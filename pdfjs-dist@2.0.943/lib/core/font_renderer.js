"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.FontRendererFactory=void 0;var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var r=t[s];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,s,r){return s&&e(t.prototype,s),r&&e(t,r),t}}(),_util=require("../shared/util"),_cff_parser=require("./cff_parser"),_glyphlist=require("./glyphlist"),_encodings=require("./encodings"),_stream=require("./stream");function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==typeof t&&"function"!==typeof t?e:t}function _inherits(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var FontRendererFactory=function(){function e(e,t){return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}function t(e,t){return e[t]<<8|e[t+1]}function s(s,r,i){var a,h,n,l=1===t(s,r+2)?e(s,r+8):e(s,r+16),f=t(s,r+l);if(4===f){t(s,r+l+2);var o=t(s,r+l+6)>>1;for(h=r+l+14,a=[],n=0;n<o;n++,h+=2)a[n]={end:t(s,h)};for(h+=2,n=0;n<o;n++,h+=2)a[n].start=t(s,h);for(n=0;n<o;n++,h+=2)a[n].idDelta=t(s,h);for(n=0;n<o;n++,h+=2){var c=t(s,h);if(0!==c){a[n].ids=[];for(var u=0,p=a[n].end-a[n].start+1;u<p;u++)a[n].ids[u]=t(s,h+c),c+=2}}return a}if(12===f){e(s,r+l+4);var d=e(s,r+l+12);for(h=r+l+16,a=[],n=0;n<d;n++)a.push({start:e(s,h),end:e(s,h+4),idDelta:e(s,h+8)-e(s,h)}),h+=12;return a}throw new _util.FormatError("unsupported cmap: "+f)}function r(e,t,s,r){var i={},a=new _cff_parser.CFFParser(new _stream.Stream(e,t,s-t),i,r),h=a.parse();return{glyphs:h.charStrings.objects,subrs:h.topDict.privateDict&&h.topDict.privateDict.subrsIndex&&h.topDict.privateDict.subrsIndex.objects,gsubrs:h.globalSubrIndex&&h.globalSubrIndex.objects,isCFFCIDFont:h.isCIDFont,fdSelect:h.fdSelect,fdArray:h.fdArray}}function i(e,t,s){var r,i;s?(r=4,i=function(e,t){return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}):(r=2,i=function(e,t){return e[t]<<9|e[t+1]<<1});for(var a=[],h=i(t,0),n=r;n<t.length;n+=r){var l=i(t,n);a.push(e.subarray(h,l)),h=l}return a}function a(e,t){var s=t.codePointAt(0),r=0,i=0,a=e.length-1;while(i<a){var h=i+a+1>>1;s<e[h].start?a=h-1:i=h}return e[i].start<=s&&s<=e[i].end&&(r=e[i].idDelta+(e[i].ids?e[i].ids[s-e[i].start]:s)&65535),{charCode:s,glyphId:r}}function h(e,t,s){function r(e,s){t.push({cmd:"moveTo",args:[e,s]})}function i(e,s){t.push({cmd:"lineTo",args:[e,s]})}function a(e,s,r,i){t.push({cmd:"quadraticCurveTo",args:[e,s,r,i]})}var n,l=0,f=(e[l]<<24|e[l+1]<<16)>>16,o=0,c=0;if(l+=10,f<0)do{n=e[l]<<8|e[l+1];var u,p,d=e[l+2]<<8|e[l+3];l+=4,1&n?(u=(e[l]<<24|e[l+1]<<16)>>16,p=(e[l+2]<<24|e[l+3]<<16)>>16,l+=4):(u=e[l++],p=e[l++]),2&n?(o=u,c=p):(o=0,c=0);var g=1,b=1,y=0,v=0;8&n?(g=b=(e[l]<<24|e[l+1]<<16)/1073741824,l+=2):64&n?(g=(e[l]<<24|e[l+1]<<16)/1073741824,b=(e[l+2]<<24|e[l+3]<<16)/1073741824,l+=4):128&n&&(g=(e[l]<<24|e[l+1]<<16)/1073741824,y=(e[l+2]<<24|e[l+3]<<16)/1073741824,v=(e[l+4]<<24|e[l+5]<<16)/1073741824,b=(e[l+6]<<24|e[l+7]<<16)/1073741824,l+=8);var m=s.glyphs[d];m&&(t.push({cmd:"save"}),t.push({cmd:"transform",args:[g,y,v,b,o,c]}),h(m,t,s),t.push({cmd:"restore"}))}while(32&n);else{var k,_,C=[];for(k=0;k<f;k++)C.push(e[l]<<8|e[l+1]),l+=2;var w=e[l]<<8|e[l+1];l+=2+w;var I=C[C.length-1]+1,F=[];while(F.length<I){n=e[l++];var x=1;8&n&&(x+=e[l++]);while(x-- >0)F.push({flags:n})}for(k=0;k<I;k++){switch(18&F[k].flags){case 0:o+=(e[l]<<24|e[l+1]<<16)>>16,l+=2;break;case 2:o-=e[l++];break;case 18:o+=e[l++];break}F[k].x=o}for(k=0;k<I;k++){switch(36&F[k].flags){case 0:c+=(e[l]<<24|e[l+1]<<16)>>16,l+=2;break;case 4:c-=e[l++];break;case 36:c+=e[l++];break}F[k].y=c}var D=0;for(l=0;l<f;l++){var T=C[l],S=F.slice(D,T+1);if(1&S[0].flags)S.push(S[0]);else if(1&S[S.length-1].flags)S.unshift(S[S.length-1]);else{var G={flags:1,x:(S[0].x+S[S.length-1].x)/2,y:(S[0].y+S[S.length-1].y)/2};S.unshift(G),S.push(G)}for(r(S[0].x,S[0].y),k=1,_=S.length;k<_;k++)1&S[k].flags?i(S[k].x,S[k].y):1&S[k+1].flags?(a(S[k].x,S[k].y,S[k+1].x,S[k+1].y),k++):a(S[k].x,S[k].y,(S[k].x+S[k+1].x)/2,(S[k].y+S[k+1].y)/2);D=T+1}}}function n(e,t,s,r){var i=[],h=0,l=0,f=0;function o(e,s){t.push({cmd:"moveTo",args:[e,s]})}function c(e,s){t.push({cmd:"lineTo",args:[e,s]})}function u(e,s,r,i,a,h){t.push({cmd:"bezierCurveTo",args:[e,s,r,i,a,h]})}function p(e){var d=0;while(d<e.length){var g,b,y,v,m,k,_,C,w,I=!1,F=e[d++];switch(F){case 1:f+=i.length>>1,I=!0;break;case 3:f+=i.length>>1,I=!0;break;case 4:l+=i.pop(),o(h,l),I=!0;break;case 5:while(i.length>0)h+=i.shift(),l+=i.shift(),c(h,l);break;case 6:while(i.length>0){if(h+=i.shift(),c(h,l),0===i.length)break;l+=i.shift(),c(h,l)}break;case 7:while(i.length>0){if(l+=i.shift(),c(h,l),0===i.length)break;h+=i.shift(),c(h,l)}break;case 8:while(i.length>0)g=h+i.shift(),y=l+i.shift(),b=g+i.shift(),v=y+i.shift(),h=b+i.shift(),l=v+i.shift(),u(g,y,b,v,h,l);break;case 10:if(C=i.pop(),w=null,s.isCFFCIDFont){var x=s.fdSelect.getFDIndex(r);if(x>=0&&x<s.fdArray.length){var D=s.fdArray[x],T=void 0;if(D.privateDict&&D.privateDict.subrsIndex&&(T=D.privateDict.subrsIndex.objects),T){var S=T.length;C+=S<1240?107:S<33900?1131:32768,w=T[C]}}else(0,_util.warn)("Invalid fd index for glyph index.")}else w=s.subrs[C+s.subrsBias];w&&p(w);break;case 11:return;case 12:switch(F=e[d++],F){case 34:g=h+i.shift(),b=g+i.shift(),m=l+i.shift(),h=b+i.shift(),u(g,l,b,m,h,m),g=h+i.shift(),b=g+i.shift(),h=b+i.shift(),u(g,m,b,l,h,l);break;case 35:g=h+i.shift(),y=l+i.shift(),b=g+i.shift(),v=y+i.shift(),h=b+i.shift(),l=v+i.shift(),u(g,y,b,v,h,l),g=h+i.shift(),y=l+i.shift(),b=g+i.shift(),v=y+i.shift(),h=b+i.shift(),l=v+i.shift(),u(g,y,b,v,h,l),i.pop();break;case 36:g=h+i.shift(),m=l+i.shift(),b=g+i.shift(),k=m+i.shift(),h=b+i.shift(),u(g,m,b,k,h,k),g=h+i.shift(),b=g+i.shift(),_=k+i.shift(),h=b+i.shift(),u(g,k,b,_,h,l);break;case 37:var G=h,j=l;g=h+i.shift(),y=l+i.shift(),b=g+i.shift(),v=y+i.shift(),h=b+i.shift(),l=v+i.shift(),u(g,y,b,v,h,l),g=h+i.shift(),y=l+i.shift(),b=g+i.shift(),v=y+i.shift(),h=b,l=v,Math.abs(h-G)>Math.abs(l-j)?h+=i.shift():l+=i.shift(),u(g,y,b,v,h,l);break;default:throw new _util.FormatError("unknown operator: 12 "+F)}break;case 14:if(i.length>=4){var O=i.pop(),M=i.pop();l=i.pop(),h=i.pop(),t.push({cmd:"save"}),t.push({cmd:"translate",args:[h,l]});var A=a(s.cmap,String.fromCharCode(s.glyphNameMap[_encodings.StandardEncoding[O]]));n(s.glyphs[A.glyphId],t,s,A.glyphId),t.push({cmd:"restore"}),A=a(s.cmap,String.fromCharCode(s.glyphNameMap[_encodings.StandardEncoding[M]])),n(s.glyphs[A.glyphId],t,s,A.glyphId)}return;case 18:f+=i.length>>1,I=!0;break;case 19:f+=i.length>>1,d+=f+7>>3,I=!0;break;case 20:f+=i.length>>1,d+=f+7>>3,I=!0;break;case 21:l+=i.pop(),h+=i.pop(),o(h,l),I=!0;break;case 22:h+=i.pop(),o(h,l),I=!0;break;case 23:f+=i.length>>1,I=!0;break;case 24:while(i.length>2)g=h+i.shift(),y=l+i.shift(),b=g+i.shift(),v=y+i.shift(),h=b+i.shift(),l=v+i.shift(),u(g,y,b,v,h,l);h+=i.shift(),l+=i.shift(),c(h,l);break;case 25:while(i.length>6)h+=i.shift(),l+=i.shift(),c(h,l);g=h+i.shift(),y=l+i.shift(),b=g+i.shift(),v=y+i.shift(),h=b+i.shift(),l=v+i.shift(),u(g,y,b,v,h,l);break;case 26:i.length%2&&(h+=i.shift());while(i.length>0)g=h,y=l+i.shift(),b=g+i.shift(),v=y+i.shift(),h=b,l=v+i.shift(),u(g,y,b,v,h,l);break;case 27:i.length%2&&(l+=i.shift());while(i.length>0)g=h+i.shift(),y=l,b=g+i.shift(),v=y+i.shift(),h=b+i.shift(),l=v,u(g,y,b,v,h,l);break;case 28:i.push((e[d]<<24|e[d+1]<<16)>>16),d+=2;break;case 29:C=i.pop()+s.gsubrsBias,w=s.gsubrs[C],w&&p(w);break;case 30:while(i.length>0){if(g=h,y=l+i.shift(),b=g+i.shift(),v=y+i.shift(),h=b+i.shift(),l=v+(1===i.length?i.shift():0),u(g,y,b,v,h,l),0===i.length)break;g=h+i.shift(),y=l,b=g+i.shift(),v=y+i.shift(),l=v+i.shift(),h=b+(1===i.length?i.shift():0),u(g,y,b,v,h,l)}break;case 31:while(i.length>0){if(g=h+i.shift(),y=l,b=g+i.shift(),v=y+i.shift(),l=v+i.shift(),h=b+(1===i.length?i.shift():0),u(g,y,b,v,h,l),0===i.length)break;g=h,y=l+i.shift(),b=g+i.shift(),v=y+i.shift(),h=b+i.shift(),l=v+(1===i.length?i.shift():0),u(g,y,b,v,h,l)}break;default:if(F<32)throw new _util.FormatError("unknown operator: "+F);F<247?i.push(F-139):F<251?i.push(256*(F-247)+e[d++]+108):F<255?i.push(256*-(F-251)-e[d++]-108):(i.push((e[d]<<24|e[d+1]<<16|e[d+2]<<8|e[d+3])/65536),d+=4);break}I&&(i.length=0)}}p(e)}var l=[],f=function(){function e(t){_classCallCheck(this,e),this.constructor===e&&(0,_util.unreachable)("Cannot initialize CompiledFont."),this.fontMatrix=t,this.compiledGlyphs=Object.create(null),this.compiledCharCodeToGlyphId=Object.create(null)}return _createClass(e,[{key:"getPathJs",value:function(e){var t=a(this.cmap,e),s=this.compiledGlyphs[t.glyphId];return s||(s=this.compileGlyph(this.glyphs[t.glyphId],t.glyphId),this.compiledGlyphs[t.glyphId]=s),void 0===this.compiledCharCodeToGlyphId[t.charCode]&&(this.compiledCharCodeToGlyphId[t.charCode]=t.glyphId),s}},{key:"compileGlyph",value:function(e,t){if(!e||0===e.length||14===e[0])return l;var s=this.fontMatrix;if(this.isCFFCIDFont){var r=this.fdSelect.getFDIndex(t);if(r>=0&&r<this.fdArray.length){var i=this.fdArray[r];s=i.getByName("FontMatrix")||_util.FONT_IDENTITY_MATRIX}else(0,_util.warn)("Invalid fd index for glyph index.")}var a=[];return a.push({cmd:"save"}),a.push({cmd:"transform",args:s.slice()}),a.push({cmd:"scale",args:["size","-size"]}),this.compileGlyphImpl(e,a,t),a.push({cmd:"restore"}),a}},{key:"compileGlyphImpl",value:function(){(0,_util.unreachable)("Children classes should implement this.")}},{key:"hasBuiltPath",value:function(e){var t=a(this.cmap,e);return void 0!==this.compiledGlyphs[t.glyphId]&&void 0!==this.compiledCharCodeToGlyphId[t.charCode]}}]),e}(),o=function(e){function t(e,s,r){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,r||[488e-6,0,0,488e-6,0,0]));return i.glyphs=e,i.cmap=s,i}return _inherits(t,e),_createClass(t,[{key:"compileGlyphImpl",value:function(e,t){h(e,t,this)}}]),t}(f),c=function(e){function t(e,s,r,i){_classCallCheck(this,t);var a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,r||[.001,0,0,.001,0,0]));return a.glyphs=e.glyphs,a.gsubrs=e.gsubrs||[],a.subrs=e.subrs||[],a.cmap=s,a.glyphNameMap=i||(0,_glyphlist.getGlyphsUnicode)(),a.gsubrsBias=a.gsubrs.length<1240?107:a.gsubrs.length<33900?1131:32768,a.subrsBias=a.subrs.length<1240?107:a.subrs.length<33900?1131:32768,a.isCFFCIDFont=e.isCFFCIDFont,a.fdSelect=e.fdSelect,a.fdArray=e.fdArray,a}return _inherits(t,e),_createClass(t,[{key:"compileGlyphImpl",value:function(e,t,s){n(e,t,this,s)}}]),t}(f);return{create:function(a,h){for(var n,l,f,u,p,d,g=new Uint8Array(a.data),b=t(g,4),y=0,v=12;y<b;y++,v+=16){var m=(0,_util.bytesToString)(g.subarray(v,v+4)),k=e(g,v+8),_=e(g,v+12);switch(m){case"cmap":n=s(g,k,k+_);break;case"glyf":l=g.subarray(k,k+_);break;case"loca":f=g.subarray(k,k+_);break;case"head":d=t(g,k+18),p=t(g,k+50);break;case"CFF ":u=r(g,k,k+_,h);break}}if(l){var C=d?[1/d,0,0,1/d,0,0]:a.fontMatrix;return new o(i(l,f,p),n,C)}return new c(u,n,a.fontMatrix,a.glyphNameMap)}}}();exports.FontRendererFactory=FontRendererFactory;