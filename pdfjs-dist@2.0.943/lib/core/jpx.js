"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.JpxImage=void 0;var _util=require("../shared/util"),_arithmetic_decoder=require("./arithmetic_decoder"),JpxError=function(){function e(e){this.message="JPX error: "+e}return e.prototype=new Error,e.prototype.name="JpxError",e.constructor=e,e}(),JpxImage=function(){var e={LL:0,LH:1,HL:1,HH:2};function t(){this.failOnCorruptedImage=!1}function i(e,t){e.x0=Math.ceil(t.XOsiz/e.XRsiz),e.x1=Math.ceil(t.Xsiz/e.XRsiz),e.y0=Math.ceil(t.YOsiz/e.YRsiz),e.y1=Math.ceil(t.Ysiz/e.YRsiz),e.width=e.x1-e.x0,e.height=e.y1-e.y0}function r(e,t){for(var i,r=e.SIZ,n=[],a=Math.ceil((r.Xsiz-r.XTOsiz)/r.XTsiz),s=Math.ceil((r.Ysiz-r.YTOsiz)/r.YTsiz),o=0;o<s;o++)for(var c=0;c<a;c++)i={},i.tx0=Math.max(r.XTOsiz+c*r.XTsiz,r.XOsiz),i.ty0=Math.max(r.YTOsiz+o*r.YTsiz,r.YOsiz),i.tx1=Math.min(r.XTOsiz+(c+1)*r.XTsiz,r.Xsiz),i.ty1=Math.min(r.YTOsiz+(o+1)*r.YTsiz,r.Ysiz),i.width=i.tx1-i.tx0,i.height=i.ty1-i.ty0,i.components=[],n.push(i);e.tiles=n;for(var l=r.Csiz,h=0,u=l;h<u;h++)for(var d=t[h],f=0,p=n.length;f<p;f++){var m={};i=n[f],m.tcx0=Math.ceil(i.tx0/d.XRsiz),m.tcy0=Math.ceil(i.ty0/d.YRsiz),m.tcx1=Math.ceil(i.tx1/d.XRsiz),m.tcy1=Math.ceil(i.ty1/d.YRsiz),m.width=m.tcx1-m.tcx0,m.height=m.tcy1-m.tcy0,i.components[h]=m}}function n(e,t,i){var r=t.codingStyleParameters,n={};return r.entropyCoderWithCustomPrecincts?(n.PPx=r.precinctsSizes[i].PPx,n.PPy=r.precinctsSizes[i].PPy):(n.PPx=15,n.PPy=15),n.xcb_=i>0?Math.min(r.xcb,n.PPx-1):Math.min(r.xcb,n.PPx),n.ycb_=i>0?Math.min(r.ycb,n.PPy-1):Math.min(r.ycb,n.PPy),n}function a(e,t,i){var r=1<<i.PPx,n=1<<i.PPy,a=0===t.resLevel,s=1<<i.PPx+(a?0:-1),o=1<<i.PPy+(a?0:-1),c=t.trx1>t.trx0?Math.ceil(t.trx1/r)-Math.floor(t.trx0/r):0,l=t.try1>t.try0?Math.ceil(t.try1/n)-Math.floor(t.try0/n):0,h=c*l;t.precinctParameters={precinctWidth:r,precinctHeight:n,numprecinctswide:c,numprecinctshigh:l,numprecincts:h,precinctWidthInSubband:s,precinctHeightInSubband:o}}function s(e,t,i){var r,n,a,s,o=i.xcb_,c=i.ycb_,l=1<<o,h=1<<c,u=t.tbx0>>o,d=t.tby0>>c,f=t.tbx1+l-1>>o,p=t.tby1+h-1>>c,m=t.resolution.precinctParameters,v=[],b=[];for(n=d;n<p;n++)for(r=u;r<f;r++){a={cbx:r,cby:n,tbx0:l*r,tby0:h*n,tbx1:l*(r+1),tby1:h*(n+1)},a.tbx0_=Math.max(t.tbx0,a.tbx0),a.tby0_=Math.max(t.tby0,a.tby0),a.tbx1_=Math.min(t.tbx1,a.tbx1),a.tby1_=Math.min(t.tby1,a.tby1);var x=Math.floor((a.tbx0_-t.tbx0)/m.precinctWidthInSubband),g=Math.floor((a.tby0_-t.tby0)/m.precinctHeightInSubband);if(s=x+g*m.numprecinctswide,a.precinctNumber=s,a.subbandType=t.type,a.Lblock=3,!(a.tbx1_<=a.tbx0_||a.tby1_<=a.tby0_)){v.push(a);var y=b[s];void 0!==y?(r<y.cbxMin?y.cbxMin=r:r>y.cbxMax&&(y.cbxMax=r),n<y.cbyMin?y.cbxMin=n:n>y.cbyMax&&(y.cbyMax=n)):b[s]=y={cbxMin:r,cbyMin:n,cbxMax:r,cbyMax:n},a.precinct=y}}t.codeblockParameters={codeblockWidth:o,codeblockHeight:c,numcodeblockwide:f-u+1,numcodeblockhigh:p-d+1},t.codeblocks=v,t.precincts=b}function o(e,t,i){for(var r=[],n=e.subbands,a=0,s=n.length;a<s;a++)for(var o=n[a],c=o.codeblocks,l=0,h=c.length;l<h;l++){var u=c[l];u.precinctNumber===t&&r.push(u)}return{layerNumber:i,codeblocks:r}}function c(e){for(var t=e.SIZ,i=e.currentTile.index,r=e.tiles[i],n=r.codingStyleDefaultParameters.layersCount,a=t.Csiz,s=0,c=0;c<a;c++)s=Math.max(s,r.components[c].codingStyleParameters.decompositionLevelsCount);var l=0,h=0,u=0,d=0;this.nextPacket=function(){for(;l<n;l++){for(;h<=s;h++){for(;u<a;u++){var e=r.components[u];if(!(h>e.codingStyleParameters.decompositionLevelsCount)){for(var t=e.resolutions[h],i=t.precinctParameters.numprecincts;d<i;){var c=o(t,d,l);return d++,c}d=0}}u=0}h=0}throw new JpxError("Out of packets")}}function l(e){for(var t=e.SIZ,i=e.currentTile.index,r=e.tiles[i],n=r.codingStyleDefaultParameters.layersCount,a=t.Csiz,s=0,c=0;c<a;c++)s=Math.max(s,r.components[c].codingStyleParameters.decompositionLevelsCount);var l=0,h=0,u=0,d=0;this.nextPacket=function(){for(;l<=s;l++){for(;h<n;h++){for(;u<a;u++){var e=r.components[u];if(!(l>e.codingStyleParameters.decompositionLevelsCount)){for(var t=e.resolutions[l],i=t.precinctParameters.numprecincts;d<i;){var c=o(t,d,h);return d++,c}d=0}}u=0}h=0}throw new JpxError("Out of packets")}}function h(e){var t,i,r,n,a=e.SIZ,s=e.currentTile.index,c=e.tiles[s],l=c.codingStyleDefaultParameters.layersCount,h=a.Csiz,u=0;for(r=0;r<h;r++){var d=c.components[r];u=Math.max(u,d.codingStyleParameters.decompositionLevelsCount)}var f=new Int32Array(u+1);for(i=0;i<=u;++i){var p=0;for(r=0;r<h;++r){var m=c.components[r].resolutions;i<m.length&&(p=Math.max(p,m[i].precinctParameters.numprecincts))}f[i]=p}t=0,i=0,r=0,n=0,this.nextPacket=function(){for(;i<=u;i++){for(;n<f[i];n++){for(;r<h;r++){var e=c.components[r];if(!(i>e.codingStyleParameters.decompositionLevelsCount)){var a=e.resolutions[i],s=a.precinctParameters.numprecincts;if(!(n>=s)){for(;t<l;){var d=o(a,n,t);return t++,d}t=0}}}r=0}n=0}throw new JpxError("Out of packets")}}function u(e){var t=e.SIZ,i=e.currentTile.index,r=e.tiles[i],n=r.codingStyleDefaultParameters.layersCount,a=t.Csiz,s=p(r),c=s,l=0,h=0,u=0,d=0,m=0;this.nextPacket=function(){for(;m<c.maxNumHigh;m++){for(;d<c.maxNumWide;d++){for(;u<a;u++){for(var e=r.components[u],t=e.codingStyleParameters.decompositionLevelsCount;h<=t;h++){var i=e.resolutions[h],p=s.components[u].resolutions[h],v=f(d,m,p,c,i);if(null!==v){for(;l<n;){var b=o(i,v,l);return l++,b}l=0}}h=0}u=0}d=0}throw new JpxError("Out of packets")}}function d(e){var t=e.SIZ,i=e.currentTile.index,r=e.tiles[i],n=r.codingStyleDefaultParameters.layersCount,a=t.Csiz,s=p(r),c=0,l=0,h=0,u=0,d=0;this.nextPacket=function(){for(;h<a;++h){for(var e=r.components[h],t=s.components[h],i=e.codingStyleParameters.decompositionLevelsCount;d<t.maxNumHigh;d++){for(;u<t.maxNumWide;u++){for(;l<=i;l++){var p=e.resolutions[l],m=t.resolutions[l],v=f(u,d,m,t,p);if(null!==v){for(;c<n;){var b=o(p,v,c);return c++,b}c=0}}l=0}u=0}d=0}throw new JpxError("Out of packets")}}function f(e,t,i,r,n){var a=e*r.minWidth,s=t*r.minHeight;if(a%i.width!==0||s%i.height!==0)return null;var o=s/i.width*n.precinctParameters.numprecinctswide;return a/i.height+o}function p(e){for(var t=e.components.length,i=Number.MAX_VALUE,r=Number.MAX_VALUE,n=0,a=0,s=new Array(t),o=0;o<t;o++){for(var c=e.components[o],l=c.codingStyleParameters.decompositionLevelsCount,h=new Array(l+1),u=Number.MAX_VALUE,d=Number.MAX_VALUE,f=0,p=0,m=1,v=l;v>=0;--v){var b=c.resolutions[v],x=m*b.precinctParameters.precinctWidth,g=m*b.precinctParameters.precinctHeight;u=Math.min(u,x),d=Math.min(d,g),f=Math.max(f,b.precinctParameters.numprecinctswide),p=Math.max(p,b.precinctParameters.numprecinctshigh),h[v]={width:x,height:g},m<<=1}i=Math.min(i,u),r=Math.min(r,d),n=Math.max(n,f),a=Math.max(a,p),s[o]={resolutions:h,minWidth:u,minHeight:d,maxNumWide:f,maxNumHigh:p}}return{components:s,minWidth:i,minHeight:r,maxNumWide:n,maxNumHigh:a}}function m(e){for(var t=e.SIZ,i=e.currentTile.index,r=e.tiles[i],o=t.Csiz,f=0;f<o;f++){for(var p=r.components[f],m=p.codingStyleParameters.decompositionLevelsCount,v=[],b=[],x=0;x<=m;x++){var g,y=n(e,p,x),w={},C=1<<m-x;if(w.trx0=Math.ceil(p.tcx0/C),w.try0=Math.ceil(p.tcy0/C),w.trx1=Math.ceil(p.tcx1/C),w.try1=Math.ceil(p.tcy1/C),w.resLevel=x,a(e,w,y),v.push(w),0===x)g={},g.type="LL",g.tbx0=Math.ceil(p.tcx0/C),g.tby0=Math.ceil(p.tcy0/C),g.tbx1=Math.ceil(p.tcx1/C),g.tby1=Math.ceil(p.tcy1/C),g.resolution=w,s(e,g,y),b.push(g),w.subbands=[g];else{var M=1<<m-x+1,P=[];g={},g.type="HL",g.tbx0=Math.ceil(p.tcx0/M-.5),g.tby0=Math.ceil(p.tcy0/M),g.tbx1=Math.ceil(p.tcx1/M-.5),g.tby1=Math.ceil(p.tcy1/M),g.resolution=w,s(e,g,y),b.push(g),P.push(g),g={},g.type="LH",g.tbx0=Math.ceil(p.tcx0/M),g.tby0=Math.ceil(p.tcy0/M-.5),g.tbx1=Math.ceil(p.tcx1/M),g.tby1=Math.ceil(p.tcy1/M-.5),g.resolution=w,s(e,g,y),b.push(g),P.push(g),g={},g.type="HH",g.tbx0=Math.ceil(p.tcx0/M-.5),g.tby0=Math.ceil(p.tcy0/M-.5),g.tbx1=Math.ceil(p.tcx1/M-.5),g.tby1=Math.ceil(p.tcy1/M-.5),g.resolution=w,s(e,g,y),b.push(g),P.push(g),w.subbands=P}}p.resolutions=v,p.subbands=b}var k=r.codingStyleDefaultParameters.progressionOrder;switch(k){case 0:r.packetsIterator=new c(e);break;case 1:r.packetsIterator=new l(e);break;case 2:r.packetsIterator=new h(e);break;case 3:r.packetsIterator=new u(e);break;case 4:r.packetsIterator=new d(e);break;default:throw new JpxError("Unsupported progression order "+k)}}function v(e,t,i,r){var n,a=0,s=0,o=!1;function c(e){while(s<e){var r=t[i+a];a++,o?(n=n<<7|r,s+=7,o=!1):(n=n<<8|r,s+=8),255===r&&(o=!0)}return s-=e,n>>>s&(1<<e)-1}function l(e){return 255===t[i+a-1]&&t[i+a]===e?(h(1),!0):255===t[i+a]&&t[i+a+1]===e&&(h(2),!0)}function h(e){a+=e}function u(){s=0,o&&(a++,o=!1)}function d(){if(0===c(1))return 1;if(0===c(1))return 2;var e=c(2);return e<3?e+3:(e=c(5),e<31?e+6:(e=c(7),e+37))}var f=e.currentTile.index,p=e.tiles[f],m=e.COD.sopMarkerUsed,v=e.COD.ephMarkerUsed,b=p.packetsIterator;while(a<r){u(),m&&l(145)&&h(4);var x=b.nextPacket();if(c(1)){for(var g,y=x.layerNumber,M=[],P=0,k=x.codeblocks.length;P<k;P++){g=x.codeblocks[P];var S,z=g.precinct,_=g.cbx-z.cbxMin,T=g.cby-z.cbyMin,U=!1,L=!1;if(void 0!==g["included"])U=!!c(1);else{var I,O;if(z=g.precinct,void 0!==z["inclusionTree"])I=z.inclusionTree;else{var A=z.cbxMax-z.cbxMin+1,D=z.cbyMax-z.cbyMin+1;I=new C(A,D,y),O=new w(A,D),z.inclusionTree=I,z.zeroBitPlanesTree=O}if(I.reset(_,T,y))while(1){if(!c(1)){I.incrementValue(y);break}if(S=!I.nextLevel(),S){g.included=!0,U=L=!0;break}}}if(U){if(L){O=z.zeroBitPlanesTree,O.reset(_,T);while(1)if(c(1)){if(S=!O.nextLevel(),S)break}else O.incrementValue();g.zeroBitPlanes=O.value}var E=d();while(c(1))g.Lblock++;var H=(0,_util.log2)(E),X=(E<1<<H?H-1:H)+g.Lblock,B=c(X);M.push({codeblock:g,codingpasses:E,dataLength:B})}}u(),v&&l(146);while(M.length>0){var Y=M.shift();g=Y.codeblock,void 0===g["data"]&&(g.data=[]),g.data.push({data:t,start:i+a,end:i+a+Y.dataLength,codingpasses:Y.codingpasses}),a+=Y.dataLength}}}return a}function b(e,t,i,r,n,a,s,o){for(var c=r.tbx0,l=r.tby0,h=r.tbx1-r.tbx0,u=r.codeblocks,d="H"===r.type.charAt(0)?1:0,f="H"===r.type.charAt(1)?t:0,p=0,m=u.length;p<m;++p){var v=u[p],b=v.tbx1_-v.tbx0_,x=v.tby1_-v.tby0_;if(0!==b&&0!==x&&void 0!==v["data"]){var g,y;g=new M(b,x,v.subbandType,v.zeroBitPlanes,a),y=2;var w,C,P,k=v.data,S=0,z=0;for(w=0,C=k.length;w<C;w++)P=k[w],S+=P.end-P.start,z+=P.codingpasses;var _=new Uint8Array(S),T=0;for(w=0,C=k.length;w<C;w++){P=k[w];var U=P.data.subarray(P.start,P.end);_.set(U,T),T+=U.length}var L=new _arithmetic_decoder.ArithmeticDecoder(_,0,S);for(g.setDecoder(L),w=0;w<z;w++){switch(y){case 0:g.runSignificancePropagationPass();break;case 1:g.runMagnitudeRefinementPass();break;case 2:g.runCleanupPass(),o&&g.checkSegmentationSymbol();break}y=(y+1)%3}var I,O,A,D=v.tbx0_-c+(v.tby0_-l)*h,E=g.coefficentsSign,H=g.coefficentsMagnitude,X=g.bitsDecoded,B=s?0:.5;T=0;var Y="LL"!==r.type;for(w=0;w<x;w++){var N=D/h|0,J=2*N*(t-h)+d+f;for(I=0;I<b;I++){if(O=H[T],0!==O){O=(O+B)*n,0!==E[T]&&(O=-O),A=X[T];var Q=Y?J+(D<<1):D;e[Q]=s&&A>=a?O:O*(1<<a-A)}D++,T++}D+=h-b}}}}function x(t,i,r){for(var n=i.components[r],a=n.codingStyleParameters,s=n.quantizationParameters,o=a.decompositionLevelsCount,c=s.SPqcds,l=s.scalarExpounded,h=s.guardBits,u=a.segmentationSymbolUsed,d=t.components[r].precision,f=a.reversibleTransformation,p=f?new S:new k,m=[],v=0,x=0;x<=o;x++){for(var g=n.resolutions[x],y=g.trx1-g.trx0,w=g.try1-g.try0,C=new Float32Array(y*w),M=0,P=g.subbands.length;M<P;M++){var z,_;l?(z=c[v].mu,_=c[v].epsilon,v++):(z=c[0].mu,_=c[0].epsilon+(x>0?1-x:0));var T=g.subbands[M],U=e[T.type],L=f?1:Math.pow(2,d+U-_)*(1+z/2048),I=h+_-1;b(C,y,w,T,L,I,f,u)}m.push({width:y,height:w,items:C})}var O=p.calculate(m,n.tcx0,n.tcy0);return{left:n.tcx0,top:n.tcy0,width:O.width,height:O.height,items:O.items}}function g(e){for(var t=e.SIZ,i=e.components,r=t.Csiz,n=[],a=0,s=e.tiles.length;a<s;a++){var o,c=e.tiles[a],l=[];for(o=0;o<r;o++)l[o]=x(e,c,o);var h,u,d,f,p,m,v,b=l[0],g=new Uint8ClampedArray(b.items.length*r),y={left:b.left,top:b.top,width:b.width,height:b.height,items:g},w=0;if(c.codingStyleDefaultParameters.multipleComponentTransform){var C=4===r,M=l[0].items,P=l[1].items,k=l[2].items,S=C?l[3].items:null;h=i[0].precision-8,u=.5+(128<<h);var z=c.components[0],_=r-3;if(f=M.length,z.codingStyleParameters.reversibleTransformation)for(d=0;d<f;d++,w+=_){p=M[d]+u,m=P[d],v=k[d];var T=p-(v+m>>2);g[w++]=T+v>>h,g[w++]=T>>h,g[w++]=T+m>>h}else for(d=0;d<f;d++,w+=_)p=M[d]+u,m=P[d],v=k[d],g[w++]=p+1.402*v>>h,g[w++]=p-.34413*m-.71414*v>>h,g[w++]=p+1.772*m>>h;if(C)for(d=0,w=3;d<f;d++,w+=4)g[w]=S[d]+u>>h}else for(o=0;o<r;o++){var U=l[o].items;for(h=i[o].precision-8,u=.5+(128<<h),w=o,d=0,f=U.length;d<f;d++)g[w]=U[d]+u>>h,w+=r}n.push(y)}return n}function y(e,t){for(var i=e.SIZ,r=i.Csiz,n=e.tiles[t],a=0;a<r;a++){var s=n.components[a],o=void 0!==e.currentTile.QCC[a]?e.currentTile.QCC[a]:e.currentTile.QCD;s.quantizationParameters=o;var c=void 0!==e.currentTile.COC[a]?e.currentTile.COC[a]:e.currentTile.COD;s.codingStyleParameters=c}n.codingStyleDefaultParameters=e.currentTile.COD}t.prototype={parse:function(e){var t=(0,_util.readUint16)(e,0);if(65359!==t){var i=0,r=e.length;while(i<r){var n=8,a=(0,_util.readUint32)(e,i),s=(0,_util.readUint32)(e,i+4);if(i+=n,1===a&&(a=4294967296*(0,_util.readUint32)(e,i)+(0,_util.readUint32)(e,i+4),i+=8,n+=8),0===a&&(a=r-i+n),a<n)throw new JpxError("Invalid box field size");var o=a-n,c=!0;switch(s){case 1785737832:c=!1;break;case 1668246642:var l=e[i];if(1===l){var h=(0,_util.readUint32)(e,i+3);switch(h){case 16:case 17:case 18:break;default:(0,_util.warn)("Unknown colorspace "+h);break}}else 2===l&&(0,_util.info)("ICC profile not supported");break;case 1785737827:this.parseCodestream(e,i,i+o);break;case 1783636e3:218793738!==(0,_util.readUint32)(e,i)&&(0,_util.warn)("Invalid JP2 signature");break;case 1783634458:case 1718909296:case 1920099697:case 1919251232:case 1768449138:break;default:var u=String.fromCharCode(s>>24&255,s>>16&255,s>>8&255,255&s);(0,_util.warn)("Unsupported header type "+s+" ("+u+")");break}c&&(i+=o)}}else this.parseCodestream(e,0,e.length)},parseImageProperties:function(e){var t=e.getByte();while(t>=0){var i=t;t=e.getByte();var r=i<<8|t;if(65361===r){e.skip(4);var n=e.getInt32()>>>0,a=e.getInt32()>>>0,s=e.getInt32()>>>0,o=e.getInt32()>>>0;e.skip(16);var c=e.getUint16();return this.width=n-s,this.height=a-o,this.componentsCount=c,void(this.bitsPerComponent=8)}}throw new JpxError("No size marker found in JPX stream")},parseCodestream:function(e,t,n){var a={},s=!1;try{var o=t;while(o+1<n){var c=(0,_util.readUint16)(e,o);o+=2;var l,h,u,d,f,p,b=0;switch(c){case 65359:a.mainHeader=!0;break;case 65497:break;case 65361:b=(0,_util.readUint16)(e,o);var x={};x.Xsiz=(0,_util.readUint32)(e,o+4),x.Ysiz=(0,_util.readUint32)(e,o+8),x.XOsiz=(0,_util.readUint32)(e,o+12),x.YOsiz=(0,_util.readUint32)(e,o+16),x.XTsiz=(0,_util.readUint32)(e,o+20),x.YTsiz=(0,_util.readUint32)(e,o+24),x.XTOsiz=(0,_util.readUint32)(e,o+28),x.YTOsiz=(0,_util.readUint32)(e,o+32);var w=(0,_util.readUint16)(e,o+36);x.Csiz=w;var C=[];l=o+38;for(var M=0;M<w;M++){var P={precision:1+(127&e[l]),isSigned:!!(128&e[l]),XRsiz:e[l+1],YRsiz:e[l+2]};l+=3,i(P,x),C.push(P)}a.SIZ=x,a.components=C,r(a,C),a.QCC=[],a.COC=[];break;case 65372:b=(0,_util.readUint16)(e,o);var k={};switch(l=o+2,h=e[l++],31&h){case 0:d=8,f=!0;break;case 1:d=16,f=!1;break;case 2:d=16,f=!0;break;default:throw new Error("Invalid SQcd value "+h)}k.noQuantization=8===d,k.scalarExpounded=f,k.guardBits=h>>5,u=[];while(l<b+o){var S={};8===d?(S.epsilon=e[l++]>>3,S.mu=0):(S.epsilon=e[l]>>3,S.mu=(7&e[l])<<8|e[l+1],l+=2),u.push(S)}k.SPqcds=u,a.mainHeader?a.QCD=k:(a.currentTile.QCD=k,a.currentTile.QCC=[]);break;case 65373:b=(0,_util.readUint16)(e,o);var z,_={};switch(l=o+2,a.SIZ.Csiz<257?z=e[l++]:(z=(0,_util.readUint16)(e,l),l+=2),h=e[l++],31&h){case 0:d=8,f=!0;break;case 1:d=16,f=!1;break;case 2:d=16,f=!0;break;default:throw new Error("Invalid SQcd value "+h)}_.noQuantization=8===d,_.scalarExpounded=f,_.guardBits=h>>5,u=[];while(l<b+o)S={},8===d?(S.epsilon=e[l++]>>3,S.mu=0):(S.epsilon=e[l]>>3,S.mu=(7&e[l])<<8|e[l+1],l+=2),u.push(S);_.SPqcds=u,a.mainHeader?a.QCC[z]=_:a.currentTile.QCC[z]=_;break;case 65362:b=(0,_util.readUint16)(e,o);var T={};l=o+2;var U=e[l++];T.entropyCoderWithCustomPrecincts=!!(1&U),T.sopMarkerUsed=!!(2&U),T.ephMarkerUsed=!!(4&U),T.progressionOrder=e[l++],T.layersCount=(0,_util.readUint16)(e,l),l+=2,T.multipleComponentTransform=e[l++],T.decompositionLevelsCount=e[l++],T.xcb=2+(15&e[l++]),T.ycb=2+(15&e[l++]);var L=e[l++];if(T.selectiveArithmeticCodingBypass=!!(1&L),T.resetContextProbabilities=!!(2&L),T.terminationOnEachCodingPass=!!(4&L),T.verticallyStripe=!!(8&L),T.predictableTermination=!!(16&L),T.segmentationSymbolUsed=!!(32&L),T.reversibleTransformation=e[l++],T.entropyCoderWithCustomPrecincts){var I=[];while(l<b+o){var O=e[l++];I.push({PPx:15&O,PPy:O>>4})}T.precinctsSizes=I}var A=[];if(T.selectiveArithmeticCodingBypass&&A.push("selectiveArithmeticCodingBypass"),T.resetContextProbabilities&&A.push("resetContextProbabilities"),T.terminationOnEachCodingPass&&A.push("terminationOnEachCodingPass"),T.verticallyStripe&&A.push("verticallyStripe"),T.predictableTermination&&A.push("predictableTermination"),A.length>0)throw s=!0,new Error("Unsupported COD options ("+A.join(", ")+")");a.mainHeader?a.COD=T:(a.currentTile.COD=T,a.currentTile.COC=[]);break;case 65424:b=(0,_util.readUint16)(e,o),p={},p.index=(0,_util.readUint16)(e,o+2),p.length=(0,_util.readUint32)(e,o+4),p.dataEnd=p.length+o-2,p.partIndex=e[o+8],p.partsCount=e[o+9],a.mainHeader=!1,0===p.partIndex&&(p.COD=a.COD,p.COC=a.COC.slice(0),p.QCD=a.QCD,p.QCC=a.QCC.slice(0)),a.currentTile=p;break;case 65427:p=a.currentTile,0===p.partIndex&&(y(a,p.index),m(a)),b=p.dataEnd-o,v(a,e,o,b);break;case 65365:case 65367:case 65368:case 65380:b=(0,_util.readUint16)(e,o);break;case 65363:throw new Error("Codestream code 0xFF53 (COC) is not implemented");default:throw new Error("Unknown codestream code: "+c.toString(16))}o+=b}}catch(D){if(s||this.failOnCorruptedImage)throw new JpxError(D.message);(0,_util.warn)("JPX: Trying to recover from: "+D.message)}this.tiles=g(a),this.width=a.SIZ.Xsiz-a.SIZ.XOsiz,this.height=a.SIZ.Ysiz-a.SIZ.YOsiz,this.componentsCount=a.SIZ.Csiz}};var w=function(){function e(e,t){var i=(0,_util.log2)(Math.max(e,t))+1;this.levels=[];for(var r=0;r<i;r++){var n={width:e,height:t,items:[]};this.levels.push(n),e=Math.ceil(e/2),t=Math.ceil(t/2)}}return e.prototype={reset:function(e,t){var i,r=0,n=0;while(r<this.levels.length){i=this.levels[r];var a=e+t*i.width;if(void 0!==i.items[a]){n=i.items[a];break}i.index=a,e>>=1,t>>=1,r++}r--,i=this.levels[r],i.items[i.index]=n,this.currentLevel=r,delete this.value},incrementValue:function(){var e=this.levels[this.currentLevel];e.items[e.index]++},nextLevel:function(){var e=this.currentLevel,t=this.levels[e],i=t.items[t.index];return e--,e<0?(this.value=i,!1):(this.currentLevel=e,t=this.levels[e],t.items[t.index]=i,!0)}},e}(),C=function(){function e(e,t,i){var r=(0,_util.log2)(Math.max(e,t))+1;this.levels=[];for(var n=0;n<r;n++){for(var a=new Uint8Array(e*t),s=0,o=a.length;s<o;s++)a[s]=i;var c={width:e,height:t,items:a};this.levels.push(c),e=Math.ceil(e/2),t=Math.ceil(t/2)}}return e.prototype={reset:function(e,t,i){var r=0;while(r<this.levels.length){var n=this.levels[r],a=e+t*n.width;n.index=a;var s=n.items[a];if(255===s)break;if(s>i)return this.currentLevel=r,this.propagateValues(),!1;e>>=1,t>>=1,r++}return this.currentLevel=r-1,!0},incrementValue:function(e){var t=this.levels[this.currentLevel];t.items[t.index]=e+1,this.propagateValues()},propagateValues:function(){var e=this.currentLevel,t=this.levels[e],i=t.items[t.index];while(--e>=0)t=this.levels[e],t.items[t.index]=i},nextLevel:function(){var e=this.currentLevel,t=this.levels[e],i=t.items[t.index];return t.items[t.index]=255,e--,!(e<0)&&(this.currentLevel=e,t=this.levels[e],t.items[t.index]=i,!0)}},e}(),M=function(){var e=17,t=18,i=new Uint8Array([0,5,8,0,3,7,8,0,4,7,8,0,0,0,0,0,1,6,8,0,3,7,8,0,4,7,8,0,0,0,0,0,2,6,8,0,3,7,8,0,4,7,8,0,0,0,0,0,2,6,8,0,3,7,8,0,4,7,8,0,0,0,0,0,2,6,8,0,3,7,8,0,4,7,8]),r=new Uint8Array([0,3,4,0,5,7,7,0,8,8,8,0,0,0,0,0,1,3,4,0,6,7,7,0,8,8,8,0,0,0,0,0,2,3,4,0,6,7,7,0,8,8,8,0,0,0,0,0,2,3,4,0,6,7,7,0,8,8,8,0,0,0,0,0,2,3,4,0,6,7,7,0,8,8,8]),n=new Uint8Array([0,1,2,0,1,2,2,0,2,2,2,0,0,0,0,0,3,4,5,0,4,5,5,0,5,5,5,0,0,0,0,0,6,7,7,0,7,7,7,0,7,7,7,0,0,0,0,0,8,8,8,0,8,8,8,0,8,8,8,0,0,0,0,0,8,8,8,0,8,8,8,0,8,8,8]);function a(e,t,a,s,o){this.width=e,this.height=t,this.contextLabelTable="HH"===a?n:"HL"===a?r:i;var c=e*t;this.neighborsSignificance=new Uint8Array(c),this.coefficentsSign=new Uint8Array(c),this.coefficentsMagnitude=o>14?new Uint32Array(c):o>6?new Uint16Array(c):new Uint8Array(c),this.processingFlags=new Uint8Array(c);var l=new Uint8Array(c);if(0!==s)for(var h=0;h<c;h++)l[h]=s;this.bitsDecoded=l,this.reset()}return a.prototype={setDecoder:function(e){this.decoder=e},reset:function(){this.contexts=new Int8Array(19),this.contexts[0]=8,this.contexts[e]=92,this.contexts[t]=6},setNeighborsSignificance:function(e,t,i){var r,n=this.neighborsSignificance,a=this.width,s=this.height,o=t>0,c=t+1<a;e>0&&(r=i-a,o&&(n[r-1]+=16),c&&(n[r+1]+=16),n[r]+=4),e+1<s&&(r=i+a,o&&(n[r-1]+=16),c&&(n[r+1]+=16),n[r]+=4),o&&(n[i-1]+=1),c&&(n[i+1]+=1),n[i]|=128},runSignificancePropagationPass:function(){for(var e=this.decoder,t=this.width,i=this.height,r=this.coefficentsMagnitude,n=this.coefficentsSign,a=this.neighborsSignificance,s=this.processingFlags,o=this.contexts,c=this.contextLabelTable,l=this.bitsDecoded,h=-2,u=1,d=2,f=0;f<i;f+=4)for(var p=0;p<t;p++)for(var m=f*t+p,v=0;v<4;v++,m+=t){var b=f+v;if(b>=i)break;if(s[m]&=h,!r[m]&&a[m]){var x=c[a[m]],g=e.readBit(o,x);if(g){var y=this.decodeSignBit(b,p,m);n[m]=y,r[m]=1,this.setNeighborsSignificance(b,p,m),s[m]|=d}l[m]++,s[m]|=u}}},decodeSignBit:function(e,t,i){var r,n,a,s,o,c,l=this.width,h=this.height,u=this.coefficentsMagnitude,d=this.coefficentsSign;s=t>0&&0!==u[i-1],t+1<l&&0!==u[i+1]?(a=d[i+1],s?(n=d[i-1],r=1-a-n):r=1-a-a):s?(n=d[i-1],r=1-n-n):r=0;var f=3*r;return s=e>0&&0!==u[i-l],e+1<h&&0!==u[i+l]?(a=d[i+l],s?(n=d[i-l],r=1-a-n+f):r=1-a-a+f):s?(n=d[i-l],r=1-n-n+f):r=f,r>=0?(o=9+r,c=this.decoder.readBit(this.contexts,o)):(o=9-r,c=1^this.decoder.readBit(this.contexts,o)),c},runMagnitudeRefinementPass:function(){for(var e,t=this.decoder,i=this.width,r=this.height,n=this.coefficentsMagnitude,a=this.neighborsSignificance,s=this.contexts,o=this.bitsDecoded,c=this.processingFlags,l=1,h=2,u=i*r,d=4*i,f=0;f<u;f=e){e=Math.min(u,f+d);for(var p=0;p<i;p++)for(var m=f+p;m<e;m+=i)if(n[m]&&0===(c[m]&l)){var v=16;if(0!==(c[m]&h)){c[m]^=h;var b=127&a[m];v=0===b?15:14}var x=t.readBit(s,v);n[m]=n[m]<<1|x,o[m]++,c[m]|=l}}},runCleanupPass:function(){for(var i,r=this.decoder,n=this.width,a=this.height,s=this.neighborsSignificance,o=this.coefficentsMagnitude,c=this.coefficentsSign,l=this.contexts,h=this.contextLabelTable,u=this.bitsDecoded,d=this.processingFlags,f=1,p=2,m=n,v=2*n,b=3*n,x=0;x<a;x=i){i=Math.min(x+4,a);for(var g=x*n,y=x+3<a,w=0;w<n;w++){var C,M=g+w,P=y&&0===d[M]&&0===d[M+m]&&0===d[M+v]&&0===d[M+b]&&0===s[M]&&0===s[M+m]&&0===s[M+v]&&0===s[M+b],k=0,S=M,z=x;if(P){var _=r.readBit(l,t);if(!_){u[M]++,u[M+m]++,u[M+v]++,u[M+b]++;continue}k=r.readBit(l,e)<<1|r.readBit(l,e),0!==k&&(z=x+k,S+=k*n),C=this.decodeSignBit(z,w,S),c[S]=C,o[S]=1,this.setNeighborsSignificance(z,w,S),d[S]|=p,S=M;for(var T=x;T<=z;T++,S+=n)u[S]++;k++}for(z=x+k;z<i;z++,S+=n)if(!o[S]&&0===(d[S]&f)){var U=h[s[S]],L=r.readBit(l,U);1===L&&(C=this.decodeSignBit(z,w,S),c[S]=C,o[S]=1,this.setNeighborsSignificance(z,w,S),d[S]|=p),u[S]++}}}},checkSegmentationSymbol:function(){var t=this.decoder,i=this.contexts,r=t.readBit(i,e)<<3|t.readBit(i,e)<<2|t.readBit(i,e)<<1|t.readBit(i,e);if(10!==r)throw new JpxError("Invalid segmentation symbol")}},a}(),P=function(){function e(){}return e.prototype.calculate=function(e,t,i){for(var r=e[0],n=1,a=e.length;n<a;n++)r=this.iterate(r,e[n],t,i);return r},e.prototype.extend=function(e,t,i){var r=t-1,n=t+1,a=t+i-2,s=t+i;e[r--]=e[n++],e[s++]=e[a--],e[r--]=e[n++],e[s++]=e[a--],e[r--]=e[n++],e[s++]=e[a--],e[r]=e[n],e[s]=e[a]},e.prototype.iterate=function(e,t,i,r){var n,a,s,o,c,l,h=e.width,u=e.height,d=e.items,f=t.width,p=t.height,m=t.items;for(s=0,n=0;n<u;n++)for(o=2*n*f,a=0;a<h;a++,s++,o+=2)m[o]=d[s];d=e.items=null;var v=4,b=new Float32Array(f+2*v);if(1===f){if(0!==(1&i))for(l=0,s=0;l<p;l++,s+=f)m[s]*=.5}else for(l=0,s=0;l<p;l++,s+=f)b.set(m.subarray(s,s+f),v),this.extend(b,v,f),this.filter(b,v,f),m.set(b.subarray(v,v+f),s);var x=16,g=[];for(n=0;n<x;n++)g.push(new Float32Array(p+2*v));var y,w=0;if(e=v+p,1===p){if(0!==(1&r))for(c=0;c<f;c++)m[c]*=.5}else for(c=0;c<f;c++){if(0===w){for(x=Math.min(f-c,x),s=c,o=v;o<e;s+=f,o++)for(y=0;y<x;y++)g[y][o]=m[s+y];w=x}w--;var C=g[w];if(this.extend(C,v,p),this.filter(C,v,p),0===w)for(s=c-x+1,o=v;o<e;s+=f,o++)for(y=0;y<x;y++)m[s+y]=g[y][o]}return{width:f,height:p,items:m}},e}(),k=function(){function e(){P.call(this)}return e.prototype=Object.create(P.prototype),e.prototype.filter=function(e,t,i){var r,n,a,s,o=i>>1;t|=0;var c=-1.586134342059924,l=-.052980118572961,h=.882911075530934,u=.443506852043971,d=1.230174104914001,f=1/d;for(r=t-3,n=o+4;n--;r+=2)e[r]*=f;for(r=t-2,a=u*e[r-1],n=o+3;n--;r+=2){if(s=u*e[r+1],e[r]=d*e[r]-a-s,!n--)break;r+=2,a=u*e[r+1],e[r]=d*e[r]-a-s}for(r=t-1,a=h*e[r-1],n=o+2;n--;r+=2){if(s=h*e[r+1],e[r]-=a+s,!n--)break;r+=2,a=h*e[r+1],e[r]-=a+s}for(r=t,a=l*e[r-1],n=o+1;n--;r+=2){if(s=l*e[r+1],e[r]-=a+s,!n--)break;r+=2,a=l*e[r+1],e[r]-=a+s}if(0!==o)for(r=t+1,a=c*e[r-1],n=o;n--;r+=2){if(s=c*e[r+1],e[r]-=a+s,!n--)break;r+=2,a=c*e[r+1],e[r]-=a+s}},e}(),S=function(){function e(){P.call(this)}return e.prototype=Object.create(P.prototype),e.prototype.filter=function(e,t,i){var r,n,a=i>>1;for(t|=0,r=t,n=a+1;n--;r+=2)e[r]-=e[r-1]+e[r+1]+2>>2;for(r=t+1,n=a;n--;r+=2)e[r]+=e[r-1]+e[r+1]>>1},e}();return t}();exports.JpxImage=JpxImage;