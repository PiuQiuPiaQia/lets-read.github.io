"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PartialEvaluator=void 0;var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_util=require("../shared/util"),_cmap=require("./cmap"),_stream=require("./stream"),_primitives=require("./primitives"),_fonts=require("./fonts"),_encodings=require("./encodings"),_unicode=require("./unicode"),_standard_fonts=require("./standard_fonts"),_pattern=require("./pattern"),_parser=require("./parser"),_bidi=require("./bidi"),_colorspace=require("./colorspace"),_glyphlist=require("./glyphlist"),_metrics=require("./metrics"),_function=require("./function"),_jpeg_stream=require("./jpeg_stream"),_murmurhash=require("./murmurhash3"),_operator_list=require("./operator_list"),_image=require("./image");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise((function(e,i){function r(a,n){try{var s=t[a](n),o=s.value}catch(l){return void i(l)}if(!s.done)return Promise.resolve(o).then((function(e){r("next",e)}),(function(e){r("throw",e)}));e(o)}return r("next")}))}}var PartialEvaluator=function(){var e={forceDataSchema:!1,maxImageSize:-1,disableFontFace:!1,nativeImageDecoderSupport:_util.NativeImageDecoding.DECODE,ignoreErrors:!1,isEvalSupported:!0};function t(e){var t=e.xref,i=e.resources,r=e.handler,a=e.forceDataSchema,n=void 0!==a&&a,s=e.pdfFunctionFactory;this.xref=t,this.resources=i,this.handler=r,this.forceDataSchema=n,this.pdfFunctionFactory=s}function i(t){var i=this,r=t.pdfManager,a=t.xref,n=t.handler,s=t.pageIndex,o=t.idFactory,l=t.fontCache,c=t.builtInCMapCache,u=t.options,d=void 0===u?null:u,g=t.pdfFunctionFactory;this.pdfManager=r,this.xref=a,this.handler=n,this.pageIndex=s,this.idFactory=o,this.fontCache=l,this.builtInCMapCache=c,this.options=d||e,this.pdfFunctionFactory=g,this.fetchBuiltInCMap=function(){var e=_asyncToGenerator(_regenerator2.default.mark((function e(t){var r;return _regenerator2.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!i.builtInCMapCache.has(t)){e.next=2;break}return e.abrupt("return",i.builtInCMapCache.get(t));case 2:return e.next=4,i.handler.sendWithPromise("FetchBuiltInCMap",{name:t});case 4:return r=e.sent,r.compressionType!==_util.CMapCompressionType.NONE&&i.builtInCMapCache.set(t,r),e.abrupt("return",r);case 7:case"end":return e.stop()}}),e,i)})));return function(t){return e.apply(this,arguments)}}()}t.prototype={canDecode:function(e){return e instanceof _jpeg_stream.JpegStream&&t.isDecodable(e,this.xref,this.resources,this.pdfFunctionFactory)},decode:function(e){var t=e.dict,i=t.get("ColorSpace","CS");return i=_colorspace.ColorSpace.parse(i,this.xref,this.resources,this.pdfFunctionFactory),this.handler.sendWithPromise("JpegDecode",[e.getIR(this.forceDataSchema),i.numComps]).then((function(t){var i=t.data;t.width,t.height;return new _stream.Stream(i,0,i.length,e.dict)}))}},t.isSupported=function(e,t,i,r){var a=e.dict;if(a.has("DecodeParms")||a.has("DP"))return!1;var n=_colorspace.ColorSpace.parse(a.get("ColorSpace","CS"),t,i,r);return("DeviceGray"===n.name||"DeviceRGB"===n.name)&&n.isDefaultDecode(a.getArray("Decode","D"))},t.isDecodable=function(e,t,i,r){var a=e.dict;if(a.has("DecodeParms")||a.has("DP"))return!1;var n=_colorspace.ColorSpace.parse(a.get("ColorSpace","CS"),t,i,r);return(1===n.numComps||3===n.numComps)&&n.isDefaultDecode(a.getArray("Decode","D"))};var r=20,a=100;function n(){this.reset()}function s(e){if(!(0,_primitives.isName)(e))return"source-over";switch(e.name){case"Normal":case"Compatible":return"source-over";case"Multiply":return"multiply";case"Screen":return"screen";case"Overlay":return"overlay";case"Darken":return"darken";case"Lighten":return"lighten";case"ColorDodge":return"color-dodge";case"ColorBurn":return"color-burn";case"HardLight":return"hard-light";case"SoftLight":return"soft-light";case"Difference":return"difference";case"Exclusion":return"exclusion";case"Hue":return"hue";case"Saturation":return"saturation";case"Color":return"color";case"Luminosity":return"luminosity"}return(0,_util.warn)("Unsupported blend mode: "+e.name),"source-over"}n.prototype={check:function(){return!(++this.checked<a)&&(this.checked=0,this.endTime<=Date.now())},reset:function(){this.endTime=Date.now()+r,this.checked=0}};var o=Promise.resolve(),l=1,c=2;return i.prototype={clone:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e,i=Object.create(this);return i.options=t,i},hasBlendModes:function(e){if(!(0,_primitives.isDict)(e))return!1;var t=Object.create(null);e.objId&&(t[e.objId]=!0);var i=[e],r=this.xref;while(i.length){var a,n,s,o=i.shift(),l=o.get("ExtGState");if((0,_primitives.isDict)(l)){var c=l.getKeys();for(n=0,s=c.length;n<s;n++){a=c[n];var u=l.get(a),d=u.get("BM");if((0,_primitives.isName)(d)&&"Normal"!==d.name)return!0}}var g=o.get("XObject");if((0,_primitives.isDict)(g)){var f=g.getKeys();for(n=0,s=f.length;n<s;n++){a=f[n];var h=g.getRaw(a);if((0,_primitives.isRef)(h)){if(t[h.toString()])continue;h=r.fetch(h)}if((0,_primitives.isStream)(h)){if(h.dict.objId){if(t[h.dict.objId])continue;t[h.dict.objId]=!0}var p=h.dict.get("Resources");!(0,_primitives.isDict)(p)||p.objId&&t[p.objId]||(i.push(p),p.objId&&(t[p.objId]=!0))}}}}return!1},buildFormXObject:function(e,t,i,r,a,n){var s=t.dict,o=s.getArray("Matrix"),l=s.getArray("BBox"),c=s.get("Group");if(c){var u={matrix:o,bbox:l,smask:i,isolated:!1,knockout:!1},d=c.get("S"),g=null;(0,_primitives.isName)(d,"Transparency")&&(u.isolated=c.get("I")||!1,u.knockout=c.get("K")||!1,c.has("CS")&&(g=_colorspace.ColorSpace.parse(c.get("CS"),this.xref,e,this.pdfFunctionFactory))),i&&i.backdrop&&(g=g||_colorspace.ColorSpace.singletons.rgb,i.backdrop=g.getRgb(i.backdrop,0)),r.addOp(_util.OPS.beginGroup,[u])}return r.addOp(_util.OPS.paintFormXObjectBegin,[o,l]),this.getOperatorList({stream:t,task:a,resources:s.get("Resources")||e,operatorList:r,initialState:n}).then((function(){r.addOp(_util.OPS.paintFormXObjectEnd,[]),c&&r.addOp(_util.OPS.endGroup,[u])}))},buildPaintImageXObject:function(e){var i=this,r=e.resources,a=e.image,n=e.isInline,s=void 0!==n&&n,o=e.operatorList,l=e.cacheKey,c=e.imageCache,u=e.forceDisableNativeImageDecoder,d=void 0!==u&&u,g=a.dict,f=g.get("Width","W"),h=g.get("Height","H");if(!f||!(0,_util.isNum)(f)||!h||!(0,_util.isNum)(h))return(0,_util.warn)("Image dimensions are missing, or not numbers."),Promise.resolve();var p=this.options.maxImageSize;if(-1!==p&&f*h>p)return(0,_util.warn)("Image exceeded maximum allowed size and was removed."),Promise.resolve();var m,v,_=g.get("ImageMask","IM")||!1;if(_){var S=g.get("Width","W"),b=g.get("Height","H"),P=S+7>>3,O=a.getBytes(P*b,!0),A=g.getArray("Decode","D");return m=_image.PDFImage.createMask({imgArray:O,width:S,height:b,imageIsFromDecodeStream:a instanceof _stream.DecodeStream,inverseDecode:!!A&&A[0]>0}),m.cached=!0,v=[m],o.addOp(_util.OPS.paintImageMaskXObject,v),l&&(c[l]={fn:_util.OPS.paintImageMaskXObject,args:v}),Promise.resolve()}var x=g.get("SMask","SM")||!1,y=g.get("Mask")||!1,F=200;if(s&&!x&&!y&&!(a instanceof _jpeg_stream.JpegStream)&&f+h<F){var M=new _image.PDFImage({xref:this.xref,res:r,image:a,isInline:s,pdfFunctionFactory:this.pdfFunctionFactory});return m=M.createImageData(!0),o.addOp(_util.OPS.paintInlineImageXObject,[m]),Promise.resolve()}var C=d?_util.NativeImageDecoding.NONE:this.options.nativeImageDecoderSupport,T="img_"+this.idFactory.createObjId();if(C!==_util.NativeImageDecoding.NONE&&!x&&!y&&a instanceof _jpeg_stream.JpegStream&&t.isSupported(a,this.xref,r,this.pdfFunctionFactory))return this.handler.sendWithPromise("obj",[T,this.pageIndex,"JpegStream",a.getIR(this.options.forceDataSchema)]).then((function(){o.addDependency(T),v=[T,f,h],o.addOp(_util.OPS.paintJpegXObject,v),l&&(c[l]={fn:_util.OPS.paintJpegXObject,args:v})}),(function(e){return(0,_util.warn)("Native JPEG decoding failed -- trying to recover: "+(e&&e.message)),i.buildPaintImageXObject({resources:r,image:a,isInline:s,operatorList:o,cacheKey:l,imageCache:c,forceDisableNativeImageDecoder:!0})}));var w=null;return C===_util.NativeImageDecoding.DECODE&&(a instanceof _jpeg_stream.JpegStream||y instanceof _jpeg_stream.JpegStream||x instanceof _jpeg_stream.JpegStream)&&(w=new t({xref:this.xref,resources:r,handler:this.handler,forceDataSchema:this.options.forceDataSchema,pdfFunctionFactory:this.pdfFunctionFactory})),o.addDependency(T),v=[T,f,h],_image.PDFImage.buildImage({handler:this.handler,xref:this.xref,res:r,image:a,isInline:s,nativeDecoder:w,pdfFunctionFactory:this.pdfFunctionFactory}).then((function(e){var t=e.createImageData(!1);i.handler.send("obj",[T,i.pageIndex,"Image",t],[t.data.buffer])})).catch((function(e){(0,_util.warn)("Unable to decode image: "+e),i.handler.send("obj",[T,i.pageIndex,"Image",null])})),o.addOp(_util.OPS.paintImageXObject,v),l&&(c[l]={fn:_util.OPS.paintImageXObject,args:v}),Promise.resolve()},handleSMask:function(e,t,i,r,a){var n=e.get("G"),s={subtype:e.get("S").name,backdrop:e.get("BC")},o=e.get("TR");if((0,_function.isPDFFunction)(o)){for(var l=this.pdfFunctionFactory.create(o),c=new Uint8Array(256),u=new Float32Array(1),d=0;d<256;d++)u[0]=d/255,l(u,0,u,0),c[d]=255*u[0]|0;s.transferMap=c}return this.buildFormXObject(t,n,s,i,r,a.state.clone())},handleTilingType:function(e,t,i,r,a,n,s){var o=this,l=new _operator_list.OperatorList,c=[a.get("Resources"),i],u=_primitives.Dict.merge(this.xref,c);return this.getOperatorList({stream:r,task:s,resources:u,operatorList:l}).then((function(){return(0,_pattern.getTilingPatternIR)({fnArray:l.fnArray,argsArray:l.argsArray},a,t)})).then((function(t){n.addDependencies(l.dependencies),n.addOp(e,t)}),(function(e){if(o.options.ignoreErrors)return o.handler.send("UnsupportedFeature",{featureId:_util.UNSUPPORTED_FEATURES.unknown}),void(0,_util.warn)('handleTilingType - ignoring pattern: "'+e+'".');throw e}))},handleSetFont:function(e,t,i,r,a,n){var s,o=this;return t&&(t=t.slice(),s=t[0].name),this.loadFont(s,i,e).then((function(t){return t.font.isType3Font?t.loadType3Data(o,e,r,a).then((function(){return t})).catch((function(e){return o.handler.send("UnsupportedFeature",{featureId:_util.UNSUPPORTED_FEATURES.font}),new TranslatedFont("g_font_error",new _fonts.ErrorFont("Type3 font load error: "+e),t.font)})):t})).then((function(e){return n.font=e.font,e.send(o.handler),e.loadedName}))},handleText:function(e,t){var i=this,r=t.font,a=r.charsToGlyphs(e),n=!!(t.textRenderingMode&_util.TextRenderingMode.ADD_TO_PATH_FLAG);if(r.data&&(n||this.options.disableFontFace||"Pattern"===t.fillColorSpace.name))for(var s=function(e){if(!r.renderer.hasBuiltPath(e)){var t=r.renderer.getPathJs(e);i.handler.send("commonobj",[r.loadedName+"_path_"+e,"FontPath",t])}},o=0,l=a.length;o<l;o++){var c=a[o];s(c.fontChar);var u=c.accent;u&&u.fontChar&&s(u.fontChar)}return a},setGState:function(e,t,i,r,a){for(var n=this,o=[],l=t.getKeys(),c=Promise.resolve(),u=function(){var u=l[d],g=t.get(u);switch(u){case"Type":break;case"LW":case"LC":case"LJ":case"ML":case"D":case"RI":case"FL":case"CA":case"ca":o.push([u,g]);break;case"Font":c=c.then((function(){return n.handleSetFont(e,null,g[0],i,r,a.state).then((function(e){i.addDependency(e),o.push([u,[e,g[1]]])}))}));break;case"BM":o.push([u,s(g)]);break;case"SMask":if((0,_primitives.isName)(g,"None")){o.push([u,!1]);break}(0,_primitives.isDict)(g)?(c=c.then((function(){return n.handleSMask(g,e,i,r,a)})),o.push([u,!0])):(0,_util.warn)("Unsupported SMask type");break;case"OP":case"op":case"OPM":case"BG":case"BG2":case"UCR":case"UCR2":case"TR":case"TR2":case"HT":case"SM":case"SA":case"AIS":case"TK":(0,_util.info)("graphic state operator "+u);break;default:(0,_util.info)("Unknown graphic state operator "+u);break}},d=0,g=l.length;d<g;d++)u();return c.then((function(){o.length>0&&i.addOp(_util.OPS.setGState,[o])}))},loadFont:function(e,t,i){var r=this;function a(){return Promise.resolve(new TranslatedFont("g_font_error",new _fonts.ErrorFont("Font "+e+" is not available"),t))}var n,s=this.xref;if(t){if(!(0,_primitives.isRef)(t))throw new Error('The "font" object should be a reference.');n=t}else{var o=i.get("Font");if(!o)return(0,_util.warn)("fontRes not available"),a();n=o.getRaw(e)}if(!n)return(0,_util.warn)("fontRef not available"),a();if(this.fontCache.has(n))return this.fontCache.get(n);if(t=s.fetchIfRef(n),!(0,_primitives.isDict)(t))return a();if(t.translated)return t.translated;var l,c,u=(0,_util.createPromiseCapability)(),d=this.preEvaluateFont(t),g=d.descriptor,f=(0,_primitives.isRef)(n);if(f&&(l=n.toString()),(0,_primitives.isDict)(g)){g.fontAliases||(g.fontAliases=Object.create(null));var h=g.fontAliases,p=d.hash;if(h[p]){var m=h[p].aliasRef;if(f&&m&&this.fontCache.has(m))return this.fontCache.putAlias(n,m),this.fontCache.get(n)}else h[p]={fontID:_fonts.Font.getFontID()};f&&(h[p].aliasRef=n),l=h[p].fontID}f?this.fontCache.put(n,u.promise):(l||(l=this.idFactory.createObjId()),this.fontCache.put("id_"+l,u.promise)),(0,_util.assert)(l,'The "fontID" must be defined.'),t.loadedName="g_"+this.pdfManager.docId+"_f"+l,t.translated=u.promise;try{c=this.translateFont(d)}catch(v){c=Promise.reject(v)}return c.then((function(e){if(void 0!==e.fontType){var i=s.stats.fontTypes;i[e.fontType]=!0}u.resolve(new TranslatedFont(t.loadedName,e,t))})).catch((function(e){r.handler.send("UnsupportedFeature",{featureId:_util.UNSUPPORTED_FEATURES.font});try{var i=d.descriptor,a=i&&i.get("FontFile3"),n=a&&a.get("Subtype"),o=(0,_fonts.getFontType)(d.type,n&&n.name),l=s.stats.fontTypes;l[o]=!0}catch(c){}u.resolve(new TranslatedFont(t.loadedName,new _fonts.ErrorFont(e instanceof Error?e.message:e),t))})),u.promise},buildPath:function(e,t,i){var r=e.length-1;if(i||(i=[]),r<0||e.fnArray[r]!==_util.OPS.constructPath)e.addOp(_util.OPS.constructPath,[[t],i]);else{var a=e.argsArray[r];a[0].push(t),Array.prototype.push.apply(a[1],i)}},handleColorN:function(e,t,i,r,a,n,s){var o,u=i[i.length-1];if((0,_primitives.isName)(u)&&(o=a.get(u.name))){var d=(0,_primitives.isStream)(o)?o.dict:o,g=d.get("PatternType");if(g===l){var f=r.base?r.base.getRgb(i,0):null;return this.handleTilingType(t,f,n,o,d,e,s)}if(g===c){var h=d.get("Shading"),p=d.getArray("Matrix");return o=_pattern.Pattern.parseShading(h,p,this.xref,n,this.handler,this.pdfFunctionFactory),e.addOp(t,o.getIR()),Promise.resolve()}return Promise.reject(new Error("Unknown PatternType: "+g))}return e.addOp(t,i),Promise.resolve()},getOperatorList:function(e){var t=this,i=e.stream,r=e.task,a=e.resources,s=e.operatorList,l=e.initialState,c=void 0===l?null:l;if(a=a||_primitives.Dict.empty,c=c||new EvalState,!s)throw new Error('getOperatorList: missing "operatorList" parameter');var u=this,d=this.xref,g=Object.create(null),f=a.get("XObject")||_primitives.Dict.empty,h=a.get("Pattern")||_primitives.Dict.empty,p=new StateManager(c),m=new EvaluatorPreprocessor(i,d,p),v=new n;function _(e){for(var t=0,i=m.savedStatesDepth;t<i;t++)s.addOp(_util.OPS.restore,[])}return new Promise((function e(t,i){var n=function(r){r.then((function(){try{e(t,i)}catch(r){i(r)}}),i)};r.ensureNotTerminated(),v.reset();var l,c,S,b,P={};while(!(l=v.check())){if(P.args=null,!m.read(P))break;var O=P.args,A=P.fn;switch(0|A){case _util.OPS.paintXObject:var x=O[0].name;if(x&&void 0!==g[x]){s.addOp(g[x].fn,g[x].args),O=null;continue}return void n(new Promise((function(e,t){if(!x)throw new _util.FormatError("XObject must be referred to by name.");var i=f.get(x);if(!i)return s.addOp(A,O),void e();if(!(0,_primitives.isStream)(i))throw new _util.FormatError("XObject should be a stream");var n=i.dict.get("Subtype");if(!(0,_primitives.isName)(n))throw new _util.FormatError("XObject should have a Name subtype");if("Form"===n.name)return p.save(),void u.buildFormXObject(a,i,null,s,r,p.state.clone()).then((function(){p.restore(),e()}),t);if("Image"!==n.name){if("PS"!==n.name)throw new _util.FormatError("Unhandled XObject subtype "+n.name);(0,_util.info)("Ignored XObject subtype PS"),e()}else u.buildPaintImageXObject({resources:a,image:i,operatorList:s,cacheKey:x,imageCache:g}).then(e,t)})).catch((function(e){if(u.options.ignoreErrors)return u.handler.send("UnsupportedFeature",{featureId:_util.UNSUPPORTED_FEATURES.unknown}),void(0,_util.warn)('getOperatorList - ignoring XObject: "'+e+'".');throw e})));case _util.OPS.setFont:var y=O[1];return void n(u.handleSetFont(a,O,null,s,r,p.state).then((function(e){s.addDependency(e),s.addOp(_util.OPS.setFont,[e,y])})));case _util.OPS.endInlineImage:var F=O[0].cacheKey;if(F){var M=g[F];if(void 0!==M){s.addOp(M.fn,M.args),O=null;continue}}return void n(u.buildPaintImageXObject({resources:a,image:O[0],isInline:!0,operatorList:s,cacheKey:F,imageCache:g}));case _util.OPS.showText:O[0]=u.handleText(O[0],p.state);break;case _util.OPS.showSpacedText:var C=O[0],T=[],w=C.length,I=p.state;for(c=0;c<w;++c){var k=C[c];(0,_util.isString)(k)?Array.prototype.push.apply(T,u.handleText(k,I)):(0,_util.isNum)(k)&&T.push(k)}O[0]=T,A=_util.OPS.showText;break;case _util.OPS.nextLineShowText:s.addOp(_util.OPS.nextLine),O[0]=u.handleText(O[0],p.state),A=_util.OPS.showText;break;case _util.OPS.nextLineSetSpacingShowText:s.addOp(_util.OPS.nextLine),s.addOp(_util.OPS.setWordSpacing,[O.shift()]),s.addOp(_util.OPS.setCharSpacing,[O.shift()]),O[0]=u.handleText(O[0],p.state),A=_util.OPS.showText;break;case _util.OPS.setTextRenderingMode:p.state.textRenderingMode=O[0];break;case _util.OPS.setFillColorSpace:p.state.fillColorSpace=_colorspace.ColorSpace.parse(O[0],d,a,u.pdfFunctionFactory);continue;case _util.OPS.setStrokeColorSpace:p.state.strokeColorSpace=_colorspace.ColorSpace.parse(O[0],d,a,u.pdfFunctionFactory);continue;case _util.OPS.setFillColor:b=p.state.fillColorSpace,O=b.getRgb(O,0),A=_util.OPS.setFillRGBColor;break;case _util.OPS.setStrokeColor:b=p.state.strokeColorSpace,O=b.getRgb(O,0),A=_util.OPS.setStrokeRGBColor;break;case _util.OPS.setFillGray:p.state.fillColorSpace=_colorspace.ColorSpace.singletons.gray,O=_colorspace.ColorSpace.singletons.gray.getRgb(O,0),A=_util.OPS.setFillRGBColor;break;case _util.OPS.setStrokeGray:p.state.strokeColorSpace=_colorspace.ColorSpace.singletons.gray,O=_colorspace.ColorSpace.singletons.gray.getRgb(O,0),A=_util.OPS.setStrokeRGBColor;break;case _util.OPS.setFillCMYKColor:p.state.fillColorSpace=_colorspace.ColorSpace.singletons.cmyk,O=_colorspace.ColorSpace.singletons.cmyk.getRgb(O,0),A=_util.OPS.setFillRGBColor;break;case _util.OPS.setStrokeCMYKColor:p.state.strokeColorSpace=_colorspace.ColorSpace.singletons.cmyk,O=_colorspace.ColorSpace.singletons.cmyk.getRgb(O,0),A=_util.OPS.setStrokeRGBColor;break;case _util.OPS.setFillRGBColor:p.state.fillColorSpace=_colorspace.ColorSpace.singletons.rgb,O=_colorspace.ColorSpace.singletons.rgb.getRgb(O,0);break;case _util.OPS.setStrokeRGBColor:p.state.strokeColorSpace=_colorspace.ColorSpace.singletons.rgb,O=_colorspace.ColorSpace.singletons.rgb.getRgb(O,0);break;case _util.OPS.setFillColorN:if(b=p.state.fillColorSpace,"Pattern"===b.name)return void n(u.handleColorN(s,_util.OPS.setFillColorN,O,b,h,a,r));O=b.getRgb(O,0),A=_util.OPS.setFillRGBColor;break;case _util.OPS.setStrokeColorN:if(b=p.state.strokeColorSpace,"Pattern"===b.name)return void n(u.handleColorN(s,_util.OPS.setStrokeColorN,O,b,h,a,r));O=b.getRgb(O,0),A=_util.OPS.setStrokeRGBColor;break;case _util.OPS.shadingFill:var D=a.get("Shading");if(!D)throw new _util.FormatError("No shading resource found");var R=D.get(O[0].name);if(!R)throw new _util.FormatError("No shading object found");var E=_pattern.Pattern.parseShading(R,null,d,a,u.handler,u.pdfFunctionFactory),N=E.getIR();O=[N],A=_util.OPS.shadingFill;break;case _util.OPS.setGState:var L=O[0],j=a.get("ExtGState");if(!(0,_primitives.isDict)(j)||!j.has(L.name))break;var U=j.get(L.name);return void n(u.setGState(a,U,s,r,p));case _util.OPS.moveTo:case _util.OPS.lineTo:case _util.OPS.curveTo:case _util.OPS.curveTo2:case _util.OPS.curveTo3:case _util.OPS.closePath:u.buildPath(s,A,O);continue;case _util.OPS.rectangle:u.buildPath(s,A,O);continue;case _util.OPS.markPoint:case _util.OPS.markPointProps:case _util.OPS.beginMarkedContent:case _util.OPS.beginMarkedContentProps:case _util.OPS.endMarkedContent:case _util.OPS.beginCompat:case _util.OPS.endCompat:continue;default:if(null!==O){for(c=0,S=O.length;c<S;c++)if(O[c]instanceof _primitives.Dict)break;if(c<S){(0,_util.warn)("getOperatorList - ignoring operator: "+A);continue}}}s.addOp(A,O)}l?n(o):(_(),t())})).catch((function(e){if(t.options.ignoreErrors)return t.handler.send("UnsupportedFeature",{featureId:_util.UNSUPPORTED_FEATURES.unknown}),(0,_util.warn)('getOperatorList - ignoring errors during "'+r.name+'" task: "'+e+'".'),void _();throw e}))},getTextContent:function(e){var t=this,i=e.stream,r=e.task,a=e.resources,s=e.stateManager,l=void 0===s?null:s,c=e.normalizeWhitespace,u=void 0!==c&&c,d=e.combineTextItems,g=void 0!==d&&d,f=e.sink,h=e.seenStyles,p=void 0===h?Object.create(null):h;a=a||_primitives.Dict.empty,l=l||new StateManager(new TextState);var m,v=/\s/g,_={items:[],styles:Object.create(null)},S={initialized:!1,str:[],width:0,height:0,vertical:!1,lastAdvanceWidth:0,lastAdvanceHeight:0,textAdvanceScale:0,spaceWidth:0,fakeSpaceMin:1/0,fakeMultiSpaceMin:1/0,fakeMultiSpaceMax:-0,textRunBreakAllowed:!1,transform:null,fontName:null},b=.3,P=1.5,O=4,A=this,x=this.xref,y=null,F=Object.create(null),M=new EvaluatorPreprocessor(i,x,l);function C(){if(S.initialized)return S;var e=m.font;e.loadedName in p||(p[e.loadedName]=!0,_.styles[e.loadedName]={fontFamily:e.fallbackName,ascent:e.ascent,descent:e.descent,vertical:e.vertical}),S.fontName=e.loadedName;var t=[m.fontSize*m.textHScale,0,0,m.fontSize,0,m.textRise];if(e.isType3Font&&m.fontMatrix!==_util.FONT_IDENTITY_MATRIX&&1===m.fontSize){var i=e.bbox[3]-e.bbox[1];i>0&&(i*=m.fontMatrix[3],t[3]*=i)}var r=_util.Util.transform(m.ctm,_util.Util.transform(m.textMatrix,t));S.transform=r,e.vertical?(S.width=Math.sqrt(r[0]*r[0]+r[1]*r[1]),S.height=0,S.vertical=!0):(S.width=0,S.height=Math.sqrt(r[2]*r[2]+r[3]*r[3]),S.vertical=!1);var a=m.textLineMatrix[0],n=m.textLineMatrix[1],s=Math.sqrt(a*a+n*n);a=m.ctm[0],n=m.ctm[1];var o=Math.sqrt(a*a+n*n);S.textAdvanceScale=o*s,S.lastAdvanceWidth=0,S.lastAdvanceHeight=0;var l=e.spaceWidth/1e3*m.fontSize;return l?(S.spaceWidth=l,S.fakeSpaceMin=l*b,S.fakeMultiSpaceMin=l*P,S.fakeMultiSpaceMax=l*O,S.textRunBreakAllowed=!e.isMonospace):(S.spaceWidth=0,S.fakeSpaceMin=1/0,S.fakeMultiSpaceMin=1/0,S.fakeMultiSpaceMax=0,S.textRunBreakAllowed=!1),S.initialized=!0,S}function T(e){var t,i=0,r=e.length;while(i<r&&(t=e.charCodeAt(i))>=32&&t<=127)i++;return i<r?e.replace(v," "):e}function w(e){var t=e.str.join(""),i=(0,_bidi.bidi)(t,-1,e.vertical);return{str:u?T(i.str):i.str,dir:i.dir,width:e.width,height:e.height,transform:e.transform,fontName:e.fontName}}function I(e,t){return A.loadFont(e,t,a).then((function(e){m.font=e.font,m.fontMatrix=e.font.fontMatrix||_util.FONT_IDENTITY_MATRIX}))}function k(e){for(var t=m.font,i=C(),r=0,a=0,n=t.charsToGlyphs(e),s=0;s<n.length;s++){var o=n[s],l=null;l=t.vertical&&o.vmetric?o.vmetric[0]:o.width;var c=o.unicode,u=(0,_unicode.getNormalizedUnicodes)();void 0!==u[c]&&(c=u[c]),c=(0,_unicode.reverseIfRtl)(c);var d=m.charSpacing;if(o.isSpace){var g=m.wordSpacing;d+=g,g>0&&D(g,i.str)}var f=0,h=0;if(t.vertical){var p=l*m.fontMatrix[0];h=p*m.fontSize+d,a+=h}else{var v=l*m.fontMatrix[0];f=(v*m.fontSize+d)*m.textHScale,r+=f}m.translateTextMatrix(f,h),i.str.push(c)}return t.vertical?(i.lastAdvanceHeight=a,i.height+=Math.abs(a)):(i.lastAdvanceWidth=r,i.width+=r),i}function D(e,t){if(!(e<S.fakeSpaceMin))if(e<S.fakeMultiSpaceMin)t.push(" ");else{var i=Math.round(e/S.spaceWidth);while(i-- >0)t.push(" ")}}function R(){S.initialized&&(S.width*=S.textAdvanceScale,S.height*=S.textAdvanceScale,_.items.push(w(S)),S.initialized=!1,S.str.length=0)}function E(){var e=_.items.length;e>0&&(f.enqueue(_,e),_.items=[],_.styles=Object.create(null))}var N=new n;return new Promise((function e(t,i){var n=function(r){E(),Promise.all([r,f.ready]).then((function(){try{e(t,i)}catch(r){i(r)}}),i)};r.ensureNotTerminated(),N.reset();var s,c={},d=[];while(!(s=N.check())){if(d.length=0,c.args=d,!M.read(c))break;m=l.state;var h,v,b=c.fn;switch(d=c.args,0|b){case _util.OPS.setFont:var P=d[0].name,O=d[1];if(m.font&&P===m.fontName&&O===m.fontSize)break;return R(),m.fontName=P,m.fontSize=O,void n(I(P,null));case _util.OPS.setTextRise:R(),m.textRise=d[0];break;case _util.OPS.setHScale:R(),m.textHScale=d[0]/100;break;case _util.OPS.setLeading:R(),m.leading=d[0];break;case _util.OPS.moveText:var x=!!m.font&&0===(m.font.vertical?d[0]:d[1]);if(h=d[0]-d[1],g&&x&&S.initialized&&h>0&&h<=S.fakeMultiSpaceMax){m.translateTextLineMatrix(d[0],d[1]),S.width+=d[0]-S.lastAdvanceWidth,S.height+=d[1]-S.lastAdvanceHeight,v=d[0]-S.lastAdvanceWidth-(d[1]-S.lastAdvanceHeight),D(v,S.str);break}R(),m.translateTextLineMatrix(d[0],d[1]),m.textMatrix=m.textLineMatrix.slice();break;case _util.OPS.setLeadingMoveText:R(),m.leading=-d[1],m.translateTextLineMatrix(d[0],d[1]),m.textMatrix=m.textLineMatrix.slice();break;case _util.OPS.nextLine:R(),m.carriageReturn();break;case _util.OPS.setTextMatrix:if(h=m.calcTextLineMatrixAdvance(d[0],d[1],d[2],d[3],d[4],d[5]),g&&null!==h&&S.initialized&&h.value>0&&h.value<=S.fakeMultiSpaceMax){m.translateTextLineMatrix(h.width,h.height),S.width+=h.width-S.lastAdvanceWidth,S.height+=h.height-S.lastAdvanceHeight,v=h.width-S.lastAdvanceWidth-(h.height-S.lastAdvanceHeight),D(v,S.str);break}R(),m.setTextMatrix(d[0],d[1],d[2],d[3],d[4],d[5]),m.setTextLineMatrix(d[0],d[1],d[2],d[3],d[4],d[5]);break;case _util.OPS.setCharSpacing:m.charSpacing=d[0];break;case _util.OPS.setWordSpacing:m.wordSpacing=d[0];break;case _util.OPS.beginText:R(),m.textMatrix=_util.IDENTITY_MATRIX.slice(),m.textLineMatrix=_util.IDENTITY_MATRIX.slice();break;case _util.OPS.showSpacedText:for(var T,w=d[0],L=0,j=w.length;L<j;L++)if("string"===typeof w[L])k(w[L]);else if((0,_util.isNum)(w[L])){C(),h=w[L]*m.fontSize/1e3;var U=!1;m.font.vertical?(T=h,m.translateTextMatrix(0,T),U=S.textRunBreakAllowed&&h>S.fakeMultiSpaceMax,U||(S.height+=T)):(h=-h,T=h*m.textHScale,m.translateTextMatrix(T,0),U=S.textRunBreakAllowed&&h>S.fakeMultiSpaceMax,U||(S.width+=T)),U?R():h>0&&D(h,S.str)}break;case _util.OPS.showText:k(d[0]);break;case _util.OPS.nextLineShowText:R(),m.carriageReturn(),k(d[0]);break;case _util.OPS.nextLineSetSpacingShowText:R(),m.wordSpacing=d[0],m.charSpacing=d[1],m.carriageReturn(),k(d[2]);break;case _util.OPS.paintXObject:R(),y||(y=a.get("XObject")||_primitives.Dict.empty);var B=d[0].name;if(B&&void 0!==F[B])break;return void n(new Promise((function(e,t){if(!B)throw new _util.FormatError("XObject must be referred to by name.");var i=y.get(B);if(i){if(!(0,_primitives.isStream)(i))throw new _util.FormatError("XObject should be a stream");var n=i.dict.get("Subtype");if(!(0,_primitives.isName)(n))throw new _util.FormatError("XObject should have a Name subtype");if("Form"!==n.name)return F[B]=!0,void e();var s=l.state.clone(),o=new StateManager(s),c=i.dict.getArray("Matrix");Array.isArray(c)&&6===c.length&&o.transform(c),E();var d={enqueueInvoked:!1,enqueue:function(e,t){this.enqueueInvoked=!0,f.enqueue(e,t)},get desiredSize(){return f.desiredSize},get ready(){return f.ready}};A.getTextContent({stream:i,task:r,resources:i.dict.get("Resources")||a,stateManager:o,normalizeWhitespace:u,combineTextItems:g,sink:d,seenStyles:p}).then((function(){d.enqueueInvoked||(F[B]=!0),e()}),t)}else e()})).catch((function(e){if(!(e instanceof _util.AbortException)){if(!A.options.ignoreErrors)throw e;(0,_util.warn)('getTextContent - ignoring XObject: "'+e+'".')}})));case _util.OPS.setGState:R();var W=d[0],G=a.get("ExtGState");if(!(0,_primitives.isDict)(G)||!(0,_primitives.isName)(W))break;var X=G.get(W.name);if(!(0,_primitives.isDict)(X))break;var q=X.get("Font");if(q)return m.fontName=null,m.fontSize=q[1],void n(I(null,q[0]));break}if(_.items.length>=f.desiredSize){s=!0;break}}s?n(o):(R(),E(),t())})).catch((function(e){if(!(e instanceof _util.AbortException)){if(t.options.ignoreErrors)return(0,_util.warn)('getTextContent - ignoring errors during "'+r.name+'" task: "'+e+'".'),R(),void E();throw e}}))},extractDataStructures:function(e,t,i){var r=this,a=this.xref,n=e.get("ToUnicode")||t.get("ToUnicode"),s=n?this.readToUnicode(n):Promise.resolve(void 0);if(i.composite){var o=e.get("CIDSystemInfo");(0,_primitives.isDict)(o)&&(i.cidSystemInfo={registry:(0,_util.stringToPDFString)(o.get("Registry")),ordering:(0,_util.stringToPDFString)(o.get("Ordering")),supplement:o.get("Supplement")});var l=e.get("CIDToGIDMap");(0,_primitives.isStream)(l)&&(i.cidToGidMap=this.readCidToGidMap(l))}var c,u=[],d=null;if(e.has("Encoding")){if(c=e.get("Encoding"),(0,_primitives.isDict)(c)){if(d=c.get("BaseEncoding"),d=(0,_primitives.isName)(d)?d.name:null,c.has("Differences"))for(var g=c.get("Differences"),f=0,h=0,p=g.length;h<p;h++){var m=a.fetchIfRef(g[h]);if((0,_util.isNum)(m))f=m;else{if(!(0,_primitives.isName)(m))throw new _util.FormatError("Invalid entry in 'Differences' array: "+m);u[f++]=m.name}}}else{if(!(0,_primitives.isName)(c))throw new _util.FormatError("Encoding is not a Name nor a Dict");d=c.name}"MacRomanEncoding"!==d&&"MacExpertEncoding"!==d&&"WinAnsiEncoding"!==d&&(d=null)}if(d)i.defaultEncoding=(0,_encodings.getEncoding)(d).slice();else{var v=!!(i.flags&_fonts.FontFlags.Symbolic),_=!!(i.flags&_fonts.FontFlags.Nonsymbolic);c=_encodings.StandardEncoding,"TrueType"!==i.type||_||(c=_encodings.WinAnsiEncoding),v&&(c=_encodings.MacRomanEncoding,i.file||(/Symbol/i.test(i.name)?c=_encodings.SymbolSetEncoding:/Dingbats/i.test(i.name)&&(c=_encodings.ZapfDingbatsEncoding))),i.defaultEncoding=c}return i.differences=u,i.baseEncodingName=d,i.hasEncoding=!!d||u.length>0,i.dict=e,s.then((function(e){return i.toUnicode=e,r.buildToUnicode(i)})).then((function(e){return i.toUnicode=e,i}))},_buildSimpleFontToUnicode:function(e){(0,_util.assert)(!e.composite,"Must be a simple font.");var t=[],i=void 0,r=void 0,a=e.defaultEncoding.slice(),n=e.baseEncodingName,s=e.differences;for(i in s)r=s[i],".notdef"!==r&&(a[i]=r);var o=(0,_glyphlist.getGlyphsUnicode)();for(i in a)if(r=a[i],""!==r)if(void 0!==o[r])t[i]=String.fromCharCode(o[r]);else{var l=0;switch(r[0]){case"G":3===r.length&&(l=parseInt(r.substring(1),16));break;case"g":5===r.length&&(l=parseInt(r.substring(1),16));break;case"C":case"c":r.length>=3&&(l=+r.substring(1));break;default:var c=(0,_unicode.getUnicodeForGlyph)(r,o);-1!==c&&(l=c)}if(l){if(n&&l===+i){var u=(0,_encodings.getEncoding)(n);if(u&&(r=u[i])){t[i]=String.fromCharCode(o[r]);continue}}t[i]=String.fromCharCode(l)}}return new _fonts.ToUnicodeMap(t)},buildToUnicode:function(e){if(e.hasIncludedToUnicodeMap=!!e.toUnicode&&e.toUnicode.length>0,e.hasIncludedToUnicodeMap)return!e.composite&&e.hasEncoding&&(e.fallbackToUnicode=this._buildSimpleFontToUnicode(e)),Promise.resolve(e.toUnicode);if(!e.composite)return Promise.resolve(this._buildSimpleFontToUnicode(e));if(e.composite&&(e.cMap.builtInCMap&&!(e.cMap instanceof _cmap.IdentityCMap)||"Adobe"===e.cidSystemInfo.registry&&("GB1"===e.cidSystemInfo.ordering||"CNS1"===e.cidSystemInfo.ordering||"Japan1"===e.cidSystemInfo.ordering||"Korea1"===e.cidSystemInfo.ordering))){var t=e.cidSystemInfo.registry,i=e.cidSystemInfo.ordering,r=_primitives.Name.get(t+"-"+i+"-UCS2");return _cmap.CMapFactory.create({encoding:r,fetchBuiltInCMap:this.fetchBuiltInCMap,useCMap:null}).then((function(t){var i=e.cMap,r=[];return i.forEach((function(e,i){if(i>65535)throw new _util.FormatError("Max size of CID is 65,535");var a=t.lookup(i);a&&(r[e]=String.fromCharCode((a.charCodeAt(0)<<8)+a.charCodeAt(1)))})),new _fonts.ToUnicodeMap(r)}))}return Promise.resolve(new _fonts.IdentityToUnicodeMap(e.firstChar,e.lastChar))},readToUnicode:function(e){var t=e;return(0,_primitives.isName)(t)?_cmap.CMapFactory.create({encoding:t,fetchBuiltInCMap:this.fetchBuiltInCMap,useCMap:null}).then((function(e){return e instanceof _cmap.IdentityCMap?new _fonts.IdentityToUnicodeMap(0,65535):new _fonts.ToUnicodeMap(e.getMap())})):(0,_primitives.isStream)(t)?_cmap.CMapFactory.create({encoding:t,fetchBuiltInCMap:this.fetchBuiltInCMap,useCMap:null}).then((function(e){if(e instanceof _cmap.IdentityCMap)return new _fonts.IdentityToUnicodeMap(0,65535);var t=new Array(e.length);return e.forEach((function(e,i){for(var r=[],a=0;a<i.length;a+=2){var n=i.charCodeAt(a)<<8|i.charCodeAt(a+1);if(55296===(63488&n)){a+=2;var s=i.charCodeAt(a)<<8|i.charCodeAt(a+1);r.push(((1023&n)<<10)+(1023&s)+65536)}else r.push(n)}t[e]=String.fromCharCode.apply(String,r)})),new _fonts.ToUnicodeMap(t)})):Promise.resolve(null)},readCidToGidMap:function(e){for(var t=e.getBytes(),i=[],r=0,a=t.length;r<a;r++){var n=t[r++]<<8|t[r];if(0!==n){var s=r>>1;i[s]=n}}return i},extractWidths:function(e,t,i){var r,a,n,s,o,l,c,u,d=this.xref,g=[],f=0,h=[];if(i.composite){if(f=e.has("DW")?e.get("DW"):1e3,u=e.get("W"),u)for(a=0,n=u.length;a<n;a++)if(l=d.fetchIfRef(u[a++]),c=d.fetchIfRef(u[a]),Array.isArray(c))for(s=0,o=c.length;s<o;s++)g[l++]=d.fetchIfRef(c[s]);else{var p=d.fetchIfRef(u[++a]);for(s=l;s<=c;s++)g[s]=p}if(i.vertical){var m=e.getArray("DW2")||[880,-1e3];if(r=[m[1],.5*f,m[0]],m=e.get("W2"),m)for(a=0,n=m.length;a<n;a++)if(l=d.fetchIfRef(m[a++]),c=d.fetchIfRef(m[a]),Array.isArray(c))for(s=0,o=c.length;s<o;s++)h[l++]=[d.fetchIfRef(c[s++]),d.fetchIfRef(c[s++]),d.fetchIfRef(c[s])];else{var v=[d.fetchIfRef(m[++a]),d.fetchIfRef(m[++a]),d.fetchIfRef(m[++a])];for(s=l;s<=c;s++)h[s]=v}}}else{var _=i.firstChar;if(u=e.get("Widths"),u){for(s=_,a=0,n=u.length;a<n;a++)g[s++]=d.fetchIfRef(u[a]);f=parseFloat(t.get("MissingWidth"))||0}else{var S=e.get("BaseFont");if((0,_primitives.isName)(S)){var b=this.getBaseFontMetrics(S.name);g=this.buildCharCodeToWidth(b.widths,i),f=b.defaultWidth}}}var P=!0,O=f;for(var A in g){var x=g[A];if(x)if(O){if(O!==x){P=!1;break}}else O=x}P&&(i.flags|=_fonts.FontFlags.FixedPitch),i.defaultWidth=f,i.widths=g,i.defaultVMetrics=r,i.vmetrics=h},isSerifFont:function(e){var t=e.split("-")[0];return t in(0,_standard_fonts.getSerifFonts)()||-1!==t.search(/serif/gi)},getBaseFontMetrics:function(e){var t=0,i=[],r=!1,a=(0,_standard_fonts.getStdFontMap)(),n=a[e]||e,s=(0,_metrics.getMetrics)();n in s||(n=this.isSerifFont(e)?"Times-Roman":"Helvetica");var o=s[n];return(0,_util.isNum)(o)?(t=o,r=!0):i=o(),{defaultWidth:t,monospace:r,widths:i}},buildCharCodeToWidth:function(e,t){for(var i=Object.create(null),r=t.differences,a=t.defaultEncoding,n=0;n<256;n++)n in r&&e[r[n]]?i[n]=e[r[n]]:n in a&&e[a[n]]&&(i[n]=e[a[n]]);return i},preEvaluateFont:function(e){var t=e,i=e.get("Subtype");if(!(0,_primitives.isName)(i))throw new _util.FormatError("invalid font Subtype");var r,a=!1;if("Type0"===i.name){var n=e.get("DescendantFonts");if(!n)throw new _util.FormatError("Descendant fonts are not specified");if(e=Array.isArray(n)?this.xref.fetchIfRef(n[0]):n,i=e.get("Subtype"),!(0,_primitives.isName)(i))throw new _util.FormatError("invalid font Subtype");a=!0}var s=e.get("FontDescriptor");if(s){var o=new _murmurhash.MurmurHash3_64,l=t.getRaw("Encoding");if((0,_primitives.isName)(l))o.update(l.name);else if((0,_primitives.isRef)(l))o.update(l.toString());else if((0,_primitives.isDict)(l))for(var c=l.getKeys(),u=0,d=c.length;u<d;u++){var g=l.getRaw(c[u]);if((0,_primitives.isName)(g))o.update(g.name);else if((0,_primitives.isRef)(g))o.update(g.toString());else if(Array.isArray(g)){for(var f=g.length,h=new Array(f),p=0;p<f;p++){var m=g[p];(0,_primitives.isName)(m)?h[p]=m.name:((0,_util.isNum)(m)||(0,_primitives.isRef)(m))&&(h[p]=m.toString())}o.update(h.join())}}var v=e.get("ToUnicode")||t.get("ToUnicode");if((0,_primitives.isStream)(v)){var _=v.str||v;r=_.buffer?new Uint8Array(_.buffer.buffer,0,_.bufferLength):new Uint8Array(_.bytes.buffer,_.start,_.end-_.start),o.update(r)}else(0,_primitives.isName)(v)&&o.update(v.name);var S=e.get("Widths")||t.get("Widths");S&&(r=new Uint8Array(new Uint32Array(S).buffer),o.update(r))}return{descriptor:s,dict:e,baseDict:t,composite:a,type:i.name,hash:o?o.hexdigest():""}},translateFont:function(e){var t,i=this,r=e.baseDict,a=e.dict,n=e.composite,s=e.descriptor,o=e.type,l=n?65535:255;if(!s){if("Type3"!==o){var c=a.get("BaseFont");if(!(0,_primitives.isName)(c))throw new _util.FormatError("Base font is not specified");c=c.name.replace(/[,_]/g,"-");var u=this.getBaseFontMetrics(c),d=c.split("-")[0],g=(this.isSerifFont(d)?_fonts.FontFlags.Serif:0)|(u.monospace?_fonts.FontFlags.FixedPitch:0)|((0,_standard_fonts.getSymbolsFonts)()[d]?_fonts.FontFlags.Symbolic:_fonts.FontFlags.Nonsymbolic);return t={type:o,name:c,widths:u.widths,defaultWidth:u.defaultWidth,flags:g,firstChar:0,lastChar:l},this.extractDataStructures(a,a,t).then((function(e){return e.widths=i.buildCharCodeToWidth(u.widths,e),new _fonts.Font(c,null,e)}))}s=new _primitives.Dict(null),s.set("FontName",_primitives.Name.get(o)),s.set("FontBBox",a.getArray("FontBBox"))}var f=a.get("FirstChar")||0,h=a.get("LastChar")||l,p=s.get("FontName"),m=a.get("BaseFont");if((0,_util.isString)(p)&&(p=_primitives.Name.get(p)),(0,_util.isString)(m)&&(m=_primitives.Name.get(m)),"Type3"!==o){var v=p&&p.name,_=m&&m.name;v!==_&&((0,_util.info)("The FontDescriptor's FontName is \""+v+'" but should be the same as the Font\'s BaseFont "'+_+'"'),v&&_&&0===_.indexOf(v)&&(p=m))}if(p=p||m,!(0,_primitives.isName)(p))throw new _util.FormatError("invalid font name");var S,b=s.get("FontFile","FontFile2","FontFile3");if(b&&b.dict){var P=b.dict.get("Subtype");P&&(P=P.name);var O=b.dict.get("Length1"),A=b.dict.get("Length2"),x=b.dict.get("Length3")}if(t={type:o,name:p.name,subtype:P,file:b,length1:O,length2:A,length3:x,loadedName:r.loadedName,composite:n,wideChars:n,fixedPitch:!1,fontMatrix:a.getArray("FontMatrix")||_util.FONT_IDENTITY_MATRIX,firstChar:f||0,lastChar:h||l,bbox:s.getArray("FontBBox"),ascent:s.get("Ascent"),descent:s.get("Descent"),xHeight:s.get("XHeight"),capHeight:s.get("CapHeight"),flags:s.get("Flags"),italicAngle:s.get("ItalicAngle"),isType3Font:!1},n){var y=r.get("Encoding");(0,_primitives.isName)(y)&&(t.cidEncoding=y.name),S=_cmap.CMapFactory.create({encoding:y,fetchBuiltInCMap:this.fetchBuiltInCMap,useCMap:null}).then((function(e){t.cMap=e,t.vertical=t.cMap.vertical}))}else S=Promise.resolve(void 0);return S.then((function(){return i.extractDataStructures(a,r,t)})).then((function(e){return i.extractWidths(a,s,e),"Type3"===o&&(e.isType3Font=!0),new _fonts.Font(p.name,b,e)}))}},i}(),TranslatedFont=function(){function e(e,t,i){this.loadedName=e,this.font=t,this.dict=i,this.type3Loaded=null,this.sent=!1}return e.prototype={send:function(e){if(!this.sent){var t=this.font.exportData();e.send("commonobj",[this.loadedName,"Font",t]),this.sent=!0}},loadType3Data:function(e,t,i,r){if(!this.font.isType3Font)throw new Error("Must be a Type3 font.");if(this.type3Loaded)return this.type3Loaded;var a=Object.create(e.options);a.ignoreErrors=!1;for(var n=e.clone(a),s=this.font,o=Promise.resolve(),l=this.dict.get("CharProcs"),c=this.dict.get("Resources")||t,u=l.getKeys(),d=Object.create(null),g=function(){var e=u[f];o=o.then((function(){var t=l.get(e),a=new _operator_list.OperatorList;return n.getOperatorList({stream:t,task:r,resources:c,operatorList:a}).then((function(){d[e]=a.getIR(),i.addDependencies(a.dependencies)})).catch((function(t){(0,_util.warn)('Type3 font resource "'+e+'" is not available.');var i=new _operator_list.OperatorList;d[e]=i.getIR()}))}))},f=0,h=u.length;f<h;++f)g();return this.type3Loaded=o.then((function(){s.charProcOperatorList=d})),this.type3Loaded}},e}(),StateManager=function(){function e(e){this.state=e,this.stateStack=[]}return e.prototype={save:function(){var e=this.state;this.stateStack.push(this.state),this.state=e.clone()},restore:function(){var e=this.stateStack.pop();e&&(this.state=e)},transform:function(e){this.state.ctm=_util.Util.transform(this.state.ctm,e)}},e}(),TextState=function(){function e(){this.ctm=new Float32Array(_util.IDENTITY_MATRIX),this.fontName=null,this.fontSize=0,this.font=null,this.fontMatrix=_util.FONT_IDENTITY_MATRIX,this.textMatrix=_util.IDENTITY_MATRIX.slice(),this.textLineMatrix=_util.IDENTITY_MATRIX.slice(),this.charSpacing=0,this.wordSpacing=0,this.leading=0,this.textHScale=1,this.textRise=0}return e.prototype={setTextMatrix:function(e,t,i,r,a,n){var s=this.textMatrix;s[0]=e,s[1]=t,s[2]=i,s[3]=r,s[4]=a,s[5]=n},setTextLineMatrix:function(e,t,i,r,a,n){var s=this.textLineMatrix;s[0]=e,s[1]=t,s[2]=i,s[3]=r,s[4]=a,s[5]=n},translateTextMatrix:function(e,t){var i=this.textMatrix;i[4]=i[0]*e+i[2]*t+i[4],i[5]=i[1]*e+i[3]*t+i[5]},translateTextLineMatrix:function(e,t){var i=this.textLineMatrix;i[4]=i[0]*e+i[2]*t+i[4],i[5]=i[1]*e+i[3]*t+i[5]},calcTextLineMatrixAdvance:function(e,t,i,r,a,n){var s=this.font;if(!s)return null;var o=this.textLineMatrix;if(e!==o[0]||t!==o[1]||i!==o[2]||r!==o[3])return null;var l=a-o[4],c=n-o[5];if(s.vertical&&0!==l||!s.vertical&&0!==c)return null;var u,d,g=e*r-t*i;return s.vertical?(u=-c*i/g,d=c*e/g):(u=l*r/g,d=-l*t/g),{width:u,height:d,value:s.vertical?d:u}},calcRenderMatrix:function(e){var t=[this.fontSize*this.textHScale,0,0,this.fontSize,0,this.textRise];return _util.Util.transform(e,_util.Util.transform(this.textMatrix,t))},carriageReturn:function(){this.translateTextLineMatrix(0,-this.leading),this.textMatrix=this.textLineMatrix.slice()},clone:function(){var e=Object.create(this);return e.textMatrix=this.textMatrix.slice(),e.textLineMatrix=this.textLineMatrix.slice(),e.fontMatrix=this.fontMatrix.slice(),e}},e}(),EvalState=function(){function e(){this.ctm=new Float32Array(_util.IDENTITY_MATRIX),this.font=null,this.textRenderingMode=_util.TextRenderingMode.FILL,this.fillColorSpace=_colorspace.ColorSpace.singletons.gray,this.strokeColorSpace=_colorspace.ColorSpace.singletons.gray}return e.prototype={clone:function(){return Object.create(this)}},e}(),EvaluatorPreprocessor=function(){var e=(0,_util.getLookupTableFactory)((function(e){e["w"]={id:_util.OPS.setLineWidth,numArgs:1,variableArgs:!1},e["J"]={id:_util.OPS.setLineCap,numArgs:1,variableArgs:!1},e["j"]={id:_util.OPS.setLineJoin,numArgs:1,variableArgs:!1},e["M"]={id:_util.OPS.setMiterLimit,numArgs:1,variableArgs:!1},e["d"]={id:_util.OPS.setDash,numArgs:2,variableArgs:!1},e["ri"]={id:_util.OPS.setRenderingIntent,numArgs:1,variableArgs:!1},e["i"]={id:_util.OPS.setFlatness,numArgs:1,variableArgs:!1},e["gs"]={id:_util.OPS.setGState,numArgs:1,variableArgs:!1},e["q"]={id:_util.OPS.save,numArgs:0,variableArgs:!1},e["Q"]={id:_util.OPS.restore,numArgs:0,variableArgs:!1},e["cm"]={id:_util.OPS.transform,numArgs:6,variableArgs:!1},e["m"]={id:_util.OPS.moveTo,numArgs:2,variableArgs:!1},e["l"]={id:_util.OPS.lineTo,numArgs:2,variableArgs:!1},e["c"]={id:_util.OPS.curveTo,numArgs:6,variableArgs:!1},e["v"]={id:_util.OPS.curveTo2,numArgs:4,variableArgs:!1},e["y"]={id:_util.OPS.curveTo3,numArgs:4,variableArgs:!1},e["h"]={id:_util.OPS.closePath,numArgs:0,variableArgs:!1},e["re"]={id:_util.OPS.rectangle,numArgs:4,variableArgs:!1},e["S"]={id:_util.OPS.stroke,numArgs:0,variableArgs:!1},e["s"]={id:_util.OPS.closeStroke,numArgs:0,variableArgs:!1},e["f"]={id:_util.OPS.fill,numArgs:0,variableArgs:!1},e["F"]={id:_util.OPS.fill,numArgs:0,variableArgs:!1},e["f*"]={id:_util.OPS.eoFill,numArgs:0,variableArgs:!1},e["B"]={id:_util.OPS.fillStroke,numArgs:0,variableArgs:!1},e["B*"]={id:_util.OPS.eoFillStroke,numArgs:0,variableArgs:!1},e["b"]={id:_util.OPS.closeFillStroke,numArgs:0,variableArgs:!1},e["b*"]={id:_util.OPS.closeEOFillStroke,numArgs:0,variableArgs:!1},e["n"]={id:_util.OPS.endPath,numArgs:0,variableArgs:!1},e["W"]={id:_util.OPS.clip,numArgs:0,variableArgs:!1},e["W*"]={id:_util.OPS.eoClip,numArgs:0,variableArgs:!1},e["BT"]={id:_util.OPS.beginText,numArgs:0,variableArgs:!1},e["ET"]={id:_util.OPS.endText,numArgs:0,variableArgs:!1},e["Tc"]={id:_util.OPS.setCharSpacing,numArgs:1,variableArgs:!1},e["Tw"]={id:_util.OPS.setWordSpacing,numArgs:1,variableArgs:!1},e["Tz"]={id:_util.OPS.setHScale,numArgs:1,variableArgs:!1},e["TL"]={id:_util.OPS.setLeading,numArgs:1,variableArgs:!1},e["Tf"]={id:_util.OPS.setFont,numArgs:2,variableArgs:!1},e["Tr"]={id:_util.OPS.setTextRenderingMode,numArgs:1,variableArgs:!1},e["Ts"]={id:_util.OPS.setTextRise,numArgs:1,variableArgs:!1},e["Td"]={id:_util.OPS.moveText,numArgs:2,variableArgs:!1},e["TD"]={id:_util.OPS.setLeadingMoveText,numArgs:2,variableArgs:!1},e["Tm"]={id:_util.OPS.setTextMatrix,numArgs:6,variableArgs:!1},e["T*"]={id:_util.OPS.nextLine,numArgs:0,variableArgs:!1},e["Tj"]={id:_util.OPS.showText,numArgs:1,variableArgs:!1},e["TJ"]={id:_util.OPS.showSpacedText,numArgs:1,variableArgs:!1},e["'"]={id:_util.OPS.nextLineShowText,numArgs:1,variableArgs:!1},e['"']={id:_util.OPS.nextLineSetSpacingShowText,numArgs:3,variableArgs:!1},e["d0"]={id:_util.OPS.setCharWidth,numArgs:2,variableArgs:!1},e["d1"]={id:_util.OPS.setCharWidthAndBounds,numArgs:6,variableArgs:!1},e["CS"]={id:_util.OPS.setStrokeColorSpace,numArgs:1,variableArgs:!1},e["cs"]={id:_util.OPS.setFillColorSpace,numArgs:1,variableArgs:!1},e["SC"]={id:_util.OPS.setStrokeColor,numArgs:4,variableArgs:!0},e["SCN"]={id:_util.OPS.setStrokeColorN,numArgs:33,variableArgs:!0},e["sc"]={id:_util.OPS.setFillColor,numArgs:4,variableArgs:!0},e["scn"]={id:_util.OPS.setFillColorN,numArgs:33,variableArgs:!0},e["G"]={id:_util.OPS.setStrokeGray,numArgs:1,variableArgs:!1},e["g"]={id:_util.OPS.setFillGray,numArgs:1,variableArgs:!1},e["RG"]={id:_util.OPS.setStrokeRGBColor,numArgs:3,variableArgs:!1},e["rg"]={id:_util.OPS.setFillRGBColor,numArgs:3,variableArgs:!1},e["K"]={id:_util.OPS.setStrokeCMYKColor,numArgs:4,variableArgs:!1},e["k"]={id:_util.OPS.setFillCMYKColor,numArgs:4,variableArgs:!1},e["sh"]={id:_util.OPS.shadingFill,numArgs:1,variableArgs:!1},e["BI"]={id:_util.OPS.beginInlineImage,numArgs:0,variableArgs:!1},e["ID"]={id:_util.OPS.beginImageData,numArgs:0,variableArgs:!1},e["EI"]={id:_util.OPS.endInlineImage,numArgs:1,variableArgs:!1},e["Do"]={id:_util.OPS.paintXObject,numArgs:1,variableArgs:!1},e["MP"]={id:_util.OPS.markPoint,numArgs:1,variableArgs:!1},e["DP"]={id:_util.OPS.markPointProps,numArgs:2,variableArgs:!1},e["BMC"]={id:_util.OPS.beginMarkedContent,numArgs:1,variableArgs:!1},e["BDC"]={id:_util.OPS.beginMarkedContentProps,numArgs:2,variableArgs:!1},e["EMC"]={id:_util.OPS.endMarkedContent,numArgs:0,variableArgs:!1},e["BX"]={id:_util.OPS.beginCompat,numArgs:0,variableArgs:!1},e["EX"]={id:_util.OPS.endCompat,numArgs:0,variableArgs:!1},e["BM"]=null,e["BD"]=null,e["true"]=null,e["fa"]=null,e["fal"]=null,e["fals"]=null,e["false"]=null,e["nu"]=null,e["nul"]=null,e["null"]=null})),t=20;function i(t,i,r){this.opMap=e(),this.parser=new _parser.Parser(new _parser.Lexer(t,this.opMap),!1,i),this.stateManager=r,this.nonProcessedArgs=[],this._numInvalidPathOPS=0}return i.prototype={get savedStatesDepth(){return this.stateManager.stateStack.length},read:function(e){var i=e.args;while(1){var r=this.parser.getObj();if((0,_primitives.isCmd)(r)){var a=r.cmd,n=this.opMap[a];if(!n){(0,_util.warn)('Unknown command "'+a+'".');continue}var s=n.id,o=n.numArgs,l=null!==i?i.length:0;if(n.variableArgs)l>o&&(0,_util.info)("Command "+a+": expected [0, "+o+"] args, but received "+l+" args.");else{if(l!==o){var c=this.nonProcessedArgs;while(l>o)c.push(i.shift()),l--;while(l<o&&0!==c.length)null===i&&(i=[]),i.unshift(c.pop()),l++}if(l<o){var u="command "+a+": expected "+o+" args, but received "+l+" args.";if(s>=_util.OPS.moveTo&&s<=_util.OPS.endPath&&++this._numInvalidPathOPS>t)throw new _util.FormatError("Invalid "+u);(0,_util.warn)("Skipping "+u),null!==i&&(i.length=0);continue}}return this.preprocessCommand(s,i),e.fn=s,e.args=i,!0}if((0,_primitives.isEOF)(r))return!1;if(null!==r&&(null===i&&(i=[]),i.push(r),i.length>33))throw new _util.FormatError("Too many arguments")}},preprocessCommand:function(e,t){switch(0|e){case _util.OPS.save:this.stateManager.save();break;case _util.OPS.restore:this.stateManager.restore();break;case _util.OPS.transform:this.stateManager.transform(t);break}}},i}();exports.PartialEvaluator=PartialEvaluator;