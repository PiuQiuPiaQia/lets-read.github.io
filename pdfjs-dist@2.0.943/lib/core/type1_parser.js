"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Type1Parser=void 0;var _util=require("../shared/util"),_encodings=require("./encodings"),_stream=require("./stream"),HINTING_ENABLED=!1,Type1CharString=function(){var e={hstem:[1],vstem:[3],vmoveto:[4],rlineto:[5],hlineto:[6],vlineto:[7],rrcurveto:[8],callsubr:[10],flex:[12,35],drop:[12,18],endchar:[14],rmoveto:[21],hmoveto:[22],vhcurveto:[30],hvcurveto:[31]};function t(){this.width=0,this.lsb=0,this.flexing=!1,this.output=[],this.stack=[]}return t.prototype={convert:function(t,a,r){for(var s,i,n,h=t.length,c=!1,o=0;o<h;o++){var u=t[o];if(u<32){switch(12===u&&(u=(u<<8)+t[++o]),u){case 1:if(!HINTING_ENABLED){this.stack=[];break}c=this.executeCommand(2,e.hstem);break;case 3:if(!HINTING_ENABLED){this.stack=[];break}c=this.executeCommand(2,e.vstem);break;case 4:if(this.flexing){if(this.stack.length<1){c=!0;break}var k=this.stack.pop();this.stack.push(0,k);break}c=this.executeCommand(1,e.vmoveto);break;case 5:c=this.executeCommand(2,e.rlineto);break;case 6:c=this.executeCommand(1,e.hlineto);break;case 7:c=this.executeCommand(1,e.vlineto);break;case 8:c=this.executeCommand(6,e.rrcurveto);break;case 9:this.stack=[];break;case 10:if(this.stack.length<1){c=!0;break}if(n=this.stack.pop(),!a[n]){c=!0;break}c=this.convert(a[n],a,r);break;case 11:return c;case 13:if(this.stack.length<2){c=!0;break}s=this.stack.pop(),i=this.stack.pop(),this.lsb=i,this.width=s,this.stack.push(s,i),c=this.executeCommand(2,e.hmoveto);break;case 14:this.output.push(e.endchar[0]);break;case 21:if(this.flexing)break;c=this.executeCommand(2,e.rmoveto);break;case 22:if(this.flexing){this.stack.push(0);break}c=this.executeCommand(1,e.hmoveto);break;case 30:c=this.executeCommand(4,e.vhcurveto);break;case 31:c=this.executeCommand(4,e.hvcurveto);break;case 3072:this.stack=[];break;case 3073:if(!HINTING_ENABLED){this.stack=[];break}c=this.executeCommand(2,e.vstem);break;case 3074:if(!HINTING_ENABLED){this.stack=[];break}c=this.executeCommand(2,e.hstem);break;case 3078:r?(this.seac=this.stack.splice(-4,4),c=this.executeCommand(0,e.endchar)):c=this.executeCommand(4,e.endchar);break;case 3079:if(this.stack.length<4){c=!0;break}this.stack.pop(),s=this.stack.pop();var l=this.stack.pop();i=this.stack.pop(),this.lsb=i,this.width=s,this.stack.push(s,i,l),c=this.executeCommand(3,e.rmoveto);break;case 3084:if(this.stack.length<2){c=!0;break}var p=this.stack.pop(),g=this.stack.pop();this.stack.push(g/p);break;case 3088:if(this.stack.length<2){c=!0;break}n=this.stack.pop();var d=this.stack.pop();if(0===n&&3===d){var m=this.stack.splice(this.stack.length-17,17);this.stack.push(m[2]+m[0],m[3]+m[1],m[4],m[5],m[6],m[7],m[8],m[9],m[10],m[11],m[12],m[13],m[14]),c=this.executeCommand(13,e.flex,!0),this.flexing=!1,this.stack.push(m[15],m[16])}else 1===n&&0===d&&(this.flexing=!0);break;case 3089:break;case 3105:this.stack=[];break;default:(0,_util.warn)('Unknown type 1 charstring command of "'+u+'"');break}if(c)break}else u<=246?u-=139:u=u<=250?256*(u-247)+t[++o]+108:u<=254?-256*(u-251)-t[++o]-108:(255&t[++o])<<24|(255&t[++o])<<16|(255&t[++o])<<8|(255&t[++o])<<0,this.stack.push(u)}return c},executeCommand:function(e,t,a){var r=this.stack.length;if(e>r)return!0;for(var s=r-e,i=s;i<r;i++){var n=this.stack[i];Number.isInteger(n)?this.output.push(28,n>>8&255,255&n):(n=65536*n|0,this.output.push(255,n>>24&255,n>>16&255,n>>8&255,255&n))}return this.output.push.apply(this.output,t),a?this.stack.splice(s,e):this.stack.length=0,!1}},t}(),Type1Parser=function(){var e=55665,t=4330;function a(e){return e>=48&&e<=57||e>=65&&e<=70||e>=97&&e<=102}function r(e,t,a){if(a>=e.length)return new Uint8Array(0);var r,s,i=0|t,n=52845,h=22719;for(r=0;r<a;r++)i=(e[r]+i)*n+h&65535;var c=e.length-a,o=new Uint8Array(c);for(r=a,s=0;s<c;r++,s++){var u=e[r];o[s]=u^i>>8,i=(u+i)*n+h&65535}return o}function s(e,t,r){var s,i,n=0|t,h=52845,c=22719,o=e.length,u=o>>>1,k=new Uint8Array(u);for(s=0,i=0;s<o;s++){var l=e[s];if(a(l)){var p;s++;while(s<o&&!a(p=e[s]))s++;if(s<o){var g=parseInt(String.fromCharCode(l,p),16);k[i++]=g^n>>8,n=(g+n)*h+c&65535}}}return Array.prototype.slice.call(k,r,i)}function i(e){return 47===e||91===e||93===e||123===e||125===e||40===e||41===e}function n(t,i,n){if(i){var h=t.getBytes(),c=!(a(h[0])&&a(h[1])&&a(h[2])&&a(h[3]));t=new _stream.Stream(c?r(h,e,4):s(h,e,4))}this.seacAnalysisEnabled=!!n,this.stream=t,this.nextChar()}return n.prototype={readNumberArray:function(){this.getToken();var e=[];while(1){var t=this.getToken();if(null===t||"]"===t||"}"===t)break;e.push(parseFloat(t||0))}return e},readNumber:function(){var e=this.getToken();return parseFloat(e||0)},readInt:function(){var e=this.getToken();return 0|parseInt(e||0,10)},readBoolean:function(){var e=this.getToken();return"true"===e?1:0},nextChar:function(){return this.currentChar=this.stream.getByte()},getToken:function(){var e=!1,t=this.currentChar;while(1){if(-1===t)return null;if(e)10!==t&&13!==t||(e=!1);else if(37===t)e=!0;else if(!(0,_util.isSpace)(t))break;t=this.nextChar()}if(i(t))return this.nextChar(),String.fromCharCode(t);var a="";do{a+=String.fromCharCode(t),t=this.nextChar()}while(t>=0&&!(0,_util.isSpace)(t)&&!i(t));return a},readCharStrings:function(e,a){return-1===a?e:r(e,t,a)},extractFontProgram:function(){var e=this.stream,t=[],a=[],r=Object.create(null);r["lenIV"]=4;var s,i,n,h,c,o={subrs:[],charstrings:[],properties:{privateData:r}};while(null!==(s=this.getToken()))if("/"===s)switch(s=this.getToken(),s){case"CharStrings":this.getToken(),this.getToken(),this.getToken(),this.getToken();while(1){if(s=this.getToken(),null===s||"end"===s)break;if("/"===s){var u=this.getToken();i=this.readInt(),this.getToken(),n=i>0?e.getBytes(i):new Uint8Array(0),h=o.properties.privateData["lenIV"],c=this.readCharStrings(n,h),this.nextChar(),s=this.getToken(),"noaccess"===s&&this.getToken(),a.push({glyph:u,encoded:c})}}break;case"Subrs":this.readInt(),this.getToken();while("dup"===this.getToken()){var k=this.readInt();i=this.readInt(),this.getToken(),n=i>0?e.getBytes(i):new Uint8Array(0),h=o.properties.privateData["lenIV"],c=this.readCharStrings(n,h),this.nextChar(),s=this.getToken(),"noaccess"===s&&this.getToken(),t[k]=c}break;case"BlueValues":case"OtherBlues":case"FamilyBlues":case"FamilyOtherBlues":var l=this.readNumberArray();l.length>0&&l.length%2===0&&HINTING_ENABLED&&(o.properties.privateData[s]=l);break;case"StemSnapH":case"StemSnapV":o.properties.privateData[s]=this.readNumberArray();break;case"StdHW":case"StdVW":o.properties.privateData[s]=this.readNumberArray()[0];break;case"BlueShift":case"lenIV":case"BlueFuzz":case"BlueScale":case"LanguageGroup":case"ExpansionFactor":o.properties.privateData[s]=this.readNumber();break;case"ForceBold":o.properties.privateData[s]=this.readBoolean();break}for(var p=0;p<a.length;p++){u=a[p].glyph,c=a[p].encoded;var g=new Type1CharString,d=g.convert(c,t,this.seacAnalysisEnabled),m=g.output;d&&(m=[14]),o.charstrings.push({glyphName:u,charstring:m,width:g.width,lsb:g.lsb,seac:g.seac})}return o},extractFontHeader:function(e){var t;while(null!==(t=this.getToken()))if("/"===t)switch(t=this.getToken(),t){case"FontMatrix":var a=this.readNumberArray();e.fontMatrix=a;break;case"Encoding":var r,s=this.getToken();if(/^\d+$/.test(s)){r=[];var i=0|parseInt(s,10);this.getToken();for(var n=0;n<i;n++){t=this.getToken();while("dup"!==t&&"def"!==t)if(t=this.getToken(),null===t)return;if("def"===t)break;var h=this.readInt();this.getToken();var c=this.getToken();r[h]=c,this.getToken()}}else r=(0,_encodings.getEncoding)(s);e.builtInEncoding=r;break;case"FontBBox":var o=this.readNumberArray();e.ascent=Math.max(o[3],o[1]),e.descent=Math.min(o[1],o[3]),e.ascentScaled=!0;break}}},n}();exports.Type1Parser=Type1Parser;