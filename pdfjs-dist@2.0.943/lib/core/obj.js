"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.FileSpec=exports.XRef=exports.ObjectLoader=exports.Catalog=void 0;var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_slicedToArray=function(){function e(e,t){var i=[],r=!0,n=!1,s=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done);r=!0)if(i.push(a.value),t&&i.length===t)break}catch(u){n=!0,s=u}finally{try{!r&&o["return"]&&o["return"]()}finally{if(n)throw s}}return i}return function(t,i){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_typeof="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"===typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),_util=require("../shared/util"),_primitives=require("./primitives"),_parser=require("./parser"),_chunked_stream=require("./chunked_stream"),_crypto=require("./crypto"),_colorspace=require("./colorspace");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==typeof t&&"function"!==typeof t?e:t}function _inherits(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise((function(e,i){function r(n,s){try{var a=t[n](s),o=a.value}catch(u){return void i(u)}if(!a.done)return Promise.resolve(o).then((function(e){r("next",e)}),(function(e){r("throw",e)}));e(o)}return r("next")}))}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function fetchDestination(e){return(0,_primitives.isDict)(e)?e.get("D"):e}var Catalog=function(){function e(t,i){if(_classCallCheck(this,e),this.pdfManager=t,this.xref=i,this.catDict=i.getCatalogObj(),!(0,_primitives.isDict)(this.catDict))throw new _util.FormatError("Catalog object is not a dictionary.");this.fontCache=new _primitives.RefSetCache,this.builtInCMapCache=new Map,this.pageKidsCountCache=new _primitives.RefSetCache}return _createClass(e,[{key:"_readDocumentOutline",value:function(){var t=this.catDict.get("Outlines");if(!(0,_primitives.isDict)(t))return null;if(t=t.getRaw("First"),!(0,_primitives.isRef)(t))return null;var i={items:[]},r=[{obj:t,parent:i}],n=new _primitives.RefSet;n.put(t);var s=this.xref,a=new Uint8ClampedArray(3);while(r.length>0){var o=r.shift(),u=s.fetchIfRef(o.obj);if(null!==u){if(!u.has("Title"))throw new _util.FormatError("Invalid outline item encountered.");var f={url:null,dest:null};e.parseDestDictionary({destDict:u,resultObj:f,docBaseUrl:this.pdfManager.docBaseUrl});var c=u.get("Title"),l=u.get("F")||0,h=u.getArray("C"),p=a;!Array.isArray(h)||3!==h.length||0===h[0]&&0===h[1]&&0===h[2]||(p=_colorspace.ColorSpace.singletons.rgb.getRgb(h,0));var m={dest:f.dest,url:f.url,unsafeUrl:f.unsafeUrl,newWindow:f.newWindow,title:(0,_util.stringToPDFString)(c),color:p,count:u.get("Count"),bold:!!(2&l),italic:!!(1&l),items:[]};o.parent.items.push(m),t=u.getRaw("First"),(0,_primitives.isRef)(t)&&!n.has(t)&&(r.push({obj:t,parent:m}),n.put(t)),t=u.getRaw("Next"),(0,_primitives.isRef)(t)&&!n.has(t)&&(r.push({obj:t,parent:o.parent}),n.put(t))}}return i.items.length>0?i.items:null}},{key:"_readPermissions",value:function(){var e=this.xref.trailer.get("Encrypt");if(!(0,_primitives.isDict)(e))return null;var t=e.get("P");if(!(0,_util.isNum)(t))return null;t+=Math.pow(2,32);var i=[];for(var r in _util.PermissionFlag){var n=_util.PermissionFlag[r];t&n&&i.push(n)}return i}},{key:"getDestination",value:function(e){var t=this._readDests();return t instanceof NameTree||t instanceof _primitives.Dict?fetchDestination(t.get(e)||null):null}},{key:"_readDests",value:function(){var e=this.catDict.get("Names");return e&&e.has("Dests")?new NameTree(e.getRaw("Dests"),this.xref):this.catDict.has("Dests")?this.catDict.get("Dests"):void 0}},{key:"_readPageLabels",value:function(){var e=this.catDict.getRaw("PageLabels");if(!e)return null;for(var t=new Array(this.numPages),i=null,r="",n=new NumberTree(e,this.xref),s=n.getAll(),a="",o=1,u=0,f=this.numPages;u<f;u++){if(u in s){var c=s[u];if(!(0,_primitives.isDict)(c))throw new _util.FormatError("PageLabel is not a dictionary.");if(c.has("Type")&&!(0,_primitives.isName)(c.get("Type"),"PageLabel"))throw new _util.FormatError("Invalid type in PageLabel dictionary.");if(c.has("S")){var l=c.get("S");if(!(0,_primitives.isName)(l))throw new _util.FormatError("Invalid style in PageLabel dictionary.");i=l.name}else i=null;if(c.has("P")){var h=c.get("P");if(!(0,_util.isString)(h))throw new _util.FormatError("Invalid prefix in PageLabel dictionary.");r=(0,_util.stringToPDFString)(h)}else r="";if(c.has("St")){var p=c.get("St");if(!(Number.isInteger(p)&&p>=1))throw new _util.FormatError("Invalid start in PageLabel dictionary.");o=p}else o=1}switch(i){case"D":a=o;break;case"R":case"r":a=(0,_util.toRomanNumerals)(o,"r"===i);break;case"A":case"a":for(var m=26,g=65,v=97,d="a"===i?v:g,_=o-1,b=String.fromCharCode(d+_%m),y=[],w=0,D=_/m|0;w<=D;w++)y.push(b);a=y.join("");break;default:if(i)throw new _util.FormatError('Invalid style "'+i+'" in PageLabel dictionary.');a=""}t[u]=r+a,o++}return t}},{key:"cleanup",value:function(){var e=this;this.pageKidsCountCache.clear();var t=[];return this.fontCache.forEach((function(e){t.push(e)})),Promise.all(t).then((function(t){for(var i=0,r=t.length;i<r;i++){var n=t[i].dict;delete n.translated}e.fontCache.clear(),e.builtInCMapCache.clear()}))}},{key:"getPageDict",value:function(e){var t=(0,_util.createPromiseCapability)(),i=[this.catDict.getRaw("Pages")],r=this.xref,n=this.pageKidsCountCache,s=void 0,a=0;function o(){var u=function(){var u=i.pop();if((0,_primitives.isRef)(u))return s=n.get(u),s>0&&a+s<e?(a+=s,"continue"):(r.fetchAsync(u).then((function(r){(0,_primitives.isDict)(r,"Page")||(0,_primitives.isDict)(r)&&!r.has("Kids")?e===a?(u&&!n.has(u)&&n.put(u,1),t.resolve([r,u])):(a++,o()):(i.push(r),o())}),t.reject),{v:void 0});if(!(0,_primitives.isDict)(u))return t.reject(new _util.FormatError("Page dictionary kid reference points to wrong type of object.")),{v:void 0};if(s=u.get("Count"),Number.isInteger(s)&&s>=0){var f=u.objId;if(f&&!n.has(f)&&n.put(f,s),a+s<=e)return a+=s,"continue"}var c=u.get("Kids");if(!Array.isArray(c))return(0,_primitives.isName)(u.get("Type"),"Page")||!u.has("Type")&&u.has("Contents")?a===e?(t.resolve([u,null]),{v:void 0}):(a++,"continue"):(t.reject(new _util.FormatError("Page dictionary kids object is not an array.")),{v:void 0});for(var l=c.length-1;l>=0;l--)i.push(c[l])};while(i.length){var f=u();switch(f){case"continue":continue;default:if("object"===("undefined"===typeof f?"undefined":_typeof(f)))return f.v}}t.reject(new Error("Page index "+e+" not found."))}return o(),t.promise}},{key:"getPageIndex",value:function(e){var t=this.xref;function i(i){var r=0,n=void 0;return t.fetchAsync(i).then((function(t){if((0,_primitives.isRefsEqual)(i,e)&&!(0,_primitives.isDict)(t,"Page")&&(!(0,_primitives.isDict)(t)||t.has("Type")||!t.has("Contents")))throw new _util.FormatError("The reference does not point to a /Page dictionary.");if(!t)return null;if(!(0,_primitives.isDict)(t))throw new _util.FormatError("Node must be a dictionary.");return n=t.getRaw("Parent"),t.getAsync("Parent")})).then((function(e){if(!e)return null;if(!(0,_primitives.isDict)(e))throw new _util.FormatError("Parent must be a dictionary.");return e.getAsync("Kids")})).then((function(e){if(!e)return null;for(var s=[],a=!1,o=0,u=e.length;o<u;o++){var f=e[o];if(!(0,_primitives.isRef)(f))throw new _util.FormatError("Kid must be a reference.");if((0,_primitives.isRefsEqual)(f,i)){a=!0;break}s.push(t.fetchAsync(f).then((function(e){if(!(0,_primitives.isDict)(e))throw new _util.FormatError("Kid node must be a dictionary.");e.has("Count")?r+=e.get("Count"):r++})))}if(!a)throw new _util.FormatError("Kid reference not found in parent's kids.");return Promise.all(s).then((function(){return[r,n]}))}))}var r=0;function n(e){return i(e).then((function(e){if(!e)return r;var t=_slicedToArray(e,2),i=t[0],s=t[1];return r+=i,n(s)}))}return n(e)}},{key:"metadata",get:function(){var e=this.catDict.getRaw("Metadata");if(!(0,_primitives.isRef)(e))return(0,_util.shadow)(this,"metadata",null);var t=!(this.xref.encrypt&&this.xref.encrypt.encryptMetadata),i=this.xref.fetch(e,t),r=void 0;if(i&&(0,_primitives.isDict)(i.dict)){var n=i.dict.get("Type"),s=i.dict.get("Subtype");if((0,_primitives.isName)(n,"Metadata")&&(0,_primitives.isName)(s,"XML"))try{r=(0,_util.stringToUTF8String)((0,_util.bytesToString)(i.getBytes()))}catch(a){if(a instanceof _util.MissingDataException)throw a;(0,_util.info)("Skipping invalid metadata.")}}return(0,_util.shadow)(this,"metadata",r)}},{key:"toplevelPagesDict",get:function(){var e=this.catDict.get("Pages");if(!(0,_primitives.isDict)(e))throw new _util.FormatError("Invalid top-level pages dictionary.");return(0,_util.shadow)(this,"toplevelPagesDict",e)}},{key:"documentOutline",get:function(){var e=null;try{e=this._readDocumentOutline()}catch(t){if(t instanceof _util.MissingDataException)throw t;(0,_util.warn)("Unable to read document outline.")}return(0,_util.shadow)(this,"documentOutline",e)}},{key:"permissions",get:function(){var e=null;try{e=this._readPermissions()}catch(t){if(t instanceof _util.MissingDataException)throw t;(0,_util.warn)("Unable to read permissions.")}return(0,_util.shadow)(this,"permissions",e)}},{key:"numPages",get:function(){var e=this.toplevelPagesDict.get("Count");if(!Number.isInteger(e))throw new _util.FormatError("Page count in top-level pages dictionary is not an integer.");return(0,_util.shadow)(this,"numPages",e)}},{key:"destinations",get:function(){var e=this._readDests(),t=Object.create(null);if(e instanceof NameTree){var i=e.getAll();for(var r in i)t[r]=fetchDestination(i[r])}else e instanceof _primitives.Dict&&e.forEach((function(e,i){i&&(t[e]=fetchDestination(i))}));return(0,_util.shadow)(this,"destinations",t)}},{key:"pageLabels",get:function(){var e=null;try{e=this._readPageLabels()}catch(t){if(t instanceof _util.MissingDataException)throw t;(0,_util.warn)("Unable to read page labels.")}return(0,_util.shadow)(this,"pageLabels",e)}},{key:"pageMode",get:function(){var e=this.catDict.get("PageMode"),t="UseNone";if((0,_primitives.isName)(e))switch(e.name){case"UseNone":case"UseOutlines":case"UseThumbs":case"FullScreen":case"UseOC":case"UseAttachments":t=e.name}return(0,_util.shadow)(this,"pageMode",t)}},{key:"attachments",get:function(){var e=this.catDict.get("Names"),t=null;if(e&&e.has("EmbeddedFiles")){var i=new NameTree(e.getRaw("EmbeddedFiles"),this.xref),r=i.getAll();for(var n in r){var s=new FileSpec(r[n],this.xref);t||(t=Object.create(null)),t[(0,_util.stringToPDFString)(n)]=s.serializable}}return(0,_util.shadow)(this,"attachments",t)}},{key:"javaScript",get:function(){var e=this.catDict.get("Names"),t=null;function i(e){var i=e.get("S");if((0,_primitives.isName)(i,"JavaScript")){var r=e.get("JS");if((0,_primitives.isStream)(r))r=(0,_util.bytesToString)(r.getBytes());else if(!(0,_util.isString)(r))return;t||(t=[]),t.push((0,_util.stringToPDFString)(r))}}if(e&&e.has("JavaScript")){var r=new NameTree(e.getRaw("JavaScript"),this.xref),n=r.getAll();for(var s in n){var a=n[s];(0,_primitives.isDict)(a)&&i(a)}}var o=this.catDict.get("OpenAction");if((0,_primitives.isDict)(o,"Action")){var u=o.get("S");if((0,_primitives.isName)(u,"Named")){var f=o.get("N");(0,_primitives.isName)(f,"Print")&&(t||(t=[]),t.push("print({});"))}else i(o)}return(0,_util.shadow)(this,"javaScript",t)}}],[{key:"parseDestDictionary",value:function(e){function t(e){return 0===e.indexOf("www.")?"http://"+e:e}function i(e){try{return(0,_util.stringToUTF8String)(e)}catch(t){return e}}var r=e.destDict;if((0,_primitives.isDict)(r)){var n=e.resultObj;if("object"===("undefined"===typeof n?"undefined":_typeof(n))){var s=e.docBaseUrl||null,a=r.get("A"),o=void 0,u=void 0;if(!(0,_primitives.isDict)(a)&&r.has("Dest")&&(a=r.get("Dest")),(0,_primitives.isDict)(a)){var f=a.get("S");if(!(0,_primitives.isName)(f))return void(0,_util.warn)("parseDestDictionary: Invalid type in Action dictionary.");var c=f.name;switch(c){case"URI":o=a.get("URI"),(0,_primitives.isName)(o)?o="/"+o.name:(0,_util.isString)(o)&&(o=t(o));break;case"GoTo":u=a.get("D");break;case"Launch":case"GoToR":var l=a.get("F");(0,_primitives.isDict)(l)?o=l.get("F")||null:(0,_util.isString)(l)&&(o=l);var h=a.get("D");if(h&&((0,_primitives.isName)(h)&&(h=h.name),(0,_util.isString)(o))){var p=o.split("#")[0];(0,_util.isString)(h)?o=p+"#"+h:Array.isArray(h)&&(o=p+"#"+JSON.stringify(h))}var m=a.get("NewWindow");(0,_util.isBool)(m)&&(n.newWindow=m);break;case"Named":var g=a.get("N");(0,_primitives.isName)(g)&&(n.action=g.name);break;case"JavaScript":var v=a.get("JS"),d=void 0;if((0,_primitives.isStream)(v)?d=(0,_util.bytesToString)(v.getBytes()):(0,_util.isString)(v)&&(d=v),d){var _=["app.launchURL","window.open"],b=new RegExp("^\\s*("+_.join("|").split(".").join("\\.")+")\\((?:'|\")([^'\"]*)(?:'|\")(?:,\\s*(\\w+)\\)|\\))","i"),y=b.exec((0,_util.stringToPDFString)(d));if(y&&y[2]){o=y[2],"true"===y[3]&&"app.launchURL"===y[1]&&(n.newWindow=!0);break}}default:(0,_util.warn)('parseDestDictionary: unsupported action type "'+c+'".');break}}else r.has("Dest")&&(u=r.get("Dest"));if((0,_util.isString)(o)){o=i(o);var w=(0,_util.createValidAbsoluteUrl)(o,s);w&&(n.url=w.href),n.unsafeUrl=o}u&&((0,_primitives.isName)(u)&&(u=u.name),((0,_util.isString)(u)||Array.isArray(u))&&(n.dest=u))}else(0,_util.warn)("parseDestDictionary: `resultObj` must be an object.")}else(0,_util.warn)("parseDestDictionary: `destDict` must be a dictionary.")}}]),e}(),XRef=function(){function e(e,t){this.stream=e,this.pdfManager=t,this.entries=[],this.xrefstms=Object.create(null),this.cache=[],this.stats={streamTypes:[],fontTypes:[]}}return e.prototype={setStartXRef:function(e){this.startXRefQueue=[e]},parse:function(e){var t;e?((0,_util.warn)("Indexing all PDF objects"),t=this.indexObjects()):t=this.readXRef(),t.assignXref(this),this.trailer=t;var i=void 0;try{i=t.get("Encrypt")}catch(a){if(a instanceof _util.MissingDataException)throw a;(0,_util.warn)('XRef.parse - Invalid "Encrypt" reference: "'+a+'".')}if((0,_primitives.isDict)(i)){var r=t.get("ID"),n=r&&r.length?r[0]:"";i.suppressEncryption=!0,this.encrypt=new _crypto.CipherTransformFactory(i,n,this.pdfManager.password)}var s=void 0;try{s=t.get("Root")}catch(a){if(a instanceof _util.MissingDataException)throw a;(0,_util.warn)('XRef.parse - Invalid "Root" reference: "'+a+'".')}if(!(0,_primitives.isDict)(s)||!s.has("Pages")){if(!e)throw new _util.XRefParseException;throw new _util.FormatError("Invalid root reference")}this.root=s},processXRefTable:function(e){"tableState"in this||(this.tableState={entryNum:0,streamPos:e.lexer.stream.pos,parserBuf1:e.buf1,parserBuf2:e.buf2});var t=this.readXRefTable(e);if(!(0,_primitives.isCmd)(t,"trailer"))throw new _util.FormatError("Invalid XRef table: could not find trailer dictionary");var i=e.getObj();if(!(0,_primitives.isDict)(i)&&i.dict&&(i=i.dict),!(0,_primitives.isDict)(i))throw new _util.FormatError("Invalid XRef table: could not parse trailer dictionary");return delete this.tableState,i},readXRefTable:function(e){var t,i=e.lexer.stream,r=this.tableState;i.pos=r.streamPos,e.buf1=r.parserBuf1,e.buf2=r.parserBuf2;while(1){if(!("firstEntryNum"in r)||!("entryCount"in r)){if((0,_primitives.isCmd)(t=e.getObj(),"trailer"))break;r.firstEntryNum=t,r.entryCount=e.getObj()}var n=r.firstEntryNum,s=r.entryCount;if(!Number.isInteger(n)||!Number.isInteger(s))throw new _util.FormatError("Invalid XRef table: wrong types in subsection header");for(var a=r.entryNum;a<s;a++){r.streamPos=i.pos,r.entryNum=a,r.parserBuf1=e.buf1,r.parserBuf2=e.buf2;var o={};o.offset=e.getObj(),o.gen=e.getObj();var u=e.getObj();if((0,_primitives.isCmd)(u,"f")?o.free=!0:(0,_primitives.isCmd)(u,"n")&&(o.uncompressed=!0),!Number.isInteger(o.offset)||!Number.isInteger(o.gen)||!o.free&&!o.uncompressed)throw new _util.FormatError("Invalid entry in XRef subsection: "+n+", "+s);0===a&&o.free&&1===n&&(n=0),this.entries[a+n]||(this.entries[a+n]=o)}r.entryNum=0,r.streamPos=i.pos,r.parserBuf1=e.buf1,r.parserBuf2=e.buf2,delete r.firstEntryNum,delete r.entryCount}if(this.entries[0]&&!this.entries[0].free)throw new _util.FormatError("Invalid XRef table: unexpected first object");return t},processXRefStream:function(e){if(!("streamState"in this)){var t=e.dict,i=t.get("W"),r=t.get("Index");r||(r=[0,t.get("Size")]),this.streamState={entryRanges:r,byteWidths:i,entryNum:0,streamPos:e.pos}}return this.readXRefStream(e),delete this.streamState,e.dict},readXRefStream:function(e){var t,i,r=this.streamState;e.pos=r.streamPos;var n=r.byteWidths,s=n[0],a=n[1],o=n[2],u=r.entryRanges;while(u.length>0){var f=u[0],c=u[1];if(!Number.isInteger(f)||!Number.isInteger(c))throw new _util.FormatError("Invalid XRef range fields: "+f+", "+c);if(!Number.isInteger(s)||!Number.isInteger(a)||!Number.isInteger(o))throw new _util.FormatError("Invalid XRef entry fields length: "+f+", "+c);for(t=r.entryNum;t<c;++t){r.entryNum=t,r.streamPos=e.pos;var l=0,h=0,p=0;for(i=0;i<s;++i)l=l<<8|e.getByte();for(0===s&&(l=1),i=0;i<a;++i)h=h<<8|e.getByte();for(i=0;i<o;++i)p=p<<8|e.getByte();var m={};switch(m.offset=h,m.gen=p,l){case 0:m.free=!0;break;case 1:m.uncompressed=!0;break;case 2:break;default:throw new _util.FormatError("Invalid XRef entry type: "+l)}this.entries[f+t]||(this.entries[f+t]=m)}r.entryNum=0,r.streamPos=e.pos,u.splice(0,2)}},indexObjects:function(){var e=9,t=10,i=13,r=32,n=37,s=60;function a(e,r){var n="",a=e[r];while(a!==t&&a!==i&&a!==s){if(++r>=e.length)break;n+=String.fromCharCode(a),a=e[r]}return n}function o(e,t,i){var r=i.length,n=e.length,s=0;while(t<n){var a=0;while(a<r&&e[t+a]===i[a])++a;if(a>=r)break;t++,s++}return s}var u=/^(\d+)\s+(\d+)\s+obj\b/,f=/\bendobj[\b\s]$/,c=/\s+(\d+\s+\d+\s+obj[\b\s])$/,l=25,h=new Uint8Array([116,114,97,105,108,101,114]),p=new Uint8Array([115,116,97,114,116,120,114,101,102]),m=new Uint8Array([111,98,106]),g=new Uint8Array([47,88,82,101,102]);this.entries.length=0;var v=this.stream;v.pos=0;var d,_,b=v.getBytes(),y=v.start,w=b.length,D=[],R=[];while(y<w){var S=b[y];if(S!==e&&S!==t&&S!==i&&S!==r)if(S!==n){var j,x=a(b,y);if(0!==x.indexOf("xref")||4!==x.length&&!/\s/.test(x[4]))if(j=u.exec(x)){"undefined"===typeof this.entries[j[1]]&&(this.entries[j[1]]={offset:y-v.start,gen:0|j[2],uncompressed:!0});var N=void 0,P=y+x.length;while(P<b.length){var E=P+o(b,P,m)+4;N=E-y;var F=Math.max(E-l,P),C=(0,_util.bytesToString)(b.subarray(F,E));if(f.test(C))break;var I=c.exec(C);if(I&&I[1]){(0,_util.warn)('indexObjects: Found new "obj" inside of another "obj", caused by missing "endobj" -- trying to recover.'),N-=I[1].length;break}P=E}var O=b.subarray(y,y+N),k=o(O,0,g);k<N&&O[k+5]<64&&(R.push(y-v.start),this.xrefstms[y-v.start]=1),y+=N}else 0!==x.indexOf("trailer")||7!==x.length&&!/\s/.test(x[7])?y+=x.length+1:(D.push(y),y+=o(b,y,p));else y+=o(b,y,h),D.push(y),y+=o(b,y,p)}else do{if(++y,y>=w)break;S=b[y]}while(S!==t&&S!==i);else++y}for(d=0,_=R.length;d<_;++d)this.startXRefQueue.push(R[d]),this.readXRef(!0);var T=void 0;for(d=0,_=D.length;d<_;++d){v.pos=D[d];var A=new _parser.Parser(new _parser.Lexer(v),!0,this,!0),X=A.getObj();if((0,_primitives.isCmd)(X,"trailer")){var M=A.getObj();if((0,_primitives.isDict)(M)){var U=void 0;try{U=M.get("Root")}catch(L){if(L instanceof _util.MissingDataException)throw L;continue}if((0,_primitives.isDict)(U)&&U.has("Pages")){if(M.has("ID"))return M;T=M}}}}if(T)return T;throw new _util.InvalidPDFException("Invalid PDF structure")},readXRef:function(e){var t=this.stream,i=Object.create(null);try{while(this.startXRefQueue.length){var r=this.startXRefQueue[0];if(i[r])(0,_util.warn)("readXRef - skipping XRef table since it was already parsed."),this.startXRefQueue.shift();else{i[r]=!0,t.pos=r+t.start;var n,s=new _parser.Parser(new _parser.Lexer(t),!0,this),a=s.getObj();if((0,_primitives.isCmd)(a,"xref")){if(n=this.processXRefTable(s),this.topDict||(this.topDict=n),a=n.get("XRefStm"),Number.isInteger(a)){var o=a;o in this.xrefstms||(this.xrefstms[o]=1,this.startXRefQueue.push(o))}}else{if(!Number.isInteger(a))throw new _util.FormatError("Invalid XRef stream header");if(!Number.isInteger(s.getObj())||!(0,_primitives.isCmd)(s.getObj(),"obj")||!(0,_primitives.isStream)(a=s.getObj()))throw new _util.FormatError("Invalid XRef stream");if(n=this.processXRefStream(a),this.topDict||(this.topDict=n),!n)throw new _util.FormatError("Failed to read XRef stream")}a=n.get("Prev"),Number.isInteger(a)?this.startXRefQueue.push(a):(0,_primitives.isRef)(a)&&this.startXRefQueue.push(a.num),this.startXRefQueue.shift()}}return this.topDict}catch(u){if(u instanceof _util.MissingDataException)throw u;(0,_util.info)("(while reading XRef): "+u)}if(!e)throw new _util.XRefParseException},getEntry:function(e){var t=this.entries[e];return t&&!t.free&&t.offset?t:null},fetchIfRef:function(e,t){return(0,_primitives.isRef)(e)?this.fetch(e,t):e},fetch:function(e,t){if(!(0,_primitives.isRef)(e))throw new Error("ref object is not a reference");var i=e.num;if(i in this.cache){var r=this.cache[i];return r instanceof _primitives.Dict&&!r.objId&&(r.objId=e.toString()),r}var n=this.getEntry(i);return null===n?this.cache[i]=null:(n=n.uncompressed?this.fetchUncompressed(e,n,t):this.fetchCompressed(n,t),(0,_primitives.isDict)(n)?n.objId=e.toString():(0,_primitives.isStream)(n)&&(n.dict.objId=e.toString()),n)},fetchUncompressed:function(e,t,i){var r=e.gen,n=e.num;if(t.gen!==r)throw new _util.FormatError("inconsistent generation in XRef");var s=this.stream.makeSubStream(t.offset+this.stream.start),a=new _parser.Parser(new _parser.Lexer(s),!0,this),o=a.getObj(),u=a.getObj(),f=a.getObj();if(Number.isInteger(o)||(o=parseInt(o,10)),Number.isInteger(u)||(u=parseInt(u,10)),o!==n||u!==r||!(0,_primitives.isCmd)(f))throw new _util.FormatError("bad XRef entry");if("obj"!==f.cmd){if(0===f.cmd.indexOf("obj")&&(n=parseInt(f.cmd.substring(3),10),!Number.isNaN(n)))return n;throw new _util.FormatError("bad XRef entry")}return t=this.encrypt&&!i?a.getObj(this.encrypt.createCipherTransform(n,r)):a.getObj(),(0,_primitives.isStream)(t)||(this.cache[n]=t),t},fetchCompressed:function(e,t){var i=e.offset,r=this.fetch(new _primitives.Ref(i,0));if(!(0,_primitives.isStream)(r))throw new _util.FormatError("bad ObjStm stream");var n=r.dict.get("First"),s=r.dict.get("N");if(!Number.isInteger(n)||!Number.isInteger(s))throw new _util.FormatError("invalid first and n parameters for ObjStm stream");var a=new _parser.Parser(new _parser.Lexer(r),!1,this);a.allowStreams=!0;var o,u,f=[],c=[];for(o=0;o<s;++o){if(u=a.getObj(),!Number.isInteger(u))throw new _util.FormatError("invalid object number in the ObjStm stream: "+u);c.push(u);var l=a.getObj();if(!Number.isInteger(l))throw new _util.FormatError("invalid object offset in the ObjStm stream: "+l)}for(o=0;o<s;++o){f.push(a.getObj()),(0,_primitives.isCmd)(a.buf1,"endobj")&&a.shift(),u=c[o];var h=this.entries[u];h&&h.offset===i&&h.gen===o&&(this.cache[u]=f[o])}if(e=f[e.gen],void 0===e)throw new _util.FormatError("bad XRef entry for compressed object");return e},fetchIfRefAsync:function(){var e=_asyncToGenerator(_regenerator2.default.mark((function e(t,i){return _regenerator2.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if((0,_primitives.isRef)(t)){e.next=2;break}return e.abrupt("return",t);case 2:return e.abrupt("return",this.fetchAsync(t,i));case 3:case"end":return e.stop()}}),e,this)})));function t(t,i){return e.apply(this,arguments)}return t}(),fetchAsync:function(){var e=_asyncToGenerator(_regenerator2.default.mark((function e(t,i){return _regenerator2.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.abrupt("return",this.fetch(t,i));case 4:if(e.prev=4,e.t0=e["catch"](0),e.t0 instanceof _util.MissingDataException){e.next=8;break}throw e.t0;case 8:return e.next=10,this.pdfManager.requestRange(e.t0.begin,e.t0.end);case 10:return e.abrupt("return",this.fetchAsync(t,i));case 11:case"end":return e.stop()}}),e,this,[[0,4]])})));function t(t,i){return e.apply(this,arguments)}return t}(),getCatalogObj:function(){return this.root}},e}(),NameOrNumberTree=function(){function e(t,i,r){_classCallCheck(this,e),this.constructor===e&&(0,_util.unreachable)("Cannot initialize NameOrNumberTree."),this.root=t,this.xref=i,this._type=r}return _createClass(e,[{key:"getAll",value:function(){var e=Object.create(null);if(!this.root)return e;var t=this.xref,i=new _primitives.RefSet;i.put(this.root);var r=[this.root];while(r.length>0){var n=t.fetchIfRef(r.shift());if((0,_primitives.isDict)(n))if(n.has("Kids"))for(var s=n.get("Kids"),a=0,o=s.length;a<o;a++){var u=s[a];if(i.has(u))throw new _util.FormatError('Duplicate entry in "'+this._type+'" tree.');r.push(u),i.put(u)}else{var f=n.get(this._type);if(Array.isArray(f))for(var c=0,l=f.length;c<l;c+=2)e[t.fetchIfRef(f[c])]=t.fetchIfRef(f[c+1])}}return e}},{key:"get",value:function(e){if(!this.root)return null;var t=this.xref,i=t.fetchIfRef(this.root),r=0,n=10;while(i.has("Kids")){if(++r>n)return(0,_util.warn)('Search depth limit reached for "'+this._type+'" tree.'),null;var s=i.get("Kids");if(!Array.isArray(s))return null;var a=0,o=s.length-1;while(a<=o){var u=a+o>>1,f=t.fetchIfRef(s[u]),c=f.get("Limits");if(e<t.fetchIfRef(c[0]))o=u-1;else{if(!(e>t.fetchIfRef(c[1]))){i=t.fetchIfRef(s[u]);break}a=u+1}}if(a>o)return null}var l=i.get(this._type);if(Array.isArray(l)){var h=0,p=l.length-2;while(h<=p){var m=h+p&-2,g=t.fetchIfRef(l[m]);if(e<g)p=m-2;else{if(!(e>g))return t.fetchIfRef(l[m+1]);h=m+2}}}return null}}]),e}(),NameTree=function(e){function t(e,i){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,"Names"))}return _inherits(t,e),t}(NameOrNumberTree),NumberTree=function(e){function t(e,i){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,"Nums"))}return _inherits(t,e),t}(NameOrNumberTree),FileSpec=function(){function e(e,t){e&&(0,_primitives.isDict)(e)&&(this.xref=t,this.root=e,e.has("FS")&&(this.fs=e.get("FS")),this.description=e.has("Desc")?(0,_util.stringToPDFString)(e.get("Desc")):"",e.has("RF")&&(0,_util.warn)("Related file specifications are not supported"),this.contentAvailable=!0,e.has("EF")||(this.contentAvailable=!1,(0,_util.warn)("Non-embedded file specifications are not supported")))}function t(e){return e.has("UF")?e.get("UF"):e.has("F")?e.get("F"):e.has("Unix")?e.get("Unix"):e.has("Mac")?e.get("Mac"):e.has("DOS")?e.get("DOS"):null}return e.prototype={get filename(){if(!this._filename&&this.root){var e=t(this.root)||"unnamed";this._filename=(0,_util.stringToPDFString)(e).replace(/\\\\/g,"\\").replace(/\\\//g,"/").replace(/\\/g,"/")}return this._filename},get content(){if(!this.contentAvailable)return null;!this.contentRef&&this.root&&(this.contentRef=t(this.root.get("EF")));var e=null;if(this.contentRef){var i=this.xref,r=i.fetchIfRef(this.contentRef);r&&(0,_primitives.isStream)(r)?e=r.getBytes():(0,_util.warn)("Embedded file specification points to non-existing/invalid content")}else(0,_util.warn)("Embedded file specification does not have a content");return e},get serializable(){return{filename:this.filename,content:this.content}}},e}(),ObjectLoader=function(){function e(e){return(0,_primitives.isRef)(e)||(0,_primitives.isDict)(e)||Array.isArray(e)||(0,_primitives.isStream)(e)}function t(t,i){if((0,_primitives.isDict)(t)||(0,_primitives.isStream)(t))for(var r=(0,_primitives.isDict)(t)?t:t.dict,n=r.getKeys(),s=0,a=n.length;s<a;s++){var o=r.getRaw(n[s]);e(o)&&i.push(o)}else if(Array.isArray(t))for(var u=0,f=t.length;u<f;u++){var c=t[u];e(c)&&i.push(c)}}function i(e,t,i){this.dict=e,this.keys=t,this.xref=i,this.refSet=null,this.capability=null}return i.prototype={load:function(){if(this.capability=(0,_util.createPromiseCapability)(),!(this.xref.stream instanceof _chunked_stream.ChunkedStream)||0===this.xref.stream.getMissingChunks().length)return this.capability.resolve(),this.capability.promise;var e=this.keys,t=this.dict;this.refSet=new _primitives.RefSet;for(var i=[],r=0,n=e.length;r<n;r++){var s=t.getRaw(e[r]);void 0!==s&&i.push(s)}return this._walk(i),this.capability.promise},_walk:function(e){var i=this,r=[],n=[];while(e.length){var s=e.pop();if((0,_primitives.isRef)(s)){if(this.refSet.has(s))continue;try{this.refSet.put(s),s=this.xref.fetch(s)}catch(l){if(!(l instanceof _util.MissingDataException))throw l;r.push(s),n.push({begin:l.begin,end:l.end})}}if(s&&s.getBaseStreams){for(var a=s.getBaseStreams(),o=!1,u=0,f=a.length;u<f;u++){var c=a[u];c.getMissingChunks&&c.getMissingChunks().length&&(o=!0,n.push({begin:c.start,end:c.end}))}o&&r.push(s)}t(s,e)}n.length?this.xref.stream.manager.requestRanges(n).then((function(){for(var e=0,t=r.length;e<t;e++){var n=r[e];(0,_primitives.isRef)(n)&&i.refSet.remove(n)}i._walk(r)}),this.capability.reject):(this.refSet=null,this.capability.resolve())}},i}();exports.Catalog=Catalog,exports.ObjectLoader=ObjectLoader,exports.XRef=XRef,exports.FileSpec=FileSpec;