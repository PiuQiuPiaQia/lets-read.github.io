"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Parser=exports.Linearization=exports.Lexer=void 0;var _stream=require("./stream"),_util=require("../shared/util"),_primitives=require("./primitives"),_ccitt_stream=require("./ccitt_stream"),_jbig2_stream=require("./jbig2_stream"),_jpeg_stream=require("./jpeg_stream"),_jpx_stream=require("./jpx_stream"),MAX_LENGTH_TO_CACHE=1e3,MAX_ADLER32_LENGTH=5552;function computeAdler32(e){for(var t=e.length,i=1,r=0,a=0;a<t;++a)i+=255&e[a],r+=i;return r%65521<<16|i%65521}var Parser=function(){function e(e,t,i,r){this.lexer=e,this.allowStreams=t,this.xref=i,this.recoveryMode=r||!1,this.imageCache=Object.create(null),this.refill()}return e.prototype={refill:function(){this.buf1=this.lexer.getObj(),this.buf2=this.lexer.getObj()},shift:function(){(0,_primitives.isCmd)(this.buf2,"ID")?(this.buf1=this.buf2,this.buf2=null):(this.buf1=this.buf2,this.buf2=this.lexer.getObj())},tryShift:function(){try{return this.shift(),!0}catch(e){if(e instanceof _util.MissingDataException)throw e;return!1}},getObj:function(e){var t=this.buf1;if(this.shift(),t instanceof _primitives.Cmd)switch(t.cmd){case"BI":return this.makeInlineImage(e);case"[":var i=[];while(!(0,_primitives.isCmd)(this.buf1,"]")&&!(0,_primitives.isEOF)(this.buf1))i.push(this.getObj(e));if((0,_primitives.isEOF)(this.buf1)){if(!this.recoveryMode)throw new _util.FormatError("End of file inside array");return i}return this.shift(),i;case"<<":var r=new _primitives.Dict(this.xref);while(!(0,_primitives.isCmd)(this.buf1,">>")&&!(0,_primitives.isEOF)(this.buf1))if((0,_primitives.isName)(this.buf1)){var a=this.buf1.name;if(this.shift(),(0,_primitives.isEOF)(this.buf1))break;r.set(a,this.getObj(e))}else(0,_util.info)("Malformed dictionary: key must be a name object"),this.shift();if((0,_primitives.isEOF)(this.buf1)){if(!this.recoveryMode)throw new _util.FormatError("End of file inside dictionary");return r}return(0,_primitives.isCmd)(this.buf2,"stream")?this.allowStreams?this.makeStream(r,e):r:(this.shift(),r);default:return t}if(Number.isInteger(t)){var s=t;if(Number.isInteger(this.buf1)&&(0,_primitives.isCmd)(this.buf2,"R")){var n=new _primitives.Ref(s,this.buf1);return this.shift(),this.shift(),n}return s}if((0,_util.isString)(t)){var h=t;return e&&(h=e.decryptString(h)),h}return t},findDefaultInlineStreamEnd:function(e){var t=69,i=73,r=32,a=10,s=13,n=10,h=0,o=e.pos,m=0,u=void 0,f=void 0;while(-1!==(u=e.getByte()))if(0===m)m=u===t?1:0;else if(1===m)m=u===i?2:0;else if((0,_util.assert)(2===m),u===r||u===a||u===s){f=e.pos;for(var c=e.peekBytes(n),l=0,d=c.length;l<d;l++)if(u=c[l],(u!==h||c[l+1]===h)&&u!==a&&u!==s&&(u<r||u>127)){m=0;break}if(2===m)break}else m=0;return-1===u&&((0,_util.warn)("findDefaultInlineStreamEnd: Reached the end of the stream without finding a valid EI marker"),f&&((0,_util.warn)('... trying to recover by using the last "EI" occurrence.'),e.skip(-(e.pos-f)))),e.pos-4-o},findDCTDecodeInlineStreamEnd:function(e){var t,i,r,a=e.pos,s=!1;while(-1!==(t=e.getByte()))if(255===t){switch(e.getByte()){case 0:break;case 255:e.skip(-1);break;case 217:s=!0;break;case 192:case 193:case 194:case 195:case 197:case 198:case 199:case 201:case 202:case 203:case 205:case 206:case 207:case 196:case 204:case 218:case 219:case 220:case 221:case 222:case 223:case 224:case 225:case 226:case 227:case 228:case 229:case 230:case 231:case 232:case 233:case 234:case 235:case 236:case 237:case 238:case 239:case 254:i=e.getUint16(),i>2?e.skip(i-2):e.skip(-2);break}if(s)break}return r=e.pos-a,-1===t?((0,_util.warn)("Inline DCTDecode image stream: EOI marker not found, searching for /EI/ instead."),e.skip(-r),this.findDefaultInlineStreamEnd(e)):(this.inlineStreamSkipEI(e),r)},findASCII85DecodeInlineStreamEnd:function(e){var t,i,r=126,a=62,s=e.pos;while(-1!==(t=e.getByte()))if(t===r&&e.peekByte()===a){e.skip();break}return i=e.pos-s,-1===t?((0,_util.warn)("Inline ASCII85Decode image stream: EOD marker not found, searching for /EI/ instead."),e.skip(-i),this.findDefaultInlineStreamEnd(e)):(this.inlineStreamSkipEI(e),i)},findASCIIHexDecodeInlineStreamEnd:function(e){var t,i,r=62,a=e.pos;while(-1!==(t=e.getByte()))if(t===r)break;return i=e.pos-a,-1===t?((0,_util.warn)("Inline ASCIIHexDecode image stream: EOD marker not found, searching for /EI/ instead."),e.skip(-i),this.findDefaultInlineStreamEnd(e)):(this.inlineStreamSkipEI(e),i)},inlineStreamSkipEI:function(e){var t,i=69,r=73,a=0;while(-1!==(t=e.getByte()))if(0===a)a=t===i?1:0;else if(1===a)a=t===r?2:0;else if(2===a)break},makeInlineImage:function(e){var t=this.lexer,i=t.stream,r=new _primitives.Dict(this.xref),a=void 0;while(!(0,_primitives.isCmd)(this.buf1,"ID")&&!(0,_primitives.isEOF)(this.buf1)){if(!(0,_primitives.isName)(this.buf1))throw new _util.FormatError("Dictionary key must be a name object");var s=this.buf1.name;if(this.shift(),(0,_primitives.isEOF)(this.buf1))break;r.set(s,this.getObj(e))}-1!==t.beginInlineImagePos&&(a=i.pos-t.beginInlineImagePos);var n,h=r.get("Filter","F");if((0,_primitives.isName)(h))n=h.name;else if(Array.isArray(h)){var o=this.xref.fetchIfRef(h[0]);(0,_primitives.isName)(o)&&(n=o.name)}var m=i.pos,u=void 0;u="DCTDecode"===n||"DCT"===n?this.findDCTDecodeInlineStreamEnd(i):"ASCII85Decode"===n||"A85"===n?this.findASCII85DecodeInlineStreamEnd(i):"ASCIIHexDecode"===n||"AHx"===n?this.findASCIIHexDecodeInlineStreamEnd(i):this.findDefaultInlineStreamEnd(i);var f=i.makeSubStream(m,u,r),c=void 0;if(u<MAX_LENGTH_TO_CACHE&&a<MAX_ADLER32_LENGTH){var l=f.getBytes();f.reset();var d=i.pos;i.pos=t.beginInlineImagePos;var g=i.getBytes(a);i.pos=d,c=computeAdler32(l)+"_"+computeAdler32(g);var p=this.imageCache[c];if(void 0!==p)return this.buf2=_primitives.Cmd.get("EI"),this.shift(),p.reset(),p}return e&&(f=e.createStream(f,u)),f=this.filter(f,r,u),f.dict=r,void 0!==c&&(f.cacheKey="inline_"+u+"_"+c,this.imageCache[c]=f),this.buf2=_primitives.Cmd.get("EI"),this.shift(),f},_findStreamLength:function(e,t){var i=this.lexer.stream;i.pos=e;var r=2048,a=t.length;while(i.pos<i.end){var s=i.peekBytes(r),n=s.length-a;if(n<=0)break;var h=0;while(h<n){var o=0;while(o<a&&s[h+o]===t[o])o++;if(o>=a)return i.pos+=h,i.pos-e;h++}i.pos+=n}return-1},makeStream:function(e,t){var i=this.lexer,r=i.stream;i.skipToNextLine();var a=r.pos-1,s=e.get("Length");if(Number.isInteger(s)||((0,_util.info)("Bad "+s+" attribute in stream"),s=0),r.pos=a+s,i.nextChar(),this.tryShift()&&(0,_primitives.isCmd)(this.buf2,"endstream"))this.shift();else{var n=new Uint8Array([101,110,100,115,116,114,101,97,109]),h=this._findStreamLength(a,n);if(h<0){for(var o=1,m=1;m<=o;m++){var u=n.length-m,f=n.slice(0,u),c=this._findStreamLength(a,f);if(c>=0){var l=r.peekBytes(u+1)[u];if(!(0,_util.isSpace)(l))break;(0,_util.info)('Found "'+(0,_util.bytesToString)(f)+'" when searching for endstream command.'),h=c;break}}if(h<0)throw new _util.FormatError("Missing endstream command.")}s=h,i.nextChar(),this.shift(),this.shift()}return this.shift(),r=r.makeSubStream(a,s,e),t&&(r=t.createStream(r,s)),r=this.filter(r,e,s),r.dict=e,r},filter:function(e,t,i){var r=t.get("Filter","F"),a=t.get("DecodeParms","DP");if((0,_primitives.isName)(r))return Array.isArray(a)&&(0,_util.warn)("/DecodeParms should not contain an Array, when /Filter contains a Name."),this.makeFilter(e,r.name,i,a);var s=i;if(Array.isArray(r))for(var n=r,h=a,o=0,m=n.length;o<m;++o){if(r=this.xref.fetchIfRef(n[o]),!(0,_primitives.isName)(r))throw new _util.FormatError("Bad filter name: "+r);a=null,Array.isArray(h)&&o in h&&(a=this.xref.fetchIfRef(h[o])),e=this.makeFilter(e,r.name,s,a),s=null}return e},makeFilter:function(e,t,i,r){if(0===i)return(0,_util.warn)('Empty "'+t+'" stream.'),new _stream.NullStream;try{var a=this.xref.stats.streamTypes;if("FlateDecode"===t||"Fl"===t)return a[_util.StreamType.FLATE]=!0,r?new _stream.PredictorStream(new _stream.FlateStream(e,i),i,r):new _stream.FlateStream(e,i);if("LZWDecode"===t||"LZW"===t){a[_util.StreamType.LZW]=!0;var s=1;return r?(r.has("EarlyChange")&&(s=r.get("EarlyChange")),new _stream.PredictorStream(new _stream.LZWStream(e,i,s),i,r)):new _stream.LZWStream(e,i,s)}return"DCTDecode"===t||"DCT"===t?(a[_util.StreamType.DCT]=!0,new _jpeg_stream.JpegStream(e,i,e.dict,r)):"JPXDecode"===t||"JPX"===t?(a[_util.StreamType.JPX]=!0,new _jpx_stream.JpxStream(e,i,e.dict,r)):"ASCII85Decode"===t||"A85"===t?(a[_util.StreamType.A85]=!0,new _stream.Ascii85Stream(e,i)):"ASCIIHexDecode"===t||"AHx"===t?(a[_util.StreamType.AHX]=!0,new _stream.AsciiHexStream(e,i)):"CCITTFaxDecode"===t||"CCF"===t?(a[_util.StreamType.CCF]=!0,new _ccitt_stream.CCITTFaxStream(e,i,r)):"RunLengthDecode"===t||"RL"===t?(a[_util.StreamType.RL]=!0,new _stream.RunLengthStream(e,i)):"JBIG2Decode"===t?(a[_util.StreamType.JBIG]=!0,new _jbig2_stream.Jbig2Stream(e,i,e.dict,r)):((0,_util.warn)('filter "'+t+'" not supported yet'),e)}catch(n){if(n instanceof _util.MissingDataException)throw n;return(0,_util.warn)('Invalid stream: "'+n+'"'),new _stream.NullStream}}},e}(),Lexer=function(){function e(e,t){this.stream=e,this.nextChar(),this.strBuf=[],this.knownCommands=t,this.beginInlineImagePos=-1}var t=[1,0,0,0,0,0,0,0,0,1,1,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,2,0,0,2,2,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,2,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];function i(e){return e>=48&&e<=57?15&e:e>=65&&e<=70||e>=97&&e<=102?9+(15&e):-1}return e.prototype={nextChar:function(){return this.currentChar=this.stream.getByte()},peekChar:function(){return this.stream.peekByte()},getNumber:function(){var e=this.currentChar,t=!1,i=0,r=0;if(45===e?(r=-1,e=this.nextChar(),45===e&&(e=this.nextChar())):43===e&&(r=1,e=this.nextChar()),10===e||13===e)do{e=this.nextChar()}while(10===e||13===e);if(46===e&&(i=10,e=this.nextChar()),e<48||e>57){if(10===i&&0===r&&((0,_util.isSpace)(e)||-1===e))return(0,_util.warn)("Lexer.getNumber - treating a single decimal point as zero."),0;throw new _util.FormatError("Invalid number: "+String.fromCharCode(e)+" (charCode "+e+")")}r=r||1;var a=e-48,s=0,n=1;while((e=this.nextChar())>=0)if(48<=e&&e<=57){var h=e-48;t?s=10*s+h:(0!==i&&(i*=10),a=10*a+h)}else if(46===e){if(0!==i)break;i=1}else if(45===e)(0,_util.warn)("Badly formatted number");else{if(69!==e&&101!==e)break;if(e=this.peekChar(),43===e||45===e)n=45===e?-1:1,this.nextChar();else if(e<48||e>57)break;t=!0}return 0!==i&&(a/=i),t&&(a*=Math.pow(10,n*s)),r*a},getString:function(){var e=1,t=!1,i=this.strBuf;i.length=0;var r=this.nextChar();while(1){var a=!1;switch(0|r){case-1:(0,_util.warn)("Unterminated string"),t=!0;break;case 40:++e,i.push("(");break;case 41:0===--e?(this.nextChar(),t=!0):i.push(")");break;case 92:switch(r=this.nextChar(),r){case-1:(0,_util.warn)("Unterminated string"),t=!0;break;case 110:i.push("\n");break;case 114:i.push("\r");break;case 116:i.push("\t");break;case 98:i.push("\b");break;case 102:i.push("\f");break;case 92:case 40:case 41:i.push(String.fromCharCode(r));break;case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:var s=15&r;r=this.nextChar(),a=!0,r>=48&&r<=55&&(s=(s<<3)+(15&r),r=this.nextChar(),r>=48&&r<=55&&(a=!1,s=(s<<3)+(15&r))),i.push(String.fromCharCode(s));break;case 13:10===this.peekChar()&&this.nextChar();break;case 10:break;default:i.push(String.fromCharCode(r));break}break;default:i.push(String.fromCharCode(r));break}if(t)break;a||(r=this.nextChar())}return i.join("")},getName:function(){var e,r,a=this.strBuf;a.length=0;while((e=this.nextChar())>=0&&!t[e])if(35===e){if(e=this.nextChar(),t[e]){(0,_util.warn)("Lexer_getName: NUMBER SIGN (#) should be followed by a hexadecimal number."),a.push("#");break}var s=i(e);if(-1!==s){r=e,e=this.nextChar();var n=i(e);if(-1===n){if((0,_util.warn)("Lexer_getName: Illegal digit ("+String.fromCharCode(e)+") in hexadecimal number."),a.push("#",String.fromCharCode(r)),t[e])break;a.push(String.fromCharCode(e));continue}a.push(String.fromCharCode(s<<4|n))}else a.push("#",String.fromCharCode(e))}else a.push(String.fromCharCode(e));return a.length>127&&(0,_util.warn)("name token is longer than allowed by the spec: "+a.length),_primitives.Name.get(a.join(""))},getHexString:function(){var e=this.strBuf;e.length=0;var r,a,s=this.currentChar,n=!0;while(1){if(s<0){(0,_util.warn)("Unterminated hex string");break}if(62===s){this.nextChar();break}if(1!==t[s]){if(n){if(r=i(s),-1===r){(0,_util.warn)('Ignoring invalid character "'+s+'" in hex string'),s=this.nextChar();continue}}else{if(a=i(s),-1===a){(0,_util.warn)('Ignoring invalid character "'+s+'" in hex string'),s=this.nextChar();continue}e.push(String.fromCharCode(r<<4|a))}n=!n,s=this.nextChar()}else s=this.nextChar()}return e.join("")},getObj:function(){var e=!1,i=this.currentChar;while(1){if(i<0)return _primitives.EOF;if(e)10!==i&&13!==i||(e=!1);else if(37===i)e=!0;else if(1!==t[i])break;i=this.nextChar()}switch(0|i){case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:case 43:case 45:case 46:return this.getNumber();case 40:return this.getString();case 47:return this.getName();case 91:return this.nextChar(),_primitives.Cmd.get("[");case 93:return this.nextChar(),_primitives.Cmd.get("]");case 60:return i=this.nextChar(),60===i?(this.nextChar(),_primitives.Cmd.get("<<")):this.getHexString();case 62:return i=this.nextChar(),62===i?(this.nextChar(),_primitives.Cmd.get(">>")):_primitives.Cmd.get(">");case 123:return this.nextChar(),_primitives.Cmd.get("{");case 125:return this.nextChar(),_primitives.Cmd.get("}");case 41:throw this.nextChar(),new _util.FormatError("Illegal character: "+i)}var r=String.fromCharCode(i),a=this.knownCommands,s=a&&void 0!==a[r];while((i=this.nextChar())>=0&&!t[i]){var n=r+String.fromCharCode(i);if(s&&void 0===a[n])break;if(128===r.length)throw new _util.FormatError("Command token too long: "+r.length);r=n,s=a&&void 0!==a[r]}return"true"===r||"false"!==r&&("null"===r?null:("BI"===r&&(this.beginInlineImagePos=this.stream.pos),_primitives.Cmd.get(r)))},skipToNextLine:function(){var e=this.currentChar;while(e>=0){if(13===e){e=this.nextChar(),10===e&&this.nextChar();break}if(10===e){this.nextChar();break}e=this.nextChar()}}},e}(),Linearization={create:function(e){function t(e,t){var i=m.get(e);if(Number.isInteger(i)&&(t?i>=0:i>0))return i;throw new Error('The "'+e+'" parameter in the linearization dictionary is invalid.')}function i(){var e,t,i=m.get("H");if(Array.isArray(i)&&(2===(e=i.length)||4===e)){for(var r=0;r<e;r++)if(!(Number.isInteger(t=i[r])&&t>0))throw new Error("Hint ("+r+") in the linearization dictionary is invalid.");return i}throw new Error("Hint array in the linearization dictionary is invalid.")}var r,a,s=new Parser(new Lexer(e),!1,null),n=s.getObj(),h=s.getObj(),o=s.getObj(),m=s.getObj();if(!(Number.isInteger(n)&&Number.isInteger(h)&&(0,_primitives.isCmd)(o,"obj")&&(0,_primitives.isDict)(m)&&(0,_util.isNum)(r=m.get("Linearized"))&&r>0))return null;if((a=t("L"))!==e.length)throw new Error('The "L" parameter in the linearization dictionary does not equal the stream length.');return{length:a,hints:i(),objectNumberFirst:t("O"),endFirst:t("E"),numPages:t("N"),mainXRefEntriesOffset:t("T"),pageFirst:m.has("P")?t("P",!0):0}}};exports.Lexer=Lexer,exports.Linearization=Linearization,exports.Parser=Parser;