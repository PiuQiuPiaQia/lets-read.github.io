"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PDFDocument=exports.Page=void 0;var _slicedToArray=function(){function t(t,e){var r=[],i=!0,a=!1,n=void 0;try{for(var o,s=t[Symbol.iterator]();!(i=(o=s.next()).done);i=!0)if(r.push(o.value),e&&r.length===e)break}catch(u){a=!0,n=u}finally{try{!i&&s["return"]&&s["return"]()}finally{if(a)throw n}}return r}return function(e,r){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_util=require("../shared/util"),_obj=require("./obj"),_primitives=require("./primitives"),_stream=require("./stream"),_annotation=require("./annotation"),_crypto=require("./crypto"),_parser=require("./parser"),_operator_list=require("./operator_list"),_evaluator=require("./evaluator"),_function=require("./function"),Page=function(){var t=1,e=[0,0,612,792];function r(t,e){return"display"===e&&t.viewable||"print"===e&&t.printable}function i(t){var e=t.pdfManager,r=t.xref,i=t.pageIndex,a=t.pageDict,n=t.ref,o=t.fontCache,s=t.builtInCMapCache,u=t.pdfFunctionFactory;this.pdfManager=e,this.pageIndex=i,this.pageDict=a,this.xref=r,this.ref=n,this.fontCache=o,this.builtInCMapCache=s,this.pdfFunctionFactory=u,this.evaluatorOptions=e.evaluatorOptions,this.resourcesPromise=null;var h="p"+this.pageIndex+"_",c={obj:0};this.idFactory={createObjId:function(){return h+ ++c.obj}}}return i.prototype={_getInheritableProperty:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=(0,_util.getInheritableProperty)({dict:this.pageDict,key:t,getArray:e,stopWhenFound:!1});return Array.isArray(r)?1!==r.length&&(0,_primitives.isDict)(r[0])?_primitives.Dict.merge(this.xref,r):r[0]:r},get content(){return this.pageDict.get("Contents")},get resources(){return(0,_util.shadow)(this,"resources",this._getInheritableProperty("Resources")||_primitives.Dict.empty)},get mediaBox(){var t=this._getInheritableProperty("MediaBox",!0);return Array.isArray(t)&&4===t.length?(0,_util.shadow)(this,"mediaBox",t):(0,_util.shadow)(this,"mediaBox",e)},get cropBox(){var t=this._getInheritableProperty("CropBox",!0);return Array.isArray(t)&&4===t.length?(0,_util.shadow)(this,"cropBox",t):(0,_util.shadow)(this,"cropBox",this.mediaBox)},get userUnit(){var e=this.pageDict.get("UserUnit");return(!(0,_util.isNum)(e)||e<=0)&&(e=t),(0,_util.shadow)(this,"userUnit",e)},get view(){var t=this.mediaBox,e=this.cropBox;if(t===e)return(0,_util.shadow)(this,"view",t);var r=_util.Util.intersect(e,t);return(0,_util.shadow)(this,"view",r||t)},get rotate(){var t=this._getInheritableProperty("Rotate")||0;return t%90!==0?t=0:t>=360?t%=360:t<0&&(t=(t%360+360)%360),(0,_util.shadow)(this,"rotate",t)},getContentStream:function(){var t,e=this.content;if(Array.isArray(e)){var r,i=this.xref,a=e.length,n=[];for(r=0;r<a;++r)n.push(i.fetchIfRef(e[r]));t=new _stream.StreamsSequenceStream(n)}else t=(0,_primitives.isStream)(e)?e:new _stream.NullStream;return t},loadResources:function(t){var e=this;return this.resourcesPromise||(this.resourcesPromise=this.pdfManager.ensure(this,"resources")),this.resourcesPromise.then((function(){var r=new _obj.ObjectLoader(e.resources,t,e.xref);return r.load()}))},getOperatorList:function(t){var e=this,i=t.handler,a=t.task,n=t.intent,o=t.renderInteractiveForms,s=this.pdfManager.ensure(this,"getContentStream"),u=this.loadResources(["ExtGState","ColorSpace","Pattern","Shading","XObject","Font"]),h=new _evaluator.PartialEvaluator({pdfManager:this.pdfManager,xref:this.xref,handler:i,pageIndex:this.pageIndex,idFactory:this.idFactory,fontCache:this.fontCache,builtInCMapCache:this.builtInCMapCache,options:this.evaluatorOptions,pdfFunctionFactory:this.pdfFunctionFactory}),c=Promise.all([s,u]),l=c.then((function(t){var r=_slicedToArray(t,1),o=r[0],s=new _operator_list.OperatorList(n,i,e.pageIndex);return i.send("StartRenderPage",{transparency:h.hasBlendModes(e.resources),pageIndex:e.pageIndex,intent:n}),h.getOperatorList({stream:o,task:a,resources:e.resources,operatorList:s}).then((function(){return s}))}));return Promise.all([l,this._parsedAnnotations]).then((function(t){var e=_slicedToArray(t,2),i=e[0],s=e[1];if(0===s.length)return i.flush(!0),i;var u,c,l=[];for(u=0,c=s.length;u<c;u++)r(s[u],n)&&l.push(s[u].getOperatorList(h,a,o));return Promise.all(l).then((function(t){for(i.addOp(_util.OPS.beginAnnotations,[]),u=0,c=t.length;u<c;u++)i.addOpList(t[u]);return i.addOp(_util.OPS.endAnnotations,[]),i.flush(!0),i}))}))},extractTextContent:function(t){var e=this,r=t.handler,i=t.task,a=t.normalizeWhitespace,n=t.sink,o=t.combineTextItems,s=this.pdfManager.ensure(this,"getContentStream"),u=this.loadResources(["ExtGState","XObject","Font"]),h=Promise.all([s,u]);return h.then((function(t){var s=_slicedToArray(t,1),u=s[0],h=new _evaluator.PartialEvaluator({pdfManager:e.pdfManager,xref:e.xref,handler:r,pageIndex:e.pageIndex,idFactory:e.idFactory,fontCache:e.fontCache,builtInCMapCache:e.builtInCMapCache,options:e.evaluatorOptions,pdfFunctionFactory:e.pdfFunctionFactory});return h.getTextContent({stream:u,task:i,resources:e.resources,normalizeWhitespace:a,combineTextItems:o,sink:n})}))},getAnnotationsData:function(t){return this._parsedAnnotations.then((function(e){for(var i=[],a=0,n=e.length;a<n;a++)t&&!r(e[a],t)||i.push(e[a].data);return i}))},get annotations(){return(0,_util.shadow)(this,"annotations",this._getInheritableProperty("Annots")||[])},get _parsedAnnotations(){var t=this,e=this.pdfManager.ensure(this,"annotations").then((function(){for(var e=t.annotations,r=[],i=0,a=e.length;i<a;i++)r.push(_annotation.AnnotationFactory.create(t.xref,e[i],t.pdfManager,t.idFactory));return Promise.all(r).then((function(t){return t.filter((function(t){return!!t}))}),(function(t){return(0,_util.warn)('_parsedAnnotations: "'+t+'".'),[]}))}));return(0,_util.shadow)(this,"_parsedAnnotations",e)}},i}(),PDFDocument=function(){var t=1024,e="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0";function r(t,e){var r;if((0,_primitives.isStream)(e))r=e;else{if(!(0,_util.isArrayBuffer)(e))throw new Error("PDFDocument: Unknown argument type");r=new _stream.Stream(e)}if(r.length<=0)throw new Error("PDFDocument: stream must have data");this.pdfManager=t,this.stream=r,this.xref=new _obj.XRef(r,t);var i=t.evaluatorOptions;this.pdfFunctionFactory=new _function.PDFFunctionFactory({xref:this.xref,isEvalSupported:i.isEvalSupported}),this._pagePromises=[]}function i(t,e,r,i){var a=t.pos,n=t.end,o=[];a+r>n&&(r=n-a);for(var s=0;s<r;++s)o.push(String.fromCharCode(t.getByte()));var u=o.join("");t.pos=a;var h=i?u.lastIndexOf(e):u.indexOf(e);return-1!==h&&(t.pos+=h,!0)}var a={Title:_util.isString,Author:_util.isString,Subject:_util.isString,Keywords:_util.isString,Creator:_util.isString,Producer:_util.isString,CreationDate:_util.isString,ModDate:_util.isString,Trapped:_primitives.isName};return r.prototype={parse:function(t){this.setup(t);var e=this.catalog.catDict.get("Version");(0,_primitives.isName)(e)&&(this.pdfFormatVersion=e.name);try{if(this.acroForm=this.catalog.catDict.get("AcroForm"),this.acroForm){this.xfa=this.acroForm.get("XFA");var r=this.acroForm.get("Fields");r&&Array.isArray(r)&&0!==r.length||this.xfa||(this.acroForm=null)}}catch(i){if(i instanceof _util.MissingDataException)throw i;(0,_util.info)("Something wrong with AcroForm entry"),this.acroForm=null}},get linearization(){var t=null;try{t=_parser.Linearization.create(this.stream)}catch(e){if(e instanceof _util.MissingDataException)throw e;(0,_util.info)(e)}return(0,_util.shadow)(this,"linearization",t)},get startXRef(){var t=this.stream,e=0,r=this.linearization;if(r)t.reset(),i(t,"endobj",1024)&&(e=t.pos+6);else{var a=1024,n=!1,o=t.end;while(!n&&o>0)o-=a-"startxref".length,o<0&&(o=0),t.pos=o,n=i(t,"startxref",a,!0);if(n){var s;t.skip(9);do{s=t.getByte()}while((0,_util.isSpace)(s));var u="";while(s>=32&&s<=57)u+=String.fromCharCode(s),s=t.getByte();e=parseInt(u,10),isNaN(e)&&(e=0)}}return(0,_util.shadow)(this,"startXRef",e)},checkHeader:function(){var t=this.stream;if(t.reset(),i(t,"%PDF-",1024)){t.moveStart();var e,r=12,a="";while((e=t.getByte())>32){if(a.length>=r)break;a+=String.fromCharCode(e)}this.pdfFormatVersion||(this.pdfFormatVersion=a.substring(5))}else;},parseStartXRef:function(){var t=this.startXRef;this.xref.setStartXRef(t)},setup:function(t){this.xref.parse(t),this.catalog=new _obj.Catalog(this.pdfManager,this.xref)},get numPages(){var t=this.linearization,e=t?t.numPages:this.catalog.numPages;return(0,_util.shadow)(this,"numPages",e)},get documentInfo(){var t={PDFFormatVersion:this.pdfFormatVersion,IsLinearized:!!this.linearization,IsAcroFormPresent:!!this.acroForm,IsXFAPresent:!!this.xfa},e=void 0;try{e=this.xref.trailer.get("Info")}catch(n){if(n instanceof _util.MissingDataException)throw n;(0,_util.info)("The document information dictionary is invalid.")}if((0,_primitives.isDict)(e))for(var r in a)if(e.has(r)){var i=e.get(r);a[r](i)?t[r]="string"!==typeof i?i:(0,_util.stringToPDFString)(i):(0,_util.info)('Bad value in document info for "'+r+'"')}return(0,_util.shadow)(this,"documentInfo",t)},get fingerprint(){var r,i=this.xref,a="",n=i.trailer.get("ID");Array.isArray(n)&&n[0]&&(0,_util.isString)(n[0])&&n[0]!==e?r=(0,_util.stringToBytes)(n[0]):(this.stream.ensureRange&&this.stream.ensureRange(0,Math.min(t,this.stream.end)),r=(0,_crypto.calculateMD5)(this.stream.bytes.subarray(0,t),0,t));for(var o=0,s=r.length;o<s;o++){var u=r[o].toString(16);a+=1===u.length?"0"+u:u}return(0,_util.shadow)(this,"fingerprint",a)},_getLinearizationPage:function(t){var e=this.catalog,r=this.linearization;(0,_util.assert)(r&&r.pageFirst===t);var i=new _primitives.Ref(r.objectNumberFirst,0);return this.xref.fetchAsync(i).then((function(t){if((0,_primitives.isDict)(t,"Page")||(0,_primitives.isDict)(t)&&!t.has("Type")&&t.has("Contents"))return i&&!e.pageKidsCountCache.has(i)&&e.pageKidsCountCache.put(i,1),[t,i];throw new _util.FormatError("The Linearization dictionary doesn't point to a valid Page dictionary.")})).catch((function(r){return(0,_util.info)(r),e.getPageDict(t)}))},getPage:function(t){var e=this;if(void 0!==this._pagePromises[t])return this._pagePromises[t];var r=this.catalog,i=this.linearization,a=i&&i.pageFirst===t?this._getLinearizationPage(t):r.getPageDict(t);return this._pagePromises[t]=a.then((function(i){var a=_slicedToArray(i,2),n=a[0],o=a[1];return new Page({pdfManager:e.pdfManager,xref:e.xref,pageIndex:t,pageDict:n,ref:o,fontCache:r.fontCache,builtInCMapCache:r.builtInCMapCache,pdfFunctionFactory:e.pdfFunctionFactory})}))},cleanup:function(){return this.catalog.cleanup()}},r}();exports.Page=Page,exports.PDFDocument=PDFDocument;