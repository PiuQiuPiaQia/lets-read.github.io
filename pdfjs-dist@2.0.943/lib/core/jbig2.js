"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Jbig2Image=void 0;var _util=require("../shared/util"),_arithmetic_decoder=require("./arithmetic_decoder"),_ccitt=require("./ccitt"),Jbig2Error=function(){function e(e){this.message="JBIG2 error: "+e}return e.prototype=new Error,e.prototype.name="Jbig2Error",e.constructor=e,e}(),Jbig2Image=function(){function e(){}function t(e,t,r){this.data=e,this.start=t,this.end=r}function r(e,t,r){var i=e.getContexts(t),n=1;function a(e){for(var t=0,a=0;a<e;a++){var o=r.readBit(i,n);n=n<256?n<<1|o:511&(n<<1|o)|256,t=t<<1|o}return t>>>0}var o=a(1),s=a(1)?a(1)?a(1)?a(1)?a(1)?a(32)+4436:a(12)+340:a(8)+84:a(6)+20:a(4)+4:a(2);return 0===o?s:s>0?-s:null}function i(e,t,r){for(var i=e.getContexts("IAID"),n=1,a=0;a<r;a++){var o=t.readBit(i,n);n=n<<1|o}return r<31?n&(1<<r)-1:2147483647&n}e.prototype={getContexts:function(e){return e in this?this[e]:this[e]=new Int8Array(65536)}},t.prototype={get decoder(){var e=new _arithmetic_decoder.ArithmeticDecoder(this.data,this.start,this.end);return(0,_util.shadow)(this,"decoder",e)},get contextCache(){var t=new e;return(0,_util.shadow)(this,"contextCache",t)}};var n=["SymbolDictionary",null,null,null,"IntermediateTextRegion",null,"ImmediateTextRegion","ImmediateLosslessTextRegion",null,null,null,null,null,null,null,null,"PatternDictionary",null,null,null,"IntermediateHalftoneRegion",null,"ImmediateHalftoneRegion","ImmediateLosslessHalftoneRegion",null,null,null,null,null,null,null,null,null,null,null,null,"IntermediateGenericRegion",null,"ImmediateGenericRegion","ImmediateLosslessGenericRegion","IntermediateGenericRefinementRegion",null,"ImmediateGenericRefinementRegion","ImmediateLosslessGenericRefinementRegion",null,null,null,null,"PageInformation","EndOfPage","EndOfStripe","EndOfFile","Profiles","Tables",null,null,null,null,null,null,null,null,"Extension"],a=[[{x:-1,y:-2},{x:0,y:-2},{x:1,y:-2},{x:-2,y:-1},{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:2,y:-1},{x:-4,y:0},{x:-3,y:0},{x:-2,y:0},{x:-1,y:0}],[{x:-1,y:-2},{x:0,y:-2},{x:1,y:-2},{x:2,y:-2},{x:-2,y:-1},{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:2,y:-1},{x:-3,y:0},{x:-2,y:0},{x:-1,y:0}],[{x:-1,y:-2},{x:0,y:-2},{x:1,y:-2},{x:-2,y:-1},{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:-2,y:0},{x:-1,y:0}],[{x:-3,y:-1},{x:-2,y:-1},{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:-4,y:0},{x:-3,y:0},{x:-2,y:0},{x:-1,y:0}]],o=[{coding:[{x:0,y:-1},{x:1,y:-1},{x:-1,y:0}],reference:[{x:0,y:-1},{x:1,y:-1},{x:-1,y:0},{x:0,y:0},{x:1,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1}]},{coding:[{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:-1,y:0}],reference:[{x:0,y:-1},{x:-1,y:0},{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1}]}],s=[39717,1941,229,405],l=[32,8];function f(e,t,r){var i,n,a,o,s,l,f,d=r.decoder,h=r.contextCache.getContexts("GB"),u=[],c=31735;for(n=0;n<t;n++)for(s=u[n]=new Uint8Array(e),l=n<1?s:u[n-1],f=n<2?s:u[n-2],i=f[0]<<13|f[1]<<12|f[2]<<11|l[0]<<7|l[1]<<6|l[2]<<5|l[3]<<4,a=0;a<e;a++)s[a]=o=d.readBit(h,i),i=(i&c)<<1|(a+3<e?f[a+3]<<11:0)|(a+4<e?l[a+4]<<4:0)|o;return u}function d(e,t,r,i,n,o,l,d){if(e){var h=new O(d.data,d.start,d.end);return L(h,t,r,!1)}if(0===i&&!o&&!n&&4===l.length&&3===l[0].x&&-1===l[0].y&&-3===l[1].x&&-1===l[1].y&&2===l[2].x&&-2===l[2].y&&-2===l[3].x&&-2===l[3].y)return f(t,r,d);var u=!!o,c=a[i].concat(l);c.sort((function(e,t){return e.y-t.y||e.x-t.x}));var m,v,g=c.length,p=new Int8Array(g),w=new Int8Array(g),b=[],y=0,x=0,I=0,k=0;for(v=0;v<g;v++)p[v]=c[v].x,w[v]=c[v].y,x=Math.min(x,c[v].x),I=Math.max(I,c[v].x),k=Math.min(k,c[v].y),v<g-1&&c[v].y===c[v+1].y&&c[v].x===c[v+1].x-1?y|=1<<g-1-v:b.push(v);var A=b.length,_=new Int8Array(A),D=new Int8Array(A),S=new Uint16Array(A);for(m=0;m<A;m++)v=b[m],_[m]=c[v].x,D[m]=c[v].y,S[m]=1<<g-1-v;for(var B,R,U,E,T,J=-x,C=-k,H=t-I,P=s[i],N=new Uint8Array(t),G=[],W=d.decoder,z=d.contextCache.getContexts("GB"),V=0,F=0,X=0;X<r;X++){if(n){var Y=W.readBit(z,P);if(V^=Y,V){G.push(N);continue}}for(N=new Uint8Array(N),G.push(N),B=0;B<t;B++)if(u&&o[X][B])N[B]=0;else{if(B>=J&&B<H&&X>=C)for(F=F<<1&y,v=0;v<A;v++)R=X+D[v],U=B+_[v],E=G[R][U],E&&(E=S[v],F|=E);else for(F=0,T=g-1,v=0;v<g;v++,T--)U=B+p[v],U>=0&&U<t&&(R=X+w[v],R>=0&&(E=G[R][U],E&&(F|=E<<T)));var M=W.readBit(z,F);N[B]=M}}return G}function h(e,t,r,i,n,a,s,f,d){var h=o[r].coding;0===r&&(h=h.concat([f[0]]));var u,c=h.length,m=new Int32Array(c),v=new Int32Array(c);for(u=0;u<c;u++)m[u]=h[u].x,v[u]=h[u].y;var g=o[r].reference;0===r&&(g=g.concat([f[1]]));var p=g.length,w=new Int32Array(p),b=new Int32Array(p);for(u=0;u<p;u++)w[u]=g[u].x,b[u]=g[u].y;for(var y=i[0].length,x=i.length,I=l[r],k=[],A=d.decoder,_=d.contextCache.getContexts("GR"),D=0,S=0;S<t;S++){if(s){var B=A.readBit(_,I);if(D^=B,D)throw new Jbig2Error("prediction is not supported")}var R=new Uint8Array(e);k.push(R);for(var U=0;U<e;U++){var O,E,T=0;for(u=0;u<c;u++)O=S+v[u],E=U+m[u],O<0||E<0||E>=e?T<<=1:T=T<<1|k[O][E];for(u=0;u<p;u++)O=S+b[u]-a,E=U+w[u]-n,O<0||O>=x||E<0||E>=y?T<<=1:T=T<<1|i[O][E];var J=A.readBit(_,T);R[U]=J}}return k}function u(e,t,n,a,o,s,l,f,u,m,v,g){if(e&&t)throw new Jbig2Error("symbol refinement with Huffman is not supported");var p=[],w=0,b=(0,_util.log2)(n.length+a),y=v.decoder,x=v.contextCache,I=void 0,k=void 0;e&&(I=U(1),k=[],b=Math.max(b,1));while(p.length<a){var A=e?s.tableDeltaHeight.decode(g):r(x,"IADH",y);w+=A;var _=0,D=0,S=e?k.length:0;while(1){var B,R=e?s.tableDeltaWidth.decode(g):r(x,"IADW",y);if(null===R)break;if(_+=R,D+=_,t){var O=r(x,"IAAI",y);if(O>1)B=c(e,t,_,w,0,O,1,n.concat(p),b,0,0,1,0,s,u,m,v,0,g);else{var E=i(x,y,b),T=r(x,"IARDX",y),J=r(x,"IARDY",y),H=E<n.length?n[E]:p[E-n.length];B=h(_,w,u,H,T,J,!1,m,v)}p.push(B)}else e?k.push(_):(B=d(!1,_,w,l,!1,null,f,v),p.push(B))}if(e&&!t){var P=s.tableBitmapSize.decode(g);g.byteAlign();var N=void 0;if(0===P)N=C(g,D,w);else{var G=g.end,W=g.position+P;g.end=W,N=L(g,D,w,!1),g.end=G,g.position=W}var z=k.length;if(S===z-1)p.push(N);else{var V=void 0,F=void 0,X=0,Y=void 0,M=void 0,q=void 0;for(V=S;V<z;V++){for(M=k[V],Y=X+M,q=[],F=0;F<w;F++)q.push(N[F].subarray(X,Y));p.push(q),X=Y}}}}var j=[],K=[],Q=!1,Z=n.length+a;while(K.length<Z){var $=e?I.decode(g):r(x,"IAEX",y);while($--)K.push(Q);Q=!Q}for(var ee=0,te=n.length;ee<te;ee++)K[ee]&&j.push(n[ee]);for(var re=0;re<a;ee++,re++)K[ee]&&j.push(p[re]);return j}function c(e,t,n,a,o,s,l,f,d,u,c,m,v,g,p,w,b,y,x){if(e&&t)throw new Jbig2Error("refinement with Huffman is not supported");var I,k,A=[];for(I=0;I<a;I++){if(k=new Uint8Array(n),o)for(var _=0;_<n;_++)k[_]=o;A.push(k)}var D=b.decoder,S=b.contextCache,B=e?-g.tableDeltaT.decode(x):-r(S,"IADT",D),R=0;I=0;while(I<s){var U=e?g.tableDeltaT.decode(x):r(S,"IADT",D);B+=U;var O=e?g.tableFirstS.decode(x):r(S,"IAFS",D);R+=O;var E=R;do{var T=0;l>1&&(T=e?x.readBits(y):r(S,"IAIT",D));var J=l*B+T,C=e?g.symbolIDTable.decode(x):i(S,D,d),L=t&&(e?x.readBit():r(S,"IARI",D)),H=f[C],P=H[0].length,N=H.length;if(L){var G=r(S,"IARDW",D),W=r(S,"IARDH",D),z=r(S,"IARDX",D),V=r(S,"IARDY",D);P+=G,N+=W,H=h(P,N,p,H,(G>>1)+z,(W>>1)+V,!1,w,b)}var F,X,Y,M=J-(1&m?0:N-1),q=E-(2&m?P-1:0);if(u){for(F=0;F<N;F++)if(k=A[q+F],k){Y=H[F];var j=Math.min(n-M,P);switch(v){case 0:for(X=0;X<j;X++)k[M+X]|=Y[X];break;case 2:for(X=0;X<j;X++)k[M+X]^=Y[X];break;default:throw new Jbig2Error("operator "+v+" is not supported")}}E+=N-1}else{for(X=0;X<N;X++)if(k=A[M+X],k)switch(Y=H[X],v){case 0:for(F=0;F<P;F++)k[q+F]|=Y[F];break;case 2:for(F=0;F<P;F++)k[q+F]^=Y[F];break;default:throw new Jbig2Error("operator "+v+" is not supported")}E+=P-1}I++;var K=e?g.tableDeltaS.decode(x):r(S,"IADS",D);if(null===K)break;E+=K+c}while(1)}return A}function m(e,t,r,i,n,a){var o=[];e||(o.push({x:-t,y:0}),0===n&&(o.push({x:-3,y:-1}),o.push({x:2,y:-2}),o.push({x:-2,y:-2})));var s=(i+1)*t,l=d(e,s,r,n,!1,null,o,a),f=[],h=0,u=void 0,c=void 0,m=void 0,v=void 0;while(h<=i){for(u=[],c=t*h,m=c+t,v=0;v<r;v++)u.push(l[v].subarray(c,m));f.push(u),h++}return f}function v(e,t,r,i,n,a,o,s,l,f,h,u,c,m,v){var g=null;if(o)throw new Jbig2Error("skip is not supported");if(0!==s)throw new Jbig2Error("operator "+s+" is not supported in halftone region");var p=[],w=void 0,b=void 0,y=void 0;for(w=0;w<n;w++){if(y=new Uint8Array(i),a)for(b=0;b<i;b++)y[b]=a;p.push(y)}var x=t.length,I=t[0],k=I[0].length,A=I.length,_=(0,_util.log2)(x),D=[];e||(D.push({x:r<=1?3:2,y:-1}),0===r&&(D.push({x:-3,y:-1}),D.push({x:2,y:-2}),D.push({x:-2,y:-2})));var S=[],B=void 0,R=void 0;for(e&&(B=new O(v.data,v.start,v.end)),w=_-1;w>=0;w--)R=e?L(B,l,f,!0):d(!1,l,f,r,!1,g,D,v),S[w]=R;var U=void 0,E=void 0,T=void 0,J=void 0,C=void 0,H=void 0,P=void 0,N=void 0,G=void 0;for(U=0;U<f;U++)for(E=0;E<l;E++){for(T=0,J=0,b=_-1;b>=0;b--)T=S[b][U][E]^T,J|=T<<b;if(C=t[J],H=h+U*m+E*c>>8,P=u+U*c-E*m>>8,H>=0&&H+k<=i&&P>=0&&P+A<=n)for(w=0;w<A;w++)for(G=p[P+w],N=C[w],b=0;b<k;b++)G[H+b]|=N[b];else{var W=void 0,z=void 0;for(w=0;w<A;w++)if(z=P+w,!(z<0||z>=n))for(G=p[z],N=C[w],b=0;b<k;b++)W=H+b,W>=0&&W<i&&(G[W]|=N[b])}}return p}function g(e,t){var r={};r.number=(0,_util.readUint32)(e,t);var i=e[t+4],a=63&i;if(!n[a])throw new Jbig2Error("invalid segment type: "+a);r.type=a,r.typeName=n[a],r.deferredNonRetain=!!(128&i);var o=!!(64&i),s=e[t+5],l=s>>5&7,f=[31&s],d=t+6;if(7===s){l=536870911&(0,_util.readUint32)(e,d-1),d+=3;var h=l+7>>3;f[0]=e[d++];while(--h>0)f.push(e[d++])}else if(5===s||6===s)throw new Jbig2Error("invalid referred-to flags");r.retainBits=f;var u,c,m=r.number<=256?1:r.number<=65536?2:4,v=[];for(u=0;u<l;u++){var g=1===m?e[d]:2===m?(0,_util.readUint16)(e,d):(0,_util.readUint32)(e,d);v.push(g),d+=m}if(r.referredTo=v,o?(r.pageAssociation=(0,_util.readUint32)(e,d),d+=4):r.pageAssociation=e[d++],r.length=(0,_util.readUint32)(e,d),d+=4,4294967295===r.length){if(38!==a)throw new Jbig2Error("invalid unknown segment length");var p=w(e,d),y=e[d+b],x=!!(1&y),I=6,k=new Uint8Array(I);for(x||(k[0]=255,k[1]=172),k[2]=p.height>>>24&255,k[3]=p.height>>16&255,k[4]=p.height>>8&255,k[5]=255&p.height,u=d,c=e.length;u<c;u++){var A=0;while(A<I&&k[A]===e[u+A])A++;if(A===I){r.length=u+I;break}}if(4294967295===r.length)throw new Jbig2Error("segment end was not found")}return r.headerEnd=d,r}function p(e,t,r,i){var n=[],a=r;while(a<i){var o=g(t,a);a=o.headerEnd;var s={header:o,data:t};if(e.randomAccess||(s.start=a,a+=o.length,s.end=a),n.push(s),51===o.type)break}if(e.randomAccess)for(var l=0,f=n.length;l<f;l++)n[l].start=a,a+=n[l].header.length,n[l].end=a;return n}function w(e,t){return{width:(0,_util.readUint32)(e,t),height:(0,_util.readUint32)(e,t+4),x:(0,_util.readUint32)(e,t+8),y:(0,_util.readUint32)(e,t+12),combinationOperator:7&e[t+16]}}var b=17;function y(e,t){var r,i,n,a,o=e.header,s=e.data,l=e.start,f=e.end;switch(o.type){case 0:var d={},h=(0,_util.readUint16)(s,l);if(d.huffman=!!(1&h),d.refinement=!!(2&h),d.huffmanDHSelector=h>>2&3,d.huffmanDWSelector=h>>4&3,d.bitmapSizeSelector=h>>6&1,d.aggregationInstancesSelector=h>>7&1,d.bitmapCodingContextUsed=!!(256&h),d.bitmapCodingContextRetained=!!(512&h),d.template=h>>10&3,d.refinementTemplate=h>>12&1,l+=2,!d.huffman){for(a=0===d.template?4:1,i=[],n=0;n<a;n++)i.push({x:(0,_util.readInt8)(s,l),y:(0,_util.readInt8)(s,l+1)}),l+=2;d.at=i}if(d.refinement&&!d.refinementTemplate){for(i=[],n=0;n<2;n++)i.push({x:(0,_util.readInt8)(s,l),y:(0,_util.readInt8)(s,l+1)}),l+=2;d.refinementAt=i}d.numberOfExportedSymbols=(0,_util.readUint32)(s,l),l+=4,d.numberOfNewSymbols=(0,_util.readUint32)(s,l),l+=4,r=[d,o.number,o.referredTo,s,l,f];break;case 6:case 7:var u={};u.info=w(s,l),l+=b;var c=(0,_util.readUint16)(s,l);if(l+=2,u.huffman=!!(1&c),u.refinement=!!(2&c),u.logStripSize=c>>2&3,u.stripSize=1<<u.logStripSize,u.referenceCorner=c>>4&3,u.transposed=!!(64&c),u.combinationOperator=c>>7&3,u.defaultPixelValue=c>>9&1,u.dsOffset=c<<17>>27,u.refinementTemplate=c>>15&1,u.huffman){var m=(0,_util.readUint16)(s,l);l+=2,u.huffmanFS=3&m,u.huffmanDS=m>>2&3,u.huffmanDT=m>>4&3,u.huffmanRefinementDW=m>>6&3,u.huffmanRefinementDH=m>>8&3,u.huffmanRefinementDX=m>>10&3,u.huffmanRefinementDY=m>>12&3,u.huffmanRefinementSizeSelector=!!(16384&m)}if(u.refinement&&!u.refinementTemplate){for(i=[],n=0;n<2;n++)i.push({x:(0,_util.readInt8)(s,l),y:(0,_util.readInt8)(s,l+1)}),l+=2;u.refinementAt=i}u.numberOfSymbolInstances=(0,_util.readUint32)(s,l),l+=4,r=[u,o.referredTo,s,l,f];break;case 16:var v={},g=s[l++];v.mmr=!!(1&g),v.template=g>>1&3,v.patternWidth=s[l++],v.patternHeight=s[l++],v.maxPatternIndex=(0,_util.readUint32)(s,l),l+=4,r=[v,o.number,s,l,f];break;case 22:case 23:var p={};p.info=w(s,l),l+=b;var y=s[l++];p.mmr=!!(1&y),p.template=y>>1&3,p.enableSkip=!!(8&y),p.combinationOperator=y>>4&7,p.defaultPixelValue=y>>7&1,p.gridWidth=(0,_util.readUint32)(s,l),l+=4,p.gridHeight=(0,_util.readUint32)(s,l),l+=4,p.gridOffsetX=4294967295&(0,_util.readUint32)(s,l),l+=4,p.gridOffsetY=4294967295&(0,_util.readUint32)(s,l),l+=4,p.gridVectorX=(0,_util.readUint16)(s,l),l+=2,p.gridVectorY=(0,_util.readUint16)(s,l),l+=2,r=[p,o.referredTo,s,l,f];break;case 38:case 39:var x={};x.info=w(s,l),l+=b;var I=s[l++];if(x.mmr=!!(1&I),x.template=I>>1&3,x.prediction=!!(8&I),!x.mmr){for(a=0===x.template?4:1,i=[],n=0;n<a;n++)i.push({x:(0,_util.readInt8)(s,l),y:(0,_util.readInt8)(s,l+1)}),l+=2;x.at=i}r=[x,s,l,f];break;case 48:var k={width:(0,_util.readUint32)(s,l),height:(0,_util.readUint32)(s,l+4),resolutionX:(0,_util.readUint32)(s,l+8),resolutionY:(0,_util.readUint32)(s,l+12)};4294967295===k.height&&delete k.height;var A=s[l+16];(0,_util.readUint16)(s,l+17),k.lossless=!!(1&A),k.refinement=!!(2&A),k.defaultPixelValue=A>>2&1,k.combinationOperator=A>>3&3,k.requiresBuffer=!!(32&A),k.combinationOperatorOverride=!!(64&A),r=[k];break;case 49:break;case 50:break;case 51:break;case 53:r=[o.number,s,l,f];break;case 62:break;default:throw new Jbig2Error("segment type "+o.typeName+"("+o.type+") is not implemented")}var _="on"+o.typeName;_ in t&&t[_].apply(t,r)}function x(e,t){for(var r=0,i=e.length;r<i;r++)y(e[r],t)}function I(e){for(var t=new A,r=0,i=e.length;r<i;r++){var n=e[r],a=p({},n.data,n.start,n.end);x(a,t)}return t.buffer}function k(e){var t=0,r=e.length;if(151!==e[t]||74!==e[t+1]||66!==e[t+2]||50!==e[t+3]||13!==e[t+4]||10!==e[t+5]||26!==e[t+6]||10!==e[t+7])throw new Jbig2Error("parseJbig2 - invalid header.");var i=Object.create(null);t+=8;var n=e[t++];i.randomAccess=!(1&n),2&n||(i.numberOfPages=(0,_util.readUint32)(e,t),t+=4);var a=p(i,e,t,r),o=new A;x(a,o);for(var s=o.currentPageInfo,l=s.width,f=s.height,d=o.buffer,h=new Uint8ClampedArray(l*f),u=0,c=0,m=0;m<f;m++)for(var v=0,g=void 0,w=0;w<l;w++)v||(v=128,g=d[c++]),h[u++]=g&v?0:255,v>>=1;return{imgData:h,width:l,height:f}}function A(){}function _(e){2===e.length?(this.isOOB=!0,this.rangeLow=0,this.prefixLength=e[0],this.rangeLength=0,this.prefixCode=e[1],this.isLowerRange=!1):(this.isOOB=!1,this.rangeLow=e[0],this.prefixLength=e[1],this.rangeLength=e[2],this.prefixCode=e[3],this.isLowerRange="lower"===e[4])}function D(e){this.children=[],e?(this.isLeaf=!0,this.rangeLength=e.rangeLength,this.rangeLow=e.rangeLow,this.isLowerRange=e.isLowerRange,this.isOOB=e.isOOB):this.isLeaf=!1}function S(e,t){t||this.assignPrefixCodes(e),this.rootNode=new D(null);var r=void 0,i=e.length,n=void 0;for(r=0;r<i;r++)n=e[r],n.prefixLength>0&&this.rootNode.buildTree(n,n.prefixLength-1)}function B(e,t,r){var i=e[t],n=4294967295&(0,_util.readUint32)(e,t+1),a=4294967295&(0,_util.readUint32)(e,t+5),o=new O(e,t+9,r),s=1+(i>>1&7),l=1+(i>>4&7),f=[],d=void 0,h=void 0,u=n;do{d=o.readBits(s),h=o.readBits(l),f.push(new _([u,d,h,0])),u+=1<<h}while(u<a);return d=o.readBits(s),f.push(new _([n-1,d,32,0,"lower"])),d=o.readBits(s),f.push(new _([a,d,32,0])),1&i&&(d=o.readBits(s),f.push(new _([d,0]))),new S(f,!1)}A.prototype={onPageInformation:function(e){this.currentPageInfo=e;var t=e.width+7>>3,r=new Uint8ClampedArray(t*e.height);if(e.defaultPixelValue)for(var i=0,n=r.length;i<n;i++)r[i]=255;this.buffer=r},drawBitmap:function(e,t){var r,i,n,a,o=this.currentPageInfo,s=e.width,l=e.height,f=o.width+7>>3,d=o.combinationOperatorOverride?e.combinationOperator:o.combinationOperator,h=this.buffer,u=128>>(7&e.x),c=e.y*f+(e.x>>3);switch(d){case 0:for(r=0;r<l;r++){for(n=u,a=c,i=0;i<s;i++)t[r][i]&&(h[a]|=n),n>>=1,n||(n=128,a++);c+=f}break;case 2:for(r=0;r<l;r++){for(n=u,a=c,i=0;i<s;i++)t[r][i]&&(h[a]^=n),n>>=1,n||(n=128,a++);c+=f}break;default:throw new Jbig2Error("operator "+d+" is not supported")}},onImmediateGenericRegion:function(e,r,i,n){var a=e.info,o=new t(r,i,n),s=d(e.mmr,a.width,a.height,e.template,e.prediction,null,e.at,o);this.drawBitmap(a,s)},onImmediateLosslessGenericRegion:function(){this.onImmediateGenericRegion.apply(this,arguments)},onSymbolDictionary:function(e,r,i,n,a,o){var s=void 0,l=void 0;e.huffman&&(s=J(e,i,this.customTables),l=new O(n,a,o));var f=this.symbols;f||(this.symbols=f={});for(var d=[],h=0,c=i.length;h<c;h++){var m=f[i[h]];m&&(d=d.concat(m))}var v=new t(n,a,o);f[r]=u(e.huffman,e.refinement,d,e.numberOfNewSymbols,e.numberOfExportedSymbols,s,e.template,e.at,e.refinementTemplate,e.refinementAt,v,l)},onImmediateTextRegion:function(e,r,i,n,a){for(var o=e.info,s=void 0,l=void 0,f=this.symbols,d=[],h=0,u=r.length;h<u;h++){var m=f[r[h]];m&&(d=d.concat(m))}var v=(0,_util.log2)(d.length);e.huffman&&(l=new O(i,n,a),s=T(e,r,this.customTables,d.length,l));var g=new t(i,n,a),p=c(e.huffman,e.refinement,o.width,o.height,e.defaultPixelValue,e.numberOfSymbolInstances,e.stripSize,d,v,e.transposed,e.dsOffset,e.referenceCorner,e.combinationOperator,s,e.refinementTemplate,e.refinementAt,g,e.logStripSize,l);this.drawBitmap(o,p)},onImmediateLosslessTextRegion:function(){this.onImmediateTextRegion.apply(this,arguments)},onPatternDictionary:function(e,r,i,n,a){var o=this.patterns;o||(this.patterns=o={});var s=new t(i,n,a);o[r]=m(e.mmr,e.patternWidth,e.patternHeight,e.maxPatternIndex,e.template,s)},onImmediateHalftoneRegion:function(e,r,i,n,a){var o=this.patterns[r[0]],s=e.info,l=new t(i,n,a),f=v(e.mmr,o,e.template,s.width,s.height,e.defaultPixelValue,e.enableSkip,e.combinationOperator,e.gridWidth,e.gridHeight,e.gridOffsetX,e.gridOffsetY,e.gridVectorX,e.gridVectorY,l);this.drawBitmap(s,f)},onImmediateLosslessHalftoneRegion:function(){this.onImmediateHalftoneRegion.apply(this,arguments)},onTables:function(e,t,r,i){var n=this.customTables;n||(this.customTables=n={}),n[e]=B(t,r,i)}},D.prototype={buildTree:function(e,t){var r=e.prefixCode>>t&1;if(t<=0)this.children[r]=new D(e);else{var i=this.children[r];i||(this.children[r]=i=new D(null)),i.buildTree(e,t-1)}},decodeNode:function(e){if(this.isLeaf){if(this.isOOB)return null;var t=e.readBits(this.rangeLength);return this.rangeLow+(this.isLowerRange?-t:t)}var r=this.children[e.readBit()];if(!r)throw new Jbig2Error("invalid Huffman data");return r.decodeNode(e)}},S.prototype={decode:function(e){return this.rootNode.decodeNode(e)},assignPrefixCodes:function(e){var t=e.length,r=0,i=void 0;for(i=0;i<t;i++)r=Math.max(r,e[i].prefixLength);var n=new Uint32Array(r+1);for(i=0;i<t;i++)n[e[i].prefixLength]++;var a=1,o=0,s=void 0,l=void 0,f=void 0;n[0]=0;while(a<=r){o=o+n[a-1]<<1,s=o,l=0;while(l<t)f=e[l],f.prefixLength===a&&(f.prefixCode=s,s++),l++;a++}}};var R={};function U(e){var t=R[e];if(t)return t;var r=void 0;switch(e){case 1:r=[[0,1,4,0],[16,2,8,2],[272,3,16,6],[65808,3,32,7]];break;case 2:r=[[0,1,0,0],[1,2,0,2],[2,3,0,6],[3,4,3,14],[11,5,6,30],[75,6,32,62],[6,63]];break;case 3:r=[[-256,8,8,254],[0,1,0,0],[1,2,0,2],[2,3,0,6],[3,4,3,14],[11,5,6,30],[-257,8,32,255,"lower"],[75,7,32,126],[6,62]];break;case 4:r=[[1,1,0,0],[2,2,0,2],[3,3,0,6],[4,4,3,14],[12,5,6,30],[76,5,32,31]];break;case 5:r=[[-255,7,8,126],[1,1,0,0],[2,2,0,2],[3,3,0,6],[4,4,3,14],[12,5,6,30],[-256,7,32,127,"lower"],[76,6,32,62]];break;case 6:r=[[-2048,5,10,28],[-1024,4,9,8],[-512,4,8,9],[-256,4,7,10],[-128,5,6,29],[-64,5,5,30],[-32,4,5,11],[0,2,7,0],[128,3,7,2],[256,3,8,3],[512,4,9,12],[1024,4,10,13],[-2049,6,32,62,"lower"],[2048,6,32,63]];break;case 7:r=[[-1024,4,9,8],[-512,3,8,0],[-256,4,7,9],[-128,5,6,26],[-64,5,5,27],[-32,4,5,10],[0,4,5,11],[32,5,5,28],[64,5,6,29],[128,4,7,12],[256,3,8,1],[512,3,9,2],[1024,3,10,3],[-1025,5,32,30,"lower"],[2048,5,32,31]];break;case 8:r=[[-15,8,3,252],[-7,9,1,508],[-5,8,1,253],[-3,9,0,509],[-2,7,0,124],[-1,4,0,10],[0,2,1,0],[2,5,0,26],[3,6,0,58],[4,3,4,4],[20,6,1,59],[22,4,4,11],[38,4,5,12],[70,5,6,27],[134,5,7,28],[262,6,7,60],[390,7,8,125],[646,6,10,61],[-16,9,32,510,"lower"],[1670,9,32,511],[2,1]];break;case 9:r=[[-31,8,4,252],[-15,9,2,508],[-11,8,2,253],[-7,9,1,509],[-5,7,1,124],[-3,4,1,10],[-1,3,1,2],[1,3,1,3],[3,5,1,26],[5,6,1,58],[7,3,5,4],[39,6,2,59],[43,4,5,11],[75,4,6,12],[139,5,7,27],[267,5,8,28],[523,6,8,60],[779,7,9,125],[1291,6,11,61],[-32,9,32,510,"lower"],[3339,9,32,511],[2,0]];break;case 10:r=[[-21,7,4,122],[-5,8,0,252],[-4,7,0,123],[-3,5,0,24],[-2,2,2,0],[2,5,0,25],[3,6,0,54],[4,7,0,124],[5,8,0,253],[6,2,6,1],[70,5,5,26],[102,6,5,55],[134,6,6,56],[198,6,7,57],[326,6,8,58],[582,6,9,59],[1094,6,10,60],[2118,7,11,125],[-22,8,32,254,"lower"],[4166,8,32,255],[2,2]];break;case 11:r=[[1,1,0,0],[2,2,1,2],[4,4,0,12],[5,4,1,13],[7,5,1,28],[9,5,2,29],[13,6,2,60],[17,7,2,122],[21,7,3,123],[29,7,4,124],[45,7,5,125],[77,7,6,126],[141,7,32,127]];break;case 12:r=[[1,1,0,0],[2,2,0,2],[3,3,1,6],[5,5,0,28],[6,5,1,29],[8,6,1,60],[10,7,0,122],[11,7,1,123],[13,7,2,124],[17,7,3,125],[25,7,4,126],[41,8,5,254],[73,8,32,255]];break;case 13:r=[[1,1,0,0],[2,3,0,4],[3,4,0,12],[4,5,0,28],[5,4,1,13],[7,3,3,5],[15,6,1,58],[17,6,2,59],[21,6,3,60],[29,6,4,61],[45,6,5,62],[77,7,6,126],[141,7,32,127]];break;case 14:r=[[-2,3,0,4],[-1,3,0,5],[0,1,0,0],[1,3,0,6],[2,3,0,7]];break;case 15:r=[[-24,7,4,124],[-8,6,2,60],[-4,5,1,28],[-2,4,0,12],[-1,3,0,4],[0,1,0,0],[1,3,0,5],[2,4,0,13],[3,5,1,29],[5,6,2,61],[9,7,4,125],[-25,7,32,126,"lower"],[25,7,32,127]];break;default:throw new Jbig2Error("standard table B."+e+" does not exist")}var i=r.length,n=void 0;for(n=0;n<i;n++)r[n]=new _(r[n]);return t=new S(r,!0),R[e]=t,t}function O(e,t,r){this.data=e,this.start=t,this.end=r,this.position=t,this.shift=-1,this.currentByte=0}function E(e,t,r){var i=0,n=void 0,a=t.length,o=void 0;for(n=0;n<a;n++)if(o=r[t[n]],o){if(e===i)return o;i++}throw new Jbig2Error("can't find custom Huffman table")}function T(e,t,r,i,n){var a=[],o=void 0,s=void 0;for(o=0;o<=34;o++)s=n.readBits(4),a.push(new _([o,s,0,0]));var l=new S(a,!1);for(a.length=0,o=0;o<i;)if(s=l.decode(n),s>=32){var f=void 0,d=void 0,h=void 0;switch(s){case 32:if(0===o)throw new Jbig2Error("no previous value in symbol ID table");d=n.readBits(2)+3,f=a[o-1].prefixLength;break;case 33:d=n.readBits(3)+3,f=0;break;case 34:d=n.readBits(7)+11,f=0;break;default:throw new Jbig2Error("invalid code length in symbol ID table")}for(h=0;h<d;h++)a.push(new _([o,f,0,0])),o++}else a.push(new _([o,s,0,0])),o++;n.byteAlign();var u=new S(a,!1),c=0,m=void 0,v=void 0,g=void 0;switch(e.huffmanFS){case 0:case 1:m=U(e.huffmanFS+6);break;case 3:m=E(c,t,r),c++;break;default:throw new Jbig2Error("invalid Huffman FS selector")}switch(e.huffmanDS){case 0:case 1:case 2:v=U(e.huffmanDS+8);break;case 3:v=E(c,t,r),c++;break;default:throw new Jbig2Error("invalid Huffman DS selector")}switch(e.huffmanDT){case 0:case 1:case 2:g=U(e.huffmanDT+11);break;case 3:g=E(c,t,r),c++;break;default:throw new Jbig2Error("invalid Huffman DT selector")}if(e.refinement)throw new Jbig2Error("refinement with Huffman is not supported");return{symbolIDTable:u,tableFirstS:m,tableDeltaS:v,tableDeltaT:g}}function J(e,t,r){var i=0,n=void 0,a=void 0;switch(e.huffmanDHSelector){case 0:case 1:n=U(e.huffmanDHSelector+4);break;case 3:n=E(i,t,r),i++;break;default:throw new Jbig2Error("invalid Huffman DH selector")}switch(e.huffmanDWSelector){case 0:case 1:a=U(e.huffmanDWSelector+2);break;case 3:a=E(i,t,r),i++;break;default:throw new Jbig2Error("invalid Huffman DW selector")}var o=void 0,s=void 0;return e.bitmapSizeSelector?(o=E(i,t,r),i++):o=U(1),s=e.aggregationInstancesSelector?E(i,t,r):U(1),{tableDeltaHeight:n,tableDeltaWidth:a,tableBitmapSize:o,tableAggregateInstances:s}}function C(e,t,r){var i=[],n=void 0,a=void 0,o=void 0;for(a=0;a<r;a++){for(o=new Uint8Array(t),i.push(o),n=0;n<t;n++)o[n]=e.readBit();e.byteAlign()}return i}function L(e,t,r,i){var n={K:-1,Columns:t,Rows:r,BlackIs1:!0,EndOfBlock:i},a=new _ccitt.CCITTFaxDecoder(e,n),o=[],s=void 0,l=void 0,f=void 0,d=void 0,h=void 0,u=!1;for(l=0;l<r;l++)for(f=new Uint8Array(t),o.push(f),h=-1,s=0;s<t;s++)h<0&&(d=a.readNextChar(),-1===d&&(d=0,u=!0),h=7),f[s]=d>>h&1,h--;if(i&&!u)for(var c=5,m=0;m<c;m++)if(-1===a.readNextChar())break;return o}function H(){}return O.prototype={readBit:function(){if(this.shift<0){if(this.position>=this.end)throw new Jbig2Error("end of data while reading bit");this.currentByte=this.data[this.position++],this.shift=7}var e=this.currentByte>>this.shift&1;return this.shift--,e},readBits:function(e){var t=0,r=void 0;for(r=e-1;r>=0;r--)t|=this.readBit()<<r;return t},byteAlign:function(){this.shift=-1},next:function(){return this.position>=this.end?-1:this.data[this.position++]}},H.prototype={parseChunks:function(e){return I(e)},parse:function(e){var t=k(e),r=t.imgData,i=t.width,n=t.height;return this.width=i,this.height=n,r}},H}();exports.Jbig2Image=Jbig2Image;