"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.WorkerMessageHandler=exports.WorkerTask=void 0;var _typeof="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"===typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_slicedToArray=function(){function e(e,t){var n=[],r=!0,a=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(r=(i=s.next()).done);r=!0)if(n.push(i.value),t&&n.length===t)break}catch(u){a=!0,o=u}finally{try{!r&&s["return"]&&s["return"]()}finally{if(a)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_util=require("../shared/util"),_pdf_manager=require("./pdf_manager"),_is_node=require("../shared/is_node"),_is_node2=_interopRequireDefault(_is_node),_message_handler=require("../shared/message_handler"),_primitives=require("./primitives");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var WorkerTask=function(){function e(e){this.name=e,this.terminated=!1,this._capability=(0,_util.createPromiseCapability)()}return e.prototype={get finished(){return this._capability.promise},finish:function(){this._capability.resolve()},terminate:function(){this.terminated=!0},ensureNotTerminated:function(){if(this.terminated)throw new Error("Worker task was terminated")}},e}(),PDFWorkerStream=function(){function e(e){this._msgHandler=e,this._contentLength=null,this._fullRequestReader=null,this._rangeRequestReaders=[]}function t(e){var t=this;this._msgHandler=e,this._contentLength=null,this._isRangeSupported=!1,this._isStreamingSupported=!1;var n=this._msgHandler.sendWithStream("GetReader");this._reader=n.getReader(),this._headersReady=this._msgHandler.sendWithPromise("ReaderHeadersReady").then((function(e){t._isStreamingSupported=e.isStreamingSupported,t._isRangeSupported=e.isRangeSupported,t._contentLength=e.contentLength}))}function n(e,t,n){this._msgHandler=n,this.onProgress=null;var r=this._msgHandler.sendWithStream("GetRangeReader",{begin:e,end:t});this._reader=r.getReader()}return e.prototype={getFullReader:function(){return(0,_util.assert)(!this._fullRequestReader),this._fullRequestReader=new t(this._msgHandler),this._fullRequestReader},getRangeReader:function(e,t){var r=new n(e,t,this._msgHandler);return this._rangeRequestReaders.push(r),r},cancelAllRequests:function(e){this._fullRequestReader&&this._fullRequestReader.cancel(e);var t=this._rangeRequestReaders.slice(0);t.forEach((function(t){t.cancel(e)}))}},t.prototype={get headersReady(){return this._headersReady},get contentLength(){return this._contentLength},get isStreamingSupported(){return this._isStreamingSupported},get isRangeSupported(){return this._isRangeSupported},read:function(){return this._reader.read().then((function(e){var t=e.value,n=e.done;return n?{value:void 0,done:!0}:{value:t.buffer,done:!1}}))},cancel:function(e){this._reader.cancel(e)}},n.prototype={get isStreamingSupported(){return!1},read:function(){return this._reader.read().then((function(e){var t=e.value,n=e.done;return n?{value:void 0,done:!0}:{value:t.buffer,done:!1}}))},cancel:function(e){this._reader.cancel(e)}},e}(),WorkerMessageHandler={setup:function(e,t){var n=!1;e.on("test",(function(t){if(!n)if(n=!0,t instanceof Uint8Array){var r=255===t[0];e.postMessageTransfers=r;var a=new XMLHttpRequest,o="response"in a;try{a.responseType}catch(i){o=!1}o?e.send("test",{supportTypedArray:!0,supportTransfers:r}):e.send("test",!1)}else e.send("test",!1)})),e.on("configure",(function(e){(0,_util.setVerbosityLevel)(e.verbosity)})),e.on("GetDocRequest",(function(e){return WorkerMessageHandler.createDocumentHandler(e,t)}))},createDocumentHandler:function(e,t){var n,r=!1,a=null,o=[],i=e.apiVersion,s="2.0.943";if(i!==s)throw new Error('The API version "'+i+'" does not match the Worker version "'+s+'".');var u=e.docId,d=e.docBaseUrl,c=e.docId+"_worker",l=new _message_handler.MessageHandler(c,u,t);function f(){if(r)throw new Error("Worker was terminated")}function p(e){o.push(e)}function g(e){e.finish();var t=o.indexOf(e);o.splice(t,1)}function h(e){var t=(0,_util.createPromiseCapability)(),r=function(){Promise.all([n.ensureDoc("numPages"),n.ensureDoc("fingerprint")]).then((function(e){var n=_slicedToArray(e,2),r=n[0],a=n[1];t.resolve({numPages:r,fingerprint:a})}),a)},a=function(e){t.reject(e)};return n.ensureDoc("checkHeader",[]).then((function(){n.ensureDoc("parseStartXRef",[]).then((function(){n.ensureDoc("parse",[e]).then(r,a)}),a)}),a),t.promise}function m(e,t){var n,r=(0,_util.createPromiseCapability)(),o=e.source;if(o.data){try{n=new _pdf_manager.LocalPdfManager(u,o.data,o.password,t,d),r.resolve(n)}catch(m){r.reject(m)}return r.promise}var i,s=[];try{i=new PDFWorkerStream(l)}catch(m){return r.reject(m),r.promise}var c=i.getFullReader();c.headersReady.then((function(){if(c.isRangeSupported){var e=o.disableAutoFetch||c.isStreamingSupported;n=new _pdf_manager.NetworkPdfManager(u,i,{msgHandler:l,url:o.url,password:o.password,length:c.contentLength,disableAutoFetch:e,rangeChunkSize:o.rangeChunkSize},t,d);for(var f=0;f<s.length;f++)n.sendProgressiveData(s[f]);s=[],r.resolve(n),a=null}})).catch((function(e){r.reject(e),a=null}));var p=0,g=function(){var e=(0,_util.arraysToBytes)(s);o.length&&e.length!==o.length&&(0,_util.warn)("reported HTTP length is different from actual");try{n=new _pdf_manager.LocalPdfManager(u,e,o.password,t,d),r.resolve(n)}catch(m){r.reject(m)}s=[]},h=new Promise((function(e,t){var r=function e(r){try{if(f(),r.done)return n||g(),void(a=null);var o=r.value;p+=(0,_util.arrayByteLength)(o),c.isStreamingSupported||l.send("DocProgress",{loaded:p,total:Math.max(p,c.contentLength||0)}),n?n.sendProgressiveData(o):s.push(o),c.read().then(e,t)}catch(i){t(i)}};c.read().then(r,t)}));return h.catch((function(e){r.reject(e),a=null})),a=function(){i.cancelAllRequests("abort")},r.promise}function _(e){function t(e){f(),l.send("GetDoc",{pdfInfo:e})}function a(e){if(f(),e instanceof _util.PasswordException){var t=new WorkerTask("PasswordException: response "+e.code);p(t),l.sendWithPromise("PasswordRequest",e).then((function(e){g(t),n.updatePassword(e.password),o()})).catch(function(e){g(t),l.send("PasswordException",e)}.bind(null,e))}else e instanceof _util.InvalidPDFException?l.send("InvalidPDF",e):e instanceof _util.MissingPDFException?l.send("MissingPDF",e):e instanceof _util.UnexpectedResponseException?l.send("UnexpectedResponse",e):l.send("UnknownError",new _util.UnknownErrorException(e.message,e.toString()))}function o(){f(),h(!1).then(t,(function(e){f(),e instanceof _util.XRefParseException?(n.requestLoadedStream(),n.onLoadedStream().then((function(){f(),h(!0).then(t,a)}))):a(e)}),a)}f();var i={forceDataSchema:e.disableCreateObjectURL,maxImageSize:e.maxImageSize,disableFontFace:e.disableFontFace,nativeImageDecoderSupport:e.nativeImageDecoderSupport,ignoreErrors:e.ignoreErrors,isEvalSupported:e.isEvalSupported};m(e,i).then((function(e){if(r)throw e.terminate(),new Error("Worker was terminated");n=e,n.onLoadedStream().then((function(e){l.send("DataLoaded",{length:e.bytes.byteLength})}))})).then(o,a)}return l.postMessageTransfers=e.postMessageTransfers,l.on("GetPage",(function(e){return n.getPage(e.pageIndex).then((function(e){return Promise.all([n.ensure(e,"rotate"),n.ensure(e,"ref"),n.ensure(e,"userUnit"),n.ensure(e,"view")]).then((function(e){var t=_slicedToArray(e,4),n=t[0],r=t[1],a=t[2],o=t[3];return{rotate:n,ref:r,userUnit:a,view:o}}))}))})),l.on("GetPageIndex",(function(e){var t=new _primitives.Ref(e.ref.num,e.ref.gen),r=n.pdfDocument.catalog;return r.getPageIndex(t)})),l.on("GetDestinations",(function(e){return n.ensureCatalog("destinations")})),l.on("GetDestination",(function(e){return n.ensureCatalog("getDestination",[e.id])})),l.on("GetPageLabels",(function(e){return n.ensureCatalog("pageLabels")})),l.on("GetPageMode",(function(e){return n.ensureCatalog("pageMode")})),l.on("GetAttachments",(function(e){return n.ensureCatalog("attachments")})),l.on("GetJavaScript",(function(e){return n.ensureCatalog("javaScript")})),l.on("GetOutline",(function(e){return n.ensureCatalog("documentOutline")})),l.on("GetPermissions",(function(e){return n.ensureCatalog("permissions")})),l.on("GetMetadata",(function(e){return Promise.all([n.ensureDoc("documentInfo"),n.ensureCatalog("metadata")])})),l.on("GetData",(function(e){return n.requestLoadedStream(),n.onLoadedStream().then((function(e){return e.bytes}))})),l.on("GetStats",(function(e){return n.pdfDocument.xref.stats})),l.on("GetAnnotations",(function(e){var t=e.pageIndex,r=e.intent;return n.getPage(t).then((function(e){return e.getAnnotationsData(r)}))})),l.on("RenderPageRequest",(function(e){var t=e.pageIndex;n.getPage(t).then((function(n){var r=new WorkerTask("RenderPageRequest: page "+t);p(r);var a=t+1,o=Date.now();n.getOperatorList({handler:l,task:r,intent:e.intent,renderInteractiveForms:e.renderInteractiveForms}).then((function(e){g(r),(0,_util.info)("page="+a+" - getOperatorList: time="+(Date.now()-o)+"ms, len="+e.totalLength)}),(function(t){if(g(r),!r.terminated){l.send("UnsupportedFeature",{featureId:_util.UNSUPPORTED_FEATURES.unknown});var n,o="worker.js: while trying to getPage() and getOperatorList()";n="string"===typeof t?{message:t,stack:o}:"object"===("undefined"===typeof t?"undefined":_typeof(t))?{message:t.message||t.toString(),stack:t.stack||o}:{message:"Unknown exception type: "+("undefined"===typeof t?"undefined":_typeof(t)),stack:o},l.send("PageError",{pageNum:a,error:n,intent:e.intent})}}))}))}),this),l.on("GetTextContent",(function(e,t){var r=e.pageIndex;t.onPull=function(e){},t.onCancel=function(e){},n.getPage(r).then((function(n){var a=new WorkerTask("GetTextContent: page "+r);p(a);var o=r+1,i=Date.now();n.extractTextContent({handler:l,task:a,sink:t,normalizeWhitespace:e.normalizeWhitespace,combineTextItems:e.combineTextItems}).then((function(){g(a),(0,_util.info)("text indexing: page="+o+" - time="+(Date.now()-i)+"ms"),t.close()}),(function(e){if(g(a),!a.terminated)throw t.error(e),e}))}))})),l.on("Cleanup",(function(e){return n.cleanup()})),l.on("Terminate",(function(e){r=!0,n&&(n.terminate(),n=null),a&&a();var t=[];return o.forEach((function(e){t.push(e.finished),e.terminate()})),Promise.all(t).then((function(){l.destroy(),l=null}))})),l.on("Ready",(function(t){_(e),e=null})),c},initializeFromPort:function(e){var t=new _message_handler.MessageHandler("worker","main",e);WorkerMessageHandler.setup(t,e),t.send("ready",null)}};function isMessagePort(e){return"function"===typeof e.postMessage&&"onmessage"in e}"undefined"===typeof window&&!(0,_is_node2.default)()&&"undefined"!==typeof self&&isMessagePort(self)&&WorkerMessageHandler.initializeFromPort(self),exports.WorkerTask=WorkerTask,exports.WorkerMessageHandler=WorkerMessageHandler;