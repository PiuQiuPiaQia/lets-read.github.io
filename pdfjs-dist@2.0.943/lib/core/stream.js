"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.LZWStream=exports.StringStream=exports.StreamsSequenceStream=exports.Stream=exports.RunLengthStream=exports.PredictorStream=exports.NullStream=exports.FlateStream=exports.DecodeStream=exports.DecryptStream=exports.AsciiHexStream=exports.Ascii85Stream=void 0;var _util=require("../shared/util"),_primitives=require("./primitives");function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,r=Array(t.length);e<t.length;e++)r[e]=t[e];return r}return Array.from(t)}var Stream=function(){function t(t,e,r,i){this.bytes=t instanceof Uint8Array?t:new Uint8Array(t),this.start=e||0,this.pos=this.start,this.end=e+r||this.bytes.length,this.dict=i}return t.prototype={get length(){return this.end-this.start},get isEmpty(){return 0===this.length},getByte:function(){return this.pos>=this.end?-1:this.bytes[this.pos++]},getUint16:function(){var t=this.getByte(),e=this.getByte();return-1===t||-1===e?-1:(t<<8)+e},getInt32:function(){var t=this.getByte(),e=this.getByte(),r=this.getByte(),i=this.getByte();return(t<<24)+(e<<16)+(r<<8)+i},getBytes:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this.bytes,i=this.pos,s=this.end;if(!t){var n=r.subarray(i,s);return e?new Uint8ClampedArray(n):n}var o=i+t;o>s&&(o=s),this.pos=o;var a=r.subarray(i,o);return e?new Uint8ClampedArray(a):a},peekByte:function(){var t=this.getByte();return this.pos--,t},peekBytes:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this.getBytes(t,e);return this.pos-=r.length,r},skip:function(t){t||(t=1),this.pos+=t},reset:function(){this.pos=this.start},moveStart:function(){this.start=this.pos},makeSubStream:function(e,r,i){return new t(this.bytes.buffer,e,r,i)}},t}(),StringStream=function(){function t(t){var e=(0,_util.stringToBytes)(t);Stream.call(this,e)}return t.prototype=Stream.prototype,t}(),DecodeStream=function(){var t=new Uint8Array(0);function e(e){if(this._rawMinBufferLength=e||0,this.pos=0,this.bufferLength=0,this.eof=!1,this.buffer=t,this.minBufferLength=512,e)while(this.minBufferLength<e)this.minBufferLength*=2}return e.prototype={get isEmpty(){while(!this.eof&&0===this.bufferLength)this.readBlock();return 0===this.bufferLength},ensureBuffer:function(t){var e=this.buffer;if(t<=e.byteLength)return e;var r=this.minBufferLength;while(r<t)r*=2;var i=new Uint8Array(r);return i.set(e),this.buffer=i},getByte:function(){var t=this.pos;while(this.bufferLength<=t){if(this.eof)return-1;this.readBlock()}return this.buffer[this.pos++]},getUint16:function(){var t=this.getByte(),e=this.getByte();return-1===t||-1===e?-1:(t<<8)+e},getInt32:function(){var t=this.getByte(),e=this.getByte(),r=this.getByte(),i=this.getByte();return(t<<24)+(e<<16)+(r<<8)+i},getBytes:function(t){var e,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=this.pos;if(t){this.ensureBuffer(i+t),e=i+t;while(!this.eof&&this.bufferLength<e)this.readBlock();var s=this.bufferLength;e>s&&(e=s)}else{while(!this.eof)this.readBlock();e=this.bufferLength}this.pos=e;var n=this.buffer.subarray(i,e);return!r||n instanceof Uint8ClampedArray?n:new Uint8ClampedArray(n)},peekByte:function(){var t=this.getByte();return this.pos--,t},peekBytes:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this.getBytes(t,e);return this.pos-=r.length,r},makeSubStream:function(t,e,r){var i=t+e;while(this.bufferLength<=i&&!this.eof)this.readBlock();return new Stream(this.buffer,t,e,r)},skip:function(t){t||(t=1),this.pos+=t},reset:function(){this.pos=0},getBaseStreams:function(){return this.str&&this.str.getBaseStreams?this.str.getBaseStreams():[]}},e}(),StreamsSequenceStream=function(){function t(t){this.streams=t;for(var e=0,r=0,i=t.length;r<i;r++){var s=t[r];e+=s instanceof DecodeStream?s._rawMinBufferLength:s.length}DecodeStream.call(this,e)}return t.prototype=Object.create(DecodeStream.prototype),t.prototype.readBlock=function(){var t=this.streams;if(0!==t.length){var e=t.shift(),r=e.getBytes(),i=this.bufferLength,s=i+r.length,n=this.ensureBuffer(s);n.set(r,i),this.bufferLength=s}else this.eof=!0},t.prototype.getBaseStreams=function(){for(var t=[],e=0,r=this.streams.length;e<r;e++){var i=this.streams[e];i.getBaseStreams&&t.push.apply(t,_toConsumableArray(i.getBaseStreams()))}return t},t}(),FlateStream=function(){var t=new Int32Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),e=new Int32Array([3,4,5,6,7,8,9,10,65547,65549,65551,65553,131091,131095,131099,131103,196643,196651,196659,196667,262211,262227,262243,262259,327811,327843,327875,327907,258,258,258]),r=new Int32Array([1,2,3,4,65541,65543,131081,131085,196625,196633,262177,262193,327745,327777,393345,393409,459009,459137,524801,525057,590849,591361,657409,658433,724993,727041,794625,798721,868353,876545]),i=[new Int32Array([459008,524368,524304,524568,459024,524400,524336,590016,459016,524384,524320,589984,524288,524416,524352,590048,459012,524376,524312,589968,459028,524408,524344,590032,459020,524392,524328,59e4,524296,524424,524360,590064,459010,524372,524308,524572,459026,524404,524340,590024,459018,524388,524324,589992,524292,524420,524356,590056,459014,524380,524316,589976,459030,524412,524348,590040,459022,524396,524332,590008,524300,524428,524364,590072,459009,524370,524306,524570,459025,524402,524338,590020,459017,524386,524322,589988,524290,524418,524354,590052,459013,524378,524314,589972,459029,524410,524346,590036,459021,524394,524330,590004,524298,524426,524362,590068,459011,524374,524310,524574,459027,524406,524342,590028,459019,524390,524326,589996,524294,524422,524358,590060,459015,524382,524318,589980,459031,524414,524350,590044,459023,524398,524334,590012,524302,524430,524366,590076,459008,524369,524305,524569,459024,524401,524337,590018,459016,524385,524321,589986,524289,524417,524353,590050,459012,524377,524313,589970,459028,524409,524345,590034,459020,524393,524329,590002,524297,524425,524361,590066,459010,524373,524309,524573,459026,524405,524341,590026,459018,524389,524325,589994,524293,524421,524357,590058,459014,524381,524317,589978,459030,524413,524349,590042,459022,524397,524333,590010,524301,524429,524365,590074,459009,524371,524307,524571,459025,524403,524339,590022,459017,524387,524323,589990,524291,524419,524355,590054,459013,524379,524315,589974,459029,524411,524347,590038,459021,524395,524331,590006,524299,524427,524363,590070,459011,524375,524311,524575,459027,524407,524343,590030,459019,524391,524327,589998,524295,524423,524359,590062,459015,524383,524319,589982,459031,524415,524351,590046,459023,524399,524335,590014,524303,524431,524367,590078,459008,524368,524304,524568,459024,524400,524336,590017,459016,524384,524320,589985,524288,524416,524352,590049,459012,524376,524312,589969,459028,524408,524344,590033,459020,524392,524328,590001,524296,524424,524360,590065,459010,524372,524308,524572,459026,524404,524340,590025,459018,524388,524324,589993,524292,524420,524356,590057,459014,524380,524316,589977,459030,524412,524348,590041,459022,524396,524332,590009,524300,524428,524364,590073,459009,524370,524306,524570,459025,524402,524338,590021,459017,524386,524322,589989,524290,524418,524354,590053,459013,524378,524314,589973,459029,524410,524346,590037,459021,524394,524330,590005,524298,524426,524362,590069,459011,524374,524310,524574,459027,524406,524342,590029,459019,524390,524326,589997,524294,524422,524358,590061,459015,524382,524318,589981,459031,524414,524350,590045,459023,524398,524334,590013,524302,524430,524366,590077,459008,524369,524305,524569,459024,524401,524337,590019,459016,524385,524321,589987,524289,524417,524353,590051,459012,524377,524313,589971,459028,524409,524345,590035,459020,524393,524329,590003,524297,524425,524361,590067,459010,524373,524309,524573,459026,524405,524341,590027,459018,524389,524325,589995,524293,524421,524357,590059,459014,524381,524317,589979,459030,524413,524349,590043,459022,524397,524333,590011,524301,524429,524365,590075,459009,524371,524307,524571,459025,524403,524339,590023,459017,524387,524323,589991,524291,524419,524355,590055,459013,524379,524315,589975,459029,524411,524347,590039,459021,524395,524331,590007,524299,524427,524363,590071,459011,524375,524311,524575,459027,524407,524343,590031,459019,524391,524327,589999,524295,524423,524359,590063,459015,524383,524319,589983,459031,524415,524351,590047,459023,524399,524335,590015,524303,524431,524367,590079]),9],s=[new Int32Array([327680,327696,327688,327704,327684,327700,327692,327708,327682,327698,327690,327706,327686,327702,327694,0,327681,327697,327689,327705,327685,327701,327693,327709,327683,327699,327691,327707,327687,327703,327695,0]),5];function n(t,e){this.str=t,this.dict=t.dict;var r=t.getByte(),i=t.getByte();if(-1===r||-1===i)throw new _util.FormatError("Invalid header in flate stream: "+r+", "+i);if(8!==(15&r))throw new _util.FormatError("Unknown compression method in flate stream: "+r+", "+i);if(((r<<8)+i)%31!==0)throw new _util.FormatError("Bad FCHECK in flate stream: "+r+", "+i);if(32&i)throw new _util.FormatError("FDICT bit set in flate stream: "+r+", "+i);this.codeSize=0,this.codeBuf=0,DecodeStream.call(this,e)}return n.prototype=Object.create(DecodeStream.prototype),n.prototype.getBits=function(t){var e,r=this.str,i=this.codeSize,s=this.codeBuf;while(i<t){if(-1===(e=r.getByte()))throw new _util.FormatError("Bad encoding in flate stream");s|=e<<i,i+=8}return e=s&(1<<t)-1,this.codeBuf=s>>t,this.codeSize=i-=t,e},n.prototype.getCode=function(t){var e,r=this.str,i=t[0],s=t[1],n=this.codeSize,o=this.codeBuf;while(n<s){if(-1===(e=r.getByte()))break;o|=e<<n,n+=8}var a=i[o&(1<<s)-1],h=a>>16,f=65535&a;if(h<1||n<h)throw new _util.FormatError("Bad encoding in flate stream");return this.codeBuf=o>>h,this.codeSize=n-h,f},n.prototype.generateHuffmanTable=function(t){var e,r=t.length,i=0;for(e=0;e<r;++e)t[e]>i&&(i=t[e]);for(var s=1<<i,n=new Int32Array(s),o=1,a=0,h=2;o<=i;++o,a<<=1,h<<=1)for(var f=0;f<r;++f)if(t[f]===o){var u=0,c=a;for(e=0;e<o;++e)u=u<<1|1&c,c>>=1;for(e=u;e<s;e+=h)n[e]=o<<16|f;++a}return[n,i]},n.prototype.readBlock=function(){var n,o,a=this.str,h=this.getBits(3);if(1&h&&(this.eof=!0),h>>=1,0!==h){var f,u;if(1===h)f=i,u=s;else{if(2!==h)throw new _util.FormatError("Unknown block type in flate stream");var c,l=this.getBits(5)+257,g=this.getBits(5)+1,p=this.getBits(4)+4,y=new Uint8Array(t.length);for(c=0;c<p;++c)y[t[c]]=this.getBits(3);var d=this.generateHuffmanTable(y);o=0,c=0;var m,B,v,S=l+g,b=new Uint8Array(S);while(c<S){var w=this.getCode(d);if(16===w)m=2,B=3,v=o;else if(17===w)m=3,B=3,v=o=0;else{if(18!==w){b[c++]=o=w;continue}m=7,B=11,v=o=0}var L=this.getBits(m)+B;while(L-- >0)b[c++]=v}f=this.generateHuffmanTable(b.subarray(0,l)),u=this.generateHuffmanTable(b.subarray(l,S))}n=this.buffer;var k=n?n.length:0,x=this.bufferLength;while(1){var A=this.getCode(f);if(A<256)x+1>=k&&(n=this.ensureBuffer(x+1),k=n.length),n[x++]=A;else{if(256===A)return void(this.bufferLength=x);A-=257,A=e[A];var C=A>>16;C>0&&(C=this.getBits(C)),o=(65535&A)+C,A=this.getCode(u),A=r[A],C=A>>16,C>0&&(C=this.getBits(C));var D=(65535&A)+C;x+o>=k&&(n=this.ensureBuffer(x+o),k=n.length);for(var _=0;_<o;++_,++x)n[x]=n[x-D]}}}else{var U;if(-1===(U=a.getByte()))throw new _util.FormatError("Bad block header in flate stream");var F=U;if(-1===(U=a.getByte()))throw new _util.FormatError("Bad block header in flate stream");if(F|=U<<8,-1===(U=a.getByte()))throw new _util.FormatError("Bad block header in flate stream");var E=U;if(-1===(U=a.getByte()))throw new _util.FormatError("Bad block header in flate stream");if(E|=U<<8,E!==(65535&~F)&&(0!==F||0!==E))throw new _util.FormatError("Bad uncompressed block length in flate stream");this.codeBuf=0,this.codeSize=0;var z=this.bufferLength;n=this.ensureBuffer(z+F);var q=z+F;if(this.bufferLength=q,0===F)-1===a.peekByte()&&(this.eof=!0);else for(var P=z;P<q;++P){if(-1===(U=a.getByte())){this.eof=!0;break}n[P]=U}}},n}(),PredictorStream=function(){function t(t,e,r){if(!(0,_primitives.isDict)(r))return t;var i=this.predictor=r.get("Predictor")||1;if(i<=1)return t;if(2!==i&&(i<10||i>15))throw new _util.FormatError("Unsupported predictor: "+i);this.readBlock=2===i?this.readBlockTiff:this.readBlockPng,this.str=t,this.dict=t.dict;var s=this.colors=r.get("Colors")||1,n=this.bits=r.get("BitsPerComponent")||8,o=this.columns=r.get("Columns")||1;return this.pixBytes=s*n+7>>3,this.rowBytes=o*s*n+7>>3,DecodeStream.call(this,e),this}return t.prototype=Object.create(DecodeStream.prototype),t.prototype.readBlockTiff=function(){var t=this.rowBytes,e=this.bufferLength,r=this.ensureBuffer(e+t),i=this.bits,s=this.colors,n=this.str.getBytes(t);if(this.eof=!n.length,!this.eof){var o,a=0,h=0,f=0,u=0,c=e;if(1===i&&1===s)for(o=0;o<t;++o){var l=n[o]^a;l^=l>>1,l^=l>>2,l^=l>>4,a=(1&l)<<7,r[c++]=l}else if(8===i){for(o=0;o<s;++o)r[c++]=n[o];for(;o<t;++o)r[c]=r[c-s]+n[o],c++}else if(16===i){var g=2*s;for(o=0;o<g;++o)r[c++]=n[o];for(;o<t;o+=2){var p=((255&n[o])<<8)+(255&n[o+1])+((255&r[c-g])<<8)+(255&r[c-g+1]);r[c++]=p>>8&255,r[c++]=255&p}}else{var y=new Uint8Array(s+1),d=(1<<i)-1,m=0,B=e,v=this.columns;for(o=0;o<v;++o)for(var S=0;S<s;++S)f<i&&(a=a<<8|255&n[m++],f+=8),y[S]=y[S]+(a>>f-i)&d,f-=i,h=h<<i|y[S],u+=i,u>=8&&(r[B++]=h>>u-8&255,u-=8);u>0&&(r[B++]=(h<<8-u)+(a&(1<<8-u)-1))}this.bufferLength+=t}},t.prototype.readBlockPng=function(){var t=this.rowBytes,e=this.pixBytes,r=this.str.getByte(),i=this.str.getBytes(t);if(this.eof=!i.length,!this.eof){var s=this.bufferLength,n=this.ensureBuffer(s+t),o=n.subarray(s-t,s);0===o.length&&(o=new Uint8Array(t));var a,h,f,u=s;switch(r){case 0:for(a=0;a<t;++a)n[u++]=i[a];break;case 1:for(a=0;a<e;++a)n[u++]=i[a];for(;a<t;++a)n[u]=n[u-e]+i[a]&255,u++;break;case 2:for(a=0;a<t;++a)n[u++]=o[a]+i[a]&255;break;case 3:for(a=0;a<e;++a)n[u++]=(o[a]>>1)+i[a];for(;a<t;++a)n[u]=(o[a]+n[u-e]>>1)+i[a]&255,u++;break;case 4:for(a=0;a<e;++a)h=o[a],f=i[a],n[u++]=h+f;for(;a<t;++a){h=o[a];var c=o[a-e],l=n[u-e],g=l+h-c,p=g-l;p<0&&(p=-p);var y=g-h;y<0&&(y=-y);var d=g-c;d<0&&(d=-d),f=i[a],n[u++]=p<=y&&p<=d?l+f:y<=d?h+f:c+f}break;default:throw new _util.FormatError("Unsupported predictor: "+r)}this.bufferLength+=t}},t}(),DecryptStream=function(){function t(t,e,r){this.str=t,this.dict=t.dict,this.decrypt=r,this.nextChunk=null,this.initialized=!1,DecodeStream.call(this,e)}var e=512;return t.prototype=Object.create(DecodeStream.prototype),t.prototype.readBlock=function(){var t;if(this.initialized?t=this.nextChunk:(t=this.str.getBytes(e),this.initialized=!0),t&&0!==t.length){this.nextChunk=this.str.getBytes(e);var r=this.nextChunk&&this.nextChunk.length>0,i=this.decrypt;t=i(t,!r);var s,n=this.bufferLength,o=t.length,a=this.ensureBuffer(n+o);for(s=0;s<o;s++)a[n++]=t[s];this.bufferLength=n}else this.eof=!0},t}(),Ascii85Stream=function(){function t(t,e){this.str=t,this.dict=t.dict,this.input=new Uint8Array(5),e&&(e*=.8),DecodeStream.call(this,e)}return t.prototype=Object.create(DecodeStream.prototype),t.prototype.readBlock=function(){var t=126,e=122,r=-1,i=this.str,s=i.getByte();while((0,_util.isSpace)(s))s=i.getByte();if(s!==r&&s!==t){var n,o,a=this.bufferLength;if(s===e){for(n=this.ensureBuffer(a+4),o=0;o<4;++o)n[a+o]=0;this.bufferLength+=4}else{var h=this.input;for(h[0]=s,o=1;o<5;++o){s=i.getByte();while((0,_util.isSpace)(s))s=i.getByte();if(h[o]=s,s===r||s===t)break}if(n=this.ensureBuffer(a+o-1),this.bufferLength+=o-1,o<5){for(;o<5;++o)h[o]=117;this.eof=!0}var f=0;for(o=0;o<5;++o)f=85*f+(h[o]-33);for(o=3;o>=0;--o)n[a+o]=255&f,f>>=8}}else this.eof=!0},t}(),AsciiHexStream=function(){function t(t,e){this.str=t,this.dict=t.dict,this.firstDigit=-1,e&&(e*=.5),DecodeStream.call(this,e)}return t.prototype=Object.create(DecodeStream.prototype),t.prototype.readBlock=function(){var t=8e3,e=this.str.getBytes(t);if(e.length){for(var r=e.length+1>>1,i=this.ensureBuffer(this.bufferLength+r),s=this.bufferLength,n=this.firstDigit,o=0,a=e.length;o<a;o++){var h,f=e[o];if(f>=48&&f<=57)h=15&f;else{if(!(f>=65&&f<=70||f>=97&&f<=102)){if(62===f){this.eof=!0;break}continue}h=9+(15&f)}n<0?n=h:(i[s++]=n<<4|h,n=-1)}n>=0&&this.eof&&(i[s++]=n<<4,n=-1),this.firstDigit=n,this.bufferLength=s}else this.eof=!0},t}(),RunLengthStream=function(){function t(t,e){this.str=t,this.dict=t.dict,DecodeStream.call(this,e)}return t.prototype=Object.create(DecodeStream.prototype),t.prototype.readBlock=function(){var t=this.str.getBytes(2);if(!t||t.length<2||128===t[0])this.eof=!0;else{var e,r=this.bufferLength,i=t[0];if(i<128){if(e=this.ensureBuffer(r+i+1),e[r++]=t[1],i>0){var s=this.str.getBytes(i);e.set(s,r),r+=i}}else{i=257-i;var n=t[1];e=this.ensureBuffer(r+i+1);for(var o=0;o<i;o++)e[r++]=n}this.bufferLength=r}},t}(),LZWStream=function(){function t(t,e,r){this.str=t,this.dict=t.dict,this.cachedData=0,this.bitsCached=0;for(var i=4096,s={earlyChange:r,codeLength:9,nextCode:258,dictionaryValues:new Uint8Array(i),dictionaryLengths:new Uint16Array(i),dictionaryPrevCodes:new Uint16Array(i),currentSequence:new Uint8Array(i),currentSequenceLength:0},n=0;n<256;++n)s.dictionaryValues[n]=n,s.dictionaryLengths[n]=1;this.lzwState=s,DecodeStream.call(this,e)}return t.prototype=Object.create(DecodeStream.prototype),t.prototype.readBits=function(t){var e=this.bitsCached,r=this.cachedData;while(e<t){var i=this.str.getByte();if(-1===i)return this.eof=!0,null;r=r<<8|i,e+=8}return this.bitsCached=e-=t,this.cachedData=r,this.lastCode=null,r>>>e&(1<<t)-1},t.prototype.readBlock=function(){var t,e,r,i=512,s=2*i,n=i,o=this.lzwState;if(o){var a=o.earlyChange,h=o.nextCode,f=o.dictionaryValues,u=o.dictionaryLengths,c=o.dictionaryPrevCodes,l=o.codeLength,g=o.prevCode,p=o.currentSequence,y=o.currentSequenceLength,d=0,m=this.bufferLength,B=this.ensureBuffer(this.bufferLength+s);for(t=0;t<i;t++){var v=this.readBits(l),S=y>0;if(v<256)p[0]=v,y=1;else{if(!(v>=258)){if(256===v){l=9,h=258,y=0;continue}this.eof=!0,delete this.lzwState;break}if(v<h)for(y=u[v],e=y-1,r=v;e>=0;e--)p[e]=f[r],r=c[r];else p[y++]=p[0]}if(S&&(c[h]=g,u[h]=u[g]+1,f[h]=p[0],h++,l=h+a&h+a-1?l:0|Math.min(Math.log(h+a)/.6931471805599453+1,12)),g=v,d+=y,s<d){do{s+=n}while(s<d);B=this.ensureBuffer(this.bufferLength+s)}for(e=0;e<y;e++)B[m++]=p[e]}o.nextCode=h,o.codeLength=l,o.prevCode=g,o.currentSequenceLength=y,this.bufferLength=m}},t}(),NullStream=function(){function t(){Stream.call(this,new Uint8Array(0))}return t.prototype=Stream.prototype,t}();exports.Ascii85Stream=Ascii85Stream,exports.AsciiHexStream=AsciiHexStream,exports.DecryptStream=DecryptStream,exports.DecodeStream=DecodeStream,exports.FlateStream=FlateStream,exports.NullStream=NullStream,exports.PredictorStream=PredictorStream,exports.RunLengthStream=RunLengthStream,exports.Stream=Stream,exports.StreamsSequenceStream=StreamsSequenceStream,exports.StringStream=StringStream,exports.LZWStream=LZWStream;