"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PostScriptCompiler=exports.PostScriptEvaluator=exports.PDFFunctionFactory=exports.isPDFFunction=void 0;var _typeof="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"===typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_createClass=function(){function t(t,r){for(var e=0;e<r.length;e++){var n=r[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(r,e,n){return e&&t(r.prototype,e),n&&t(r,n),r}}(),_util=require("../shared/util"),_primitives=require("./primitives"),_ps_parser=require("./ps_parser");function _classCallCheck(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}var IsEvalSupportedCached={get value(){return(0,_util.shadow)(this,"value",(0,_util.isEvalSupported)())}},PDFFunctionFactory=function(){function t(r){var e=r.xref,n=r.isEvalSupported,i=void 0===n||n;_classCallCheck(this,t),this.xref=e,this.isEvalSupported=!1!==i}return _createClass(t,[{key:"create",value:function(t){return PDFFunction.parse({xref:this.xref,isEvalSupported:this.isEvalSupported,fn:t})}},{key:"createFromArray",value:function(t){return PDFFunction.parseArray({xref:this.xref,isEvalSupported:this.isEvalSupported,fnObj:t})}}]),t}();function toNumberArray(t){if(!Array.isArray(t))return null;for(var r=t.length,e=0;e<r;e++)if("number"!==typeof t[e]){for(var n=new Array(r),i=0;i<r;i++)n[i]=+t[i];return n}return t}var PDFFunction=function(){var t=0,r=2,e=3,n=4;return{getSampleArray:function(t,r,e,n){var i,o,a=1;for(i=0,o=t.length;i<o;i++)a*=t[i];a*=r;var p=new Array(a),s=0,u=0,c=1/(Math.pow(2,e)-1),l=n.getBytes((a*e+7)/8),h=0;for(i=0;i<a;i++){while(s<e)u<<=8,u|=l[h++],s+=8;s-=e,p[i]=(u>>s)*c,u&=(1<<s)-1}return p},getIR:function(t){var r=t.xref,e=t.isEvalSupported,n=t.fn,i=n.dict;i||(i=n);var o=[this.constructSampled,null,this.constructInterpolated,this.constructStiched,this.constructPostScript],a=i.get("FunctionType"),p=o[a];if(!p)throw new _util.FormatError("Unknown type of function");return p.call(this,{xref:r,isEvalSupported:e,fn:n,dict:i})},fromIR:function(n){var i=n.xref,o=n.isEvalSupported,a=n.IR,p=a[0];switch(p){case t:return this.constructSampledFromIR({xref:i,isEvalSupported:o,IR:a});case r:return this.constructInterpolatedFromIR({xref:i,isEvalSupported:o,IR:a});case e:return this.constructStichedFromIR({xref:i,isEvalSupported:o,IR:a});default:return this.constructPostScriptFromIR({xref:i,isEvalSupported:o,IR:a})}},parse:function(t){var r=t.xref,e=t.isEvalSupported,n=t.fn,i=this.getIR({xref:r,isEvalSupported:e,fn:n});return this.fromIR({xref:r,isEvalSupported:e,IR:i})},parseArray:function(t){var r=t.xref,e=t.isEvalSupported,n=t.fnObj;if(!Array.isArray(n))return this.parse({xref:r,isEvalSupported:e,fn:n});for(var i=[],o=0,a=n.length;o<a;o++)i.push(this.parse({xref:r,isEvalSupported:e,fn:r.fetchIfRef(n[o])}));return function(t,r,e,n){for(var o=0,a=i.length;o<a;o++)i[o](t,r,e,n+o)}},constructSampled:function(r){r.xref,r.isEvalSupported;var e=r.fn,n=r.dict;function i(t){for(var r=t.length,e=[],n=0,i=0;i<r;i+=2)e[n]=[t[i],t[i+1]],++n;return e}var o=toNumberArray(n.getArray("Domain")),a=toNumberArray(n.getArray("Range"));if(!o||!a)throw new _util.FormatError("No domain or range");var p=o.length/2,s=a.length/2;o=i(o),a=i(a);var u=toNumberArray(n.getArray("Size")),c=n.get("BitsPerSample"),l=n.get("Order")||1;1!==l&&(0,_util.info)("No support for cubic spline interpolation: "+l);var h=toNumberArray(n.getArray("Encode"));if(h)h=i(h);else{h=[];for(var f=0;f<p;++f)h.push([0,u[f]-1])}var m=toNumberArray(n.getArray("Decode"));m=m?i(m):a;var v=this.getSampleArray(u,s,c,e);return[t,p,o,h,m,v,u,s,Math.pow(2,c)-1,a]},constructSampledFromIR:function(t){t.xref,t.isEvalSupported;var r=t.IR;function e(t,r,e,n,i){return n+(i-n)/(e-r)*(t-r)}return function(t,n,i,o){var a,p,s=r[1],u=r[2],c=r[3],l=r[4],h=r[5],f=r[6],m=r[7],v=r[9],b=1<<s,y=new Float64Array(b),d=new Uint32Array(b);for(p=0;p<b;p++)y[p]=1;var g=m,x=1;for(a=0;a<s;++a){var k=u[a][0],S=u[a][1],w=Math.min(Math.max(t[n+a],k),S),E=e(w,k,S,c[a][0],c[a][1]),F=f[a];E=Math.min(Math.max(E,0),F-1);var A=E<F-1?Math.floor(E):E-1,_=A+1-E,P=E-A,M=A*g,I=M+g;for(p=0;p<b;p++)p&x?(y[p]*=P,d[p]+=I):(y[p]*=_,d[p]+=M);g*=F,x<<=1}for(p=0;p<m;++p){var R=0;for(a=0;a<b;a++)R+=h[d[a]+p]*y[a];R=e(R,0,1,l[p][0],l[p][1]),i[o+p]=Math.min(Math.max(R,v[p][0]),v[p][1])}}},constructInterpolated:function(t){t.xref,t.isEvalSupported,t.fn;for(var e=t.dict,n=toNumberArray(e.getArray("C0"))||[0],i=toNumberArray(e.getArray("C1"))||[1],o=e.get("N"),a=n.length,p=[],s=0;s<a;++s)p.push(i[s]-n[s]);return[r,n,p,o]},constructInterpolatedFromIR:function(t){t.xref,t.isEvalSupported;var r=t.IR,e=r[1],n=r[2],i=r[3],o=n.length;return function(t,r,a,p){for(var s=1===i?t[r]:Math.pow(t[r],i),u=0;u<o;++u)a[p+u]=e[u]+s*n[u]}},constructStiched:function(t){var r=t.xref,n=t.isEvalSupported,i=(t.fn,t.dict),o=toNumberArray(i.getArray("Domain"));if(!o)throw new _util.FormatError("No domain");var a=o.length/2;if(1!==a)throw new _util.FormatError("Bad domain for stiched function");for(var p=i.get("Functions"),s=[],u=0,c=p.length;u<c;++u)s.push(this.parse({xref:r,isEvalSupported:n,fn:r.fetchIfRef(p[u])}));var l=toNumberArray(i.getArray("Bounds")),h=toNumberArray(i.getArray("Encode"));return[e,o,l,h,s]},constructStichedFromIR:function(t){t.xref,t.isEvalSupported;var r=t.IR,e=r[1],n=r[2],i=r[3],o=r[4],a=new Float32Array(1);return function(t,r,p,s){for(var u=function(t,r,e){return t>e?t=e:t<r&&(t=r),t},c=u(t[r],e[0],e[1]),l=0,h=n.length;l<h;++l)if(c<n[l])break;var f=e[0];l>0&&(f=n[l-1]);var m=e[1];l<n.length&&(m=n[l]);var v=i[2*l],b=i[2*l+1];a[0]=f===m?v:v+(c-f)*(b-v)/(m-f),o[l](a,0,p,s)}},constructPostScript:function(t){t.xref,t.isEvalSupported;var r=t.fn,e=t.dict,i=toNumberArray(e.getArray("Domain")),o=toNumberArray(e.getArray("Range"));if(!i)throw new _util.FormatError("No domain.");if(!o)throw new _util.FormatError("No range.");var a=new _ps_parser.PostScriptLexer(r),p=new _ps_parser.PostScriptParser(a),s=p.parse();return[n,i,o,s]},constructPostScriptFromIR:function(t){t.xref;var r=t.isEvalSupported,e=t.IR,n=e[1],i=e[2],o=e[3];if(r&&IsEvalSupportedCached.value){var a=(new PostScriptCompiler).compile(o,n,i);if(a)return new Function("src","srcOffset","dest","destOffset",a)}(0,_util.info)("Unable to compile PS function");var p=i.length>>1,s=n.length>>1,u=new PostScriptEvaluator(o),c=Object.create(null),l=8192,h=l,f=new Float32Array(s);return function(t,r,e,n){var o,a,l="",m=f;for(o=0;o<s;o++)a=t[r+o],m[o]=a,l+=a+"_";var v=c[l];if(void 0===v){var b=new Float32Array(p),y=u.execute(m),d=y.length-p;for(o=0;o<p;o++){a=y[d+o];var g=i[2*o];a<g?a=g:(g=i[2*o+1],a>g&&(a=g)),b[o]=a}h>0&&(h--,c[l]=b),e.set(b,n)}else e.set(v,n)}}}}();function isPDFFunction(t){var r;if("object"!==("undefined"===typeof t?"undefined":_typeof(t)))return!1;if((0,_primitives.isDict)(t))r=t;else{if(!(0,_primitives.isStream)(t))return!1;r=t.dict}return r.has("FunctionType")}var PostScriptStack=function(){var t=100;function r(t){this.stack=t?Array.prototype.slice.call(t,0):[]}return r.prototype={push:function(r){if(this.stack.length>=t)throw new Error("PostScript function stack overflow.");this.stack.push(r)},pop:function(){if(this.stack.length<=0)throw new Error("PostScript function stack underflow.");return this.stack.pop()},copy:function(r){if(this.stack.length+r>=t)throw new Error("PostScript function stack overflow.");for(var e=this.stack,n=e.length-r,i=r-1;i>=0;i--,n++)e.push(e[n])},index:function(t){this.push(this.stack[this.stack.length-t-1])},roll:function(t,r){var e,n,i,o=this.stack,a=o.length-t,p=o.length-1,s=a+(r-Math.floor(r/t)*t);for(e=a,n=p;e<n;e++,n--)i=o[e],o[e]=o[n],o[n]=i;for(e=a,n=s-1;e<n;e++,n--)i=o[e],o[e]=o[n],o[n]=i;for(e=s,n=p;e<n;e++,n--)i=o[e],o[e]=o[n],o[n]=i}},r}(),PostScriptEvaluator=function(){function t(t){this.operators=t}return t.prototype={execute:function(t){var r,e,n,i=new PostScriptStack(t),o=0,a=this.operators,p=a.length;while(o<p)if(r=a[o++],"number"!==typeof r)switch(r){case"jz":n=i.pop(),e=i.pop(),e||(o=n);break;case"j":e=i.pop(),o=e;break;case"abs":e=i.pop(),i.push(Math.abs(e));break;case"add":n=i.pop(),e=i.pop(),i.push(e+n);break;case"and":n=i.pop(),e=i.pop(),(0,_util.isBool)(e)&&(0,_util.isBool)(n)?i.push(e&&n):i.push(e&n);break;case"atan":e=i.pop(),i.push(Math.atan(e));break;case"bitshift":n=i.pop(),e=i.pop(),e>0?i.push(e<<n):i.push(e>>n);break;case"ceiling":e=i.pop(),i.push(Math.ceil(e));break;case"copy":e=i.pop(),i.copy(e);break;case"cos":e=i.pop(),i.push(Math.cos(e));break;case"cvi":e=0|i.pop(),i.push(e);break;case"cvr":break;case"div":n=i.pop(),e=i.pop(),i.push(e/n);break;case"dup":i.copy(1);break;case"eq":n=i.pop(),e=i.pop(),i.push(e===n);break;case"exch":i.roll(2,1);break;case"exp":n=i.pop(),e=i.pop(),i.push(Math.pow(e,n));break;case"false":i.push(!1);break;case"floor":e=i.pop(),i.push(Math.floor(e));break;case"ge":n=i.pop(),e=i.pop(),i.push(e>=n);break;case"gt":n=i.pop(),e=i.pop(),i.push(e>n);break;case"idiv":n=i.pop(),e=i.pop(),i.push(e/n|0);break;case"index":e=i.pop(),i.index(e);break;case"le":n=i.pop(),e=i.pop(),i.push(e<=n);break;case"ln":e=i.pop(),i.push(Math.log(e));break;case"log":e=i.pop(),i.push(Math.log(e)/Math.LN10);break;case"lt":n=i.pop(),e=i.pop(),i.push(e<n);break;case"mod":n=i.pop(),e=i.pop(),i.push(e%n);break;case"mul":n=i.pop(),e=i.pop(),i.push(e*n);break;case"ne":n=i.pop(),e=i.pop(),i.push(e!==n);break;case"neg":e=i.pop(),i.push(-e);break;case"not":e=i.pop(),(0,_util.isBool)(e)?i.push(!e):i.push(~e);break;case"or":n=i.pop(),e=i.pop(),(0,_util.isBool)(e)&&(0,_util.isBool)(n)?i.push(e||n):i.push(e|n);break;case"pop":i.pop();break;case"roll":n=i.pop(),e=i.pop(),i.roll(e,n);break;case"round":e=i.pop(),i.push(Math.round(e));break;case"sin":e=i.pop(),i.push(Math.sin(e));break;case"sqrt":e=i.pop(),i.push(Math.sqrt(e));break;case"sub":n=i.pop(),e=i.pop(),i.push(e-n);break;case"true":i.push(!0);break;case"truncate":e=i.pop(),e=e<0?Math.ceil(e):Math.floor(e),i.push(e);break;case"xor":n=i.pop(),e=i.pop(),(0,_util.isBool)(e)&&(0,_util.isBool)(n)?i.push(e!==n):i.push(e^n);break;default:throw new _util.FormatError("Unknown operator "+r)}else i.push(r);return i.stack}},t}(),PostScriptCompiler=function(){function t(t){this.type=t}function r(r,e,n){t.call(this,"args"),this.index=r,this.min=e,this.max=n}function e(r){t.call(this,"literal"),this.number=r,this.min=r,this.max=r}function n(r,e,n,i,o){t.call(this,"binary"),this.op=r,this.arg1=e,this.arg2=n,this.min=i,this.max=o}function i(r,e){t.call(this,"max"),this.arg=r,this.min=r.min,this.max=e}function o(r,e,n){t.call(this,"var"),this.index=r,this.min=e,this.max=n}function a(r,e){t.call(this,"definition"),this.variable=r,this.arg=e}function p(){this.parts=[]}function s(t,r){return"literal"===r.type&&0===r.number?t:"literal"===t.type&&0===t.number?r:"literal"===r.type&&"literal"===t.type?new e(t.number+r.number):new n("+",t,r,t.min+r.min,t.max+r.max)}function u(t,r){if("literal"===r.type){if(0===r.number)return new e(0);if(1===r.number)return t;if("literal"===t.type)return new e(t.number*r.number)}if("literal"===t.type){if(0===t.number)return new e(0);if(1===t.number)return r}var i=Math.min(t.min*r.min,t.min*r.max,t.max*r.min,t.max*r.max),o=Math.max(t.min*r.min,t.min*r.max,t.max*r.min,t.max*r.max);return new n("*",t,r,i,o)}function c(t,r){if("literal"===r.type){if(0===r.number)return t;if("literal"===t.type)return new e(t.number-r.number)}return"binary"===r.type&&"-"===r.op&&"literal"===t.type&&1===t.number&&"literal"===r.arg1.type&&1===r.arg1.number?r.arg2:new n("-",t,r,t.min-r.max,t.max-r.min)}function l(t,r){return t.min>=r?new e(r):t.max<=r?t:new i(t,r)}function h(){}return t.prototype.visit=function(t){(0,_util.unreachable)("abstract method")},r.prototype=Object.create(t.prototype),r.prototype.visit=function(t){t.visitArgument(this)},e.prototype=Object.create(t.prototype),e.prototype.visit=function(t){t.visitLiteral(this)},n.prototype=Object.create(t.prototype),n.prototype.visit=function(t){t.visitBinaryOperation(this)},i.prototype=Object.create(t.prototype),i.prototype.visit=function(t){t.visitMin(this)},o.prototype=Object.create(t.prototype),o.prototype.visit=function(t){t.visitVariable(this)},a.prototype=Object.create(t.prototype),a.prototype.visit=function(t){t.visitVariableDefinition(this)},p.prototype={visitArgument:function(t){this.parts.push("Math.max(",t.min,", Math.min(",t.max,", src[srcOffset + ",t.index,"]))")},visitVariable:function(t){this.parts.push("v",t.index)},visitLiteral:function(t){this.parts.push(t.number)},visitBinaryOperation:function(t){this.parts.push("("),t.arg1.visit(this),this.parts.push(" ",t.op," "),t.arg2.visit(this),this.parts.push(")")},visitVariableDefinition:function(t){this.parts.push("var "),t.variable.visit(this),this.parts.push(" = "),t.arg.visit(this),this.parts.push(";")},visitMin:function(t){this.parts.push("Math.min("),t.arg.visit(this),this.parts.push(", ",t.max,")")},toString:function(){return this.parts.join("")}},h.prototype={compile:function(t,n,i){var h,f,m,v,b,y,d,g,x,k,S=[],w=[],E=n.length>>1,F=i.length>>1,A=0;for(h=0;h<E;h++)S.push(new r(h,n[2*h],n[2*h+1]));for(h=0,f=t.length;h<f;h++)if(k=t[h],"number"!==typeof k)switch(k){case"add":if(S.length<2)return null;y=S.pop(),b=S.pop(),S.push(s(b,y));break;case"cvr":if(S.length<1)return null;break;case"mul":if(S.length<2)return null;y=S.pop(),b=S.pop(),S.push(u(b,y));break;case"sub":if(S.length<2)return null;y=S.pop(),b=S.pop(),S.push(c(b,y));break;case"exch":if(S.length<2)return null;d=S.pop(),g=S.pop(),S.push(d,g);break;case"pop":if(S.length<1)return null;S.pop();break;case"index":if(S.length<1)return null;if(b=S.pop(),"literal"!==b.type)return null;if(m=b.number,m<0||!Number.isInteger(m)||S.length<m)return null;if(d=S[S.length-m-1],"literal"===d.type||"var"===d.type){S.push(d);break}x=new o(A++,d.min,d.max),S[S.length-m-1]=x,S.push(x),w.push(new a(x,d));break;case"dup":if(S.length<1)return null;if("number"===typeof t[h+1]&&"gt"===t[h+2]&&t[h+3]===h+7&&"jz"===t[h+4]&&"pop"===t[h+5]&&t[h+6]===t[h+1]){b=S.pop(),S.push(l(b,t[h+1])),h+=6;break}if(d=S[S.length-1],"literal"===d.type||"var"===d.type){S.push(d);break}x=new o(A++,d.min,d.max),S[S.length-1]=x,S.push(x),w.push(new a(x,d));break;case"roll":if(S.length<2)return null;if(y=S.pop(),b=S.pop(),"literal"!==y.type||"literal"!==b.type)return null;if(v=y.number,m=b.number,m<=0||!Number.isInteger(m)||!Number.isInteger(v)||S.length<m)return null;if(v=(v%m+m)%m,0===v)break;Array.prototype.push.apply(S,S.splice(S.length-m,m-v));break;default:return null}else S.push(new e(k));if(S.length!==F)return null;var _=[];return w.forEach((function(t){var r=new p;t.visit(r),_.push(r.toString())})),S.forEach((function(t,r){var e=new p;t.visit(e);var n=i[2*r],o=i[2*r+1],a=[e.toString()];n>t.min&&(a.unshift("Math.max(",n,", "),a.push(")")),o<t.max&&(a.unshift("Math.min(",o,", "),a.push(")")),a.unshift("dest[destOffset + ",r,"] = "),a.push(";"),_.push(a.join(""))})),_.join("\n")}},h}();exports.isPDFFunction=isPDFFunction,exports.PDFFunctionFactory=PDFFunctionFactory,exports.PostScriptEvaluator=PostScriptEvaluator,exports.PostScriptCompiler=PostScriptCompiler;