"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PDFImage=void 0;var _slicedToArray=function(){function e(e,t){var i=[],r=!0,a=!1,s=void 0;try{for(var n,o=e[Symbol.iterator]();!(r=(n=o.next()).done);r=!0)if(i.push(n.value),t&&i.length===t)break}catch(h){a=!0,s=h}finally{try{!r&&o["return"]&&o["return"]()}finally{if(a)throw s}}return i}return function(t,i){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_util=require("../shared/util"),_primitives=require("./primitives"),_colorspace=require("./colorspace"),_stream=require("./stream"),_jpeg_stream=require("./jpeg_stream"),_jpx=require("./jpx"),PDFImage=function(){function e(e,t){return t&&t.canDecode(e)?t.decode(e).catch((function(t){return(0,_util.warn)("Native image decoding failed -- trying to recover: "+(t&&t.message)),e})):Promise.resolve(e)}function t(e,t,i,r){return e=t+e*i,e<0?0:e>r?r:e}function i(e,t,i,r,a,s){var n,o,h,m,d=a*s,c=t<=8?new Uint8Array(d):t<=16?new Uint16Array(d):new Uint32Array(d),l=i/a,g=r/s,f=0,u=new Uint16Array(a),p=i;for(n=0;n<a;n++)u[n]=Math.floor(n*l);for(n=0;n<s;n++)for(h=Math.floor(n*g)*p,o=0;o<a;o++)m=h+u[o],c[f++]=e[m];return c}function r(e){var t=e.xref,i=e.res,a=e.image,s=e.isInline,n=void 0!==s&&s,o=e.smask,h=void 0===o?null:o,m=e.mask,d=void 0===m?null:m,c=e.isMask,l=void 0!==c&&c,g=e.pdfFunctionFactory;this.image=a;var f=a.dict,u=f.get("Filter");if((0,_primitives.isName)(u))switch(u.name){case"JPXDecode":var p=new _jpx.JpxImage;p.parseImageProperties(a.stream),a.stream.reset(),a.width=p.width,a.height=p.height,a.bitsPerComponent=p.bitsPerComponent,a.numComps=p.componentsCount;break;case"JBIG2Decode":a.bitsPerComponent=1,a.numComps=1;break}var v=f.get("Width","W"),w=f.get("Height","H");if(Number.isInteger(a.width)&&a.width>0&&Number.isInteger(a.height)&&a.height>0&&(a.width!==v||a.height!==w)&&((0,_util.warn)("PDFImage - using the Width/Height of the image data, rather than the image dictionary."),v=a.width,w=a.height),v<1||w<1)throw new _util.FormatError("Invalid image width: "+v+" or height: "+w);this.width=v,this.height=w,this.interpolate=f.get("Interpolate","I")||!1,this.imageMask=f.get("ImageMask","IM")||!1,this.matte=f.get("Matte")||!1;var y=a.bitsPerComponent;if(!y&&(y=f.get("BitsPerComponent","BPC"),!y)){if(!this.imageMask)throw new _util.FormatError("Bits per component missing in image: "+this.imageMask);y=1}if(this.bpc=y,!this.imageMask){var k=f.get("ColorSpace","CS");if(!k)switch((0,_util.info)("JPX images (which do not require color spaces)"),a.numComps){case 1:k=_primitives.Name.get("DeviceGray");break;case 3:k=_primitives.Name.get("DeviceRGB");break;case 4:k=_primitives.Name.get("DeviceCMYK");break;default:throw new Error("JPX images with "+a.numComps+" color components not supported.")}var _=n?i:null;this.colorSpace=_colorspace.ColorSpace.parse(k,t,_,g),this.numComps=this.colorSpace.numComps}if(this.decode=f.getArray("Decode","D"),this.needsDecode=!1,this.decode&&(this.colorSpace&&!this.colorSpace.isDefaultDecode(this.decode)||l&&!_colorspace.ColorSpace.isDefaultDecode(this.decode,1))){this.needsDecode=!0;var C=(1<<y)-1;this.decodeCoefficients=[],this.decodeAddends=[];for(var I=0,P=0;I<this.decode.length;I+=2,++P){var D=this.decode[I],A=this.decode[I+1];this.decodeCoefficients[P]=A-D,this.decodeAddends[P]=C*D}}if(h)this.smask=new r({xref:t,res:i,image:h,isInline:n,pdfFunctionFactory:g});else if(d)if((0,_primitives.isStream)(d)){var b=d.dict,B=b.get("ImageMask","IM");B?this.mask=new r({xref:t,res:i,image:d,isInline:n,isMask:!0,pdfFunctionFactory:g}):(0,_util.warn)("Ignoring /Mask in image without /ImageMask.")}else this.mask=d}return r.buildImage=function(t){t.handler;var i,a,s=t.xref,n=t.res,o=t.image,h=t.isInline,m=void 0!==h&&h,d=t.nativeDecoder,c=void 0===d?null:d,l=t.pdfFunctionFactory,g=e(o,c),f=o.dict.get("SMask"),u=o.dict.get("Mask");return f?(i=e(f,c),a=Promise.resolve(null)):(i=Promise.resolve(null),u?(0,_primitives.isStream)(u)?a=e(u,c):Array.isArray(u)?a=Promise.resolve(u):((0,_util.warn)("Unsupported mask format."),a=Promise.resolve(null)):a=Promise.resolve(null)),Promise.all([g,i,a]).then((function(e){var t=_slicedToArray(e,3),i=t[0],a=t[1],o=t[2];return new r({xref:s,res:n,image:i,isInline:m,smask:a,mask:o,pdfFunctionFactory:l})}))},r.createMask=function(e){var t,i,r=e.imgArray,a=e.width,s=e.height,n=e.imageIsFromDecodeStream,o=e.inverseDecode,h=(a+7>>3)*s,m=r.byteLength,d=h===m;if(!n||o&&!d)if(o)for(t=new Uint8ClampedArray(h),t.set(r),i=m;i<h;i++)t[i]=255;else t=new Uint8ClampedArray(m),t.set(r);else t=r;if(o)for(i=0;i<m;i++)t[i]^=255;return{data:t,width:a,height:s}},r.prototype={get drawWidth(){return Math.max(this.width,this.smask&&this.smask.width||0,this.mask&&this.mask.width||0)},get drawHeight(){return Math.max(this.height,this.smask&&this.smask.height||0,this.mask&&this.mask.height||0)},decodeBuffer:function(e){var i,r,a=this.bpc,s=this.numComps,n=this.decodeAddends,o=this.decodeCoefficients,h=(1<<a)-1;if(1!==a){var m=0;for(i=0,r=this.width*this.height;i<r;i++)for(var d=0;d<s;d++)e[m]=t(e[m],n[d],o[d],h),m++}else for(i=0,r=e.length;i<r;i++)e[i]=+!e[i]},getComponents:function(e){var t=this.bpc;if(8===t)return e;var i,r,a=this.width,s=this.height,n=this.numComps,o=a*s*n,h=0,m=t<=8?new Uint8Array(o):t<=16?new Uint16Array(o):new Uint32Array(o),d=a*n,c=(1<<t)-1,l=0;if(1===t)for(var g,f,u,p=0;p<s;p++){f=l+(-8&d),u=l+d;while(l<f)r=e[h++],m[l]=r>>7&1,m[l+1]=r>>6&1,m[l+2]=r>>5&1,m[l+3]=r>>4&1,m[l+4]=r>>3&1,m[l+5]=r>>2&1,m[l+6]=r>>1&1,m[l+7]=1&r,l+=8;if(l<u){r=e[h++],g=128;while(l<u)m[l++]=+!!(r&g),g>>=1}}else{var v=0;for(r=0,l=0,i=o;l<i;++l){l%d===0&&(r=0,v=0);while(v<t)r=r<<8|e[h++],v+=8;var w=v-t,y=r>>w;m[l]=y<0?0:y>c?c:y,r&=(1<<w)-1,v=w}}return m},fillOpacity:function(e,t,a,s,n){var o,h,m,d,c,l,g=this.smask,f=this.mask;if(g)h=g.width,m=g.height,o=new Uint8ClampedArray(h*m),g.fillGrayBuffer(o),h===t&&m===a||(o=i(o,g.bpc,h,m,t,a));else if(f)if(f instanceof r){for(h=f.width,m=f.height,o=new Uint8ClampedArray(h*m),f.numComps=1,f.fillGrayBuffer(o),d=0,c=h*m;d<c;++d)o[d]=255-o[d];h===t&&m===a||(o=i(o,f.bpc,h,m,t,a))}else{if(!Array.isArray(f))throw new _util.FormatError("Unknown mask format.");o=new Uint8ClampedArray(t*a);var u=this.numComps;for(d=0,c=t*a;d<c;++d){var p=0,v=d*u;for(l=0;l<u;++l){var w=n[v+l],y=2*l;if(w<f[y]||w>f[y+1]){p=255;break}}o[d]=p}}if(o)for(d=0,l=3,c=t*s;d<c;++d,l+=4)e[l]=o[d];else for(d=0,l=3,c=t*s;d<c;++d,l+=4)e[l]=255},undoPreblend:function(e,t,i){var r=this.smask&&this.smask.matte;if(r)for(var a=this.colorSpace.getRgb(r,0),s=a[0],n=a[1],o=a[2],h=t*i*4,m=0;m<h;m+=4){var d=e[m+3];if(0!==d){var c=255/d;e[m]=(e[m]-s)*c+s,e[m+1]=(e[m+1]-n)*c+n,e[m+2]=(e[m+2]-o)*c+o}else e[m]=255,e[m+1]=255,e[m+2]=255}},createImageData:function(){var e,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=this.drawWidth,r=this.drawHeight,a={width:i,height:r,kind:0,data:null},s=this.numComps,n=this.width,o=this.height,h=this.bpc,m=n*s*h+7>>3;if(!t){var d;if("DeviceGray"===this.colorSpace.name&&1===h?d=_util.ImageKind.GRAYSCALE_1BPP:"DeviceRGB"!==this.colorSpace.name||8!==h||this.needsDecode||(d=_util.ImageKind.RGB_24BPP),d&&!this.smask&&!this.mask&&i===n&&r===o){if(a.kind=d,e=this.getImageBytes(o*m),this.image instanceof _stream.DecodeStream)a.data=e;else{var c=new Uint8ClampedArray(e.length);c.set(e),a.data=c}if(this.needsDecode){(0,_util.assert)(d===_util.ImageKind.GRAYSCALE_1BPP,"PDFImage.createImageData: The image must be grayscale.");for(var l=a.data,g=0,f=l.length;g<f;g++)l[g]^=255}return a}if(this.image instanceof _jpeg_stream.JpegStream&&!this.smask&&!this.mask){var u=o*m;switch(this.colorSpace.name){case"DeviceGray":u*=3;case"DeviceRGB":case"DeviceCMYK":return a.kind=_util.ImageKind.RGB_24BPP,a.data=this.getImageBytes(u,i,r,!0),a}}}e=this.getImageBytes(o*m);var p,v,w=0|e.length/m*r/o,y=this.getComponents(e);return t||this.smask||this.mask?(a.kind=_util.ImageKind.RGBA_32BPP,a.data=new Uint8ClampedArray(i*r*4),p=1,v=!0,this.fillOpacity(a.data,i,r,w,y)):(a.kind=_util.ImageKind.RGB_24BPP,a.data=new Uint8ClampedArray(i*r*3),p=0,v=!1),this.needsDecode&&this.decodeBuffer(y),this.colorSpace.fillRgb(a.data,n,o,i,r,w,h,y,p),v&&this.undoPreblend(a.data,i,w),a},fillGrayBuffer:function(e){var t=this.numComps;if(1!==t)throw new _util.FormatError("Reading gray scale from a color image: "+t);var i,r,a=this.width,s=this.height,n=this.bpc,o=a*t*n+7>>3,h=this.getImageBytes(s*o),m=this.getComponents(h);if(1!==n){this.needsDecode&&this.decodeBuffer(m),r=a*s;var d=255/((1<<n)-1);for(i=0;i<r;++i)e[i]=d*m[i]}else if(r=a*s,this.needsDecode)for(i=0;i<r;++i)e[i]=m[i]-1&255;else for(i=0;i<r;++i)e[i]=255&-m[i]},getImageBytes:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return this.image.reset(),this.image.drawWidth=t||this.width,this.image.drawHeight=i||this.height,this.image.forceRGB=!!r,this.image.getBytes(e,!0)}},r}();exports.PDFImage=PDFImage;