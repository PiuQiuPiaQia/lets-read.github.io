"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ChunkedStreamManager=exports.ChunkedStream=void 0;var _util=require("../shared/util"),ChunkedStream=function(){function t(t,e,s){this.bytes=new Uint8Array(t),this.start=0,this.pos=0,this.end=t,this.chunkSize=e,this.loadedChunks=[],this.numChunksLoaded=0,this.numChunks=Math.ceil(t/e),this.manager=s,this.progressiveDataLength=0,this.lastSuccessfulEnsureByteChunk=-1}return t.prototype={getMissingChunks:function(){for(var t=[],e=0,s=this.numChunks;e<s;++e)this.loadedChunks[e]||t.push(e);return t},getBaseStreams:function(){return[this]},allChunksLoaded:function(){return this.numChunksLoaded===this.numChunks},onReceiveData:function(t,e){var s=t+e.byteLength;if(t%this.chunkSize!==0)throw new Error("Bad begin offset: "+t);var n=this.bytes.length;if(s%this.chunkSize!==0&&s!==n)throw new Error("Bad end offset: "+s);this.bytes.set(new Uint8Array(e),t);var r,i=this.chunkSize,h=Math.floor(t/i),u=Math.floor((s-1)/i)+1;for(r=h;r<u;++r)this.loadedChunks[r]||(this.loadedChunks[r]=!0,++this.numChunksLoaded)},onReceiveProgressiveData:function(t){var e=this.progressiveDataLength,s=Math.floor(e/this.chunkSize);this.bytes.set(new Uint8Array(t),e),e+=t.byteLength,this.progressiveDataLength=e;var n,r=e>=this.end?this.numChunks:Math.floor(e/this.chunkSize);for(n=s;n<r;++n)this.loadedChunks[n]||(this.loadedChunks[n]=!0,++this.numChunksLoaded)},ensureByte:function(t){var e=Math.floor(t/this.chunkSize);if(e!==this.lastSuccessfulEnsureByteChunk){if(!this.loadedChunks[e])throw new _util.MissingDataException(t,t+1);this.lastSuccessfulEnsureByteChunk=e}},ensureRange:function(t,e){if(!(t>=e)&&!(e<=this.progressiveDataLength))for(var s=this.chunkSize,n=Math.floor(t/s),r=Math.floor((e-1)/s)+1,i=n;i<r;++i)if(!this.loadedChunks[i])throw new _util.MissingDataException(t,e)},nextEmptyChunk:function(t){for(var e,s=this.numChunks,n=0;n<s;++n)if(e=(t+n)%s,!this.loadedChunks[e])return e;return null},hasChunk:function(t){return!!this.loadedChunks[t]},get length(){return this.end-this.start},get isEmpty(){return 0===this.length},getByte:function(){var t=this.pos;return t>=this.end?-1:(this.ensureByte(t),this.bytes[this.pos++])},getUint16:function(){var t=this.getByte(),e=this.getByte();return-1===t||-1===e?-1:(t<<8)+e},getInt32:function(){var t=this.getByte(),e=this.getByte(),s=this.getByte(),n=this.getByte();return(t<<24)+(e<<16)+(s<<8)+n},getBytes:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=this.bytes,n=this.pos,r=this.end;if(!t){this.ensureRange(n,r);var i=s.subarray(n,r);return e?new Uint8ClampedArray(i):i}var h=n+t;h>r&&(h=r),this.ensureRange(n,h),this.pos=h;var u=s.subarray(n,h);return e?new Uint8ClampedArray(u):u},peekByte:function(){var t=this.getByte();return this.pos--,t},peekBytes:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=this.getBytes(t,e);return this.pos-=s.length,s},getByteRange:function(t,e){return this.ensureRange(t,e),this.bytes.subarray(t,e)},skip:function(t){t||(t=1),this.pos+=t},reset:function(){this.pos=this.start},moveStart:function(){this.start=this.pos},makeSubStream:function(t,e,s){function n(){}this.ensureRange(t,t+e),n.prototype=Object.create(this),n.prototype.getMissingChunks=function(){for(var t=this.chunkSize,e=Math.floor(this.start/t),s=Math.floor((this.end-1)/t)+1,n=[],r=e;r<s;++r)this.loadedChunks[r]||n.push(r);return n};var r=new n;return r.pos=r.start=t,r.end=t+e||this.end,r.dict=s,r}},t}(),ChunkedStreamManager=function(){function t(t,e){var s=e.rangeChunkSize,n=e.length;this.stream=new ChunkedStream(n,s,this),this.length=n,this.chunkSize=s,this.pdfNetworkStream=t,this.url=e.url,this.disableAutoFetch=e.disableAutoFetch,this.msgHandler=e.msgHandler,this.currRequestId=0,this.chunksNeededByRequest=Object.create(null),this.requestsByChunk=Object.create(null),this.promisesByRequest=Object.create(null),this.progressiveDataLength=0,this.aborted=!1,this._loadedStreamCapability=(0,_util.createPromiseCapability)()}return t.prototype={onLoadedStream:function(){return this._loadedStreamCapability.promise},sendRequest:function(t,e){var s=this,n=this.pdfNetworkStream.getRangeReader(t,e);n.isStreamingSupported||(n.onProgress=this.onProgress.bind(this));var r=[],i=0,h=this,u=new Promise((function(t,e){var s=function s(u){try{if(!u.done){var a=u.value;return r.push(a),i+=(0,_util.arrayByteLength)(a),n.isStreamingSupported&&h.onProgress({loaded:i}),void n.read().then(s,e)}var o=(0,_util.arraysToBytes)(r);r=null,t(o)}catch(d){e(d)}};n.read().then(s,e)}));u.then((function(e){s.aborted||s.onReceiveData({chunk:e,begin:t})}))},requestAllChunks:function(){var t=this.stream.getMissingChunks();return this._requestChunks(t),this._loadedStreamCapability.promise},_requestChunks:function(t){var e,s,n=this.currRequestId++,r=Object.create(null);for(this.chunksNeededByRequest[n]=r,e=0,s=t.length;e<s;e++)this.stream.hasChunk(t[e])||(r[t[e]]=!0);if((0,_util.isEmptyObj)(r))return Promise.resolve();var i=(0,_util.createPromiseCapability)();this.promisesByRequest[n]=i;var h=[];for(var u in r)u|=0,u in this.requestsByChunk||(this.requestsByChunk[u]=[],h.push(u)),this.requestsByChunk[u].push(n);if(!h.length)return i.promise;var a=this.groupChunks(h);for(e=0;e<a.length;++e){var o=a[e],d=o.beginChunk*this.chunkSize,l=Math.min(o.endChunk*this.chunkSize,this.length);this.sendRequest(d,l)}return i.promise},getStream:function(){return this.stream},requestRange:function(t,e){e=Math.min(e,this.length);for(var s=this.getBeginChunk(t),n=this.getEndChunk(e),r=[],i=s;i<n;++i)r.push(i);return this._requestChunks(r)},requestRanges:function(t){t=t||[];for(var e=[],s=0;s<t.length;s++)for(var n=this.getBeginChunk(t[s].begin),r=this.getEndChunk(t[s].end),i=n;i<r;++i)e.includes(i)||e.push(i);return e.sort((function(t,e){return t-e})),this._requestChunks(e)},groupChunks:function(t){for(var e=[],s=-1,n=-1,r=0;r<t.length;++r){var i=t[r];s<0&&(s=i),n>=0&&n+1!==i&&(e.push({beginChunk:s,endChunk:n+1}),s=i),r+1===t.length&&e.push({beginChunk:s,endChunk:i+1}),n=i}return e},onProgress:function(t){var e=this.stream.numChunksLoaded*this.chunkSize+t.loaded;this.msgHandler.send("DocProgress",{loaded:e,total:this.length})},onReceiveData:function(t){var e=t.chunk,s=void 0===t.begin,n=s?this.progressiveDataLength:t.begin,r=n+e.byteLength,i=Math.floor(n/this.chunkSize),h=r<this.length?Math.floor(r/this.chunkSize):Math.ceil(r/this.chunkSize);s?(this.stream.onReceiveProgressiveData(e),this.progressiveDataLength=r):this.stream.onReceiveData(n,e),this.stream.allChunksLoaded()&&this._loadedStreamCapability.resolve(this.stream);var u,a,o=[];for(e=i;e<h;++e){var d=this.requestsByChunk[e]||[];for(delete this.requestsByChunk[e],u=0;u<d.length;++u){a=d[u];var l=this.chunksNeededByRequest[a];e in l&&delete l[e],(0,_util.isEmptyObj)(l)&&o.push(a)}}if(!this.disableAutoFetch&&(0,_util.isEmptyObj)(this.requestsByChunk)){var g;if(1===this.stream.numChunksLoaded){var c=this.stream.numChunks-1;this.stream.hasChunk(c)||(g=c)}else g=this.stream.nextEmptyChunk(h);Number.isInteger(g)&&this._requestChunks([g])}for(u=0;u<o.length;++u){a=o[u];var k=this.promisesByRequest[a];delete this.promisesByRequest[a],k.resolve()}this.msgHandler.send("DocProgress",{loaded:this.stream.numChunksLoaded*this.chunkSize,total:this.length})},onError:function(t){this._loadedStreamCapability.reject(t)},getBeginChunk:function(t){var e=Math.floor(t/this.chunkSize);return e},getEndChunk:function(t){var e=Math.floor((t-1)/this.chunkSize)+1;return e},abort:function(){for(var t in this.aborted=!0,this.pdfNetworkStream&&this.pdfNetworkStream.cancelAllRequests("abort"),this.promisesByRequest){var e=this.promisesByRequest[t];e.reject(new Error("Request was aborted"))}}},t}();exports.ChunkedStream=ChunkedStream,exports.ChunkedStreamManager=ChunkedStreamManager;