"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getTilingPatternIR=exports.Pattern=void 0;var _util=require("../shared/util"),_colorspace=require("./colorspace"),_primitives=require("./primitives"),ShadingType={FUNCTION_BASED:1,AXIAL:2,RADIAL:3,FREE_FORM_MESH:4,LATTICE_FORM_MESH:5,COONS_PATCH_MESH:6,TENSOR_PATCH_MESH:7},Pattern=function(){function t(){(0,_util.unreachable)("should not call Pattern constructor")}return t.prototype={getPattern:function(t){(0,_util.unreachable)("Should not call Pattern.getStyle: "+t)}},t.parseShading=function(t,r,e,a,n,s){var i=(0,_primitives.isStream)(t)?t.dict:t,o=i.get("ShadingType");try{switch(o){case ShadingType.AXIAL:case ShadingType.RADIAL:return new Shadings.RadialAxial(i,r,e,a,s);case ShadingType.FREE_FORM_MESH:case ShadingType.LATTICE_FORM_MESH:case ShadingType.COONS_PATCH_MESH:case ShadingType.TENSOR_PATCH_MESH:return new Shadings.Mesh(t,r,e,a,s);default:throw new _util.FormatError("Unsupported ShadingType: "+o)}}catch(h){if(h instanceof _util.MissingDataException)throw h;return n.send("UnsupportedFeature",{featureId:_util.UNSUPPORTED_FEATURES.shadingPattern}),(0,_util.warn)(h),new Shadings.Dummy}},t}(),Shadings={};function getTilingPatternIR(t,r,e){var a=r.getArray("Matrix"),n=_util.Util.normalizeRect(r.getArray("BBox")),s=r.get("XStep"),i=r.get("YStep"),o=r.get("PaintType"),h=r.get("TilingType");if(n[2]-n[0]===0||n[3]-n[1]===0)throw new _util.FormatError("Invalid getTilingPatternIR /BBox array: ["+n+"].");return["TilingPattern",e,t,a,n,s,i,o,h]}Shadings.SMALL_NUMBER=1e-6,Shadings.RadialAxial=function(){function t(t,r,e,a,n){this.matrix=r,this.coordsArr=t.getArray("Coords"),this.shadingType=t.get("ShadingType"),this.type="Pattern";var s=t.get("ColorSpace","CS");s=_colorspace.ColorSpace.parse(s,e,a,n),this.cs=s;var i=0,o=1;if(t.has("Domain")){var h=t.getArray("Domain");i=h[0],o=h[1]}var u=!1,c=!1;if(t.has("Extend")){var g=t.getArray("Extend");u=g[0],c=g[1]}if(this.shadingType===ShadingType.RADIAL&&(!u||!c)){var l=this.coordsArr[0],p=this.coordsArr[1],d=this.coordsArr[2],f=this.coordsArr[3],y=this.coordsArr[4],m=this.coordsArr[5],v=Math.sqrt((l-f)*(l-f)+(p-y)*(p-y));d<=m+v&&m<=d+v&&(0,_util.warn)("Unsupported radial gradient.")}this.extendStart=u,this.extendEnd=c;var A=t.get("Function"),S=n.createFromArray(A),w=o-i,_=w/10,b=this.colorStops=[];if(i>=o||_<=0)(0,_util.info)("Bad shading domain.");else{for(var T,C=new Float32Array(s.numComps),R=new Float32Array(1),E=i;E<=o;E+=_){R[0]=E,S(R,0,C,0),T=s.getRgb(C,0);var M=_util.Util.makeCssRgb(T[0],T[1],T[2]);b.push([(E-i)/w,M])}var P="transparent";t.has("Background")&&(T=s.getRgb(t.get("Background"),0),P=_util.Util.makeCssRgb(T[0],T[1],T[2])),u||(b.unshift([0,P]),b[1][0]+=Shadings.SMALL_NUMBER),c||(b[b.length-1][0]-=Shadings.SMALL_NUMBER,b.push([1,P])),this.colorStops=b}}return t.prototype={getIR:function(){var t,r,e,a,n,s=this.coordsArr,i=this.shadingType;i===ShadingType.AXIAL?(r=[s[0],s[1]],e=[s[2],s[3]],a=null,n=null,t="axial"):i===ShadingType.RADIAL?(r=[s[0],s[1]],e=[s[3],s[4]],a=s[2],n=s[5],t="radial"):(0,_util.unreachable)("getPattern type unknown: "+i);var o=this.matrix;if(o&&(r=_util.Util.applyTransform(r,o),e=_util.Util.applyTransform(e,o),i===ShadingType.RADIAL)){var h=_util.Util.singularValueDecompose2dScale(o);a*=h[0],n*=h[1]}return["RadialAxial",t,this.colorStops,r,e,a,n]}},t}(),Shadings.Mesh=function(){function t(t,r){this.stream=t,this.context=r,this.buffer=0,this.bufferLength=0;var e=r.numComps;this.tmpCompsBuf=new Float32Array(e);var a=r.colorSpace.numComps;this.tmpCsCompsBuf=r.colorFn?new Float32Array(a):this.tmpCompsBuf}function r(t,r){var e=t.coords,a=t.colors,n=[],s=[],i=0;while(r.hasData){var o=r.readFlag(),h=r.readCoordinate(),u=r.readComponents();if(0===i){if(!(0<=o&&o<=2))throw new _util.FormatError("Unknown type4 flag");switch(o){case 0:i=3;break;case 1:s.push(s[s.length-2],s[s.length-1]),i=1;break;case 2:s.push(s[s.length-3],s[s.length-1]),i=1;break}n.push(o)}s.push(e.length),e.push(h),a.push(u),i--,r.align()}t.figures.push({type:"triangles",coords:new Int32Array(s),colors:new Int32Array(s)})}function e(t,r,e){var a=t.coords,n=t.colors,s=[];while(r.hasData){var i=r.readCoordinate(),o=r.readComponents();s.push(a.length),a.push(i),n.push(o)}t.figures.push({type:"lattice",coords:new Int32Array(s),colors:new Int32Array(s),verticesPerRow:e})}t.prototype={get hasData(){if(this.stream.end)return this.stream.pos<this.stream.end;if(this.bufferLength>0)return!0;var t=this.stream.getByte();return!(t<0)&&(this.buffer=t,this.bufferLength=8,!0)},readBits:function(t){var r=this.buffer,e=this.bufferLength;if(32===t){if(0===e)return(this.stream.getByte()<<24|this.stream.getByte()<<16|this.stream.getByte()<<8|this.stream.getByte())>>>0;r=r<<24|this.stream.getByte()<<16|this.stream.getByte()<<8|this.stream.getByte();var a=this.stream.getByte();return this.buffer=a&(1<<e)-1,(r<<8-e|(255&a)>>e)>>>0}if(8===t&&0===e)return this.stream.getByte();while(e<t)r=r<<8|this.stream.getByte(),e+=8;return e-=t,this.bufferLength=e,this.buffer=r&(1<<e)-1,r>>e},align:function(){this.buffer=0,this.bufferLength=0},readFlag:function(){return this.readBits(this.context.bitsPerFlag)},readCoordinate:function(){var t=this.context.bitsPerCoordinate,r=this.readBits(t),e=this.readBits(t),a=this.context.decode,n=t<32?1/((1<<t)-1):2.3283064365386963e-10;return[r*n*(a[1]-a[0])+a[0],e*n*(a[3]-a[2])+a[2]]},readComponents:function(){for(var t=this.context.numComps,r=this.context.bitsPerComponent,e=r<32?1/((1<<r)-1):2.3283064365386963e-10,a=this.context.decode,n=this.tmpCompsBuf,s=0,i=4;s<t;s++,i+=2){var o=this.readBits(r);n[s]=o*e*(a[i+1]-a[i])+a[i]}var h=this.tmpCsCompsBuf;return this.context.colorFn&&this.context.colorFn(n,0,h,0),this.context.colorSpace.getRgb(h,0)}};var a=3,n=20,s=20,i=function(){function t(t){for(var r=[],e=0;e<=t;e++){var a=e/t,n=1-a;r.push(new Float32Array([n*n*n,3*a*n*n,3*a*a*n,a*a*a]))}return r}var r=[];return function(e){return r[e]||(r[e]=t(e)),r[e]}}();function o(t,r){var e=t.figures[r];(0,_util.assert)("patch"===e.type,"Unexpected patch mesh figure");var o=t.coords,h=t.colors,u=e.coords,c=e.colors,g=Math.min(o[u[0]][0],o[u[3]][0],o[u[12]][0],o[u[15]][0]),l=Math.min(o[u[0]][1],o[u[3]][1],o[u[12]][1],o[u[15]][1]),p=Math.max(o[u[0]][0],o[u[3]][0],o[u[12]][0],o[u[15]][0]),d=Math.max(o[u[0]][1],o[u[3]][1],o[u[12]][1],o[u[15]][1]),f=Math.ceil((p-g)*s/(t.bounds[2]-t.bounds[0]));f=Math.max(a,Math.min(n,f));var y=Math.ceil((d-l)*s/(t.bounds[3]-t.bounds[1]));y=Math.max(a,Math.min(n,y));for(var m=f+1,v=new Int32Array((y+1)*m),A=new Int32Array((y+1)*m),S=0,w=new Uint8Array(3),_=new Uint8Array(3),b=h[c[0]],T=h[c[1]],C=h[c[2]],R=h[c[3]],E=i(y),M=i(f),P=0;P<=y;P++){w[0]=(b[0]*(y-P)+C[0]*P)/y|0,w[1]=(b[1]*(y-P)+C[1]*P)/y|0,w[2]=(b[2]*(y-P)+C[2]*P)/y|0,_[0]=(T[0]*(y-P)+R[0]*P)/y|0,_[1]=(T[1]*(y-P)+R[1]*P)/y|0,_[2]=(T[2]*(y-P)+R[2]*P)/y|0;for(var F=0;F<=f;F++,S++)if(0!==P&&P!==y||0!==F&&F!==f){for(var x=0,B=0,I=0,k=0;k<=3;k++)for(var U=0;U<=3;U++,I++){var L=E[P][k]*M[F][U];x+=o[u[I]][0]*L,B+=o[u[I]][1]*L}v[S]=o.length,o.push([x,B]),A[S]=h.length;var D=new Uint8Array(3);D[0]=(w[0]*(f-F)+_[0]*F)/f|0,D[1]=(w[1]*(f-F)+_[1]*F)/f|0,D[2]=(w[2]*(f-F)+_[2]*F)/f|0,h.push(D)}}v[0]=u[0],A[0]=c[0],v[f]=u[3],A[f]=c[1],v[m*y]=u[12],A[m*y]=c[2],v[m*y+f]=u[15],A[m*y+f]=c[3],t.figures[r]={type:"lattice",coords:v,colors:A,verticesPerRow:m}}function h(t,r){var e=t.coords,a=t.colors,n=new Int32Array(16),s=new Int32Array(4);while(r.hasData){var i,o,h=r.readFlag();if(!(0<=h&&h<=3))throw new _util.FormatError("Unknown type6 flag");var u=e.length;for(i=0,o=0!==h?8:12;i<o;i++)e.push(r.readCoordinate());var c,g,l,p,d=a.length;for(i=0,o=0!==h?2:4;i<o;i++)a.push(r.readComponents());switch(h){case 0:n[12]=u+3,n[13]=u+4,n[14]=u+5,n[15]=u+6,n[8]=u+2,n[11]=u+7,n[4]=u+1,n[7]=u+8,n[0]=u,n[1]=u+11,n[2]=u+10,n[3]=u+9,s[2]=d+1,s[3]=d+2,s[0]=d,s[1]=d+3;break;case 1:c=n[12],g=n[13],l=n[14],p=n[15],n[12]=p,n[13]=u+0,n[14]=u+1,n[15]=u+2,n[8]=l,n[11]=u+3,n[4]=g,n[7]=u+4,n[0]=c,n[1]=u+7,n[2]=u+6,n[3]=u+5,c=s[2],g=s[3],s[2]=g,s[3]=d,s[0]=c,s[1]=d+1;break;case 2:c=n[15],g=n[11],n[12]=n[3],n[13]=u+0,n[14]=u+1,n[15]=u+2,n[8]=n[7],n[11]=u+3,n[4]=g,n[7]=u+4,n[0]=c,n[1]=u+7,n[2]=u+6,n[3]=u+5,c=s[3],s[2]=s[1],s[3]=d,s[0]=c,s[1]=d+1;break;case 3:n[12]=n[0],n[13]=u+0,n[14]=u+1,n[15]=u+2,n[8]=n[1],n[11]=u+3,n[4]=n[2],n[7]=u+4,n[0]=n[3],n[1]=u+7,n[2]=u+6,n[3]=u+5,s[2]=s[0],s[3]=d,s[0]=s[1],s[1]=d+1;break}n[5]=e.length,e.push([(-4*e[n[0]][0]-e[n[15]][0]+6*(e[n[4]][0]+e[n[1]][0])-2*(e[n[12]][0]+e[n[3]][0])+3*(e[n[13]][0]+e[n[7]][0]))/9,(-4*e[n[0]][1]-e[n[15]][1]+6*(e[n[4]][1]+e[n[1]][1])-2*(e[n[12]][1]+e[n[3]][1])+3*(e[n[13]][1]+e[n[7]][1]))/9]),n[6]=e.length,e.push([(-4*e[n[3]][0]-e[n[12]][0]+6*(e[n[2]][0]+e[n[7]][0])-2*(e[n[0]][0]+e[n[15]][0])+3*(e[n[4]][0]+e[n[14]][0]))/9,(-4*e[n[3]][1]-e[n[12]][1]+6*(e[n[2]][1]+e[n[7]][1])-2*(e[n[0]][1]+e[n[15]][1])+3*(e[n[4]][1]+e[n[14]][1]))/9]),n[9]=e.length,e.push([(-4*e[n[12]][0]-e[n[3]][0]+6*(e[n[8]][0]+e[n[13]][0])-2*(e[n[0]][0]+e[n[15]][0])+3*(e[n[11]][0]+e[n[1]][0]))/9,(-4*e[n[12]][1]-e[n[3]][1]+6*(e[n[8]][1]+e[n[13]][1])-2*(e[n[0]][1]+e[n[15]][1])+3*(e[n[11]][1]+e[n[1]][1]))/9]),n[10]=e.length,e.push([(-4*e[n[15]][0]-e[n[0]][0]+6*(e[n[11]][0]+e[n[14]][0])-2*(e[n[12]][0]+e[n[3]][0])+3*(e[n[2]][0]+e[n[8]][0]))/9,(-4*e[n[15]][1]-e[n[0]][1]+6*(e[n[11]][1]+e[n[14]][1])-2*(e[n[12]][1]+e[n[3]][1])+3*(e[n[2]][1]+e[n[8]][1]))/9]),t.figures.push({type:"patch",coords:new Int32Array(n),colors:new Int32Array(s)})}}function u(t,r){var e=t.coords,a=t.colors,n=new Int32Array(16),s=new Int32Array(4);while(r.hasData){var i,o,h=r.readFlag();if(!(0<=h&&h<=3))throw new _util.FormatError("Unknown type7 flag");var u=e.length;for(i=0,o=0!==h?12:16;i<o;i++)e.push(r.readCoordinate());var c,g,l,p,d=a.length;for(i=0,o=0!==h?2:4;i<o;i++)a.push(r.readComponents());switch(h){case 0:n[12]=u+3,n[13]=u+4,n[14]=u+5,n[15]=u+6,n[8]=u+2,n[9]=u+13,n[10]=u+14,n[11]=u+7,n[4]=u+1,n[5]=u+12,n[6]=u+15,n[7]=u+8,n[0]=u,n[1]=u+11,n[2]=u+10,n[3]=u+9,s[2]=d+1,s[3]=d+2,s[0]=d,s[1]=d+3;break;case 1:c=n[12],g=n[13],l=n[14],p=n[15],n[12]=p,n[13]=u+0,n[14]=u+1,n[15]=u+2,n[8]=l,n[9]=u+9,n[10]=u+10,n[11]=u+3,n[4]=g,n[5]=u+8,n[6]=u+11,n[7]=u+4,n[0]=c,n[1]=u+7,n[2]=u+6,n[3]=u+5,c=s[2],g=s[3],s[2]=g,s[3]=d,s[0]=c,s[1]=d+1;break;case 2:c=n[15],g=n[11],n[12]=n[3],n[13]=u+0,n[14]=u+1,n[15]=u+2,n[8]=n[7],n[9]=u+9,n[10]=u+10,n[11]=u+3,n[4]=g,n[5]=u+8,n[6]=u+11,n[7]=u+4,n[0]=c,n[1]=u+7,n[2]=u+6,n[3]=u+5,c=s[3],s[2]=s[1],s[3]=d,s[0]=c,s[1]=d+1;break;case 3:n[12]=n[0],n[13]=u+0,n[14]=u+1,n[15]=u+2,n[8]=n[1],n[9]=u+9,n[10]=u+10,n[11]=u+3,n[4]=n[2],n[5]=u+8,n[6]=u+11,n[7]=u+4,n[0]=n[3],n[1]=u+7,n[2]=u+6,n[3]=u+5,s[2]=s[0],s[3]=d,s[0]=s[1],s[1]=d+1;break}t.figures.push({type:"patch",coords:new Int32Array(n),colors:new Int32Array(s)})}}function c(t){for(var r=t.coords[0][0],e=t.coords[0][1],a=r,n=e,s=1,i=t.coords.length;s<i;s++){var o=t.coords[s][0],h=t.coords[s][1];r=r>o?o:r,e=e>h?h:e,a=a<o?o:a,n=n<h?h:n}t.bounds=[r,e,a,n]}function g(t){var r,e,a,n,s=t.coords,i=new Float32Array(2*s.length);for(r=0,a=0,e=s.length;r<e;r++){var o=s[r];i[a++]=o[0],i[a++]=o[1]}t.coords=i;var h=t.colors,u=new Uint8Array(3*h.length);for(r=0,a=0,e=h.length;r<e;r++){var c=h[r];u[a++]=c[0],u[a++]=c[1],u[a++]=c[2]}t.colors=u;var g=t.figures;for(r=0,e=g.length;r<e;r++){var l=g[r],p=l.coords,d=l.colors;for(a=0,n=p.length;a<n;a++)p[a]*=2,d[a]*=3}}function l(a,n,s,i,l){if(!(0,_primitives.isStream)(a))throw new _util.FormatError("Mesh data is not a stream");var p=a.dict;this.matrix=n,this.shadingType=p.get("ShadingType"),this.type="Pattern",this.bbox=p.getArray("BBox");var d=p.get("ColorSpace","CS");d=_colorspace.ColorSpace.parse(d,s,i,l),this.cs=d,this.background=p.has("Background")?d.getRgb(p.get("Background"),0):null;var f=p.get("Function"),y=f?l.createFromArray(f):null;this.coords=[],this.colors=[],this.figures=[];var m={bitsPerCoordinate:p.get("BitsPerCoordinate"),bitsPerComponent:p.get("BitsPerComponent"),bitsPerFlag:p.get("BitsPerFlag"),decode:p.getArray("Decode"),colorFn:y,colorSpace:d,numComps:y?1:d.numComps},v=new t(a,m),A=!1;switch(this.shadingType){case ShadingType.FREE_FORM_MESH:r(this,v);break;case ShadingType.LATTICE_FORM_MESH:var S=0|p.get("VerticesPerRow");if(S<2)throw new _util.FormatError("Invalid VerticesPerRow");e(this,v,S);break;case ShadingType.COONS_PATCH_MESH:h(this,v),A=!0;break;case ShadingType.TENSOR_PATCH_MESH:u(this,v),A=!0;break;default:(0,_util.unreachable)("Unsupported mesh type.");break}if(A){c(this);for(var w=0,_=this.figures.length;w<_;w++)o(this,w)}c(this),g(this)}return l.prototype={getIR:function(){return["Mesh",this.shadingType,this.coords,this.colors,this.figures,this.bounds,this.matrix,this.bbox,this.background]}},l}(),Shadings.Dummy=function(){function t(){this.type="Pattern"}return t.prototype={getIR:function(){return["Dummy"]}},t}(),exports.Pattern=Pattern,exports.getTilingPatternIR=getTilingPatternIR;