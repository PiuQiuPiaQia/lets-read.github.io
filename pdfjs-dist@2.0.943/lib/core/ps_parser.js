"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PostScriptParser=exports.PostScriptLexer=void 0;var _util=require("../shared/util"),_primitives=require("./primitives"),PostScriptParser=function(){function t(t){this.lexer=t,this.operators=[],this.token=null,this.prev=null}return t.prototype={nextToken:function(){this.prev=this.token,this.token=this.lexer.getToken()},accept:function(t){return this.token.type===t&&(this.nextToken(),!0)},expect:function(t){if(this.accept(t))return!0;throw new _util.FormatError("Unexpected symbol: found "+this.token.type+" expected "+t+".")},parse:function(){return this.nextToken(),this.expect(PostScriptTokenTypes.LBRACE),this.parseBlock(),this.expect(PostScriptTokenTypes.RBRACE),this.operators},parseBlock:function(){while(1)if(this.accept(PostScriptTokenTypes.NUMBER))this.operators.push(this.prev.value);else if(this.accept(PostScriptTokenTypes.OPERATOR))this.operators.push(this.prev.value);else{if(!this.accept(PostScriptTokenTypes.LBRACE))return;this.parseCondition()}},parseCondition:function(){var t=this.operators.length;if(this.operators.push(null,null),this.parseBlock(),this.expect(PostScriptTokenTypes.RBRACE),this.accept(PostScriptTokenTypes.IF))this.operators[t]=this.operators.length,this.operators[t+1]="jz";else{if(!this.accept(PostScriptTokenTypes.LBRACE))throw new _util.FormatError("PS Function: error parsing conditional.");var e=this.operators.length;this.operators.push(null,null);var r=this.operators.length;this.parseBlock(),this.expect(PostScriptTokenTypes.RBRACE),this.expect(PostScriptTokenTypes.IFELSE),this.operators[e]=this.operators.length,this.operators[e+1]="j",this.operators[t]=r,this.operators[t+1]="jz"}}},t}(),PostScriptTokenTypes={LBRACE:0,RBRACE:1,NUMBER:2,OPERATOR:3,IF:4,IFELSE:5},PostScriptToken=function(){function t(t,e){this.type=t,this.value=e}var e=Object.create(null);return t.getOperator=function(r){var s=e[r];return s||(e[r]=new t(PostScriptTokenTypes.OPERATOR,r))},t.LBRACE=new t(PostScriptTokenTypes.LBRACE,"{"),t.RBRACE=new t(PostScriptTokenTypes.RBRACE,"}"),t.IF=new t(PostScriptTokenTypes.IF,"IF"),t.IFELSE=new t(PostScriptTokenTypes.IFELSE,"IFELSE"),t}(),PostScriptLexer=function(){function t(t){this.stream=t,this.nextChar(),this.strBuf=[]}return t.prototype={nextChar:function(){return this.currentChar=this.stream.getByte()},getToken:function(){var t=!1,e=this.currentChar;while(1){if(e<0)return _primitives.EOF;if(t)10!==e&&13!==e||(t=!1);else if(37===e)t=!0;else if(!(0,_util.isSpace)(e))break;e=this.nextChar()}switch(0|e){case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:case 43:case 45:case 46:return new PostScriptToken(PostScriptTokenTypes.NUMBER,this.getNumber());case 123:return this.nextChar(),PostScriptToken.LBRACE;case 125:return this.nextChar(),PostScriptToken.RBRACE}var r=this.strBuf;r.length=0,r[0]=String.fromCharCode(e);while((e=this.nextChar())>=0&&(e>=65&&e<=90||e>=97&&e<=122))r.push(String.fromCharCode(e));var s=r.join("");switch(s.toLowerCase()){case"if":return PostScriptToken.IF;case"ifelse":return PostScriptToken.IFELSE;default:return PostScriptToken.getOperator(s)}},getNumber:function(){var t=this.currentChar,e=this.strBuf;e.length=0,e[0]=String.fromCharCode(t);while((t=this.nextChar())>=0){if(!(t>=48&&t<=57||45===t||46===t))break;e.push(String.fromCharCode(t))}var r=parseFloat(e.join(""));if(isNaN(r))throw new _util.FormatError("Invalid floating point number: "+r);return r}},t}();exports.PostScriptLexer=PostScriptLexer,exports.PostScriptParser=PostScriptParser;