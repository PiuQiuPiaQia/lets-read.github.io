"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AnnotationFactory=exports.AnnotationBorderStyle=exports.Annotation=void 0;var _get=function t(e,n,i){null===e&&(e=Function.prototype);var a=Object.getOwnPropertyDescriptor(e,n);if(void 0===a){var r=Object.getPrototypeOf(e);return null===r?void 0:t(r,n,i)}if("value"in a)return a.value;var o=a.get;return void 0!==o?o.call(i):void 0},_createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),_util=require("../shared/util"),_obj=require("./obj"),_primitives=require("./primitives"),_colorspace=require("./colorspace"),_operator_list=require("./operator_list"),_stream=require("./stream");function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!==typeof e&&"function"!==typeof e?t:e}function _inherits(t,e){if("function"!==typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var AnnotationFactory=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"create",value:function(t,e,n,i){return n.ensure(this,"_create",[t,e,n,i])}},{key:"_create",value:function(t,e,n,i){var a=t.fetchIfRef(e);if((0,_primitives.isDict)(a)){var r=(0,_primitives.isRef)(e)?e.toString():"annot_"+i.createObjId(),o=a.get("Subtype");o=(0,_primitives.isName)(o)?o.name:null;var s={xref:t,dict:a,ref:(0,_primitives.isRef)(e)?e:null,subtype:o,id:r,pdfManager:n};switch(o){case"Link":return new LinkAnnotation(s);case"Text":return new TextAnnotation(s);case"Widget":var l=(0,_util.getInheritableProperty)({dict:a,key:"FT"});switch(l=(0,_primitives.isName)(l)?l.name:null,l){case"Tx":return new TextWidgetAnnotation(s);case"Btn":return new ButtonWidgetAnnotation(s);case"Ch":return new ChoiceWidgetAnnotation(s)}return(0,_util.warn)('Unimplemented widget field type "'+l+'", falling back to base field type.'),new WidgetAnnotation(s);case"Popup":return new PopupAnnotation(s);case"Line":return new LineAnnotation(s);case"Square":return new SquareAnnotation(s);case"Circle":return new CircleAnnotation(s);case"PolyLine":return new PolylineAnnotation(s);case"Polygon":return new PolygonAnnotation(s);case"Ink":return new InkAnnotation(s);case"Highlight":return new HighlightAnnotation(s);case"Underline":return new UnderlineAnnotation(s);case"Squiggly":return new SquigglyAnnotation(s);case"StrikeOut":return new StrikeOutAnnotation(s);case"Stamp":return new StampAnnotation(s);case"FileAttachment":return new FileAttachmentAnnotation(s);default:return o?(0,_util.warn)('Unimplemented annotation type "'+o+'", falling back to base annotation.'):(0,_util.warn)("Annotation is missing the required /Subtype."),new Annotation(s)}}}}]),t}();function getTransformMatrix(t,e,n){var i=_util.Util.getAxialAlignedBoundingBox(e,n),a=i[0],r=i[1],o=i[2],s=i[3];if(a===o||r===s)return[1,0,0,1,t[0],t[1]];var l=(t[2]-t[0])/(o-a),u=(t[3]-t[1])/(s-r);return[l,0,0,u,t[0]-a*l,t[1]-r*u]}var Annotation=function(){function t(e){_classCallCheck(this,t);var n=e.dict;this.setFlags(n.get("F")),this.setRectangle(n.getArray("Rect")),this.setColor(n.getArray("C")),this.setBorderStyle(n),this.setAppearance(n),this.data={annotationFlags:this.flags,borderStyle:this.borderStyle,color:this.color,hasAppearance:!!this.appearance,id:e.id,rect:this.rectangle,subtype:e.subtype}}return _createClass(t,[{key:"_hasFlag",value:function(t,e){return!!(t&e)}},{key:"_isViewable",value:function(t){return!this._hasFlag(t,_util.AnnotationFlag.INVISIBLE)&&!this._hasFlag(t,_util.AnnotationFlag.HIDDEN)&&!this._hasFlag(t,_util.AnnotationFlag.NOVIEW)}},{key:"_isPrintable",value:function(t){return this._hasFlag(t,_util.AnnotationFlag.PRINT)&&!this._hasFlag(t,_util.AnnotationFlag.INVISIBLE)&&!this._hasFlag(t,_util.AnnotationFlag.HIDDEN)}},{key:"setFlags",value:function(t){this.flags=Number.isInteger(t)&&t>0?t:0}},{key:"hasFlag",value:function(t){return this._hasFlag(this.flags,t)}},{key:"setRectangle",value:function(t){Array.isArray(t)&&4===t.length?this.rectangle=_util.Util.normalizeRect(t):this.rectangle=[0,0,0,0]}},{key:"setColor",value:function(t){var e=new Uint8ClampedArray(3);if(Array.isArray(t))switch(t.length){case 0:this.color=null;break;case 1:_colorspace.ColorSpace.singletons.gray.getRgbItem(t,0,e,0),this.color=e;break;case 3:_colorspace.ColorSpace.singletons.rgb.getRgbItem(t,0,e,0),this.color=e;break;case 4:_colorspace.ColorSpace.singletons.cmyk.getRgbItem(t,0,e,0),this.color=e;break;default:this.color=e;break}else this.color=e}},{key:"setBorderStyle",value:function(t){if(this.borderStyle=new AnnotationBorderStyle,(0,_primitives.isDict)(t))if(t.has("BS")){var e=t.get("BS"),n=e.get("Type");n&&!(0,_primitives.isName)(n,"Border")||(this.borderStyle.setWidth(e.get("W")),this.borderStyle.setStyle(e.get("S")),this.borderStyle.setDashArray(e.getArray("D")))}else if(t.has("Border")){var i=t.getArray("Border");Array.isArray(i)&&i.length>=3&&(this.borderStyle.setHorizontalCornerRadius(i[0]),this.borderStyle.setVerticalCornerRadius(i[1]),this.borderStyle.setWidth(i[2]),4===i.length&&this.borderStyle.setDashArray(i[3]))}else this.borderStyle.setWidth(0)}},{key:"setAppearance",value:function(t){this.appearance=null;var e=t.get("AP");if((0,_primitives.isDict)(e)){var n=e.get("N");if((0,_primitives.isStream)(n))this.appearance=n;else if((0,_primitives.isDict)(n)){var i=t.get("AS");(0,_primitives.isName)(i)&&n.has(i.name)&&(this.appearance=n.get(i.name))}}}},{key:"_preparePopup",value:function(t){t.has("C")||(this.data.color=null),this.data.hasPopup=t.has("Popup"),this.data.title=(0,_util.stringToPDFString)(t.get("T")||""),this.data.contents=(0,_util.stringToPDFString)(t.get("Contents")||"")}},{key:"loadResources",value:function(t){return this.appearance.dict.getAsync("Resources").then((function(e){if(e){var n=new _obj.ObjectLoader(e,t,e.xref);return n.load().then((function(){return e}))}}))}},{key:"getOperatorList",value:function(t,e,n){var i=this;if(!this.appearance)return Promise.resolve(new _operator_list.OperatorList);var a=this.data,r=this.appearance.dict,o=this.loadResources(["ExtGState","ColorSpace","Pattern","Shading","XObject","Font"]),s=r.getArray("BBox")||[0,0,1,1],l=r.getArray("Matrix")||[1,0,0,1,0,0],u=getTransformMatrix(a.rect,s,l);return o.then((function(n){var r=new _operator_list.OperatorList;return r.addOp(_util.OPS.beginAnnotation,[a.rect,u,l]),t.getOperatorList({stream:i.appearance,task:e,resources:n,operatorList:r}).then((function(){return r.addOp(_util.OPS.endAnnotation,[]),i.appearance.reset(),r}))}))}},{key:"viewable",get:function(){return 0===this.flags||this._isViewable(this.flags)}},{key:"printable",get:function(){return 0!==this.flags&&this._isPrintable(this.flags)}}]),t}(),AnnotationBorderStyle=function(){function t(){_classCallCheck(this,t),this.width=1,this.style=_util.AnnotationBorderStyleType.SOLID,this.dashArray=[3],this.horizontalCornerRadius=0,this.verticalCornerRadius=0}return _createClass(t,[{key:"setWidth",value:function(t){Number.isInteger(t)&&(this.width=t)}},{key:"setStyle",value:function(t){if(t)switch(t.name){case"S":this.style=_util.AnnotationBorderStyleType.SOLID;break;case"D":this.style=_util.AnnotationBorderStyleType.DASHED;break;case"B":this.style=_util.AnnotationBorderStyleType.BEVELED;break;case"I":this.style=_util.AnnotationBorderStyleType.INSET;break;case"U":this.style=_util.AnnotationBorderStyleType.UNDERLINE;break;default:break}}},{key:"setDashArray",value:function(t){if(Array.isArray(t)&&t.length>0){for(var e=!0,n=!0,i=0,a=t.length;i<a;i++){var r=t[i],o=+r>=0;if(!o){e=!1;break}r>0&&(n=!1)}e&&!n?this.dashArray=t:this.width=0}else t&&(this.width=0)}},{key:"setHorizontalCornerRadius",value:function(t){Number.isInteger(t)&&(this.horizontalCornerRadius=t)}},{key:"setVerticalCornerRadius",value:function(t){Number.isInteger(t)&&(this.verticalCornerRadius=t)}}]),t}(),WidgetAnnotation=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t)),i=t.dict,a=n.data;a.annotationType=_util.AnnotationType.WIDGET,a.fieldName=n._constructFieldName(i),a.fieldValue=(0,_util.getInheritableProperty)({dict:i,key:"V",getArray:!0}),a.alternativeText=(0,_util.stringToPDFString)(i.get("TU")||""),a.defaultAppearance=(0,_util.getInheritableProperty)({dict:i,key:"DA"})||"";var r=(0,_util.getInheritableProperty)({dict:i,key:"FT"});return a.fieldType=(0,_primitives.isName)(r)?r.name:null,n.fieldResources=(0,_util.getInheritableProperty)({dict:i,key:"DR"})||_primitives.Dict.empty,a.fieldFlags=(0,_util.getInheritableProperty)({dict:i,key:"Ff"}),(!Number.isInteger(a.fieldFlags)||a.fieldFlags<0)&&(a.fieldFlags=0),a.readOnly=n.hasFieldFlag(_util.AnnotationFieldFlag.READONLY),"Sig"===a.fieldType&&n.setFlags(_util.AnnotationFlag.HIDDEN),n}return _inherits(e,t),_createClass(e,[{key:"_constructFieldName",value:function(t){if(!t.has("T")&&!t.has("Parent"))return(0,_util.warn)("Unknown field name, falling back to empty field name."),"";if(!t.has("Parent"))return(0,_util.stringToPDFString)(t.get("T"));var e=[];t.has("T")&&e.unshift((0,_util.stringToPDFString)(t.get("T")));var n=t;while(n.has("Parent")){if(n=n.get("Parent"),!(0,_primitives.isDict)(n))break;n.has("T")&&e.unshift((0,_util.stringToPDFString)(n.get("T")))}return e.join(".")}},{key:"hasFieldFlag",value:function(t){return!!(this.data.fieldFlags&t)}},{key:"getOperatorList",value:function(t,n,i){return i?Promise.resolve(new _operator_list.OperatorList):_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"getOperatorList",this).call(this,t,n,i)}}]),e}(Annotation),TextWidgetAnnotation=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t)),i=t.dict;n.data.fieldValue=(0,_util.stringToPDFString)(n.data.fieldValue||"");var a=(0,_util.getInheritableProperty)({dict:i,key:"Q"});(!Number.isInteger(a)||a<0||a>2)&&(a=null),n.data.textAlignment=a;var r=(0,_util.getInheritableProperty)({dict:i,key:"MaxLen"});return(!Number.isInteger(r)||r<0)&&(r=null),n.data.maxLen=r,n.data.multiLine=n.hasFieldFlag(_util.AnnotationFieldFlag.MULTILINE),n.data.comb=n.hasFieldFlag(_util.AnnotationFieldFlag.COMB)&&!n.hasFieldFlag(_util.AnnotationFieldFlag.MULTILINE)&&!n.hasFieldFlag(_util.AnnotationFieldFlag.PASSWORD)&&!n.hasFieldFlag(_util.AnnotationFieldFlag.FILESELECT)&&null!==n.data.maxLen,n}return _inherits(e,t),_createClass(e,[{key:"getOperatorList",value:function(t,n,i){if(i||this.appearance)return _get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"getOperatorList",this).call(this,t,n,i);var a=new _operator_list.OperatorList;if(!this.data.defaultAppearance)return Promise.resolve(a);var r=new _stream.Stream((0,_util.stringToBytes)(this.data.defaultAppearance));return t.getOperatorList({stream:r,task:n,resources:this.fieldResources,operatorList:a}).then((function(){return a}))}}]),e}(WidgetAnnotation),ButtonWidgetAnnotation=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.data.checkBox=!n.hasFieldFlag(_util.AnnotationFieldFlag.RADIO)&&!n.hasFieldFlag(_util.AnnotationFieldFlag.PUSHBUTTON),n.data.radioButton=n.hasFieldFlag(_util.AnnotationFieldFlag.RADIO)&&!n.hasFieldFlag(_util.AnnotationFieldFlag.PUSHBUTTON),n.data.pushButton=n.hasFieldFlag(_util.AnnotationFieldFlag.PUSHBUTTON),n.data.checkBox?n._processCheckBox(t):n.data.radioButton?n._processRadioButton(t):n.data.pushButton?n._processPushButton(t):(0,_util.warn)("Invalid field flags for button widget annotation"),n}return _inherits(e,t),_createClass(e,[{key:"_processCheckBox",value:function(t){(0,_primitives.isName)(this.data.fieldValue)&&(this.data.fieldValue=this.data.fieldValue.name);var e=t.dict.get("AP");if((0,_primitives.isDict)(e)){var n=e.get("D");if((0,_primitives.isDict)(n)){var i=n.getKeys(),a=2===i.length;a&&(this.data.exportValue="Off"===i[0]?i[1]:i[0])}}}},{key:"_processRadioButton",value:function(t){this.data.fieldValue=this.data.buttonValue=null;var e=t.dict.get("Parent");if((0,_primitives.isDict)(e)&&e.has("V")){var n=e.get("V");(0,_primitives.isName)(n)&&(this.data.fieldValue=n.name)}var i=t.dict.get("AP");if((0,_primitives.isDict)(i)){var a=i.get("N");if((0,_primitives.isDict)(a))for(var r=a.getKeys(),o=0,s=r.length;o<s;o++)if("Off"!==r[o]){this.data.buttonValue=r[o];break}}}},{key:"_processPushButton",value:function(t){t.dict.has("A")?_obj.Catalog.parseDestDictionary({destDict:t.dict,resultObj:this.data,docBaseUrl:t.pdfManager.docBaseUrl}):(0,_util.warn)("Push buttons without action dictionaries are not supported")}}]),e}(WidgetAnnotation),ChoiceWidgetAnnotation=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));n.data.options=[];var i=(0,_util.getInheritableProperty)({dict:t.dict,key:"Opt"});if(Array.isArray(i))for(var a=t.xref,r=0,o=i.length;r<o;r++){var s=a.fetchIfRef(i[r]),l=Array.isArray(s);n.data.options[r]={exportValue:l?a.fetchIfRef(s[0]):s,displayValue:(0,_util.stringToPDFString)(l?a.fetchIfRef(s[1]):s)}}return Array.isArray(n.data.fieldValue)||(n.data.fieldValue=[n.data.fieldValue]),n.data.combo=n.hasFieldFlag(_util.AnnotationFieldFlag.COMBO),n.data.multiSelect=n.hasFieldFlag(_util.AnnotationFieldFlag.MULTISELECT),n}return _inherits(e,t),e}(WidgetAnnotation),TextAnnotation=function(t){function e(t){_classCallCheck(this,e);var n=22,i=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i.data.annotationType=_util.AnnotationType.TEXT,i.data.hasAppearance?i.data.name="NoIcon":(i.data.rect[1]=i.data.rect[3]-n,i.data.rect[2]=i.data.rect[0]+n,i.data.name=t.dict.has("Name")?t.dict.get("Name").name:"Note"),i._preparePopup(t.dict),i}return _inherits(e,t),e}(Annotation),LinkAnnotation=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.data.annotationType=_util.AnnotationType.LINK,_obj.Catalog.parseDestDictionary({destDict:t.dict,resultObj:n.data,docBaseUrl:t.pdfManager.docBaseUrl}),n}return _inherits(e,t),e}(Annotation),PopupAnnotation=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));n.data.annotationType=_util.AnnotationType.POPUP;var i=t.dict,a=i.get("Parent");if(!a)return(0,_util.warn)("Popup annotation has a missing or invalid parent annotation."),_possibleConstructorReturn(n);var r=a.get("Subtype");if(n.data.parentType=(0,_primitives.isName)(r)?r.name:null,n.data.parentId=i.getRaw("Parent").toString(),n.data.title=(0,_util.stringToPDFString)(a.get("T")||""),n.data.contents=(0,_util.stringToPDFString)(a.get("Contents")||""),a.has("C")?(n.setColor(a.getArray("C")),n.data.color=n.color):n.data.color=null,!n.viewable){var o=a.get("F");n._isViewable(o)&&n.setFlags(o)}return n}return _inherits(e,t),e}(Annotation),LineAnnotation=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));n.data.annotationType=_util.AnnotationType.LINE;var i=t.dict;return n.data.lineCoordinates=_util.Util.normalizeRect(i.getArray("L")),n._preparePopup(i),n}return _inherits(e,t),e}(Annotation),SquareAnnotation=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.data.annotationType=_util.AnnotationType.SQUARE,n._preparePopup(t.dict),n}return _inherits(e,t),e}(Annotation),CircleAnnotation=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.data.annotationType=_util.AnnotationType.CIRCLE,n._preparePopup(t.dict),n}return _inherits(e,t),e}(Annotation),PolylineAnnotation=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));n.data.annotationType=_util.AnnotationType.POLYLINE;var i=t.dict,a=i.getArray("Vertices");n.data.vertices=[];for(var r=0,o=a.length;r<o;r+=2)n.data.vertices.push({x:a[r],y:a[r+1]});return n._preparePopup(i),n}return _inherits(e,t),e}(Annotation),PolygonAnnotation=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.data.annotationType=_util.AnnotationType.POLYGON,n}return _inherits(e,t),e}(PolylineAnnotation),InkAnnotation=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));n.data.annotationType=_util.AnnotationType.INK;var i=t.dict,a=t.xref,r=i.getArray("InkList");n.data.inkLists=[];for(var o=0,s=r.length;o<s;++o){n.data.inkLists.push([]);for(var l=0,u=r[o].length;l<u;l+=2)n.data.inkLists[o].push({x:a.fetchIfRef(r[o][l]),y:a.fetchIfRef(r[o][l+1])})}return n._preparePopup(i),n}return _inherits(e,t),e}(Annotation),HighlightAnnotation=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.data.annotationType=_util.AnnotationType.HIGHLIGHT,n._preparePopup(t.dict),n}return _inherits(e,t),e}(Annotation),UnderlineAnnotation=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.data.annotationType=_util.AnnotationType.UNDERLINE,n._preparePopup(t.dict),n}return _inherits(e,t),e}(Annotation),SquigglyAnnotation=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.data.annotationType=_util.AnnotationType.SQUIGGLY,n._preparePopup(t.dict),n}return _inherits(e,t),e}(Annotation),StrikeOutAnnotation=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.data.annotationType=_util.AnnotationType.STRIKEOUT,n._preparePopup(t.dict),n}return _inherits(e,t),e}(Annotation),StampAnnotation=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.data.annotationType=_util.AnnotationType.STAMP,n._preparePopup(t.dict),n}return _inherits(e,t),e}(Annotation),FileAttachmentAnnotation=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t)),i=new _obj.FileSpec(t.dict.get("FS"),t.xref);return n.data.annotationType=_util.AnnotationType.FILEATTACHMENT,n.data.file=i.serializable,n._preparePopup(t.dict),n}return _inherits(e,t),e}(Annotation);exports.Annotation=Annotation,exports.AnnotationBorderStyle=AnnotationBorderStyle,exports.AnnotationFactory=AnnotationFactory;