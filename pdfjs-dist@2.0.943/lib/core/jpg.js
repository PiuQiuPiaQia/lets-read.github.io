"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.JpegImage=void 0;var _typeof="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(r){return typeof r}:function(r){return r&&"function"===typeof Symbol&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},_util=require("../shared/util"),JpegError=function(){function r(r){this.message="JPEG error: "+r}return r.prototype=new Error,r.prototype.name="JpegError",r.constructor=r,r}(),DNLMarkerError=function(){function r(r,e){this.message=r,this.scanLines=e}return r.prototype=new Error,r.prototype.name="DNLMarkerError",r.constructor=r,r}(),EOIMarkerError=function(){function r(r){this.message=r}return r.prototype=new Error,r.prototype.name="EOIMarkerError",r.constructor=r,r}(),JpegImage=function(){var r=new Uint8Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),e=4017,n=799,a=3406,o=2276,t=1567,i=3784,s=5793,c=2896;function l(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=r.decodeTransform,n=void 0===e?null:e,a=r.colorTransform,o=void 0===a?-1:a;this._decodeTransform=n,this._colorTransform=o}function f(r,e){var n,a,o=0,t=[],i=16;while(i>0&&!r[i-1])i--;t.push({children:[],index:0});var s,c=t[0];for(n=0;n<i;n++){for(a=0;a<r[n];a++){c=t.pop(),c.children[c.index]=e[o];while(c.index>0)c=t.pop();c.index++,t.push(c);while(t.length<=n)t.push(s={children:[],index:0}),c.children[c.index]=s.children,c=s;o++}n+1<i&&(t.push(s={children:[],index:0}),c.children[c.index]=s.children,c=s)}return t[0].children}function u(r,e,n){return 64*((r.blocksPerLine+1)*e+n)}function h(e,n,a,o,t,i,s,c,l){var f=arguments.length>9&&void 0!==arguments[9]&&arguments[9],h=a.mcusPerLine,v=a.progressive,m=n,p=0,b=0;function k(){if(b>0)return b--,p>>b&1;if(p=e[n++],255===p){var r=e[n++];if(r){if(220===r&&f){n+=2;var o=e[n++]<<8|e[n++];if(o>0&&o!==a.scanLines)throw new DNLMarkerError("Found DNL marker (0xFFDC) while parsing scan data",o)}else if(217===r)throw new EOIMarkerError("Found EOI marker (0xFFD9) while parsing scan data");throw new JpegError("unexpected marker "+(p<<8|r).toString(16))}}return b=7,p>>>7}function g(r){var e=r;while(1){if(e=e[k()],"number"===typeof e)return e;if("object"!==("undefined"===typeof e?"undefined":_typeof(e)))throw new JpegError("invalid huffman sequence")}}function w(r){var e=0;while(r>0)e=e<<1|k(),r--;return e}function y(r){if(1===r)return 1===k()?1:-1;var e=w(r);return e>=1<<r-1?e:e+(-1<<r)+1}function C(e,n){var a=g(e.huffmanTableDC),o=0===a?0:y(a);e.blockData[n]=e.pred+=o;var t=1;while(t<64){var i=g(e.huffmanTableAC),s=15&i,c=i>>4;if(0!==s){t+=c;var l=r[t];e.blockData[n+l]=y(s),t++}else{if(c<15)break;t+=16}}}function D(r,e){var n=g(r.huffmanTableDC),a=0===n?0:y(n)<<l;r.blockData[e]=r.pred+=a}function E(r,e){r.blockData[e]|=k()<<l}var L=0;function _(e,n){if(L>0)L--;else{var a=i,o=s;while(a<=o){var t=g(e.huffmanTableAC),c=15&t,f=t>>4;if(0!==c){a+=f;var u=r[a];e.blockData[n+u]=y(c)*(1<<l),a++}else{if(f<15){L=w(f)+(1<<f)-1;break}a+=16}}}}var x,P=0;function T(e,n){var a,o,t=i,c=s,f=0;while(t<=c){var u=n+r[t],h=e.blockData[u]<0?-1:1;switch(P){case 0:if(o=g(e.huffmanTableAC),a=15&o,f=o>>4,0===a)f<15?(L=w(f)+(1<<f),P=4):(f=16,P=1);else{if(1!==a)throw new JpegError("invalid ACn encoding");x=y(a),P=f?2:3}continue;case 1:case 2:e.blockData[u]?e.blockData[u]+=h*(k()<<l):(f--,0===f&&(P=2===P?3:0));break;case 3:e.blockData[u]?e.blockData[u]+=h*(k()<<l):(e.blockData[u]=x<<l,P=0);break;case 4:e.blockData[u]&&(e.blockData[u]+=h*(k()<<l));break}t++}4===P&&(L--,0===L&&(P=0))}function J(r,e,n,a,o){var t=n/h|0,i=n%h,s=t*r.v+a,c=i*r.h+o,l=u(r,s,c);e(r,l)}function I(r,e,n){var a=n/r.blocksPerLine|0,o=n%r.blocksPerLine,t=u(r,a,o);e(r,t)}var M,A,S,U,q,z,N=o.length;z=v?0===i?0===c?D:E:0===c?_:T:C;var O,Y,F,R,H=0;Y=1===N?o[0].blocksPerLine*o[0].blocksPerColumn:h*a.mcusPerColumn;while(H<Y){var j=t?Math.min(Y-H,t):Y;for(A=0;A<N;A++)o[A].pred=0;if(L=0,1===N)for(M=o[0],q=0;q<j;q++)I(M,z,H),H++;else for(q=0;q<j;q++){for(A=0;A<N;A++)for(M=o[A],F=M.h,R=M.v,S=0;S<R;S++)for(U=0;U<F;U++)J(M,z,H,S,U);H++}b=0,O=d(e,n),O&&O.invalid&&((0,_util.warn)("decodeScan - unexpected MCU data, current marker is: "+O.invalid),n=O.offset);var B=O&&O.marker;if(!B||B<=65280)throw new JpegError("marker was not found");if(!(B>=65488&&B<=65495))break;n+=2}return O=d(e,n),O&&O.invalid&&((0,_util.warn)("decodeScan - unexpected Scan data, current marker is: "+O.invalid),n=O.offset),n-m}function v(r,l,f){var u,h,v,m,d,p,b,k,g,w,y,C,D,E,L,_,x,P=r.quantizationTable,T=r.blockData;if(!P)throw new JpegError("missing required Quantization Table.");for(var J=0;J<64;J+=8)g=T[l+J],w=T[l+J+1],y=T[l+J+2],C=T[l+J+3],D=T[l+J+4],E=T[l+J+5],L=T[l+J+6],_=T[l+J+7],g*=P[J],0!==(w|y|C|D|E|L|_)?(w*=P[J+1],y*=P[J+2],C*=P[J+3],D*=P[J+4],E*=P[J+5],L*=P[J+6],_*=P[J+7],u=s*g+128>>8,h=s*D+128>>8,v=y,m=L,d=c*(w-_)+128>>8,k=c*(w+_)+128>>8,p=C<<4,b=E<<4,u=u+h+1>>1,h=u-h,x=v*i+m*t+128>>8,v=v*t-m*i+128>>8,m=x,d=d+b+1>>1,b=d-b,k=k+p+1>>1,p=k-p,u=u+m+1>>1,m=u-m,h=h+v+1>>1,v=h-v,x=d*o+k*a+2048>>12,d=d*a-k*o+2048>>12,k=x,x=p*n+b*e+2048>>12,p=p*e-b*n+2048>>12,b=x,f[J]=u+k,f[J+7]=u-k,f[J+1]=h+b,f[J+6]=h-b,f[J+2]=v+p,f[J+5]=v-p,f[J+3]=m+d,f[J+4]=m-d):(x=s*g+512>>10,f[J]=x,f[J+1]=x,f[J+2]=x,f[J+3]=x,f[J+4]=x,f[J+5]=x,f[J+6]=x,f[J+7]=x);for(var I=0;I<8;++I)g=f[I],w=f[I+8],y=f[I+16],C=f[I+24],D=f[I+32],E=f[I+40],L=f[I+48],_=f[I+56],0!==(w|y|C|D|E|L|_)?(u=s*g+2048>>12,h=s*D+2048>>12,v=y,m=L,d=c*(w-_)+2048>>12,k=c*(w+_)+2048>>12,p=C,b=E,u=4112+(u+h+1>>1),h=u-h,x=v*i+m*t+2048>>12,v=v*t-m*i+2048>>12,m=x,d=d+b+1>>1,b=d-b,k=k+p+1>>1,p=k-p,u=u+m+1>>1,m=u-m,h=h+v+1>>1,v=h-v,x=d*o+k*a+2048>>12,d=d*a-k*o+2048>>12,k=x,x=p*n+b*e+2048>>12,p=p*e-b*n+2048>>12,b=x,g=u+k,_=u-k,w=h+b,L=h-b,y=v+p,E=v-p,C=m+d,D=m-d,g=g<16?0:g>=4080?255:g>>4,w=w<16?0:w>=4080?255:w>>4,y=y<16?0:y>=4080?255:y>>4,C=C<16?0:C>=4080?255:C>>4,D=D<16?0:D>=4080?255:D>>4,E=E<16?0:E>=4080?255:E>>4,L=L<16?0:L>=4080?255:L>>4,_=_<16?0:_>=4080?255:_>>4,T[l+I]=g,T[l+I+8]=w,T[l+I+16]=y,T[l+I+24]=C,T[l+I+32]=D,T[l+I+40]=E,T[l+I+48]=L,T[l+I+56]=_):(x=s*g+8192>>14,x=x<-2040?0:x>=2024?255:x+2056>>4,T[l+I]=x,T[l+I+8]=x,T[l+I+16]=x,T[l+I+24]=x,T[l+I+32]=x,T[l+I+40]=x,T[l+I+48]=x,T[l+I+56]=x)}function m(r,e){for(var n=e.blocksPerLine,a=e.blocksPerColumn,o=new Int16Array(64),t=0;t<a;t++)for(var i=0;i<n;i++){var s=u(e,t,i);v(e,s,o)}return e.blockData}function d(r,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;function a(e){return r[e]<<8|r[e+1]}var o=r.length-1,t=n<e?n:e;if(e>=o)return null;var i=a(e);if(i>=65472&&i<=65534)return{invalid:null,marker:i,offset:e};var s=a(t);while(!(s>=65472&&s<=65534)){if(++t>=o)return null;s=a(t)}return{invalid:i.toString(16),marker:s,offset:t}}return l.prototype={parse:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=n.dnlScanLines,o=void 0===a?null:a;function t(){var r=e[u]<<8|e[u+1];return u+=2,r}function i(){var r=t(),n=u+r-2,a=d(e,n,u);a&&a.invalid&&((0,_util.warn)("readDataBlock - incorrect length, current marker is: "+a.invalid),n=a.offset);var o=e.subarray(u,n);return u+=o.length,o}function s(r){for(var e=Math.ceil(r.samplesPerLine/8/r.maxH),n=Math.ceil(r.scanLines/8/r.maxV),a=0;a<r.components.length;a++){B=r.components[a];var o=Math.ceil(Math.ceil(r.samplesPerLine/8)*B.h/r.maxH),t=Math.ceil(Math.ceil(r.scanLines/8)*B.v/r.maxV),i=e*B.h,s=n*B.v,c=64*s*(i+1);B.blockData=new Int16Array(c),B.blocksPerLine=o,B.blocksPerColumn=t}r.mcusPerLine=e,r.mcusPerColumn=n}var c,l,u=0,v=null,p=null,b=0,k=[],g=[],w=[],y=t();if(65496!==y)throw new JpegError("SOI not found");y=t();r:while(65497!==y){var C,D,E;switch(y){case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:var L=i();65504===y&&74===L[0]&&70===L[1]&&73===L[2]&&70===L[3]&&0===L[4]&&(v={version:{major:L[5],minor:L[6]},densityUnits:L[7],xDensity:L[8]<<8|L[9],yDensity:L[10]<<8|L[11],thumbWidth:L[12],thumbHeight:L[13],thumbData:L.subarray(14,14+3*L[12]*L[13])}),65518===y&&65===L[0]&&100===L[1]&&111===L[2]&&98===L[3]&&101===L[4]&&(p={version:L[5]<<8|L[6],flags0:L[7]<<8|L[8],flags1:L[9]<<8|L[10],transformCode:L[11]});break;case 65499:var _,x=t(),P=x+u-2;while(u<P){var T=e[u++],J=new Uint16Array(64);if(T>>4===0)for(D=0;D<64;D++)_=r[D],J[_]=e[u++];else{if(T>>4!==1)throw new JpegError("DQT - invalid table spec");for(D=0;D<64;D++)_=r[D],J[_]=t()}k[15&T]=J}break;case 65472:case 65473:case 65474:if(c)throw new JpegError("Only single frame JPEGs supported");t(),c={},c.extended=65473===y,c.progressive=65474===y,c.precision=e[u++];var I=t();c.scanLines=o||I,c.samplesPerLine=t(),c.components=[],c.componentIds={};var M,A=e[u++],S=0,U=0;for(C=0;C<A;C++){M=e[u];var q=e[u+1]>>4,z=15&e[u+1];S<q&&(S=q),U<z&&(U=z);var N=e[u+2];E=c.components.push({h:q,v:z,quantizationId:N,quantizationTable:null}),c.componentIds[M]=E-1,u+=3}c.maxH=S,c.maxV=U,s(c);break;case 65476:var O=t();for(C=2;C<O;){var Y=e[u++],F=new Uint8Array(16),R=0;for(D=0;D<16;D++,u++)R+=F[D]=e[u];var H=new Uint8Array(R);for(D=0;D<R;D++,u++)H[D]=e[u];C+=17+R,(Y>>4===0?w:g)[15&Y]=f(F,H)}break;case 65501:t(),l=t();break;case 65498:var j=1===++b&&!o;t();var B,G=e[u++],V=[];for(C=0;C<G;C++){var Q=c.componentIds[e[u++]];B=c.components[Q];var X=e[u++];B.huffmanTableDC=w[X>>4],B.huffmanTableAC=g[15&X],V.push(B)}var W=e[u++],K=e[u++],Z=e[u++];try{var $=h(e,u,c,V,l,W,K,Z>>4,15&Z,j);u+=$}catch(nr){if(nr instanceof DNLMarkerError)return(0,_util.warn)(nr.message+" -- attempting to re-parse the JPEG image."),this.parse(e,{dnlScanLines:nr.scanLines});if(nr instanceof EOIMarkerError){(0,_util.warn)(nr.message+" -- ignoring the rest of the image data.");break r}throw nr}break;case 65500:u+=4;break;case 65535:255!==e[u]&&u--;break;default:if(255===e[u-3]&&e[u-2]>=192&&e[u-2]<=254){u-=3;break}var rr=d(e,u-2);if(rr&&rr.invalid){(0,_util.warn)("JpegImage.parse - unexpected data, current marker is: "+rr.invalid),u=rr.offset;break}throw new JpegError("unknown marker "+y.toString(16))}y=t()}for(this.width=c.samplesPerLine,this.height=c.scanLines,this.jfif=v,this.adobe=p,this.components=[],C=0;C<c.components.length;C++){B=c.components[C];var er=k[B.quantizationId];er&&(B.quantizationTable=er),this.components.push({output:m(c,B),scaleX:B.h/c.maxH,scaleY:B.v/c.maxV,blocksPerLine:B.blocksPerLine,blocksPerColumn:B.blocksPerColumn})}this.numComponents=this.components.length},_getLinearizedBlockData:function(r,e){var n,a,o,t,i,s,c,l,f,u,h,v=arguments.length>2&&void 0!==arguments[2]&&arguments[2],m=this.width/r,d=this.height/e,p=0,b=this.components.length,k=r*e*b,g=new Uint8ClampedArray(k),w=new Uint32Array(r),y=4294967288;for(c=0;c<b;c++){for(n=this.components[c],a=n.scaleX*m,o=n.scaleY*d,p=c,h=n.output,t=n.blocksPerLine+1<<3,i=0;i<r;i++)l=0|i*a,w[i]=(l&y)<<3|7&l;for(s=0;s<e;s++)for(l=0|s*o,u=t*(l&y)|(7&l)<<3,i=0;i<r;i++)g[p]=h[u+w[i]],p+=b}var C=this._decodeTransform;if(v||4!==b||C||(C=new Int32Array([-256,255,-256,255,-256,255,-256,255])),C)for(c=0;c<k;)for(l=0,f=0;l<b;l++,c++,f+=2)g[c]=(g[c]*C[f]>>8)+C[f+1];return g},get _isColorConversionNeeded(){return this.adobe?!!this.adobe.transformCode:3===this.numComponents?0!==this._colorTransform:1===this._colorTransform},_convertYccToRgb:function(r){for(var e,n,a,o=0,t=r.length;o<t;o+=3)e=r[o],n=r[o+1],a=r[o+2],r[o]=e-179.456+1.402*a,r[o+1]=e+135.459-.344*n-.714*a,r[o+2]=e-226.816+1.772*n;return r},_convertYcckToRgb:function(r){for(var e,n,a,o,t=0,i=0,s=r.length;i<s;i+=4)e=r[i],n=r[i+1],a=r[i+2],o=r[i+3],r[t++]=n*(-660635669420364e-19*n+.000437130475926232*a-54080610064599e-18*e+.00048449797120281*o-.154362151871126)-122.67195406894+a*(-.000957964378445773*a+.000817076911346625*e-.00477271405408747*o+1.53380253221734)+e*(.000961250184130688*e-.00266257332283933*o+.48357088451265)+o*(-.000336197177618394*o+.484791561490776),r[t++]=107.268039397724+n*(219927104525741e-19*n-.000640992018297945*a+.000659397001245577*e+.000426105652938837*o-.176491792462875)+a*(-.000778269941513683*a+.00130872261408275*e+.000770482631801132*o-.151051492775562)+e*(.00126935368114843*e-.00265090189010898*o+.25802910206845)+o*(-.000318913117588328*o-.213742400323665),r[t++]=n*(-.000570115196973677*n-263409051004589e-19*a+.0020741088115012*e-.00288260236853442*o+.814272968359295)-20.810012546947+a*(-153496057440975e-19*a-.000132689043961446*e+.000560833691242812*o-.195152027534049)+e*(.00174418132927582*e-.00255243321439347*o+.116935020465145)+o*(-.000343531996510555*o+.24165260232407);return r.subarray(0,t)},_convertYcckToCmyk:function(r){for(var e,n,a,o=0,t=r.length;o<t;o+=4)e=r[o],n=r[o+1],a=r[o+2],r[o]=434.456-e-1.402*a,r[o+1]=119.541-e+.344*n+.714*a,r[o+2]=481.816-e-1.772*n;return r},_convertCmykToRgb:function(r){for(var e,n,a,o,t=0,i=1/255,s=0,c=r.length;s<c;s+=4)e=r[s]*i,n=r[s+1]*i,a=r[s+2]*i,o=r[s+3]*i,r[t++]=255+e*(-4.387332384609988*e+54.48615194189176*n+18.82290502165302*a+212.25662451639585*o-285.2331026137004)+n*(1.7149763477362134*n-5.6096736904047315*a-17.873870861415444*o-5.497006427196366)+a*(-2.5217340131683033*a-21.248923337353073*o+17.5119270841813)-o*(21.86122147463605*o+189.48180835922747),r[t++]=255+e*(8.841041422036149*e+60.118027045597366*n+6.871425592049007*a+31.159100130055922*o-79.2970844816548)+n*(-15.310361306967817*n+17.575251261109482*a+131.35250912493976*o-190.9453302588951)+a*(4.444339102852739*a+9.8632861493405*o-24.86741582555878)-o*(20.737325471181034*o+187.80453709719578),r[t++]=255+e*(.8842522430003296*e+8.078677503112928*n+30.89978309703729*a-.23883238689178934*o-14.183576799673286)+n*(10.49593273432072*n+63.02378494754052*a+50.606957656360734*o-112.23884253719248)+a*(.03296041114873217*a+115.60384449646641*o-193.58209356861505)-o*(22.33816807309886*o+180.12613974708367);return r.subarray(0,t)},getData:function(r){var e=r.width,n=r.height,a=r.forceRGB,o=void 0!==a&&a,t=r.isSourcePDF,i=void 0!==t&&t;if(this.numComponents>4)throw new JpegError("Unsupported color mode");var s=this._getLinearizedBlockData(e,n,i);if(1===this.numComponents&&o){for(var c=s.length,l=new Uint8ClampedArray(3*c),f=0,u=0;u<c;u++){var h=s[u];l[f++]=h,l[f++]=h,l[f++]=h}return l}if(3===this.numComponents&&this._isColorConversionNeeded)return this._convertYccToRgb(s);if(4===this.numComponents){if(this._isColorConversionNeeded)return o?this._convertYcckToRgb(s):this._convertYcckToCmyk(s);if(o)return this._convertCmykToRgb(s)}return s}},l}();exports.JpegImage=JpegImage;