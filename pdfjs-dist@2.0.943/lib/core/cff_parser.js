"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CFFFDSelect=exports.CFFCompiler=exports.CFFPrivateDict=exports.CFFTopDict=exports.CFFCharset=exports.CFFIndex=exports.CFFStrings=exports.CFFHeader=exports.CFF=exports.CFFParser=exports.CFFStandardStrings=void 0;var _util=require("../shared/util"),_charsets=require("./charsets"),_encodings=require("./encodings"),MAX_SUBR_NESTING=10,CFFStandardStrings=[".notdef","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quoteright","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","quoteleft","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","exclamdown","cent","sterling","fraction","yen","florin","section","currency","quotesingle","quotedblleft","guillemotleft","guilsinglleft","guilsinglright","fi","fl","endash","dagger","daggerdbl","periodcentered","paragraph","bullet","quotesinglbase","quotedblbase","quotedblright","guillemotright","ellipsis","perthousand","questiondown","grave","acute","circumflex","tilde","macron","breve","dotaccent","dieresis","ring","cedilla","hungarumlaut","ogonek","caron","emdash","AE","ordfeminine","Lslash","Oslash","OE","ordmasculine","ae","dotlessi","lslash","oslash","oe","germandbls","onesuperior","logicalnot","mu","trademark","Eth","onehalf","plusminus","Thorn","onequarter","divide","brokenbar","degree","thorn","threequarters","twosuperior","registered","minus","eth","multiply","threesuperior","copyright","Aacute","Acircumflex","Adieresis","Agrave","Aring","Atilde","Ccedilla","Eacute","Ecircumflex","Edieresis","Egrave","Iacute","Icircumflex","Idieresis","Igrave","Ntilde","Oacute","Ocircumflex","Odieresis","Ograve","Otilde","Scaron","Uacute","Ucircumflex","Udieresis","Ugrave","Yacute","Ydieresis","Zcaron","aacute","acircumflex","adieresis","agrave","aring","atilde","ccedilla","eacute","ecircumflex","edieresis","egrave","iacute","icircumflex","idieresis","igrave","ntilde","oacute","ocircumflex","odieresis","ograve","otilde","scaron","uacute","ucircumflex","udieresis","ugrave","yacute","ydieresis","zcaron","exclamsmall","Hungarumlautsmall","dollaroldstyle","dollarsuperior","ampersandsmall","Acutesmall","parenleftsuperior","parenrightsuperior","twodotenleader","onedotenleader","zerooldstyle","oneoldstyle","twooldstyle","threeoldstyle","fouroldstyle","fiveoldstyle","sixoldstyle","sevenoldstyle","eightoldstyle","nineoldstyle","commasuperior","threequartersemdash","periodsuperior","questionsmall","asuperior","bsuperior","centsuperior","dsuperior","esuperior","isuperior","lsuperior","msuperior","nsuperior","osuperior","rsuperior","ssuperior","tsuperior","ff","ffi","ffl","parenleftinferior","parenrightinferior","Circumflexsmall","hyphensuperior","Gravesmall","Asmall","Bsmall","Csmall","Dsmall","Esmall","Fsmall","Gsmall","Hsmall","Ismall","Jsmall","Ksmall","Lsmall","Msmall","Nsmall","Osmall","Psmall","Qsmall","Rsmall","Ssmall","Tsmall","Usmall","Vsmall","Wsmall","Xsmall","Ysmall","Zsmall","colonmonetary","onefitted","rupiah","Tildesmall","exclamdownsmall","centoldstyle","Lslashsmall","Scaronsmall","Zcaronsmall","Dieresissmall","Brevesmall","Caronsmall","Dotaccentsmall","Macronsmall","figuredash","hypheninferior","Ogoneksmall","Ringsmall","Cedillasmall","questiondownsmall","oneeighth","threeeighths","fiveeighths","seveneighths","onethird","twothirds","zerosuperior","foursuperior","fivesuperior","sixsuperior","sevensuperior","eightsuperior","ninesuperior","zeroinferior","oneinferior","twoinferior","threeinferior","fourinferior","fiveinferior","sixinferior","seveninferior","eightinferior","nineinferior","centinferior","dollarinferior","periodinferior","commainferior","Agravesmall","Aacutesmall","Acircumflexsmall","Atildesmall","Adieresissmall","Aringsmall","AEsmall","Ccedillasmall","Egravesmall","Eacutesmall","Ecircumflexsmall","Edieresissmall","Igravesmall","Iacutesmall","Icircumflexsmall","Idieresissmall","Ethsmall","Ntildesmall","Ogravesmall","Oacutesmall","Ocircumflexsmall","Otildesmall","Odieresissmall","OEsmall","Oslashsmall","Ugravesmall","Uacutesmall","Ucircumflexsmall","Udieresissmall","Yacutesmall","Thornsmall","Ydieresissmall","001.000","001.001","001.002","001.003","Black","Bold","Book","Light","Medium","Regular","Roman","Semibold"],CFFParser=function(){var e=[null,{id:"hstem",min:2,stackClearing:!0,stem:!0},null,{id:"vstem",min:2,stackClearing:!0,stem:!0},{id:"vmoveto",min:1,stackClearing:!0},{id:"rlineto",min:2,resetStack:!0},{id:"hlineto",min:1,resetStack:!0},{id:"vlineto",min:1,resetStack:!0},{id:"rrcurveto",min:6,resetStack:!0},null,{id:"callsubr",min:1,undefStack:!0},{id:"return",min:0,undefStack:!0},null,null,{id:"endchar",min:0,stackClearing:!0},null,null,null,{id:"hstemhm",min:2,stackClearing:!0,stem:!0},{id:"hintmask",min:0,stackClearing:!0},{id:"cntrmask",min:0,stackClearing:!0},{id:"rmoveto",min:2,stackClearing:!0},{id:"hmoveto",min:1,stackClearing:!0},{id:"vstemhm",min:2,stackClearing:!0,stem:!0},{id:"rcurveline",min:8,resetStack:!0},{id:"rlinecurve",min:8,resetStack:!0},{id:"vvcurveto",min:4,resetStack:!0},{id:"hhcurveto",min:4,resetStack:!0},null,{id:"callgsubr",min:1,undefStack:!0},{id:"vhcurveto",min:4,resetStack:!0},{id:"hvcurveto",min:4,resetStack:!0}],t=[null,null,null,{id:"and",min:2,stackDelta:-1},{id:"or",min:2,stackDelta:-1},{id:"not",min:1,stackDelta:0},null,null,null,{id:"abs",min:1,stackDelta:0},{id:"add",min:2,stackDelta:-1,stackFn:function(e,t){e[t-2]=e[t-2]+e[t-1]}},{id:"sub",min:2,stackDelta:-1,stackFn:function(e,t){e[t-2]=e[t-2]-e[t-1]}},{id:"div",min:2,stackDelta:-1,stackFn:function(e,t){e[t-2]=e[t-2]/e[t-1]}},null,{id:"neg",min:1,stackDelta:0,stackFn:function(e,t){e[t-1]=-e[t-1]}},{id:"eq",min:2,stackDelta:-1},null,null,{id:"drop",min:1,stackDelta:-1},null,{id:"put",min:2,stackDelta:-2},{id:"get",min:1,stackDelta:0},{id:"ifelse",min:4,stackDelta:-3},{id:"random",min:0,stackDelta:1},{id:"mul",min:2,stackDelta:-1,stackFn:function(e,t){e[t-2]=e[t-2]*e[t-1]}},null,{id:"sqrt",min:1,stackDelta:0},{id:"dup",min:1,stackDelta:1},{id:"exch",min:2,stackDelta:0},{id:"index",min:2,stackDelta:0},{id:"roll",min:3,stackDelta:-2},null,null,null,{id:"hflex",min:7,resetStack:!0},{id:"flex",min:13,resetStack:!0},{id:"hflex1",min:9,resetStack:!0},{id:"flex1",min:11,resetStack:!0}];function r(e,t,r){this.bytes=e.getBytes(),this.properties=t,this.seacAnalysisEnabled=!!r}return r.prototype={parse:function(){var e=this.properties,t=new CFF;this.cff=t;var r=this.parseHeader(),i=this.parseIndex(r.endPos),n=this.parseIndex(i.endPos),a=this.parseIndex(n.endPos),s=this.parseIndex(a.endPos),l=this.parseDict(n.obj.get(0)),o=this.createDict(CFFTopDict,l,t.strings);t.header=r.obj,t.names=this.parseNameIndex(i.obj),t.strings=this.parseStringIndex(a.obj),t.topDict=o,t.globalSubrIndex=s.obj,this.parsePrivateDict(t.topDict),t.isCIDFont=o.hasName("ROS");var c=o.getByName("CharStrings"),u=this.parseIndex(c).obj,d=o.getByName("FontMatrix");d&&(e.fontMatrix=d);var h,f,m=o.getByName("FontBBox");if(m&&(e.ascent=Math.max(m[3],m[1]),e.descent=Math.min(m[1],m[3]),e.ascentScaled=!0),t.isCIDFont){for(var p=this.parseIndex(o.getByName("FDArray")).obj,g=0,F=p.count;g<F;++g){var v=p.get(g),y=this.createDict(CFFTopDict,this.parseDict(v),t.strings);this.parsePrivateDict(y),t.fdArray.push(y)}f=null,h=this.parseCharsets(o.getByName("charset"),u.count,t.strings,!0),t.fdSelect=this.parseFDSelect(o.getByName("FDSelect"),u.count)}else h=this.parseCharsets(o.getByName("charset"),u.count,t.strings,!1),f=this.parseEncoding(o.getByName("Encoding"),e,t.strings,h.charset);t.charset=h,t.encoding=f;var S=this.parseCharStrings({charStrings:u,localSubrIndex:o.privateDict.subrsIndex,globalSubrIndex:s.obj,fdSelect:t.fdSelect,fdArray:t.fdArray,privateDict:o.privateDict});return t.charStrings=S.charStrings,t.seacs=S.seacs,t.widths=S.widths,t},parseHeader:function(){var e=this.bytes,t=e.length,r=0;while(r<t&&1!==e[r])++r;if(r>=t)throw new _util.FormatError("Invalid CFF header");0!==r&&((0,_util.info)("cff data is shifted"),e=e.subarray(r),this.bytes=e);var i=e[0],n=e[1],a=e[2],s=e[3],l=new CFFHeader(i,n,a,s);return{obj:l,endPos:a}},parseDict:function(e){var t=0;function r(){var r=e[t++];return 30===r?i():28===r?(r=e[t++],r=(r<<24|e[t++]<<16)>>16,r):29===r?(r=e[t++],r=r<<8|e[t++],r=r<<8|e[t++],r=r<<8|e[t++],r):r>=32&&r<=246?r-139:r>=247&&r<=250?256*(r-247)+e[t++]+108:r>=251&&r<=254?-256*(r-251)-e[t++]-108:((0,_util.warn)('CFFParser_parseDict: "'+r+'" is a reserved command.'),NaN)}function i(){var r="",i=15,n=["0","1","2","3","4","5","6","7","8","9",".","E","E-",null,"-"],a=e.length;while(t<a){var s=e[t++],l=s>>4,o=15&s;if(l===i)break;if(r+=n[l],o===i)break;r+=n[o]}return parseFloat(r)}var n=[],a=[];t=0;var s=e.length;while(t<s){var l=e[t];l<=21?(12===l&&(l=l<<8|e[++t]),a.push([l,n]),n=[],++t):n.push(r())}return a},parseIndex:function(e){var t,r,i=new CFFIndex,n=this.bytes,a=n[e++]<<8|n[e++],s=[],l=e;if(0!==a){var o=n[e++],c=e+(a+1)*o-1;for(t=0,r=a+1;t<r;++t){for(var u=0,d=0;d<o;++d)u<<=8,u+=n[e++];s.push(c+u)}l=s[a]}for(t=0,r=s.length-1;t<r;++t){var h=s[t],f=s[t+1];i.add(n.subarray(h,f))}return{obj:i,endPos:l}},parseNameIndex:function(e){for(var t=[],r=0,i=e.count;r<i;++r){var n=e.get(r);t.push((0,_util.bytesToString)(n))}return t},parseStringIndex:function(e){for(var t=new CFFStrings,r=0,i=e.count;r<i;++r){var n=e.get(r);t.add((0,_util.bytesToString)(n))}return t},createDict:function(e,t,r){for(var i=new e(r),n=0,a=t.length;n<a;++n){var s=t[n],l=s[0],o=s[1];i.setByKey(l,o)}return i},parseCharString:function(r,i,n,a){if(!i||r.callDepth>MAX_SUBR_NESTING)return!1;for(var s=r.stackSize,l=r.stack,o=i.length,c=0;c<o;){var u=i[c++],d=null;if(12===u){var h=i[c++];0===h?(i[c-2]=139,i[c-1]=22,s=0):d=t[h]}else if(28===u)l[s]=(i[c]<<24|i[c+1]<<16)>>16,c+=2,s++;else if(14===u){if(s>=4&&(s-=4,this.seacAnalysisEnabled))return r.seac=l.slice(s,s+4),!1;d=e[u]}else if(u>=32&&u<=246)l[s]=u-139,s++;else if(u>=247&&u<=254)l[s]=u<251?(u-247<<8)+i[c]+108:-(u-251<<8)-i[c]-108,c++,s++;else if(255===u)l[s]=(i[c]<<24|i[c+1]<<16|i[c+2]<<8|i[c+3])/65536,c+=4,s++;else if(19===u||20===u)r.hints+=s>>1,c+=r.hints+7>>3,s%=2,d=e[u];else{if(10===u||29===u){var f;if(f=10===u?n:a,!f)return d=e[u],(0,_util.warn)("Missing subrsIndex for "+d.id),!1;var m=32768;f.count<1240?m=107:f.count<33900&&(m=1131);var p=l[--s]+m;if(p<0||p>=f.count||isNaN(p))return d=e[u],(0,_util.warn)("Out of bounds subrIndex for "+d.id),!1;r.stackSize=s,r.callDepth++;var g=this.parseCharString(r,f.get(p),n,a);if(!g)return!1;r.callDepth--,s=r.stackSize;continue}if(11===u)return r.stackSize=s,!0;d=e[u]}if(d){if(d.stem&&(r.hints+=s>>1),"min"in d&&!r.undefStack&&s<d.min)return(0,_util.warn)("Not enough parameters for "+d.id+"; actual: "+s+", expected: "+d.min),!1;r.firstStackClearing&&d.stackClearing&&(r.firstStackClearing=!1,s-=d.min,s>=2&&d.stem?s%=2:s>1&&(0,_util.warn)("Found too many parameters for stack-clearing command"),s>0&&l[s-1]>=0&&(r.width=l[s-1])),"stackDelta"in d?("stackFn"in d&&d.stackFn(l,s),s+=d.stackDelta):d.stackClearing?s=0:d.resetStack?(s=0,r.undefStack=!1):d.undefStack&&(s=0,r.undefStack=!0,r.firstStackClearing=!1)}}return r.stackSize=s,!0},parseCharStrings:function(e){for(var t=e.charStrings,r=e.localSubrIndex,i=e.globalSubrIndex,n=e.fdSelect,a=e.fdArray,s=e.privateDict,l=[],o=[],c=t.count,u=0;u<c;u++){var d=t.get(u),h={callDepth:0,stackSize:0,stack:[],undefStack:!0,hints:0,firstStackClearing:!0,seac:null,width:null},f=!0,m=null,p=s;if(n&&a.length){var g=n.getFDIndex(u);-1===g&&((0,_util.warn)("Glyph index is not in fd select."),f=!1),g>=a.length&&((0,_util.warn)("Invalid fd index for glyph index."),f=!1),f&&(p=a[g].privateDict,m=p.subrsIndex)}else r&&(m=r);if(f&&(f=this.parseCharString(h,d,m,i)),null!==h.width){var F=p.getByName("nominalWidthX");o[u]=F+h.width}else{var v=p.getByName("defaultWidthX");o[u]=v}null!==h.seac&&(l[u]=h.seac),f||t.set(u,new Uint8Array([14]))}return{charStrings:t,seacs:l,widths:o}},emptyPrivateDictionary:function(e){var t=this.createDict(CFFPrivateDict,[],e.strings);e.setByKey(18,[0,0]),e.privateDict=t},parsePrivateDict:function(e){if(e.hasName("Private")){var t=e.getByName("Private");if(Array.isArray(t)&&2===t.length){var r=t[0],i=t[1];if(0===r||i>=this.bytes.length)this.emptyPrivateDictionary(e);else{var n=i+r,a=this.bytes.subarray(i,n),s=this.parseDict(a),l=this.createDict(CFFPrivateDict,s,e.strings);if(e.privateDict=l,l.getByName("Subrs")){var o=l.getByName("Subrs"),c=i+o;if(0===o||c>=this.bytes.length)this.emptyPrivateDictionary(e);else{var u=this.parseIndex(c);l.subrsIndex=u.obj}}}}else e.removeByName("Private")}else this.emptyPrivateDictionary(e)},parseCharsets:function(e,t,r,i){if(0===e)return new CFFCharset(!0,CFFCharsetPredefinedTypes.ISO_ADOBE,_charsets.ISOAdobeCharset);if(1===e)return new CFFCharset(!0,CFFCharsetPredefinedTypes.EXPERT,_charsets.ExpertCharset);if(2===e)return new CFFCharset(!0,CFFCharsetPredefinedTypes.EXPERT_SUBSET,_charsets.ExpertSubsetCharset);var n,a,s,l=this.bytes,o=e,c=l[e++],u=[".notdef"];switch(t-=1,c){case 0:for(s=0;s<t;s++)n=l[e++]<<8|l[e++],u.push(i?n:r.get(n));break;case 1:while(u.length<=t)for(n=l[e++]<<8|l[e++],a=l[e++],s=0;s<=a;s++)u.push(i?n++:r.get(n++));break;case 2:while(u.length<=t)for(n=l[e++]<<8|l[e++],a=l[e++]<<8|l[e++],s=0;s<=a;s++)u.push(i?n++:r.get(n++));break;default:throw new _util.FormatError("Unknown charset format")}var d=e,h=l.subarray(o,d);return new CFFCharset(!1,c,u,h)},parseEncoding:function(e,t,r,i){var n,a,s,l=Object.create(null),o=this.bytes,c=!1,u=null;function d(){var t=o[e++];for(a=0;a<t;a++){var n=o[e++],s=(o[e++]<<8)+(255&o[e++]);l[n]=i.indexOf(r.get(s))}}if(0===e||1===e){c=!0,n=e;var h=e?_encodings.ExpertEncoding:_encodings.StandardEncoding;for(a=0,s=i.length;a<s;a++){var f=h.indexOf(i[a]);-1!==f&&(l[f]=a)}}else{var m=e;switch(n=o[e++],127&n){case 0:var p=o[e++];for(a=1;a<=p;a++)l[o[e++]]=a;break;case 1:var g=o[e++],F=1;for(a=0;a<g;a++)for(var v=o[e++],y=o[e++],S=v;S<=v+y;S++)l[S]=F++;break;default:throw new _util.FormatError("Unknown encoding format: "+n+" in CFF")}var C=e;128&n&&(o[m]&=127,d()),u=o.subarray(m,C)}return n&=127,new CFFEncoding(c,n,l,u)},parseFDSelect:function(e,t){var r,i=this.bytes,n=i[e++],a=[];switch(n){case 0:for(r=0;r<t;++r){var s=i[e++];a.push(s)}break;case 3:var l=i[e++]<<8|i[e++];for(r=0;r<l;++r){var o=i[e++]<<8|i[e++];0===r&&0!==o&&((0,_util.warn)("parseFDSelect: The first range must have a first GID of 0 -- trying to recover."),o=0);for(var c=i[e++],u=i[e]<<8|i[e+1],d=o;d<u;++d)a.push(c)}e+=2;break;default:throw new _util.FormatError('parseFDSelect: Unknown format "'+n+'".')}if(a.length!==t)throw new _util.FormatError("parseFDSelect: Invalid font data.");return new CFFFDSelect(n,a)}},r}(),CFF=function(){function e(){this.header=null,this.names=[],this.topDict=null,this.strings=new CFFStrings,this.globalSubrIndex=null,this.encoding=null,this.charset=null,this.charStrings=null,this.fdArray=[],this.fdSelect=null,this.isCIDFont=!1}return e.prototype={duplicateFirstGlyph:function(){if(this.charStrings.count>=65535)(0,_util.warn)("Not enough space in charstrings to duplicate first glyph.");else{var e=this.charStrings.get(0);this.charStrings.add(e),this.isCIDFont&&this.fdSelect.fdSelect.push(this.fdSelect.fdSelect[0])}},hasGlyphId:function(e){if(e<0||e>=this.charStrings.count)return!1;var t=this.charStrings.get(e);return t.length>0}},e}(),CFFHeader=function(){function e(e,t,r,i){this.major=e,this.minor=t,this.hdrSize=r,this.offSize=i}return e}(),CFFStrings=function(){function e(){this.strings=[]}return e.prototype={get:function(e){return e>=0&&e<=390?CFFStandardStrings[e]:e-391<=this.strings.length?this.strings[e-391]:CFFStandardStrings[0]},add:function(e){this.strings.push(e)},get count(){return this.strings.length}},e}(),CFFIndex=function(){function e(){this.objects=[],this.length=0}return e.prototype={add:function(e){this.length+=e.length,this.objects.push(e)},set:function(e,t){this.length+=t.length-this.objects[e].length,this.objects[e]=t},get:function(e){return this.objects[e]},get count(){return this.objects.length}},e}(),CFFDict=function(){function e(e,t){this.keyToNameMap=e.keyToNameMap,this.nameToKeyMap=e.nameToKeyMap,this.defaults=e.defaults,this.types=e.types,this.opcodes=e.opcodes,this.order=e.order,this.strings=t,this.values=Object.create(null)}return e.prototype={setByKey:function(e,t){if(!(e in this.keyToNameMap))return!1;var r=t.length;if(0===r)return!0;for(var i=0;i<r;i++)if(isNaN(t[i]))return(0,_util.warn)('Invalid CFFDict value: "'+t+'" for key "'+e+'".'),!0;var n=this.types[e];return"num"!==n&&"sid"!==n&&"offset"!==n||(t=t[0]),this.values[e]=t,!0},setByName:function(e,t){if(!(e in this.nameToKeyMap))throw new _util.FormatError('Invalid dictionary name "'+e+'"');this.values[this.nameToKeyMap[e]]=t},hasName:function(e){return this.nameToKeyMap[e]in this.values},getByName:function(e){if(!(e in this.nameToKeyMap))throw new _util.FormatError("Invalid dictionary name "+e+'"');var t=this.nameToKeyMap[e];return t in this.values?this.values[t]:this.defaults[t]},removeByName:function(e){delete this.values[this.nameToKeyMap[e]]}},e.createTables=function(e){for(var t={keyToNameMap:{},nameToKeyMap:{},defaults:{},types:{},opcodes:{},order:[]},r=0,i=e.length;r<i;++r){var n=e[r],a=Array.isArray(n[0])?(n[0][0]<<8)+n[0][1]:n[0];t.keyToNameMap[a]=n[1],t.nameToKeyMap[n[1]]=a,t.types[a]=n[2],t.defaults[a]=n[3],t.opcodes[a]=Array.isArray(n[0])?n[0]:[n[0]],t.order.push(a)}return t},e}(),CFFTopDict=function(){var e=[[[12,30],"ROS",["sid","sid","num"],null],[[12,20],"SyntheticBase","num",null],[0,"version","sid",null],[1,"Notice","sid",null],[[12,0],"Copyright","sid",null],[2,"FullName","sid",null],[3,"FamilyName","sid",null],[4,"Weight","sid",null],[[12,1],"isFixedPitch","num",0],[[12,2],"ItalicAngle","num",0],[[12,3],"UnderlinePosition","num",-100],[[12,4],"UnderlineThickness","num",50],[[12,5],"PaintType","num",0],[[12,6],"CharstringType","num",2],[[12,7],"FontMatrix",["num","num","num","num","num","num"],[.001,0,0,.001,0,0]],[13,"UniqueID","num",null],[5,"FontBBox",["num","num","num","num"],[0,0,0,0]],[[12,8],"StrokeWidth","num",0],[14,"XUID","array",null],[15,"charset","offset",0],[16,"Encoding","offset",0],[17,"CharStrings","offset",0],[18,"Private",["offset","offset"],null],[[12,21],"PostScript","sid",null],[[12,22],"BaseFontName","sid",null],[[12,23],"BaseFontBlend","delta",null],[[12,31],"CIDFontVersion","num",0],[[12,32],"CIDFontRevision","num",0],[[12,33],"CIDFontType","num",0],[[12,34],"CIDCount","num",8720],[[12,35],"UIDBase","num",null],[[12,37],"FDSelect","offset",null],[[12,36],"FDArray","offset",null],[[12,38],"FontName","sid",null]],t=null;function r(r){null===t&&(t=CFFDict.createTables(e)),CFFDict.call(this,t,r),this.privateDict=null}return r.prototype=Object.create(CFFDict.prototype),r}(),CFFPrivateDict=function(){var e=[[6,"BlueValues","delta",null],[7,"OtherBlues","delta",null],[8,"FamilyBlues","delta",null],[9,"FamilyOtherBlues","delta",null],[[12,9],"BlueScale","num",.039625],[[12,10],"BlueShift","num",7],[[12,11],"BlueFuzz","num",1],[10,"StdHW","num",null],[11,"StdVW","num",null],[[12,12],"StemSnapH","delta",null],[[12,13],"StemSnapV","delta",null],[[12,14],"ForceBold","num",0],[[12,17],"LanguageGroup","num",0],[[12,18],"ExpansionFactor","num",.06],[[12,19],"initialRandomSeed","num",0],[20,"defaultWidthX","num",0],[21,"nominalWidthX","num",0],[19,"Subrs","offset",null]],t=null;function r(r){null===t&&(t=CFFDict.createTables(e)),CFFDict.call(this,t,r),this.subrsIndex=null}return r.prototype=Object.create(CFFDict.prototype),r}(),CFFCharsetPredefinedTypes={ISO_ADOBE:0,EXPERT:1,EXPERT_SUBSET:2},CFFCharset=function(){function e(e,t,r,i){this.predefined=e,this.format=t,this.charset=r,this.raw=i}return e}(),CFFEncoding=function(){function e(e,t,r,i){this.predefined=e,this.format=t,this.encoding=r,this.raw=i}return e}(),CFFFDSelect=function(){function e(e,t){this.format=e,this.fdSelect=t}return e.prototype={getFDIndex:function(e){return e<0||e>=this.fdSelect.length?-1:this.fdSelect[e]}},e}(),CFFOffsetTracker=function(){function e(){this.offsets=Object.create(null)}return e.prototype={isTracking:function(e){return e in this.offsets},track:function(e,t){if(e in this.offsets)throw new _util.FormatError("Already tracking location of "+e);this.offsets[e]=t},offset:function(e){for(var t in this.offsets)this.offsets[t]+=e},setEntryLocation:function(e,t,r){if(!(e in this.offsets))throw new _util.FormatError("Not tracking location of "+e);for(var i=r.data,n=this.offsets[e],a=5,s=0,l=t.length;s<l;++s){var o=s*a+n,c=o+1,u=o+2,d=o+3,h=o+4;if(29!==i[o]||0!==i[c]||0!==i[u]||0!==i[d]||0!==i[h])throw new _util.FormatError("writing to an offset that is not empty");var f=t[s];i[o]=29,i[c]=f>>24&255,i[u]=f>>16&255,i[d]=f>>8&255,i[h]=255&f}}},e}(),CFFCompiler=function(){function e(e){this.cff=e}return e.prototype={compile:function(){var e=this.cff,t={data:[],length:0,add:function(e){this.data=this.data.concat(e),this.length=this.data.length}},r=this.compileHeader(e.header);t.add(r);var i=this.compileNameIndex(e.names);if(t.add(i),e.isCIDFont&&e.topDict.hasName("FontMatrix")){var n=e.topDict.getByName("FontMatrix");e.topDict.removeByName("FontMatrix");for(var a=0,s=e.fdArray.length;a<s;a++){var l=e.fdArray[a],o=n.slice(0);l.hasName("FontMatrix")&&(o=_util.Util.transform(o,l.getByName("FontMatrix"))),l.setByName("FontMatrix",o)}}e.topDict.setByName("charset",0);var c=this.compileTopDicts([e.topDict],t.length,e.isCIDFont);t.add(c.output);var u=c.trackers[0],d=this.compileStringIndex(e.strings.strings);t.add(d);var h=this.compileIndex(e.globalSubrIndex);if(t.add(h),e.encoding&&e.topDict.hasName("Encoding"))if(e.encoding.predefined)u.setEntryLocation("Encoding",[e.encoding.format],t);else{var f=this.compileEncoding(e.encoding);u.setEntryLocation("Encoding",[t.length],t),t.add(f)}var m=this.compileCharset(e.charset);u.setEntryLocation("charset",[t.length],t),t.add(m);var p=this.compileCharStrings(e.charStrings);if(u.setEntryLocation("CharStrings",[t.length],t),t.add(p),e.isCIDFont){u.setEntryLocation("FDSelect",[t.length],t);var g=this.compileFDSelect(e.fdSelect);t.add(g),c=this.compileTopDicts(e.fdArray,t.length,!0),u.setEntryLocation("FDArray",[t.length],t),t.add(c.output);var F=c.trackers;this.compilePrivateDicts(e.fdArray,F,t)}return this.compilePrivateDicts([e.topDict],[u],t),t.add([0]),t.data},encodeNumber:function(e){return parseFloat(e)!==parseInt(e,10)||isNaN(e)?this.encodeFloat(e):this.encodeInteger(e)},encodeFloat:function(e){var t=e.toString(),r=/\.(\d*?)(?:9{5,20}|0{5,20})\d{0,2}(?:e(.+)|$)/.exec(t);if(r){var i=parseFloat("1e"+((r[2]?+r[2]:0)+r[1].length));t=(Math.round(e*i)/i).toString()}var n,a,s="";for(n=0,a=t.length;n<a;++n){var l=t[n];s+="e"===l?"-"===t[++n]?"c":"b":"."===l?"a":"-"===l?"e":l}s+=1&s.length?"f":"ff";var o=[30];for(n=0,a=s.length;n<a;n+=2)o.push(parseInt(s.substring(n,n+2),16));return o},encodeInteger:function(e){var t;return e>=-107&&e<=107?t=[e+139]:e>=108&&e<=1131?(e-=108,t=[247+(e>>8),255&e]):e>=-1131&&e<=-108?(e=-e-108,t=[251+(e>>8),255&e]):t=e>=-32768&&e<=32767?[28,e>>8&255,255&e]:[29,e>>24&255,e>>16&255,e>>8&255,255&e],t},compileHeader:function(e){return[e.major,e.minor,e.hdrSize,e.offSize]},compileNameIndex:function(e){for(var t=new CFFIndex,r=0,i=e.length;r<i;++r){for(var n=e[r],a=Math.min(n.length,127),s=new Array(a),l=0;l<a;l++){var o=n[l];(o<"!"||o>"~"||"["===o||"]"===o||"("===o||")"===o||"{"===o||"}"===o||"<"===o||">"===o||"/"===o||"%"===o)&&(o="_"),s[l]=o}s=s.join(""),""===s&&(s="Bad_Font_Name"),t.add((0,_util.stringToBytes)(s))}return this.compileIndex(t)},compileTopDicts:function(e,t,r){for(var i=[],n=new CFFIndex,a=0,s=e.length;a<s;++a){var l=e[a];r&&(l.removeByName("CIDFontVersion"),l.removeByName("CIDFontRevision"),l.removeByName("CIDFontType"),l.removeByName("CIDCount"),l.removeByName("UIDBase"));var o=new CFFOffsetTracker,c=this.compileDict(l,o);i.push(o),n.add(c),o.offset(t)}return n=this.compileIndex(n,i),{trackers:i,output:n}},compilePrivateDicts:function(e,t,r){for(var i=0,n=e.length;i<n;++i){var a=e[i],s=a.privateDict;if(!s||!a.hasName("Private"))throw new _util.FormatError("There must be a private dictionary.");var l=new CFFOffsetTracker,o=this.compileDict(s,l),c=r.length;if(l.offset(c),o.length||(c=0),t[i].setEntryLocation("Private",[o.length,c],r),r.add(o),s.subrsIndex&&s.hasName("Subrs")){var u=this.compileIndex(s.subrsIndex);l.setEntryLocation("Subrs",[o.length],r),r.add(u)}}},compileDict:function(e,t){for(var r=[],i=e.order,n=0;n<i.length;++n){var a=i[n];if(a in e.values){var s=e.values[a],l=e.types[a];if(Array.isArray(l)||(l=[l]),Array.isArray(s)||(s=[s]),0!==s.length){for(var o=0,c=l.length;o<c;++o){var u=l[o],d=s[o];switch(u){case"num":case"sid":r=r.concat(this.encodeNumber(d));break;case"offset":var h=e.keyToNameMap[a];t.isTracking(h)||t.track(h,r.length),r=r.concat([29,0,0,0,0]);break;case"array":case"delta":r=r.concat(this.encodeNumber(d));for(var f=1,m=s.length;f<m;++f)r=r.concat(this.encodeNumber(s[f]));break;default:throw new _util.FormatError("Unknown data type of "+u)}}r=r.concat(e.opcodes[a])}}}return r},compileStringIndex:function(e){for(var t=new CFFIndex,r=0,i=e.length;r<i;++r)t.add((0,_util.stringToBytes)(e[r]));return this.compileIndex(t)},compileGlobalSubrIndex:function(){var e=this.cff.globalSubrIndex;this.out.writeByteArray(this.compileIndex(e))},compileCharStrings:function(e){for(var t=new CFFIndex,r=0;r<e.count;r++){var i=e.get(r);0!==i.length?t.add(i):t.add(new Uint8Array([139,14]))}return this.compileIndex(t)},compileCharset:function(e){var t=1+2*(this.cff.charStrings.count-1),r=new Uint8Array(t);return this.compileTypedArray(r)},compileEncoding:function(e){return this.compileTypedArray(e.raw)},compileFDSelect:function(e){var t=e.format,r=void 0,i=void 0;switch(t){case 0:for(r=new Uint8Array(1+e.fdSelect.length),r[0]=t,i=0;i<e.fdSelect.length;i++)r[i+1]=e.fdSelect[i];break;case 3:var n=0,a=e.fdSelect[0],s=[t,0,0,n>>8&255,255&n,a];for(i=1;i<e.fdSelect.length;i++){var l=e.fdSelect[i];l!==a&&(s.push(i>>8&255,255&i,l),a=l)}var o=(s.length-3)/3;s[1]=o>>8&255,s[2]=255&o,s.push(i>>8&255,255&i),r=new Uint8Array(s);break}return this.compileTypedArray(r)},compileTypedArray:function(e){for(var t=[],r=0,i=e.length;r<i;++r)t[r]=e[r];return t},compileIndex:function(e,t){t=t||[];var r=e.objects,i=r.length;if(0===i)return[0,0,0];var n,a,s=[i>>8&255,255&i],l=1;for(n=0;n<i;++n)l+=r[n].length;a=l<256?1:l<65536?2:l<16777216?3:4,s.push(a);var o=1;for(n=0;n<i+1;n++)1===a?s.push(255&o):2===a?s.push(o>>8&255,255&o):3===a?s.push(o>>16&255,o>>8&255,255&o):s.push(o>>>24&255,o>>16&255,o>>8&255,255&o),r[n]&&(o+=r[n].length);for(n=0;n<i;n++){t[n]&&t[n].offset(s.length);for(var c=0,u=r[n].length;c<u;c++)s.push(r[n][c])}return s}},e}();exports.CFFStandardStrings=CFFStandardStrings,exports.CFFParser=CFFParser,exports.CFF=CFF,exports.CFFHeader=CFFHeader,exports.CFFStrings=CFFStrings,exports.CFFIndex=CFFIndex,exports.CFFCharset=CFFCharset,exports.CFFTopDict=CFFTopDict,exports.CFFPrivateDict=CFFPrivateDict,exports.CFFCompiler=CFFCompiler,exports.CFFFDSelect=CFFFDSelect;