"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MessageHandler=void 0;var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_typeof="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"===typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},resolveCall=function(){var e=_asyncToGenerator(_regenerator2.default.mark((function e(t,s){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return _regenerator2.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:return e.abrupt("return",t.apply(r,s));case 3:case"end":return e.stop()}}),e,this)})));return function(t,s){return e.apply(this,arguments)}}(),_util=require("./util");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise((function(e,s){function r(a,n){try{var o=t[a](n),i=o.value}catch(l){return void s(l)}if(!o.done)return Promise.resolve(i).then((function(e){r("next",e)}),(function(e){r("throw",e)}));e(i)}return r("next")}))}}function wrapReason(e){if("object"!==("undefined"===typeof e?"undefined":_typeof(e)))return e;switch(e.name){case"AbortException":return new _util.AbortException(e.message);case"MissingPDFException":return new _util.MissingPDFException(e.message);case"UnexpectedResponseException":return new _util.UnexpectedResponseException(e.message,e.status);default:return new _util.UnknownErrorException(e.message,e.details)}}function makeReasonSerializable(e){return!(e instanceof Error)||e instanceof _util.AbortException||e instanceof _util.MissingPDFException||e instanceof _util.UnexpectedResponseException||e instanceof _util.UnknownErrorException?e:new _util.UnknownErrorException(e.message,e.toString())}function resolveOrReject(e,t,s){t?e.resolve():e.reject(s)}function finalize(e){return Promise.resolve(e).catch((function(){}))}function MessageHandler(e,t,s){var r=this;this.sourceName=e,this.targetName=t,this.comObj=s,this.callbackId=1,this.streamId=1,this.postMessageTransfers=!0,this.streamSinks=Object.create(null),this.streamControllers=Object.create(null);var a=this.callbacksCapabilities=Object.create(null),n=this.actionHandler=Object.create(null);this._onComObjOnMessage=function(e){var t=e.data;if(t.targetName===r.sourceName)if(t.stream)r._processStreamMessage(t);else if(t.isReply){var o=t.callbackId;if(!(t.callbackId in a))throw new Error("Cannot resolve callback "+o);var i=a[o];delete a[o],"error"in t?i.reject(wrapReason(t.error)):i.resolve(t.data)}else{if(!(t.action in n))throw new Error("Unknown action from worker: "+t.action);var l=n[t.action];if(t.callbackId){var c=r.sourceName,u=t.sourceName;Promise.resolve().then((function(){return l[0].call(l[1],t.data)})).then((function(e){s.postMessage({sourceName:c,targetName:u,isReply:!0,callbackId:t.callbackId,data:e})}),(function(e){s.postMessage({sourceName:c,targetName:u,isReply:!0,callbackId:t.callbackId,error:makeReasonSerializable(e)})}))}else t.streamId?r._createStreamSink(t):l[0].call(l[1],t.data)}},s.addEventListener("message",this._onComObjOnMessage)}MessageHandler.prototype={on:function(e,t,s){var r=this.actionHandler;if(r[e])throw new Error('There is already an actionName called "'+e+'"');r[e]=[t,s]},send:function(e,t,s){var r={sourceName:this.sourceName,targetName:this.targetName,action:e,data:t};this.postMessage(r,s)},sendWithPromise:function(e,t,s){var r=this.callbackId++,a={sourceName:this.sourceName,targetName:this.targetName,action:e,data:t,callbackId:r},n=(0,_util.createPromiseCapability)();this.callbacksCapabilities[r]=n;try{this.postMessage(a,s)}catch(o){n.reject(o)}return n.promise},sendWithStream:function(e,t,s,r){var a=this,n=this.streamId++,o=this.sourceName,i=this.targetName;return new _util.ReadableStream({start:function(s){var r=(0,_util.createPromiseCapability)();return a.streamControllers[n]={controller:s,startCall:r,isClosed:!1},a.postMessage({sourceName:o,targetName:i,action:e,streamId:n,data:t,desiredSize:s.desiredSize}),r.promise},pull:function(e){var t=(0,_util.createPromiseCapability)();return a.streamControllers[n].pullCall=t,a.postMessage({sourceName:o,targetName:i,stream:"pull",streamId:n,desiredSize:e.desiredSize}),t.promise},cancel:function(e){var t=(0,_util.createPromiseCapability)();return a.streamControllers[n].cancelCall=t,a.streamControllers[n].isClosed=!0,a.postMessage({sourceName:o,targetName:i,stream:"cancel",reason:e,streamId:n}),t.promise}},s)},_createStreamSink:function(e){var t=this,s=this,r=this.actionHandler[e.action],a=e.streamId,n=e.desiredSize,o=this.sourceName,i=e.sourceName,l=(0,_util.createPromiseCapability)(),c=function(e){var s=e.stream,r=e.chunk,n=e.transfers,l=e.success,c=e.reason;t.postMessage({sourceName:o,targetName:i,stream:s,streamId:a,chunk:r,success:l,reason:c},n)},u={enqueue:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,s=arguments[2];if(!this.isCancelled){var r=this.desiredSize;this.desiredSize-=t,r>0&&this.desiredSize<=0&&(this.sinkCapability=(0,_util.createPromiseCapability)(),this.ready=this.sinkCapability.promise),c({stream:"enqueue",chunk:e,transfers:s})}},close:function(){this.isCancelled||(this.isCancelled=!0,c({stream:"close"}),delete s.streamSinks[a])},error:function(e){this.isCancelled||(this.isCancelled=!0,c({stream:"error",reason:e}))},sinkCapability:l,onPull:null,onCancel:null,isCancelled:!1,desiredSize:n,ready:null};u.sinkCapability.resolve(),u.ready=u.sinkCapability.promise,this.streamSinks[a]=u,resolveCall(r[0],[e.data,u],r[1]).then((function(){c({stream:"start_complete",success:!0})}),(function(e){c({stream:"start_complete",success:!1,reason:e})}))},_processStreamMessage:function(e){var t=this,s=this.sourceName,r=e.sourceName,a=e.streamId,n=function(e){var n=e.stream,o=e.success,i=e.reason;t.comObj.postMessage({sourceName:s,targetName:r,stream:n,success:o,streamId:a,reason:i})},o=function(){Promise.all([t.streamControllers[e.streamId].startCall,t.streamControllers[e.streamId].pullCall,t.streamControllers[e.streamId].cancelCall].map((function(e){return e&&finalize(e.promise)}))).then((function(){delete t.streamControllers[e.streamId]}))};switch(e.stream){case"start_complete":resolveOrReject(this.streamControllers[e.streamId].startCall,e.success,wrapReason(e.reason));break;case"pull_complete":resolveOrReject(this.streamControllers[e.streamId].pullCall,e.success,wrapReason(e.reason));break;case"pull":if(!this.streamSinks[e.streamId]){n({stream:"pull_complete",success:!0});break}this.streamSinks[e.streamId].desiredSize<=0&&e.desiredSize>0&&this.streamSinks[e.streamId].sinkCapability.resolve(),this.streamSinks[e.streamId].desiredSize=e.desiredSize,resolveCall(this.streamSinks[e.streamId].onPull).then((function(){n({stream:"pull_complete",success:!0})}),(function(e){n({stream:"pull_complete",success:!1,reason:e})}));break;case"enqueue":(0,_util.assert)(this.streamControllers[e.streamId],"enqueue should have stream controller"),this.streamControllers[e.streamId].isClosed||this.streamControllers[e.streamId].controller.enqueue(e.chunk);break;case"close":if((0,_util.assert)(this.streamControllers[e.streamId],"close should have stream controller"),this.streamControllers[e.streamId].isClosed)break;this.streamControllers[e.streamId].isClosed=!0,this.streamControllers[e.streamId].controller.close(),o();break;case"error":(0,_util.assert)(this.streamControllers[e.streamId],"error should have stream controller"),this.streamControllers[e.streamId].controller.error(wrapReason(e.reason)),o();break;case"cancel_complete":resolveOrReject(this.streamControllers[e.streamId].cancelCall,e.success,wrapReason(e.reason)),o();break;case"cancel":if(!this.streamSinks[e.streamId])break;resolveCall(this.streamSinks[e.streamId].onCancel,[wrapReason(e.reason)]).then((function(){n({stream:"cancel_complete",success:!0})}),(function(e){n({stream:"cancel_complete",success:!1,reason:e})})),this.streamSinks[e.streamId].sinkCapability.reject(wrapReason(e.reason)),this.streamSinks[e.streamId].isCancelled=!0,delete this.streamSinks[e.streamId];break;default:throw new Error("Unexpected stream case")}},postMessage:function(e,t){t&&this.postMessageTransfers?this.comObj.postMessage(e,t):this.comObj.postMessage(e)},destroy:function(){this.comObj.removeEventListener("message",this._onComObjOnMessage)}},exports.MessageHandler=MessageHandler;