"use strict";var _slicedToArray=function(){function e(e,t){var r=[],n=!0,a=!1,i=void 0;try{for(var u,o=e[Symbol.iterator]();!(n=(u=o.next()).done);n=!0)if(r.push(u.value),t&&r.length===t)break}catch(l){a=!0,i=l}finally{try{!n&&o["return"]&&o["return"]()}finally{if(a)throw i}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_util=require("../../shared/util"),_is_node=require("../../shared/is_node"),_is_node2=_interopRequireDefault(_is_node),_node_stream=require("../../display/node_stream");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}(0,_util.assert)((0,_is_node2.default)());var path=require("path"),url=require("url"),http=require("http"),fs=require("fs");describe("node_stream",(function(){var e=null,t=null,r=url.parse(encodeURI("file://"+path.join(process.cwd(),"./test/pdfs/tracemonkey.pdf"))).href,n=1016315;beforeAll((function(r){e=http.createServer((function(e,t){var r=process.cwd()+"/test/pdfs"+e.url;fs.lstat(r,(function(n,a){if(n)return t.writeHead(404),void t.end("File "+e.url+" not found!");if(e.headers["range"]){var i=e.headers["range"].split("=")[1].split("-").map((function(e){return Number(e)})),u=_slicedToArray(i,2),o=u[0],l=u[1],d=fs.createReadStream(r,{start:o,end:l});t.writeHead(206,{"Content-Type":"application/pdf"}),d.pipe(t)}else{var s=a.size,c=fs.createReadStream(r);t.writeHead(200,{"Content-Type":"application/pdf","Content-Length":s,"Accept-Ranges":"bytes"}),c.pipe(t)}}))})).listen(0),t=e.address().port,r()})),afterAll((function(t){e.close(),t()})),it("read both http(s) and filesystem pdf files",(function(e){var a=new _node_stream.PDFNodeStream({url:"http://127.0.0.1:"+t+"/tracemonkey.pdf",rangeChunkSize:65536,disableStream:!0,disableRange:!0}),i=new _node_stream.PDFNodeStream({url:r,rangeChunkSize:65536,disableStream:!0,disableRange:!0}),u=a.getFullReader(),o=i.getFullReader(),l=void 0,d=void 0,s=u.headersReady.then((function(){l=u.isStreamingSupported,d=u.isRangeSupported})),c=void 0,p=void 0,f=o.headersReady.then((function(){c=o.isStreamingSupported,p=o.isRangeSupported})),h=0,g=0,v=function e(){return u.read().then((function(t){if(!t.done)return h+=t.value.byteLength,e()}))},m=function e(){return o.read().then((function(t){if(!t.done)return g+=t.value.byteLength,e()}))},R=Promise.all([v(),m(),s,f]);R.then((function(t){expect(l).toEqual(!1),expect(d).toEqual(!1),expect(c).toEqual(!1),expect(p).toEqual(!1),expect(h).toEqual(n),expect(h).toEqual(g),e()})).catch((function(t){e.fail(t)}))})),it("read custom ranges for both http(s) and filesystem urls",(function(e){var a=32768,i=new _node_stream.PDFNodeStream({url:"http://127.0.0.1:"+t+"/tracemonkey.pdf",length:n,rangeChunkSize:a,disableStream:!0,disableRange:!1}),u=new _node_stream.PDFNodeStream({url:r,length:n,rangeChunkSize:a,disableStream:!0,disableRange:!1}),o=i.getFullReader(),l=u.getFullReader(),d=void 0,s=void 0,c=void 0,p=void 0,f=void 0,h=void 0,g=o.headersReady.then((function(){d=o.isStreamingSupported,s=o.isRangeSupported,o.cancel("Don't need full reader"),c=!0})),v=l.headersReady.then((function(){p=l.isStreamingSupported,f=l.isRangeSupported,l.cancel("Don't need full reader"),h=!0})),m=n%a||a,R=i.getRangeReader(n-m-a,n-m),S=i.getRangeReader(n-m,n),_=u.getRangeReader(n-m-a,n-m),y=u.getRangeReader(n-m,n),q={value:0},b={value:0},x={value:0},E={value:0},w=function e(t,r){return t.read().then((function(n){if(!n.done)return r.value+=n.value.byteLength,e(t,r)}))},F=Promise.all([w(R,q),w(S,b),w(_,x),w(y,E),g,v]);F.then((function(){expect(q.value).toEqual(a),expect(b.value).toEqual(m),expect(x.value).toEqual(a),expect(E.value).toEqual(m),expect(d).toEqual(!1),expect(s).toEqual(!0),expect(c).toEqual(!0),expect(p).toEqual(!1),expect(f).toEqual(!0),expect(h).toEqual(!0),e()})).catch((function(t){e.fail(t)}))}))}));