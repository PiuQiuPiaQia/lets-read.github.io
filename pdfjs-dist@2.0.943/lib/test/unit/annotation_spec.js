"use strict";var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),_annotation=require("../../core/annotation"),_util=require("../../shared/util"),_primitives=require("../../core/primitives"),_parser=require("../../core/parser"),_stream=require("../../core/stream"),_test_utils=require("./test_utils");function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}describe("annotation",(function(){var t=function(){function t(e){_classCallCheck(this,t),this.docBaseUrl=e.docBaseUrl||null}return _createClass(t,[{key:"ensure",value:function(t,e,n){return new Promise((function(i){var a=t[e];i("function"===typeof a?a.apply(t,n):a)}))}}]),t}(),e=function(){function t(e){_classCallCheck(this,t),this.uniquePrefix=e.prefix||"p0_",this.idCounters={obj:e.startObjId||0}}return _createClass(t,[{key:"createObjId",value:function(){return this.uniquePrefix+ ++this.idCounters.obj}}]),t}(),n=void 0,i=void 0;beforeAll((function(a){n=new t({docBaseUrl:null}),i=new e({}),a()})),afterAll((function(){n=null,i=null})),describe("AnnotationFactory",(function(){it("should get id for annotation",(function(t){var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Annot")),e.set("Subtype",_primitives.Name.get("Link"));var a=new _primitives.Ref(10,0),o=new _test_utils.XRefMock([{ref:a,data:e}]);_annotation.AnnotationFactory.create(o,a,n,i).then((function(e){var n=e.data;expect(n.annotationType).toEqual(_util.AnnotationType.LINK),expect(n.id).toEqual("10R"),t()}),t.fail)})),it("should handle, and get fallback IDs for, annotations that are not indirect objects (issue 7569)",(function(t){var i=new _primitives.Dict;i.set("Type",_primitives.Name.get("Annot")),i.set("Subtype",_primitives.Name.get("Link"));var a=new _test_utils.XRefMock,o=new e({prefix:"p0_",startObjId:0}),r=_annotation.AnnotationFactory.create(a,i,n,o).then((function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.LINK),expect(e.id).toEqual("annot_p0_1")})),s=_annotation.AnnotationFactory.create(a,i,n,o).then((function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.LINK),expect(e.id).toEqual("annot_p0_2")}));Promise.all([r,s]).then(t,t.fail)})),it("should handle missing /Subtype",(function(t){var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Annot"));var a=new _primitives.Ref(1,0),o=new _test_utils.XRefMock([{ref:a,data:e}]);_annotation.AnnotationFactory.create(o,a,n,i).then((function(e){var n=e.data;expect(n.annotationType).toBeUndefined(),t()}),t.fail)}))})),describe("Annotation",(function(){var t=void 0,e=void 0;beforeAll((function(n){t=new _primitives.Dict,e=new _primitives.Ref(1,0),n()})),afterAll((function(){t=e=null})),it("should set and get flags",(function(){var n=new _annotation.Annotation({dict:t,ref:e});n.setFlags(13),expect(n.hasFlag(_util.AnnotationFlag.INVISIBLE)).toEqual(!0),expect(n.hasFlag(_util.AnnotationFlag.NOZOOM)).toEqual(!0),expect(n.hasFlag(_util.AnnotationFlag.PRINT)).toEqual(!0),expect(n.hasFlag(_util.AnnotationFlag.READONLY)).toEqual(!1)})),it("should be viewable and not printable by default",(function(){var n=new _annotation.Annotation({dict:t,ref:e});expect(n.viewable).toEqual(!0),expect(n.printable).toEqual(!1)})),it("should set and get a valid rectangle",(function(){var n=new _annotation.Annotation({dict:t,ref:e});n.setRectangle([117,694,164.298,720]),expect(n.rectangle).toEqual([117,694,164.298,720])})),it("should not set and get an invalid rectangle",(function(){var n=new _annotation.Annotation({dict:t,ref:e});n.setRectangle([117,694,164.298]),expect(n.rectangle).toEqual([0,0,0,0])})),it("should reject a color if it is not an array",(function(){var n=new _annotation.Annotation({dict:t,ref:e});n.setColor("red"),expect(n.color).toEqual(new Uint8ClampedArray([0,0,0]))})),it("should set and get a transparent color",(function(){var n=new _annotation.Annotation({dict:t,ref:e});n.setColor([]),expect(n.color).toEqual(null)})),it("should set and get a grayscale color",(function(){var n=new _annotation.Annotation({dict:t,ref:e});n.setColor([.4]),expect(n.color).toEqual(new Uint8ClampedArray([102,102,102]))})),it("should set and get an RGB color",(function(){var n=new _annotation.Annotation({dict:t,ref:e});n.setColor([0,0,1]),expect(n.color).toEqual(new Uint8ClampedArray([0,0,255]))})),it("should set and get a CMYK color",(function(){var n=new _annotation.Annotation({dict:t,ref:e});n.setColor([.1,.92,.84,.02]),expect(n.color).toEqual(new Uint8ClampedArray([234,59,48]))})),it("should not set and get an invalid color",(function(){var n=new _annotation.Annotation({dict:t,ref:e});n.setColor([.4,.6]),expect(n.color).toEqual(new Uint8ClampedArray([0,0,0]))}))})),describe("AnnotationBorderStyle",(function(){it("should set and get a valid width",(function(){var t=new _annotation.AnnotationBorderStyle;t.setWidth(3),expect(t.width).toEqual(3)})),it("should not set and get an invalid width",(function(){var t=new _annotation.AnnotationBorderStyle;t.setWidth("three"),expect(t.width).toEqual(1)})),it("should set and get a valid style",(function(){var t=new _annotation.AnnotationBorderStyle;t.setStyle(_primitives.Name.get("D")),expect(t.style).toEqual(_util.AnnotationBorderStyleType.DASHED)})),it("should not set and get an invalid style",(function(){var t=new _annotation.AnnotationBorderStyle;t.setStyle("Dashed"),expect(t.style).toEqual(_util.AnnotationBorderStyleType.SOLID)})),it("should set and get a valid dash array",(function(){var t=new _annotation.AnnotationBorderStyle;t.setDashArray([1,2,3]),expect(t.dashArray).toEqual([1,2,3])})),it("should not set and get an invalid dash array",(function(){var t=new _annotation.AnnotationBorderStyle;t.setDashArray([0,0]),expect(t.dashArray).toEqual([3])})),it("should set and get a valid horizontal corner radius",(function(){var t=new _annotation.AnnotationBorderStyle;t.setHorizontalCornerRadius(3),expect(t.horizontalCornerRadius).toEqual(3)})),it("should not set and get an invalid horizontal corner radius",(function(){var t=new _annotation.AnnotationBorderStyle;t.setHorizontalCornerRadius("three"),expect(t.horizontalCornerRadius).toEqual(0)})),it("should set and get a valid vertical corner radius",(function(){var t=new _annotation.AnnotationBorderStyle;t.setVerticalCornerRadius(3),expect(t.verticalCornerRadius).toEqual(3)})),it("should not set and get an invalid vertical corner radius",(function(){var t=new _annotation.AnnotationBorderStyle;t.setVerticalCornerRadius("three"),expect(t.verticalCornerRadius).toEqual(0)}))})),describe("LinkAnnotation",(function(){it("should correctly parse a URI action",(function(t){var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Action")),e.set("S",_primitives.Name.get("URI")),e.set("URI","http://www.ctan.org/tex-archive/info/lshort");var a=new _primitives.Dict;a.set("Type",_primitives.Name.get("Annot")),a.set("Subtype",_primitives.Name.get("Link")),a.set("A",e);var o=new _primitives.Ref(820,0),r=new _test_utils.XRefMock([{ref:o,data:a}]);_annotation.AnnotationFactory.create(r,o,n,i).then((function(e){var n=e.data;expect(n.annotationType).toEqual(_util.AnnotationType.LINK),expect(n.url).toEqual("http://www.ctan.org/tex-archive/info/lshort"),expect(n.unsafeUrl).toEqual("http://www.ctan.org/tex-archive/info/lshort"),expect(n.dest).toBeUndefined(),t()}),t.fail)})),it("should correctly parse a URI action, where the URI entry is missing a protocol",(function(t){var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Action")),e.set("S",_primitives.Name.get("URI")),e.set("URI","www.hmrc.gov.uk");var a=new _primitives.Dict;a.set("Type",_primitives.Name.get("Annot")),a.set("Subtype",_primitives.Name.get("Link")),a.set("A",e);var o=new _primitives.Ref(353,0),r=new _test_utils.XRefMock([{ref:o,data:a}]);_annotation.AnnotationFactory.create(r,o,n,i).then((function(e){var n=e.data;expect(n.annotationType).toEqual(_util.AnnotationType.LINK),expect(n.url).toEqual("http://www.hmrc.gov.uk/"),expect(n.unsafeUrl).toEqual("http://www.hmrc.gov.uk"),expect(n.dest).toBeUndefined(),t()}),t.fail)})),it("should correctly parse a URI action, where the URI entry has an incorrect encoding (bug 1122280)",(function(t){var e=new _stream.StringStream("<<\n/Type /Action\n/S /URI\n/URI (http://www.example.com/\\303\\274\\303\\266\\303\\244)\n>>\n"),a=new _parser.Lexer(e),o=new _parser.Parser(a),r=o.getObj(),s=new _primitives.Dict;s.set("Type",_primitives.Name.get("Annot")),s.set("Subtype",_primitives.Name.get("Link")),s.set("A",r);var l=new _primitives.Ref(8,0),c=new _test_utils.XRefMock([{ref:l,data:s}]);_annotation.AnnotationFactory.create(c,l,n,i).then((function(e){var n=e.data;expect(n.annotationType).toEqual(_util.AnnotationType.LINK),expect(n.url).toEqual(new URL((0,_util.stringToUTF8String)("http://www.example.com/\xc3\xbc\xc3\xb6\xc3\xa4")).href),expect(n.unsafeUrl).toEqual((0,_util.stringToUTF8String)("http://www.example.com/\xc3\xbc\xc3\xb6\xc3\xa4")),expect(n.dest).toBeUndefined(),t()}),t.fail)})),it("should correctly parse a GoTo action",(function(t){var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Action")),e.set("S",_primitives.Name.get("GoTo")),e.set("D","page.157");var a=new _primitives.Dict;a.set("Type",_primitives.Name.get("Annot")),a.set("Subtype",_primitives.Name.get("Link")),a.set("A",e);var o=new _primitives.Ref(798,0),r=new _test_utils.XRefMock([{ref:o,data:a}]);_annotation.AnnotationFactory.create(r,o,n,i).then((function(e){var n=e.data;expect(n.annotationType).toEqual(_util.AnnotationType.LINK),expect(n.url).toBeUndefined(),expect(n.unsafeUrl).toBeUndefined(),expect(n.dest).toEqual("page.157"),t()}),t.fail)})),it("should correctly parse a GoToR action, where the FileSpec entry is a string containing a relative URL",(function(t){var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Action")),e.set("S",_primitives.Name.get("GoToR")),e.set("F","../../0013/001346/134685E.pdf"),e.set("D","4.3"),e.set("NewWindow",!0);var a=new _primitives.Dict;a.set("Type",_primitives.Name.get("Annot")),a.set("Subtype",_primitives.Name.get("Link")),a.set("A",e);var o=new _primitives.Ref(489,0),r=new _test_utils.XRefMock([{ref:o,data:a}]);_annotation.AnnotationFactory.create(r,o,n,i).then((function(e){var n=e.data;expect(n.annotationType).toEqual(_util.AnnotationType.LINK),expect(n.url).toBeUndefined(),expect(n.unsafeUrl).toEqual("../../0013/001346/134685E.pdf#4.3"),expect(n.dest).toBeUndefined(),expect(n.newWindow).toEqual(!0),t()}),t.fail)})),it('should correctly parse a GoToR action, containing a relative URL, with the "docBaseUrl" parameter specified',(function(e){var n=new _primitives.Dict;n.set("Type",_primitives.Name.get("Action")),n.set("S",_primitives.Name.get("GoToR")),n.set("F","../../0013/001346/134685E.pdf"),n.set("D","4.3");var a=new _primitives.Dict;a.set("Type",_primitives.Name.get("Annot")),a.set("Subtype",_primitives.Name.get("Link")),a.set("A",n);var o=new _primitives.Ref(489,0),r=new _test_utils.XRefMock([{ref:o,data:a}]),s=new t({docBaseUrl:"http://www.example.com/test/pdfs/qwerty.pdf"});_annotation.AnnotationFactory.create(r,o,s,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.LINK),expect(n.url).toEqual("http://www.example.com/0013/001346/134685E.pdf#4.3"),expect(n.unsafeUrl).toEqual("../../0013/001346/134685E.pdf#4.3"),expect(n.dest).toBeUndefined(),e()}),e.fail)})),it("should correctly parse a GoToR action, with named destination",(function(t){var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Action")),e.set("S",_primitives.Name.get("GoToR")),e.set("F","http://www.example.com/test.pdf"),e.set("D","15");var a=new _primitives.Dict;a.set("Type",_primitives.Name.get("Annot")),a.set("Subtype",_primitives.Name.get("Link")),a.set("A",e);var o=new _primitives.Ref(495,0),r=new _test_utils.XRefMock([{ref:o,data:a}]);_annotation.AnnotationFactory.create(r,o,n,i).then((function(e){var n=e.data;expect(n.annotationType).toEqual(_util.AnnotationType.LINK),expect(n.url).toEqual("http://www.example.com/test.pdf#15"),expect(n.unsafeUrl).toEqual("http://www.example.com/test.pdf#15"),expect(n.dest).toBeUndefined(),expect(n.newWindow).toBeFalsy(),t()}),t.fail)})),it("should correctly parse a GoToR action, with explicit destination array",(function(t){var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Action")),e.set("S",_primitives.Name.get("GoToR")),e.set("F","http://www.example.com/test.pdf"),e.set("D",[14,_primitives.Name.get("XYZ"),null,298.043,null]);var a=new _primitives.Dict;a.set("Type",_primitives.Name.get("Annot")),a.set("Subtype",_primitives.Name.get("Link")),a.set("A",e);var o=new _primitives.Ref(489,0),r=new _test_utils.XRefMock([{ref:o,data:a}]);_annotation.AnnotationFactory.create(r,o,n,i).then((function(e){var n=e.data;expect(n.annotationType).toEqual(_util.AnnotationType.LINK),expect(n.url).toEqual(new URL('http://www.example.com/test.pdf#[14,{"name":"XYZ"},null,298.043,null]').href),expect(n.unsafeUrl).toEqual('http://www.example.com/test.pdf#[14,{"name":"XYZ"},null,298.043,null]'),expect(n.dest).toBeUndefined(),expect(n.newWindow).toBeFalsy(),t()}),t.fail)})),it('should correctly parse a Launch action, where the FileSpec dict contains a relative URL, with the "docBaseUrl" parameter specified',(function(e){var n=new _primitives.Dict;n.set("Type",_primitives.Name.get("FileSpec")),n.set("F","Part II/Part II.pdf"),n.set("UF","Part II/Part II.pdf");var a=new _primitives.Dict;a.set("Type",_primitives.Name.get("Action")),a.set("S",_primitives.Name.get("Launch")),a.set("F",n),a.set("NewWindow",!0);var o=new _primitives.Dict;o.set("Type",_primitives.Name.get("Annot")),o.set("Subtype",_primitives.Name.get("Link")),o.set("A",a);var r=new _primitives.Ref(88,0),s=new _test_utils.XRefMock([{ref:r,data:o}]),l=new t({docBaseUrl:"http://www.example.com/test/pdfs/qwerty.pdf"});_annotation.AnnotationFactory.create(s,r,l,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.LINK),expect(n.url).toEqual(new URL("http://www.example.com/test/pdfs/Part II/Part II.pdf").href),expect(n.unsafeUrl).toEqual("Part II/Part II.pdf"),expect(n.dest).toBeUndefined(),expect(n.newWindow).toEqual(!0),e()}),e.fail)})),it("should recover valid URLs from JavaScript actions having certain white-listed formats",(function(t){function e(t){var e=t.jsEntry,a=t.expectedUrl,o=t.expectedUnsafeUrl,r=t.expectedNewWindow,s=new _primitives.Dict;s.set("Type",_primitives.Name.get("Action")),s.set("S",_primitives.Name.get("JavaScript")),s.set("JS",e);var l=new _primitives.Dict;l.set("Type",_primitives.Name.get("Annot")),l.set("Subtype",_primitives.Name.get("Link")),l.set("A",s);var c=new _primitives.Ref(46,0),p=new _test_utils.XRefMock([{ref:c,data:l}]);return _annotation.AnnotationFactory.create(p,c,n,i).then((function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.LINK),expect(e.url).toEqual(a),expect(e.unsafeUrl).toEqual(o),expect(e.dest).toBeUndefined(),expect(e.newWindow).toEqual(r)}))}var a=e({jsEntry:'function someFun() { return "qwerty"; } someFun();',expectedUrl:void 0,expectedUnsafeUrl:void 0,expectedNewWindow:void 0}),o=e({jsEntry:"window.open('http://www.example.com/test.pdf')",expectedUrl:new URL("http://www.example.com/test.pdf").href,expectedUnsafeUrl:"http://www.example.com/test.pdf",expectedNewWindow:void 0}),r=e({jsEntry:new _stream.StringStream('app.launchURL("http://www.example.com/test.pdf", true)'),expectedUrl:new URL("http://www.example.com/test.pdf").href,expectedUnsafeUrl:"http://www.example.com/test.pdf",expectedNewWindow:!0});Promise.all([a,o,r]).then(t,t.fail)})),it("should correctly parse a Named action",(function(t){var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Action")),e.set("S",_primitives.Name.get("Named")),e.set("N",_primitives.Name.get("GoToPage"));var a=new _primitives.Dict;a.set("Type",_primitives.Name.get("Annot")),a.set("Subtype",_primitives.Name.get("Link")),a.set("A",e);var o=new _primitives.Ref(12,0),r=new _test_utils.XRefMock([{ref:o,data:a}]);_annotation.AnnotationFactory.create(r,o,n,i).then((function(e){var n=e.data;expect(n.annotationType).toEqual(_util.AnnotationType.LINK),expect(n.url).toBeUndefined(),expect(n.unsafeUrl).toBeUndefined(),expect(n.action).toEqual("GoToPage"),t()}),t.fail)})),it("should correctly parse a simple Dest",(function(t){var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Annot")),e.set("Subtype",_primitives.Name.get("Link")),e.set("Dest",_primitives.Name.get("LI0"));var a=new _primitives.Ref(583,0),o=new _test_utils.XRefMock([{ref:a,data:e}]);_annotation.AnnotationFactory.create(o,a,n,i).then((function(e){var n=e.data;expect(n.annotationType).toEqual(_util.AnnotationType.LINK),expect(n.url).toBeUndefined(),expect(n.unsafeUrl).toBeUndefined(),expect(n.dest).toEqual("LI0"),t()}),t.fail)})),it("should correctly parse a simple Dest, with explicit destination array",(function(t){var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Annot")),e.set("Subtype",_primitives.Name.get("Link")),e.set("Dest",[new _primitives.Ref(17,0),_primitives.Name.get("XYZ"),0,841.89,null]);var a=new _primitives.Ref(10,0),o=new _test_utils.XRefMock([{ref:a,data:e}]);_annotation.AnnotationFactory.create(o,a,n,i).then((function(e){var n=e.data;expect(n.annotationType).toEqual(_util.AnnotationType.LINK),expect(n.url).toBeUndefined(),expect(n.unsafeUrl).toBeUndefined(),expect(n.dest).toEqual([{num:17,gen:0},{name:"XYZ"},0,841.89,null]),t()}),t.fail)})),it("should correctly parse a Dest, which violates the specification by containing a dictionary",(function(t){var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Action")),e.set("S",_primitives.Name.get("GoTo")),e.set("D","page.157");var a=new _primitives.Dict;a.set("Type",_primitives.Name.get("Annot")),a.set("Subtype",_primitives.Name.get("Link")),a.set("Dest",e);var o=new _primitives.Ref(798,0),r=new _test_utils.XRefMock([{ref:o,data:a}]);_annotation.AnnotationFactory.create(r,o,n,i).then((function(e){var n=e.data;expect(n.annotationType).toEqual(_util.AnnotationType.LINK),expect(n.url).toBeUndefined(),expect(n.unsafeUrl).toBeUndefined(),expect(n.dest).toEqual("page.157"),t()}),t.fail)}))})),describe("WidgetAnnotation",(function(){var t=void 0;beforeEach((function(e){t=new _primitives.Dict,t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Widget")),e()})),afterEach((function(){t=null})),it("should handle unknown field names",(function(e){var a=new _primitives.Ref(20,0),o=new _test_utils.XRefMock([{ref:a,data:t}]);_annotation.AnnotationFactory.create(o,a,n,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(n.fieldName).toEqual(""),e()}),e.fail)})),it("should construct the field name when there are no ancestors",(function(e){t.set("T","foo");var a=new _primitives.Ref(21,0),o=new _test_utils.XRefMock([{ref:a,data:t}]);_annotation.AnnotationFactory.create(o,a,n,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(n.fieldName).toEqual("foo"),e()}),e.fail)})),it("should construct the field name when there are ancestors",(function(e){var a=new _primitives.Dict;a.set("T","foo");var o=new _primitives.Dict;o.set("Parent",a),o.set("T","bar"),t.set("Parent",o),t.set("T","baz");var r=new _primitives.Ref(22,0),s=new _test_utils.XRefMock([{ref:r,data:t}]);_annotation.AnnotationFactory.create(s,r,n,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(n.fieldName).toEqual("foo.bar.baz"),e()}),e.fail)})),it("should construct the field name if a parent is not a dictionary (issue 8143)",(function(e){var a=new _primitives.Dict;a.set("Parent",null),a.set("T","foo"),t.set("Parent",a),t.set("T","bar");var o=new _primitives.Ref(22,0),r=new _test_utils.XRefMock([{ref:o,data:t}]);_annotation.AnnotationFactory.create(r,o,n,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(n.fieldName).toEqual("foo.bar"),e()}),e.fail)}))})),describe("TextWidgetAnnotation",(function(){var t=void 0;beforeEach((function(e){t=new _primitives.Dict,t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Widget")),t.set("FT",_primitives.Name.get("Tx")),e()})),afterEach((function(){t=null})),it("should handle unknown text alignment, maximum length and flags",(function(e){var a=new _primitives.Ref(124,0),o=new _test_utils.XRefMock([{ref:a,data:t}]);_annotation.AnnotationFactory.create(o,a,n,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(n.textAlignment).toEqual(null),expect(n.maxLen).toEqual(null),expect(n.readOnly).toEqual(!1),expect(n.multiLine).toEqual(!1),expect(n.comb).toEqual(!1),e()}),e.fail)})),it("should not set invalid text alignment, maximum length and flags",(function(e){t.set("Q","center"),t.set("MaxLen","five"),t.set("Ff","readonly");var a=new _primitives.Ref(43,0),o=new _test_utils.XRefMock([{ref:a,data:t}]);_annotation.AnnotationFactory.create(o,a,n,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(n.textAlignment).toEqual(null),expect(n.maxLen).toEqual(null),expect(n.readOnly).toEqual(!1),expect(n.multiLine).toEqual(!1),expect(n.comb).toEqual(!1),e()}),e.fail)})),it("should set valid text alignment, maximum length and flags",(function(e){t.set("Q",1),t.set("MaxLen",20),t.set("Ff",_util.AnnotationFieldFlag.READONLY+_util.AnnotationFieldFlag.MULTILINE);var a=new _primitives.Ref(84,0),o=new _test_utils.XRefMock([{ref:a,data:t}]);_annotation.AnnotationFactory.create(o,a,n,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(n.textAlignment).toEqual(1),expect(n.maxLen).toEqual(20),expect(n.readOnly).toEqual(!0),expect(n.multiLine).toEqual(!0),e()}),e.fail)})),it("should reject comb fields without a maximum length",(function(e){t.set("Ff",_util.AnnotationFieldFlag.COMB);var a=new _primitives.Ref(46,0),o=new _test_utils.XRefMock([{ref:a,data:t}]);_annotation.AnnotationFactory.create(o,a,n,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(n.comb).toEqual(!1),e()}),e.fail)})),it("should accept comb fields with a maximum length",(function(e){t.set("MaxLen",20),t.set("Ff",_util.AnnotationFieldFlag.COMB);var a=new _primitives.Ref(46,0),o=new _test_utils.XRefMock([{ref:a,data:t}]);_annotation.AnnotationFactory.create(o,a,n,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(n.comb).toEqual(!0),e()}),e.fail)})),it("should only accept comb fields when the flags are valid",(function(e){for(var a=[_util.AnnotationFieldFlag.MULTILINE,_util.AnnotationFieldFlag.PASSWORD,_util.AnnotationFieldFlag.FILESELECT],o=_util.AnnotationFieldFlag.COMB+_util.AnnotationFieldFlag.MULTILINE+_util.AnnotationFieldFlag.PASSWORD+_util.AnnotationFieldFlag.FILESELECT,r=Promise.resolve(),s=0,l=a.length;s<=l;s++)r=r.then((function(){t.set("MaxLen",20),t.set("Ff",o);var e=new _primitives.Ref(93,0),r=new _test_utils.XRefMock([{ref:e,data:t}]);return _annotation.AnnotationFactory.create(r,e,n,i).then((function(t){var e=t.data;expect(e.annotationType).toEqual(_util.AnnotationType.WIDGET);var n=0===a.length;expect(e.comb).toEqual(n),n||(o-=a.pop())}))}));r.then(e,e.fail)}))})),describe("ButtonWidgetAnnotation",(function(){var t=void 0;beforeEach((function(e){t=new _primitives.Dict,t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Widget")),t.set("FT",_primitives.Name.get("Btn")),e()})),afterEach((function(){t=null})),it("should handle checkboxes with export value",(function(e){t.set("V",_primitives.Name.get("1"));var a=new _primitives.Dict,o=new _primitives.Dict;o.set("Off",0),o.set("Checked",1),a.set("D",o),t.set("AP",a);var r=new _primitives.Ref(124,0),s=new _test_utils.XRefMock([{ref:r,data:t}]);_annotation.AnnotationFactory.create(s,r,n,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(n.checkBox).toEqual(!0),expect(n.fieldValue).toEqual("1"),expect(n.radioButton).toEqual(!1),expect(n.exportValue).toEqual("Checked"),e()}),e.fail)})),it("should handle checkboxes without export value",(function(e){t.set("V",_primitives.Name.get("1"));var a=new _primitives.Ref(124,0),o=new _test_utils.XRefMock([{ref:a,data:t}]);_annotation.AnnotationFactory.create(o,a,n,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(n.checkBox).toEqual(!0),expect(n.fieldValue).toEqual("1"),expect(n.radioButton).toEqual(!1),e()}),e.fail)})),it("should handle radio buttons with a field value",(function(e){var a=new _primitives.Dict;a.set("V",_primitives.Name.get("1"));var o=new _primitives.Dict;o.set("2",null);var r=new _primitives.Dict;r.set("N",o),t.set("Ff",_util.AnnotationFieldFlag.RADIO),t.set("Parent",a),t.set("AP",r);var s=new _primitives.Ref(124,0),l=new _test_utils.XRefMock([{ref:s,data:t}]);_annotation.AnnotationFactory.create(l,s,n,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(n.checkBox).toEqual(!1),expect(n.radioButton).toEqual(!0),expect(n.fieldValue).toEqual("1"),expect(n.buttonValue).toEqual("2"),e()}),e.fail)})),it("should handle radio buttons without a field value",(function(e){var a=new _primitives.Dict;a.set("2",null);var o=new _primitives.Dict;o.set("N",a),t.set("Ff",_util.AnnotationFieldFlag.RADIO),t.set("AP",o);var r=new _primitives.Ref(124,0),s=new _test_utils.XRefMock([{ref:r,data:t}]);_annotation.AnnotationFactory.create(s,r,n,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(n.checkBox).toEqual(!1),expect(n.radioButton).toEqual(!0),expect(n.fieldValue).toEqual(null),expect(n.buttonValue).toEqual("2"),e()}),e.fail)}))})),describe("ChoiceWidgetAnnotation",(function(){var t=void 0;beforeEach((function(e){t=new _primitives.Dict,t.set("Type",_primitives.Name.get("Annot")),t.set("Subtype",_primitives.Name.get("Widget")),t.set("FT",_primitives.Name.get("Ch")),e()})),afterEach((function(){t=null})),it("should handle missing option arrays",(function(e){var a=new _primitives.Ref(122,0),o=new _test_utils.XRefMock([{ref:a,data:t}]);_annotation.AnnotationFactory.create(o,a,n,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(n.options).toEqual([]),e()}),e.fail)})),it("should handle option arrays with array elements",(function(e){var a=new _primitives.Ref(20,0),o="Bar",r=new _primitives.Ref(10,0),s=["bar_export",a],l=[["foo_export","Foo"],r],c=[{exportValue:"foo_export",displayValue:"Foo"},{exportValue:"bar_export",displayValue:"Bar"}];t.set("Opt",l);var p=new _primitives.Ref(123,0),u=new _test_utils.XRefMock([{ref:p,data:t},{ref:a,data:o},{ref:r,data:s}]);_annotation.AnnotationFactory.create(u,p,n,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(n.options).toEqual(c),e()}),e.fail)})),it("should handle option arrays with string elements",(function(e){var a=new _primitives.Ref(10,0),o="Bar",r=["Foo",a],s=[{exportValue:"Foo",displayValue:"Foo"},{exportValue:"Bar",displayValue:"Bar"}];t.set("Opt",r);var l=new _primitives.Ref(981,0),c=new _test_utils.XRefMock([{ref:l,data:t},{ref:a,data:o}]);_annotation.AnnotationFactory.create(c,l,n,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(n.options).toEqual(s),e()}),e.fail)})),it("should handle inherited option arrays (issue 8094)",(function(e){var a=[["Value1","Description1"],["Value2","Description2"]],o=[{exportValue:"Value1",displayValue:"Description1"},{exportValue:"Value2",displayValue:"Description2"}],r=new _primitives.Dict;r.set("Opt",a),t.set("Parent",r);var s=new _primitives.Ref(123,0),l=new _test_utils.XRefMock([{ref:s,data:t}]);_annotation.AnnotationFactory.create(l,s,n,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(n.options).toEqual(o),e()}),e.fail)})),it("should sanitize display values in option arrays (issue 8947)",(function(e){var a=["\xfe\xff\0F\0o\0o"],o=[{exportValue:"\xfe\xff\0F\0o\0o",displayValue:"Foo"}];t.set("Opt",a);var r=new _primitives.Ref(984,0),s=new _test_utils.XRefMock([{ref:r,data:t}]);_annotation.AnnotationFactory.create(s,r,n,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(n.options).toEqual(o),e()}),e.fail)})),it("should handle array field values",(function(e){var a=["Foo","Bar"];t.set("V",a);var o=new _primitives.Ref(968,0),r=new _test_utils.XRefMock([{ref:o,data:t}]);_annotation.AnnotationFactory.create(r,o,n,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(n.fieldValue).toEqual(a),e()}),e.fail)})),it("should handle string field values",(function(e){var a="Foo";t.set("V",a);var o=new _primitives.Ref(978,0),r=new _test_utils.XRefMock([{ref:o,data:t}]);_annotation.AnnotationFactory.create(r,o,n,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(n.fieldValue).toEqual([a]),e()}),e.fail)})),it("should handle unknown flags",(function(e){var a=new _primitives.Ref(166,0),o=new _test_utils.XRefMock([{ref:a,data:t}]);_annotation.AnnotationFactory.create(o,a,n,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(n.readOnly).toEqual(!1),expect(n.combo).toEqual(!1),expect(n.multiSelect).toEqual(!1),e()}),e.fail)})),it("should not set invalid flags",(function(e){t.set("Ff","readonly");var a=new _primitives.Ref(165,0),o=new _test_utils.XRefMock([{ref:a,data:t}]);_annotation.AnnotationFactory.create(o,a,n,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(n.readOnly).toEqual(!1),expect(n.combo).toEqual(!1),expect(n.multiSelect).toEqual(!1),e()}),e.fail)})),it("should set valid flags",(function(e){t.set("Ff",_util.AnnotationFieldFlag.READONLY+_util.AnnotationFieldFlag.COMBO+_util.AnnotationFieldFlag.MULTISELECT);var a=new _primitives.Ref(512,0),o=new _test_utils.XRefMock([{ref:a,data:t}]);_annotation.AnnotationFactory.create(o,a,n,i).then((function(t){var n=t.data;expect(n.annotationType).toEqual(_util.AnnotationType.WIDGET),expect(n.readOnly).toEqual(!0),expect(n.combo).toEqual(!0),expect(n.multiSelect).toEqual(!0),e()}),e.fail)}))})),describe("LineAnnotation",(function(){it("should set the line coordinates",(function(t){var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Annot")),e.set("Subtype",_primitives.Name.get("Line")),e.set("L",[1,2,3,4]);var a=new _primitives.Ref(122,0),o=new _test_utils.XRefMock([{ref:a,data:e}]);_annotation.AnnotationFactory.create(o,a,n,i).then((function(e){var n=e.data;expect(n.annotationType).toEqual(_util.AnnotationType.LINE),expect(n.lineCoordinates).toEqual([1,2,3,4]),t()}),t.fail)}))})),describe("FileAttachmentAnnotation",(function(){it("should correctly parse a file attachment",(function(t){var e=new _stream.StringStream("<<\n/Type /EmbeddedFile\n/Subtype /text#2Fplain\n>>\nstream\nTest attachmentendstream\n"),a=new _parser.Lexer(e),o=new _parser.Parser(a,!0),r=new _primitives.Ref(18,0),s=o.getObj(),l=new _primitives.Dict;l.set("F",r);var c=new _primitives.Ref(19,0),p=new _primitives.Dict;p.set("Type",_primitives.Name.get("Filespec")),p.set("Desc",""),p.set("EF",l),p.set("UF","Test.txt");var u=new _primitives.Ref(20,0),f=new _primitives.Dict;f.set("Type",_primitives.Name.get("Annot")),f.set("Subtype",_primitives.Name.get("FileAttachment")),f.set("FS",c),f.set("T","Topic"),f.set("Contents","Test.txt");var d=new _test_utils.XRefMock([{ref:r,data:s},{ref:c,data:p},{ref:u,data:f}]);l.assignXref(d),p.assignXref(d),f.assignXref(d),_annotation.AnnotationFactory.create(d,u,n,i).then((function(e){var n=e.data;expect(n.annotationType).toEqual(_util.AnnotationType.FILEATTACHMENT),expect(n.file.filename).toEqual("Test.txt"),expect(n.file.content).toEqual((0,_util.stringToBytes)("Test attachment")),t()}),t.fail)}))})),describe("PopupAnnotation",(function(){it("should inherit the parent flags when the Popup is not viewable, but the parent is (PR 7352)",(function(t){var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Annot")),e.set("Subtype",_primitives.Name.get("Text")),e.set("F",28);var a=new _primitives.Dict;a.set("Type",_primitives.Name.get("Annot")),a.set("Subtype",_primitives.Name.get("Popup")),a.set("F",25),a.set("Parent",e);var o=new _primitives.Ref(13,0),r=new _test_utils.XRefMock([{ref:o,data:a}]);_annotation.AnnotationFactory.create(r,o,n,i).then((function(e){var n=e.data,i=e.viewable;expect(n.annotationType).toEqual(_util.AnnotationType.POPUP),expect(n.annotationFlags).toEqual(25),expect(i).toEqual(!0),t()}),t.fail)}))})),describe("InkAnnotation",(function(){it("should handle a single ink list",(function(t){var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Annot")),e.set("Subtype",_primitives.Name.get("Ink")),e.set("InkList",[[1,1,1,2,2,2,3,3]]);var a=new _primitives.Ref(142,0),o=new _test_utils.XRefMock([{ref:a,data:e}]);_annotation.AnnotationFactory.create(o,a,n,i).then((function(e){var n=e.data;expect(n.annotationType).toEqual(_util.AnnotationType.INK),expect(n.inkLists.length).toEqual(1),expect(n.inkLists[0]).toEqual([{x:1,y:1},{x:1,y:2},{x:2,y:2},{x:3,y:3}]),t()}),t.fail)})),it("should handle multiple ink lists",(function(t){var e=new _primitives.Dict;e.set("Type",_primitives.Name.get("Annot")),e.set("Subtype",_primitives.Name.get("Ink")),e.set("InkList",[[1,1,1,2],[3,3,4,5]]);var a=new _primitives.Ref(143,0),o=new _test_utils.XRefMock([{ref:a,data:e}]);_annotation.AnnotationFactory.create(o,a,n,i).then((function(e){var n=e.data;expect(n.annotationType).toEqual(_util.AnnotationType.INK),expect(n.inkLists.length).toEqual(2),expect(n.inkLists[0]).toEqual([{x:1,y:1},{x:1,y:2}]),expect(n.inkLists[1]).toEqual([{x:3,y:3},{x:4,y:5}]),t()}),t.fail)}))}))}));