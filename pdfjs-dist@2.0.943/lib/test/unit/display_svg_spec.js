"use strict";var _domstubs=require("../../examples/node/domstubs"),_test_utils=require("./test_utils"),_api=require("../../display/api"),_is_node=require("../../shared/is_node"),_is_node2=_interopRequireDefault(_is_node),_util=require("../../shared/util"),_svg=require("../../display/svg");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var XLINK_NS="http://www.w3.org/1999/xlink";function withZlib(e,t){if(e){if(!(0,_is_node2.default)())throw new Error("zlib test can only be run in Node.js");return t()}if(!(0,_is_node2.default)())return t();var i=require("zlib"),n=i.deflateSync;function o(){throw new Error("zlib.deflateSync is explicitly disabled for testing.")}function r(){i.deflateSync===o&&(i.deflateSync=n)}i.deflateSync=o;var u=t();return u.then(r,r),u}describe("SVGGraphics",(function(){var e,t;beforeAll((function(i){e=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)("xobject-image.pdf",{nativeImageDecoderSupport:_util.NativeImageDecoding.DISPLAY})),e.promise.then((function(e){e.getPage(1).then((function(e){t=e,i()}))}))})),afterAll((function(t){e.destroy().then(t)})),describe("paintImageXObject",(function(){function e(){var e;return t.getOperatorList().then((function(i){var n=!0;return e=new _svg.SVGGraphics(t.commonObjs,t.objs,n),e.loadDependencies(i)})).then((function(){var t,i={appendChild:function(e){t=e}},n="img_p0_1";(0,_is_node2.default)()&&(0,_domstubs.setStubs)(global);try{var o=e.objs.get(n);e.paintInlineImageXObject(o,i)}finally{(0,_is_node2.default)()&&(0,_domstubs.unsetStubs)(global)}return t}))}it('should fail require("zlib") unless in Node.js',(function(){function e(){require("zlib")}expect(e.toString()).toMatch(/\srequire\(["']zlib["']\)/),(0,_is_node2.default)()?expect(e).not.toThrow():expect(e).toThrow()})),it("should produce a reasonably small svg:image",(function(t){(0,_is_node2.default)()||pending("zlib.deflateSync is not supported in non-Node environments."),withZlib(!0,e).then((function(e){expect(e.nodeName).toBe("svg:image"),expect(e.getAttributeNS(null,"width")).toBe("200px"),expect(e.getAttributeNS(null,"height")).toBe("100px");var t=e.getAttributeNS(XLINK_NS,"href");expect(t).toMatch(/^data:image\/png;base64,/),expect(t.length).toBeLessThan(367)})).then(t,t.fail)})),it("should be able to produce a svg:image without zlib",(function(t){withZlib(!1,e).then((function(e){expect(e.nodeName).toBe("svg:image"),expect(e.getAttributeNS(null,"width")).toBe("200px"),expect(e.getAttributeNS(null,"height")).toBe("100px");var t=e.getAttributeNS(XLINK_NS,"href");expect(t).toMatch(/^data:image\/png;base64,/),expect(t.length).toBe(80246)})).then(t,t.fail)}))}))}));