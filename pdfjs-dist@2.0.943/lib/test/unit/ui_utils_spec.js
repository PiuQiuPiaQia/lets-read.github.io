"use strict";var _slicedToArray=function(){function t(t,e){var i=[],n=!0,o=!1,u=void 0;try{for(var a,l=t[Symbol.iterator]();!(n=(a=l.next()).done);n=!0)if(i.push(a.value),e&&i.length===e)break}catch(r){o=!0,u=r}finally{try{!n&&l["return"]&&l["return"]()}finally{if(o)throw u}}return i}return function(e,i){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_ui_utils=require("../../web/ui_utils"),_util=require("../../shared/util"),_is_node=require("../../shared/is_node"),_is_node2=_interopRequireDefault(_is_node);function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}describe("ui_utils",(function(){describe("binary search",(function(){function t(t){return t}function e(t){return t>3}it("empty array",(function(){expect((0,_ui_utils.binarySearchFirstItem)([],t)).toEqual(0)})),it("single boolean entry",(function(){expect((0,_ui_utils.binarySearchFirstItem)([!1],t)).toEqual(1),expect((0,_ui_utils.binarySearchFirstItem)([!0],t)).toEqual(0)})),it("three boolean entries",(function(){expect((0,_ui_utils.binarySearchFirstItem)([!0,!0,!0],t)).toEqual(0),expect((0,_ui_utils.binarySearchFirstItem)([!1,!0,!0],t)).toEqual(1),expect((0,_ui_utils.binarySearchFirstItem)([!1,!1,!0],t)).toEqual(2),expect((0,_ui_utils.binarySearchFirstItem)([!1,!1,!1],t)).toEqual(3)})),it("three numeric entries",(function(){expect((0,_ui_utils.binarySearchFirstItem)([0,1,2],e)).toEqual(3),expect((0,_ui_utils.binarySearchFirstItem)([2,3,4],e)).toEqual(2),expect((0,_ui_utils.binarySearchFirstItem)([4,5,6],e)).toEqual(0)}))})),describe("getPDFFileNameFromURL",(function(){it("gets PDF filename",(function(){expect((0,_ui_utils.getPDFFileNameFromURL)("/pdfs/file1.pdf")).toEqual("file1.pdf"),expect((0,_ui_utils.getPDFFileNameFromURL)("http://www.example.com/pdfs/file2.pdf")).toEqual("file2.pdf")})),it("gets fallback filename",(function(){expect((0,_ui_utils.getPDFFileNameFromURL)("/pdfs/file1.txt")).toEqual("document.pdf"),expect((0,_ui_utils.getPDFFileNameFromURL)("http://www.example.com/pdfs/file2.txt")).toEqual("document.pdf")})),it("gets custom fallback filename",(function(){expect((0,_ui_utils.getPDFFileNameFromURL)("/pdfs/file1.txt","qwerty1.pdf")).toEqual("qwerty1.pdf"),expect((0,_ui_utils.getPDFFileNameFromURL)("http://www.example.com/pdfs/file2.txt","qwerty2.pdf")).toEqual("qwerty2.pdf"),expect((0,_ui_utils.getPDFFileNameFromURL)("/pdfs/file3.txt","")).toEqual("")})),it("gets fallback filename when url is not a string",(function(){expect((0,_ui_utils.getPDFFileNameFromURL)(null)).toEqual("document.pdf"),expect((0,_ui_utils.getPDFFileNameFromURL)(null,"file.pdf")).toEqual("file.pdf")})),it("gets PDF filename from URL containing leading/trailing whitespace",(function(){expect((0,_ui_utils.getPDFFileNameFromURL)("   /pdfs/file1.pdf   ")).toEqual("file1.pdf"),expect((0,_ui_utils.getPDFFileNameFromURL)("   http://www.example.com/pdfs/file2.pdf   ")).toEqual("file2.pdf")})),it("gets PDF filename from query string",(function(){expect((0,_ui_utils.getPDFFileNameFromURL)("/pdfs/pdfs.html?name=file1.pdf")).toEqual("file1.pdf"),expect((0,_ui_utils.getPDFFileNameFromURL)("http://www.example.com/pdfs/pdf.html?file2.pdf")).toEqual("file2.pdf")})),it("gets PDF filename from hash string",(function(){expect((0,_ui_utils.getPDFFileNameFromURL)("/pdfs/pdfs.html#name=file1.pdf")).toEqual("file1.pdf"),expect((0,_ui_utils.getPDFFileNameFromURL)("http://www.example.com/pdfs/pdf.html#file2.pdf")).toEqual("file2.pdf")})),it("gets correct PDF filename when multiple ones are present",(function(){expect((0,_ui_utils.getPDFFileNameFromURL)("/pdfs/file1.pdf?name=file.pdf")).toEqual("file1.pdf"),expect((0,_ui_utils.getPDFFileNameFromURL)("http://www.example.com/pdfs/file2.pdf#file.pdf")).toEqual("file2.pdf")})),it("gets PDF filename from URI-encoded data",(function(){var t=encodeURIComponent("http://www.example.com/pdfs/file1.pdf");expect((0,_ui_utils.getPDFFileNameFromURL)(t)).toEqual("file1.pdf");var e=encodeURIComponent("http://www.example.com/pdfs/file.txt?file2.pdf");expect((0,_ui_utils.getPDFFileNameFromURL)(e)).toEqual("file2.pdf")})),it("gets PDF filename from data mistaken for URI-encoded",(function(){expect((0,_ui_utils.getPDFFileNameFromURL)("/pdfs/%AA.pdf")).toEqual("%AA.pdf"),expect((0,_ui_utils.getPDFFileNameFromURL)("/pdfs/%2F.pdf")).toEqual("%2F.pdf")})),it("gets PDF filename from (some) standard protocols",(function(){expect((0,_ui_utils.getPDFFileNameFromURL)("http://www.example.com/file1.pdf")).toEqual("file1.pdf"),expect((0,_ui_utils.getPDFFileNameFromURL)("https://www.example.com/file2.pdf")).toEqual("file2.pdf"),expect((0,_ui_utils.getPDFFileNameFromURL)("file:///path/to/files/file3.pdf")).toEqual("file3.pdf"),expect((0,_ui_utils.getPDFFileNameFromURL)("ftp://www.example.com/file4.pdf")).toEqual("file4.pdf")})),it('gets PDF filename from query string appended to "blob:" URL',(function(){(0,_is_node2.default)()&&pending("Blob in not supported in Node.js.");var t=new Uint8Array([1,2,3,4,5]),e=(0,_util.createObjectURL)(t,"application/pdf");expect(0===e.indexOf("blob:")).toEqual(!0),expect((0,_ui_utils.getPDFFileNameFromURL)(e+"?file.pdf")).toEqual("file.pdf")})),it('gets fallback filename from query string appended to "data:" URL',(function(){var t=new Uint8Array([1,2,3,4,5]),e=(0,_util.createObjectURL)(t,"application/pdf",!0);expect(0===e.indexOf("data:")).toEqual(!0),expect((0,_ui_utils.getPDFFileNameFromURL)(e+"?file1.pdf")).toEqual("document.pdf"),expect((0,_ui_utils.getPDFFileNameFromURL)("     "+e+"?file2.pdf")).toEqual("document.pdf")}))})),describe("EventBus",(function(){it("dispatch event",(function(){var t=new _ui_utils.EventBus,e=0;t.on("test",(function(t){expect(t).toEqual(void 0),e++})),t.dispatch("test"),expect(e).toEqual(1)})),it("dispatch event with arguments",(function(){var t=new _ui_utils.EventBus,e=0;t.on("test",(function(t){expect(t).toEqual({abc:123}),e++})),t.dispatch("test",{abc:123}),expect(e).toEqual(1)})),it("dispatch different event",(function(){var t=new _ui_utils.EventBus,e=0;t.on("test",(function(){e++})),t.dispatch("nottest"),expect(e).toEqual(0)})),it("dispatch event multiple times",(function(){var t=new _ui_utils.EventBus,e=0;t.dispatch("test"),t.on("test",(function(){e++})),t.dispatch("test"),t.dispatch("test"),expect(e).toEqual(2)})),it("dispatch event to multiple handlers",(function(){var t=new _ui_utils.EventBus,e=0;t.on("test",(function(){e++})),t.on("test",(function(){e++})),t.dispatch("test"),expect(e).toEqual(2)})),it("dispatch to detached",(function(){var t=new _ui_utils.EventBus,e=0,i=function(){e++};t.on("test",i),t.dispatch("test"),t.off("test",i),t.dispatch("test"),expect(e).toEqual(1)})),it("dispatch to wrong detached",(function(){var t=new _ui_utils.EventBus,e=0;t.on("test",(function(){e++})),t.dispatch("test"),t.off("test",(function(){e++})),t.dispatch("test"),expect(e).toEqual(2)})),it("dispatch to detached during handling",(function(){var t=new _ui_utils.EventBus,e=0,i=function(){t.off("test",n),e++},n=function(){t.off("test",i),e++};t.on("test",i),t.on("test",n),t.dispatch("test"),t.dispatch("test"),expect(e).toEqual(2)})),it("should not, by default, re-dispatch to DOM",(function(t){(0,_is_node2.default)()&&pending("Document in not supported in Node.js.");var e=new _ui_utils.EventBus,i=0;function n(){t.fail("shall not dispatch DOM event.")}e.on("test",(function(t){expect(t).toEqual(void 0),i++})),document.addEventListener("test",n),e.dispatch("test"),Promise.resolve().then((function(){expect(i).toEqual(1),document.removeEventListener("test",n),t()}))})),it("should re-dispatch to DOM",(function(t){(0,_is_node2.default)()&&pending("Document in not supported in Node.js.");var e=new _ui_utils.EventBus({dispatchToDOM:!0}),i=0;function n(t){expect(t.detail).toEqual({}),i++}e.on("test",(function(t){expect(t).toEqual(void 0),i++})),document.addEventListener("test",n),e.dispatch("test"),Promise.resolve().then((function(){expect(i).toEqual(2),document.removeEventListener("test",n),t()}))})),it("should re-dispatch to DOM, with arguments (without internal listeners)",(function(t){(0,_is_node2.default)()&&pending("Document in not supported in Node.js.");var e=new _ui_utils.EventBus({dispatchToDOM:!0}),i=0;function n(t){expect(t.detail).toEqual({abc:123}),i++}document.addEventListener("test",n),e.dispatch("test",{abc:123}),Promise.resolve().then((function(){expect(i).toEqual(1),document.removeEventListener("test",n),t()}))}))})),describe("isValidRotation",(function(){it("should reject non-integer angles",(function(){expect((0,_ui_utils.isValidRotation)()).toEqual(!1),expect((0,_ui_utils.isValidRotation)(null)).toEqual(!1),expect((0,_ui_utils.isValidRotation)(NaN)).toEqual(!1),expect((0,_ui_utils.isValidRotation)([90])).toEqual(!1),expect((0,_ui_utils.isValidRotation)("90")).toEqual(!1),expect((0,_ui_utils.isValidRotation)(90.5)).toEqual(!1)})),it("should reject non-multiple of 90 degree angles",(function(){expect((0,_ui_utils.isValidRotation)(45)).toEqual(!1),expect((0,_ui_utils.isValidRotation)(-123)).toEqual(!1)})),it("should accept valid angles",(function(){expect((0,_ui_utils.isValidRotation)(0)).toEqual(!0),expect((0,_ui_utils.isValidRotation)(90)).toEqual(!0),expect((0,_ui_utils.isValidRotation)(-270)).toEqual(!0),expect((0,_ui_utils.isValidRotation)(540)).toEqual(!0)}))})),describe("isPortraitOrientation",(function(){it("should be portrait orientation",(function(){expect((0,_ui_utils.isPortraitOrientation)({width:200,height:400})).toEqual(!0),expect((0,_ui_utils.isPortraitOrientation)({width:500,height:500})).toEqual(!0)})),it("should be landscape orientation",(function(){expect((0,_ui_utils.isPortraitOrientation)({width:600,height:300})).toEqual(!1)}))})),describe("waitOnEventOrTimeout",(function(){var t=void 0;beforeAll((function(e){t=new _ui_utils.EventBus,e()})),afterAll((function(){t=null})),it("should reject invalid parameters",(function(e){var i=(0,_ui_utils.waitOnEventOrTimeout)({target:"window",name:"DOMContentLoaded"}).then((function(){throw new Error("Should reject invalid parameters.")}),(function(t){expect(t instanceof Error).toEqual(!0)})),n=(0,_ui_utils.waitOnEventOrTimeout)({target:t,name:""}).then((function(){throw new Error("Should reject invalid parameters.")}),(function(t){expect(t instanceof Error).toEqual(!0)})),o=(0,_ui_utils.waitOnEventOrTimeout)({target:t,name:"pagerendered",delay:-1e3}).then((function(){throw new Error("Should reject invalid parameters.")}),(function(t){expect(t instanceof Error).toEqual(!0)}));Promise.all([i,n,o]).then(e,e.fail)})),it("should resolve on event, using the DOM",(function(t){(0,_is_node2.default)()&&pending("Document in not supported in Node.js.");var e=document.createElement("button"),i=(0,_ui_utils.waitOnEventOrTimeout)({target:e,name:"click",delay:1e4});e.click(),i.then((function(e){expect(e).toEqual(_ui_utils.WaitOnType.EVENT),t()}),t.fail)})),it("should resolve on timeout, using the DOM",(function(t){(0,_is_node2.default)()&&pending("Document in not supported in Node.js.");var e=document.createElement("button"),i=(0,_ui_utils.waitOnEventOrTimeout)({target:e,name:"click",delay:10});i.then((function(e){expect(e).toEqual(_ui_utils.WaitOnType.TIMEOUT),t()}),t.fail)})),it("should resolve on event, using the EventBus",(function(e){var i=(0,_ui_utils.waitOnEventOrTimeout)({target:t,name:"pagerendered",delay:1e4});t.dispatch("pagerendered"),i.then((function(t){expect(t).toEqual(_ui_utils.WaitOnType.EVENT),e()}),e.fail)})),it("should resolve on timeout, using the EventBus",(function(e){var i=(0,_ui_utils.waitOnEventOrTimeout)({target:t,name:"pagerendered",delay:10});i.then((function(t){expect(t).toEqual(_ui_utils.WaitOnType.TIMEOUT),e()}),e.fail)}))})),describe("getPageSizeInches",(function(){it("gets page size (in inches)",(function(){var t={view:[0,0,595.28,841.89],userUnit:1,rotate:0},e=(0,_ui_utils.getPageSizeInches)(t),i=e.width,n=e.height;expect(+i.toPrecision(3)).toEqual(8.27),expect(+n.toPrecision(4)).toEqual(11.69)})),it("gets page size (in inches), for non-default /Rotate entry",(function(){var t={view:[0,0,612,792],userUnit:1,rotate:0},e=(0,_ui_utils.getPageSizeInches)(t),i=e.width,n=e.height;expect(i).toEqual(8.5),expect(n).toEqual(11);var o={view:[0,0,612,792],userUnit:1,rotate:90},u=(0,_ui_utils.getPageSizeInches)(o),a=u.width,l=u.height;expect(a).toEqual(11),expect(l).toEqual(8.5)}))})),describe("getVisibleElements",(function(){var t=9,e=2*t-7;function i(i){var n=[],o=0,u=0,a=!0,l=!1,r=void 0;try{for(var s,c=i[Symbol.iterator]();!(a=(s=c.next()).done);a=!0){var f=s.value,d=f.reduce((function(t,e){return Math.max(t,e[1])}),0),p=-t,m=!0,_=!1,h=void 0;try{for(var E,v=f[Symbol.iterator]();!(m=(E=v.next()).done);m=!0){var g=E.value,x=_slicedToArray(g,2),w=x[0],F=x[1],q=o+(d-F)/2-t,y={offsetLeft:p,offsetTop:q,clientWidth:w,clientHeight:F,clientLeft:t,clientTop:t};n.push({id:u,div:y}),++u,p+=w+e}}catch(b){_=!0,h=b}finally{try{!m&&v.return&&v.return()}finally{if(_)throw h}}o+=d+e}}catch(b){l=!0,r=b}finally{try{!a&&c.return&&c.return()}finally{if(l)throw r}}return n}function n(t,e){var i=[],n=t.scrollLeft,o=t.scrollTop,u=n+t.clientWidth,a=o+t.clientHeight,l=!0,r=!1,s=void 0;try{for(var c,f=e[Symbol.iterator]();!(l=(c=f.next()).done);l=!0){var d=c.value,p=d.div,m=p.offsetLeft+p.clientLeft,_=m+p.clientWidth,h=p.offsetTop+p.clientTop,E=h+p.clientHeight;if(m<u&&_>n&&h<a&&E>o){var v=Math.max(0,o-h)+Math.max(0,E-a),g=Math.max(0,n-m)+Math.max(0,_-u),x=(p.clientHeight-v)*(p.clientWidth-g),w=100*x/p.clientHeight/p.clientWidth|0;i.push({id:d.id,x:m,y:h,view:d,percent:w})}}}catch(F){r=!0,s=F}finally{try{!l&&f.return&&f.return()}finally{if(r)throw s}}return{first:i[0],last:i[i.length-1],views:i}}function o(t){for(var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=t.reduce((function(t,i){var n=i.div;return Math.max(t,e?n.offsetLeft+n.clientLeft+n.clientWidth:n.offsetTop+n.clientTop+n.clientHeight)}),0),o=0;o<i;o+=7)for(var u=o+5;u<i;u+=u-o){var a=e?{scrollTop:0,scrollLeft:o,clientHeight:1e4,clientWidth:u-o}:{scrollTop:o,scrollLeft:0,clientHeight:u-o,clientWidth:1e4};expect((0,_ui_utils.getVisibleElements)(a,t,!1,e)).toEqual(n(a,t))}}it("with pages of varying height",(function(){var t=i([[[50,20],[20,50]],[[30,12],[12,30]],[[20,50],[50,20]],[[50,20],[20,50]]]);o(t)})),it("widescreen challenge",(function(){var t=i([[[10,50],[10,60],[10,70],[10,80],[10,90]],[[10,90],[10,80],[10,70],[10,60],[10,50]],[[10,50],[10,60],[10,70],[10,80],[10,90]]]);o(t)})),it("works with horizontal scrolling",(function(){var t=i([[[10,50],[20,20],[30,10]]]);o(t,!0)})),describe("backtrackBeforeAllVisibleElements",(function(){var t=[10,50],n=[10,10],o=20+e+40,u=20+e+10;it("handles case 1",(function(){var e=i([[[10,20],[10,20],[10,20],[10,20]],[t,n,t,n],[[10,50],[10,50],[10,50],[10,50]],[[10,20],[10,20],[10,20],[10,20]],[[10,20]]]),u=4;expect((0,_ui_utils.backtrackBeforeAllVisibleElements)(u,e,o)).toEqual(4)})),it("handles case 2",(function(){var e=i([[[10,20],[10,20],[10,20],[10,20]],[t,n,t,t],[[10,50],[10,50],[10,50],[10,50]],[[10,20],[10,20],[10,20],[10,20]]]),u=6;expect((0,_ui_utils.backtrackBeforeAllVisibleElements)(u,e,o)).toEqual(4)})),it("handles case 3",(function(){var e=i([[[10,20],[10,20],[10,20],[10,20]],[t,n,t,n],[[10,50],[10,50],[10,50],[10,50]],[[10,20],[10,20],[10,20],[10,20]]]),u=8;expect((0,_ui_utils.backtrackBeforeAllVisibleElements)(u,e,o)).toEqual(4)})),it("handles case 4",(function(){var e=i([[[10,20],[10,20],[10,20],[10,20]],[t,n,t,n],[[10,50],[10,50],[10,50],[10,50]],[[10,20],[10,20],[10,20],[10,20]]]),o=4;expect((0,_ui_utils.backtrackBeforeAllVisibleElements)(o,e,u)).toEqual(4)}))}))})),describe("moveToEndOfArray",(function(){it("works on empty arrays",(function(){var t=[];(0,_ui_utils.moveToEndOfArray)(t,(function(){})),expect(t).toEqual([])})),it("works when moving everything",(function(){var t=[1,2,3,4,5];(0,_ui_utils.moveToEndOfArray)(t,(function(){return!0})),expect(t).toEqual([1,2,3,4,5])})),it("works when moving some things",(function(){var t=[1,2,3,4,5];(0,_ui_utils.moveToEndOfArray)(t,(function(t){return t%2===0})),expect(t).toEqual([1,3,5,2,4])})),it("works when moving one thing",(function(){var t=[1,2,3,4,5];(0,_ui_utils.moveToEndOfArray)(t,(function(t){return 1===t})),expect(t).toEqual([2,3,4,5,1])})),it("works when moving nothing",(function(){var t=[1,2,3,4,5];(0,_ui_utils.moveToEndOfArray)(t,(function(t){return 0===t})),expect(t).toEqual([1,2,3,4,5])}))}))}));