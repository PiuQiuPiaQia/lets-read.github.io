"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PDFThumbnailViewer=void 0;var _createClass=function(){function e(e,i){for(var t=0;t<i.length;t++){var n=i[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(i,t,n){return t&&e(i.prototype,t),n&&e(i,n),i}}(),_ui_utils=require("./ui_utils"),_pdf_thumbnail_view=require("./pdf_thumbnail_view");function _classCallCheck(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}var THUMBNAIL_SCROLL_MARGIN=-19,THUMBNAIL_SELECTED_CLASS="selected",PDFThumbnailViewer=function(){function e(i){var t=i.container,n=i.linkService,s=i.renderingQueue,a=i.l10n,r=void 0===a?_ui_utils.NullL10n:a;_classCallCheck(this,e),this.container=t,this.linkService=n,this.renderingQueue=s,this.l10n=r,this.scroll=(0,_ui_utils.watchScroll)(this.container,this._scrollUpdated.bind(this)),this._resetView()}return _createClass(e,[{key:"_scrollUpdated",value:function(){this.renderingQueue.renderHighestPriority()}},{key:"getThumbnail",value:function(e){return this._thumbnails[e]}},{key:"_getVisibleThumbs",value:function(){return(0,_ui_utils.getVisibleElements)(this.container,this._thumbnails)}},{key:"scrollThumbnailIntoView",value:function(e){if(this.pdfDocument){var i=this._thumbnails[e-1];if(i){if(e!==this._currentPageNumber){var t=this._thumbnails[this._currentPageNumber-1];t.div.classList.remove(THUMBNAIL_SELECTED_CLASS),i.div.classList.add(THUMBNAIL_SELECTED_CLASS)}var n=this._getVisibleThumbs(),s=n.views.length;if(s>0){var a=n.first.id,r=s>1?n.last.id:a,u=!1;e<=a||e>=r?u=!0:n.views.some((function(i){return i.id===e&&(u=i.percent<100,!0)})),u&&(0,_ui_utils.scrollIntoView)(i.div,{top:THUMBNAIL_SCROLL_MARGIN})}this._currentPageNumber=e}else console.error('scrollThumbnailIntoView: Invalid "pageNumber" parameter.')}}},{key:"cleanup",value:function(){_pdf_thumbnail_view.PDFThumbnailView.cleanup()}},{key:"_resetView",value:function(){this._thumbnails=[],this._currentPageNumber=1,this._pageLabels=null,this._pagesRotation=0,this._pagesRequests=[],this.container.textContent=""}},{key:"setDocument",value:function(e){var i=this;this.pdfDocument&&(this._cancelRendering(),this._resetView()),this.pdfDocument=e,e&&e.getPage(1).then((function(t){for(var n=e.numPages,s=t.getViewport(1),a=1;a<=n;++a){var r=new _pdf_thumbnail_view.PDFThumbnailView({container:i.container,id:a,defaultViewport:s.clone(),linkService:i.linkService,renderingQueue:i.renderingQueue,disableCanvasToImageConversion:!1,l10n:i.l10n});i._thumbnails.push(r)}var u=i._thumbnails[i._currentPageNumber-1];u.div.classList.add(THUMBNAIL_SELECTED_CLASS)})).catch((function(e){console.error("Unable to initialize thumbnail viewer",e)}))}},{key:"_cancelRendering",value:function(){for(var e=0,i=this._thumbnails.length;e<i;e++)this._thumbnails[e]&&this._thumbnails[e].cancelRendering()}},{key:"setPageLabels",value:function(e){if(this.pdfDocument){e?Array.isArray(e)&&this.pdfDocument.numPages===e.length?this._pageLabels=e:(this._pageLabels=null,console.error("PDFThumbnailViewer_setPageLabels: Invalid page labels.")):this._pageLabels=null;for(var i=0,t=this._thumbnails.length;i<t;i++){var n=this._pageLabels&&this._pageLabels[i];this._thumbnails[i].setPageLabel(n)}}}},{key:"_ensurePdfPageLoaded",value:function(e){var i=this;if(e.pdfPage)return Promise.resolve(e.pdfPage);var t=e.id;if(this._pagesRequests[t])return this._pagesRequests[t];var n=this.pdfDocument.getPage(t).then((function(n){return e.setPdfPage(n),i._pagesRequests[t]=null,n})).catch((function(e){console.error("Unable to get page for thumb view",e),i._pagesRequests[t]=null}));return this._pagesRequests[t]=n,n}},{key:"forceRendering",value:function(){var e=this,i=this._getVisibleThumbs(),t=this.renderingQueue.getHighestPriority(i,this._thumbnails,this.scroll.down);return!!t&&(this._ensurePdfPageLoaded(t).then((function(){e.renderingQueue.renderView(t)})),!0)}},{key:"pagesRotation",get:function(){return this._pagesRotation},set:function(e){if(!(0,_ui_utils.isValidRotation)(e))throw new Error("Invalid thumbnails rotation angle.");if(this.pdfDocument&&this._pagesRotation!==e){this._pagesRotation=e;for(var i=0,t=this._thumbnails.length;i<t;i++)this._thumbnails[i].update(e)}}}]),e}();exports.PDFThumbnailViewer=PDFThumbnailViewer;