"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SpreadMode=exports.ScrollMode=exports.BaseViewer=void 0;var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),_ui_utils=require("./ui_utils"),_pdf_rendering_queue=require("./pdf_rendering_queue"),_annotation_layer_builder=require("./annotation_layer_builder"),_pdf=require("../pdf"),_dom_events=require("./dom_events"),_pdf_page_view=require("./pdf_page_view"),_pdf_link_service=require("./pdf_link_service"),_text_layer_builder=require("./text_layer_builder");function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var DEFAULT_CACHE_SIZE=10,ScrollMode={VERTICAL:0,HORIZONTAL:1,WRAPPED:2},SpreadMode={NONE:0,ODD:1,EVEN:2};function PDFPageViewBuffer(e){var t=[];this.push=function(i){var r=t.indexOf(i);r>=0&&t.splice(r,1),t.push(i),t.length>e&&t.shift().destroy()},this.resize=function(i,r){if(e=i,r){for(var n=new Set,a=0,s=r.length;a<s;++a)n.add(r[a].id);(0,_ui_utils.moveToEndOfArray)(t,(function(e){return n.has(e.id)}))}while(t.length>e)t.shift().destroy()}}function isSameScale(e,t){return t===e||Math.abs(t-e)<1e-15}var BaseViewer=function(){function e(t){var i=this;if(_classCallCheck(this,e),this.constructor===e)throw new Error("Cannot initialize BaseViewer.");this._name=this.constructor.name,this.container=t.container,this.viewer=t.viewer||t.container.firstElementChild,this.eventBus=t.eventBus||(0,_dom_events.getGlobalEventBus)(),this.linkService=t.linkService||new _pdf_link_service.SimpleLinkService,this.downloadManager=t.downloadManager||null,this.findController=t.findController||null,this.removePageBorders=t.removePageBorders||!1,this.textLayerMode=Number.isInteger(t.textLayerMode)?t.textLayerMode:_ui_utils.TextLayerMode.ENABLE,this.imageResourcesPath=t.imageResourcesPath||"",this.renderInteractiveForms=t.renderInteractiveForms||!1,this.enablePrintAutoRotate=t.enablePrintAutoRotate||!1,this.renderer=t.renderer||_ui_utils.RendererType.CANVAS,this.enableWebGL=t.enableWebGL||!1,this.useOnlyCssZoom=t.useOnlyCssZoom||!1,this.maxCanvasPixels=t.maxCanvasPixels,this.l10n=t.l10n||_ui_utils.NullL10n,this.defaultRenderingQueue=!t.renderingQueue,this.defaultRenderingQueue?(this.renderingQueue=new _pdf_rendering_queue.PDFRenderingQueue,this.renderingQueue.setViewer(this)):this.renderingQueue=t.renderingQueue,this.scroll=(0,_ui_utils.watchScroll)(this.container,this._scrollUpdate.bind(this)),this.presentationModeState=_ui_utils.PresentationModeState.UNKNOWN,this._resetView(),this.removePageBorders&&this.viewer.classList.add("removePageBorders"),Promise.resolve().then((function(){i.eventBus.dispatch("baseviewerinit",{source:i})}))}return _createClass(e,[{key:"getPageView",value:function(e){return this._pages[e]}},{key:"_setCurrentPageNumber",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._currentPageNumber!==e)if(0<e&&e<=this.pagesCount){var i={source:this,pageNumber:e,pageLabel:this._pageLabels&&this._pageLabels[e-1]};this._currentPageNumber=e,this.eventBus.dispatch("pagechanging",i),this.eventBus.dispatch("pagechange",i),t&&this._resetCurrentPageView()}else console.error(this._name+'._setCurrentPageNumber: "'+e+'" is out of bounds.');else t&&this._resetCurrentPageView()}},{key:"setDocument",value:function(e){var t=this;if(this.pdfDocument&&(this._cancelRendering(),this._resetView(),this.findController&&this.findController.setDocument(null)),this.pdfDocument=e,e){var i=e.numPages,r=(0,_pdf.createPromiseCapability)();this.pagesPromise=r.promise,r.promise.then((function(){t._pageViewsReady=!0,t.eventBus.dispatch("pagesloaded",{source:t,pagesCount:i})}));var n=!1,a=(0,_pdf.createPromiseCapability)();this.onePageRendered=a.promise;var s=function(e){e.onBeforeDraw=function(){t._buffer.push(e)},e.onAfterDraw=function(){n||(n=!0,a.resolve())}},o=e.getPage(1);this.firstPagePromise=o,o.then((function(n){for(var o=t.currentScale,l=n.getViewport(o*_ui_utils.CSS_UNITS),u=1;u<=i;++u){var h=null;t.textLayerMode!==_ui_utils.TextLayerMode.DISABLE&&(h=t);var c=new _pdf_page_view.PDFPageView({container:t._setDocumentViewerElement,eventBus:t.eventBus,id:u,scale:o,defaultViewport:l.clone(),renderingQueue:t.renderingQueue,textLayerFactory:h,textLayerMode:t.textLayerMode,annotationLayerFactory:t,imageResourcesPath:t.imageResourcesPath,renderInteractiveForms:t.renderInteractiveForms,renderer:t.renderer,enableWebGL:t.enableWebGL,useOnlyCssZoom:t.useOnlyCssZoom,maxCanvasPixels:t.maxCanvasPixels,l10n:t.l10n});s(c),t._pages.push(c)}t._spreadMode!==SpreadMode.NONE&&t._updateSpreadMode(),a.promise.then((function(){if(e.loadingParams["disableAutoFetch"])r.resolve();else for(var n=i,a=function(i){e.getPage(i).then((function(e){var a=t._pages[i-1];a.pdfPage||a.setPdfPage(e),t.linkService.cachePageRef(i,e.ref),0===--n&&r.resolve()}),(function(e){console.error("Unable to get page "+i+" to initialize viewer",e),0===--n&&r.resolve()}))},s=1;s<=i;++s)a(s)})),t.eventBus.dispatch("pagesinit",{source:t}),t.findController&&t.findController.setDocument(e),t.defaultRenderingQueue&&t.update()})).catch((function(e){console.error("Unable to initialize viewer",e)}))}}},{key:"setPageLabels",value:function(e){if(this.pdfDocument){e?Array.isArray(e)&&this.pdfDocument.numPages===e.length?this._pageLabels=e:(this._pageLabels=null,console.error(this._name+".setPageLabels: Invalid page labels.")):this._pageLabels=null;for(var t=0,i=this._pages.length;t<i;t++){var r=this._pages[t],n=this._pageLabels&&this._pageLabels[t];r.setPageLabel(n)}}}},{key:"_resetView",value:function(){this._pages=[],this._currentPageNumber=1,this._currentScale=_ui_utils.UNKNOWN_SCALE,this._currentScaleValue=null,this._pageLabels=null,this._buffer=new PDFPageViewBuffer(DEFAULT_CACHE_SIZE),this._location=null,this._pagesRotation=0,this._pagesRequests=[],this._pageViewsReady=!1,this._scrollMode=ScrollMode.VERTICAL,this._spreadMode=SpreadMode.NONE,this.viewer.textContent="",this._updateScrollMode()}},{key:"_scrollUpdate",value:function(){0!==this.pagesCount&&this.update()}},{key:"_scrollIntoView",value:function(e){e.pageDiv,e.pageSpot,e.pageNumber;throw new Error("Not implemented: _scrollIntoView")}},{key:"_setScaleDispatchEvent",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r={source:this,scale:e,presetValue:i?t:void 0};this.eventBus.dispatch("scalechanging",r),this.eventBus.dispatch("scalechange",r)}},{key:"_setScaleUpdatePages",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(this._currentScaleValue=t.toString(),isSameScale(this._currentScale,e))r&&this._setScaleDispatchEvent(e,t,!0);else{for(var n=0,a=this._pages.length;n<a;n++)this._pages[n].update(e);if(this._currentScale=e,!i){var s=this._currentPageNumber,o=void 0;!this._location||this.isInPresentationMode||this.isChangingPresentationMode||(s=this._location.pageNumber,o=[null,{name:"XYZ"},this._location.left,this._location.top,null]),this.scrollPageIntoView({pageNumber:s,destArray:o,allowNegativeOffset:!0})}this._setScaleDispatchEvent(e,t,r),this.defaultRenderingQueue&&this.update()}}},{key:"_setScale",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=parseFloat(e);if(i>0)this._setScaleUpdatePages(i,e,t,!1);else{var r=this._pages[this._currentPageNumber-1];if(!r)return;var n=this.isInPresentationMode||this.removePageBorders,a=n?0:_ui_utils.SCROLLBAR_PADDING,s=n?0:_ui_utils.VERTICAL_PADDING;if(!n&&this._isScrollModeHorizontal){var o=[s,a];a=o[0],s=o[1]}var l=(this.container.clientWidth-a)/r.width*r.scale,u=(this.container.clientHeight-s)/r.height*r.scale;switch(e){case"page-actual":i=1;break;case"page-width":i=l;break;case"page-height":i=u;break;case"page-fit":i=Math.min(l,u);break;case"auto":var h=(0,_ui_utils.isPortraitOrientation)(r)?l:Math.min(u,l);i=Math.min(_ui_utils.MAX_AUTO_SCALE,h);break;default:return void console.error(this._name+'._setScale: "'+e+'" is an unknown zoom value.')}this._setScaleUpdatePages(i,e,t,!0)}}},{key:"_resetCurrentPageView",value:function(){this.isInPresentationMode&&this._setScale(this._currentScaleValue,!0);var e=this._pages[this._currentPageNumber-1];this._scrollIntoView({pageDiv:e.div})}},{key:"scrollPageIntoView",value:function(e){if(this.pdfDocument){var t=e.pageNumber||0,i=e.destArray||null,r=e.allowNegativeOffset||!1;if(!this.isInPresentationMode&&i){var n=this._pages[t-1];if(n){var a=0,s=0,o=0,l=0,u=void 0,h=void 0,c=n.rotation%180!==0,d=(c?n.height:n.width)/n.scale/_ui_utils.CSS_UNITS,g=(c?n.width:n.height)/n.scale/_ui_utils.CSS_UNITS,_=0;switch(i[1].name){case"XYZ":a=i[2],s=i[3],_=i[4],a=null!==a?a:0,s=null!==s?s:g;break;case"Fit":case"FitB":_="page-fit";break;case"FitH":case"FitBH":s=i[2],_="page-width",null===s&&this._location&&(a=this._location.left,s=this._location.top);break;case"FitV":case"FitBV":a=i[2],o=d,l=g,_="page-height";break;case"FitR":a=i[2],s=i[3],o=i[4]-a,l=i[5]-s;var p=this.removePageBorders?0:_ui_utils.SCROLLBAR_PADDING,f=this.removePageBorders?0:_ui_utils.VERTICAL_PADDING;u=(this.container.clientWidth-p)/o/_ui_utils.CSS_UNITS,h=(this.container.clientHeight-f)/l/_ui_utils.CSS_UNITS,_=Math.min(Math.abs(u),Math.abs(h));break;default:return void console.error(this._name+'.scrollPageIntoView: "'+i[1].name+'" is not a valid destination type.')}if(_&&_!==this._currentScale?this.currentScaleValue=_:this._currentScale===_ui_utils.UNKNOWN_SCALE&&(this.currentScaleValue=_ui_utils.DEFAULT_SCALE_VALUE),"page-fit"!==_||i[4]){var v=[n.viewport.convertToViewportPoint(a,s),n.viewport.convertToViewportPoint(a+o,s+l)],m=Math.min(v[0][0],v[1][0]),P=Math.min(v[0][1],v[1][1]);r||(m=Math.max(m,0),P=Math.max(P,0)),this._scrollIntoView({pageDiv:n.div,pageSpot:{left:m,top:P},pageNumber:t})}else this._scrollIntoView({pageDiv:n.div,pageNumber:t})}else console.error(this._name+'.scrollPageIntoView: Invalid "pageNumber" parameter.')}else this._setCurrentPageNumber(t,!0)}}},{key:"_resizeBuffer",value:function(e,t){var i=Math.max(DEFAULT_CACHE_SIZE,2*e+1);this._buffer.resize(i,t)}},{key:"_updateLocation",value:function(e){var t=this._currentScale,i=this._currentScaleValue,r=parseFloat(i)===t?Math.round(1e4*t)/100:i,n=e.id,a="#page="+n;a+="&zoom="+r;var s=this._pages[n-1],o=this.container,l=s.getPagePoint(o.scrollLeft-e.x,o.scrollTop-e.y),u=Math.round(l[0]),h=Math.round(l[1]);a+=","+u+","+h,this._location={pageNumber:n,scale:r,top:h,left:u,rotation:this._pagesRotation,pdfOpenParams:a}}},{key:"update",value:function(){throw new Error("Not implemented: update")}},{key:"containsElement",value:function(e){return this.container.contains(e)}},{key:"focus",value:function(){this.container.focus()}},{key:"_getVisiblePages",value:function(){throw new Error("Not implemented: _getVisiblePages")}},{key:"cleanup",value:function(){for(var e=0,t=this._pages.length;e<t;e++)this._pages[e]&&this._pages[e].renderingState!==_pdf_rendering_queue.RenderingStates.FINISHED&&this._pages[e].reset()}},{key:"_cancelRendering",value:function(){for(var e=0,t=this._pages.length;e<t;e++)this._pages[e]&&this._pages[e].cancelRendering()}},{key:"_ensurePdfPageLoaded",value:function(e){var t=this;if(e.pdfPage)return Promise.resolve(e.pdfPage);var i=e.id;if(this._pagesRequests[i])return this._pagesRequests[i];var r=this.pdfDocument.getPage(i).then((function(r){return e.pdfPage||e.setPdfPage(r),t._pagesRequests[i]=null,r})).catch((function(e){console.error("Unable to get page for page view",e),t._pagesRequests[i]=null}));return this._pagesRequests[i]=r,r}},{key:"forceRendering",value:function(e){var t=this,i=e||this._getVisiblePages(),r=this._isScrollModeHorizontal?this.scroll.right:this.scroll.down,n=this.renderingQueue.getHighestPriority(i,this._pages,r);return!!n&&(this._ensurePdfPageLoaded(n).then((function(){t.renderingQueue.renderView(n)})),!0)}},{key:"createTextLayerBuilder",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return new _text_layer_builder.TextLayerBuilder({textLayerDiv:e,eventBus:this.eventBus,pageIndex:t,viewport:i,findController:this.isInPresentationMode?null:this.findController,enhanceTextSelection:!this.isInPresentationMode&&r})}},{key:"createAnnotationLayerBuilder",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:_ui_utils.NullL10n;return new _annotation_layer_builder.AnnotationLayerBuilder({pageDiv:e,pdfPage:t,imageResourcesPath:i,renderInteractiveForms:r,linkService:this.linkService,downloadManager:this.downloadManager,l10n:n})}},{key:"getPagesOverview",value:function(){var e=this._pages.map((function(e){var t=e.pdfPage.getViewport(1);return{width:t.width,height:t.height,rotation:t.rotation}}));if(!this.enablePrintAutoRotate)return e;var t=(0,_ui_utils.isPortraitOrientation)(e[0]);return e.map((function(e){return t===(0,_ui_utils.isPortraitOrientation)(e)?e:{width:e.height,height:e.width,rotation:(e.rotation+90)%360}}))}},{key:"_updateScrollMode",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=this._scrollMode,i=this.viewer;i.classList.toggle("scrollHorizontal",t===ScrollMode.HORIZONTAL),i.classList.toggle("scrollWrapped",t===ScrollMode.WRAPPED),this.pdfDocument&&e&&(this._currentScaleValue&&isNaN(this._currentScaleValue)&&this._setScale(this._currentScaleValue,!0),this.scrollPageIntoView({pageNumber:e}),this.update())}},{key:"_updateSpreadMode",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(this.pdfDocument){var t=this.viewer,i=this._pages;if(t.textContent="",this._spreadMode===SpreadMode.NONE)for(var r=0,n=i.length;r<n;++r)t.appendChild(i[r].div);else for(var a=this._spreadMode-1,s=null,o=0,l=i.length;o<l;++o)null===s?(s=document.createElement("div"),s.className="spread",t.appendChild(s)):o%2===a&&(s=s.cloneNode(!1),t.appendChild(s)),s.appendChild(i[o].div);e&&(this.scrollPageIntoView({pageNumber:e}),this.update())}}},{key:"pagesCount",get:function(){return this._pages.length}},{key:"pageViewsReady",get:function(){return this._pageViewsReady}},{key:"currentPageNumber",get:function(){return this._currentPageNumber},set:function(e){if(!Number.isInteger(e))throw new Error("Invalid page number.");this.pdfDocument&&this._setCurrentPageNumber(e,!0)}},{key:"currentPageLabel",get:function(){return this._pageLabels&&this._pageLabels[this._currentPageNumber-1]},set:function(e){var t=0|e;if(this._pageLabels){var i=this._pageLabels.indexOf(e);i>=0&&(t=i+1)}this.currentPageNumber=t}},{key:"currentScale",get:function(){return this._currentScale!==_ui_utils.UNKNOWN_SCALE?this._currentScale:_ui_utils.DEFAULT_SCALE},set:function(e){if(isNaN(e))throw new Error("Invalid numeric scale");this.pdfDocument&&this._setScale(e,!1)}},{key:"currentScaleValue",get:function(){return this._currentScaleValue},set:function(e){this.pdfDocument&&this._setScale(e,!1)}},{key:"pagesRotation",get:function(){return this._pagesRotation},set:function(e){if(!(0,_ui_utils.isValidRotation)(e))throw new Error("Invalid pages rotation angle.");if(this.pdfDocument&&this._pagesRotation!==e){this._pagesRotation=e;for(var t=this._currentPageNumber,i=0,r=this._pages.length;i<r;i++){var n=this._pages[i];n.update(n.scale,e)}this._currentScaleValue&&this._setScale(this._currentScaleValue,!0),this.eventBus.dispatch("rotationchanging",{source:this,pagesRotation:e,pageNumber:t}),this.defaultRenderingQueue&&this.update()}}},{key:"_setDocumentViewerElement",get:function(){throw new Error("Not implemented: _setDocumentViewerElement")}},{key:"_isScrollModeHorizontal",get:function(){throw new Error("Not implemented: _isScrollModeHorizontal")}},{key:"isInPresentationMode",get:function(){return this.presentationModeState===_ui_utils.PresentationModeState.FULLSCREEN}},{key:"isChangingPresentationMode",get:function(){return this.presentationModeState===_ui_utils.PresentationModeState.CHANGING}},{key:"isHorizontalScrollbarEnabled",get:function(){return!this.isInPresentationMode&&this.container.scrollWidth>this.container.clientWidth}},{key:"isVerticalScrollbarEnabled",get:function(){return!this.isInPresentationMode&&this.container.scrollHeight>this.container.clientHeight}},{key:"hasEqualPageSizes",get:function(){for(var e=this._pages[0],t=1,i=this._pages.length;t<i;++t){var r=this._pages[t];if(r.width!==e.width||r.height!==e.height)return!1}return!0}},{key:"scrollMode",get:function(){return this._scrollMode},set:function(e){if(this._scrollMode!==e){if(!Number.isInteger(e)||!Object.values(ScrollMode).includes(e))throw new Error("Invalid scroll mode: "+e);this._scrollMode=e,this.eventBus.dispatch("scrollmodechanged",{source:this,mode:e}),this._updateScrollMode(this._currentPageNumber)}}},{key:"spreadMode",get:function(){return this._spreadMode},set:function(e){if(this._spreadMode!==e){if(!Number.isInteger(e)||!Object.values(SpreadMode).includes(e))throw new Error("Invalid spread mode: "+e);this._spreadMode=e,this.eventBus.dispatch("spreadmodechanged",{source:this,mode:e}),this._updateSpreadMode(this._currentPageNumber)}}}]),e}();exports.BaseViewer=BaseViewer,exports.ScrollMode=ScrollMode,exports.SpreadMode=SpreadMode;