"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PDFPageView=void 0;var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}(),_ui_utils=require("./ui_utils"),_pdf=require("../pdf"),_dom_events=require("./dom_events"),_pdf_rendering_queue=require("./pdf_rendering_queue"),_viewer_compatibility=require("./viewer_compatibility");function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var MAX_CANVAS_PIXELS=_viewer_compatibility.viewerCompatibilityParams.maxCanvasPixels||16777216,PDFPageView=function(){function e(t){_classCallCheck(this,e);var i=t.container,a=t.defaultViewport;this.id=t.id,this.renderingId="page"+this.id,this.pdfPage=null,this.pageLabel=null,this.rotation=0,this.scale=t.scale||_ui_utils.DEFAULT_SCALE,this.viewport=a,this.pdfPageRotate=a.rotation,this.hasRestrictedScaling=!1,this.textLayerMode=Number.isInteger(t.textLayerMode)?t.textLayerMode:_ui_utils.TextLayerMode.ENABLE,this.imageResourcesPath=t.imageResourcesPath||"",this.renderInteractiveForms=t.renderInteractiveForms||!1,this.useOnlyCssZoom=t.useOnlyCssZoom||!1,this.maxCanvasPixels=t.maxCanvasPixels||MAX_CANVAS_PIXELS,this.eventBus=t.eventBus||(0,_dom_events.getGlobalEventBus)(),this.renderingQueue=t.renderingQueue,this.textLayerFactory=t.textLayerFactory,this.annotationLayerFactory=t.annotationLayerFactory,this.renderer=t.renderer||_ui_utils.RendererType.CANVAS,this.enableWebGL=t.enableWebGL||!1,this.l10n=t.l10n||_ui_utils.NullL10n,this.paintTask=null,this.paintedViewportMap=new WeakMap,this.renderingState=_pdf_rendering_queue.RenderingStates.INITIAL,this.resume=null,this.error=null,this.onBeforeDraw=null,this.onAfterDraw=null,this.annotationLayer=null,this.textLayer=null,this.zoomLayer=null;var n=document.createElement("div");n.className="page",n.style.width=Math.floor(this.viewport.width)+"px",n.style.height=Math.floor(this.viewport.height)+"px",n.setAttribute("data-page-number",this.id),this.div=n,i.appendChild(n)}return _createClass(e,[{key:"setPdfPage",value:function(e){this.pdfPage=e,this.pdfPageRotate=e.rotate;var t=(this.rotation+this.pdfPageRotate)%360;this.viewport=e.getViewport(this.scale*_ui_utils.CSS_UNITS,t),this.stats=e.stats,this.reset()}},{key:"destroy",value:function(){this.reset(),this.pdfPage&&this.pdfPage.cleanup()}},{key:"_resetZoomLayer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this.zoomLayer){var t=this.zoomLayer.firstChild;this.paintedViewportMap.delete(t),t.width=0,t.height=0,e&&this.zoomLayer.remove(),this.zoomLayer=null}}},{key:"reset",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.cancelRendering(t);var i=this.div;i.style.width=Math.floor(this.viewport.width)+"px",i.style.height=Math.floor(this.viewport.height)+"px";for(var a=i.childNodes,n=e&&this.zoomLayer||null,r=t&&this.annotationLayer&&this.annotationLayer.div||null,s=a.length-1;s>=0;s--){var o=a[s];n!==o&&r!==o&&i.removeChild(o)}i.removeAttribute("data-loaded"),r?this.annotationLayer.hide():this.annotationLayer&&(this.annotationLayer.cancel(),this.annotationLayer=null),n||(this.canvas&&(this.paintedViewportMap.delete(this.canvas),this.canvas.width=0,this.canvas.height=0,delete this.canvas),this._resetZoomLayer()),this.svg&&(this.paintedViewportMap.delete(this.svg),delete this.svg),this.loadingIconDiv=document.createElement("div"),this.loadingIconDiv.className="loadingIcon",i.appendChild(this.loadingIconDiv)}},{key:"update",value:function(e,t){this.scale=e||this.scale,"undefined"!==typeof t&&(this.rotation=t);var i=(this.rotation+this.pdfPageRotate)%360;if(this.viewport=this.viewport.clone({scale:this.scale*_ui_utils.CSS_UNITS,rotation:i}),this.svg)return this.cssTransform(this.svg,!0),void this.eventBus.dispatch("pagerendered",{source:this,pageNumber:this.id,cssTransform:!0});var a=!1;if(this.canvas&&this.maxCanvasPixels>0){var n=this.outputScale;(Math.floor(this.viewport.width)*n.sx|0)*(Math.floor(this.viewport.height)*n.sy|0)>this.maxCanvasPixels&&(a=!0)}if(this.canvas){if(this.useOnlyCssZoom||this.hasRestrictedScaling&&a)return this.cssTransform(this.canvas,!0),void this.eventBus.dispatch("pagerendered",{source:this,pageNumber:this.id,cssTransform:!0});this.zoomLayer||this.canvas.hasAttribute("hidden")||(this.zoomLayer=this.canvas.parentNode,this.zoomLayer.style.position="absolute")}this.zoomLayer&&this.cssTransform(this.zoomLayer.firstChild),this.reset(!0,!0)}},{key:"cancelRendering",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.renderingState;this.paintTask&&(this.paintTask.cancel(),this.paintTask=null),this.renderingState=_pdf_rendering_queue.RenderingStates.INITIAL,this.resume=null,this.textLayer&&(this.textLayer.cancel(),this.textLayer=null),!e&&this.annotationLayer&&(this.annotationLayer.cancel(),this.annotationLayer=null),t!==_pdf_rendering_queue.RenderingStates.INITIAL&&this.eventBus.dispatch("pagecancelled",{source:this,pageNumber:this.id,renderingState:t})}},{key:"cssTransform",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=this.viewport.width,a=this.viewport.height,n=this.div;e.style.width=e.parentNode.style.width=n.style.width=Math.floor(i)+"px",e.style.height=e.parentNode.style.height=n.style.height=Math.floor(a)+"px";var r=this.viewport.rotation-this.paintedViewportMap.get(e).rotation,s=Math.abs(r),o=1,h=1;90!==s&&270!==s||(o=a/i,h=i/a);var d="rotate("+r+"deg) scale("+o+","+h+")";if(e.style.transform=d,this.textLayer){var l=this.textLayer.viewport,u=this.viewport.rotation-l.rotation,c=Math.abs(u),v=i/l.width;90!==c&&270!==c||(v=i/l.height);var p=this.textLayer.textLayerDiv,g=void 0,y=void 0;switch(c){case 0:g=y=0;break;case 90:g=0,y="-"+p.style.height;break;case 180:g="-"+p.style.width,y="-"+p.style.height;break;case 270:g="-"+p.style.width,y=0;break;default:console.error("Bad rotation value.");break}p.style.transform="rotate("+c+"deg) scale("+v+", "+v+") translate("+g+", "+y+")",p.style.transformOrigin="0% 0%"}t&&this.annotationLayer&&this.annotationLayer.render(this.viewport,"display")}},{key:"getPagePoint",value:function(e,t){return this.viewport.convertToPdfPoint(e,t)}},{key:"draw",value:function(){var e=this;if(this.renderingState!==_pdf_rendering_queue.RenderingStates.INITIAL&&(console.error("Must be in new state before drawing"),this.reset()),!this.pdfPage)return this.renderingState=_pdf_rendering_queue.RenderingStates.FINISHED,Promise.reject(new Error("Page is not loaded"));this.renderingState=_pdf_rendering_queue.RenderingStates.RUNNING;var t=this.pdfPage,i=this.div,a=document.createElement("div");a.style.width=i.style.width,a.style.height=i.style.height,a.classList.add("canvasWrapper"),this.annotationLayer&&this.annotationLayer.div?i.insertBefore(a,this.annotationLayer.div):i.appendChild(a);var n=null;if(this.textLayerMode!==_ui_utils.TextLayerMode.DISABLE&&this.textLayerFactory){var r=document.createElement("div");r.className="textLayer",r.style.width=a.style.width,r.style.height=a.style.height,this.annotationLayer&&this.annotationLayer.div?i.insertBefore(r,this.annotationLayer.div):i.appendChild(r),n=this.textLayerFactory.createTextLayerBuilder(r,this.id-1,this.viewport,this.textLayerMode===_ui_utils.TextLayerMode.ENABLE_ENHANCE)}this.textLayer=n;var s=null;this.renderingQueue&&(s=function(t){if(!e.renderingQueue.isHighestPriority(e))return e.renderingState=_pdf_rendering_queue.RenderingStates.PAUSED,void(e.resume=function(){e.renderingState=_pdf_rendering_queue.RenderingStates.RUNNING,t()});t()});var o=function(a){return h===e.paintTask&&(e.paintTask=null),a instanceof _pdf.RenderingCancelledException?(e.error=null,Promise.resolve(void 0)):(e.renderingState=_pdf_rendering_queue.RenderingStates.FINISHED,e.loadingIconDiv&&(i.removeChild(e.loadingIconDiv),delete e.loadingIconDiv),e._resetZoomLayer(!0),e.error=a,e.stats=t.stats,e.onAfterDraw&&e.onAfterDraw(),e.eventBus.dispatch("pagerendered",{source:e,pageNumber:e.id,cssTransform:!1}),a?Promise.reject(a):Promise.resolve(void 0))},h=this.renderer===_ui_utils.RendererType.SVG?this.paintOnSvg(a):this.paintOnCanvas(a);h.onRenderContinue=s,this.paintTask=h;var d=h.promise.then((function(){return o(null).then((function(){if(n){var e=t.streamTextContent({normalizeWhitespace:!0});n.setTextContentStream(e),n.render()}}))}),(function(e){return o(e)}));return this.annotationLayerFactory&&(this.annotationLayer||(this.annotationLayer=this.annotationLayerFactory.createAnnotationLayerBuilder(i,t,this.imageResourcesPath,this.renderInteractiveForms,this.l10n)),this.annotationLayer.render(this.viewport,"display")),i.setAttribute("data-loaded",!0),this.onBeforeDraw&&this.onBeforeDraw(),d}},{key:"paintOnCanvas",value:function(e){var t=(0,_pdf.createPromiseCapability)(),i={promise:t.promise,onRenderContinue:function(e){e()},cancel:function(){y.cancel()}},a=this.viewport,n=document.createElement("canvas");n.id=this.renderingId,n.setAttribute("hidden","hidden");var r=!0,s=function(){r&&(n.removeAttribute("hidden"),r=!1)};e.appendChild(n),this.canvas=n,n.mozOpaque=!0;var o=n.getContext("2d",{alpha:!1}),h=(0,_ui_utils.getOutputScale)(o);if(this.outputScale=h,this.useOnlyCssZoom){var d=a.clone({scale:_ui_utils.CSS_UNITS});h.sx*=d.width/a.width,h.sy*=d.height/a.height,h.scaled=!0}if(this.maxCanvasPixels>0){var l=a.width*a.height,u=Math.sqrt(this.maxCanvasPixels/l);h.sx>u||h.sy>u?(h.sx=u,h.sy=u,h.scaled=!0,this.hasRestrictedScaling=!0):this.hasRestrictedScaling=!1}var c=(0,_ui_utils.approximateFraction)(h.sx),v=(0,_ui_utils.approximateFraction)(h.sy);n.width=(0,_ui_utils.roundToDivide)(a.width*h.sx,c[0]),n.height=(0,_ui_utils.roundToDivide)(a.height*h.sy,v[0]),n.style.width=(0,_ui_utils.roundToDivide)(a.width,c[1])+"px",n.style.height=(0,_ui_utils.roundToDivide)(a.height,v[1])+"px",this.paintedViewportMap.set(n,a);var p=h.scaled?[h.sx,0,0,h.sy,0,0]:null,g={canvasContext:o,transform:p,viewport:this.viewport,enableWebGL:this.enableWebGL,renderInteractiveForms:this.renderInteractiveForms},y=this.pdfPage.render(g);return y.onContinue=function(e){s(),i.onRenderContinue?i.onRenderContinue(e):e()},y.promise.then((function(){s(),t.resolve(void 0)}),(function(e){s(),t.reject(e)})),i}},{key:"paintOnSvg",value:function(e){var t=this,i=!1,a=function(){if(i)throw new _pdf.RenderingCancelledException("Rendering cancelled, page "+t.id,"svg")},n=this.pdfPage,r=this.viewport.clone({scale:_ui_utils.CSS_UNITS}),s=n.getOperatorList().then((function(i){a();var s=new _pdf.SVGGraphics(n.commonObjs,n.objs);return s.getSVG(i,r).then((function(i){a(),t.svg=i,t.paintedViewportMap.set(i,r),i.style.width=e.style.width,i.style.height=e.style.height,t.renderingState=_pdf_rendering_queue.RenderingStates.FINISHED,e.appendChild(i)}))}));return{promise:s,onRenderContinue:function(e){e()},cancel:function(){i=!0}}}},{key:"setPageLabel",value:function(e){this.pageLabel="string"===typeof e?e:null,null!==this.pageLabel?this.div.setAttribute("data-page-label",this.pageLabel):this.div.removeAttribute("data-page-label")}},{key:"width",get:function(){return this.viewport.width}},{key:"height",get:function(){return this.viewport.height}}]),e}();exports.PDFPageView=PDFPageView;