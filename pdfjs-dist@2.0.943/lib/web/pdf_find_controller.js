"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PDFFindController=exports.FindState=void 0;var _createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var i=e[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,a,i){return a&&t(e.prototype,a),i&&t(e,i),e}}(),_pdf=require("../pdf"),_pdf_find_utils=require("./pdf_find_utils"),_dom_events=require("./dom_events");function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var FindState={FOUND:0,NOT_FOUND:1,WRAPPED:2,PENDING:3},FIND_TIMEOUT=250,CHARACTERS_TO_NORMALIZE={"\u2018":"'","\u2019":"'","\u201a":"'","\u201b":"'","\u201c":'"',"\u201d":'"',"\u201e":'"',"\u201f":'"',"\xbc":"1/4","\xbd":"1/2","\xbe":"3/4"},PDFFindController=function(){function t(e){var a=e.linkService,i=e.eventBus,s=void 0===i?(0,_dom_events.getGlobalEventBus)():i;_classCallCheck(this,t),this._linkService=a,this._eventBus=s,this._reset(),s.on("findbarclose",this._onFindBarClose.bind(this));var n=Object.keys(CHARACTERS_TO_NORMALIZE).join("");this._normalizationRegex=new RegExp("["+n+"]","g")}return _createClass(t,[{key:"setDocument",value:function(t){this._pdfDocument&&this._reset(),t&&(this._pdfDocument=t,this._firstPageCapability.resolve())}},{key:"executeCommand",value:function(t,e){var a=this,i=this._pdfDocument;null!==this._state&&"findagain"===t||(this._dirtyMatch=!0),this._state=e,this._updateUIState(FindState.PENDING),this._firstPageCapability.promise.then((function(){!a._pdfDocument||i&&a._pdfDocument!==i||(a._extractText(),a._findTimeout&&(clearTimeout(a._findTimeout),a._findTimeout=null),"find"===t?a._findTimeout=setTimeout((function(){a._nextMatch(),a._findTimeout=null}),FIND_TIMEOUT):a._nextMatch())}))}},{key:"_reset",value:function(){this._highlightMatches=!1,this._pdfDocument=null,this._pageMatches=[],this._pageMatchesLength=null,this._state=null,this._selected={pageIdx:-1,matchIdx:-1},this._offset={pageIdx:null,matchIdx:null},this._extractTextPromises=[],this._pageContents=[],this._matchesCountTotal=0,this._pagesToSearch=null,this._pendingFindMatches=Object.create(null),this._resumePageIdx=null,this._dirtyMatch=!1,clearTimeout(this._findTimeout),this._findTimeout=null,this._firstPageCapability=(0,_pdf.createPromiseCapability)()}},{key:"_normalize",value:function(t){return t.replace(this._normalizationRegex,(function(t){return CHARACTERS_TO_NORMALIZE[t]}))}},{key:"_prepareMatches",value:function(t,e,a){function i(t,e){var a=t[e],i=t[e+1];if(e<t.length-1&&a.match===i.match)return a.skipped=!0,!0;for(var s=e-1;s>=0;s--){var n=t[s];if(!n.skipped){if(n.match+n.matchLength<a.match)break;if(n.match+n.matchLength>=a.match+a.matchLength)return a.skipped=!0,!0}}return!1}t.sort((function(t,e){return t.match===e.match?t.matchLength-e.matchLength:t.match-e.match}));for(var s=0,n=t.length;s<n;s++)i(t,s)||(e.push(t[s].match),a.push(t[s].matchLength))}},{key:"_isEntireWord",value:function(t,e,a){if(e>0){var i=t.charCodeAt(e),s=t.charCodeAt(e-1);if((0,_pdf_find_utils.getCharacterType)(i)===(0,_pdf_find_utils.getCharacterType)(s))return!1}var n=e+a-1;if(n<t.length-1){var h=t.charCodeAt(n),r=t.charCodeAt(n+1);if((0,_pdf_find_utils.getCharacterType)(h)===(0,_pdf_find_utils.getCharacterType)(r))return!1}return!0}},{key:"_calculatePhraseMatch",value:function(t,e,a,i){var s=[],n=t.length,h=-n;while(1){if(h=a.indexOf(t,h+n),-1===h)break;i&&!this._isEntireWord(a,h,n)||s.push(h)}this._pageMatches[e]=s}},{key:"_calculateWordMatch",value:function(t,e,a,i){for(var s=[],n=t.match(/\S+/g),h=0,r=n.length;h<r;h++){var c=n[h],u=c.length,o=-u;while(1){if(o=a.indexOf(c,o+u),-1===o)break;i&&!this._isEntireWord(a,o,u)||s.push({match:o,matchLength:u,skipped:!1})}}this._pageMatchesLength||(this._pageMatchesLength=[]),this._pageMatchesLength[e]=[],this._pageMatches[e]=[],this._prepareMatches(s,this._pageMatches[e],this._pageMatchesLength[e])}},{key:"_calculateMatch",value:function(t){var e=this._normalize(this._pageContents[t]),a=this._normalize(this._state.query),i=this._state,s=i.caseSensitive,n=i.entireWord,h=i.phraseSearch;if(0!==a.length){s||(e=e.toLowerCase(),a=a.toLowerCase()),h?this._calculatePhraseMatch(a,t,e,n):this._calculateWordMatch(a,t,e,n),this._updatePage(t),this._resumePageIdx===t&&(this._resumePageIdx=null,this._nextPageMatch());var r=this._pageMatches[t].length;r>0&&(this._matchesCountTotal+=r,this._updateUIResultsCount())}}},{key:"_extractText",value:function(){var t=this;if(!(this._extractTextPromises.length>0))for(var e=Promise.resolve(),a=function(a,i){var s=(0,_pdf.createPromiseCapability)();t._extractTextPromises[a]=s.promise,e=e.then((function(){return t._pdfDocument.getPage(a+1).then((function(t){return t.getTextContent({normalizeWhitespace:!0})})).then((function(e){for(var i=e.items,n=[],h=0,r=i.length;h<r;h++)n.push(i[h].str);t._pageContents[a]=n.join(""),s.resolve(a)}),(function(e){console.error("Unable to get text content for page "+(a+1),e),t._pageContents[a]="",s.resolve(a)}))}))},i=0,s=this._linkService.pagesCount;i<s;i++)a(i,s)}},{key:"_updatePage",value:function(t){this._selected.pageIdx===t&&(this._linkService.page=t+1),this._eventBus.dispatch("updatetextlayermatches",{source:this,pageIndex:t})}},{key:"_nextMatch",value:function(){var t=this,e=this._state.findPrevious,a=this._linkService.page-1,i=this._linkService.pagesCount;if(this._highlightMatches=!0,this._dirtyMatch){this._dirtyMatch=!1,this._selected.pageIdx=this._selected.matchIdx=-1,this._offset.pageIdx=a,this._offset.matchIdx=null,this._resumePageIdx=null,this._pageMatches.length=0,this._pageMatchesLength=null,this._matchesCountTotal=0;for(var s=0;s<i;s++)this._updatePage(s),s in this._pendingFindMatches||(this._pendingFindMatches[s]=!0,this._extractTextPromises[s].then((function(e){delete t._pendingFindMatches[e],t._calculateMatch(e)})))}if(""!==this._state.query){if(!this._resumePageIdx){var n=this._offset;if(this._pagesToSearch=i,null!==n.matchIdx){var h=this._pageMatches[n.pageIdx].length;if(!e&&n.matchIdx+1<h||e&&n.matchIdx>0)return n.matchIdx=e?n.matchIdx-1:n.matchIdx+1,void this._updateMatch(!0);this._advanceOffsetPage(e)}this._nextPageMatch()}}else this._updateUIState(FindState.FOUND)}},{key:"_matchesReady",value:function(t){var e=this._offset,a=t.length,i=this._state.findPrevious;return a?(e.matchIdx=i?a-1:0,this._updateMatch(!0),!0):(this._advanceOffsetPage(i),!!(e.wrapped&&(e.matchIdx=null,this._pagesToSearch<0))&&(this._updateMatch(!1),!0))}},{key:"_nextPageMatch",value:function(){null!==this._resumePageIdx&&console.error("There can only be one pending page.");var t=null;do{var e=this._offset.pageIdx;if(t=this._pageMatches[e],!t){this._resumePageIdx=e;break}}while(!this._matchesReady(t))}},{key:"_advanceOffsetPage",value:function(t){var e=this._offset,a=this._linkService.pagesCount;e.pageIdx=t?e.pageIdx-1:e.pageIdx+1,e.matchIdx=null,this._pagesToSearch--,(e.pageIdx>=a||e.pageIdx<0)&&(e.pageIdx=t?a-1:0,e.wrapped=!0)}},{key:"_updateMatch",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=FindState.NOT_FOUND,a=this._offset.wrapped;if(this._offset.wrapped=!1,t){var i=this._selected.pageIdx;this._selected.pageIdx=this._offset.pageIdx,this._selected.matchIdx=this._offset.matchIdx,e=a?FindState.WRAPPED:FindState.FOUND,-1!==i&&i!==this._selected.pageIdx&&this._updatePage(i)}this._updateUIState(e,this._state.findPrevious),-1!==this._selected.pageIdx&&this._updatePage(this._selected.pageIdx)}},{key:"_onFindBarClose",value:function(t){var e=this,a=this._pdfDocument;this._firstPageCapability.promise.then((function(){!e._pdfDocument||a&&e._pdfDocument!==a||(e._findTimeout&&(clearTimeout(e._findTimeout),e._findTimeout=null,e._updateUIState(FindState.FOUND)),e._highlightMatches=!1,e._eventBus.dispatch("updatetextlayermatches",{source:e,pageIndex:-1}))}))}},{key:"_requestMatchesCount",value:function(){var t=this._selected,e=t.pageIdx,a=t.matchIdx,i=0,s=this._matchesCountTotal;if(-1!==a){for(var n=0;n<e;n++)i+=this._pageMatches[n]&&this._pageMatches[n].length||0;i+=a+1}return(i<1||i>s)&&(i=s=0),{current:i,total:s}}},{key:"_updateUIResultsCount",value:function(){this._eventBus.dispatch("updatefindmatchescount",{source:this,matchesCount:this._requestMatchesCount()})}},{key:"_updateUIState",value:function(t,e){this._eventBus.dispatch("updatefindcontrolstate",{source:this,state:t,previous:e,matchesCount:this._requestMatchesCount()})}},{key:"highlightMatches",get:function(){return this._highlightMatches}},{key:"pageMatches",get:function(){return this._pageMatches}},{key:"pageMatchesLength",get:function(){return this._pageMatchesLength}},{key:"selected",get:function(){return this._selected}},{key:"state",get:function(){return this._state}}]),t}();exports.FindState=FindState,exports.PDFFindController=PDFFindController;