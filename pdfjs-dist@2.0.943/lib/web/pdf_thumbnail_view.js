"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PDFThumbnailView=void 0;var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}(),_pdf=require("../pdf"),_ui_utils=require("./ui_utils"),_pdf_rendering_queue=require("./pdf_rendering_queue");function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var MAX_NUM_SCALING_STEPS=3,THUMBNAIL_CANVAS_BORDER_WIDTH=1,THUMBNAIL_WIDTH=98,TempImageFactory=function(){var e=null;return{getCanvas:function(t,i){var a=e;a||(a=document.createElement("canvas"),e=a),a.width=t,a.height=i,a.mozOpaque=!0;var n=a.getContext("2d",{alpha:!1});return n.save(),n.fillStyle="rgb(255, 255, 255)",n.fillRect(0,0,t,i),n.restore(),a},destroyCanvas:function(){var t=e;t&&(t.width=0,t.height=0),e=null}}}(),PDFThumbnailView=function(){function e(t){var i=t.container,a=t.id,n=t.defaultViewport,s=t.linkService,r=t.renderingQueue,h=t.disableCanvasToImageConversion,d=void 0!==h&&h,g=t.l10n,o=void 0===g?_ui_utils.NullL10n:g;_classCallCheck(this,e),this.id=a,this.renderingId="thumbnail"+a,this.pageLabel=null,this.pdfPage=null,this.rotation=0,this.viewport=n,this.pdfPageRotate=n.rotation,this.linkService=s,this.renderingQueue=r,this.renderTask=null,this.renderingState=_pdf_rendering_queue.RenderingStates.INITIAL,this.resume=null,this.disableCanvasToImageConversion=d,this.pageWidth=this.viewport.width,this.pageHeight=this.viewport.height,this.pageRatio=this.pageWidth/this.pageHeight,this.canvasWidth=THUMBNAIL_WIDTH,this.canvasHeight=this.canvasWidth/this.pageRatio|0,this.scale=this.canvasWidth/this.pageWidth,this.l10n=o;var l=document.createElement("a");l.href=s.getAnchorUrl("#page="+a),this.l10n.get("thumb_page_title",{page:a},"Page {{page}}").then((function(e){l.title=e})),l.onclick=function(){return s.page=a,!1},this.anchor=l;var u=document.createElement("div");u.className="thumbnail",u.setAttribute("data-page-number",this.id),this.div=u;var c=document.createElement("div");c.className="thumbnailSelectionRing";var v=2*THUMBNAIL_CANVAS_BORDER_WIDTH;c.style.width=this.canvasWidth+v+"px",c.style.height=this.canvasHeight+v+"px",this.ring=c,u.appendChild(c),l.appendChild(u),i.appendChild(l)}return _createClass(e,[{key:"setPdfPage",value:function(e){this.pdfPage=e,this.pdfPageRotate=e.rotate;var t=(this.rotation+this.pdfPageRotate)%360;this.viewport=e.getViewport(1,t),this.reset()}},{key:"reset",value:function(){this.cancelRendering(),this.pageWidth=this.viewport.width,this.pageHeight=this.viewport.height,this.pageRatio=this.pageWidth/this.pageHeight,this.canvasHeight=this.canvasWidth/this.pageRatio|0,this.scale=this.canvasWidth/this.pageWidth,this.div.removeAttribute("data-loaded");for(var e=this.ring,t=e.childNodes,i=t.length-1;i>=0;i--)e.removeChild(t[i]);var a=2*THUMBNAIL_CANVAS_BORDER_WIDTH;e.style.width=this.canvasWidth+a+"px",e.style.height=this.canvasHeight+a+"px",this.canvas&&(this.canvas.width=0,this.canvas.height=0,delete this.canvas),this.image&&(this.image.removeAttribute("src"),delete this.image)}},{key:"update",value:function(e){"undefined"!==typeof e&&(this.rotation=e);var t=(this.rotation+this.pdfPageRotate)%360;this.viewport=this.viewport.clone({scale:1,rotation:t}),this.reset()}},{key:"cancelRendering",value:function(){this.renderTask&&(this.renderTask.cancel(),this.renderTask=null),this.renderingState=_pdf_rendering_queue.RenderingStates.INITIAL,this.resume=null}},{key:"_getPageDrawContext",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=document.createElement("canvas");this.canvas=t,t.mozOpaque=!0;var i=t.getContext("2d",{alpha:!1}),a=(0,_ui_utils.getOutputScale)(i);return t.width=this.canvasWidth*a.sx|0,t.height=this.canvasHeight*a.sy|0,t.style.width=this.canvasWidth+"px",t.style.height=this.canvasHeight+"px",!e&&a.scaled&&i.scale(a.sx,a.sy),i}},{key:"_convertCanvasToImage",value:function(){var e=this;if(this.canvas&&this.renderingState===_pdf_rendering_queue.RenderingStates.FINISHED){var t=this.renderingId,i="thumbnailImage";if(this.disableCanvasToImageConversion)return this.canvas.id=t,this.canvas.className=i,this.l10n.get("thumb_page_canvas",{page:this.pageId},"Thumbnail of Page {{page}}").then((function(t){e.canvas.setAttribute("aria-label",t)})),this.div.setAttribute("data-loaded",!0),void this.ring.appendChild(this.canvas);var a=document.createElement("img");a.id=t,a.className=i,this.l10n.get("thumb_page_canvas",{page:this.pageId},"Thumbnail of Page {{page}}").then((function(e){a.setAttribute("aria-label",e)})),a.style.width=this.canvasWidth+"px",a.style.height=this.canvasHeight+"px",a.src=this.canvas.toDataURL(),this.image=a,this.div.setAttribute("data-loaded",!0),this.ring.appendChild(a),this.canvas.width=0,this.canvas.height=0,delete this.canvas}}},{key:"draw",value:function(){var e=this;if(this.renderingState!==_pdf_rendering_queue.RenderingStates.INITIAL)return console.error("Must be in new state before drawing"),Promise.resolve(void 0);this.renderingState=_pdf_rendering_queue.RenderingStates.RUNNING;var t=(0,_pdf.createPromiseCapability)(),i=function(i){h===e.renderTask&&(e.renderTask=null),i instanceof _pdf.RenderingCancelledException?t.resolve(void 0):(e.renderingState=_pdf_rendering_queue.RenderingStates.FINISHED,e._convertCanvasToImage(),i?t.reject(i):t.resolve(void 0))},a=this._getPageDrawContext(),n=this.viewport.clone({scale:this.scale}),s=function(t){if(!e.renderingQueue.isHighestPriority(e))return e.renderingState=_pdf_rendering_queue.RenderingStates.PAUSED,void(e.resume=function(){e.renderingState=_pdf_rendering_queue.RenderingStates.RUNNING,t()});t()},r={canvasContext:a,viewport:n},h=this.renderTask=this.pdfPage.render(r);return h.onContinue=s,h.promise.then((function(){i(null)}),(function(e){i(e)})),t.promise}},{key:"setImage",value:function(e){if(this.renderingState===_pdf_rendering_queue.RenderingStates.INITIAL){var t=e.canvas;if(t){this.pdfPage||this.setPdfPage(e.pdfPage),this.renderingState=_pdf_rendering_queue.RenderingStates.FINISHED;var i=this._getPageDrawContext(!0),a=i.canvas;if(t.width<=2*a.width)return i.drawImage(t,0,0,t.width,t.height,0,0,a.width,a.height),void this._convertCanvasToImage();var n=a.width<<MAX_NUM_SCALING_STEPS,s=a.height<<MAX_NUM_SCALING_STEPS,r=TempImageFactory.getCanvas(n,s),h=r.getContext("2d");while(n>t.width||s>t.height)n>>=1,s>>=1;h.drawImage(t,0,0,t.width,t.height,0,0,n,s);while(n>2*a.width)h.drawImage(r,0,0,n,s,0,0,n>>1,s>>1),n>>=1,s>>=1;i.drawImage(r,0,0,n,s,0,0,a.width,a.height),this._convertCanvasToImage()}}}},{key:"setPageLabel",value:function(e){var t=this;this.pageLabel="string"===typeof e?e:null,this.l10n.get("thumb_page_title",{page:this.pageId},"Page {{page}}").then((function(e){t.anchor.title=e})),this.renderingState===_pdf_rendering_queue.RenderingStates.FINISHED&&this.l10n.get("thumb_page_canvas",{page:this.pageId},"Thumbnail of Page {{page}}").then((function(e){t.image?t.image.setAttribute("aria-label",e):t.disableCanvasToImageConversion&&t.canvas&&t.canvas.setAttribute("aria-label",e)}))}},{key:"pageId",get:function(){return null!==this.pageLabel?this.pageLabel:this.id}}],[{key:"cleanup",value:function(){TempImageFactory.destroyCanvas()}}]),e}();exports.PDFThumbnailView=PDFThumbnailView;