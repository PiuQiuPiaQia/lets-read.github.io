"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.isDestArraysEqual=exports.isDestHashesEqual=exports.PDFHistory=void 0;var _typeof="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"===typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_createClass=function(){function t(t,i){for(var e=0;e<i.length;e++){var s=i[e];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(i,e,s){return e&&t(i.prototype,e),s&&t(i,s),i}}(),_ui_utils=require("./ui_utils"),_dom_events=require("./dom_events");function _classCallCheck(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}var HASH_CHANGE_TIMEOUT=1e3,POSITION_UPDATED_THRESHOLD=50,UPDATE_VIEWAREA_TIMEOUT=1e3;function getCurrentHash(){return document.location.hash}function parseCurrentHash(t){var i=unescape(getCurrentHash()).substring(1),e=(0,_ui_utils.parseQueryString)(i),s=0|e.page;return Number.isInteger(s)&&s>0&&s<=t.pagesCount||(s=null),{hash:i,page:s,rotation:t.rotation}}var PDFHistory=function(){function t(i){var e=this,s=i.linkService,n=i.eventBus;_classCallCheck(this,t),this.linkService=s,this.eventBus=n||(0,_dom_events.getGlobalEventBus)(),this.initialized=!1,this.initialBookmark=null,this.initialRotation=null,this._boundEvents=Object.create(null),this._isViewerInPresentationMode=!1,this._isPagesLoaded=!1,this.eventBus.on("presentationmodechanged",(function(t){e._isViewerInPresentationMode=t.active||t.switchInProgress})),this.eventBus.on("pagesloaded",(function(t){e._isPagesLoaded=!!t.pagesCount}))}return _createClass(t,[{key:"initialize",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(t&&"string"===typeof t){var e=this.initialized&&this.fingerprint!==t;this.fingerprint=t,this.initialized||this._bindEvents();var s=window.history.state;if(this.initialized=!0,this.initialBookmark=null,this.initialRotation=null,this._popStateInProgress=!1,this._blockHashChange=0,this._currentHash=getCurrentHash(),this._numPositionUpdates=0,this._uid=this._maxUid=0,this._destination=null,this._position=null,!this._isValidState(s)||i){var n=parseCurrentHash(this.linkService),a=n.hash,r=n.page,o=n.rotation;return!a||e||i?void this._pushOrReplaceState(null,!0):void this._pushOrReplaceState({hash:a,page:r,rotation:o},!0)}var u=s.destination;this._updateInternalState(u,s.uid,!0),this._uid>this._maxUid&&(this._maxUid=this._uid),void 0!==u.rotation&&(this.initialRotation=u.rotation),u.dest?(this.initialBookmark=JSON.stringify(u.dest),this._destination.page=null):u.hash?this.initialBookmark=u.hash:u.page&&(this.initialBookmark="page="+u.page)}else console.error('PDFHistory.initialize: The "fingerprint" must be a non-empty string.')}},{key:"push",value:function(t){var i=this,e=t.namedDest,s=t.explicitDest,n=t.pageNumber;if(this.initialized)if((!e||"string"===typeof e)&&Array.isArray(s)&&Number.isInteger(n)&&n>0&&n<=this.linkService.pagesCount){var a=e||JSON.stringify(s);if(a){var r=!1;if(this._destination&&(isDestHashesEqual(this._destination.hash,a)||isDestArraysEqual(this._destination.dest,s))){if(this._destination.page)return;r=!0}this._popStateInProgress&&!r||(this._pushOrReplaceState({dest:s,hash:a,page:n,rotation:this.linkService.rotation},r),this._popStateInProgress||(this._popStateInProgress=!0,Promise.resolve().then((function(){i._popStateInProgress=!1}))))}}else console.error("PDFHistory.push: Invalid parameters.")}},{key:"pushCurrentPosition",value:function(){this.initialized&&!this._popStateInProgress&&this._tryPushCurrentPosition()}},{key:"back",value:function(){if(this.initialized&&!this._popStateInProgress){var t=window.history.state;this._isValidState(t)&&t.uid>0&&window.history.back()}}},{key:"forward",value:function(){if(this.initialized&&!this._popStateInProgress){var t=window.history.state;this._isValidState(t)&&t.uid<this._maxUid&&window.history.forward()}}},{key:"_pushOrReplaceState",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],e=i||!this._destination,s={fingerprint:this.fingerprint,uid:e?this._uid:this._uid+1,destination:t};this._updateInternalState(t,s.uid),e?window.history.replaceState(s,""):(this._maxUid=this._uid,window.history.pushState(s,""))}},{key:"_tryPushCurrentPosition",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._position){var i=this._position;if(t&&(i=Object.assign(Object.create(null),this._position),i.temporary=!0),this._destination){if(this._destination.temporary)this._pushOrReplaceState(i,!0);else if(this._destination.hash!==i.hash&&(this._destination.page||!(POSITION_UPDATED_THRESHOLD<=0||this._numPositionUpdates<=POSITION_UPDATED_THRESHOLD))){var e=!1;if(this._destination.page===i.first||this._destination.page===i.page){if(this._destination.dest||!this._destination.first)return;e=!0}this._pushOrReplaceState(i,e)}}else this._pushOrReplaceState(i)}}},{key:"_isValidState",value:function(t){return!!t&&(t.fingerprint===this.fingerprint&&(!(!Number.isInteger(t.uid)||t.uid<0)&&(null!==t.destination&&"object"===_typeof(t.destination))))}},{key:"_updateInternalState",value:function(t,i){var e=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this._updateViewareaTimeout&&(clearTimeout(this._updateViewareaTimeout),this._updateViewareaTimeout=null),e&&t&&t.temporary&&delete t.temporary,this._destination=t,this._uid=i,this._numPositionUpdates=0}},{key:"_updateViewarea",value:function(t){var i=this,e=t.location;this._updateViewareaTimeout&&(clearTimeout(this._updateViewareaTimeout),this._updateViewareaTimeout=null),this._position={hash:this._isViewerInPresentationMode?"page="+e.pageNumber:e.pdfOpenParams.substring(1),page:this.linkService.page,first:e.pageNumber,rotation:e.rotation},this._popStateInProgress||(POSITION_UPDATED_THRESHOLD>0&&this._isPagesLoaded&&this._destination&&!this._destination.page&&this._numPositionUpdates++,UPDATE_VIEWAREA_TIMEOUT>0&&(this._updateViewareaTimeout=setTimeout((function(){i._popStateInProgress||i._tryPushCurrentPosition(!0),i._updateViewareaTimeout=null}),UPDATE_VIEWAREA_TIMEOUT)))}},{key:"_popState",value:function(t){var i=this,e=t.state,s=getCurrentHash(),n=this._currentHash!==s;if(this._currentHash=s,e){if(this._isValidState(e)){this._popStateInProgress=!0,n&&(this._blockHashChange++,(0,_ui_utils.waitOnEventOrTimeout)({target:window,name:"hashchange",delay:HASH_CHANGE_TIMEOUT}).then((function(){i._blockHashChange--})));var a=e.destination;this._updateInternalState(a,e.uid,!0),this._uid>this._maxUid&&(this._maxUid=this._uid),(0,_ui_utils.isValidRotation)(a.rotation)&&(this.linkService.rotation=a.rotation),a.dest?this.linkService.navigateTo(a.dest):a.hash?this.linkService.setHash(a.hash):a.page&&(this.linkService.page=a.page),Promise.resolve().then((function(){i._popStateInProgress=!1}))}}else{this._uid++;var r=parseCurrentHash(this.linkService),o=r.hash,u=r.page,h=r.rotation;this._pushOrReplaceState({hash:o,page:u,rotation:h},!0)}}},{key:"_bindEvents",value:function(){var t=this,i=this._boundEvents,e=this.eventBus;i.updateViewarea=this._updateViewarea.bind(this),i.popState=this._popState.bind(this),i.pageHide=function(i){t._destination&&!t._destination.temporary||t._tryPushCurrentPosition()},e.on("updateviewarea",i.updateViewarea),window.addEventListener("popstate",i.popState),window.addEventListener("pagehide",i.pageHide)}},{key:"popStateInProgress",get:function(){return this.initialized&&(this._popStateInProgress||this._blockHashChange>0)}}]),t}();function isDestHashesEqual(t,i){if("string"!==typeof t||"string"!==typeof i)return!1;if(t===i)return!0;var e=(0,_ui_utils.parseQueryString)(t),s=e.nameddest;return s===i}function isDestArraysEqual(t,i){function e(t,i){if(("undefined"===typeof t?"undefined":_typeof(t))!==("undefined"===typeof i?"undefined":_typeof(i)))return!1;if(Array.isArray(t)||Array.isArray(i))return!1;if(null!==t&&"object"===("undefined"===typeof t?"undefined":_typeof(t))&&null!==i){if(Object.keys(t).length!==Object.keys(i).length)return!1;for(var s in t)if(!e(t[s],i[s]))return!1;return!0}return t===i||Number.isNaN(t)&&Number.isNaN(i)}if(!Array.isArray(t)||!Array.isArray(i))return!1;if(t.length!==i.length)return!1;for(var s=0,n=t.length;s<n;s++)if(!e(t[s],i[s]))return!1;return!0}exports.PDFHistory=PDFHistory,exports.isDestHashesEqual=isDestHashesEqual,exports.isDestArraysEqual=isDestArraysEqual;