"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PDFDocumentProperties=void 0;var _slicedToArray=function(){function e(e,t){var i=[],a=!0,r=!1,n=void 0;try{for(var o,s=e[Symbol.iterator]();!(a=(o=s.next()).done);a=!0)if(i.push(o.value),t&&i.length===t)break}catch(l){r=!0,n=l}finally{try{!a&&s["return"]&&s["return"]()}finally{if(r)throw n}}return i}return function(t,i){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}(),_ui_utils=require("./ui_utils"),_pdf=require("../pdf");function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var DEFAULT_FIELD_CONTENT="-",NON_METRIC_LOCALES=["en-us","en-lr","my"],US_PAGE_NAMES={"8.5x11":"Letter","8.5x14":"Legal"},METRIC_PAGE_NAMES={"297x420":"A3","210x297":"A4"};function getPageName(e,t,i){var a=t?e.width:e.height,r=t?e.height:e.width;return i[a+"x"+r]}var PDFDocumentProperties=function(){function e(t,i,a){var r=t.overlayName,n=t.fields,o=t.container,s=t.closeButton,l=this,u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:_ui_utils.NullL10n;_classCallCheck(this,e),this.overlayName=r,this.fields=n,this.container=o,this.overlayManager=i,this.l10n=u,this._reset(),s&&s.addEventListener("click",this.close.bind(this)),this.overlayManager.register(this.overlayName,this.container,this.close.bind(this)),a&&(a.on("pagechanging",(function(e){l._currentPageNumber=e.pageNumber})),a.on("rotationchanging",(function(e){l._pagesRotation=e.pagesRotation}))),this._isNonMetricLocale=!0,u.getLanguage().then((function(e){l._isNonMetricLocale=NON_METRIC_LOCALES.includes(e)}))}return _createClass(e,[{key:"open",value:function(){var e=this,t=function(t){Object.defineProperty(e,"fieldData",{value:Object.freeze(t),writable:!1,enumerable:!0,configurable:!0})};Promise.all([this.overlayManager.open(this.overlayName),this._dataAvailableCapability.promise]).then((function(){var i=e._currentPageNumber,a=e._pagesRotation;e.fieldData&&i===e.fieldData["_currentPageNumber"]&&a===e.fieldData["_pagesRotation"]?e._updateUI():e.pdfDocument.getMetadata().then((function(t){var r=t.info,n=t.metadata,o=t.contentDispositionFilename;return Promise.all([r,n,o||(0,_ui_utils.getPDFFileNameFromURL)(e.url||""),e._parseFileSize(e.maybeFileSize),e._parseDate(r.CreationDate),e._parseDate(r.ModDate),e.pdfDocument.getPage(i).then((function(t){return e._parsePageSize((0,_ui_utils.getPageSizeInches)(t),a)})),e._parseLinearization(r.IsLinearized)])})).then((function(r){var n=_slicedToArray(r,8),o=n[0],s=(n[1],n[2]),l=n[3],u=n[4],h=n[5],c=n[6],_=n[7];return t({fileName:s,fileSize:l,title:o.Title,author:o.Author,subject:o.Subject,keywords:o.Keywords,creationDate:u,modificationDate:h,creator:o.Creator,producer:o.Producer,version:o.PDFFormatVersion,pageCount:e.pdfDocument.numPages,pageSize:c,linearized:_,_currentPageNumber:i,_pagesRotation:a}),e._updateUI(),e.pdfDocument.getDownloadInfo()})).then((function(t){var i=t.length;return e.maybeFileSize=i,e._parseFileSize(i)})).then((function(i){if(i!==e.fieldData["fileSize"]){var a=Object.assign(Object.create(null),e.fieldData);a["fileSize"]=i,t(a),e._updateUI()}}))}))}},{key:"close",value:function(){this.overlayManager.close(this.overlayName)}},{key:"setDocument",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.pdfDocument&&(this._reset(),this._updateUI(!0)),e&&(this.pdfDocument=e,this.url=t,this._dataAvailableCapability.resolve())}},{key:"setFileSize",value:function(e){Number.isInteger(e)&&e>0&&(this.maybeFileSize=e)}},{key:"_reset",value:function(){this.pdfDocument=null,this.url=null,this.maybeFileSize=0,delete this.fieldData,this._dataAvailableCapability=(0,_pdf.createPromiseCapability)(),this._currentPageNumber=1,this._pagesRotation=0}},{key:"_updateUI",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!e&&this.fieldData){if(this.overlayManager.active===this.overlayName)for(var t in this.fields){var i=this.fieldData[t];this.fields[t].textContent=i||0===i?i:DEFAULT_FIELD_CONTENT}}else for(var a in this.fields)this.fields[a].textContent=DEFAULT_FIELD_CONTENT}},{key:"_parseFileSize",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=e/1024;return t?t<1024?this.l10n.get("document_properties_kb",{size_kb:(+t.toPrecision(3)).toLocaleString(),size_b:e.toLocaleString()},"{{size_kb}} KB ({{size_b}} bytes)"):this.l10n.get("document_properties_mb",{size_mb:(+(t/1024).toPrecision(3)).toLocaleString(),size_b:e.toLocaleString()},"{{size_mb}} MB ({{size_b}} bytes)"):Promise.resolve(void 0)}},{key:"_parsePageSize",value:function(e,t){var i=this;if(!e)return Promise.resolve(void 0);t%180!==0&&(e={width:e.height,height:e.width});var a=(0,_ui_utils.isPortraitOrientation)(e),r={width:Math.round(100*e.width)/100,height:Math.round(100*e.height)/100},n={width:Math.round(25.4*e.width*10)/10,height:Math.round(25.4*e.height*10)/10},o=null,s=getPageName(r,a,US_PAGE_NAMES)||getPageName(n,a,METRIC_PAGE_NAMES);if(!s&&(!Number.isInteger(n.width)||!Number.isInteger(n.height))){var l={width:25.4*e.width,height:25.4*e.height},u={width:Math.round(n.width),height:Math.round(n.height)};Math.abs(l.width-u.width)<.1&&Math.abs(l.height-u.height)<.1&&(s=getPageName(u,a,METRIC_PAGE_NAMES),s&&(r={width:Math.round(u.width/25.4*100)/100,height:Math.round(u.height/25.4*100)/100},n=u))}return s&&(o=this.l10n.get("document_properties_page_size_name_"+s.toLowerCase(),null,s)),Promise.all([this._isNonMetricLocale?r:n,this.l10n.get("document_properties_page_size_unit_"+(this._isNonMetricLocale?"inches":"millimeters"),null,this._isNonMetricLocale?"in":"mm"),o,this.l10n.get("document_properties_page_size_orientation_"+(a?"portrait":"landscape"),null,a?"portrait":"landscape")]).then((function(e){var t=_slicedToArray(e,4),a=t[0],r=a.width,n=a.height,o=t[1],s=t[2],l=t[3];return i.l10n.get("document_properties_page_size_dimension_"+(s?"name_":"")+"string",{width:r.toLocaleString(),height:n.toLocaleString(),unit:o,name:s,orientation:l},"{{width}} \xd7 {{height}} {{unit}} ("+(s?"{{name}}, ":"")+"{{orientation}})")}))}},{key:"_parseDate",value:function(e){if(e){var t=e;"D:"===t.substring(0,2)&&(t=t.substring(2));var i=parseInt(t.substring(0,4),10),a=parseInt(t.substring(4,6),10)-1,r=parseInt(t.substring(6,8),10),n=parseInt(t.substring(8,10),10),o=parseInt(t.substring(10,12),10),s=parseInt(t.substring(12,14),10),l=t.substring(14,15),u=parseInt(t.substring(15,17),10),h=parseInt(t.substring(18,20),10);"-"===l?(n+=u,o+=h):"+"===l&&(n-=u,o-=h);var c=new Date(Date.UTC(i,a,r,n,o,s)),_=c.toLocaleDateString(),g=c.toLocaleTimeString();return this.l10n.get("document_properties_date_string",{date:_,time:g},"{{date}}, {{time}}")}}},{key:"_parseLinearization",value:function(e){return this.l10n.get("document_properties_linearized_"+(e?"yes":"no"),null,e?"Yes":"No")}}]),e}();exports.PDFDocumentProperties=PDFDocumentProperties;