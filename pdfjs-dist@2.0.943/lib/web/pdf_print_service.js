"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PDFPrintService=void 0;var _ui_utils=require("./ui_utils"),_app=require("./app"),_pdf=require("../pdf"),activeService=null,overlayManager=null;function renderPage(e,t,r,i){var n=activeService.scratchCanvas,a=150,o=a/72;n.width=Math.floor(i.width*o),n.height=Math.floor(i.height*o);var c=Math.floor(i.width*_ui_utils.CSS_UNITS)+"px",s=Math.floor(i.height*_ui_utils.CSS_UNITS)+"px",v=n.getContext("2d");return v.save(),v.fillStyle="rgb(255, 255, 255)",v.fillRect(0,0,n.width,n.height),v.restore(),t.getPage(r).then((function(e){var t={canvasContext:v,transform:[o,0,0,o,0,0],viewport:e.getViewport(1,i.rotation),intent:"print"};return e.render(t).promise})).then((function(){return{width:c,height:s}}))}function PDFPrintService(e,t,r,i){this.pdfDocument=e,this.pagesOverview=t,this.printContainer=r,this.l10n=i||_ui_utils.NullL10n,this.disableCreateObjectURL=e.loadingParams["disableCreateObjectURL"],this.currentPage=-1,this.scratchCanvas=document.createElement("canvas")}PDFPrintService.prototype={layout:function(){this.throwIfInactive();var e=document.querySelector("body");e.setAttribute("data-pdfjsprinting",!0);var t=this.pagesOverview.every((function(e){return e.width===this.pagesOverview[0].width&&e.height===this.pagesOverview[0].height}),this);t||console.warn("Not all pages have the same size. The printed result may be incorrect!"),this.pageStyleSheet=document.createElement("style");var r=this.pagesOverview[0];this.pageStyleSheet.textContent="@supports ((size:A4) and (size:1pt 1pt)) {@page { size: "+r.width+"pt "+r.height+"pt;}}",e.appendChild(this.pageStyleSheet)},destroy:function(){activeService===this&&(this.printContainer.textContent="",this.pageStyleSheet&&(this.pageStyleSheet.remove(),this.pageStyleSheet=null),this.scratchCanvas.width=this.scratchCanvas.height=0,this.scratchCanvas=null,activeService=null,ensureOverlay().then((function(){"printServiceOverlay"===overlayManager.active&&overlayManager.close("printServiceOverlay")})))},renderPages:function(){var e=this,t=this.pagesOverview.length,r=function r(i,n){if(e.throwIfInactive(),++e.currentPage>=t)return renderProgress(t,t,e.l10n),void i();var a=e.currentPage;renderProgress(a,t,e.l10n),renderPage(e,e.pdfDocument,a+1,e.pagesOverview[a]).then(e.useRenderedPage.bind(e)).then((function(){r(i,n)}),n)};return new Promise(r)},useRenderedPage:function(e){this.throwIfInactive();var t=document.createElement("img");t.style.width=e.width,t.style.height=e.height;var r=this.scratchCanvas;"toBlob"in r&&!this.disableCreateObjectURL?r.toBlob((function(e){t.src=_pdf.URL.createObjectURL(e)})):t.src=r.toDataURL();var i=document.createElement("div");return i.appendChild(t),this.printContainer.appendChild(i),new Promise((function(e,r){t.onload=e,t.onerror=r}))},performPrint:function(){var e=this;return this.throwIfInactive(),new Promise((function(t){setTimeout((function(){e.active?(print.call(window),setTimeout(t,20)):t()}),0)}))},get active(){return this===activeService},throwIfInactive:function(){if(!this.active)throw new Error("This print request was cancelled or completed.")}};var print=window.print;function dispatchEvent(e){var t=document.createEvent("CustomEvent");t.initCustomEvent(e,!1,!1,"custom"),window.dispatchEvent(t)}function abort(){activeService&&(activeService.destroy(),dispatchEvent("afterprint"))}function renderProgress(e,t,r){var i=document.getElementById("printServiceOverlay"),n=Math.round(100*e/t),a=i.querySelector("progress"),o=i.querySelector(".relative-progress");a.value=n,r.get("print_progress_percent",{progress:n},n+"%").then((function(e){o.textContent=e}))}window.print=function(){if(activeService)console.warn("Ignored window.print() because of a pending print job.");else{ensureOverlay().then((function(){activeService&&overlayManager.open("printServiceOverlay")}));try{dispatchEvent("beforeprint")}finally{if(!activeService)return console.error("Expected print service to be initialized."),void ensureOverlay().then((function(){"printServiceOverlay"===overlayManager.active&&overlayManager.close("printServiceOverlay")}));var e=activeService;activeService.renderPages().then((function(){return e.performPrint()})).catch((function(){})).then((function(){e.active&&abort()}))}}};var hasAttachEvent=!!document.attachEvent;if(window.addEventListener("keydown",(function(e){if(80===e.keyCode&&(e.ctrlKey||e.metaKey)&&!e.altKey&&(!e.shiftKey||window.chrome||window.opera)){if(window.print(),hasAttachEvent)return;return e.preventDefault(),void(e.stopImmediatePropagation?e.stopImmediatePropagation():e.stopPropagation())}}),!0),hasAttachEvent&&document.attachEvent("onkeydown",(function(e){if(e=e||window.event,80===e.keyCode&&e.ctrlKey)return e.keyCode=0,!1})),"onbeforeprint"in window){var stopPropagationIfNeeded=function(e){"custom"!==e.detail&&e.stopImmediatePropagation&&e.stopImmediatePropagation()};window.addEventListener("beforeprint",stopPropagationIfNeeded),window.addEventListener("afterprint",stopPropagationIfNeeded)}var overlayPromise=void 0;function ensureOverlay(){if(!overlayPromise){if(overlayManager=_app.PDFViewerApplication.overlayManager,!overlayManager)throw new Error("The overlay manager has not yet been initialized.");overlayPromise=overlayManager.register("printServiceOverlay",document.getElementById("printServiceOverlay"),abort,!0),document.getElementById("printCancel").onclick=abort}return overlayPromise}_app.PDFPrintServiceFactory.instance={supportsPrinting:!0,createPrintService:function(e,t,r,i){if(activeService)throw new Error("The print service is created and active.");return activeService=new PDFPrintService(e,t,r,i),activeService}},exports.PDFPrintService=PDFPrintService;