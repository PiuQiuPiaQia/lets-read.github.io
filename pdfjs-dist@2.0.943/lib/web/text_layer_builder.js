"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.DefaultTextLayerFactory=exports.TextLayerBuilder=void 0;var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),_dom_events=require("./dom_events"),_pdf=require("../pdf"),_ui_utils=require("./ui_utils");function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var EXPAND_DIVS_TIMEOUT=300,MATCH_SCROLL_OFFSET_TOP=-50,MATCH_SCROLL_OFFSET_LEFT=-400,TextLayerBuilder=function(){function e(t){var n=t.textLayerDiv,i=t.eventBus,r=t.pageIndex,a=t.viewport,s=t.findController,l=void 0===s?null:s,o=t.enhanceTextSelection,d=void 0!==o&&o;_classCallCheck(this,e),this.textLayerDiv=n,this.eventBus=i||(0,_dom_events.getGlobalEventBus)(),this.textContent=null,this.textContentItemsStr=[],this.textContentStream=null,this.renderingDone=!1,this.pageIdx=r,this.pageNumber=this.pageIdx+1,this.matches=[],this.viewport=a,this.textDivs=[],this.findController=l,this.textLayerRenderTask=null,this.enhanceTextSelection=d,this._boundEvents=Object.create(null),this._bindEvents(),this._bindMouse()}return _createClass(e,[{key:"_finishRendering",value:function(){if(this.renderingDone=!0,!this.enhanceTextSelection){var e=document.createElement("div");e.className="endOfContent",this.textLayerDiv.appendChild(e)}this.eventBus.dispatch("textlayerrendered",{source:this,pageNumber:this.pageNumber,numTextDivs:this.textDivs.length})}},{key:"render",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if((this.textContent||this.textContentStream)&&!this.renderingDone){this.cancel(),this.textDivs=[];var n=document.createDocumentFragment();this.textLayerRenderTask=(0,_pdf.renderTextLayer)({textContent:this.textContent,textContentStream:this.textContentStream,container:n,viewport:this.viewport,textDivs:this.textDivs,textContentItemsStr:this.textContentItemsStr,timeout:t,enhanceTextSelection:this.enhanceTextSelection}),this.textLayerRenderTask.promise.then((function(){e.textLayerDiv.appendChild(n),e._finishRendering(),e.updateMatches()}),(function(e){}))}}},{key:"cancel",value:function(){this.textLayerRenderTask&&(this.textLayerRenderTask.cancel(),this.textLayerRenderTask=null)}},{key:"setTextContentStream",value:function(e){this.cancel(),this.textContentStream=e}},{key:"setTextContent",value:function(e){this.cancel(),this.textContent=e}},{key:"convertMatches",value:function(e,t){var n=0,i=0,r=this.textContentItemsStr,a=r.length-1,s=null===this.findController?0:this.findController.state.query.length,l=[];if(!e)return l;for(var o=0,d=e.length;o<d;o++){var h=e[o];while(n!==a&&h>=i+r[n].length)i+=r[n].length,n++;n===r.length&&console.error("Could not find a matching mapping");var c={begin:{divIdx:n,offset:h-i}};h+=t?t[o]:s;while(n!==a&&h>i+r[n].length)i+=r[n].length,n++;c.end={divIdx:n,offset:h-i},l.push(c)}return l}},{key:"renderMatches",value:function(e){if(0!==e.length){var t=this.textContentItemsStr,n=this.textDivs,i=null,r=this.pageIdx,a=null!==this.findController&&r===this.findController.selected.pageIdx,s=null===this.findController?-1:this.findController.selected.matchIdx,l=null!==this.findController&&this.findController.state.highlightAll,o={divIdx:-1,offset:void 0},d=s,h=d+1;if(l)d=0,h=e.length;else if(!a)return;for(var c=d;c<h;c++){var u=e[c],f=u.begin,v=u.end,x=a&&c===s,g=x?" selected":"";if(this.findController&&this.findController.selected.matchIdx===c&&this.findController.selected.pageIdx===r){var p={top:MATCH_SCROLL_OFFSET_TOP,left:MATCH_SCROLL_OFFSET_LEFT};(0,_ui_utils.scrollIntoView)(n[f.divIdx],p,!0)}if(i&&f.divIdx===i.divIdx?m(i.divIdx,i.offset,f.offset):(null!==i&&m(i.divIdx,i.offset,o.offset),T(f)),f.divIdx===v.divIdx)m(f.divIdx,f.offset,v.offset,"highlight"+g);else{m(f.divIdx,f.offset,o.offset,"highlight begin"+g);for(var C=f.divIdx+1,y=v.divIdx;C<y;C++)n[C].className="highlight middle"+g;T(v,"highlight end"+g)}i=v}i&&m(i.divIdx,i.offset,o.offset)}function T(e,t){var i=e.divIdx;n[i].textContent="",m(i,0,e.offset,t)}function m(e,i,r,a){var s=n[e],l=t[e].substring(i,r),o=document.createTextNode(l);if(a){var d=document.createElement("span");return d.className=a,d.appendChild(o),void s.appendChild(d)}s.appendChild(o)}}},{key:"updateMatches",value:function(){if(this.renderingDone){for(var e=this.matches,t=this.textDivs,n=this.textContentItemsStr,i=-1,r=0,a=e.length;r<a;r++){for(var s=e[r],l=Math.max(i,s.begin.divIdx),o=l,d=s.end.divIdx;o<=d;o++){var h=t[o];h.textContent=n[o],h.className=""}i=s.end.divIdx+1}if(this.findController&&this.findController.highlightMatches){var c=void 0,u=void 0;null!==this.findController&&(c=this.findController.pageMatches[this.pageIdx]||null,u=this.findController.pageMatchesLength&&this.findController.pageMatchesLength[this.pageIdx]||null),this.matches=this.convertMatches(c,u),this.renderMatches(this.matches)}}}},{key:"_bindEvents",value:function(){var e=this,t=this.eventBus,n=this._boundEvents;n.pageCancelled=function(i){if(i.pageNumber===e.pageNumber)if(e.textLayerRenderTask)console.error("TextLayerBuilder._bindEvents: `this.cancel()` should have been called when the page was reset, or rendering cancelled.");else for(var r in n)t.off(r.toLowerCase(),n[r]),delete n[r]},n.updateTextLayerMatches=function(t){t.pageIndex!==e.pageIdx&&-1!==t.pageIndex||e.updateMatches()},t.on("pagecancelled",n.pageCancelled),t.on("updatetextlayermatches",n.updateTextLayerMatches)}},{key:"_bindMouse",value:function(){var e=this,t=this.textLayerDiv,n=null;t.addEventListener("mousedown",(function(i){if(e.enhanceTextSelection&&e.textLayerRenderTask)return e.textLayerRenderTask.expandTextDivs(!0),void(n&&(clearTimeout(n),n=null));var r=t.querySelector(".endOfContent");if(r){var a=i.target!==t;if(a=a&&"none"!==window.getComputedStyle(r).getPropertyValue("-moz-user-select"),a){var s=t.getBoundingClientRect(),l=Math.max(0,(i.pageY-s.top)/s.height);r.style.top=(100*l).toFixed(2)+"%"}r.classList.add("active")}})),t.addEventListener("mouseup",(function(){if(e.enhanceTextSelection&&e.textLayerRenderTask)n=setTimeout((function(){e.textLayerRenderTask&&e.textLayerRenderTask.expandTextDivs(!1),n=null}),EXPAND_DIVS_TIMEOUT);else{var i=t.querySelector(".endOfContent");i&&(i.style.top="",i.classList.remove("active"))}}))}}]),e}(),DefaultTextLayerFactory=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"createTextLayerBuilder",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return new TextLayerBuilder({textLayerDiv:e,pageIndex:t,viewport:n,enhanceTextSelection:i})}}]),e}();exports.TextLayerBuilder=TextLayerBuilder,exports.DefaultTextLayerFactory=DefaultTextLayerFactory;