"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.FontLoader=exports.FontFaceObject=void 0;var _createClass=function(){function A(A,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(A,n.key,n)}}return function(t,e,n){return e&&A(t.prototype,e),n&&A(t,n),t}}(),_util=require("../shared/util");function _possibleConstructorReturn(A,t){if(!A)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==typeof t&&"function"!==typeof t?A:t}function _inherits(A,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);A.prototype=Object.create(t&&t.prototype,{constructor:{value:A,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(A,t):A.__proto__=t)}function _classCallCheck(A,t){if(!(A instanceof t))throw new TypeError("Cannot call a class as a function")}var BaseFontLoader=function(){function A(t){_classCallCheck(this,A),this.constructor===A&&(0,_util.unreachable)("Cannot initialize BaseFontLoader."),this.docId=t,this.nativeFontFaces=[],this.styleElement=null,this.loadingContext={requests:[],nextRequestId:0}}return _createClass(A,[{key:"addNativeFontFace",value:function(A){this.nativeFontFaces.push(A),document.fonts.add(A)}},{key:"insertRule",value:function(A){var t=this.styleElement;t||(t=this.styleElement=document.createElement("style"),t.id="PDFJS_FONT_STYLE_TAG_"+this.docId,document.documentElement.getElementsByTagName("head")[0].appendChild(t));var e=t.sheet;e.insertRule(A,e.cssRules.length)}},{key:"clear",value:function(){this.nativeFontFaces.forEach((function(A){document.fonts.delete(A)})),this.nativeFontFaces.length=0,this.styleElement&&(this.styleElement.remove(),this.styleElement=null)}},{key:"bind",value:function(A,t){var e=[],n=[],o=[],a=function(A){return A.loaded.catch((function(t){(0,_util.warn)('Failed to load font "'+A.family+'": '+t)}))},i=!0,r=!1,s=void 0;try{for(var l,u=A[Symbol.iterator]();!(i=(l=u.next()).done);i=!0){var c=l.value;if(!c.attached&&!c.missingFile)if(c.attached=!0,this.isFontLoadingAPISupported){var d=c.createNativeFontFace();d&&(this.addNativeFontFace(d),o.push(a(d)))}else{var h=c.createFontFaceRule();h&&(this.insertRule(h),e.push(h),n.push(c))}}}catch(f){r=!0,s=f}finally{try{!i&&u.return&&u.return()}finally{if(r)throw s}}var p=this._queueLoadingCallback(t);this.isFontLoadingAPISupported?Promise.all(o).then(p.complete):e.length>0&&!this.isSyncFontLoadingSupported?this._prepareFontLoadEvent(e,n,p):p.complete()}},{key:"_queueLoadingCallback",value:function(A){function t(){(0,_util.assert)(!n.done,"completeRequest() cannot be called twice."),n.done=!0;while(e.requests.length>0&&e.requests[0].done){var A=e.requests.shift();setTimeout(A.callback,0)}}var e=this.loadingContext,n={id:"pdfjs-font-loading-"+e.nextRequestId++,done:!1,complete:t,callback:A};return e.requests.push(n),n}},{key:"_prepareFontLoadEvent",value:function(A,t,e){(0,_util.unreachable)("Abstract method `_prepareFontLoadEvent`.")}},{key:"isFontLoadingAPISupported",get:function(){(0,_util.unreachable)("Abstract method `isFontLoadingAPISupported`.")}},{key:"isSyncFontLoadingSupported",get:function(){(0,_util.unreachable)("Abstract method `isSyncFontLoadingSupported`.")}},{key:"_loadTestFont",get:function(){(0,_util.unreachable)("Abstract method `_loadTestFont`.")}}]),A}(),FontLoader=void 0;exports.FontLoader=FontLoader=function(A){function t(A){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,A));return e.loadTestFontId=0,e}return _inherits(t,A),_createClass(t,[{key:"_prepareFontLoadEvent",value:function(A,t,e){function n(A,t){return A.charCodeAt(t)<<24|A.charCodeAt(t+1)<<16|A.charCodeAt(t+2)<<8|255&A.charCodeAt(t+3)}function o(A,t,e,n){var o=A.substring(0,t),a=A.substring(t+e);return o+n+a}var a=void 0,i=void 0,r=document.createElement("canvas");r.width=1,r.height=1;var s=r.getContext("2d"),l=0;function u(A,t){if(l++,l>30)return(0,_util.warn)("Load test font never loaded."),void t();s.font="30px "+A,s.fillText(".",0,20);var e=s.getImageData(0,0,1,1);e.data[3]>0?t():setTimeout(u.bind(null,A,t))}var c="lt"+Date.now()+this.loadTestFontId++,d=this._loadTestFont,h=976;d=o(d,h,c.length,c);var p=16,f=1482184792,v=n(d,p);for(a=0,i=c.length-3;a<i;a+=4)v=v-f+n(c,a)|0;a<c.length&&(v=v-f+n(c+"XXX",a)|0),d=o(d,p,4,(0,_util.string32)(v));var g="url(data:font/opentype;base64,"+btoa(d)+");",F='@font-face {font-family:"'+c+'";src:'+g+"}";this.insertRule(F);var y=[];for(a=0,i=t.length;a<i;a++)y.push(t[a].loadedName);y.push(c);var m=document.createElement("div");for(m.setAttribute("style","visibility: hidden;width: 10px; height: 10px;position: absolute; top: 0px; left: 0px;"),a=0,i=y.length;a<i;++a){var E=document.createElement("span");E.textContent="Hi",E.style.fontFamily=y[a],m.appendChild(E)}document.body.appendChild(m),u(c,(function(){document.body.removeChild(m),e.complete()}))}},{key:"isFontLoadingAPISupported",get:function(){var A="undefined"!==typeof document&&!!document.fonts;if(A&&"undefined"!==typeof navigator){var t=/Mozilla\/5.0.*?rv:(\d+).*? Gecko/.exec(navigator.userAgent);t&&t[1]<63&&(A=!1)}return(0,_util.shadow)(this,"isFontLoadingAPISupported",A)}},{key:"isSyncFontLoadingSupported",get:function(){var A=!1;if("undefined"===typeof navigator)A=!0;else{var t=/Mozilla\/5.0.*?rv:(\d+).*? Gecko/.exec(navigator.userAgent);t&&t[1]>=14&&(A=!0)}return(0,_util.shadow)(this,"isSyncFontLoadingSupported",A)}},{key:"_loadTestFont",get:function(){var A=function(){return atob("T1RUTwALAIAAAwAwQ0ZGIDHtZg4AAAOYAAAAgUZGVE1lkzZwAAAEHAAAABxHREVGABQAFQAABDgAAAAeT1MvMlYNYwkAAAEgAAAAYGNtYXABDQLUAAACNAAAAUJoZWFk/xVFDQAAALwAAAA2aGhlYQdkA+oAAAD0AAAAJGhtdHgD6AAAAAAEWAAAAAZtYXhwAAJQAAAAARgAAAAGbmFtZVjmdH4AAAGAAAAAsXBvc3T/hgAzAAADeAAAACAAAQAAAAEAALZRFsRfDzz1AAsD6AAAAADOBOTLAAAAAM4KHDwAAAAAA+gDIQAAAAgAAgAAAAAAAAABAAADIQAAAFoD6AAAAAAD6AABAAAAAAAAAAAAAAAAAAAAAQAAUAAAAgAAAAQD6AH0AAUAAAKKArwAAACMAooCvAAAAeAAMQECAAACAAYJAAAAAAAAAAAAAQAAAAAAAAAAAAAAAFBmRWQAwAAuAC4DIP84AFoDIQAAAAAAAQAAAAAAAAAAACAAIAABAAAADgCuAAEAAAAAAAAAAQAAAAEAAAAAAAEAAQAAAAEAAAAAAAIAAQAAAAEAAAAAAAMAAQAAAAEAAAAAAAQAAQAAAAEAAAAAAAUAAQAAAAEAAAAAAAYAAQAAAAMAAQQJAAAAAgABAAMAAQQJAAEAAgABAAMAAQQJAAIAAgABAAMAAQQJAAMAAgABAAMAAQQJAAQAAgABAAMAAQQJAAUAAgABAAMAAQQJAAYAAgABWABYAAAAAAAAAwAAAAMAAAAcAAEAAAAAADwAAwABAAAAHAAEACAAAAAEAAQAAQAAAC7//wAAAC7////TAAEAAAAAAAABBgAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAAAAAAD/gwAyAAAAAQAAAAAAAAAAAAAAAAAAAAABAAQEAAEBAQJYAAEBASH4DwD4GwHEAvgcA/gXBIwMAYuL+nz5tQXkD5j3CBLnEQACAQEBIVhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYAAABAQAADwACAQEEE/t3Dov6fAH6fAT+fPp8+nwHDosMCvm1Cvm1DAz6fBQAAAAAAAABAAAAAMmJbzEAAAAAzgTjFQAAAADOBOQpAAEAAAAAAAAADAAUAAQAAAABAAAAAgABAAAAAAAAAAAD6AAAAAAAAA==")};return(0,_util.shadow)(this,"_loadTestFont",A())}}]),t}(BaseFontLoader);var IsEvalSupportedCached={get value(){return(0,_util.shadow)(this,"value",(0,_util.isEvalSupported)())}},FontFaceObject=function(){function A(t,e){var n=e.isEvalSupported,o=void 0===n||n,a=e.disableFontFace,i=void 0!==a&&a,r=e.ignoreErrors,s=void 0!==r&&r,l=e.onUnsupportedFeature,u=void 0===l?null:l,c=e.fontRegistry,d=void 0===c?null:c;for(var h in _classCallCheck(this,A),this.compiledGlyphs=Object.create(null),t)this[h]=t[h];this.isEvalSupported=!1!==o,this.disableFontFace=!0===i,this.ignoreErrors=!0===s,this._onUnsupportedFeature=u,this.fontRegistry=d}return _createClass(A,[{key:"createNativeFontFace",value:function(){if(!this.data||this.disableFontFace)return null;var A=new FontFace(this.loadedName,this.data,{});return this.fontRegistry&&this.fontRegistry.registerFont(this),A}},{key:"createFontFaceRule",value:function(){if(!this.data||this.disableFontFace)return null;var A=(0,_util.bytesToString)(new Uint8Array(this.data)),t="url(data:"+this.mimetype+";base64,"+btoa(A)+");",e='@font-face {font-family:"'+this.loadedName+'";src:'+t+"}";return this.fontRegistry&&this.fontRegistry.registerFont(this,t),e}},{key:"getPathGenerator",value:function(A,t){if(void 0!==this.compiledGlyphs[t])return this.compiledGlyphs[t];var e=void 0,n=void 0;try{e=A.get(this.loadedName+"_path_"+t)}catch(s){if(!this.ignoreErrors)throw s;return this._onUnsupportedFeature&&this._onUnsupportedFeature({featureId:_util.UNSUPPORTED_FEATURES.font}),(0,_util.warn)('getPathGenerator - ignoring character: "'+s+'".'),this.compiledGlyphs[t]=function(A,t){}}if(this.isEvalSupported&&IsEvalSupportedCached.value){for(var o=void 0,a="",i=0,r=e.length;i<r;i++)n=e[i],o=void 0!==n.args?n.args.join(","):"",a+="c."+n.cmd+"("+o+");\n";return this.compiledGlyphs[t]=new Function("c","size",a)}return this.compiledGlyphs[t]=function(A,t){for(var o=0,a=e.length;o<a;o++)n=e[o],"scale"===n.cmd&&(n.args=[t,-t]),A[n.cmd].apply(A,n.args)}}}]),A}();exports.FontFaceObject=FontFaceObject,exports.FontLoader=FontLoader;