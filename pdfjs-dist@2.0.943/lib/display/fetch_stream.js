"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PDFFetchStream=void 0;var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),_util=require("../shared/util"),_network_utils=require("./network_utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise((function(e,r){function a(n,s){try{var i=t[n](s),o=i.value}catch(u){return void r(u)}if(!i.done)return Promise.resolve(o).then((function(e){a("next",e)}),(function(e){a("throw",e)}));e(o)}return a("next")}))}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function createFetchOptions(e,t,r){return{method:"GET",headers:e,signal:r&&r.signal,mode:"cors",credentials:t?"include":"same-origin",redirect:"follow"}}var PDFFetchStream=function(){function e(t){_classCallCheck(this,e),this.source=t,this.isHttp=/^https?:/i.test(t.url),this.httpHeaders=this.isHttp&&t.httpHeaders||{},this._fullRequestReader=null,this._rangeRequestReaders=[]}return _createClass(e,[{key:"getFullReader",value:function(){return(0,_util.assert)(!this._fullRequestReader),this._fullRequestReader=new PDFFetchStreamReader(this),this._fullRequestReader}},{key:"getRangeReader",value:function(e,t){var r=new PDFFetchStreamRangeReader(this,e,t);return this._rangeRequestReaders.push(r),r}},{key:"cancelAllRequests",value:function(e){this._fullRequestReader&&this._fullRequestReader.cancel(e);var t=this._rangeRequestReaders.slice(0);t.forEach((function(t){t.cancel(e)}))}}]),e}(),PDFFetchStreamReader=function(){function e(t){var r=this;_classCallCheck(this,e),this._stream=t,this._reader=null,this._loaded=0,this._filename=null;var a=t.source;for(var n in this._withCredentials=a.withCredentials,this._contentLength=a.length,this._headersCapability=(0,_util.createPromiseCapability)(),this._disableRange=a.disableRange||!1,this._rangeChunkSize=a.rangeChunkSize,this._rangeChunkSize||this._disableRange||(this._disableRange=!0),"undefined"!==typeof AbortController&&(this._abortController=new AbortController),this._isStreamingSupported=!a.disableStream,this._isRangeSupported=!a.disableRange,this._headers=new Headers,this._stream.httpHeaders){var s=this._stream.httpHeaders[n];"undefined"!==typeof s&&this._headers.append(n,s)}var i=a.url;fetch(i,createFetchOptions(this._headers,this._withCredentials,this._abortController)).then((function(e){if(!(0,_network_utils.validateResponseStatus)(e.status))throw(0,_network_utils.createResponseStatusError)(e.status,i);r._reader=e.body.getReader(),r._headersCapability.resolve();var t=function(t){return e.headers.get(t)},a=(0,_network_utils.validateRangeRequestCapabilities)({getResponseHeader:t,isHttp:r._stream.isHttp,rangeChunkSize:r._rangeChunkSize,disableRange:r._disableRange}),n=a.allowRangeRequests,s=a.suggestedLength;r._isRangeSupported=n,r._contentLength=s||r._contentLength,r._filename=(0,_network_utils.extractFilenameFromHeader)(t),!r._isStreamingSupported&&r._isRangeSupported&&r.cancel(new _util.AbortException("streaming is disabled"))})).catch(this._headersCapability.reject),this.onProgress=null}return _createClass(e,[{key:"read",value:function(){var e=_asyncToGenerator(_regenerator2.default.mark((function e(){var t,r,a,n;return _regenerator2.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._headersCapability.promise;case 2:return e.next=4,this._reader.read();case 4:if(t=e.sent,r=t.value,a=t.done,!a){e.next=9;break}return e.abrupt("return",{value:r,done:a});case 9:return this._loaded+=r.byteLength,this.onProgress&&this.onProgress({loaded:this._loaded,total:this._contentLength}),n=new Uint8Array(r).buffer,e.abrupt("return",{value:n,done:!1});case 13:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"cancel",value:function(e){this._reader&&this._reader.cancel(e),this._abortController&&this._abortController.abort()}},{key:"headersReady",get:function(){return this._headersCapability.promise}},{key:"filename",get:function(){return this._filename}},{key:"contentLength",get:function(){return this._contentLength}},{key:"isRangeSupported",get:function(){return this._isRangeSupported}},{key:"isStreamingSupported",get:function(){return this._isStreamingSupported}}]),e}(),PDFFetchStreamRangeReader=function(){function e(t,r,a){var n=this;_classCallCheck(this,e),this._stream=t,this._reader=null,this._loaded=0;var s=t.source;for(var i in this._withCredentials=s.withCredentials,this._readCapability=(0,_util.createPromiseCapability)(),this._isStreamingSupported=!s.disableStream,"undefined"!==typeof AbortController&&(this._abortController=new AbortController),this._headers=new Headers,this._stream.httpHeaders){var o=this._stream.httpHeaders[i];"undefined"!==typeof o&&this._headers.append(i,o)}var u=r+"-"+(a-1);this._headers.append("Range","bytes="+u);var l=s.url;fetch(l,createFetchOptions(this._headers,this._withCredentials,this._abortController)).then((function(e){if(!(0,_network_utils.validateResponseStatus)(e.status))throw(0,_network_utils.createResponseStatusError)(e.status,l);n._readCapability.resolve(),n._reader=e.body.getReader()})),this.onProgress=null}return _createClass(e,[{key:"read",value:function(){var e=_asyncToGenerator(_regenerator2.default.mark((function e(){var t,r,a,n;return _regenerator2.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._readCapability.promise;case 2:return e.next=4,this._reader.read();case 4:if(t=e.sent,r=t.value,a=t.done,!a){e.next=9;break}return e.abrupt("return",{value:r,done:a});case 9:return this._loaded+=r.byteLength,this.onProgress&&this.onProgress({loaded:this._loaded}),n=new Uint8Array(r).buffer,e.abrupt("return",{value:n,done:!1});case 13:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"cancel",value:function(e){this._reader&&this._reader.cancel(e),this._abortController&&this._abortController.abort()}},{key:"isStreamingSupported",get:function(){return this._isStreamingSupported}}]),e}();exports.PDFFetchStream=PDFFetchStream;