"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TilingPattern=exports.getShadingPatternFromIR=void 0;var _util=require("../shared/util"),ShadingIRs={RadialAxial:{fromIR:function(t){var e=t[1],a=t[2],r=t[3],s=t[4],n=t[5],o=t[6];return{type:"Pattern",getPattern:function(t){var i;"axial"===e?i=t.createLinearGradient(r[0],r[1],s[0],s[1]):"radial"===e&&(i=t.createRadialGradient(r[0],r[1],n,s[0],s[1],o));for(var l=0,c=a.length;l<c;++l){var h=a[l];i.addColorStop(h[0],h[1])}return i}}}}},createMeshCanvas=function(){function t(t,e,a,r,s,n,o,i){var l,c=e.coords,h=e.colors,f=t.data,u=4*t.width;c[a+1]>c[r+1]&&(l=a,a=r,r=l,l=n,n=o,o=l),c[r+1]>c[s+1]&&(l=r,r=s,s=l,l=o,o=i,i=l),c[a+1]>c[r+1]&&(l=a,a=r,r=l,l=n,n=o,o=l);var p=(c[a]+e.offsetX)*e.scaleX,v=(c[a+1]+e.offsetY)*e.scaleY,g=(c[r]+e.offsetX)*e.scaleX,d=(c[r+1]+e.offsetY)*e.scaleY,m=(c[s]+e.offsetX)*e.scaleX,y=(c[s+1]+e.offsetY)*e.scaleY;if(!(v>=y))for(var x,S,C,M,b,T,P,R,k,I=h[n],w=h[n+1],D=h[n+2],X=h[o],Y=h[o+1],L=h[o+2],_=h[i],F=h[i+1],O=h[i+2],U=Math.round(v),E=Math.round(y),G=U;G<=E;G++){G<d?(k=G<v?0:v===d?1:(v-G)/(v-d),x=p-(p-g)*k,S=I-(I-X)*k,C=w-(w-Y)*k,M=D-(D-L)*k):(k=G>y?1:d===y?0:(d-G)/(d-y),x=g-(g-m)*k,S=X-(X-_)*k,C=Y-(Y-F)*k,M=L-(L-O)*k),k=G<v?0:G>y?1:(v-G)/(v-y),b=p-(p-m)*k,T=I-(I-_)*k,P=w-(w-F)*k,R=D-(D-O)*k;for(var A=Math.round(Math.min(x,b)),V=Math.round(Math.max(x,b)),B=u*G+4*A,N=A;N<=V;N++)k=(x-N)/(x-b),k=k<0?0:k>1?1:k,f[B++]=S-(S-T)*k|0,f[B++]=C-(C-P)*k|0,f[B++]=M-(M-R)*k|0,f[B++]=255}}function e(e,a,r){var s,n,o=a.coords,i=a.colors;switch(a.type){case"lattice":var l=a.verticesPerRow,c=Math.floor(o.length/l)-1,h=l-1;for(s=0;s<c;s++)for(var f=s*l,u=0;u<h;u++,f++)t(e,r,o[f],o[f+1],o[f+l],i[f],i[f+1],i[f+l]),t(e,r,o[f+l+1],o[f+1],o[f+l],i[f+l+1],i[f+1],i[f+l]);break;case"triangles":for(s=0,n=o.length;s<n;s+=3)t(e,r,o[s],o[s+1],o[s+2],i[s],i[s+1],i[s+2]);break;default:throw new Error("illegal figure")}}function a(t,a,r,s,n,o,i,l){var c,h,f,u,p=1.1,v=3e3,g=2,d=Math.floor(t[0]),m=Math.floor(t[1]),y=Math.ceil(t[2])-d,x=Math.ceil(t[3])-m,S=Math.min(Math.ceil(Math.abs(y*a[0]*p)),v),C=Math.min(Math.ceil(Math.abs(x*a[1]*p)),v),M=y/S,b=x/C,T={coords:r,colors:s,offsetX:-d,offsetY:-m,scaleX:1/M,scaleY:1/b},P=S+2*g,R=C+2*g;if(l.isEnabled)c=l.drawFigures({width:S,height:C,backgroundColor:o,figures:n,context:T}),h=i.getCanvas("mesh",P,R,!1),h.context.drawImage(c,g,g),c=h.canvas;else{h=i.getCanvas("mesh",P,R,!1);var k=h.context,I=k.createImageData(S,C);if(o){var w=I.data;for(f=0,u=w.length;f<u;f+=4)w[f]=o[0],w[f+1]=o[1],w[f+2]=o[2],w[f+3]=255}for(f=0;f<n.length;f++)e(I,n[f],T);k.putImageData(I,g,g),c=h.canvas}return{canvas:c,offsetX:d-g*M,offsetY:m-g*b,scaleX:M,scaleY:b}}return a}();function getShadingPatternFromIR(t){var e=ShadingIRs[t[0]];if(!e)throw new Error("Unknown IR type: "+t[0]);return e.fromIR(t)}ShadingIRs.Mesh={fromIR:function(t){var e=t[2],a=t[3],r=t[4],s=t[5],n=t[6],o=t[8];return{type:"Pattern",getPattern:function(t,i,l){var c;if(l)c=_util.Util.singularValueDecompose2dScale(t.mozCurrentTransform);else if(c=_util.Util.singularValueDecompose2dScale(i.baseTransform),n){var h=_util.Util.singularValueDecompose2dScale(n);c=[c[0]*h[0],c[1]*h[1]]}var f=createMeshCanvas(s,c,e,a,r,l?null:o,i.cachedCanvases,i.webGLContext);return l||(t.setTransform.apply(t,i.baseTransform),n&&t.transform.apply(t,n)),t.translate(f.offsetX,f.offsetY),t.scale(f.scaleX,f.scaleY),t.createPattern(f.canvas,"no-repeat")}}}},ShadingIRs.Dummy={fromIR:function(){return{type:"Pattern",getPattern:function(){return"hotpink"}}}};var TilingPattern=function(){var t={COLORED:1,UNCOLORED:2},e=3e3;function a(t,e,a,r,s){this.operatorList=t[2],this.matrix=t[3]||[1,0,0,1,0,0],this.bbox=t[4],this.xstep=t[5],this.ystep=t[6],this.paintType=t[7],this.tilingType=t[8],this.color=e,this.canvasGraphicsFactory=r,this.baseTransform=s,this.type="Pattern",this.ctx=a}return a.prototype={createPatternCanvas:function(t){var a=this.operatorList,r=this.bbox,s=this.xstep,n=this.ystep,o=this.paintType,i=this.tilingType,l=this.color,c=this.canvasGraphicsFactory;(0,_util.info)("TilingType: "+i);var h=r[0],f=r[1],u=r[2],p=r[3],v=[h,f],g=[h+s,f+n],d=g[0]-v[0],m=g[1]-v[1],y=_util.Util.singularValueDecompose2dScale(this.matrix),x=_util.Util.singularValueDecompose2dScale(this.baseTransform),S=[y[0]*x[0],y[1]*x[1]];d=Math.min(Math.ceil(Math.abs(d*S[0])),e),m=Math.min(Math.ceil(Math.abs(m*S[1])),e);var C=t.cachedCanvases.getCanvas("pattern",d,m,!0),M=C.context,b=c.createCanvasGraphics(M);b.groupLevel=t.groupLevel,this.setFillAndStrokeStyleToContext(b,o,l),this.setScale(d,m,s,n),this.transformToScale(b);var T=[1,0,0,1,-v[0],-v[1]];return b.transform.apply(b,T),this.clipBbox(b,r,h,f,u,p),b.executeOperatorList(a),C.canvas},setScale:function(t,e,a,r){this.scale=[t/a,e/r]},transformToScale:function(t){var e=this.scale,a=[e[0],0,0,e[1],0,0];t.transform.apply(t,a)},scaleToContext:function(){var t=this.scale;this.ctx.scale(1/t[0],1/t[1])},clipBbox:function(t,e,a,r,s,n){if(Array.isArray(e)&&4===e.length){var o=s-a,i=n-r;t.ctx.rect(a,r,o,i),t.clip(),t.endPath()}},setFillAndStrokeStyleToContext:function(e,a,r){var s=e.ctx,n=e.current;switch(a){case t.COLORED:var o=this.ctx;s.fillStyle=o.fillStyle,s.strokeStyle=o.strokeStyle,n.fillColor=o.fillStyle,n.strokeColor=o.strokeStyle;break;case t.UNCOLORED:var i=_util.Util.makeCssRgb(r[0],r[1],r[2]);s.fillStyle=i,s.strokeStyle=i,n.fillColor=i,n.strokeColor=i;break;default:throw new _util.FormatError("Unsupported paint type: "+a)}},getPattern:function(t,e){var a=this.createPatternCanvas(e);return t=this.ctx,t.setTransform.apply(t,this.baseTransform),t.transform.apply(t,this.matrix),this.scaleToContext(),t.createPattern(a,"repeat")}},a}();exports.getShadingPatternFromIR=getShadingPatternFromIR,exports.TilingPattern=TilingPattern;