"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PDFNodeStream=void 0;var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),_util=require("../shared/util"),_network_utils=require("./network_utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==typeof t&&"function"!==typeof t?e:t}function _inherits(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise((function(e,r){function a(s,n){try{var i=t[s](n),o=i.value}catch(u){return void r(u)}if(!i.done)return Promise.resolve(o).then((function(e){a("next",e)}),(function(e){a("throw",e)}));e(o)}return a("next")}))}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var fs=require("fs"),http=require("http"),https=require("https"),url=require("url"),fileUriRegex=/^file:\/\/\/[a-zA-Z]:\//;function parseUrl(e){var t=url.parse(e);return"file:"===t.protocol||t.host?t:/^[a-z]:[/\\]/i.test(e)?url.parse("file:///"+e):(t.host||(t.protocol="file:"),t)}var PDFNodeStream=function(){function e(t){_classCallCheck(this,e),this.source=t,this.url=parseUrl(t.url),this.isHttp="http:"===this.url.protocol||"https:"===this.url.protocol,this.isFsUrl="file:"===this.url.protocol,this.httpHeaders=this.isHttp&&t.httpHeaders||{},this._fullRequest=null,this._rangeRequestReaders=[]}return _createClass(e,[{key:"getFullReader",value:function(){return(0,_util.assert)(!this._fullRequest),this._fullRequest=this.isFsUrl?new PDFNodeStreamFsFullReader(this):new PDFNodeStreamFullReader(this),this._fullRequest}},{key:"getRangeReader",value:function(e,t){var r=this.isFsUrl?new PDFNodeStreamFsRangeReader(this,e,t):new PDFNodeStreamRangeReader(this,e,t);return this._rangeRequestReaders.push(r),r}},{key:"cancelAllRequests",value:function(e){this._fullRequest&&this._fullRequest.cancel(e);var t=this._rangeRequestReaders.slice(0);t.forEach((function(t){t.cancel(e)}))}}]),e}(),BaseFullReader=function(){function e(t){_classCallCheck(this,e),this._url=t.url,this._done=!1,this._storedError=null,this.onProgress=null;var r=t.source;this._contentLength=r.length,this._loaded=0,this._filename=null,this._disableRange=r.disableRange||!1,this._rangeChunkSize=r.rangeChunkSize,this._rangeChunkSize||this._disableRange||(this._disableRange=!0),this._isStreamingSupported=!r.disableStream,this._isRangeSupported=!r.disableRange,this._readableStream=null,this._readCapability=(0,_util.createPromiseCapability)(),this._headersCapability=(0,_util.createPromiseCapability)()}return _createClass(e,[{key:"read",value:function(){var e=_asyncToGenerator(_regenerator2.default.mark((function e(){var t,r;return _regenerator2.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._readCapability.promise;case 2:if(!this._done){e.next=4;break}return e.abrupt("return",{value:void 0,done:!0});case 4:if(!this._storedError){e.next=6;break}throw this._storedError;case 6:if(t=this._readableStream.read(),null!==t){e.next=10;break}return this._readCapability=(0,_util.createPromiseCapability)(),e.abrupt("return",this.read());case 10:return this._loaded+=t.length,this.onProgress&&this.onProgress({loaded:this._loaded,total:this._contentLength}),r=new Uint8Array(t).buffer,e.abrupt("return",{value:r,done:!1});case 14:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"cancel",value:function(e){this._readableStream?this._readableStream.destroy(e):this._error(e)}},{key:"_error",value:function(e){this._storedError=e,this._readCapability.resolve()}},{key:"_setReadableStream",value:function(e){var t=this;this._readableStream=e,e.on("readable",(function(){t._readCapability.resolve()})),e.on("end",(function(){e.destroy(),t._done=!0,t._readCapability.resolve()})),e.on("error",(function(e){t._error(e)})),!this._isStreamingSupported&&this._isRangeSupported&&this._error(new _util.AbortException("streaming is disabled")),this._storedError&&this._readableStream.destroy(this._storedError)}},{key:"headersReady",get:function(){return this._headersCapability.promise}},{key:"filename",get:function(){return this._filename}},{key:"contentLength",get:function(){return this._contentLength}},{key:"isRangeSupported",get:function(){return this._isRangeSupported}},{key:"isStreamingSupported",get:function(){return this._isStreamingSupported}}]),e}(),BaseRangeReader=function(){function e(t){_classCallCheck(this,e),this._url=t.url,this._done=!1,this._storedError=null,this.onProgress=null,this._loaded=0,this._readableStream=null,this._readCapability=(0,_util.createPromiseCapability)();var r=t.source;this._isStreamingSupported=!r.disableStream}return _createClass(e,[{key:"read",value:function(){var e=_asyncToGenerator(_regenerator2.default.mark((function e(){var t,r;return _regenerator2.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this._readCapability.promise;case 2:if(!this._done){e.next=4;break}return e.abrupt("return",{value:void 0,done:!0});case 4:if(!this._storedError){e.next=6;break}throw this._storedError;case 6:if(t=this._readableStream.read(),null!==t){e.next=10;break}return this._readCapability=(0,_util.createPromiseCapability)(),e.abrupt("return",this.read());case 10:return this._loaded+=t.length,this.onProgress&&this.onProgress({loaded:this._loaded}),r=new Uint8Array(t).buffer,e.abrupt("return",{value:r,done:!1});case 14:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"cancel",value:function(e){this._readableStream?this._readableStream.destroy(e):this._error(e)}},{key:"_error",value:function(e){this._storedError=e,this._readCapability.resolve()}},{key:"_setReadableStream",value:function(e){var t=this;this._readableStream=e,e.on("readable",(function(){t._readCapability.resolve()})),e.on("end",(function(){e.destroy(),t._done=!0,t._readCapability.resolve()})),e.on("error",(function(e){t._error(e)})),this._storedError&&this._readableStream.destroy(this._storedError)}},{key:"isStreamingSupported",get:function(){return this._isStreamingSupported}}]),e}();function createRequestOptions(e,t){return{protocol:e.protocol,auth:e.auth,host:e.hostname,port:e.port,path:e.path,method:"GET",headers:t}}var PDFNodeStreamFullReader=function(e){function t(e){_classCallCheck(this,t);var r=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e)),a=function(t){if(404===t.statusCode){var a=new _util.MissingPDFException('Missing PDF "'+r._url+'".');return r._storedError=a,void r._headersCapability.reject(a)}r._headersCapability.resolve(),r._setReadableStream(t);var s=function(e){return r._readableStream.headers[e.toLowerCase()]},n=(0,_network_utils.validateRangeRequestCapabilities)({getResponseHeader:s,isHttp:e.isHttp,rangeChunkSize:r._rangeChunkSize,disableRange:r._disableRange}),i=n.allowRangeRequests,o=n.suggestedLength;r._isRangeSupported=i,r._contentLength=o||r._contentLength,r._filename=(0,_network_utils.extractFilenameFromHeader)(s)};return r._request=null,"http:"===r._url.protocol?r._request=http.request(createRequestOptions(r._url,e.httpHeaders),a):r._request=https.request(createRequestOptions(r._url,e.httpHeaders),a),r._request.on("error",(function(e){r._storedError=e,r._headersCapability.reject(e)})),r._request.end(),r}return _inherits(t,e),t}(BaseFullReader),PDFNodeStreamRangeReader=function(e){function t(e,r,a){_classCallCheck(this,t);var s=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));for(var n in s._httpHeaders={},e.httpHeaders){var i=e.httpHeaders[n];"undefined"!==typeof i&&(s._httpHeaders[n]=i)}s._httpHeaders["Range"]="bytes="+r+"-"+(a-1);var o=function(e){if(404!==e.statusCode)s._setReadableStream(e);else{var t=new _util.MissingPDFException('Missing PDF "'+s._url+'".');s._storedError=t}};return s._request=null,"http:"===s._url.protocol?s._request=http.request(createRequestOptions(s._url,s._httpHeaders),o):s._request=https.request(createRequestOptions(s._url,s._httpHeaders),o),s._request.on("error",(function(e){s._storedError=e})),s._request.end(),s}return _inherits(t,e),t}(BaseRangeReader),PDFNodeStreamFsFullReader=function(e){function t(e){_classCallCheck(this,t);var r=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e)),a=decodeURIComponent(r._url.path);return fileUriRegex.test(r._url.href)&&(a=a.replace(/^\//,"")),fs.lstat(a,(function(e,t){if(e)return"ENOENT"===e.code&&(e=new _util.MissingPDFException('Missing PDF "'+a+'".')),r._storedError=e,void r._headersCapability.reject(e);r._contentLength=t.size,r._setReadableStream(fs.createReadStream(a)),r._headersCapability.resolve()})),r}return _inherits(t,e),t}(BaseFullReader),PDFNodeStreamFsRangeReader=function(e){function t(e,r,a){_classCallCheck(this,t);var s=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e)),n=decodeURIComponent(s._url.path);return fileUriRegex.test(s._url.href)&&(n=n.replace(/^\//,"")),s._setReadableStream(fs.createReadStream(n,{start:r,end:a-1})),s}return _inherits(t,e),t}(BaseRangeReader);exports.PDFNodeStream=PDFNodeStream;