"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.WebGLContext=void 0;var _createClass=function(){function e(e,r){for(var o=0;o<r.length;o++){var t=r[o];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(r,o,t){return o&&e(r.prototype,o),t&&e(r,t),r}}(),_util=require("../shared/util");function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var WebGLContext=function(){function e(r){var o=r.enable,t=void 0!==o&&o;_classCallCheck(this,e),this._enabled=!0===t}return _createClass(e,[{key:"composeSMask",value:function(e){var r=e.layer,o=e.mask,t=e.properties;return WebGLUtils.composeSMask(r,o,t)}},{key:"drawFigures",value:function(e){var r=e.width,o=e.height,t=e.backgroundColor,a=e.figures,i=e.context;return WebGLUtils.drawFigures(r,o,t,a,i)}},{key:"clear",value:function(){WebGLUtils.cleanup()}},{key:"isEnabled",get:function(){var e=this._enabled;return e&&(e=WebGLUtils.tryInitGL()),(0,_util.shadow)(this,"isEnabled",e)}}]),e}(),WebGLUtils=function(){function e(e,r,o){var t=e.createShader(o);e.shaderSource(t,r),e.compileShader(t);var a=e.getShaderParameter(t,e.COMPILE_STATUS);if(!a){var i=e.getShaderInfoLog(t);throw new Error("Error during shader compilation: "+i)}return t}function r(r,o){return e(r,o,r.VERTEX_SHADER)}function o(r,o){return e(r,o,r.FRAGMENT_SHADER)}function t(e,r){for(var o=e.createProgram(),t=0,a=r.length;t<a;++t)e.attachShader(o,r[t]);e.linkProgram(o);var i=e.getProgramParameter(o,e.LINK_STATUS);if(!i){var n=e.getProgramInfoLog(o);throw new Error("Error during program linking: "+n)}return o}function a(e,r,o){e.activeTexture(o);var t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,r),t}var i,n;function c(){i||(n=document.createElement("canvas"),i=n.getContext("webgl",{premultipliedalpha:!1}))}var u="  attribute vec2 a_position;                                      attribute vec2 a_texCoord;                                                                                                      uniform vec2 u_resolution;                                                                                                      varying vec2 v_texCoord;                                                                                                        void main() {                                                     vec2 clipSpace = (a_position / u_resolution) * 2.0 - 1.0;       gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);                                                                              v_texCoord = a_texCoord;                                      }                                                             ",l="  precision mediump float;                                                                                                        uniform vec4 u_backdrop;                                        uniform int u_subtype;                                          uniform sampler2D u_image;                                      uniform sampler2D u_mask;                                                                                                       varying vec2 v_texCoord;                                                                                                        void main() {                                                     vec4 imageColor = texture2D(u_image, v_texCoord);               vec4 maskColor = texture2D(u_mask, v_texCoord);                 if (u_backdrop.a > 0.0) {                                         maskColor.rgb = maskColor.rgb * maskColor.a +                                   u_backdrop.rgb * (1.0 - maskColor.a);         }                                                               float lum;                                                      if (u_subtype == 0) {                                             lum = maskColor.a;                                            } else {                                                          lum = maskColor.r * 0.3 + maskColor.g * 0.59 +                        maskColor.b * 0.11;                                     }                                                               imageColor.a *= lum;                                            imageColor.rgb *= imageColor.a;                                 gl_FragColor = imageColor;                                    }                                                             ",s=null;function f(){var e,a;c(),e=n,n=null,a=i,i=null;var f=r(a,u),v=o(a,l),_=t(a,[f,v]);a.useProgram(_);var g={};g.gl=a,g.canvas=e,g.resolutionLocation=a.getUniformLocation(_,"u_resolution"),g.positionLocation=a.getAttribLocation(_,"a_position"),g.backdropLocation=a.getUniformLocation(_,"u_backdrop"),g.subtypeLocation=a.getUniformLocation(_,"u_subtype");var m=a.getAttribLocation(_,"a_texCoord"),d=a.getUniformLocation(_,"u_image"),b=a.getUniformLocation(_,"u_mask"),p=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,p),a.bufferData(a.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),a.STATIC_DRAW),a.enableVertexAttribArray(m),a.vertexAttribPointer(m,2,a.FLOAT,!1,0,0),a.uniform1i(d,0),a.uniform1i(b,1),s=g}function v(e,r,o){var t=e.width,i=e.height;s||f();var n=s,c=n.canvas,u=n.gl;c.width=t,c.height=i,u.viewport(0,0,u.drawingBufferWidth,u.drawingBufferHeight),u.uniform2f(n.resolutionLocation,t,i),o.backdrop?u.uniform4f(n.resolutionLocation,o.backdrop[0],o.backdrop[1],o.backdrop[2],1):u.uniform4f(n.resolutionLocation,0,0,0,0),u.uniform1i(n.subtypeLocation,"Luminosity"===o.subtype?1:0);var l=a(u,e,u.TEXTURE0),v=a(u,r,u.TEXTURE1),_=u.createBuffer();return u.bindBuffer(u.ARRAY_BUFFER,_),u.bufferData(u.ARRAY_BUFFER,new Float32Array([0,0,t,0,0,i,0,i,t,0,t,i]),u.STATIC_DRAW),u.enableVertexAttribArray(n.positionLocation),u.vertexAttribPointer(n.positionLocation,2,u.FLOAT,!1,0,0),u.clearColor(0,0,0,0),u.enable(u.BLEND),u.blendFunc(u.ONE,u.ONE_MINUS_SRC_ALPHA),u.clear(u.COLOR_BUFFER_BIT),u.drawArrays(u.TRIANGLES,0,6),u.flush(),u.deleteTexture(l),u.deleteTexture(v),u.deleteBuffer(_),c}var _="  attribute vec2 a_position;                                      attribute vec3 a_color;                                                                                                         uniform vec2 u_resolution;                                      uniform vec2 u_scale;                                           uniform vec2 u_offset;                                                                                                          varying vec4 v_color;                                                                                                           void main() {                                                     vec2 position = (a_position + u_offset) * u_scale;              vec2 clipSpace = (position / u_resolution) * 2.0 - 1.0;         gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);                                                                              v_color = vec4(a_color / 255.0, 1.0);                         }                                                             ",g="  precision mediump float;                                                                                                        varying vec4 v_color;                                                                                                           void main() {                                                     gl_FragColor = v_color;                                       }                                                             ",m=null;function d(){var e,a;c(),e=n,n=null,a=i,i=null;var u=r(a,_),l=o(a,g),s=t(a,[u,l]);a.useProgram(s);var f={};f.gl=a,f.canvas=e,f.resolutionLocation=a.getUniformLocation(s,"u_resolution"),f.scaleLocation=a.getUniformLocation(s,"u_scale"),f.offsetLocation=a.getUniformLocation(s,"u_offset"),f.positionLocation=a.getAttribLocation(s,"a_position"),f.colorLocation=a.getAttribLocation(s,"a_color"),m=f}function b(e,r,o,t,a){m||d();var i=m,n=i.canvas,c=i.gl;n.width=e,n.height=r,c.viewport(0,0,c.drawingBufferWidth,c.drawingBufferHeight),c.uniform2f(i.resolutionLocation,e,r);var u,l,s,f=0;for(u=0,l=t.length;u<l;u++)switch(t[u].type){case"lattice":s=t[u].coords.length/t[u].verticesPerRow|0,f+=(s-1)*(t[u].verticesPerRow-1)*6;break;case"triangles":f+=t[u].coords.length;break}var v=new Float32Array(2*f),_=new Uint8Array(3*f),g=a.coords,b=a.colors,p=0,A=0;for(u=0,l=t.length;u<l;u++){var E=t[u],L=E.coords,R=E.colors;switch(E.type){case"lattice":var T=E.verticesPerRow;s=L.length/T|0;for(var h=1;h<s;h++)for(var C=h*T+1,U=1;U<T;U++,C++)v[p]=g[L[C-T-1]],v[p+1]=g[L[C-T-1]+1],v[p+2]=g[L[C-T]],v[p+3]=g[L[C-T]+1],v[p+4]=g[L[C-1]],v[p+5]=g[L[C-1]+1],_[A]=b[R[C-T-1]],_[A+1]=b[R[C-T-1]+1],_[A+2]=b[R[C-T-1]+2],_[A+3]=b[R[C-T]],_[A+4]=b[R[C-T]+1],_[A+5]=b[R[C-T]+2],_[A+6]=b[R[C-1]],_[A+7]=b[R[C-1]+1],_[A+8]=b[R[C-1]+2],v[p+6]=v[p+2],v[p+7]=v[p+3],v[p+8]=v[p+4],v[p+9]=v[p+5],v[p+10]=g[L[C]],v[p+11]=g[L[C]+1],_[A+9]=_[A+3],_[A+10]=_[A+4],_[A+11]=_[A+5],_[A+12]=_[A+6],_[A+13]=_[A+7],_[A+14]=_[A+8],_[A+15]=b[R[C]],_[A+16]=b[R[C]+1],_[A+17]=b[R[C]+2],p+=12,A+=18;break;case"triangles":for(var k=0,x=L.length;k<x;k++)v[p]=g[L[k]],v[p+1]=g[L[k]+1],_[A]=b[R[k]],_[A+1]=b[R[k]+1],_[A+2]=b[R[k]+2],p+=2,A+=3;break}}o?c.clearColor(o[0]/255,o[1]/255,o[2]/255,1):c.clearColor(0,0,0,0),c.clear(c.COLOR_BUFFER_BIT);var y=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,y),c.bufferData(c.ARRAY_BUFFER,v,c.STATIC_DRAW),c.enableVertexAttribArray(i.positionLocation),c.vertexAttribPointer(i.positionLocation,2,c.FLOAT,!1,0,0);var w=c.createBuffer();return c.bindBuffer(c.ARRAY_BUFFER,w),c.bufferData(c.ARRAY_BUFFER,_,c.STATIC_DRAW),c.enableVertexAttribArray(i.colorLocation),c.vertexAttribPointer(i.colorLocation,3,c.UNSIGNED_BYTE,!1,0,0),c.uniform2f(i.scaleLocation,a.scaleX,a.scaleY),c.uniform2f(i.offsetLocation,a.offsetX,a.offsetY),c.drawArrays(c.TRIANGLES,0,f),c.flush(),c.deleteBuffer(y),c.deleteBuffer(w),n}return{tryInitGL:function(){try{return c(),!!i}catch(e){}return!1},composeSMask:v,drawFigures:b,cleanup:function(){s&&s.canvas&&(s.canvas.width=0,s.canvas.height=0),m&&m.canvas&&(m.canvas.width=0,m.canvas.height=0),s=null,m=null}}}();exports.WebGLContext=WebGLContext;