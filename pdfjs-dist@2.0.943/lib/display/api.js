"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.build=exports.version=exports.setPDFNetworkStreamFactory=exports.PDFPageProxy=exports.PDFDocumentProxy=exports.PDFWorker=exports.PDFDataRangeTransport=exports.LoopbackPort=exports.getDocument=void 0;var _slicedToArray=function(){function e(e,t){var r=[],n=!0,a=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done);n=!0)if(r.push(s.value),t&&r.length===t)break}catch(l){a=!0,i=l}finally{try{!n&&o["return"]&&o["return"]()}finally{if(a)throw i}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_typeof="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"===typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_util=require("../shared/util"),_dom_utils=require("./dom_utils"),_font_loader=require("./font_loader"),_api_compatibility=require("./api_compatibility"),_canvas=require("./canvas"),_global_scope=require("../shared/global_scope"),_global_scope2=_interopRequireDefault(_global_scope),_worker_options=require("./worker_options"),_message_handler=require("../shared/message_handler"),_metadata=require("./metadata"),_transport_stream=require("./transport_stream"),_webgl=require("./webgl");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var DEFAULT_RANGE_CHUNK_SIZE=65536,isWorkerDisabled=!1,fallbackWorkerSrc=void 0,fakeWorkerFilesLoader=null,useRequireEnsure=!1;"undefined"===typeof window?(isWorkerDisabled=!0,"undefined"===typeof require.ensure&&(require.ensure=require("node-ensure")),useRequireEnsure=!0):"undefined"!==typeof require&&"function"===typeof require.ensure&&(useRequireEnsure=!0),"undefined"!==typeof requirejs&&requirejs.toUrl&&(fallbackWorkerSrc=requirejs.toUrl("pdfjs-dist/build/pdf.worker.js"));var createPDFNetworkStream,dynamicLoaderSupported="undefined"!==typeof requirejs&&requirejs.load;if(fakeWorkerFilesLoader=useRequireEnsure?function(){return new Promise((function(e,t){require.ensure([],(function(){try{var r=void 0;r=require("../pdf.worker.js"),e(r.WorkerMessageHandler)}catch(n){t(n)}}),t,"pdfjsWorker")}))}:dynamicLoaderSupported?function(){return new Promise((function(e,t){requirejs(["pdfjs-dist/build/pdf.worker"],(function(r){try{e(r.WorkerMessageHandler)}catch(n){t(n)}}),t)}))}:null,!fallbackWorkerSrc&&"undefined"!==typeof document){var pdfjsFilePath=document.currentScript&&document.currentScript.src;pdfjsFilePath&&(fallbackWorkerSrc=pdfjsFilePath.replace(/(\.(?:min\.)?js)(\?.*)?$/i,".worker$1$2"))}function setPDFNetworkStreamFactory(e){createPDFNetworkStream=e}function getDocument(e){var t,r=new PDFDocumentLoadingTask;if("string"===typeof e)t={url:e};else if((0,_util.isArrayBuffer)(e))t={data:e};else if(e instanceof PDFDataRangeTransport)t={range:e};else{if("object"!==("undefined"===typeof e?"undefined":_typeof(e)))throw new Error("Invalid parameter in getDocument, need either Uint8Array, string or a parameter object");if(!e.url&&!e.data&&!e.range)throw new Error("Invalid parameter object: need either .data, .range or .url");t=e}var n=Object.create(null),a=null,i=null;for(var s in t)if("url"!==s||"undefined"===typeof window)if("range"!==s)if("worker"!==s)if("data"!==s||t[s]instanceof Uint8Array)n[s]=t[s];else{var o=t[s];if("string"===typeof o)n[s]=(0,_util.stringToBytes)(o);else if("object"!==("undefined"===typeof o?"undefined":_typeof(o))||null===o||isNaN(o.length)){if(!(0,_util.isArrayBuffer)(o))throw new Error("Invalid PDF binary data: either typed array, string or array-like object is expected in the data property.");n[s]=new Uint8Array(o)}else n[s]=new Uint8Array(o)}else i=t[s];else a=t[s];else n[s]=new _util.URL(t[s],window.location).href;n.rangeChunkSize=n.rangeChunkSize||DEFAULT_RANGE_CHUNK_SIZE,n.CMapReaderFactory=n.CMapReaderFactory||_dom_utils.DOMCMapReaderFactory,n.ignoreErrors=!0!==n.stopAtErrors,n.pdfBug=!0===n.pdfBug;var l=Object.values(_util.NativeImageDecoding);if(void 0!==n.nativeImageDecoderSupport&&l.includes(n.nativeImageDecoderSupport)||(n.nativeImageDecoderSupport=_api_compatibility.apiCompatibilityParams.nativeImageDecoderSupport||_util.NativeImageDecoding.DECODE),Number.isInteger(n.maxImageSize)||(n.maxImageSize=-1),"boolean"!==typeof n.isEvalSupported&&(n.isEvalSupported=!0),"boolean"!==typeof n.disableFontFace&&(n.disableFontFace=_api_compatibility.apiCompatibilityParams.disableFontFace||!1),"boolean"!==typeof n.disableRange&&(n.disableRange=!1),"boolean"!==typeof n.disableStream&&(n.disableStream=!1),"boolean"!==typeof n.disableAutoFetch&&(n.disableAutoFetch=!1),"boolean"!==typeof n.disableCreateObjectURL&&(n.disableCreateObjectURL=_api_compatibility.apiCompatibilityParams.disableCreateObjectURL||!1),(0,_util.setVerbosityLevel)(n.verbosity),!i){var u={postMessageTransfers:n.postMessageTransfers,verbosity:n.verbosity},d=_worker_options.GlobalWorkerOptions.workerPort;d?(u.port=d,i=PDFWorker.fromPort(u)):i=new PDFWorker(u),r._worker=i}var c=r.docId;return i.promise.then((function(){if(r.destroyed)throw new Error("Loading aborted");return _fetchDocument(i,n,a,c).then((function(e){if(r.destroyed)throw new Error("Loading aborted");var t=void 0;a?t=new _transport_stream.PDFDataTransportStream({length:n.length,initialData:n.initialData,disableRange:n.disableRange,disableStream:n.disableStream},a):n.data||(t=createPDFNetworkStream({url:n.url,length:n.length,httpHeaders:n.httpHeaders,withCredentials:n.withCredentials,rangeChunkSize:n.rangeChunkSize,disableRange:n.disableRange,disableStream:n.disableStream}));var s=new _message_handler.MessageHandler(c,e,i.port);s.postMessageTransfers=i.postMessageTransfers;var o=new WorkerTransport(s,r,t,n);r._transport=o,s.send("Ready",null)}))})).catch(r._capability.reject),r}function _fetchDocument(e,t,r,n){return e.destroyed?Promise.reject(new Error("Worker was destroyed")):(r&&(t.length=r.length,t.initialData=r.initialData),e.messageHandler.sendWithPromise("GetDocRequest",{docId:n,apiVersion:"2.0.943",source:{data:t.data,url:t.url,password:t.password,disableAutoFetch:t.disableAutoFetch,rangeChunkSize:t.rangeChunkSize,length:t.length},maxImageSize:t.maxImageSize,disableFontFace:t.disableFontFace,disableCreateObjectURL:t.disableCreateObjectURL,postMessageTransfers:e.postMessageTransfers,docBaseUrl:t.docBaseUrl,nativeImageDecoderSupport:t.nativeImageDecoderSupport,ignoreErrors:t.ignoreErrors,isEvalSupported:t.isEvalSupported}).then((function(t){if(e.destroyed)throw new Error("Worker was destroyed");return t})))}var version,build,PDFDocumentLoadingTask=function(){var e=0;function t(){this._capability=(0,_util.createPromiseCapability)(),this._transport=null,this._worker=null,this.docId="d"+e++,this.destroyed=!1,this.onPassword=null,this.onProgress=null,this.onUnsupportedFeature=null}return t.prototype={get promise(){return this._capability.promise},destroy:function(){var e=this;this.destroyed=!0;var t=this._transport?this._transport.destroy():Promise.resolve();return t.then((function(){e._transport=null,e._worker&&(e._worker.destroy(),e._worker=null)}))},then:function(e,t){return this.promise.then.apply(this.promise,arguments)}},t}(),PDFDataRangeTransport=function(){function e(t,r){_classCallCheck(this,e),this.length=t,this.initialData=r,this._rangeListeners=[],this._progressListeners=[],this._progressiveReadListeners=[],this._readyCapability=(0,_util.createPromiseCapability)()}return _createClass(e,[{key:"addRangeListener",value:function(e){this._rangeListeners.push(e)}},{key:"addProgressListener",value:function(e){this._progressListeners.push(e)}},{key:"addProgressiveReadListener",value:function(e){this._progressiveReadListeners.push(e)}},{key:"onDataRange",value:function(e,t){var r=!0,n=!1,a=void 0;try{for(var i,s=this._rangeListeners[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){var o=i.value;o(e,t)}}catch(l){n=!0,a=l}finally{try{!r&&s.return&&s.return()}finally{if(n)throw a}}}},{key:"onDataProgress",value:function(e){var t=this;this._readyCapability.promise.then((function(){var r=!0,n=!1,a=void 0;try{for(var i,s=t._progressListeners[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){var o=i.value;o(e)}}catch(l){n=!0,a=l}finally{try{!r&&s.return&&s.return()}finally{if(n)throw a}}}))}},{key:"onDataProgressiveRead",value:function(e){var t=this;this._readyCapability.promise.then((function(){var r=!0,n=!1,a=void 0;try{for(var i,s=t._progressiveReadListeners[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){var o=i.value;o(e)}}catch(l){n=!0,a=l}finally{try{!r&&s.return&&s.return()}finally{if(n)throw a}}}))}},{key:"transportReady",value:function(){this._readyCapability.resolve()}},{key:"requestDataRange",value:function(e,t){(0,_util.unreachable)("Abstract method PDFDataRangeTransport.requestDataRange")}},{key:"abort",value:function(){}}]),e}(),PDFDocumentProxy=function(){function e(t,r,n){_classCallCheck(this,e),this.loadingTask=n,this._pdfInfo=t,this._transport=r}return _createClass(e,[{key:"getPage",value:function(e){return this._transport.getPage(e)}},{key:"getPageIndex",value:function(e){return this._transport.getPageIndex(e)}},{key:"getDestinations",value:function(){return this._transport.getDestinations()}},{key:"getDestination",value:function(e){return this._transport.getDestination(e)}},{key:"getPageLabels",value:function(){return this._transport.getPageLabels()}},{key:"getPageMode",value:function(){return this._transport.getPageMode()}},{key:"getAttachments",value:function(){return this._transport.getAttachments()}},{key:"getJavaScript",value:function(){return this._transport.getJavaScript()}},{key:"getOutline",value:function(){return this._transport.getOutline()}},{key:"getPermissions",value:function(){return this._transport.getPermissions()}},{key:"getMetadata",value:function(){return this._transport.getMetadata()}},{key:"getData",value:function(){return this._transport.getData()}},{key:"getDownloadInfo",value:function(){return this._transport.downloadInfoCapability.promise}},{key:"getStats",value:function(){return this._transport.getStats()}},{key:"cleanup",value:function(){this._transport.startCleanup()}},{key:"destroy",value:function(){return this.loadingTask.destroy()}},{key:"numPages",get:function(){return this._pdfInfo.numPages}},{key:"fingerprint",get:function(){return this._pdfInfo.fingerprint}},{key:"loadingParams",get:function(){return this._transport.loadingParams}}]),e}(),PDFPageProxy=function(){function e(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.pageIndex=e,this._pageInfo=t,this.transport=r,this._stats=n?new _dom_utils.StatTimer:_dom_utils.DummyStatTimer,this._pdfBug=n,this.commonObjs=r.commonObjs,this.objs=new PDFObjects,this.cleanupAfterRender=!1,this.pendingCleanup=!1,this.intentStates=Object.create(null),this.destroyed=!1}return e.prototype={get pageNumber(){return this.pageIndex+1},get rotate(){return this._pageInfo.rotate},get ref(){return this._pageInfo.ref},get userUnit(){return this._pageInfo.userUnit},get view(){return this._pageInfo.view},getViewport:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.rotate,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return new _dom_utils.PageViewport({viewBox:this.view,scale:e,rotation:t,dontFlip:r})},getAnnotations:function(e){var t=e&&e.intent||null;return this.annotationsPromise&&this.annotationsIntent===t||(this.annotationsPromise=this.transport.getAnnotations(this.pageIndex,t),this.annotationsIntent=t),this.annotationsPromise},render:function(e){var t=this,r=this._stats;r.time("Overall"),this.pendingCleanup=!1;var n="print"===e.intent?"print":"display",a=e.canvasFactory||new _dom_utils.DOMCanvasFactory,i=new _webgl.WebGLContext({enable:e.enableWebGL});this.intentStates[n]||(this.intentStates[n]=Object.create(null));var s=this.intentStates[n];s.displayReadyCapability||(s.receivingOperatorList=!0,s.displayReadyCapability=(0,_util.createPromiseCapability)(),s.operatorList={fnArray:[],argsArray:[],lastChunk:!1},r.time("Page Request"),this.transport.messageHandler.send("RenderPageRequest",{pageIndex:this.pageNumber-1,intent:n,renderInteractiveForms:!0===e.renderInteractiveForms}));var o=function(e){var n=s.renderTasks.indexOf(l);n>=0&&s.renderTasks.splice(n,1),t.cleanupAfterRender&&(t.pendingCleanup=!0),t._tryCleanup(),e?l.capability.reject(e):l.capability.resolve(),r.timeEnd("Rendering"),r.timeEnd("Overall")},l=new InternalRenderTask(o,e,this.objs,this.commonObjs,s.operatorList,this.pageNumber,a,i,this._pdfBug);l.useRequestAnimationFrame="print"!==n,s.renderTasks||(s.renderTasks=[]),s.renderTasks.push(l);var u=l.task;return s.displayReadyCapability.promise.then((function(e){t.pendingCleanup?o():(r.time("Rendering"),l.initializeGraphics(e),l.operatorListChanged())})).catch(o),u},getOperatorList:function(){function e(){if(n.operatorList.lastChunk){n.opListReadCapability.resolve(n.operatorList);var e=n.renderTasks.indexOf(r);e>=0&&n.renderTasks.splice(e,1)}}var t="oplist";this.intentStates[t]||(this.intentStates[t]=Object.create(null));var r,n=this.intentStates[t];return n.opListReadCapability||(r={},r.operatorListChanged=e,n.receivingOperatorList=!0,n.opListReadCapability=(0,_util.createPromiseCapability)(),n.renderTasks=[],n.renderTasks.push(r),n.operatorList={fnArray:[],argsArray:[],lastChunk:!1},this._stats.time("Page Request"),this.transport.messageHandler.send("RenderPageRequest",{pageIndex:this.pageIndex,intent:t})),n.opListReadCapability.promise},streamTextContent:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=100;return this.transport.messageHandler.sendWithStream("GetTextContent",{pageIndex:this.pageNumber-1,normalizeWhitespace:!0===e.normalizeWhitespace,combineTextItems:!0!==e.disableCombineTextItems},{highWaterMark:t,size:function(e){return e.items.length}})},getTextContent:function(e){e=e||{};var t=this.streamTextContent(e);return new Promise((function(e,r){function n(){a.read().then((function(t){var r,a=t.value,s=t.done;s?e(i):(Object.assign(i.styles,a.styles),(r=i.items).push.apply(r,_toConsumableArray(a.items)),n())}),r)}var a=t.getReader(),i={items:[],styles:Object.create(null)};n()}))},_destroy:function(){this.destroyed=!0,this.transport.pageCache[this.pageIndex]=null;var e=[];return Object.keys(this.intentStates).forEach((function(t){if("oplist"!==t){var r=this.intentStates[t];r.renderTasks.forEach((function(t){var r=t.capability.promise.catch((function(){}));e.push(r),t.cancel()}))}}),this),this.objs.clear(),this.annotationsPromise=null,this.pendingCleanup=!1,Promise.all(e)},cleanup:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.pendingCleanup=!0,this._tryCleanup(e)},_tryCleanup:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.pendingCleanup&&!Object.keys(this.intentStates).some((function(e){var t=this.intentStates[e];return 0!==t.renderTasks.length||t.receivingOperatorList}),this)&&(Object.keys(this.intentStates).forEach((function(e){delete this.intentStates[e]}),this),this.objs.clear(),this.annotationsPromise=null,e&&this._stats instanceof _dom_utils.StatTimer&&(this._stats=new _dom_utils.StatTimer),this.pendingCleanup=!1)},_startRenderPage:function(e,t){var r=this.intentStates[t];r.displayReadyCapability&&r.displayReadyCapability.resolve(e)},_renderPageChunk:function(e,t){var r,n,a=this.intentStates[t];for(r=0,n=e.length;r<n;r++)a.operatorList.fnArray.push(e.fnArray[r]),a.operatorList.argsArray.push(e.argsArray[r]);for(a.operatorList.lastChunk=e.lastChunk,r=0;r<a.renderTasks.length;r++)a.renderTasks[r].operatorListChanged();e.lastChunk&&(a.receivingOperatorList=!1,this._tryCleanup())},get stats(){return this._stats instanceof _dom_utils.StatTimer?this._stats:null}},e}(),LoopbackPort=function(){function e(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];_classCallCheck(this,e),this._listeners=[],this._defer=t,this._deferred=Promise.resolve(void 0)}return _createClass(e,[{key:"postMessage",value:function(e,t){var r=this;function n(e){if("object"!==("undefined"===typeof e?"undefined":_typeof(e))||null===e)return e;if(a.has(e))return a.get(e);var r,i;if((i=e.buffer)&&(0,_util.isArrayBuffer)(i)){var s=t&&t.includes(i);return r=e===i?e:s?new e.constructor(i,e.byteOffset,e.byteLength):new e.constructor(e),a.set(e,r),r}for(var o in r=Array.isArray(e)?[]:{},a.set(e,r),e){var l,u=e;while(!(l=Object.getOwnPropertyDescriptor(u,o)))u=Object.getPrototypeOf(u);"undefined"!==typeof l.value&&"function"!==typeof l.value&&(r[o]=n(l.value))}return r}if(this._defer){var a=new WeakMap,i={data:n(e)};this._deferred.then((function(){r._listeners.forEach((function(e){e.call(this,i)}),r)}))}else this._listeners.forEach((function(t){t.call(this,{data:e})}),this)}},{key:"addEventListener",value:function(e,t){this._listeners.push(t)}},{key:"removeEventListener",value:function(e,t){var r=this._listeners.indexOf(t);this._listeners.splice(r,1)}},{key:"terminate",value:function(){this._listeners=[]}}]),e}(),PDFWorker=function(){var e=0;function t(){if(_worker_options.GlobalWorkerOptions.workerSrc)return _worker_options.GlobalWorkerOptions.workerSrc;if("undefined"!==typeof fallbackWorkerSrc)return fallbackWorkerSrc;throw new Error('No "GlobalWorkerOptions.workerSrc" specified.')}function r(){try{if("undefined"!==typeof window)return window.pdfjsWorker&&window.pdfjsWorker.WorkerMessageHandler}catch(e){}return null}var n=void 0;function a(){if(n)return n.promise;n=(0,_util.createPromiseCapability)();var e=r();if(e)return n.resolve(e),n.promise;var a=fakeWorkerFilesLoader||function(){return(0,_dom_utils.loadScript)(t()).then((function(){return window.pdfjsWorker.WorkerMessageHandler}))};return a().then(n.resolve,n.reject),n.promise}function i(e){var t="importScripts('"+e+"');";return _util.URL.createObjectURL(new Blob([t]))}var s=new WeakMap;function o(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.name,r=void 0===t?null:t,n=e.port,a=void 0===n?null:n,i=e.postMessageTransfers,o=void 0===i||i,l=e.verbosity,u=void 0===l?(0,_util.getVerbosityLevel)():l;if(a&&s.has(a))throw new Error("Cannot use more than one PDFWorker per port");if(this.name=r,this.destroyed=!1,this.postMessageTransfers=!1!==o,this.verbosity=u,this._readyCapability=(0,_util.createPromiseCapability)(),this._port=null,this._webWorker=null,this._messageHandler=null,a)return s.set(a,this),void this._initializeFromPort(a);this._initialize()}return o.prototype={get promise(){return this._readyCapability.promise},get port(){return this._port},get messageHandler(){return this._messageHandler},_initializeFromPort:function(e){this._port=e,this._messageHandler=new _message_handler.MessageHandler("main","worker",e),this._messageHandler.on("ready",(function(){})),this._readyCapability.resolve()},_initialize:function(){var e=this;if("undefined"!==typeof Worker&&!isWorkerDisabled&&!r()){var n=t();try{(0,_util.isSameOrigin)(window.location.href,n)||(n=i(new _util.URL(n,window.location).href));var a=new Worker(n),s=new _message_handler.MessageHandler("main","worker",a),o=function(){a.removeEventListener("error",l),s.destroy(),a.terminate(),e.destroyed?e._readyCapability.reject(new Error("Worker was destroyed")):e._setupFakeWorker()},l=function(){e._webWorker||o()};a.addEventListener("error",l),s.on("test",(function(t){a.removeEventListener("error",l),e.destroyed?o():t&&t.supportTypedArray?(e._messageHandler=s,e._port=a,e._webWorker=a,t.supportTransfers||(e.postMessageTransfers=!1),e._readyCapability.resolve(),s.send("configure",{verbosity:e.verbosity})):(e._setupFakeWorker(),s.destroy(),a.terminate())})),s.on("ready",(function(t){if(a.removeEventListener("error",l),e.destroyed)o();else try{u()}catch(r){e._setupFakeWorker()}}));var u=function(){var t=new Uint8Array([e.postMessageTransfers?255:0]);try{s.send("test",t,[t.buffer])}catch(r){(0,_util.info)("Cannot use postMessage transfers"),t[0]=0,s.send("test",t)}};return void u()}catch(d){(0,_util.info)("The worker has been disabled.")}}this._setupFakeWorker()},_setupFakeWorker:function(){var t=this;isWorkerDisabled||((0,_util.warn)("Setting up fake worker."),isWorkerDisabled=!0),a().then((function(r){if(t.destroyed)t._readyCapability.reject(new Error("Worker was destroyed"));else{var n=new LoopbackPort;t._port=n;var a="fake"+e++,i=new _message_handler.MessageHandler(a+"_worker",a,n);r.setup(i,n);var s=new _message_handler.MessageHandler(a,a+"_worker",n);t._messageHandler=s,t._readyCapability.resolve()}})).catch((function(e){t._readyCapability.reject(new Error('Setting up fake worker failed: "'+e.message+'".'))}))},destroy:function(){this.destroyed=!0,this._webWorker&&(this._webWorker.terminate(),this._webWorker=null),s.delete(this._port),this._port=null,this._messageHandler&&(this._messageHandler.destroy(),this._messageHandler=null)}},o.fromPort=function(e){if(!e||!e.port)throw new Error("PDFWorker.fromPort - invalid method signature.");return s.has(e.port)?s.get(e.port):new o(e)},o.getWorkerSrc=function(){return t()},o}(),WorkerTransport=function(){function e(t,r,n,a){_classCallCheck(this,e),this.messageHandler=t,this.loadingTask=r,this.commonObjs=new PDFObjects,this.fontLoader=new _font_loader.FontLoader(r.docId),this._params=a,this.CMapReaderFactory=new a.CMapReaderFactory({baseUrl:a.cMapUrl,isCompressed:a.cMapPacked}),this.destroyed=!1,this.destroyCapability=null,this._passwordCapability=null,this._networkStream=n,this._fullReader=null,this._lastProgress=null,this.pageCache=[],this.pagePromises=[],this.downloadInfoCapability=(0,_util.createPromiseCapability)(),this.setupMessageHandler()}return _createClass(e,[{key:"destroy",value:function(){var e=this;if(this.destroyCapability)return this.destroyCapability.promise;this.destroyed=!0,this.destroyCapability=(0,_util.createPromiseCapability)(),this._passwordCapability&&this._passwordCapability.reject(new Error("Worker was destroyed during onPassword callback"));var t=[];this.pageCache.forEach((function(e){e&&t.push(e._destroy())})),this.pageCache=[],this.pagePromises=[];var r=this.messageHandler.sendWithPromise("Terminate",null);return t.push(r),Promise.all(t).then((function(){e.fontLoader.clear(),e._networkStream&&e._networkStream.cancelAllRequests(),e.messageHandler&&(e.messageHandler.destroy(),e.messageHandler=null),e.destroyCapability.resolve()}),this.destroyCapability.reject),this.destroyCapability.promise}},{key:"setupMessageHandler",value:function(){var e=this.messageHandler,t=this.loadingTask;e.on("GetReader",(function(e,t){var r=this;(0,_util.assert)(this._networkStream),this._fullReader=this._networkStream.getFullReader(),this._fullReader.onProgress=function(e){r._lastProgress={loaded:e.loaded,total:e.total}},t.onPull=function(){r._fullReader.read().then((function(e){var r=e.value,n=e.done;n?t.close():((0,_util.assert)((0,_util.isArrayBuffer)(r)),t.enqueue(new Uint8Array(r),1,[r]))})).catch((function(e){t.error(e)}))},t.onCancel=function(e){r._fullReader.cancel(e)}}),this),e.on("ReaderHeadersReady",(function(e){var r=this,n=(0,_util.createPromiseCapability)(),a=this._fullReader;return a.headersReady.then((function(){a.isStreamingSupported&&a.isRangeSupported||(r._lastProgress&&t.onProgress&&t.onProgress(r._lastProgress),a.onProgress=function(e){t.onProgress&&t.onProgress({loaded:e.loaded,total:e.total})}),n.resolve({isStreamingSupported:a.isStreamingSupported,isRangeSupported:a.isRangeSupported,contentLength:a.contentLength})}),n.reject),n.promise}),this),e.on("GetRangeReader",(function(e,t){(0,_util.assert)(this._networkStream);var r=this._networkStream.getRangeReader(e.begin,e.end);t.onPull=function(){r.read().then((function(e){var r=e.value,n=e.done;n?t.close():((0,_util.assert)((0,_util.isArrayBuffer)(r)),t.enqueue(new Uint8Array(r),1,[r]))})).catch((function(e){t.error(e)}))},t.onCancel=function(e){r.cancel(e)}}),this),e.on("GetDoc",(function(e){var r=e.pdfInfo;this.numPages=r.numPages,this.pdfDocument=new PDFDocumentProxy(r,this,t),t._capability.resolve(this.pdfDocument)}),this),e.on("PasswordRequest",(function(e){var r=this;if(this._passwordCapability=(0,_util.createPromiseCapability)(),t.onPassword){var n=function(e){r._passwordCapability.resolve({password:e})};try{t.onPassword(n,e.code)}catch(a){this._passwordCapability.reject(a)}}else this._passwordCapability.reject(new _util.PasswordException(e.message,e.code));return this._passwordCapability.promise}),this),e.on("PasswordException",(function(e){t._capability.reject(new _util.PasswordException(e.message,e.code))}),this),e.on("InvalidPDF",(function(e){t._capability.reject(new _util.InvalidPDFException(e.message))}),this),e.on("MissingPDF",(function(e){t._capability.reject(new _util.MissingPDFException(e.message))}),this),e.on("UnexpectedResponse",(function(e){t._capability.reject(new _util.UnexpectedResponseException(e.message,e.status))}),this),e.on("UnknownError",(function(e){t._capability.reject(new _util.UnknownErrorException(e.message,e.details))}),this),e.on("DataLoaded",(function(e){t.onProgress&&t.onProgress({loaded:e.length,total:e.length}),this.downloadInfoCapability.resolve(e)}),this),e.on("StartRenderPage",(function(e){if(!this.destroyed){var t=this.pageCache[e.pageIndex];t._stats.timeEnd("Page Request"),t._startRenderPage(e.transparency,e.intent)}}),this),e.on("RenderPageChunk",(function(e){if(!this.destroyed){var t=this.pageCache[e.pageIndex];t._renderPageChunk(e.operatorList,e.intent)}}),this),e.on("commonobj",(function(e){var t=this;if(!this.destroyed){var r=_slicedToArray(e,3),n=r[0],a=r[1],i=r[2];if(!this.commonObjs.hasData(n))switch(a){case"Font":var s=this._params;if("error"in i){var o=i.error;(0,_util.warn)("Error during font loading: "+o),this.commonObjs.resolve(n,o);break}var l=null;s.pdfBug&&_global_scope2.default.FontInspector&&_global_scope2.default.FontInspector.enabled&&(l={registerFont:function(e,t){_global_scope2.default["FontInspector"].fontAdded(e,t)}});var u=new _font_loader.FontFaceObject(i,{isEvalSupported:s.isEvalSupported,disableFontFace:s.disableFontFace,ignoreErrors:s.ignoreErrors,onUnsupportedFeature:this._onUnsupportedFeature.bind(this),fontRegistry:l}),d=function(e){t.commonObjs.resolve(n,u)};this.fontLoader.bind([u],d);break;case"FontPath":this.commonObjs.resolve(n,i);break;default:throw new Error("Got unknown common object type "+a)}}}),this),e.on("obj",(function(e){if(!this.destroyed){var t=_slicedToArray(e,4),r=t[0],n=t[1],a=t[2],i=t[3],s=this.pageCache[n];if(!s.objs.hasData(r))switch(a){case"JpegStream":return new Promise((function(e,t){var r=new Image;r.onload=function(){e(r)},r.onerror=function(){t(new Error("Error during JPEG image loading"))},r.src=i})).then((function(e){s.objs.resolve(r,e)}));case"Image":s.objs.resolve(r,i);var o=8e6;i&&"data"in i&&i.data.length>o&&(s.cleanupAfterRender=!0);break;default:throw new Error("Got unknown object type "+a)}}}),this),e.on("DocProgress",(function(e){this.destroyed||t.onProgress&&t.onProgress({loaded:e.loaded,total:e.total})}),this),e.on("PageError",(function(e){if(!this.destroyed){var t=this.pageCache[e.pageNum-1],r=t.intentStates[e.intent];if(!r.displayReadyCapability)throw new Error(e.error);if(r.displayReadyCapability.reject(e.error),r.operatorList){r.operatorList.lastChunk=!0;for(var n=0;n<r.renderTasks.length;n++)r.renderTasks[n].operatorListChanged()}}}),this),e.on("UnsupportedFeature",this._onUnsupportedFeature,this),e.on("JpegDecode",(function(e){if(this.destroyed)return Promise.reject(new Error("Worker was destroyed"));if("undefined"===typeof document)return Promise.reject(new Error('"document" is not defined.'));var t=_slicedToArray(e,2),r=t[0],n=t[1];return 3!==n&&1!==n?Promise.reject(new Error("Only 3 components or 1 component can be returned")):new Promise((function(e,t){var a=new Image;a.onload=function(){var t=a.width,r=a.height,i=t*r,s=4*i,o=new Uint8ClampedArray(i*n),l=document.createElement("canvas");l.width=t,l.height=r;var u=l.getContext("2d");u.drawImage(a,0,0);var d=u.getImageData(0,0,t,r).data;if(3===n)for(var c=0,p=0;c<s;c+=4,p+=3)o[p]=d[c],o[p+1]=d[c+1],o[p+2]=d[c+2];else if(1===n)for(var h=0,f=0;h<s;h+=4,f++)o[f]=d[h];e({data:o,width:t,height:r})},a.onerror=function(){t(new Error("JpegDecode failed to load image"))},a.src=r}))}),this),e.on("FetchBuiltInCMap",(function(e){return this.destroyed?Promise.reject(new Error("Worker was destroyed")):this.CMapReaderFactory.fetch({name:e.name})}),this)}},{key:"_onUnsupportedFeature",value:function(e){var t=e.featureId;this.destroyed||this.loadingTask.onUnsupportedFeature&&this.loadingTask.onUnsupportedFeature(t)}},{key:"getData",value:function(){return this.messageHandler.sendWithPromise("GetData",null)}},{key:"getPage",value:function(e){var t=this;if(!Number.isInteger(e)||e<=0||e>this.numPages)return Promise.reject(new Error("Invalid page request"));var r=e-1;if(r in this.pagePromises)return this.pagePromises[r];var n=this.messageHandler.sendWithPromise("GetPage",{pageIndex:r}).then((function(e){if(t.destroyed)throw new Error("Transport destroyed");var n=new PDFPageProxy(r,e,t,t._params.pdfBug);return t.pageCache[r]=n,n}));return this.pagePromises[r]=n,n}},{key:"getPageIndex",value:function(e){return this.messageHandler.sendWithPromise("GetPageIndex",{ref:e}).catch((function(e){return Promise.reject(new Error(e))}))}},{key:"getAnnotations",value:function(e,t){return this.messageHandler.sendWithPromise("GetAnnotations",{pageIndex:e,intent:t})}},{key:"getDestinations",value:function(){return this.messageHandler.sendWithPromise("GetDestinations",null)}},{key:"getDestination",value:function(e){return"string"!==typeof e?Promise.reject(new Error("Invalid destination request.")):this.messageHandler.sendWithPromise("GetDestination",{id:e})}},{key:"getPageLabels",value:function(){return this.messageHandler.sendWithPromise("GetPageLabels",null)}},{key:"getPageMode",value:function(){return this.messageHandler.sendWithPromise("GetPageMode",null)}},{key:"getAttachments",value:function(){return this.messageHandler.sendWithPromise("GetAttachments",null)}},{key:"getJavaScript",value:function(){return this.messageHandler.sendWithPromise("GetJavaScript",null)}},{key:"getOutline",value:function(){return this.messageHandler.sendWithPromise("GetOutline",null)}},{key:"getPermissions",value:function(){return this.messageHandler.sendWithPromise("GetPermissions",null)}},{key:"getMetadata",value:function(){var e=this;return this.messageHandler.sendWithPromise("GetMetadata",null).then((function(t){return{info:t[0],metadata:t[1]?new _metadata.Metadata(t[1]):null,contentDispositionFilename:e._fullReader?e._fullReader.filename:null}}))}},{key:"getStats",value:function(){return this.messageHandler.sendWithPromise("GetStats",null)}},{key:"startCleanup",value:function(){var e=this;this.messageHandler.sendWithPromise("Cleanup",null).then((function(){for(var t=0,r=e.pageCache.length;t<r;t++){var n=e.pageCache[t];n&&n.cleanup()}e.commonObjs.clear(),e.fontLoader.clear()}))}},{key:"loadingParams",get:function(){var e=this._params;return(0,_util.shadow)(this,"loadingParams",{disableAutoFetch:e.disableAutoFetch,disableCreateObjectURL:e.disableCreateObjectURL,disableFontFace:e.disableFontFace,nativeImageDecoderSupport:e.nativeImageDecoderSupport})}}]),e}(),PDFObjects=function(){function e(){this.objs=Object.create(null)}return e.prototype={ensureObj:function(e){if(this.objs[e])return this.objs[e];var t={capability:(0,_util.createPromiseCapability)(),data:null,resolved:!1};return this.objs[e]=t,t},get:function(e,t){if(t)return this.ensureObj(e).capability.promise.then(t),null;var r=this.objs[e];if(!r||!r.resolved)throw new Error("Requesting object that isn't resolved yet "+e);return r.data},resolve:function(e,t){var r=this.ensureObj(e);r.resolved=!0,r.data=t,r.capability.resolve(t)},isResolved:function(e){var t=this.objs;return!!t[e]&&t[e].resolved},hasData:function(e){return this.isResolved(e)},getData:function(e){var t=this.objs;return t[e]&&t[e].resolved?t[e].data:null},clear:function(){this.objs=Object.create(null)}},e}(),RenderTask=function(){function e(e){this._internalRenderTask=e,this.onContinue=null}return e.prototype={get promise(){return this._internalRenderTask.capability.promise},cancel:function(){this._internalRenderTask.cancel()},then:function(e,t){return this.promise.then.apply(this.promise,arguments)}},e}(),InternalRenderTask=function(){var e=new WeakMap;function t(e,t,r,n,a,i,s,o){var l=arguments.length>8&&void 0!==arguments[8]&&arguments[8];this.callback=e,this.params=t,this.objs=r,this.commonObjs=n,this.operatorListIdx=null,this.operatorList=a,this.pageNumber=i,this.canvasFactory=s,this.webGLContext=o,this._pdfBug=l,this.running=!1,this.graphicsReadyCallback=null,this.graphicsReady=!1,this.useRequestAnimationFrame=!1,this.cancelled=!1,this.capability=(0,_util.createPromiseCapability)(),this.task=new RenderTask(this),this._continueBound=this._continue.bind(this),this._scheduleNextBound=this._scheduleNext.bind(this),this._nextBound=this._next.bind(this),this._canvas=t.canvasContext.canvas}return t.prototype={initializeGraphics:function(t){if(!this.cancelled){if(this._canvas){if(e.has(this._canvas))throw new Error("Cannot use the same canvas during multiple render() operations. Use different canvas or ensure previous operations were cancelled or completed.");e.set(this._canvas,this)}this._pdfBug&&_global_scope2.default.StepperManager&&_global_scope2.default.StepperManager.enabled&&(this.stepper=_global_scope2.default.StepperManager.create(this.pageNumber-1),this.stepper.init(this.operatorList),this.stepper.nextBreakPoint=this.stepper.getNextBreakPoint());var r=this.params;this.gfx=new _canvas.CanvasGraphics(r.canvasContext,this.commonObjs,this.objs,this.canvasFactory,this.webGLContext,r.imageLayer),this.gfx.beginDrawing({transform:r.transform,viewport:r.viewport,transparency:t,background:r.background}),this.operatorListIdx=0,this.graphicsReady=!0,this.graphicsReadyCallback&&this.graphicsReadyCallback()}},cancel:function(){this.running=!1,this.cancelled=!0,this._canvas&&e.delete(this._canvas),this.callback(new _dom_utils.RenderingCancelledException("Rendering cancelled, page "+this.pageNumber,"canvas"))},operatorListChanged:function(){this.graphicsReady?(this.stepper&&this.stepper.updateOperatorList(this.operatorList),this.running||this._continue()):this.graphicsReadyCallback||(this.graphicsReadyCallback=this._continueBound)},_continue:function(){this.running=!0,this.cancelled||(this.task.onContinue?this.task.onContinue(this._scheduleNextBound):this._scheduleNext())},_scheduleNext:function(){var e=this;this.useRequestAnimationFrame&&"undefined"!==typeof window?window.requestAnimationFrame((function(){e._nextBound().catch(e.callback)})):Promise.resolve().then(this._nextBound).catch(this.callback)},_next:function(){var t=this;return new Promise((function(){t.cancelled||(t.operatorListIdx=t.gfx.executeOperatorList(t.operatorList,t.operatorListIdx,t._continueBound,t.stepper),t.operatorListIdx===t.operatorList.argsArray.length&&(t.running=!1,t.operatorList.lastChunk&&(t.gfx.endDrawing(),t._canvas&&e.delete(t._canvas),t.callback())))}))}},t}();exports.version=version="2.0.943",exports.build=build="dc98bf76",exports.getDocument=getDocument,exports.LoopbackPort=LoopbackPort,exports.PDFDataRangeTransport=PDFDataRangeTransport,exports.PDFWorker=PDFWorker,exports.PDFDocumentProxy=PDFDocumentProxy,exports.PDFPageProxy=PDFPageProxy,exports.setPDFNetworkStreamFactory=setPDFNetworkStreamFactory,exports.version=version,exports.build=build;