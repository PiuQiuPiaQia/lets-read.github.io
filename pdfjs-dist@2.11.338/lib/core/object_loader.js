"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ObjectLoader=void 0;var _primitives=require("./primitives.js"),_core_utils=require("./core_utils.js"),_util=require("../shared/util.js");function mayHaveChildren(e){return e instanceof _primitives.Ref||e instanceof _primitives.Dict||Array.isArray(e)||(0,_primitives.isStream)(e)}function addChildren(e,t){if(e instanceof _primitives.Dict)e=e.getRawValues();else if((0,_primitives.isStream)(e))e=e.dict.getRawValues();else if(!Array.isArray(e))return;for(const i of e)mayHaveChildren(i)&&t.push(i)}class ObjectLoader{constructor(e,t,i){this.dict=e,this.keys=t,this.xref=i,this.refSet=null}async load(){if(this.xref.stream.isDataLoaded)return;const{keys:e,dict:t}=this;this.refSet=new _primitives.RefSet;const i=[];for(let s=0,r=e.length;s<r;s++){const r=t.getRaw(e[s]);void 0!==r&&i.push(r)}return this._walk(i)}async _walk(e){const t=[],i=[];while(e.length){let r=e.pop();if(r instanceof _primitives.Ref){if(this.refSet.has(r))continue;try{this.refSet.put(r),r=this.xref.fetch(r)}catch(s){if(!(s instanceof _core_utils.MissingDataException)){(0,_util.warn)(`ObjectLoader._walk - requesting all data: "${s}".`),this.refSet=null;const{manager:e}=this.xref.stream;return e.requestAllChunks()}t.push(r),i.push({begin:s.begin,end:s.end})}}if((0,_primitives.isStream)(r)){const e=r.getBaseStreams();if(e){let s=!1;for(const t of e)t.isDataLoaded||(s=!0,i.push({begin:t.start,end:t.end}));s&&t.push(r)}}addChildren(r,e)}if(i.length){await this.xref.stream.manager.requestRanges(i);for(const e of t)e instanceof _primitives.Ref&&this.refSet.remove(e);return this._walk(t)}this.refSet=null}}exports.ObjectLoader=ObjectLoader;