"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.OperatorList=void 0;var _util=require("../shared/util.js");function addState(t,e,r,i,s){let a=t;for(let n=0,l=e.length-1;n<l;n++){const t=e[n];a=a[t]||(a[t]=[])}a[e[e.length-1]]={checkFn:r,iterateFn:i,processFn:s}}function handlePaintSolidColorImageMask(t,e,r,i){const s=t+2;let a;for(a=0;a<e;a++){const t=i[s+4*a],e=1===t.length&&t[0];if(!e||1!==e.width||1!==e.height||e.data.length&&(1!==e.data.length||0!==e.data[0]))break;r[s+4*a]=_util.OPS.paintSolidColorImageMask}return e-a}const InitialState=[];addState(InitialState,[_util.OPS.save,_util.OPS.transform,_util.OPS.paintInlineImageXObject,_util.OPS.restore],null,(function(t,e){const r=t.fnArray,i=t.iCurr-3,s=(e-i)%4;switch(s){case 0:return r[e]===_util.OPS.save;case 1:return r[e]===_util.OPS.transform;case 2:return r[e]===_util.OPS.paintInlineImageXObject;case 3:return r[e]===_util.OPS.restore}throw new Error(`iterateInlineImageGroup - invalid pos: ${s}`)}),(function(t,e){const r=10,i=200,s=1e3,a=1,n=t.fnArray,l=t.argsArray,h=t.iCurr,u=h-3,o=h-2,c=h-1,d=Math.min(Math.floor((e-u)/4),i);if(d<r)return e-(e-u)%4;let p=0;const f=[];let g=0,O=a,_=a;for(let A=0;A<d;A++){const t=l[o+(A<<2)],e=l[c+(A<<2)][0];O+e.width>s&&(p=Math.max(p,O),_+=g+2*a,O=0,g=0),f.push({transform:t,x:O,y:_,w:e.width,h:e.height}),O+=e.width+2*a,g=Math.max(g,e.height)}const S=Math.max(p,O)+a,m=_+g+a,P=new Uint8ClampedArray(S*m*4),y=S<<2;for(let A=0;A<d;A++){const t=l[c+(A<<2)][0].data,e=f[A].w<<2;let r=0,i=f[A].x+f[A].y*S<<2;P.set(t.subarray(0,e),i-y);for(let s=0,a=f[A].h;s<a;s++)P.set(t.subarray(r,r+e),i),r+=e,i+=y;P.set(t.subarray(r-e,r),i);while(i>=0)t[i-4]=t[i],t[i-3]=t[i+1],t[i-2]=t[i+2],t[i-1]=t[i+3],t[i+e]=t[i+e-4],t[i+e+1]=t[i+e-3],t[i+e+2]=t[i+e-2],t[i+e+3]=t[i+e-1],i-=y}return n.splice(u,4*d,_util.OPS.paintInlineImageXObjectGroup),l.splice(u,4*d,[{width:S,height:m,kind:_util.ImageKind.RGBA_32BPP,data:P},f]),u+1})),addState(InitialState,[_util.OPS.save,_util.OPS.transform,_util.OPS.paintImageMaskXObject,_util.OPS.restore],null,(function(t,e){const r=t.fnArray,i=t.iCurr-3,s=(e-i)%4;switch(s){case 0:return r[e]===_util.OPS.save;case 1:return r[e]===_util.OPS.transform;case 2:return r[e]===_util.OPS.paintImageMaskXObject;case 3:return r[e]===_util.OPS.restore}throw new Error(`iterateImageMaskGroup - invalid pos: ${s}`)}),(function(t,e){const r=10,i=100,s=1e3,a=t.fnArray,n=t.argsArray,l=t.iCurr,h=l-3,u=l-2,o=l-1;let c=Math.floor((e-h)/4);if(c=handlePaintSolidColorImageMask(h,c,a,n),c<r)return e-(e-h)%4;let d,p,f=!1;const g=n[o][0],O=n[u][0],_=n[u][1],S=n[u][2],m=n[u][3];if(_===S){f=!0,d=u+4;let t=o+4;for(let e=1;e<c;e++,d+=4,t+=4)if(p=n[d],n[t][0]!==g||p[0]!==O||p[1]!==_||p[2]!==S||p[3]!==m){e<r?f=!1:c=e;break}}if(f){c=Math.min(c,s);const t=new Float32Array(2*c);d=u;for(let e=0;e<c;e++,d+=4)p=n[d],t[e<<1]=p[4],t[1+(e<<1)]=p[5];a.splice(h,4*c,_util.OPS.paintImageMaskXObjectRepeat),n.splice(h,4*c,[g,O,_,S,m,t])}else{c=Math.min(c,i);const t=[];for(let e=0;e<c;e++){p=n[u+(e<<2)];const r=n[o+(e<<2)][0];t.push({data:r.data,width:r.width,height:r.height,transform:p})}a.splice(h,4*c,_util.OPS.paintImageMaskXObjectGroup),n.splice(h,4*c,[t])}return h+1})),addState(InitialState,[_util.OPS.save,_util.OPS.transform,_util.OPS.paintImageXObject,_util.OPS.restore],(function(t){const e=t.argsArray,r=t.iCurr-2;return 0===e[r][1]&&0===e[r][2]}),(function(t,e){const r=t.fnArray,i=t.argsArray,s=t.iCurr-3,a=(e-s)%4;switch(a){case 0:return r[e]===_util.OPS.save;case 1:if(r[e]!==_util.OPS.transform)return!1;const s=t.iCurr-2,a=i[s][0],n=i[s][3];return i[e][0]===a&&0===i[e][1]&&0===i[e][2]&&i[e][3]===n;case 2:if(r[e]!==_util.OPS.paintImageXObject)return!1;const l=t.iCurr-1,h=i[l][0];return i[e][0]===h;case 3:return r[e]===_util.OPS.restore}throw new Error(`iterateImageGroup - invalid pos: ${a}`)}),(function(t,e){const r=3,i=1e3,s=t.fnArray,a=t.argsArray,n=t.iCurr,l=n-3,h=n-2,u=n-1,o=a[u][0],c=a[h][0],d=a[h][3],p=Math.min(Math.floor((e-l)/4),i);if(p<r)return e-(e-l)%4;const f=new Float32Array(2*p);let g=h;for(let _=0;_<p;_++,g+=4){const t=a[g];f[_<<1]=t[4],f[1+(_<<1)]=t[5]}const O=[o,c,d,f];return s.splice(l,4*p,_util.OPS.paintImageXObjectRepeat),a.splice(l,4*p,O),l+1})),addState(InitialState,[_util.OPS.beginText,_util.OPS.setFont,_util.OPS.setTextMatrix,_util.OPS.showText,_util.OPS.endText],null,(function(t,e){const r=t.fnArray,i=t.argsArray,s=t.iCurr-4,a=(e-s)%5;switch(a){case 0:return r[e]===_util.OPS.beginText;case 1:return r[e]===_util.OPS.setFont;case 2:return r[e]===_util.OPS.setTextMatrix;case 3:if(r[e]!==_util.OPS.showText)return!1;const s=t.iCurr-3,a=i[s][0],n=i[s][1];return i[e][0]===a&&i[e][1]===n;case 4:return r[e]===_util.OPS.endText}throw new Error(`iterateShowTextGroup - invalid pos: ${a}`)}),(function(t,e){const r=3,i=1e3,s=t.fnArray,a=t.argsArray,n=t.iCurr,l=n-4,h=n-3,u=n-2,o=n-1,c=n,d=a[h][0],p=a[h][1];let f=Math.min(Math.floor((e-l)/5),i);if(f<r)return e-(e-l)%5;let g=l;l>=4&&s[l-4]===s[h]&&s[l-3]===s[u]&&s[l-2]===s[o]&&s[l-1]===s[c]&&a[l-4][0]===d&&a[l-4][1]===p&&(f++,g-=5);let O=g+4;for(let _=1;_<f;_++)s.splice(O,3),a.splice(O,3),O+=2;return O+1}));class NullOptimizer{constructor(t){this.queue=t}_optimize(){}push(t,e){this.queue.fnArray.push(t),this.queue.argsArray.push(e),this._optimize()}flush(){}reset(){}}class QueueOptimizer extends NullOptimizer{constructor(t){super(t),this.state=null,this.context={iCurr:0,fnArray:t.fnArray,argsArray:t.argsArray},this.match=null,this.lastProcessed=0}_optimize(){const t=this.queue.fnArray;let e=this.lastProcessed,r=t.length,i=this.state,s=this.match;if(!i&&!s&&e+1===r&&!InitialState[t[e]])return void(this.lastProcessed=r);const a=this.context;while(e<r){if(s){const n=(0,s.iterateFn)(a,e);if(n){e++;continue}if(e=(0,s.processFn)(a,e+1),r=t.length,s=null,i=null,e>=r)break}i=(i||InitialState)[t[e]],i&&!Array.isArray(i)?(a.iCurr=e,e++,!i.checkFn||(0,i.checkFn)(a)?(s=i,i=null):i=null):e++}this.state=i,this.match=s,this.lastProcessed=e}flush(){while(this.match){const t=this.queue.fnArray.length;this.lastProcessed=(0,this.match.processFn)(this.context,t),this.match=null,this.state=null,this._optimize()}}reset(){this.state=null,this.match=null,this.lastProcessed=0}}class OperatorList{static get CHUNK_SIZE(){return(0,_util.shadow)(this,"CHUNK_SIZE",1e3)}static get CHUNK_SIZE_ABOUT(){return(0,_util.shadow)(this,"CHUNK_SIZE_ABOUT",this.CHUNK_SIZE-5)}constructor(t=0,e){this._streamSink=e,this.fnArray=[],this.argsArray=[],!e||t&_util.RenderingIntentFlag.OPLIST?this.optimizer=new NullOptimizer(this):this.optimizer=new QueueOptimizer(this),this.dependencies=new Set,this._totalLength=0,this.weight=0,this._resolved=e?null:Promise.resolve()}get length(){return this.argsArray.length}get ready(){return this._resolved||this._streamSink.ready}get totalLength(){return this._totalLength+this.length}addOp(t,e){this.optimizer.push(t,e),this.weight++,this._streamSink&&(this.weight>=OperatorList.CHUNK_SIZE||this.weight>=OperatorList.CHUNK_SIZE_ABOUT&&(t===_util.OPS.restore||t===_util.OPS.endText))&&this.flush()}addDependency(t){this.dependencies.has(t)||(this.dependencies.add(t),this.addOp(_util.OPS.dependency,[t]))}addDependencies(t){for(const e of t)this.addDependency(e)}addOpList(t){if(t instanceof OperatorList){for(const e of t.dependencies)this.dependencies.add(e);for(let e=0,r=t.length;e<r;e++)this.addOp(t.fnArray[e],t.argsArray[e])}else(0,_util.warn)('addOpList - ignoring invalid "opList" parameter.')}getIR(){return{fnArray:this.fnArray,argsArray:this.argsArray,length:this.length}}get _transfers(){const t=[],{fnArray:e,argsArray:r,length:i}=this;for(let s=0;s<i;s++)switch(e[s]){case _util.OPS.paintInlineImageXObject:case _util.OPS.paintInlineImageXObjectGroup:case _util.OPS.paintImageMaskXObject:const e=r[s][0];e.cached||t.push(e.data.buffer);break}return t}flush(t=!1){this.optimizer.flush();const e=this.length;this._totalLength+=e,this._streamSink.enqueue({fnArray:this.fnArray,argsArray:this.argsArray,lastChunk:t,length:e},1,this._transfers),this.dependencies.clear(),this.fnArray.length=0,this.argsArray.length=0,this.weight=0,this.optimizer.reset()}}exports.OperatorList=OperatorList;