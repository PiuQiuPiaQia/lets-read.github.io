"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.JpegImage=void 0;var _util=require("../shared/util.js"),_core_utils=require("./core_utils.js");class JpegError extends _util.BaseException{constructor(e){super(`JPEG error: ${e}`,"JpegError")}}class DNLMarkerError extends _util.BaseException{constructor(e,t){super(e,"DNLMarkerError"),this.scanLines=t}}class EOIMarkerError extends _util.BaseException{constructor(e){super(e,"EOIMarkerError")}}const dctZigZag=new Uint8Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),dctCos1=4017,dctSin1=799,dctCos3=3406,dctSin3=2276,dctCos6=1567,dctSin6=3784,dctSqrt2=5793,dctSqrt1d2=2896;function buildHuffmanTable(e,t){let n,r,o=0,i=16;while(i>0&&!e[i-1])i--;const s=[{children:[],index:0}];let c,a=s[0];for(n=0;n<i;n++){for(r=0;r<e[n];r++){a=s.pop(),a.children[a.index]=t[o];while(a.index>0)a=s.pop();a.index++,s.push(a);while(s.length<=n)s.push(c={children:[],index:0}),a.children[a.index]=c.children,a=c;o++}n+1<i&&(s.push(c={children:[],index:0}),a.children[a.index]=c.children,a=c)}return s[0].children}function getBlockBufferOffset(e,t,n){return 64*((e.blocksPerLine+1)*t+n)}function decodeScan(e,t,n,r,o,i,s,c,a,l=!1){const d=n.mcusPerLine,u=n.progressive,f=t;let h=0,m=0;function p(){if(m>0)return m--,h>>m&1;if(h=e[t++],255===h){const r=e[t++];if(r){if(220===r&&l){t+=2;const r=(0,_core_utils.readUint16)(e,t);if(t+=2,r>0&&r!==n.scanLines)throw new DNLMarkerError("Found DNL marker (0xFFDC) while parsing scan data",r)}else if(217===r){if(l){const e=E*(8===n.precision?8:0);if(e>0&&Math.round(n.scanLines/e)>=10)throw new DNLMarkerError("Found EOI marker (0xFFD9) while parsing scan data, possibly caused by incorrect `scanLines` parameter",e)}throw new EOIMarkerError("Found EOI marker (0xFFD9) while parsing scan data")}throw new JpegError(`unexpected marker ${(h<<8|r).toString(16)}`)}}return m=7,h>>>7}function g(e){let t=e;while(1){switch(t=t[p()],typeof t){case"number":return t;case"object":continue}throw new JpegError("invalid huffman sequence")}}function k(e){let t=0;while(e>0)t=t<<1|p(),e--;return t}function b(e){if(1===e)return 1===p()?1:-1;const t=k(e);return t>=1<<e-1?t:t+(-1<<e)+1}function w(e,t){const n=g(e.huffmanTableDC),r=0===n?0:b(n);e.blockData[t]=e.pred+=r;let o=1;while(o<64){const n=g(e.huffmanTableAC),r=15&n,i=n>>4;if(0===r){if(i<15)break;o+=16;continue}o+=i;const s=dctZigZag[o];e.blockData[t+s]=b(r),o++}}function _(e,t){const n=g(e.huffmanTableDC),r=0===n?0:b(n)<<a;e.blockData[t]=e.pred+=r}function C(e,t){e.blockData[t]|=p()<<a}let x=0;function D(e,t){if(x>0)return void x--;let n=i;const r=s;while(n<=r){const r=g(e.huffmanTableAC),o=15&r,i=r>>4;if(0===o){if(i<15){x=k(i)+(1<<i)-1;break}n+=16;continue}n+=i;const s=dctZigZag[n];e.blockData[t+s]=b(o)*(1<<a),n++}}let v,S=0;function L(e,t){let n=i;const r=s;let o,c,l=0;while(n<=r){const r=t+dctZigZag[n],i=e.blockData[r]<0?-1:1;switch(S){case 0:if(c=g(e.huffmanTableAC),o=15&c,l=c>>4,0===o)l<15?(x=k(l)+(1<<l),S=4):(l=16,S=1);else{if(1!==o)throw new JpegError("invalid ACn encoding");v=b(o),S=l?2:3}continue;case 1:case 2:e.blockData[r]?e.blockData[r]+=i*(p()<<a):(l--,0===l&&(S=2===S?3:0));break;case 3:e.blockData[r]?e.blockData[r]+=i*(p()<<a):(e.blockData[r]=v<<a,S=0);break;case 4:e.blockData[r]&&(e.blockData[r]+=i*(p()<<a));break}n++}4===S&&(x--,0===x&&(S=0))}let E=0;function T(e,t,n,r,o){const i=n/d|0,s=n%d;E=i*e.v+r;const c=s*e.h+o,a=getBlockBufferOffset(e,E,c);t(e,a)}function y(e,t,n){E=n/e.blocksPerLine|0;const r=n%e.blocksPerLine,o=getBlockBufferOffset(e,E,r);t(e,o)}const P=r.length;let I,U,q,M,J,A;A=u?0===i?0===c?_:C:0===c?D:L:w;let F,B,O,N,Z=0;B=1===P?r[0].blocksPerLine*r[0].blocksPerColumn:d*n.mcusPerColumn;while(Z<=B){const n=o?Math.min(B-Z,o):B;if(n>0){for(U=0;U<P;U++)r[U].pred=0;if(x=0,1===P)for(I=r[0],J=0;J<n;J++)y(I,A,Z),Z++;else for(J=0;J<n;J++){for(U=0;U<P;U++)for(I=r[U],O=I.h,N=I.v,q=0;q<N;q++)for(M=0;M<O;M++)T(I,A,Z,q,M);Z++}}if(m=0,F=findNextFileMarker(e,t),!F)break;if(F.invalid){const e=n>0?"unexpected":"excessive";(0,_util.warn)(`decodeScan - ${e} MCU data, current marker is: ${F.invalid}`),t=F.offset}if(!(F.marker>=65488&&F.marker<=65495))break;t+=2}return t-f}function quantizeAndInverse(e,t,n){const r=e.quantizationTable,o=e.blockData;let i,s,c,a,l,d,u,f,h,m,p,g,k,b,w,_,C;if(!r)throw new JpegError("missing required Quantization Table.");for(let x=0;x<64;x+=8)h=o[t+x],m=o[t+x+1],p=o[t+x+2],g=o[t+x+3],k=o[t+x+4],b=o[t+x+5],w=o[t+x+6],_=o[t+x+7],h*=r[x],0!==(m|p|g|k|b|w|_)?(m*=r[x+1],p*=r[x+2],g*=r[x+3],k*=r[x+4],b*=r[x+5],w*=r[x+6],_*=r[x+7],i=dctSqrt2*h+128>>8,s=dctSqrt2*k+128>>8,c=p,a=w,l=dctSqrt1d2*(m-_)+128>>8,f=dctSqrt1d2*(m+_)+128>>8,d=g<<4,u=b<<4,i=i+s+1>>1,s=i-s,C=c*dctSin6+a*dctCos6+128>>8,c=c*dctCos6-a*dctSin6+128>>8,a=C,l=l+u+1>>1,u=l-u,f=f+d+1>>1,d=f-d,i=i+a+1>>1,a=i-a,s=s+c+1>>1,c=s-c,C=l*dctSin3+f*dctCos3+2048>>12,l=l*dctCos3-f*dctSin3+2048>>12,f=C,C=d*dctSin1+u*dctCos1+2048>>12,d=d*dctCos1-u*dctSin1+2048>>12,u=C,n[x]=i+f,n[x+7]=i-f,n[x+1]=s+u,n[x+6]=s-u,n[x+2]=c+d,n[x+5]=c-d,n[x+3]=a+l,n[x+4]=a-l):(C=dctSqrt2*h+512>>10,n[x]=C,n[x+1]=C,n[x+2]=C,n[x+3]=C,n[x+4]=C,n[x+5]=C,n[x+6]=C,n[x+7]=C);for(let x=0;x<8;++x)h=n[x],m=n[x+8],p=n[x+16],g=n[x+24],k=n[x+32],b=n[x+40],w=n[x+48],_=n[x+56],0!==(m|p|g|k|b|w|_)?(i=dctSqrt2*h+2048>>12,s=dctSqrt2*k+2048>>12,c=p,a=w,l=dctSqrt1d2*(m-_)+2048>>12,f=dctSqrt1d2*(m+_)+2048>>12,d=g,u=b,i=4112+(i+s+1>>1),s=i-s,C=c*dctSin6+a*dctCos6+2048>>12,c=c*dctCos6-a*dctSin6+2048>>12,a=C,l=l+u+1>>1,u=l-u,f=f+d+1>>1,d=f-d,i=i+a+1>>1,a=i-a,s=s+c+1>>1,c=s-c,C=l*dctSin3+f*dctCos3+2048>>12,l=l*dctCos3-f*dctSin3+2048>>12,f=C,C=d*dctSin1+u*dctCos1+2048>>12,d=d*dctCos1-u*dctSin1+2048>>12,u=C,h=i+f,_=i-f,m=s+u,w=s-u,p=c+d,b=c-d,g=a+l,k=a-l,h<16?h=0:h>=4080?h=255:h>>=4,m<16?m=0:m>=4080?m=255:m>>=4,p<16?p=0:p>=4080?p=255:p>>=4,g<16?g=0:g>=4080?g=255:g>>=4,k<16?k=0:k>=4080?k=255:k>>=4,b<16?b=0:b>=4080?b=255:b>>=4,w<16?w=0:w>=4080?w=255:w>>=4,_<16?_=0:_>=4080?_=255:_>>=4,o[t+x]=h,o[t+x+8]=m,o[t+x+16]=p,o[t+x+24]=g,o[t+x+32]=k,o[t+x+40]=b,o[t+x+48]=w,o[t+x+56]=_):(C=dctSqrt2*h+8192>>14,C=C<-2040?0:C>=2024?255:C+2056>>4,o[t+x]=C,o[t+x+8]=C,o[t+x+16]=C,o[t+x+24]=C,o[t+x+32]=C,o[t+x+40]=C,o[t+x+48]=C,o[t+x+56]=C)}function buildComponentData(e,t){const n=t.blocksPerLine,r=t.blocksPerColumn,o=new Int16Array(64);for(let i=0;i<r;i++)for(let e=0;e<n;e++){const n=getBlockBufferOffset(t,i,e);quantizeAndInverse(t,n,o)}return t.blockData}function findNextFileMarker(e,t,n=t){const r=e.length-1;let o=n<t?n:t;if(t>=r)return null;const i=(0,_core_utils.readUint16)(e,t);if(i>=65472&&i<=65534)return{invalid:null,marker:i,offset:t};let s=(0,_core_utils.readUint16)(e,o);while(!(s>=65472&&s<=65534)){if(++o>=r)return null;s=(0,_core_utils.readUint16)(e,o)}return{invalid:i.toString(16),marker:s,offset:o}}class JpegImage{constructor({decodeTransform:e=null,colorTransform:t=-1}={}){this._decodeTransform=e,this._colorTransform=t}parse(e,{dnlScanLines:t=null}={}){function n(){const t=(0,_core_utils.readUint16)(e,s);s+=2;let n=s+t-2;const r=findNextFileMarker(e,n,s);r&&r.invalid&&((0,_util.warn)("readDataBlock - incorrect length, current marker is: "+r.invalid),n=r.offset);const o=e.subarray(s,n);return s+=o.length,o}function r(e){const t=Math.ceil(e.samplesPerLine/8/e.maxH),n=Math.ceil(e.scanLines/8/e.maxV);for(let r=0,o=e.components.length;r<o;r++){const o=e.components[r],i=Math.ceil(Math.ceil(e.samplesPerLine/8)*o.h/e.maxH),s=Math.ceil(Math.ceil(e.scanLines/8)*o.v/e.maxV),c=t*o.h,a=n*o.v,l=64*a*(c+1);o.blockData=new Int16Array(l),o.blocksPerLine=i,o.blocksPerColumn=s}e.mcusPerLine=t,e.mcusPerColumn=n}let o,i,s=0,c=null,a=null,l=0;const d=[],u=[],f=[];let h=(0,_core_utils.readUint16)(e,s);if(s+=2,65496!==h)throw new JpegError("SOI not found");h=(0,_core_utils.readUint16)(e,s),s+=2;e:while(65497!==h){let p,g,k;switch(h){case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:const b=n();65504===h&&74===b[0]&&70===b[1]&&73===b[2]&&70===b[3]&&0===b[4]&&(c={version:{major:b[5],minor:b[6]},densityUnits:b[7],xDensity:b[8]<<8|b[9],yDensity:b[10]<<8|b[11],thumbWidth:b[12],thumbHeight:b[13],thumbData:b.subarray(14,14+3*b[12]*b[13])}),65518===h&&65===b[0]&&100===b[1]&&111===b[2]&&98===b[3]&&101===b[4]&&(a={version:b[5]<<8|b[6],flags0:b[7]<<8|b[8],flags1:b[9]<<8|b[10],transformCode:b[11]});break;case 65499:const w=(0,_core_utils.readUint16)(e,s);s+=2;const _=w+s-2;let C;while(s<_){const t=e[s++],n=new Uint16Array(64);if(t>>4===0)for(g=0;g<64;g++)C=dctZigZag[g],n[C]=e[s++];else{if(t>>4!==1)throw new JpegError("DQT - invalid table spec");for(g=0;g<64;g++)C=dctZigZag[g],n[C]=(0,_core_utils.readUint16)(e,s),s+=2}d[15&t]=n}break;case 65472:case 65473:case 65474:if(o)throw new JpegError("Only single frame JPEGs supported");s+=2,o={},o.extended=65473===h,o.progressive=65474===h,o.precision=e[s++];const x=(0,_core_utils.readUint16)(e,s);s+=2,o.scanLines=t||x,o.samplesPerLine=(0,_core_utils.readUint16)(e,s),s+=2,o.components=[],o.componentIds={};const D=e[s++];let v=0,S=0;for(p=0;p<D;p++){const t=e[s],n=e[s+1]>>4,r=15&e[s+1];v<n&&(v=n),S<r&&(S=r);const i=e[s+2];k=o.components.push({h:n,v:r,quantizationId:i,quantizationTable:null}),o.componentIds[t]=k-1,s+=3}o.maxH=v,o.maxV=S,r(o);break;case 65476:const L=(0,_core_utils.readUint16)(e,s);for(s+=2,p=2;p<L;){const t=e[s++],n=new Uint8Array(16);let r=0;for(g=0;g<16;g++,s++)r+=n[g]=e[s];const o=new Uint8Array(r);for(g=0;g<r;g++,s++)o[g]=e[s];p+=17+r,(t>>4===0?f:u)[15&t]=buildHuffmanTable(n,o)}break;case 65501:s+=2,i=(0,_core_utils.readUint16)(e,s),s+=2;break;case 65498:const E=1===++l&&!t;s+=2;const T=e[s++],y=[];for(p=0;p<T;p++){const t=e[s++],n=o.componentIds[t],r=o.components[n];r.index=t;const i=e[s++];r.huffmanTableDC=f[i>>4],r.huffmanTableAC=u[15&i],y.push(r)}const P=e[s++],I=e[s++],U=e[s++];try{const t=decodeScan(e,s,o,y,i,P,I,U>>4,15&U,E);s+=t}catch(m){if(m instanceof DNLMarkerError)return(0,_util.warn)(`${m.message} -- attempting to re-parse the JPEG image.`),this.parse(e,{dnlScanLines:m.scanLines});if(m instanceof EOIMarkerError){(0,_util.warn)(`${m.message} -- ignoring the rest of the image data.`);break e}throw m}break;case 65500:s+=4;break;case 65535:255!==e[s]&&s--;break;default:const q=findNextFileMarker(e,s-2,s-3);if(q&&q.invalid){(0,_util.warn)("JpegImage.parse - unexpected data, current marker is: "+q.invalid),s=q.offset;break}if(!q||s>=e.length-1){(0,_util.warn)("JpegImage.parse - reached the end of the image data without finding an EOI marker (0xFFD9).");break e}throw new JpegError("JpegImage.parse - unknown marker: "+h.toString(16))}h=(0,_core_utils.readUint16)(e,s),s+=2}this.width=o.samplesPerLine,this.height=o.scanLines,this.jfif=c,this.adobe=a,this.components=[];for(let p=0,g=o.components.length;p<g;p++){const e=o.components[p],t=d[e.quantizationId];t&&(e.quantizationTable=t),this.components.push({index:e.index,output:buildComponentData(o,e),scaleX:e.h/o.maxH,scaleY:e.v/o.maxV,blocksPerLine:e.blocksPerLine,blocksPerColumn:e.blocksPerColumn})}this.numComponents=this.components.length}_getLinearizedBlockData(e,t,n=!1){const r=this.width/e,o=this.height/t;let i,s,c,a,l,d,u,f,h,m,p,g=0;const k=this.components.length,b=e*t*k,w=new Uint8ClampedArray(b),_=new Uint32Array(e),C=4294967288;let x;for(u=0;u<k;u++){if(i=this.components[u],s=i.scaleX*r,c=i.scaleY*o,g=u,p=i.output,a=i.blocksPerLine+1<<3,s!==x){for(l=0;l<e;l++)f=0|l*s,_[l]=(f&C)<<3|7&f;x=s}for(d=0;d<t;d++)for(f=0|d*c,m=a*(f&C)|(7&f)<<3,l=0;l<e;l++)w[g]=p[m+_[l]],g+=k}let D=this._decodeTransform;if(n||4!==k||D||(D=new Int32Array([-256,255,-256,255,-256,255,-256,255])),D)for(u=0;u<b;)for(f=0,h=0;f<k;f++,u++,h+=2)w[u]=(w[u]*D[h]>>8)+D[h+1];return w}get _isColorConversionNeeded(){return this.adobe?!!this.adobe.transformCode:3===this.numComponents?0!==this._colorTransform&&(82!==this.components[0].index||71!==this.components[1].index||66!==this.components[2].index):1===this._colorTransform}_convertYccToRgb(e){let t,n,r;for(let o=0,i=e.length;o<i;o+=3)t=e[o],n=e[o+1],r=e[o+2],e[o]=t-179.456+1.402*r,e[o+1]=t+135.459-.344*n-.714*r,e[o+2]=t-226.816+1.772*n;return e}_convertYcckToRgb(e){let t,n,r,o,i=0;for(let s=0,c=e.length;s<c;s+=4)t=e[s],n=e[s+1],r=e[s+2],o=e[s+3],e[i++]=n*(-660635669420364e-19*n+.000437130475926232*r-54080610064599e-18*t+.00048449797120281*o-.154362151871126)-122.67195406894+r*(-.000957964378445773*r+.000817076911346625*t-.00477271405408747*o+1.53380253221734)+t*(.000961250184130688*t-.00266257332283933*o+.48357088451265)+o*(-.000336197177618394*o+.484791561490776),e[i++]=107.268039397724+n*(219927104525741e-19*n-.000640992018297945*r+.000659397001245577*t+.000426105652938837*o-.176491792462875)+r*(-.000778269941513683*r+.00130872261408275*t+.000770482631801132*o-.151051492775562)+t*(.00126935368114843*t-.00265090189010898*o+.25802910206845)+o*(-.000318913117588328*o-.213742400323665),e[i++]=n*(-.000570115196973677*n-263409051004589e-19*r+.0020741088115012*t-.00288260236853442*o+.814272968359295)-20.810012546947+r*(-153496057440975e-19*r-.000132689043961446*t+.000560833691242812*o-.195152027534049)+t*(.00174418132927582*t-.00255243321439347*o+.116935020465145)+o*(-.000343531996510555*o+.24165260232407);return e.subarray(0,i)}_convertYcckToCmyk(e){let t,n,r;for(let o=0,i=e.length;o<i;o+=4)t=e[o],n=e[o+1],r=e[o+2],e[o]=434.456-t-1.402*r,e[o+1]=119.541-t+.344*n+.714*r,e[o+2]=481.816-t-1.772*n;return e}_convertCmykToRgb(e){let t,n,r,o,i=0;for(let s=0,c=e.length;s<c;s+=4)t=e[s],n=e[s+1],r=e[s+2],o=e[s+3],e[i++]=255+t*(-6747147073602441e-20*t+.0008379262121013727*n+.0002894718188643294*r+.003264231057537806*o-1.1185611867203937)+n*(26374107616089405e-21*n-8626949158638572e-20*r-.0002748769067499491*o-.02155688794978967)+r*(-3878099212869363e-20*r-.0003267808279485286*o+.0686742238595345)-o*(.0003361971776183937*o+.7430659151342254),e[i++]=255+t*(.00013596372813588848*t+.000924537132573585*n+.00010567359618683593*r+.0004791864687436512*o-.3109689587515875)+n*(-.00023545346108370344*n+.0002702845253534714*r+.0020200308977307156*o-.7488052167015494)+r*(6834815998235662e-20*r+.00015168452363460973*o-.09751927774728933)-o*(.0003189131175883281*o+.7364883807733168),e[i++]=255+t*(13598650411385307e-21*t+.00012423956175490851*n+.0004751985097583589*r-36729317476630422e-22*o-.05562186980264034)+n*(.00016141380598724676*n+.0009692239130725186*r+.0007782692450036253*o-.44015232367526463)+r*(5.068882914068769e-7*r+.0017778369011375071*o-.7591454649749609)-o*(.0003435319965105553*o+.7063770186160144);return e.subarray(0,i)}getData({width:e,height:t,forceRGB:n=!1,isSourcePDF:r=!1}){if(this.numComponents>4)throw new JpegError("Unsupported color mode");const o=this._getLinearizedBlockData(e,t,r);if(1===this.numComponents&&n){const e=o.length,t=new Uint8ClampedArray(3*e);let n=0;for(let r=0;r<e;r++){const e=o[r];t[n++]=e,t[n++]=e,t[n++]=e}return t}if(3===this.numComponents&&this._isColorConversionNeeded)return this._convertYccToRgb(o);if(4===this.numComponents){if(this._isColorConversionNeeded)return n?this._convertYcckToRgb(o):this._convertYcckToCmyk(o);if(n)return this._convertCmykToRgb(o)}return o}}exports.JpegImage=JpegImage;