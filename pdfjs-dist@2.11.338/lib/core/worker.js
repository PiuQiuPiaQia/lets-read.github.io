"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.WorkerTask=exports.WorkerMessageHandler=void 0;var _util=require("../shared/util.js"),_primitives=require("./primitives.js"),_pdf_manager=require("./pdf_manager.js"),_writer=require("./writer.js"),_is_node=require("../shared/is_node.js"),_message_handler=require("../shared/message_handler.js"),_worker_stream=require("./worker_stream.js"),_core_utils=require("./core_utils.js");class WorkerTask{constructor(e){this.name=e,this.terminated=!1,this._capability=(0,_util.createPromiseCapability)()}get finished(){return this._capability.promise}finish(){this._capability.resolve()}terminate(){this.terminated=!0}ensureNotTerminated(){if(this.terminated)throw new Error("Worker task was terminated")}}exports.WorkerTask=WorkerTask;class WorkerMessageHandler{static setup(e,t){let n=!1;e.on("test",(function(t){if(n)return;if(n=!0,!(t instanceof Uint8Array))return void e.send("test",null);const r=255===t[0];e.postMessageTransfers=r,e.send("test",{supportTransfers:r})})),e.on("configure",(function(e){(0,_util.setVerbosityLevel)(e.verbosity)})),e.on("GetDocRequest",(function(e){return WorkerMessageHandler.createDocumentHandler(e,t)}))}static createDocumentHandler(e,t){let n,r=!1,o=null;const a=[],s=(0,_util.getVerbosityLevel)(),i=e.apiVersion,u="2.11.338";if(i!==u)throw new Error(`The API version "${i}" does not match the Worker version "${u}".`);const c=[];for(const k in[])c.push(k);if(c.length)throw new Error("The `Array.prototype` contains unexpected enumerable properties: "+c.join(", ")+"; thus breaking e.g. `for...in` iteration of `Array`s.");if("undefined"===typeof ReadableStream)throw new Error("The browser/environment lacks native support for critical functionality used by the PDF.js library (e.g. `ReadableStream`); please use a `legacy`-build instead.");const l=e.docId,f=e.docBaseUrl,d=e.docId+"_worker";let g=new _message_handler.MessageHandler(d,l,t);function p(){if(r)throw new Error("Worker was terminated")}function m(e){a.push(e)}function h(e){e.finish();const t=a.indexOf(e);a.splice(t,1)}async function w(e){await n.ensureDoc("checkHeader"),await n.ensureDoc("parseStartXRef"),await n.ensureDoc("parse",[e]),e||await n.ensureDoc("checkFirstPage");const t=await n.ensureDoc("isPureXfa");if(t){const e=new WorkerTask("loadXfaFonts");m(e),await Promise.all([n.loadXfaFonts(g,e).catch((e=>{})).then((()=>h(e))),n.loadXfaImages()])}const[r,o]=await Promise.all([n.ensureDoc("numPages"),n.ensureDoc("fingerprints")]),a=t?await n.ensureDoc("htmlForXfa"):null;return{numPages:r,fingerprints:o,htmlForXfa:a}}function _(e,t,n){const r=(0,_util.createPromiseCapability)();let a;const s=e.source;if(s.data){try{a=new _pdf_manager.LocalPdfManager(l,s.data,s.password,t,n,f),r.resolve(a)}catch(w){r.reject(w)}return r.promise}let i,u=[];try{i=new _worker_stream.PDFWorkerStream(g)}catch(w){return r.reject(w),r.promise}const c=i.getFullReader();c.headersReady.then((function(){if(!c.isRangeSupported)return;const e=s.disableAutoFetch||c.isStreamingSupported;a=new _pdf_manager.NetworkPdfManager(l,i,{msgHandler:g,password:s.password,length:c.contentLength,disableAutoFetch:e,rangeChunkSize:s.rangeChunkSize},t,n,f);for(let t=0;t<u.length;t++)a.sendProgressiveData(u[t]);u=[],r.resolve(a),o=null})).catch((function(e){r.reject(e),o=null}));let d=0;const m=function(){const e=(0,_util.arraysToBytes)(u);s.length&&e.length!==s.length&&(0,_util.warn)("reported HTTP length is different from actual");try{a=new _pdf_manager.LocalPdfManager(l,e,s.password,t,n,f),r.resolve(a)}catch(w){r.reject(w)}u=[]},h=new Promise((function(e,t){const n=function({value:e,done:r}){try{if(p(),r)return a||m(),void(o=null);d+=(0,_util.arrayByteLength)(e),c.isStreamingSupported||g.send("DocProgress",{loaded:d,total:Math.max(d,c.contentLength||0)}),a?a.sendProgressiveData(e):u.push(e),c.read().then(n,t)}catch(s){t(s)}};c.read().then(n,t)}));return h.catch((function(e){r.reject(e),o=null})),o=function(e){i.cancelAllRequests(e)},r.promise}function P(e){function t(e){p(),g.send("GetDoc",{pdfInfo:e})}function o(e){if(p(),e instanceof _util.PasswordException){const t=new WorkerTask(`PasswordException: response ${e.code}`);m(t),g.sendWithPromise("PasswordRequest",e).then((function({password:e}){h(t),n.updatePassword(e),a()})).catch((function(){h(t),g.send("DocException",e)}))}else e instanceof _util.InvalidPDFException||e instanceof _util.MissingPDFException||e instanceof _util.UnexpectedResponseException||e instanceof _util.UnknownErrorException?g.send("DocException",e):g.send("DocException",new _util.UnknownErrorException(e.message,e.toString()))}function a(){p(),w(!1).then(t,(function(e){p(),e instanceof _core_utils.XRefParseException?(n.requestLoadedStream(),n.onLoadedStream().then((function(){p(),w(!0).then(t,o)}))):o(e)}))}p();const s={maxImageSize:e.maxImageSize,disableFontFace:e.disableFontFace,ignoreErrors:e.ignoreErrors,isEvalSupported:e.isEvalSupported,fontExtraProperties:e.fontExtraProperties,useSystemFonts:e.useSystemFonts,cMapUrl:e.cMapUrl,standardFontDataUrl:e.standardFontDataUrl};_(e,s,e.enableXfa).then((function(e){if(r)throw e.terminate(new _util.AbortException("Worker was terminated.")),new Error("Worker was terminated");n=e,n.onLoadedStream().then((function(e){g.send("DataLoaded",{length:e.bytes.byteLength})}))})).then(a,o)}return g.postMessageTransfers=e.postMessageTransfers,g.on("GetPage",(function(e){return n.getPage(e.pageIndex).then((function(e){return Promise.all([n.ensure(e,"rotate"),n.ensure(e,"ref"),n.ensure(e,"userUnit"),n.ensure(e,"view")]).then((function([e,t,n,r]){return{rotate:e,ref:t,userUnit:n,view:r}}))}))})),g.on("GetPageIndex",(function({ref:e}){const t=_primitives.Ref.get(e.num,e.gen);return n.ensureCatalog("getPageIndex",[t])})),g.on("GetDestinations",(function(e){return n.ensureCatalog("destinations")})),g.on("GetDestination",(function(e){return n.ensureCatalog("getDestination",[e.id])})),g.on("GetPageLabels",(function(e){return n.ensureCatalog("pageLabels")})),g.on("GetPageLayout",(function(e){return n.ensureCatalog("pageLayout")})),g.on("GetPageMode",(function(e){return n.ensureCatalog("pageMode")})),g.on("GetViewerPreferences",(function(e){return n.ensureCatalog("viewerPreferences")})),g.on("GetOpenAction",(function(e){return n.ensureCatalog("openAction")})),g.on("GetAttachments",(function(e){return n.ensureCatalog("attachments")})),g.on("GetJavaScript",(function(e){return n.ensureCatalog("javaScript")})),g.on("GetDocJSActions",(function(e){return n.ensureCatalog("jsActions")})),g.on("GetPageJSActions",(function({pageIndex:e}){return n.getPage(e).then((function(e){return n.ensure(e,"jsActions")}))})),g.on("GetOutline",(function(e){return n.ensureCatalog("documentOutline")})),g.on("GetOptionalContentConfig",(function(e){return n.ensureCatalog("optionalContentConfig")})),g.on("GetPermissions",(function(e){return n.ensureCatalog("permissions")})),g.on("GetMetadata",(function(e){return Promise.all([n.ensureDoc("documentInfo"),n.ensureCatalog("metadata")])})),g.on("GetMarkInfo",(function(e){return n.ensureCatalog("markInfo")})),g.on("GetData",(function(e){return n.requestLoadedStream(),n.onLoadedStream().then((function(e){return e.bytes}))})),g.on("GetStats",(function(e){return n.ensureXRef("stats")})),g.on("GetAnnotations",(function({pageIndex:e,intent:t}){return n.getPage(e).then((function(e){return e.getAnnotationsData(t)}))})),g.on("GetFieldObjects",(function(e){return n.ensureDoc("fieldObjects")})),g.on("HasJSActions",(function(e){return n.ensureDoc("hasJSActions")})),g.on("GetCalculationOrderIds",(function(e){return n.ensureDoc("calculationOrderIds")})),g.on("SaveDocument",(function({isPureXfa:e,numPages:t,annotationStorage:r,filename:o}){n.requestLoadedStream();const a=[n.onLoadedStream(),n.ensureCatalog("acroForm"),n.ensureCatalog("acroFormRef"),n.ensureDoc("xref"),n.ensureDoc("startXRef")];if(e)a.push(n.serializeXfaData(r));else for(let s=0;s<t;s++)a.push(n.getPage(s).then((function(e){const t=new WorkerTask(`Save: page ${s}`);return e.save(g,t,r).finally((function(){h(t)}))})));return Promise.all(a).then((function([t,n,r,a,s,...i]){let u=[],c=null;if(e){if(c=i[0],!c)return t.bytes}else{for(const e of i)u=e.filter((e=>null!==e)).reduce(((e,t)=>e.concat(t)),u);if(0===u.length)return t.bytes}const l=n instanceof _primitives.Dict&&n.get("XFA")||null;let f=null,d=!1;if(Array.isArray(l)){for(let e=0,t=l.length;e<t;e+=2)"datasets"===l[e]&&(f=l[e+1],r=null,d=!0);null===f&&(f=a.getNewRef())}else l&&(r=null,(0,_util.warn)("Unsupported XFA type."));let g=Object.create(null);if(a.trailer){const e=Object.create(null),t=a.trailer.get("Info")||null;t instanceof _primitives.Dict&&t.forEach(((t,n)=>{(0,_util.isString)(t)&&(0,_util.isString)(n)&&(e[t]=(0,_util.stringToPDFString)(n))})),g={rootRef:a.trailer.getRaw("Root")||null,encryptRef:a.trailer.getRaw("Encrypt")||null,newRef:a.getNewRef(),infoRef:a.trailer.getRaw("Info")||null,info:e,fileIds:a.trailer.get("ID")||null,startXRef:s,filename:o}}return a.resetNewRef(),(0,_writer.incrementalUpdate)({originalData:t.bytes,xrefInfo:g,newRefs:u,xref:a,hasXfa:!!l,xfaDatasetsRef:f,hasXfaDatasetsEntry:d,acroFormRef:r,acroForm:n,xfaData:c})}))})),g.on("GetOperatorList",(function(e,t){const r=e.pageIndex;n.getPage(r).then((function(n){const o=new WorkerTask(`GetOperatorList: page ${r}`);m(o);const a=s>=_util.VerbosityLevel.INFOS?Date.now():0;n.getOperatorList({handler:g,sink:t,task:o,intent:e.intent,cacheKey:e.cacheKey,annotationStorage:e.annotationStorage}).then((function(e){h(o),a&&(0,_util.info)(`page=${r+1} - getOperatorList: time=${Date.now()-a}ms, len=${e.length}`),t.close()}),(function(e){h(o),o.terminated||(g.send("UnsupportedFeature",{featureId:_util.UNSUPPORTED_FEATURES.errorOperatorList}),t.error(e))}))}))})),g.on("GetTextContent",(function(e,t){const r=e.pageIndex;n.getPage(r).then((function(n){const o=new WorkerTask("GetTextContent: page "+r);m(o);const a=s>=_util.VerbosityLevel.INFOS?Date.now():0;n.extractTextContent({handler:g,task:o,sink:t,normalizeWhitespace:e.normalizeWhitespace,includeMarkedContent:e.includeMarkedContent,combineTextItems:e.combineTextItems}).then((function(){h(o),a&&(0,_util.info)(`page=${r+1} - getTextContent: time=`+(Date.now()-a)+"ms"),t.close()}),(function(e){h(o),o.terminated||t.error(e)}))}))})),g.on("GetStructTree",(function(e){return n.getPage(e.pageIndex).then((function(e){return n.ensure(e,"getStructTree")}))})),g.on("FontFallback",(function(e){return n.fontFallback(e.id,g)})),g.on("Cleanup",(function(e){return n.cleanup(!0)})),g.on("Terminate",(function(e){r=!0;const t=[];if(n){n.terminate(new _util.AbortException("Worker was terminated."));const e=n.cleanup();t.push(e),n=null}else(0,_primitives.clearPrimitiveCaches)();o&&o(new _util.AbortException("Worker was terminated."));for(const n of a)t.push(n.finished),n.terminate();return Promise.all(t).then((function(){g.destroy(),g=null}))})),g.on("Ready",(function(t){P(e),e=null})),d}static initializeFromPort(e){const t=new _message_handler.MessageHandler("worker","main",e);WorkerMessageHandler.setup(t,e),t.send("ready",null)}}function isMessagePort(e){return"function"===typeof e.postMessage&&"onmessage"in e}exports.WorkerMessageHandler=WorkerMessageHandler,"undefined"===typeof window&&!_is_node.isNodeJS&&"undefined"!==typeof self&&isMessagePort(self)&&WorkerMessageHandler.initializeFromPort(self);