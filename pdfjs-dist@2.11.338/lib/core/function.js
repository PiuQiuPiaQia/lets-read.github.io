"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.isPDFFunction=isPDFFunction,exports.PostScriptEvaluator=exports.PostScriptCompiler=exports.PDFFunctionFactory=void 0;var _primitives=require("./primitives.js"),_util=require("../shared/util.js"),_ps_parser=require("./ps_parser.js"),_image_utils=require("./image_utils.js");class PDFFunctionFactory{constructor({xref:t,isEvalSupported:e=!0}){this.xref=t,this.isEvalSupported=!1!==e}create(t){const e=this.getCached(t);if(e)return e;const r=PDFFunction.parse({xref:this.xref,isEvalSupported:this.isEvalSupported,fn:t instanceof _primitives.Ref?this.xref.fetch(t):t});return this._cache(t,r),r}createFromArray(t){const e=this.getCached(t);if(e)return e;const r=PDFFunction.parseArray({xref:this.xref,isEvalSupported:this.isEvalSupported,fnObj:t instanceof _primitives.Ref?this.xref.fetch(t):t});return this._cache(t,r),r}getCached(t){let e;if(t instanceof _primitives.Ref?e=t:t instanceof _primitives.Dict?e=t.objId:(0,_primitives.isStream)(t)&&(e=t.dict&&t.dict.objId),e){const t=this._localFunctionCache.getByRef(e);if(t)return t}return null}_cache(t,e){if(!e)throw new Error('PDFFunctionFactory._cache - expected "parsedFunction" argument.');let r;t instanceof _primitives.Ref?r=t:t instanceof _primitives.Dict?r=t.objId:(0,_primitives.isStream)(t)&&(r=t.dict&&t.dict.objId),r&&this._localFunctionCache.set(null,r,e)}get _localFunctionCache(){return(0,_util.shadow)(this,"_localFunctionCache",new _image_utils.LocalFunctionCache)}}function toNumberArray(t){if(!Array.isArray(t))return null;const e=t.length;for(let r=0;r<e;r++)if("number"!==typeof t[r]){const r=new Array(e);for(let s=0;s<e;s++)r[s]=+t[s];return r}return t}exports.PDFFunctionFactory=PDFFunctionFactory;class PDFFunction{static getSampleArray(t,e,r,s){let i,n,o=1;for(i=0,n=t.length;i<n;i++)o*=t[i];o*=e;const a=new Array(o);let p=0,c=0;const u=1/(2**r-1),l=s.getBytes((o*r+7)/8);let h=0;for(i=0;i<o;i++){while(p<r)c<<=8,c|=l[h++],p+=8;p-=r,a[i]=(c>>p)*u,c&=(1<<p)-1}return a}static parse({xref:t,isEvalSupported:e,fn:r}){const s=r.dict||r,i=s.get("FunctionType");switch(i){case 0:return this.constructSampled({xref:t,isEvalSupported:e,fn:r,dict:s});case 1:break;case 2:return this.constructInterpolated({xref:t,isEvalSupported:e,dict:s});case 3:return this.constructStiched({xref:t,isEvalSupported:e,dict:s});case 4:return this.constructPostScript({xref:t,isEvalSupported:e,fn:r,dict:s})}throw new _util.FormatError("Unknown type of function")}static parseArray({xref:t,isEvalSupported:e,fnObj:r}){if(!Array.isArray(r))return this.parse({xref:t,isEvalSupported:e,fn:r});const s=[];for(let i=0,n=r.length;i<n;i++)s.push(this.parse({xref:t,isEvalSupported:e,fn:t.fetchIfRef(r[i])}));return function(t,e,r,i){for(let n=0,o=s.length;n<o;n++)s[n](t,e,r,i+n)}}static constructSampled({xref:t,isEvalSupported:e,fn:r,dict:s}){function i(t){const e=t.length,r=[];let s=0;for(let i=0;i<e;i+=2)r[s++]=[t[i],t[i+1]];return r}function n(t,e,r,s,i){return s+(i-s)/(r-e)*(t-e)}let o=toNumberArray(s.getArray("Domain")),a=toNumberArray(s.getArray("Range"));if(!o||!a)throw new _util.FormatError("No domain or range");const p=o.length/2,c=a.length/2;o=i(o),a=i(a);const u=toNumberArray(s.getArray("Size")),l=s.get("BitsPerSample"),h=s.get("Order")||1;1!==h&&(0,_util.info)("No support for cubic spline interpolation: "+h);let f=toNumberArray(s.getArray("Encode"));if(f)f=i(f);else{f=[];for(let t=0;t<p;++t)f.push([0,u[t]-1])}let m=toNumberArray(s.getArray("Decode"));m=m?i(m):a;const b=this.getSampleArray(u,c,l,r);return function(t,e,r,s){const i=1<<p,l=new Float64Array(i),h=new Uint32Array(i);let g,d;for(d=0;d<i;d++)l[d]=1;let y=c,v=1;for(g=0;g<p;++g){const r=o[g][0],s=o[g][1],a=Math.min(Math.max(t[e+g],r),s);let p=n(a,r,s,f[g][0],f[g][1]);const c=u[g];p=Math.min(Math.max(p,0),c-1);const m=p<c-1?Math.floor(p):p-1,b=m+1-p,x=p-m,k=m*y,S=k+y;for(d=0;d<i;d++)d&v?(l[d]*=x,h[d]+=S):(l[d]*=b,h[d]+=k);y*=c,v<<=1}for(d=0;d<c;++d){let t=0;for(g=0;g<i;g++)t+=b[h[g]+d]*l[g];t=n(t,0,1,m[d][0],m[d][1]),r[s+d]=Math.min(Math.max(t,a[d][0]),a[d][1])}}}static constructInterpolated({xref:t,isEvalSupported:e,dict:r}){const s=toNumberArray(r.getArray("C0"))||[0],i=toNumberArray(r.getArray("C1"))||[1],n=r.get("N"),o=[];for(let p=0,c=s.length;p<c;++p)o.push(i[p]-s[p]);const a=o.length;return function(t,e,r,i){const p=1===n?t[e]:t[e]**n;for(let n=0;n<a;++n)r[i+n]=s[n]+p*o[n]}}static constructStiched({xref:t,isEvalSupported:e,dict:r}){const s=toNumberArray(r.getArray("Domain"));if(!s)throw new _util.FormatError("No domain");const i=s.length/2;if(1!==i)throw new _util.FormatError("Bad domain for stiched function");const n=r.get("Functions"),o=[];for(let u=0,l=n.length;u<l;++u)o.push(this.parse({xref:t,isEvalSupported:e,fn:t.fetchIfRef(n[u])}));const a=toNumberArray(r.getArray("Bounds")),p=toNumberArray(r.getArray("Encode")),c=new Float32Array(1);return function(t,e,r,i){const n=function(t,e,r){return t>r?t=r:t<e&&(t=e),t},u=n(t[e],s[0],s[1]),l=a.length;let h;for(h=0;h<l;++h)if(u<a[h])break;let f=s[0];h>0&&(f=a[h-1]);let m=s[1];h<a.length&&(m=a[h]);const b=p[2*h],g=p[2*h+1];c[0]=f===m?b:b+(u-f)*(g-b)/(m-f),o[h](c,0,r,i)}}static constructPostScript({xref:t,isEvalSupported:e,fn:r,dict:s}){const i=toNumberArray(s.getArray("Domain")),n=toNumberArray(s.getArray("Range"));if(!i)throw new _util.FormatError("No domain.");if(!n)throw new _util.FormatError("No range.");const o=new _ps_parser.PostScriptLexer(r),a=new _ps_parser.PostScriptParser(o),p=a.parse();if(e&&_util.IsEvalSupportedCached.value){const t=(new PostScriptCompiler).compile(p,i,n);if(t)return new Function("src","srcOffset","dest","destOffset",t)}(0,_util.info)("Unable to compile PS function");const c=n.length>>1,u=i.length>>1,l=new PostScriptEvaluator(p),h=Object.create(null),f=8192;let m=f;const b=new Float32Array(u);return function(t,e,r,s){let i,o,a="";const p=b;for(i=0;i<u;i++)o=t[e+i],p[i]=o,a+=o+"_";const f=h[a];if(void 0!==f)return void r.set(f,s);const g=new Float32Array(c),d=l.execute(p),y=d.length-c;for(i=0;i<c;i++){o=d[y+i];let t=n[2*i];o<t?o=t:(t=n[2*i+1],o>t&&(o=t)),g[i]=o}m>0&&(m--,h[a]=g),r.set(g,s)}}}function isPDFFunction(t){let e;if("object"!==typeof t)return!1;if((0,_primitives.isDict)(t))e=t;else{if(!(0,_primitives.isStream)(t))return!1;e=t.dict}return e.has("FunctionType")}class PostScriptStack{static get MAX_STACK_SIZE(){return(0,_util.shadow)(this,"MAX_STACK_SIZE",100)}constructor(t){this.stack=t?Array.prototype.slice.call(t,0):[]}push(t){if(this.stack.length>=PostScriptStack.MAX_STACK_SIZE)throw new Error("PostScript function stack overflow.");this.stack.push(t)}pop(){if(this.stack.length<=0)throw new Error("PostScript function stack underflow.");return this.stack.pop()}copy(t){if(this.stack.length+t>=PostScriptStack.MAX_STACK_SIZE)throw new Error("PostScript function stack overflow.");const e=this.stack;for(let r=e.length-t,s=t-1;s>=0;s--,r++)e.push(e[r])}index(t){this.push(this.stack[this.stack.length-t-1])}roll(t,e){const r=this.stack,s=r.length-t,i=r.length-1,n=s+(e-Math.floor(e/t)*t);for(let o=s,a=i;o<a;o++,a--){const t=r[o];r[o]=r[a],r[a]=t}for(let o=s,a=n-1;o<a;o++,a--){const t=r[o];r[o]=r[a],r[a]=t}for(let o=n,a=i;o<a;o++,a--){const t=r[o];r[o]=r[a],r[a]=t}}}class PostScriptEvaluator{constructor(t){this.operators=t}execute(t){const e=new PostScriptStack(t);let r=0;const s=this.operators,i=s.length;let n,o,a;while(r<i)if(n=s[r++],"number"!==typeof n)switch(n){case"jz":a=e.pop(),o=e.pop(),o||(r=a);break;case"j":o=e.pop(),r=o;break;case"abs":o=e.pop(),e.push(Math.abs(o));break;case"add":a=e.pop(),o=e.pop(),e.push(o+a);break;case"and":a=e.pop(),o=e.pop(),(0,_util.isBool)(o)&&(0,_util.isBool)(a)?e.push(o&&a):e.push(o&a);break;case"atan":o=e.pop(),e.push(Math.atan(o));break;case"bitshift":a=e.pop(),o=e.pop(),o>0?e.push(o<<a):e.push(o>>a);break;case"ceiling":o=e.pop(),e.push(Math.ceil(o));break;case"copy":o=e.pop(),e.copy(o);break;case"cos":o=e.pop(),e.push(Math.cos(o));break;case"cvi":o=0|e.pop(),e.push(o);break;case"cvr":break;case"div":a=e.pop(),o=e.pop(),e.push(o/a);break;case"dup":e.copy(1);break;case"eq":a=e.pop(),o=e.pop(),e.push(o===a);break;case"exch":e.roll(2,1);break;case"exp":a=e.pop(),o=e.pop(),e.push(o**a);break;case"false":e.push(!1);break;case"floor":o=e.pop(),e.push(Math.floor(o));break;case"ge":a=e.pop(),o=e.pop(),e.push(o>=a);break;case"gt":a=e.pop(),o=e.pop(),e.push(o>a);break;case"idiv":a=e.pop(),o=e.pop(),e.push(o/a|0);break;case"index":o=e.pop(),e.index(o);break;case"le":a=e.pop(),o=e.pop(),e.push(o<=a);break;case"ln":o=e.pop(),e.push(Math.log(o));break;case"log":o=e.pop(),e.push(Math.log(o)/Math.LN10);break;case"lt":a=e.pop(),o=e.pop(),e.push(o<a);break;case"mod":a=e.pop(),o=e.pop(),e.push(o%a);break;case"mul":a=e.pop(),o=e.pop(),e.push(o*a);break;case"ne":a=e.pop(),o=e.pop(),e.push(o!==a);break;case"neg":o=e.pop(),e.push(-o);break;case"not":o=e.pop(),(0,_util.isBool)(o)?e.push(!o):e.push(~o);break;case"or":a=e.pop(),o=e.pop(),(0,_util.isBool)(o)&&(0,_util.isBool)(a)?e.push(o||a):e.push(o|a);break;case"pop":e.pop();break;case"roll":a=e.pop(),o=e.pop(),e.roll(o,a);break;case"round":o=e.pop(),e.push(Math.round(o));break;case"sin":o=e.pop(),e.push(Math.sin(o));break;case"sqrt":o=e.pop(),e.push(Math.sqrt(o));break;case"sub":a=e.pop(),o=e.pop(),e.push(o-a);break;case"true":e.push(!0);break;case"truncate":o=e.pop(),o=o<0?Math.ceil(o):Math.floor(o),e.push(o);break;case"xor":a=e.pop(),o=e.pop(),(0,_util.isBool)(o)&&(0,_util.isBool)(a)?e.push(o!==a):e.push(o^a);break;default:throw new _util.FormatError(`Unknown operator ${n}`)}else e.push(n);return e.stack}}exports.PostScriptEvaluator=PostScriptEvaluator;const PostScriptCompiler=function(){class t{constructor(t){this.type=t}visit(t){(0,_util.unreachable)("abstract method")}}class e extends t{constructor(t,e,r){super("args"),this.index=t,this.min=e,this.max=r}visit(t){t.visitArgument(this)}}class r extends t{constructor(t){super("literal"),this.number=t,this.min=t,this.max=t}visit(t){t.visitLiteral(this)}}class s extends t{constructor(t,e,r,s,i){super("binary"),this.op=t,this.arg1=e,this.arg2=r,this.min=s,this.max=i}visit(t){t.visitBinaryOperation(this)}}class i extends t{constructor(t,e){super("max"),this.arg=t,this.min=t.min,this.max=e}visit(t){t.visitMin(this)}}class n extends t{constructor(t,e,r){super("var"),this.index=t,this.min=e,this.max=r}visit(t){t.visitVariable(this)}}class o extends t{constructor(t,e){super("definition"),this.variable=t,this.arg=e}visit(t){t.visitVariableDefinition(this)}}class a{constructor(){this.parts=[]}visitArgument(t){this.parts.push("Math.max(",t.min,", Math.min(",t.max,", src[srcOffset + ",t.index,"]))")}visitVariable(t){this.parts.push("v",t.index)}visitLiteral(t){this.parts.push(t.number)}visitBinaryOperation(t){this.parts.push("("),t.arg1.visit(this),this.parts.push(" ",t.op," "),t.arg2.visit(this),this.parts.push(")")}visitVariableDefinition(t){this.parts.push("var "),t.variable.visit(this),this.parts.push(" = "),t.arg.visit(this),this.parts.push(";")}visitMin(t){this.parts.push("Math.min("),t.arg.visit(this),this.parts.push(", ",t.max,")")}toString(){return this.parts.join("")}}function p(t,e){return"literal"===e.type&&0===e.number?t:"literal"===t.type&&0===t.number?e:"literal"===e.type&&"literal"===t.type?new r(t.number+e.number):new s("+",t,e,t.min+e.min,t.max+e.max)}function c(t,e){if("literal"===e.type){if(0===e.number)return new r(0);if(1===e.number)return t;if("literal"===t.type)return new r(t.number*e.number)}if("literal"===t.type){if(0===t.number)return new r(0);if(1===t.number)return e}const i=Math.min(t.min*e.min,t.min*e.max,t.max*e.min,t.max*e.max),n=Math.max(t.min*e.min,t.min*e.max,t.max*e.min,t.max*e.max);return new s("*",t,e,i,n)}function u(t,e){if("literal"===e.type){if(0===e.number)return t;if("literal"===t.type)return new r(t.number-e.number)}return"binary"===e.type&&"-"===e.op&&"literal"===t.type&&1===t.number&&"literal"===e.arg1.type&&1===e.arg1.number?e.arg2:new s("-",t,e,t.min-e.max,t.max-e.min)}function l(t,e){return t.min>=e?new r(e):t.max<=e?t:new i(t,e)}class h{compile(t,s,i){const h=[],f=[],m=s.length>>1,b=i.length>>1;let g,d,y,v,x,k,S,w,_=0;for(let r=0;r<m;r++)h.push(new e(r,s[2*r],s[2*r+1]));for(let e=0,a=t.length;e<a;e++)if(w=t[e],"number"!==typeof w)switch(w){case"add":if(h.length<2)return null;v=h.pop(),y=h.pop(),h.push(p(y,v));break;case"cvr":if(h.length<1)return null;break;case"mul":if(h.length<2)return null;v=h.pop(),y=h.pop(),h.push(c(y,v));break;case"sub":if(h.length<2)return null;v=h.pop(),y=h.pop(),h.push(u(y,v));break;case"exch":if(h.length<2)return null;x=h.pop(),k=h.pop(),h.push(x,k);break;case"pop":if(h.length<1)return null;h.pop();break;case"index":if(h.length<1)return null;if(y=h.pop(),"literal"!==y.type)return null;if(g=y.number,g<0||!Number.isInteger(g)||h.length<g)return null;if(x=h[h.length-g-1],"literal"===x.type||"var"===x.type){h.push(x);break}S=new n(_++,x.min,x.max),h[h.length-g-1]=S,h.push(S),f.push(new o(S,x));break;case"dup":if(h.length<1)return null;if("number"===typeof t[e+1]&&"gt"===t[e+2]&&t[e+3]===e+7&&"jz"===t[e+4]&&"pop"===t[e+5]&&t[e+6]===t[e+1]){y=h.pop(),h.push(l(y,t[e+1])),e+=6;break}if(x=h[h.length-1],"literal"===x.type||"var"===x.type){h.push(x);break}S=new n(_++,x.min,x.max),h[h.length-1]=S,h.push(S),f.push(new o(S,x));break;case"roll":if(h.length<2)return null;if(v=h.pop(),y=h.pop(),"literal"!==v.type||"literal"!==y.type)return null;if(d=v.number,g=y.number,g<=0||!Number.isInteger(g)||!Number.isInteger(d)||h.length<g)return null;if(d=(d%g+g)%g,0===d)break;Array.prototype.push.apply(h,h.splice(h.length-g,g-d));break;default:return null}else h.push(new r(w));if(h.length!==b)return null;const A=[];for(const e of f){const t=new a;e.visit(t),A.push(t.toString())}for(let e=0,r=h.length;e<r;e++){const t=h[e],r=new a;t.visit(r);const s=i[2*e],n=i[2*e+1],o=[r.toString()];s>t.min&&(o.unshift("Math.max(",s,", "),o.push(")")),n<t.max&&(o.unshift("Math.min(",n,", "),o.push(")")),o.unshift("dest[destOffset + ",e,"] = "),o.push(";"),A.push(o.join(""))}return A.join("\n")}}return h}();exports.PostScriptCompiler=PostScriptCompiler;