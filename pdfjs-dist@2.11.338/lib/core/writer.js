"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.incrementalUpdate=incrementalUpdate,exports.writeDict=writeDict;var _util=require("../shared/util.js"),_primitives=require("./primitives.js"),_core_utils=require("./core_utils.js"),_xml_parser=require("./xml_parser.js"),_crypto=require("./crypto.js");function writeDict(e,t,n){t.push("<<");for(const r of e.getKeys())t.push(` /${(0,_core_utils.escapePDFName)(r)} `),writeValue(e.getRaw(r),t,n);t.push(">>")}function writeStream(e,t,n){writeDict(e.dict,t,n),t.push(" stream\n");let r=e.getString();null!==n&&(r=n.encryptString(r)),t.push(r,"\nendstream\n")}function writeArray(e,t,n){t.push("[");let r=!0;for(const i of e)r?r=!1:t.push(" "),writeValue(i,t,n);t.push("]")}function numberToString(e){if(Number.isInteger(e))return e.toString();const t=Math.round(100*e);return t%100===0?(t/100).toString():t%10===0?e.toFixed(1):e.toFixed(2)}function writeValue(e,t,n){(0,_primitives.isName)(e)?t.push(`/${(0,_core_utils.escapePDFName)(e.name)}`):(0,_primitives.isRef)(e)?t.push(`${e.num} ${e.gen} R`):Array.isArray(e)?writeArray(e,t,n):"string"===typeof e?(null!==n&&(e=n.encryptString(e)),t.push(`(${(0,_util.escapeString)(e)})`)):"number"===typeof e?t.push(numberToString(e)):"boolean"===typeof e?t.push(e.toString()):(0,_primitives.isDict)(e)?writeDict(e,t,n):(0,_primitives.isStream)(e)?writeStream(e,t,n):null===e?t.push("null"):(0,_util.warn)(`Unhandled value in writer: ${typeof e}, please file a bug.`)}function writeInt(e,t,n,r){for(let i=t+n-1;i>n-1;i--)r[i]=255&e,e>>=8;return n+t}function writeString(e,t,n){for(let r=0,i=e.length;r<i;r++)n[t+r]=255&e.charCodeAt(r)}function computeMD5(e,t){const n=Math.floor(Date.now()/1e3),r=t.filename||"",i=[n.toString(),r,e.toString()];let s=i.reduce(((e,t)=>e+t.length),0);for(const u of Object.values(t.info))i.push(u),s+=u.length;const o=new Uint8Array(s);let a=0;for(const u of i)writeString(u,a,o),a+=u.length;return(0,_util.bytesToString)((0,_crypto.calculateMD5)(o))}function writeXFADataForAcroform(e,t){const n=new _xml_parser.SimpleXMLParser({hasAttributes:!0}).parseFromString(e);for(const{xfa:i}of t){if(!i)continue;const{path:e,value:t}=i;if(!e)continue;const r=n.documentElement.searchNode((0,_core_utils.parseXFAPath)(e),0);r?r.childNodes=[new _xml_parser.SimpleDOMNode("#text",t)]:(0,_util.warn)(`Node not found for path: ${e}`)}const r=[];return n.documentElement.dump(r),r.join("")}function updateXFA({xfaData:e,xfaDatasetsRef:t,hasXfaDatasetsEntry:n,acroFormRef:r,acroForm:i,newRefs:s,xref:o,xrefInfo:a}){if(null===o)return;if(!n){if(!r)return void(0,_util.warn)("XFA - Cannot save it");const e=i.get("XFA"),n=e.slice();n.splice(2,0,"datasets"),n.splice(3,0,t),i.set("XFA",n);const a=o.encrypt;let u=null;a&&(u=a.createCipherTransform(r.num,r.gen));const l=[`${r.num} ${r.gen} obj\n`];writeDict(i,l,u),l.push("\n"),i.set("XFA",e),s.push({ref:r,data:l.join("")})}if(null===e){const n=o.fetchIfRef(t);e=writeXFADataForAcroform(n.getString(),s)}const u=o.encrypt;if(u){const n=u.createCipherTransform(t.num,t.gen);e=n.encryptString(e)}const l=`${t.num} ${t.gen} obj\n<< /Type /EmbeddedFile /Length ${e.length}>>\nstream\n`+e+"\nendstream\nendobj\n";s.push({ref:t,data:l})}function incrementalUpdate({originalData:e,xrefInfo:t,newRefs:n,xref:r=null,hasXfa:i=!1,xfaDatasetsRef:s=null,hasXfaDatasetsEntry:o=!1,acroFormRef:a=null,acroForm:u=null,xfaData:l=null}){i&&updateXFA({xfaData:l,xfaDatasetsRef:s,hasXfaDatasetsEntry:o,acroFormRef:a,acroForm:u,newRefs:n,xref:r,xrefInfo:t});const f=new _primitives.Dict(null),c=t.newRef;let p,m;const h=e[e.length-1];10===h||13===h?(p=[],m=e.length):(p=["\n"],m=e.length+1),f.set("Size",c.num+1),f.set("Prev",t.startXRef),f.set("Type",_primitives.Name.get("XRef")),null!==t.rootRef&&f.set("Root",t.rootRef),null!==t.infoRef&&f.set("Info",t.infoRef),null!==t.encryptRef&&f.set("Encrypt",t.encryptRef),n.push({ref:c,data:""}),n=n.sort(((e,t)=>e.ref.num-t.ref.num));const g=[[0,1,65535]],d=[0,1];let w=0;for(const{ref:b,data:v}of n)w=Math.max(w,m),g.push([1,m,Math.min(b.gen,65535)]),m+=v.length,d.push(b.num,1),p.push(v);if(f.set("Index",d),Array.isArray(t.fileIds)&&t.fileIds.length>0){const e=computeMD5(m,t);f.set("ID",[t.fileIds[0],e])}const _=Math.ceil(Math.log2(w)/8),y=[1,_,2],D=y[0]+y[1]+y[2],x=D*g.length;f.set("W",y),f.set("Length",x),p.push(`${c.num} ${c.gen} obj\n`),writeDict(f,p,null),p.push(" stream\n");const S=p.reduce(((e,t)=>e+t.length),0),F=`\nendstream\nendobj\nstartxref\n${m}\n%%EOF\n`,R=new Uint8Array(e.length+S+x+F.length);R.set(e);let A=e.length;for(const b of p)writeString(b,A,R),A+=b.length;for(const[b,v,X]of g)A=writeInt(b,y[0],A,R),A=writeInt(v,y[1],A,R),A=writeInt(X,y[2],A,R);return writeString(F,A,R),R}