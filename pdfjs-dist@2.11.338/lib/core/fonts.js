"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Font=exports.ErrorFont=void 0;var _util=require("../shared/util.js"),_cff_parser=require("./cff_parser.js"),_fonts_utils=require("./fonts_utils.js"),_glyphlist=require("./glyphlist.js"),_encodings=require("./encodings.js"),_standard_fonts=require("./standard_fonts.js"),_unicode=require("./unicode.js"),_to_unicode_map=require("./to_unicode_map.js"),_cff_font=require("./cff_font.js"),_font_renderer=require("./font_renderer.js"),_glyf=require("./glyf.js"),_cmap=require("./cmap.js"),_opentype_file_builder=require("./opentype_file_builder.js"),_core_utils=require("./core_utils.js"),_stream=require("./stream.js"),_type1_font=require("./type1_font.js");const PRIVATE_USE_AREAS=[[57344,63743],[1048576,1114109]],PDF_GLYPH_SPACE_UNITS=1e3,EXPORT_DATA_PROPERTIES=["ascent","bbox","black","bold","charProcOperatorList","composite","cssFontInfo","data","defaultVMetrics","defaultWidth","descent","fallbackName","fontMatrix","fontType","isType3Font","italic","loadedName","mimetype","missingFile","name","remeasure","subtype","type","vertical"],EXPORT_DATA_EXTRA_PROPERTIES=["cMap","defaultEncoding","differences","isMonospace","isSerifFont","isSymbolicFont","seacMap","toFontChar","toUnicode","vmetrics","widths"];function adjustWidths(t){if(!t.fontMatrix)return;if(t.fontMatrix[0]===_util.FONT_IDENTITY_MATRIX[0])return;const e=.001/t.fontMatrix[0],n=t.widths;for(const i in n)n[i]*=e;t.defaultWidth*=e}function adjustToUnicode(t,e){if(t.isInternalFont)return;if(e===t.defaultEncoding)return;if(t.toUnicode instanceof _to_unicode_map.IdentityToUnicodeMap)return;const n=[],i=(0,_glyphlist.getGlyphsUnicode)();for(const o in e){if(t.hasIncludedToUnicodeMap){if(t.toUnicode.has(o))continue}else if(t.hasEncoding&&(0===t.differences.length||void 0!==t.differences[o]))continue;const s=e[o],a=(0,_unicode.getUnicodeForGlyph)(s,i);-1!==a&&(n[o]=String.fromCharCode(a))}n.length>0&&t.toUnicode.amend(n)}function amendFallbackToUnicode(t){if(!t.fallbackToUnicode)return;if(t.toUnicode instanceof _to_unicode_map.IdentityToUnicodeMap)return;const e=[];for(const n in t.fallbackToUnicode)t.toUnicode.has(n)||(e[n]=t.fallbackToUnicode[n]);e.length>0&&t.toUnicode.amend(e)}class Glyph{constructor(t,e,n,i,o,s,a,r,l){this.originalCharCode=t,this.fontChar=e,this.unicode=n,this.accent=i,this.width=o,this.vmetric=s,this.operatorListId=a,this.isSpace=r,this.isInFont=l}matchesForCache(t,e,n,i,o,s,a,r,l){return this.originalCharCode===t&&this.fontChar===e&&this.unicode===n&&this.accent===i&&this.width===o&&this.vmetric===s&&this.operatorListId===a&&this.isSpace===r&&this.isInFont===l}}function int16(t,e){return(t<<8)+e}function writeSignedInt16(t,e,n){t[e+1]=n,t[e]=n>>>8}function signedInt16(t,e){const n=(t<<8)+e;return 32768&n?n-65536:n}function int32(t,e,n,i){return(t<<24)+(e<<16)+(n<<8)+i}function string16(t){return String.fromCharCode(t>>8&255,255&t)}function safeString16(t){return t>32767?t=32767:t<-32768&&(t=-32768),String.fromCharCode(t>>8&255,255&t)}function isTrueTypeFile(t){const e=t.peekBytes(4);return 65536===(0,_core_utils.readUint32)(e,0)||"true"===(0,_util.bytesToString)(e)}function isTrueTypeCollectionFile(t){const e=t.peekBytes(4);return"ttcf"===(0,_util.bytesToString)(e)}function isOpenTypeFile(t){const e=t.peekBytes(4);return"OTTO"===(0,_util.bytesToString)(e)}function isType1File(t){const e=t.peekBytes(2);return 37===e[0]&&33===e[1]||128===e[0]&&1===e[1]}function isCFFFile(t){const e=t.peekBytes(4);return e[0]>=1&&e[3]>=1&&e[3]<=4}function getFontFileType(t,{type:e,subtype:n,composite:i}){let o,s;return isTrueTypeFile(t)||isTrueTypeCollectionFile(t)?o=i?"CIDFontType2":"TrueType":isOpenTypeFile(t)?o=i?"CIDFontType2":"OpenType":isType1File(t)?o=i?"CIDFontType0":"MMType1"===e?"MMType1":"Type1":isCFFFile(t)?i?(o="CIDFontType0",s="CIDFontType0C"):(o="MMType1"===e?"MMType1":"Type1",s="Type1C"):((0,_util.warn)("getFontFileType: Unable to detect correct font file Type/Subtype."),o=e,s=n),[o,s]}function applyStandardFontGlyphMap(t,e){for(const n in e)t[+n]=e[n]}function buildToFontChar(t,e,n){const i=[];let o;for(let s=0,a=t.length;s<a;s++)o=(0,_unicode.getUnicodeForGlyph)(t[s],e),-1!==o&&(i[s]=o);for(const s in n)o=(0,_unicode.getUnicodeForGlyph)(n[s],e),-1!==o&&(i[+s]=o);return i}function convertCidString(t,e,n=!1){switch(e.length){case 1:return e.charCodeAt(0);case 2:return e.charCodeAt(0)<<8|e.charCodeAt(1)}const i=`Unsupported CID string (charCode ${t}): "${e}".`;if(n)throw new _util.FormatError(i);return(0,_util.warn)(i),e}function adjustMapping(t,e,n){const i=Object.create(null),o=[];let s=0,a=PRIVATE_USE_AREAS[s][0],r=PRIVATE_USE_AREAS[s][1];for(let l in t){l|=0;let c=t[l];if(!e(c))continue;if(a>r){if(s++,s>=PRIVATE_USE_AREAS.length){(0,_util.warn)("Ran out of space in font private use area.");break}a=PRIVATE_USE_AREAS[s][0],r=PRIVATE_USE_AREAS[s][1]}const d=a++;0===c&&(c=n),i[d]=c,o[l]=d}return{toFontChar:o,charCodeToGlyphId:i,nextAvailableFontCharCode:a}}function getRanges(t,e){const n=[];for(const s in t)t[s]>=e||n.push({fontCharCode:0|s,glyphId:t[s]});0===n.length&&n.push({fontCharCode:0,glyphId:0}),n.sort((function(t,e){return t.fontCharCode-e.fontCharCode}));const i=[],o=n.length;for(let s=0;s<o;){const t=n[s].fontCharCode,e=[n[s].glyphId];++s;let a=t;while(s<o&&a+1===n[s].fontCharCode)if(e.push(n[s].glyphId),++a,++s,65535===a)break;i.push([t,a,e])}return i}function createCmapTable(t,e){const n=getRanges(t,e),i=n[n.length-1][1]>65535?2:1;let o,s,a,r,l="\0\0"+string16(i)+"\0\x03\0\x01"+(0,_util.string32)(4+8*i);for(o=n.length-1;o>=0;--o)if(n[o][0]<=65535)break;const c=o+1;n[o][0]<65535&&65535===n[o][1]&&(n[o][1]=65534);const d=n[o][1]<65535?1:0,h=c+d,f=_opentype_file_builder.OpenTypeFileBuilder.getSearchParams(h,2);let p,u,g,_,y="",m="",T="",F="",C="",b=0;for(o=0,s=c;o<s;o++){p=n[o],u=p[0],g=p[1],y+=string16(u),m+=string16(g),_=p[2];let t=!0;for(a=1,r=_.length;a<r;++a)if(_[a]!==_[a-1]+1){t=!1;break}if(t){const t=_[0];T+=string16(t-u&65535),F+=string16(0)}else{const t=2*(h-o)+2*b;for(b+=g-u+1,T+=string16(0),F+=string16(t),a=0,r=_.length;a<r;++a)C+=string16(_[a])}}d>0&&(m+="\xff\xff",y+="\xff\xff",T+="\0\x01",F+="\0\0");const S="\0\0"+string16(2*h)+string16(f.range)+string16(f.entry)+string16(f.rangeShift)+m+"\0\0"+y+T+F+C;let I="",U="";if(i>1){for(l+="\0\x03\0\n"+(0,_util.string32)(4+8*i+4+S.length),I="",o=0,s=n.length;o<s;o++){p=n[o],u=p[0],_=p[2];let t=_[0];for(a=1,r=_.length;a<r;++a)_[a]!==_[a-1]+1&&(g=p[0]+a-1,I+=(0,_util.string32)(u)+(0,_util.string32)(g)+(0,_util.string32)(t),u=g+1,t=_[a]);I+=(0,_util.string32)(u)+(0,_util.string32)(p[1])+(0,_util.string32)(t)}U="\0\f\0\0"+(0,_util.string32)(I.length+16)+"\0\0\0\0"+(0,_util.string32)(I.length/12)}return l+"\0\x04"+string16(S.length+4)+S+U+I}function validateOS2Table(t,e){e.pos=(e.start||0)+t.offset;const n=e.getUint16();e.skip(60);const i=e.getUint16();if(n<4&&768&i)return!1;const o=e.getUint16(),s=e.getUint16();if(o>s)return!1;e.skip(6);const a=e.getUint16();return 0!==a&&(t.data[8]=t.data[9]=0,!0)}function createOS2Table(t,e,n){n=n||{unitsPerEm:0,yMax:0,yMin:0,ascent:0,descent:0};let i=0,o=0,s=0,a=0,r=null,l=0;if(e){for(let t in e){t|=0,(r>t||!r)&&(r=t),l<t&&(l=t);const e=(0,_unicode.getUnicodeRangeFor)(t);if(e<32)i|=1<<e;else if(e<64)o|=1<<e-32;else if(e<96)s|=1<<e-64;else{if(!(e<123))throw new _util.FormatError("Unicode ranges Bits > 123 are reserved for internal usage");a|=1<<e-96}}l>65535&&(l=65535)}else r=0,l=255;const c=t.bbox||[0,0,0,0],d=n.unitsPerEm||1/(t.fontMatrix||_util.FONT_IDENTITY_MATRIX)[0],h=t.ascentScaled?1:d/PDF_GLYPH_SPACE_UNITS,f=n.ascent||Math.round(h*(t.ascent||c[3]));let p=n.descent||Math.round(h*(t.descent||c[1]));p>0&&t.descent>0&&c[1]<0&&(p=-p);const u=n.yMax||f,g=-n.yMin||-p;return"\0\x03\x02$\x01\xf4\0\x05\0\0\x02\x8a\x02\xbb\0\0\0\x8c\x02\x8a\x02\xbb\0\0\x01\xdf\x001\x01\x02\0\0\0\0\x06"+String.fromCharCode(t.fixedPitch?9:0)+"\0\0\0\0\0\0"+(0,_util.string32)(i)+(0,_util.string32)(o)+(0,_util.string32)(s)+(0,_util.string32)(a)+"*21*"+string16(t.italicAngle?1:0)+string16(r||t.firstChar)+string16(l||t.lastChar)+string16(f)+string16(p)+"\0d"+string16(u)+string16(g)+"\0\0\0\0\0\0\0\0"+string16(t.xHeight)+string16(t.capHeight)+string16(0)+string16(r||t.firstChar)+"\0\x03"}function createPostTable(t){const e=Math.floor(65536*t.italicAngle);return"\0\x03\0\0"+(0,_util.string32)(e)+"\0\0\0\0"+(0,_util.string32)(t.fixedPitch?1:0)+"\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"}function createPostscriptName(t){return t.replace(/[^\x21-\x7E]|[[\](){}<>/%]/g,"").slice(0,63)}function createNameTable(t,e){e||(e=[[],[]]);const n=[e[0][0]||"Original licence",e[0][1]||t,e[0][2]||"Unknown",e[0][3]||"uniqueID",e[0][4]||t,e[0][5]||"Version 0.11",e[0][6]||createPostscriptName(t),e[0][7]||"Unknown",e[0][8]||"Unknown",e[0][9]||"Unknown"],i=[];let o,s,a,r,l;for(o=0,s=n.length;o<s;o++){l=e[1][o]||n[o];const t=[];for(a=0,r=l.length;a<r;a++)t.push(string16(l.charCodeAt(a)));i.push(t.join(""))}const c=[n,i],d=["\0\x01","\0\x03"],h=["\0\0","\0\x01"],f=["\0\0","\x04\t"],p=n.length*d.length;let u="\0\0"+string16(p)+string16(12*p+6),g=0;for(o=0,s=d.length;o<s;o++){const t=c[o];for(a=0,r=t.length;a<r;a++){l=t[a];const e=d[o]+h[o]+f[o]+string16(a)+string16(l.length)+string16(g);u+=e,g+=l.length}}return u+=n.join("")+i.join(""),u}class Font{constructor(t,e,n){this.name=t,this.psName=null,this.mimetype=null,this.disableFontFace=!1,this.loadedName=n.loadedName,this.isType3Font=n.isType3Font,this.missingFile=!1,this.cssFontInfo=n.cssFontInfo,this._charsCache=Object.create(null),this._glyphCache=Object.create(null);let i=!!(n.flags&_fonts_utils.FontFlags.Serif);if(!i&&!n.isSimulatedFlags){const e=t.replace(/[,_]/g,"-").split("-")[0],n=(0,_standard_fonts.getSerifFonts)();for(const t of e.split("+"))if(n[t]){i=!0;break}}this.isSerifFont=i,this.isSymbolicFont=!!(n.flags&_fonts_utils.FontFlags.Symbolic),this.isMonospace=!!(n.flags&_fonts_utils.FontFlags.FixedPitch);let o=n.type,s=n.subtype;this.type=o,this.subtype=s;let a,r="sans-serif";if(this.isMonospace?r="monospace":this.isSerifFont&&(r="serif"),this.fallbackName=r,this.differences=n.differences,this.widths=n.widths,this.defaultWidth=n.defaultWidth,this.composite=n.composite,this.cMap=n.cMap,this.capHeight=n.capHeight/PDF_GLYPH_SPACE_UNITS,this.ascent=n.ascent/PDF_GLYPH_SPACE_UNITS,this.descent=n.descent/PDF_GLYPH_SPACE_UNITS,this.lineHeight=this.ascent-this.descent,this.fontMatrix=n.fontMatrix,this.bbox=n.bbox,this.defaultEncoding=n.defaultEncoding,this.toUnicode=n.toUnicode,this.toFontChar=[],"Type3"!==n.type){if(this.cidEncoding=n.cidEncoding||"",this.vertical=!!n.vertical,this.vertical&&(this.vmetrics=n.vmetrics,this.defaultVMetrics=n.defaultVMetrics),!e||e.isEmpty)return e&&(0,_util.warn)('Font file is empty in "'+t+'" ('+this.loadedName+")"),void this.fallbackToSystemFont(n);[o,s]=getFontFileType(e,n),o===this.type&&s===this.subtype||(0,_util.info)(`Inconsistent font file Type/SubType, expected: ${this.type}/${this.subtype} but found: ${o}/${s}.`);try{switch(o){case"MMType1":(0,_util.info)("MMType1 font ("+t+"), falling back to Type1.");case"Type1":case"CIDFontType0":this.mimetype="font/opentype";const i="Type1C"===s||"CIDFontType0C"===s?new _cff_font.CFFFont(e,n):new _type1_font.Type1Font(t,e,n);adjustWidths(n),a=this.convert(t,i,n);break;case"OpenType":case"TrueType":case"CIDFontType2":this.mimetype="font/opentype",a=this.checkAndRepair(t,e,n),this.isOpenType&&(adjustWidths(n),o="OpenType");break;default:throw new _util.FormatError(`Font ${o} is not supported`)}}catch(l){return(0,_util.warn)(l),void this.fallbackToSystemFont(n)}amendFallbackToUnicode(n),this.data=a,this.fontType=(0,_fonts_utils.getFontType)(o,s,n.isStandardFont),this.fontMatrix=n.fontMatrix,this.widths=n.widths,this.defaultWidth=n.defaultWidth,this.toUnicode=n.toUnicode,this.seacMap=n.seacMap}else{for(let t=0;t<256;t++)this.toFontChar[t]=this.differences[t]||n.defaultEncoding[t];this.fontType=_util.FontType.TYPE3}}get renderer(){const t=_font_renderer.FontRendererFactory.create(this,_fonts_utils.SEAC_ANALYSIS_ENABLED);return(0,_util.shadow)(this,"renderer",t)}exportData(t=!1){const e=t?[...EXPORT_DATA_PROPERTIES,...EXPORT_DATA_EXTRA_PROPERTIES]:EXPORT_DATA_PROPERTIES,n=Object.create(null);let i,o;for(i of e)o=this[i],void 0!==o&&(n[i]=o);return n}fallbackToSystemFont(t){this.missingFile=!0;const e=this.name,n=this.type,i=this.subtype;let o=(0,_fonts_utils.normalizeFontName)(e);const s=(0,_standard_fonts.getStdFontMap)(),a=(0,_standard_fonts.getNonStdFontMap)(),r=!!s[o],l=!(!a[o]||!s[a[o]]);o=s[o]||a[o]||o,this.bold=-1!==o.search(/bold/gi),this.italic=-1!==o.search(/oblique/gi)||-1!==o.search(/italic/gi),this.black=-1!==e.search(/Black/g);const c=-1!==e.search(/Narrow/g);if(this.remeasure=(!r||c)&&Object.keys(this.widths).length>0,(r||l)&&"CIDFontType2"===n&&this.cidEncoding.startsWith("Identity-")){const n=t.cidToGidMap,i=[];if(applyStandardFontGlyphMap(i,(0,_standard_fonts.getGlyphMapForStandardFonts)()),/Arial-?Black/i.test(e)?applyStandardFontGlyphMap(i,(0,_standard_fonts.getSupplementalGlyphMapForArialBlack)()):/Calibri/i.test(e)&&applyStandardFontGlyphMap(i,(0,_standard_fonts.getSupplementalGlyphMapForCalibri)()),n){for(const t in i){const e=i[t];void 0!==n[e]&&(i[+t]=n[e])}n.length!==this.toUnicode.length&&t.hasIncludedToUnicodeMap&&this.toUnicode instanceof _to_unicode_map.IdentityToUnicodeMap&&this.toUnicode.forEach((function(t,e){const o=i[t];void 0===n[o]&&(i[+t]=e)}))}this.toUnicode instanceof _to_unicode_map.IdentityToUnicodeMap||this.toUnicode.forEach((function(t,e){i[+t]=e})),this.toFontChar=i,this.toUnicode=new _to_unicode_map.ToUnicodeMap(i)}else if(/Symbol/i.test(o))this.toFontChar=buildToFontChar(_encodings.SymbolSetEncoding,(0,_glyphlist.getGlyphsUnicode)(),this.differences);else if(/Dingbats/i.test(o))/Wingdings/i.test(e)&&(0,_util.warn)("Non-embedded Wingdings font, falling back to ZapfDingbats."),this.toFontChar=buildToFontChar(_encodings.ZapfDingbatsEncoding,(0,_glyphlist.getDingbatsGlyphsUnicode)(),this.differences);else if(r){const t=buildToFontChar(this.defaultEncoding,(0,_glyphlist.getGlyphsUnicode)(),this.differences);"CIDFontType2"!==n||this.cidEncoding.startsWith("Identity-")||this.toUnicode instanceof _to_unicode_map.IdentityToUnicodeMap||this.toUnicode.forEach((function(e,n){t[+e]=n})),this.toFontChar=t}else{const t=(0,_glyphlist.getGlyphsUnicode)(),n=[];this.toUnicode.forEach(((e,i)=>{if(!this.composite){const n=this.differences[e]||this.defaultEncoding[e],o=(0,_unicode.getUnicodeForGlyph)(n,t);-1!==o&&(i=o)}n[+e]=i})),this.composite&&this.toUnicode instanceof _to_unicode_map.IdentityToUnicodeMap&&/Verdana/i.test(e)&&applyStandardFontGlyphMap(n,(0,_standard_fonts.getGlyphMapForStandardFonts)()),this.toFontChar=n}amendFallbackToUnicode(t),this.loadedName=o.split("-")[0],this.fontType=(0,_fonts_utils.getFontType)(n,i,t.isStandardFont)}checkAndRepair(t,e,n){const i=["OS/2","cmap","head","hhea","hmtx","maxp","name","post","loca","glyf","fpgm","prep","cvt ","CFF "];function o(t,e){const n=Object.create(null);n["OS/2"]=null,n.cmap=null,n.head=null,n.hhea=null,n.hmtx=null,n.maxp=null,n.name=null,n.post=null;for(let o=0;o<e;o++){const e=s(t);i.includes(e.tag)&&(0!==e.length&&(n[e.tag]=e))}return n}function s(t){const e=t.getString(4),n=t.getInt32()>>>0,i=t.getInt32()>>>0,o=t.getInt32()>>>0,s=t.pos;t.pos=t.start?t.start:0,t.skip(i);const a=t.getBytes(o);return t.pos=s,"head"===e&&(a[8]=a[9]=a[10]=a[11]=0,a[17]|=32),{tag:e,checksum:n,length:o,offset:i,data:a}}function a(t){return{version:t.getString(4),numTables:t.getUint16(),searchRange:t.getUint16(),entrySelector:t.getUint16(),rangeShift:t.getUint16()}}function r(t){const e=t.getString(4);(0,_util.assert)("ttcf"===e,"Must be a TrueType Collection font.");const n=t.getUint16(),i=t.getUint16(),o=t.getInt32()>>>0,s=[];for(let r=0;r<o;r++)s.push(t.getInt32()>>>0);const a={ttcTag:e,majorVersion:n,minorVersion:i,numFonts:o,offsetTable:s};switch(n){case 1:return a;case 2:return a.dsigTag=t.getInt32()>>>0,a.dsigLength=t.getInt32()>>>0,a.dsigOffset=t.getInt32()>>>0,a}throw new _util.FormatError(`Invalid TrueType Collection majorVersion: ${n}.`)}function l(t,e){const{numFonts:n,offsetTable:i}=r(t),s=e.split("+");let l;for(let r=0;r<n;r++){t.pos=(t.start||0)+i[r];const n=a(t),c=o(t,n.numTables);if(!c.name)throw new _util.FormatError('TrueType Collection font must contain a "name" table.');const d=g(c.name);for(let t=0,i=d.length;t<i;t++)for(let o=0,a=d[t].length;o<a;o++){const i=d[t][o]&&d[t][o].replace(/\s/g,"");if(i){if(i===e)return{header:n,tables:c};if(!(s.length<2))for(const t of s)i===t&&(l={name:t,header:n,tables:c})}}}if(l)return(0,_util.warn)(`TrueType Collection does not contain "${e}" font, falling back to "${l.name}" font instead.`),{header:l.header,tables:l.tables};throw new _util.FormatError(`TrueType Collection does not contain "${e}" font.`)}function c(t,e,n,i){if(!t)return(0,_util.warn)("No cmap table available."),{platformId:-1,encodingId:-1,mappings:[],hasShortCmap:!1};let o,s=(e.start?e.start:0)+t.offset;e.pos=s,e.skip(2);const a=e.getUint16();let r,l=!1;for(let u=0;u<a;u++){const t=e.getUint16(),o=e.getUint16(),s=e.getInt32()>>>0;let c=!1;if(!r||r.platformId!==t||r.encodingId!==o){if(0!==t||0!==o&&1!==o&&3!==o)if(1===t&&0===o)c=!0;else if(3!==t||1!==o||!i&&r){if(n&&3===t&&0===o){c=!0;let n=!0;if(u<a-1){const i=e.peekBytes(2),o=int16(i[0],i[1]);o<t&&(n=!1)}n&&(l=!0)}}else c=!0,n||(l=!0);else c=!0;if(c&&(r={platformId:t,encodingId:o,offset:s}),l)break}}if(r&&(e.pos=s+r.offset),!r||-1===e.peekByte())return(0,_util.warn)("Could not find a preferred cmap table."),{platformId:-1,encodingId:-1,mappings:[],hasShortCmap:!1};const c=e.getUint16();e.skip(4);let d=!1;const h=[];let f,p;if(0===c){for(f=0;f<256;f++){const t=e.getByte();t&&h.push({charCode:f,glyphId:t})}d=!0}else if(4===c){const t=e.getUint16()>>1;e.skip(6);const n=[];let i;for(i=0;i<t;i++)n.push({end:e.getUint16()});for(e.skip(2),i=0;i<t;i++)n[i].start=e.getUint16();for(i=0;i<t;i++)n[i].delta=e.getUint16();let a,r=0;for(i=0;i<t;i++){o=n[i];const s=e.getUint16();s?(a=(s>>1)-(t-i),o.offsetIndex=a,r=Math.max(r,a+o.end-o.start+1)):o.offsetIndex=-1}const l=[];for(f=0;f<r;f++)l.push(e.getUint16());for(i=0;i<t;i++){o=n[i],s=o.start;const t=o.end,e=o.delta;for(a=o.offsetIndex,f=s;f<=t;f++)65535!==f&&(p=a<0?f:l[a+f-s],p=p+e&65535,h.push({charCode:f,glyphId:p}))}}else{if(6!==c)return(0,_util.warn)("cmap table has unsupported format: "+c),{platformId:-1,encodingId:-1,mappings:[],hasShortCmap:!1};{const t=e.getUint16(),n=e.getUint16();for(f=0;f<n;f++){p=e.getUint16();const n=t+f;h.push({charCode:n,glyphId:p})}}}h.sort((function(t,e){return t.charCode-e.charCode}));for(let u=1;u<h.length;u++)h[u-1].charCode===h[u].charCode&&(h.splice(u,1),u--);return{platformId:r.platformId,encodingId:r.encodingId,mappings:h,hasShortCmap:d}}function d(t,e,n,i,o,s){if(!e)return void(n&&(n.data=null));t.pos=(t.start?t.start:0)+e.offset,t.pos+=4,t.pos+=2,t.pos+=2,t.pos+=2,t.pos+=2,t.pos+=2,t.pos+=2,t.pos+=2,t.pos+=2,t.pos+=2;const a=t.getUint16();t.pos+=8,t.pos+=2;let r=t.getUint16();if(0!==a){const t=int16(i.data[44],i.data[45]);2&t||(e.data[22]=0,e.data[23]=0)}r>o&&((0,_util.info)(`The numOfMetrics (${r}) should not be greater than the numGlyphs (${o}).`),r=o,e.data[34]=(65280&r)>>8,e.data[35]=255&r);const l=o-r,c=l-(n.length-4*r>>1);if(c>0){const t=new Uint8Array(n.length+2*c);t.set(n.data),s&&(t[n.length]=n.data[2],t[n.length+1]=n.data[3]),n.data=t}}function h(t,e,n,i,o,s){const a={length:0,sizeOfInstructions:0};if(n-e<=12)return a;const r=t.subarray(e,n);let l=signedInt16(r[0],r[1]);if(l<0)return l=-1,writeSignedInt16(r,0,l),i.set(r,o),a.length=r.length,a;let c,d=10,h=0;for(c=0;c<l;c++){const t=r[d]<<8|r[d+1];h=t+1,d+=2}const f=d,p=r[d]<<8|r[d+1];a.sizeOfInstructions=p,d+=2+p;const u=d;let g=0;for(c=0;c<h;c++){const t=r[d++];192&t&&(r[d-1]=63&t);let e=2;2&t?e=1:16&t&&(e=0);let n=2;4&t?n=1:32&t&&(n=0);const i=e+n;if(g+=i,8&t){const t=r[d++];c+=t,g+=t*i}}if(0===g)return a;let _=d+g;return _>r.length?a:!s&&p>0?(i.set(r.subarray(0,f),o),i.set([0,0],o+f),i.set(r.subarray(u,_),o+f+2),_-=p,r.length-_>3&&(_=_+3&-4),a.length=_,a):r.length-_>3?(_=_+3&-4,i.set(r.subarray(0,_),o),a.length=_,a):(i.set(r,o),a.length=r.length,a)}function f(t,e,n){const i=t.data,o=int32(i[0],i[1],i[2],i[3]);o>>16!==1&&((0,_util.info)("Attempting to fix invalid version in head table: "+o),i[0]=0,i[1]=1,i[2]=0,i[3]=0);const s=int16(i[50],i[51]);if(s<0||s>1){(0,_util.info)("Attempting to fix invalid indexToLocFormat in head table: "+s);const t=e+1;if(n===t<<1)i[50]=0,i[51]=0;else{if(n!==t<<2)throw new _util.FormatError("Could not fix indexToLocFormat: "+s);i[50]=0,i[51]=1}}}function p(t,e,n,i,o,s,a){let r,l,c;i?(r=4,l=function(t,e){return t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3]},c=function(t,e,n){t[e]=n>>>24&255,t[e+1]=n>>16&255,t[e+2]=n>>8&255,t[e+3]=255&n}):(r=2,l=function(t,e){return t[e]<<9|t[e+1]<<1},c=function(t,e,n){t[e]=n>>9&255,t[e+1]=n>>1&255});const d=s?n+1:n,f=r*(1+d),p=new Uint8Array(f);p.set(t.data.subarray(0,f)),t.data=p;const u=e.data,g=u.length,_=new Uint8Array(g);let y,m;const T=[];for(y=0,m=0;y<n+1;y++,m+=r){let t=l(p,m);t>g&&(t=g),T.push({index:y,offset:t,endOffset:0})}for(T.sort(((t,e)=>t.offset-e.offset)),y=0;y<n;y++)T[y].endOffset=T[y+1].offset;T.sort(((t,e)=>t.index-e.index));const F=Object.create(null);let C=0;for(c(p,0,C),y=0,m=r;y<n;y++,m+=r){const t=h(u,T[y].offset,T[y].endOffset,_,C,o),e=t.length;0===e&&(F[y]=!0),t.sizeOfInstructions>a&&(a=t.sizeOfInstructions),C+=e,c(p,m,C)}if(0===C){const t=new Uint8Array([0,1,0,0,0,0,0,0,0,0,0,0,0,0,49,0]);for(y=0,m=r;y<d;y++,m+=r)c(p,m,t.length);e.data=t}else if(s){const n=l(p,r);_.length>n+C?e.data=_.subarray(0,n+C):(e.data=new Uint8Array(n+C),e.data.set(_.subarray(0,C))),e.data.set(_.subarray(0,n),C),c(t.data,p.length-r,C+n)}else e.data=_.subarray(0,C);return{missingGlyphs:F,maxSizeOfInstructions:a}}function u(t,n,i){const o=(e.start?e.start:0)+t.offset;e.pos=o;const s=t.length,a=o+s,r=e.getInt32();let l;e.skip(28);let c,d=!0;switch(r){case 65536:l=_fonts_utils.MacStandardGlyphOrdering;break;case 131072:const t=e.getUint16();if(t!==i){d=!1;break}const o=[];for(c=0;c<t;++c){const t=e.getUint16();if(t>=32768){d=!1;break}o.push(t)}if(!d)break;const s=[],h=[];while(e.pos<a){const t=e.getByte();for(h.length=t,c=0;c<t;++c)h[c]=String.fromCharCode(e.getByte());s.push(h.join(""))}for(l=[],c=0;c<t;++c){const t=o[c];t<258?l.push(_fonts_utils.MacStandardGlyphOrdering[t]):l.push(s[t-258])}break;case 196608:break;default:(0,_util.warn)("Unknown/unsupported post table version "+r),d=!1,n.defaultEncoding&&(l=n.defaultEncoding);break}return n.glyphNames=l,d}function g(t){const n=(e.start?e.start:0)+t.offset;e.pos=n;const i=[[],[]],o=t.length,s=n+o,a=e.getUint16(),r=6;if(0!==a||o<r)return i;const l=e.getUint16(),c=e.getUint16(),d=[],h=12;let f,p;for(f=0;f<l&&e.pos+h<=s;f++){const t={platform:e.getUint16(),encoding:e.getUint16(),language:e.getUint16(),name:e.getUint16(),length:e.getUint16(),offset:e.getUint16()};(1===t.platform&&0===t.encoding&&0===t.language||3===t.platform&&1===t.encoding&&1033===t.language)&&d.push(t)}for(f=0,p=d.length;f<p;f++){const t=d[f];if(t.length<=0)continue;const o=n+c+t.offset;if(o+t.length>s)continue;e.pos=o;const a=t.name;if(t.encoding){let n="";for(let i=0,o=t.length;i<o;i+=2)n+=String.fromCharCode(e.getUint16());i[1][a]=n}else i[0][a]=e.getString(t.length)}return i}const _=[0,0,0,0,0,0,0,0,-2,-2,-2,-2,0,0,-2,-5,-1,-1,-1,-1,-1,-1,-1,-1,0,0,-1,0,-1,-1,-1,-1,1,-1,-999,0,1,0,-1,-2,0,-1,-2,-1,-1,0,-1,-1,0,0,-999,-999,-1,-1,-1,-1,-2,-999,-2,-2,-999,0,-2,-2,0,0,-2,0,-2,0,0,0,-2,-1,-1,1,1,0,0,-1,-1,-1,-1,-1,-1,-1,0,0,-1,0,-1,-1,0,-999,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,-2,-999,-999,-999,-999,-999,-1,-1,-2,-2,0,0,0,0,-1,-1,-999,-2,-2,0,0,-1,-2,-2,0,0,0,-1,-1,-1,-2];function y(t,e){let n,i,o,s,a,r=t.data,l=0,c=0,d=0;const h=[],f=[],p=[];let u=e.tooComplexToFollowFunctions,g=!1,y=0,m=0;for(let T=r.length;l<T;){const t=r[l++];if(64===t)if(i=r[l++],g||m)l+=i;else for(n=0;n<i;n++)h.push(r[l++]);else if(65===t)if(i=r[l++],g||m)l+=2*i;else for(n=0;n<i;n++)o=r[l++],h.push(o<<8|r[l++]);else if(176===(248&t))if(i=t-176+1,g||m)l+=i;else for(n=0;n<i;n++)h.push(r[l++]);else if(184===(248&t))if(i=t-184+1,g||m)l+=2*i;else for(n=0;n<i;n++)o=r[l++],h.push(o<<8|r[l++]);else if(43!==t||u)if(44!==t||u){if(45===t)if(g)g=!1,c=l;else{if(a=f.pop(),!a)return(0,_util.warn)("TT: ENDF bad stack"),void(e.hintsValid=!1);s=p.pop(),r=a.data,l=a.i,e.functionsStackDeltas[s]=h.length-a.stackTop}else if(137===t)(g||m)&&((0,_util.warn)("TT: nested IDEFs not allowed"),u=!0),g=!0,d=l;else if(88===t)++y;else if(27===t)m=y;else if(89===t)m===y&&(m=0),--y;else if(28===t&&!g&&!m){const t=h[h.length-1];t>0&&(l+=t-1)}}else(g||m)&&((0,_util.warn)("TT: nested FDEFs not allowed"),u=!0),g=!0,d=l,s=h.pop(),e.functionsDefined[s]={data:r,i:l};else if(!g&&!m)if(s=h[h.length-1],isNaN(s))(0,_util.info)("TT: CALL empty stack (or invalid entry).");else if(e.functionsUsed[s]=!0,s in e.functionsStackDeltas){const t=h.length+e.functionsStackDeltas[s];if(t<0)return(0,_util.warn)("TT: CALL invalid functions stack delta."),void(e.hintsValid=!1);h.length=t}else if(s in e.functionsDefined&&!p.includes(s)){if(f.push({data:r,i:l,stackTop:h.length-1}),p.push(s),a=e.functionsDefined[s],!a)return(0,_util.warn)("TT: CALL non-existent function"),void(e.hintsValid=!1);r=a.data,l=a.i}if(!g&&!m){let e=0;t<=142?e=_[t]:t>=192&&t<=223?e=-1:t>=224&&(e=-2),t>=113&&t<=117&&(i=h.pop(),isNaN(i)||(e=2*-i));while(e<0&&h.length>0)h.pop(),e++;while(e>0)h.push(NaN),e--}}e.tooComplexToFollowFunctions=u;const F=[r];l>r.length&&F.push(new Uint8Array(l-r.length)),d>c&&((0,_util.warn)("TT: complementing a missing function tail"),F.push(new Uint8Array([34,45]))),T(t,F)}function m(t,e){if(!t.tooComplexToFollowFunctions){if(t.functionsDefined.length>e)return(0,_util.warn)("TT: more functions defined than expected"),void(t.hintsValid=!1);for(let n=0,i=t.functionsUsed.length;n<i;n++){if(n>e)return(0,_util.warn)("TT: invalid function id: "+n),void(t.hintsValid=!1);if(t.functionsUsed[n]&&!t.functionsDefined[n])return(0,_util.warn)("TT: undefined function: "+n),void(t.hintsValid=!1)}}}function T(t,e){if(e.length>1){let n,i,o=0;for(n=0,i=e.length;n<i;n++)o+=e[n].length;o=o+3&-4;const s=new Uint8Array(o);let a=0;for(n=0,i=e.length;n<i;n++)s.set(e[n],a),a+=e[n].length;t.data=s,t.length=o}}function F(t,e,n,i){const o={functionsDefined:[],functionsUsed:[],functionsStackDeltas:[],tooComplexToFollowFunctions:!1,hintsValid:!0};if(t&&y(t,o),e&&y(e,o),t&&m(o,i),n&&1&n.length){const t=new Uint8Array(n.length+1);t.set(n.data),n.data=t}return o.hintsValid}let C,b,S,I;if(e=new _stream.Stream(new Uint8Array(e.getBytes())),isTrueTypeCollectionFile(e)){const t=l(e,this.name);C=t.header,b=t.tables}else C=a(e),b=o(e,C.numTables);const U=!b["CFF "];if(U){if(!b.loca)throw new _util.FormatError('Required "loca" table is not found');b.glyf||((0,_util.warn)('Required "glyf" table is not found -- trying to recover.'),b.glyf={tag:"glyf",data:new Uint8Array(0)}),this.isOpenType=!1}else{const e=n.composite&&((n.cidToGidMap||[]).length>0||!(n.cMap instanceof _cmap.IdentityCMap));if("OTTO"===C.version&&!e||!b.head||!b.hhea||!b.maxp||!b.post)return I=new _stream.Stream(b["CFF "].data),S=new _cff_font.CFFFont(I,n),adjustWidths(n),this.convert(t,S,n);delete b.glyf,delete b.loca,delete b.fpgm,delete b.prep,delete b["cvt "],this.isOpenType=!0}if(!b.maxp)throw new _util.FormatError('Required "maxp" table is not found');e.pos=(e.start||0)+b.maxp.offset;const E=e.getInt32(),w=e.getUint16();if(n.scaleFactors&&n.scaleFactors.length===w&&U){const{scaleFactors:t}=n,e=int16(b.head.data[50],b.head.data[51]),i=new _glyf.GlyfTable({glyfTable:b.glyf.data,isGlyphLocationsLong:e,locaTable:b.loca.data,numGlyphs:w});i.scale(t);const{glyf:o,loca:s,isLocationLong:a}=i.write();b.glyf.data=o,b.loca.data=s,a!==!!e&&(b.head.data[50]=0,b.head.data[51]=a?1:0);const r=b.hmtx.data;for(let n=0;n<w;n++){const e=4*n,i=Math.round(t[n]*int16(r[e],r[e+1]));r[e]=i>>8&255,r[e+1]=255&i;const o=Math.round(t[n]*signedInt16(r[e+2],r[e+3]));writeSignedInt16(r,e+2,o)}}let M=w+1,A=!0;M>65535&&(A=!1,M=w,(0,_util.warn)("Not enough space in glyfs to duplicate first glyph."));let x=0,O=0;if(E>=65536&&b.maxp.length>=22){e.pos+=8;const t=e.getUint16();t>2&&(b.maxp.data[14]=0,b.maxp.data[15]=2),e.pos+=4,x=e.getUint16(),e.pos+=4,O=e.getUint16()}b.maxp.data[4]=M>>8,b.maxp.data[5]=255&M;const k=F(b.fpgm,b.prep,b["cvt "],x);if(k||(delete b.fpgm,delete b.prep,delete b["cvt "]),d(e,b.hhea,b.hmtx,b.head,M,A),!b.head)throw new _util.FormatError('Required "head" table is not found');f(b.head,w,U?b.loca.length:0);let v=Object.create(null);if(U){const t=int16(b.head.data[50],b.head.data[51]),e=p(b.loca,b.glyf,w,t,k,A,O);v=e.missingGlyphs,E>=65536&&b.maxp.length>=22&&(b.maxp.data[26]=e.maxSizeOfInstructions>>8,b.maxp.data[27]=255&e.maxSizeOfInstructions)}if(!b.hhea)throw new _util.FormatError('Required "hhea" table is not found');0===b.hhea.data[10]&&0===b.hhea.data[11]&&(b.hhea.data[10]=255,b.hhea.data[11]=255);const P={unitsPerEm:int16(b.head.data[18],b.head.data[19]),yMax:int16(b.head.data[42],b.head.data[43]),yMin:signedInt16(b.head.data[38],b.head.data[39]),ascent:signedInt16(b.hhea.data[4],b.hhea.data[5]),descent:signedInt16(b.hhea.data[6],b.hhea.data[7]),lineGap:signedInt16(b.hhea.data[8],b.hhea.data[9])};this.ascent=P.ascent/P.unitsPerEm,this.descent=P.descent/P.unitsPerEm,this.lineGap=P.lineGap/P.unitsPerEm,this.cssFontInfo&&this.cssFontInfo.lineHeight?(this.lineHeight=this.cssFontInfo.metrics.lineHeight,this.lineGap=this.cssFontInfo.metrics.lineGap):this.lineHeight=this.ascent-this.descent+this.lineGap,b.post&&u(b.post,n,w),b.post={tag:"post",data:createPostTable(n)};const G=[];function N(t){return!v[t]}if(n.composite){const t=n.cidToGidMap||[],e=0===t.length;n.cMap.forEach((function(n,i){if("string"===typeof i&&(i=convertCidString(n,i,!0)),i>65535)throw new _util.FormatError("Max size of CID is 65,535");let o=-1;e?o=i:void 0!==t[i]&&(o=t[i]),o>=0&&o<w&&N(o)&&(G[n]=o)}))}else{const t=c(b.cmap,e,this.isSymbolicFont,n.hasEncoding),i=t.platformId,o=t.encodingId,s=t.mappings,a=s.length;let r=[],l=!1;if(!n.hasEncoding||"MacRomanEncoding"!==n.baseEncodingName&&"WinAnsiEncoding"!==n.baseEncodingName||(r=(0,_encodings.getEncoding)(n.baseEncodingName)),n.hasEncoding&&!this.isSymbolicFont&&(3===i&&1===o||1===i&&0===o)){const t=(0,_glyphlist.getGlyphsUnicode)();for(let e=0;e<256;e++){let l;if(l=void 0!==this.differences[e]?this.differences[e]:r.length&&""!==r[e]?r[e]:_encodings.StandardEncoding[e],!l)continue;const c=(0,_fonts_utils.recoverGlyphName)(l,t);let d;if(3===i&&1===o?d=t[c]:1===i&&0===o&&(d=_encodings.MacRomanEncoding.indexOf(c)),void 0===d){if(!n.glyphNames&&n.hasIncludedToUnicodeMap&&!(this.toUnicode instanceof _to_unicode_map.IdentityToUnicodeMap)){const t=this.toUnicode.get(e);t&&(d=t.codePointAt(0))}if(void 0===d)continue}for(let t=0;t<a;++t)if(s[t].charCode===d){G[e]=s[t].glyphId;break}}}else if(0===i){for(let t=0;t<a;++t)G[s[t].charCode]=s[t].glyphId;l=!0}else for(let e=0;e<a;++e){let t=s[e].charCode;3===i&&t>=61440&&t<=61695&&(t&=255),G[t]=s[e].glyphId}if(n.glyphNames&&(r.length||this.differences.length))for(let e=0;e<256;++e){if(!l&&void 0!==G[e])continue;const t=this.differences[e]||r[e];if(!t)continue;const i=n.glyphNames.indexOf(t);i>0&&N(i)&&(G[e]=i)}}0===G.length&&(G[0]=0);let D=M-1;if(A||(D=0),!n.cssFontInfo){const t=adjustMapping(G,N,D);this.toFontChar=t.toFontChar,b.cmap={tag:"cmap",data:createCmapTable(t.charCodeToGlyphId,M)},b["OS/2"]&&validateOS2Table(b["OS/2"],e)||(b["OS/2"]={tag:"OS/2",data:createOS2Table(n,t.charCodeToGlyphId,P)})}if(!U)try{I=new _stream.Stream(b["CFF "].data);const t=new _cff_parser.CFFParser(I,n,_fonts_utils.SEAC_ANALYSIS_ENABLED);S=t.parse(),S.duplicateFirstGlyph();const e=new _cff_parser.CFFCompiler(S);b["CFF "].data=e.compile()}catch(j){(0,_util.warn)("Failed to compile font "+n.loadedName)}if(b.name){const e=g(b.name);b.name.data=createNameTable(t,e),this.psName=e[0][6]||null}else b.name={tag:"name",data:createNameTable(this.name)};const R=new _opentype_file_builder.OpenTypeFileBuilder(C.version);for(const L in b)R.addTable(L,b[L].data);return R.toArray()}convert(t,e,n){n.fixedPitch=!1,n.builtInEncoding&&adjustToUnicode(n,n.builtInEncoding);let i=1;e instanceof _cff_font.CFFFont&&(i=e.numGlyphs-1);const o=e.getGlyphMapping(n);let s=null,a=o;n.cssFontInfo||(s=adjustMapping(o,e.hasGlyphId.bind(e),i),this.toFontChar=s.toFontChar,a=s.charCodeToGlyphId);const r=e.numGlyphs;function l(t,e){let n=null;for(const i in t)e===t[i]&&(n||(n=[]),n.push(0|i));return n}function c(t,e){for(const n in t)if(e===t[n])return 0|n;return s.charCodeToGlyphId[s.nextAvailableFontCharCode]=e,s.nextAvailableFontCharCode++}const d=e.seacs;if(s&&_fonts_utils.SEAC_ANALYSIS_ENABLED&&d&&d.length){const t=n.fontMatrix||_util.FONT_IDENTITY_MATRIX,i=e.getCharset(),a=Object.create(null);for(let e in d){e|=0;const n=d[e],r=_encodings.StandardEncoding[n[2]],h=_encodings.StandardEncoding[n[3]],f=i.indexOf(r),p=i.indexOf(h);if(f<0||p<0)continue;const u={x:n[0]*t[0]+n[1]*t[2]+t[4],y:n[0]*t[1]+n[1]*t[3]+t[5]},g=l(o,e);if(g)for(let t=0,e=g.length;t<e;t++){const e=g[t],n=s.charCodeToGlyphId,i=c(n,f),o=c(n,p);a[e]={baseFontCharCode:i,accentFontCharCode:o,accentOffset:u}}}n.seacMap=a}const h=1/(n.fontMatrix||_util.FONT_IDENTITY_MATRIX)[0],f=new _opentype_file_builder.OpenTypeFileBuilder("OTTO");return f.addTable("CFF ",e.data),f.addTable("OS/2",createOS2Table(n,a)),f.addTable("cmap",createCmapTable(a,r)),f.addTable("head","\0\x01\0\0\0\0\x10\0\0\0\0\0_\x0f<\xf5\0\0"+safeString16(h)+"\0\0\0\0\x9e\v~'\0\0\0\0\x9e\v~'\0\0"+safeString16(n.descent)+"\x0f\xff"+safeString16(n.ascent)+string16(n.italicAngle?2:0)+"\0\x11\0\0\0\0\0\0"),f.addTable("hhea","\0\x01\0\0"+safeString16(n.ascent)+safeString16(n.descent)+"\0\0\xff\xff\0\0\0\0\0\0"+safeString16(n.capHeight)+safeString16(Math.tan(n.italicAngle)*n.xHeight)+"\0\0\0\0\0\0\0\0\0\0\0\0"+string16(r)),f.addTable("hmtx",function(){const t=e.charstrings,n=e.cff?e.cff.widths:null;let i="\0\0\0\0";for(let e=1,o=r;e<o;e++){let o=0;if(t){const n=t[e-1];o="width"in n?n.width:0}else n&&(o=Math.ceil(n[e]||0));i+=string16(o)+string16(0)}return i}()),f.addTable("maxp","\0\0P\0"+string16(r)),f.addTable("name",createNameTable(t)),f.addTable("post",createPostTable(n)),f.toArray()}get spaceWidth(){const t=["space","minus","one","i","I"];let e;for(let n=0,i=t.length;n<i;n++){const i=t[n];if(i in this.widths){e=this.widths[i];break}const o=(0,_glyphlist.getGlyphsUnicode)(),s=o[i];let a=0;if(this.composite&&this.cMap.contains(s)&&(a=this.cMap.lookup(s),"string"===typeof a&&(a=convertCidString(s,a))),!a&&this.toUnicode&&(a=this.toUnicode.charCodeOf(s)),a<=0&&(a=s),e=this.widths[a],e)break}return e=e||this.defaultWidth,(0,_util.shadow)(this,"spaceWidth",e)}_charToGlyph(t,e=!1){let n,i,o,s=t;this.cMap&&this.cMap.contains(t)&&(s=this.cMap.lookup(t),"string"===typeof s&&(s=convertCidString(t,s))),i=this.widths[s],i=(0,_util.isNum)(i)?i:this.defaultWidth;const a=this.vmetrics&&this.vmetrics[s];let r=this.toUnicode.get(t)||t;"number"===typeof r&&(r=String.fromCharCode(r));let l=void 0!==this.toFontChar[t];if(n=this.toFontChar[t]||t,this.missingFile){const e=this.differences[t]||this.defaultEncoding[t];".notdef"!==e&&""!==e||"Type1"!==this.type||(n=32),n=(0,_unicode.mapSpecialUnicodeValues)(n)}this.isType3Font&&(o=n);let c=null;if(this.seacMap&&this.seacMap[t]){l=!0;const e=this.seacMap[t];n=e.baseFontCharCode,c={fontChar:String.fromCodePoint(e.accentFontCharCode),offset:e.accentOffset}}let d="";"number"===typeof n&&(n<=1114111?d=String.fromCodePoint(n):(0,_util.warn)(`charToGlyph - invalid fontCharCode: ${n}`));let h=this._glyphCache[t];return h&&h.matchesForCache(t,d,r,c,i,a,o,e,l)||(h=new Glyph(t,d,r,c,i,a,o,e,l),this._glyphCache[t]=h),h}charsToGlyphs(t){let e=this._charsCache[t];if(e)return e;if(e=[],this.cMap){const n=Object.create(null),i=t.length;let o=0;while(o<i){this.cMap.readCharCode(t,o,n);const{charcode:i,length:s}=n;o+=s;const a=this._charToGlyph(i,1===s&&32===t.charCodeAt(o-1));e.push(a)}}else for(let n=0,i=t.length;n<i;++n){const i=t.charCodeAt(n),o=this._charToGlyph(i,32===i);e.push(o)}return this._charsCache[t]=e}getCharPositions(t){const e=[];if(this.cMap){const n=Object.create(null);let i=0;while(i<t.length){this.cMap.readCharCode(t,i,n);const o=n.length;e.push([i,i+o]),i+=o}}else for(let n=0,i=t.length;n<i;++n)e.push([n,n+1]);return e}get glyphCacheValues(){return Object.values(this._glyphCache)}encodeString(t){const e=[],n=[],i=()=>e.length%2===1,o=this.toUnicode instanceof _to_unicode_map.IdentityToUnicodeMap?t=>this.toUnicode.charCodeOf(t):t=>this.toUnicode.charCodeOf(String.fromCodePoint(t));for(let s=0,a=t.length;s<a;s++){const a=t.codePointAt(s);if(a>55295&&(a<57344||a>65533)&&s++,this.toUnicode){const t=o(a);if(-1!==t){i()&&(e.push(n.join("")),n.length=0);const o=this.cMap?this.cMap.getCharCodeLength(t):1;for(let e=o-1;e>=0;e--)n.push(String.fromCharCode(t>>8*e&255));continue}}i()||(e.push(n.join("")),n.length=0),n.push(String.fromCodePoint(a))}return e.push(n.join("")),e}}exports.Font=Font;class ErrorFont{constructor(t){this.error=t,this.loadedName="g_font_error",this.missingFile=!0}charsToGlyphs(){return[]}encodeString(t){return[t]}exportData(t=!1){return{error:this.error}}}exports.ErrorFont=ErrorFont;