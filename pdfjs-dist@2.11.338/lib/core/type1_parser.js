"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Type1Parser=void 0;var _encodings=require("./encodings.js"),_core_utils=require("./core_utils.js"),_stream=require("./stream.js"),_util=require("../shared/util.js");const HINTING_ENABLED=!1,Type1CharString=function(){const e={hstem:[1],vstem:[3],vmoveto:[4],rlineto:[5],hlineto:[6],vlineto:[7],rrcurveto:[8],callsubr:[10],flex:[12,35],drop:[12,18],endchar:[14],rmoveto:[21],hmoveto:[22],vhcurveto:[30],hvcurveto:[31]};class t{constructor(){this.width=0,this.lsb=0,this.flexing=!1,this.output=[],this.stack=[]}convert(t,s,a){const r=t.length;let i,n,h,c=!1;for(let o=0;o<r;o++){let r=t[o];if(r<32){switch(12===r&&(r=(r<<8)+t[++o]),r){case 1:if(!HINTING_ENABLED){this.stack=[];break}c=this.executeCommand(2,e.hstem);break;case 3:if(!HINTING_ENABLED){this.stack=[];break}c=this.executeCommand(2,e.vstem);break;case 4:if(this.flexing){if(this.stack.length<1){c=!0;break}const e=this.stack.pop();this.stack.push(0,e);break}c=this.executeCommand(1,e.vmoveto);break;case 5:c=this.executeCommand(2,e.rlineto);break;case 6:c=this.executeCommand(1,e.hlineto);break;case 7:c=this.executeCommand(1,e.vlineto);break;case 8:c=this.executeCommand(6,e.rrcurveto);break;case 9:this.stack=[];break;case 10:if(this.stack.length<1){c=!0;break}if(h=this.stack.pop(),!s[h]){c=!0;break}c=this.convert(s[h],s,a);break;case 11:return c;case 13:if(this.stack.length<2){c=!0;break}i=this.stack.pop(),n=this.stack.pop(),this.lsb=n,this.width=i,this.stack.push(i,n),c=this.executeCommand(2,e.hmoveto);break;case 14:this.output.push(e.endchar[0]);break;case 21:if(this.flexing)break;c=this.executeCommand(2,e.rmoveto);break;case 22:if(this.flexing){this.stack.push(0);break}c=this.executeCommand(1,e.hmoveto);break;case 30:c=this.executeCommand(4,e.vhcurveto);break;case 31:c=this.executeCommand(4,e.hvcurveto);break;case 3072:this.stack=[];break;case 3073:if(!HINTING_ENABLED){this.stack=[];break}c=this.executeCommand(2,e.vstem);break;case 3074:if(!HINTING_ENABLED){this.stack=[];break}c=this.executeCommand(2,e.hstem);break;case 3078:if(a){const t=this.stack[this.stack.length-5];this.seac=this.stack.splice(-4,4),this.seac[0]+=this.lsb-t,c=this.executeCommand(0,e.endchar)}else c=this.executeCommand(4,e.endchar);break;case 3079:if(this.stack.length<4){c=!0;break}this.stack.pop(),i=this.stack.pop();const t=this.stack.pop();n=this.stack.pop(),this.lsb=n,this.width=i,this.stack.push(i,n,t),c=this.executeCommand(3,e.rmoveto);break;case 3084:if(this.stack.length<2){c=!0;break}const o=this.stack.pop(),u=this.stack.pop();this.stack.push(u/o);break;case 3088:if(this.stack.length<2){c=!0;break}h=this.stack.pop();const l=this.stack.pop();if(0===h&&3===l){const t=this.stack.splice(this.stack.length-17,17);this.stack.push(t[2]+t[0],t[3]+t[1],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14]),c=this.executeCommand(13,e.flex,!0),this.flexing=!1,this.stack.push(t[15],t[16])}else 1===h&&0===l&&(this.flexing=!0);break;case 3089:break;case 3105:this.stack=[];break;default:(0,_util.warn)('Unknown type 1 charstring command of "'+r+'"');break}if(c)break}else r<=246?r-=139:r=r<=250?256*(r-247)+t[++o]+108:r<=254?-256*(r-251)-t[++o]-108:(255&t[++o])<<24|(255&t[++o])<<16|(255&t[++o])<<8|(255&t[++o])<<0,this.stack.push(r)}return c}executeCommand(e,t,s){const a=this.stack.length;if(e>a)return!0;const r=a-e;for(let i=r;i<a;i++){let e=this.stack[i];Number.isInteger(e)?this.output.push(28,e>>8&255,255&e):(e=65536*e|0,this.output.push(255,e>>24&255,e>>16&255,e>>8&255,255&e))}return this.output.push.apply(this.output,t),s?this.stack.splice(r,e):this.stack.length=0,!1}}return t}(),Type1Parser=function(){const e=55665,t=4330;function s(e){return e>=48&&e<=57||e>=65&&e<=70||e>=97&&e<=102}function a(e,t,s){if(s>=e.length)return new Uint8Array(0);const a=52845,r=22719;let i,n,h=0|t;for(i=0;i<s;i++)h=(e[i]+h)*a+r&65535;const c=e.length-s,o=new Uint8Array(c);for(i=s,n=0;n<c;i++,n++){const t=e[i];o[n]=t^h>>8,h=(t+h)*a+r&65535}return o}function r(e,t,a){const r=52845,i=22719;let n=0|t;const h=e.length,c=h>>>1,o=new Uint8Array(c);let u,l;for(u=0,l=0;u<h;u++){const t=e[u];if(!s(t))continue;let a;u++;while(u<h&&!s(a=e[u]))u++;if(u<h){const e=parseInt(String.fromCharCode(t,a),16);o[l++]=e^n>>8,n=(e+n)*r+i&65535}}return o.slice(a,l)}function i(e){return 47===e||91===e||93===e||123===e||125===e||40===e||41===e}class n{constructor(t,i,n){if(i){const i=t.getBytes(),n=!((s(i[0])||(0,_core_utils.isWhiteSpace)(i[0]))&&s(i[1])&&s(i[2])&&s(i[3])&&s(i[4])&&s(i[5])&&s(i[6])&&s(i[7]));t=new _stream.Stream(n?a(i,e,4):r(i,e,4))}this.seacAnalysisEnabled=!!n,this.stream=t,this.nextChar()}readNumberArray(){this.getToken();const e=[];while(1){const t=this.getToken();if(null===t||"]"===t||"}"===t)break;e.push(parseFloat(t||0))}return e}readNumber(){const e=this.getToken();return parseFloat(e||0)}readInt(){const e=this.getToken();return 0|parseInt(e||0,10)}readBoolean(){const e=this.getToken();return"true"===e?1:0}nextChar(){return this.currentChar=this.stream.getByte()}getToken(){let e=!1,t=this.currentChar;while(1){if(-1===t)return null;if(e)10!==t&&13!==t||(e=!1);else if(37===t)e=!0;else if(!(0,_core_utils.isWhiteSpace)(t))break;t=this.nextChar()}if(i(t))return this.nextChar(),String.fromCharCode(t);let s="";do{s+=String.fromCharCode(t),t=this.nextChar()}while(t>=0&&!(0,_core_utils.isWhiteSpace)(t)&&!i(t));return s}readCharStrings(e,s){return-1===s?e:a(e,t,s)}extractFontProgram(e){const t=this.stream,s=[],a=[],r=Object.create(null);r.lenIV=4;const i={subrs:[],charstrings:[],properties:{privateData:r}};let n,h,c,o,u;while(null!==(n=this.getToken()))if("/"===n)switch(n=this.getToken(),n){case"CharStrings":this.getToken(),this.getToken(),this.getToken(),this.getToken();while(1){if(n=this.getToken(),null===n||"end"===n)break;if("/"!==n)continue;const e=this.getToken();h=this.readInt(),this.getToken(),c=h>0?t.getBytes(h):new Uint8Array(0),o=i.properties.privateData.lenIV,u=this.readCharStrings(c,o),this.nextChar(),n=this.getToken(),"noaccess"===n&&this.getToken(),a.push({glyph:e,encoded:u})}break;case"Subrs":this.readInt(),this.getToken();while("dup"===this.getToken()){const e=this.readInt();h=this.readInt(),this.getToken(),c=h>0?t.getBytes(h):new Uint8Array(0),o=i.properties.privateData.lenIV,u=this.readCharStrings(c,o),this.nextChar(),n=this.getToken(),"noaccess"===n&&this.getToken(),s[e]=u}break;case"BlueValues":case"OtherBlues":case"FamilyBlues":case"FamilyOtherBlues":const e=this.readNumberArray();e.length>0&&e.length%2===0&&HINTING_ENABLED&&(i.properties.privateData[n]=e);break;case"StemSnapH":case"StemSnapV":i.properties.privateData[n]=this.readNumberArray();break;case"StdHW":case"StdVW":i.properties.privateData[n]=this.readNumberArray()[0];break;case"BlueShift":case"lenIV":case"BlueFuzz":case"BlueScale":case"LanguageGroup":case"ExpansionFactor":i.properties.privateData[n]=this.readNumber();break;case"ForceBold":i.properties.privateData[n]=this.readBoolean();break}for(let l=0;l<a.length;l++){const t=a[l].glyph;u=a[l].encoded;const r=new Type1CharString,n=r.convert(u,s,this.seacAnalysisEnabled);let h=r.output;n&&(h=[14]);const c={glyphName:t,charstring:h,width:r.width,lsb:r.lsb,seac:r.seac};if(".notdef"===t?i.charstrings.unshift(c):i.charstrings.push(c),e.builtInEncoding){const s=e.builtInEncoding.indexOf(t);s>-1&&void 0===e.widths[s]&&s>=e.firstChar&&s<=e.lastChar&&(e.widths[s]=r.width)}}return i}extractFontHeader(e){let t;while(null!==(t=this.getToken()))if("/"===t)switch(t=this.getToken(),t){case"FontMatrix":const s=this.readNumberArray();e.fontMatrix=s;break;case"Encoding":const a=this.getToken();let r;if(/^\d+$/.test(a)){r=[];const e=0|parseInt(a,10);this.getToken();for(let s=0;s<e;s++){t=this.getToken();while("dup"!==t&&"def"!==t)if(t=this.getToken(),null===t)return;if("def"===t)break;const e=this.readInt();this.getToken();const s=this.getToken();r[e]=s,this.getToken()}}else r=(0,_encodings.getEncoding)(a);e.builtInEncoding=r;break;case"FontBBox":const i=this.readNumberArray();e.ascent=Math.max(i[3],i[1]),e.descent=Math.min(i[1],i[3]),e.ascentScaled=!0;break}}}return n}();exports.Type1Parser=Type1Parser;