"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getQuadPoints=getQuadPoints,exports.MarkupAnnotation=exports.AnnotationFactory=exports.AnnotationBorderStyle=exports.Annotation=void 0;var _util=require("../shared/util.js"),_core_utils=require("./core_utils.js"),_default_appearance=require("./default_appearance.js"),_primitives=require("./primitives.js"),_bidi=require("./bidi.js"),_catalog=require("./catalog.js"),_colorspace=require("./colorspace.js"),_file_spec=require("./file_spec.js"),_object_loader=require("./object_loader.js"),_operator_list=require("./operator_list.js"),_stream=require("./stream.js"),_writer=require("./writer.js");class AnnotationFactory{static create(t,e,i,a,n){return Promise.all([i.ensureCatalog("acroForm"),n?this._getPageIndex(t,e,i):-1]).then((([s,r])=>i.ensure(this,"_create",[t,e,i,a,s,n,r])))}static _create(t,e,i,a,n,s,r=-1){const o=t.fetchIfRef(e);if(!(0,_primitives.isDict)(o))return;const l=(0,_primitives.isRef)(e)?e.toString():`annot_${a.createObjId()}`;let c=o.get("Subtype");c=(0,_primitives.isName)(c)?c.name:null;const h={xref:t,ref:e,dict:o,subtype:c,id:l,pdfManager:i,acroForm:n instanceof _primitives.Dict?n:_primitives.Dict.empty,collectFields:s,pageIndex:r};switch(c){case"Link":return new LinkAnnotation(h);case"Text":return new TextAnnotation(h);case"Widget":let t=(0,_core_utils.getInheritableProperty)({dict:o,key:"FT"});switch(t=(0,_primitives.isName)(t)?t.name:null,t){case"Tx":return new TextWidgetAnnotation(h);case"Btn":return new ButtonWidgetAnnotation(h);case"Ch":return new ChoiceWidgetAnnotation(h);case"Sig":return new SignatureWidgetAnnotation(h)}return(0,_util.warn)(`Unimplemented widget field type "${t}", falling back to base field type.`),new WidgetAnnotation(h);case"Popup":return new PopupAnnotation(h);case"FreeText":return new FreeTextAnnotation(h);case"Line":return new LineAnnotation(h);case"Square":return new SquareAnnotation(h);case"Circle":return new CircleAnnotation(h);case"PolyLine":return new PolylineAnnotation(h);case"Polygon":return new PolygonAnnotation(h);case"Caret":return new CaretAnnotation(h);case"Ink":return new InkAnnotation(h);case"Highlight":return new HighlightAnnotation(h);case"Underline":return new UnderlineAnnotation(h);case"Squiggly":return new SquigglyAnnotation(h);case"StrikeOut":return new StrikeOutAnnotation(h);case"Stamp":return new StampAnnotation(h);case"FileAttachment":return new FileAttachmentAnnotation(h);default:return s||(c?(0,_util.warn)(`Unimplemented annotation type "${c}", falling back to base annotation.`):(0,_util.warn)("Annotation is missing the required /Subtype.")),new Annotation(h)}}static async _getPageIndex(t,e,i){try{const a=await t.fetchIfRefAsync(e);if(!(0,_primitives.isDict)(a))return-1;const n=a.getRaw("P");if(!(0,_primitives.isRef)(n))return-1;const s=await i.ensureCatalog("getPageIndex",[n]);return s}catch(a){return(0,_util.warn)(`_getPageIndex: "${a}".`),-1}}}function getRgbColor(t,e=new Uint8ClampedArray(3)){if(!Array.isArray(t))return e;const i=e||new Uint8ClampedArray(3);switch(t.length){case 0:return null;case 1:return _colorspace.ColorSpace.singletons.gray.getRgbItem(t,0,i,0),i;case 3:return _colorspace.ColorSpace.singletons.rgb.getRgbItem(t,0,i,0),i;case 4:return _colorspace.ColorSpace.singletons.cmyk.getRgbItem(t,0,i,0),i;default:return e}}function getQuadPoints(t,e){if(!t.has("QuadPoints"))return null;const i=t.getArray("QuadPoints");if(!Array.isArray(i)||0===i.length||i.length%8>0)return null;const a=[];for(let n=0,s=i.length/8;n<s;n++){a.push([]);for(let t=8*n,s=8*n+8;t<s;t+=2){const s=i[t],r=i[t+1];if(null!==e&&(s<e[0]||s>e[2]||r<e[1]||r>e[3]))return null;a[n].push({x:s,y:r})}}return a.map((t=>{const[e,i,a,n]=t.reduce((([t,e,i,a],n)=>[Math.min(t,n.x),Math.max(e,n.x),Math.min(i,n.y),Math.max(a,n.y)]),[Number.MAX_VALUE,Number.MIN_VALUE,Number.MAX_VALUE,Number.MIN_VALUE]);return[{x:e,y:n},{x:i,y:n},{x:e,y:a},{x:i,y:a}]}))}function getTransformMatrix(t,e,i){const[a,n,s,r]=_util.Util.getAxialAlignedBoundingBox(e,i);if(a===s||n===r)return[1,0,0,1,t[0],t[1]];const o=(t[2]-t[0])/(s-a),l=(t[3]-t[1])/(r-n);return[o,0,0,l,t[0]-a*o,t[1]-n*l]}exports.AnnotationFactory=AnnotationFactory;class Annotation{constructor(t){const e=t.dict;if(this.setTitle(e.get("T")),this.setContents(e.get("Contents")),this.setModificationDate(e.get("M")),this.setFlags(e.get("F")),this.setRectangle(e.getArray("Rect")),this.setColor(e.getArray("C")),this.setBorderStyle(e),this.setAppearance(e),this.setBorderAndBackgroundColors(e.get("MK")),this._streams=[],this.appearance&&this._streams.push(this.appearance),this.data={annotationFlags:this.flags,borderStyle:this.borderStyle,color:this.color,backgroundColor:this.backgroundColor,borderColor:this.borderColor,contentsObj:this._contents,hasAppearance:!!this.appearance,id:t.id,modificationDate:this.modificationDate,rect:this.rectangle,subtype:t.subtype},t.collectFields){const i=e.get("Kids");if(Array.isArray(i)){const t=[];for(const e of i)(0,_primitives.isRef)(e)&&t.push(e.toString());0!==t.length&&(this.data.kidIds=t)}this.data.actions=(0,_core_utils.collectActions)(t.xref,e,_util.AnnotationActionEventType),this.data.fieldName=this._constructFieldName(e),this.data.pageIndex=t.pageIndex}this._fallbackFontDict=null}_hasFlag(t,e){return!!(t&e)}_isViewable(t){return!this._hasFlag(t,_util.AnnotationFlag.INVISIBLE)&&!this._hasFlag(t,_util.AnnotationFlag.NOVIEW)}_isPrintable(t){return this._hasFlag(t,_util.AnnotationFlag.PRINT)&&!this._hasFlag(t,_util.AnnotationFlag.INVISIBLE)}mustBeViewed(t){const e=t&&t.get(this.data.id);return e&&void 0!==e.hidden?!e.hidden:this.viewable&&!this._hasFlag(this.flags,_util.AnnotationFlag.HIDDEN)}mustBePrinted(t){const e=t&&t.get(this.data.id);return e&&void 0!==e.print?e.print:this.printable}get viewable(){return null!==this.data.quadPoints&&(0===this.flags||this._isViewable(this.flags))}get printable(){return null!==this.data.quadPoints&&(0!==this.flags&&this._isPrintable(this.flags))}_parseStringHelper(t){const e="string"===typeof t?(0,_util.stringToPDFString)(t):"",i=e&&"rtl"===(0,_bidi.bidi)(e).dir?"rtl":"ltr";return{str:e,dir:i}}setTitle(t){this._title=this._parseStringHelper(t)}setContents(t){this._contents=this._parseStringHelper(t)}setModificationDate(t){this.modificationDate=(0,_util.isString)(t)?t:null}setFlags(t){this.flags=Number.isInteger(t)&&t>0?t:0}hasFlag(t){return this._hasFlag(this.flags,t)}setRectangle(t){Array.isArray(t)&&4===t.length?this.rectangle=_util.Util.normalizeRect(t):this.rectangle=[0,0,0,0]}setColor(t){this.color=getRgbColor(t)}setBorderAndBackgroundColors(t){t instanceof _primitives.Dict?(this.borderColor=getRgbColor(t.getArray("BC"),null),this.backgroundColor=getRgbColor(t.getArray("BG"),null)):this.borderColor=this.backgroundColor=null}setBorderStyle(t){if(this.borderStyle=new AnnotationBorderStyle,(0,_primitives.isDict)(t))if(t.has("BS")){const e=t.get("BS"),i=e.get("Type");i&&!(0,_primitives.isName)(i,"Border")||(this.borderStyle.setWidth(e.get("W"),this.rectangle),this.borderStyle.setStyle(e.get("S")),this.borderStyle.setDashArray(e.getArray("D")))}else if(t.has("Border")){const e=t.getArray("Border");Array.isArray(e)&&e.length>=3&&(this.borderStyle.setHorizontalCornerRadius(e[0]),this.borderStyle.setVerticalCornerRadius(e[1]),this.borderStyle.setWidth(e[2],this.rectangle),4===e.length&&this.borderStyle.setDashArray(e[3]))}else this.borderStyle.setWidth(0)}setAppearance(t){this.appearance=null;const e=t.get("AP");if(!(0,_primitives.isDict)(e))return;const i=e.get("N");if((0,_primitives.isStream)(i))return void(this.appearance=i);if(!(0,_primitives.isDict)(i))return;const a=t.get("AS");(0,_primitives.isName)(a)&&i.has(a.name)&&(this.appearance=i.get(a.name))}loadResources(t){return this.appearance.dict.getAsync("Resources").then((e=>{if(!e)return;const i=new _object_loader.ObjectLoader(e,t,e.xref);return i.load().then((function(){return e}))}))}getOperatorList(t,e,i,a){if(!this.appearance)return Promise.resolve(new _operator_list.OperatorList);const n=this.appearance,s=this.data,r=n.dict,o=this.loadResources(["ExtGState","ColorSpace","Pattern","Shading","XObject","Font"]),l=r.getArray("BBox")||[0,0,1,1],c=r.getArray("Matrix")||[1,0,0,1,0,0],h=getTransformMatrix(s.rect,l,c);return o.then((i=>{const a=new _operator_list.OperatorList;return a.addOp(_util.OPS.beginAnnotation,[s.id,s.rect,h,c]),t.getOperatorList({stream:n,task:e,resources:i,operatorList:a,fallbackFontDict:this._fallbackFontDict}).then((()=>(a.addOp(_util.OPS.endAnnotation,[]),this.reset(),a)))}))}async save(t,e,i){return null}getFieldObject(){return this.data.kidIds?{id:this.data.id,actions:this.data.actions,name:this.data.fieldName,strokeColor:this.data.borderColor,fillColor:this.data.backgroundColor,type:"",kidIds:this.data.kidIds,page:this.data.pageIndex}:null}reset(){for(const t of this._streams)t.reset()}_constructFieldName(t){if(!t.has("T")&&!t.has("Parent"))return(0,_util.warn)("Unknown field name, falling back to empty field name."),"";if(!t.has("Parent"))return(0,_util.stringToPDFString)(t.get("T"));const e=[];t.has("T")&&e.unshift((0,_util.stringToPDFString)(t.get("T")));let i=t;const a=new _primitives.RefSet;t.objId&&a.put(t.objId);while(i.has("Parent")){if(i=i.get("Parent"),!(i instanceof _primitives.Dict)||i.objId&&a.has(i.objId))break;i.objId&&a.put(i.objId),i.has("T")&&e.unshift((0,_util.stringToPDFString)(i.get("T")))}return e.join(".")}}exports.Annotation=Annotation;class AnnotationBorderStyle{constructor(){this.width=1,this.style=_util.AnnotationBorderStyleType.SOLID,this.dashArray=[3],this.horizontalCornerRadius=0,this.verticalCornerRadius=0}setWidth(t,e=[0,0,0,0]){if((0,_primitives.isName)(t))this.width=0;else if(Number.isInteger(t)){if(t>0){const i=(e[2]-e[0])/2,a=(e[3]-e[1])/2;i>0&&a>0&&(t>i||t>a)&&((0,_util.warn)(`AnnotationBorderStyle.setWidth - ignoring width: ${t}`),t=1)}this.width=t}}setStyle(t){if((0,_primitives.isName)(t))switch(t.name){case"S":this.style=_util.AnnotationBorderStyleType.SOLID;break;case"D":this.style=_util.AnnotationBorderStyleType.DASHED;break;case"B":this.style=_util.AnnotationBorderStyleType.BEVELED;break;case"I":this.style=_util.AnnotationBorderStyleType.INSET;break;case"U":this.style=_util.AnnotationBorderStyleType.UNDERLINE;break;default:break}}setDashArray(t){if(Array.isArray(t)&&t.length>0){let e=!0,i=!0;for(const a of t){const t=+a>=0;if(!t){e=!1;break}a>0&&(i=!1)}e&&!i?this.dashArray=t:this.width=0}else t&&(this.width=0)}setHorizontalCornerRadius(t){Number.isInteger(t)&&(this.horizontalCornerRadius=t)}setVerticalCornerRadius(t){Number.isInteger(t)&&(this.verticalCornerRadius=t)}}exports.AnnotationBorderStyle=AnnotationBorderStyle;class MarkupAnnotation extends Annotation{constructor(t){super(t);const e=t.dict;if(e.has("IRT")){const t=e.getRaw("IRT");this.data.inReplyTo=(0,_primitives.isRef)(t)?t.toString():null;const i=e.get("RT");this.data.replyType=(0,_primitives.isName)(i)?i.name:_util.AnnotationReplyType.REPLY}if(this.data.replyType===_util.AnnotationReplyType.GROUP){const t=e.get("IRT");this.setTitle(t.get("T")),this.data.titleObj=this._title,this.setContents(t.get("Contents")),this.data.contentsObj=this._contents,t.has("CreationDate")?(this.setCreationDate(t.get("CreationDate")),this.data.creationDate=this.creationDate):this.data.creationDate=null,t.has("M")?(this.setModificationDate(t.get("M")),this.data.modificationDate=this.modificationDate):this.data.modificationDate=null,this.data.hasPopup=t.has("Popup"),t.has("C")?(this.setColor(t.getArray("C")),this.data.color=this.color):this.data.color=null}else this.data.titleObj=this._title,this.setCreationDate(e.get("CreationDate")),this.data.creationDate=this.creationDate,this.data.hasPopup=e.has("Popup"),e.has("C")||(this.data.color=null)}setCreationDate(t){this.creationDate=(0,_util.isString)(t)?t:null}_setDefaultAppearance({xref:t,extra:e,strokeColor:i,fillColor:a,blendMode:n,strokeAlpha:s,fillAlpha:r,pointsCallback:o}){let l=Number.MAX_VALUE,c=Number.MAX_VALUE,h=Number.MIN_VALUE,d=Number.MIN_VALUE;const u=["q"];e&&u.push(e),i&&u.push(`${i[0]} ${i[1]} ${i[2]} RG`),a&&u.push(`${a[0]} ${a[1]} ${a[2]} rg`);let p=this.data.quadPoints;p||(p=[[{x:this.rectangle[0],y:this.rectangle[3]},{x:this.rectangle[2],y:this.rectangle[3]},{x:this.rectangle[0],y:this.rectangle[1]},{x:this.rectangle[2],y:this.rectangle[1]}]]);for(const F of p){const[t,e,i,a]=o(u,F);l=Math.min(l,t),h=Math.max(h,e),c=Math.min(c,i),d=Math.max(d,a)}u.push("Q");const g=new _primitives.Dict(t),f=new _primitives.Dict(t);f.set("Subtype",_primitives.Name.get("Form"));const _=new _stream.StringStream(u.join(" "));_.dict=f,g.set("Fm0",_);const A=new _primitives.Dict(t);n&&A.set("BM",_primitives.Name.get(n)),"number"===typeof s&&A.set("CA",s),"number"===typeof r&&A.set("ca",r);const m=new _primitives.Dict(t);m.set("GS0",A);const y=new _primitives.Dict(t);y.set("ExtGState",m),y.set("XObject",g);const x=new _primitives.Dict(t);x.set("Resources",y);const b=this.data.rect=[l,c,h,d];x.set("BBox",b),this.appearance=new _stream.StringStream("/GS0 gs /Fm0 Do"),this.appearance.dict=x,this._streams.push(this.appearance,_)}}exports.MarkupAnnotation=MarkupAnnotation;class WidgetAnnotation extends Annotation{constructor(t){super(t);const e=t.dict,i=this.data;this.ref=t.ref,i.annotationType=_util.AnnotationType.WIDGET,void 0===i.fieldName&&(i.fieldName=this._constructFieldName(e)),void 0===i.actions&&(i.actions=(0,_core_utils.collectActions)(t.xref,e,_util.AnnotationActionEventType));const a=(0,_core_utils.getInheritableProperty)({dict:e,key:"V",getArray:!0});i.fieldValue=this._decodeFormValue(a);const n=(0,_core_utils.getInheritableProperty)({dict:e,key:"DV",getArray:!0});i.defaultFieldValue=this._decodeFormValue(n),void 0===a&&null!==i.defaultFieldValue&&(i.fieldValue=i.defaultFieldValue),i.alternativeText=(0,_util.stringToPDFString)(e.get("TU")||"");const s=(0,_core_utils.getInheritableProperty)({dict:e,key:"DA"})||t.acroForm.get("DA");this._defaultAppearance=(0,_util.isString)(s)?s:"",i.defaultAppearanceData=(0,_default_appearance.parseDefaultAppearance)(this._defaultAppearance);const r=(0,_core_utils.getInheritableProperty)({dict:e,key:"FT"});i.fieldType=(0,_primitives.isName)(r)?r.name:null;const o=(0,_core_utils.getInheritableProperty)({dict:e,key:"DR"}),l=t.acroForm.get("DR"),c=this.appearance&&this.appearance.dict.get("Resources");this._fieldResources={localResources:o,acroFormResources:l,appearanceResources:c,mergedResources:_primitives.Dict.merge({xref:t.xref,dictArray:[o,c,l],mergeSubDicts:!0})},i.fieldFlags=(0,_core_utils.getInheritableProperty)({dict:e,key:"Ff"}),(!Number.isInteger(i.fieldFlags)||i.fieldFlags<0)&&(i.fieldFlags=0),i.readOnly=this.hasFieldFlag(_util.AnnotationFieldFlag.READONLY),i.hidden=this._hasFlag(i.annotationFlags,_util.AnnotationFlag.HIDDEN)}_decodeFormValue(t){return Array.isArray(t)?t.filter((t=>(0,_util.isString)(t))).map((t=>(0,_util.stringToPDFString)(t))):(0,_primitives.isName)(t)?(0,_util.stringToPDFString)(t.name):(0,_util.isString)(t)?(0,_util.stringToPDFString)(t):null}hasFieldFlag(t){return!!(this.data.fieldFlags&t)}getOperatorList(t,e,i,a){return!i||this instanceof SignatureWidgetAnnotation?this._hasText?this._getAppearance(t,e,a).then((n=>{if(this.appearance&&null===n)return super.getOperatorList(t,e,i,a);const s=new _operator_list.OperatorList;if(!this._defaultAppearance||null===n)return s;const r=[1,0,0,1,0,0],o=[0,0,this.data.rect[2]-this.data.rect[0],this.data.rect[3]-this.data.rect[1]],l=getTransformMatrix(this.data.rect,o,r);s.addOp(_util.OPS.beginAnnotation,[this.data.id,this.data.rect,l,r]);const c=new _stream.StringStream(n);return t.getOperatorList({stream:c,task:e,resources:this._fieldResources.mergedResources,operatorList:s}).then((function(){return s.addOp(_util.OPS.endAnnotation,[]),s}))})):super.getOperatorList(t,e,i,a):Promise.resolve(new _operator_list.OperatorList)}async save(t,e,i){if(!i)return null;const a=i.get(this.data.id),n=a&&a.value;if(n===this.data.fieldValue||void 0===n)return null;let s=await this._getAppearance(t,e,i);if(null===s)return null;const{xref:r}=t,o=r.fetchIfRef(this.ref);if(!(0,_primitives.isDict)(o))return null;const l=[0,0,this.data.rect[2]-this.data.rect[0],this.data.rect[3]-this.data.rect[1]],c={path:(0,_util.stringToPDFString)(o.get("T")||""),value:n},h=r.getNewRef(),d=new _primitives.Dict(r);d.set("N",h);const u=r.encrypt;let p=null,g=null;u&&(p=u.createCipherTransform(this.ref.num,this.ref.gen),g=u.createCipherTransform(h.num,h.gen),s=g.encryptString(s)),o.set("V",(0,_util.isAscii)(n)?n:(0,_util.stringToUTF16BEString)(n)),o.set("AP",d),o.set("M",`D:${(0,_util.getModificationDate)()}`);const f=new _primitives.Dict(r);f.set("Length",s.length),f.set("Subtype",_primitives.Name.get("Form")),f.set("Resources",this._getSaveFieldResources(r)),f.set("BBox",l);const _=[`${this.ref.num} ${this.ref.gen} obj\n`];(0,_writer.writeDict)(o,_,p),_.push("\nendobj\n");const A=[`${h.num} ${h.gen} obj\n`];return(0,_writer.writeDict)(f,A,g),A.push(" stream\n",s,"\nendstream\nendobj\n"),[{ref:this.ref,data:_.join(""),xfa:c},{ref:h,data:A.join(""),xfa:null}]}async _getAppearance(t,e,i){const a=this.hasFieldFlag(_util.AnnotationFieldFlag.PASSWORD);if(!i||a)return null;const n=i.get(this.data.id);let s=n&&n.value;if(void 0===s)return null;if(s=s.trim(),""===s)return"";let r=-1;this.data.multiLine&&(r=s.split(/\r\n|\r|\n/).length);const o=2,l=o,c=this.data.rect[3]-this.data.rect[1],h=this.data.rect[2]-this.data.rect[0];this._defaultAppearance||(this.data.defaultAppearanceData=(0,_default_appearance.parseDefaultAppearance)(this._defaultAppearance="/Helvetica 0 Tf 0 g"));const[d,u]=this._computeFontSize(c,r),p=await this._getFontData(t,e);let g=p.descent;isNaN(g)&&(g=0);const f=o+Math.abs(g)*u,_=this.data.textAlignment;if(this.data.multiLine)return this._getMultilineAppearance(d,s,p,u,h,c,_,l,f);const A=p.encodeString(s).join("");if(this.data.comb)return this._getCombAppearance(d,p,A,h,l,f);if(0===_||_>2)return"/Tx BMC q BT "+d+` 1 0 0 1 ${l} ${f} Tm (${(0,_util.escapeString)(A)}) Tj ET Q EMC`;const m=this._renderText(A,p,u,h,_,l,f);return"/Tx BMC q BT "+d+` 1 0 0 1 0 0 Tm ${m} ET Q EMC`}async _getFontData(t,e){const i=new _operator_list.OperatorList,a={font:null,clone(){return this}},{fontName:n,fontSize:s}=this.data.defaultAppearanceData;return await t.handleSetFont(this._fieldResources.mergedResources,[n&&_primitives.Name.get(n),s],null,i,e,a,null),a.font}_computeFontSize(t,e){let{fontSize:i}=this.data.defaultAppearanceData;if(!i){const a=t=>Math.round(10*t)/10,n=.8;if(-1===e)i=a(n*t);else{i=10;let s=i/n,r=Math.round(t/s);r=Math.max(r,e),s=t/r,i=a(n*s)}const{fontName:s,fontColor:r}=this.data.defaultAppearanceData;this._defaultAppearance=(0,_default_appearance.createDefaultAppearance)({fontSize:i,fontName:s,fontColor:r})}return[this._defaultAppearance,i]}_renderText(t,e,i,a,n,s,r){const o=e.charsToGlyphs(t),l=i/1e3;let c,h=0;for(const d of o)h+=d.width*l;return c=1===n?(a-h)/2:2===n?a-h-s:s,c=c.toFixed(2),r=r.toFixed(2),`${c} ${r} Td (${(0,_util.escapeString)(t)}) Tj`}_getSaveFieldResources(t){const{localResources:e,appearanceResources:i,acroFormResources:a}=this._fieldResources,n=this.data.defaultAppearanceData&&this.data.defaultAppearanceData.fontName;if(!n)return e||_primitives.Dict.empty;for(const s of[e,i])if(s instanceof _primitives.Dict){const t=s.get("Font");if(t instanceof _primitives.Dict&&t.has(n))return s}if(a instanceof _primitives.Dict){const i=a.get("Font");if(i instanceof _primitives.Dict&&i.has(n)){const a=new _primitives.Dict(t);a.set(n,i.getRaw(n));const s=new _primitives.Dict(t);return s.set("Font",a),_primitives.Dict.merge({xref:t,dictArray:[s,e],mergeSubDicts:!0})}}return e||_primitives.Dict.empty}getFieldObject(){return null}}class TextWidgetAnnotation extends WidgetAnnotation{constructor(t){super(t),this._hasText=!0;const e=t.dict;(0,_util.isString)(this.data.fieldValue)||(this.data.fieldValue="");let i=(0,_core_utils.getInheritableProperty)({dict:e,key:"Q"});(!Number.isInteger(i)||i<0||i>2)&&(i=null),this.data.textAlignment=i;let a=(0,_core_utils.getInheritableProperty)({dict:e,key:"MaxLen"});(!Number.isInteger(a)||a<0)&&(a=null),this.data.maxLen=a,this.data.multiLine=this.hasFieldFlag(_util.AnnotationFieldFlag.MULTILINE),this.data.comb=this.hasFieldFlag(_util.AnnotationFieldFlag.COMB)&&!this.hasFieldFlag(_util.AnnotationFieldFlag.MULTILINE)&&!this.hasFieldFlag(_util.AnnotationFieldFlag.PASSWORD)&&!this.hasFieldFlag(_util.AnnotationFieldFlag.FILESELECT)&&null!==this.data.maxLen}_getCombAppearance(t,e,i,a,n,s){const r=(a/this.data.maxLen).toFixed(2),o=[],l=e.getCharPositions(i);for(const[h,d]of l)o.push(`(${(0,_util.escapeString)(i.substring(h,d))}) Tj`);const c=o.join(` ${r} 0 Td `);return"/Tx BMC q BT "+t+` 1 0 0 1 ${n} ${s} Tm ${c} ET Q EMC`}_getMultilineAppearance(t,e,i,a,n,s,r,o,l){const c=e.split(/\r\n|\r|\n/),h=[],d=n-2*o;for(const p of c){const t=this._splitLine(p,i,a,d);for(const e of t){const t=0===h.length?o:0;h.push(this._renderText(e,i,a,n,r,t,-a))}}const u=h.join("\n");return"/Tx BMC q BT "+t+` 1 0 0 1 0 ${s} Tm ${u} ET Q EMC`}_splitLine(t,e,i,a){t=e.encodeString(t).join("");const n=e.charsToGlyphs(t);if(n.length<=1)return[t];const s=e.getCharPositions(t),r=i/1e3,o=[];let l=-1,c=-1,h=-1,d=0,u=0;for(let p=0,g=n.length;p<g;p++){const[e,i]=s[p],g=n[p],f=g.width*r;" "===g.unicode?u+f>a?(o.push(t.substring(d,e)),d=e,u=f,l=-1,h=-1):(u+=f,l=e,c=i,h=p):u+f>a?-1!==l?(o.push(t.substring(d,c)),d=c,p=h+1,l=-1,u=0):(o.push(t.substring(d,e)),d=e,u=f):u+=f}return d<t.length&&o.push(t.substring(d,t.length)),o}getFieldObject(){return{id:this.data.id,value:this.data.fieldValue,defaultValue:this.data.defaultFieldValue,multiline:this.data.multiLine,password:this.hasFieldFlag(_util.AnnotationFieldFlag.PASSWORD),charLimit:this.data.maxLen,comb:this.data.comb,editable:!this.data.readOnly,hidden:this.data.hidden,name:this.data.fieldName,rect:this.data.rect,actions:this.data.actions,page:this.data.pageIndex,strokeColor:this.data.borderColor,fillColor:this.data.backgroundColor,type:"text"}}}class ButtonWidgetAnnotation extends WidgetAnnotation{constructor(t){super(t),this.checkedAppearance=null,this.uncheckedAppearance=null,this.data.checkBox=!this.hasFieldFlag(_util.AnnotationFieldFlag.RADIO)&&!this.hasFieldFlag(_util.AnnotationFieldFlag.PUSHBUTTON),this.data.radioButton=this.hasFieldFlag(_util.AnnotationFieldFlag.RADIO)&&!this.hasFieldFlag(_util.AnnotationFieldFlag.PUSHBUTTON),this.data.pushButton=this.hasFieldFlag(_util.AnnotationFieldFlag.PUSHBUTTON),this.data.isTooltipOnly=!1,this.data.checkBox?this._processCheckBox(t):this.data.radioButton?this._processRadioButton(t):this.data.pushButton?this._processPushButton(t):(0,_util.warn)("Invalid field flags for button widget annotation")}async getOperatorList(t,e,i,a){if(this.data.pushButton)return super.getOperatorList(t,e,!1,a);let n=null;if(a){const t=a.get(this.data.id);n=t?t.value:null}if(null===n){if(this.appearance)return super.getOperatorList(t,e,i,a);n=this.data.checkBox?this.data.fieldValue===this.data.exportValue:this.data.fieldValue===this.data.buttonValue}const s=n?this.checkedAppearance:this.uncheckedAppearance;if(s){const n=this.appearance;this.appearance=s;const r=super.getOperatorList(t,e,i,a);return this.appearance=n,r}return new _operator_list.OperatorList}async save(t,e,i){return this.data.checkBox?this._saveCheckbox(t,e,i):this.data.radioButton?this._saveRadioButton(t,e,i):null}async _saveCheckbox(t,e,i){if(!i)return null;const a=i.get(this.data.id),n=a&&a.value;if(void 0===n)return null;const s=this.data.fieldValue===this.data.exportValue;if(s===n)return null;const r=t.xref.fetchIfRef(this.ref);if(!(0,_primitives.isDict)(r))return null;const o={path:(0,_util.stringToPDFString)(r.get("T")||""),value:n?this.data.exportValue:""},l=_primitives.Name.get(n?this.data.exportValue:"Off");r.set("V",l),r.set("AS",l),r.set("M",`D:${(0,_util.getModificationDate)()}`);const c=t.xref.encrypt;let h=null;c&&(h=c.createCipherTransform(this.ref.num,this.ref.gen));const d=[`${this.ref.num} ${this.ref.gen} obj\n`];return(0,_writer.writeDict)(r,d,h),d.push("\nendobj\n"),[{ref:this.ref,data:d.join(""),xfa:o}]}async _saveRadioButton(t,e,i){if(!i)return null;const a=i.get(this.data.id),n=a&&a.value;if(void 0===n)return null;const s=this.data.fieldValue===this.data.buttonValue;if(s===n)return null;const r=t.xref.fetchIfRef(this.ref);if(!(0,_primitives.isDict)(r))return null;const o={path:(0,_util.stringToPDFString)(r.get("T")||""),value:n?this.data.buttonValue:""},l=_primitives.Name.get(n?this.data.buttonValue:"Off");let c=null;const h=t.xref.encrypt;if(n)if((0,_primitives.isRef)(this.parent)){const e=t.xref.fetch(this.parent);let i=null;h&&(i=h.createCipherTransform(this.parent.num,this.parent.gen)),e.set("V",l),c=[`${this.parent.num} ${this.parent.gen} obj\n`],(0,_writer.writeDict)(e,c,i),c.push("\nendobj\n")}else(0,_primitives.isDict)(this.parent)&&this.parent.set("V",l);r.set("AS",l),r.set("M",`D:${(0,_util.getModificationDate)()}`);let d=null;h&&(d=h.createCipherTransform(this.ref.num,this.ref.gen));const u=[`${this.ref.num} ${this.ref.gen} obj\n`];(0,_writer.writeDict)(r,u,d),u.push("\nendobj\n");const p=[{ref:this.ref,data:u.join(""),xfa:o}];return null!==c&&p.push({ref:this.parent,data:c.join(""),xfa:null}),p}_getDefaultCheckedAppearance(t,e){const i=this.data.rect[2]-this.data.rect[0],a=this.data.rect[3]-this.data.rect[1],n=[0,0,i,a],s=.8,r=Math.min(i,a)*s;let o,l;"check"===e?(o={width:.755*r,height:.705*r},l="3"):"disc"===e?(o={width:.791*r,height:.705*r},l="l"):(0,_util.unreachable)(`_getDefaultCheckedAppearance - unsupported type: ${e}`);const c=(i-o.width)/2,h=(a-o.height)/2,d=`q BT /PdfJsZaDb ${r} Tf 0 g ${c} ${h} Td (${l}) Tj ET Q`,u=new _primitives.Dict(t.xref);u.set("FormType",1),u.set("Subtype",_primitives.Name.get("Form")),u.set("Type",_primitives.Name.get("XObject")),u.set("BBox",n),u.set("Matrix",[1,0,0,1,0,0]),u.set("Length",d.length);const p=new _primitives.Dict(t.xref),g=new _primitives.Dict(t.xref);g.set("PdfJsZaDb",this.fallbackFontDict),p.set("Font",g),u.set("Resources",p),this.checkedAppearance=new _stream.StringStream(d),this.checkedAppearance.dict=u,this._streams.push(this.checkedAppearance)}_processCheckBox(t){const e=t.dict.get("AP");if(!(0,_primitives.isDict)(e))return;const i=e.get("N");if(!(0,_primitives.isDict)(i))return;const a=this._decodeFormValue(t.dict.get("AS"));"string"===typeof a&&(this.data.fieldValue=a);const n=null!==this.data.fieldValue&&"Off"!==this.data.fieldValue?this.data.fieldValue:"Yes",s=i.getKeys();if(0===s.length)s.push("Off",n);else if(1===s.length)"Off"===s[0]?s.push(n):s.unshift("Off");else if(s.includes(n))s.length=0,s.push("Off",n);else{const t=s.find((t=>"Off"!==t));s.length=0,s.push("Off",t)}s.includes(this.data.fieldValue)||(this.data.fieldValue="Off"),this.data.exportValue=s[1],this.checkedAppearance=i.get(this.data.exportValue)||null,this.uncheckedAppearance=i.get("Off")||null,this.checkedAppearance?this._streams.push(this.checkedAppearance):this._getDefaultCheckedAppearance(t,"check"),this.uncheckedAppearance&&this._streams.push(this.uncheckedAppearance),this._fallbackFontDict=this.fallbackFontDict}_processRadioButton(t){this.data.fieldValue=this.data.buttonValue=null;const e=t.dict.get("Parent");if((0,_primitives.isDict)(e)){this.parent=t.dict.getRaw("Parent");const i=e.get("V");(0,_primitives.isName)(i)&&(this.data.fieldValue=this._decodeFormValue(i))}const i=t.dict.get("AP");if(!(0,_primitives.isDict)(i))return;const a=i.get("N");if((0,_primitives.isDict)(a)){for(const t of a.getKeys())if("Off"!==t){this.data.buttonValue=this._decodeFormValue(t);break}this.checkedAppearance=a.get(this.data.buttonValue)||null,this.uncheckedAppearance=a.get("Off")||null,this.checkedAppearance?this._streams.push(this.checkedAppearance):this._getDefaultCheckedAppearance(t,"disc"),this.uncheckedAppearance&&this._streams.push(this.uncheckedAppearance),this._fallbackFontDict=this.fallbackFontDict}}_processPushButton(t){t.dict.has("A")||t.dict.has("AA")||this.data.alternativeText?(this.data.isTooltipOnly=!t.dict.has("A")&&!t.dict.has("AA"),_catalog.Catalog.parseDestDictionary({destDict:t.dict,resultObj:this.data,docBaseUrl:t.pdfManager.docBaseUrl})):(0,_util.warn)("Push buttons without action dictionaries are not supported")}getFieldObject(){let t,e="button";return this.data.checkBox?(e="checkbox",t=this.data.exportValue):this.data.radioButton&&(e="radiobutton",t=this.data.buttonValue),{id:this.data.id,value:this.data.fieldValue||"Off",defaultValue:this.data.defaultFieldValue,exportValues:t,editable:!this.data.readOnly,name:this.data.fieldName,rect:this.data.rect,hidden:this.data.hidden,actions:this.data.actions,page:this.data.pageIndex,strokeColor:this.data.borderColor,fillColor:this.data.backgroundColor,type:e}}get fallbackFontDict(){const t=new _primitives.Dict;return t.set("BaseFont",_primitives.Name.get("ZapfDingbats")),t.set("Type",_primitives.Name.get("FallbackType")),t.set("Subtype",_primitives.Name.get("FallbackType")),t.set("Encoding",_primitives.Name.get("ZapfDingbatsEncoding")),(0,_util.shadow)(this,"fallbackFontDict",t)}}class ChoiceWidgetAnnotation extends WidgetAnnotation{constructor(t){super(t),this.data.options=[];const e=(0,_core_utils.getInheritableProperty)({dict:t.dict,key:"Opt"});if(Array.isArray(e)){const i=t.xref;for(let t=0,a=e.length;t<a;t++){const a=i.fetchIfRef(e[t]),n=Array.isArray(a);this.data.options[t]={exportValue:this._decodeFormValue(n?i.fetchIfRef(a[0]):a),displayValue:this._decodeFormValue(n?i.fetchIfRef(a[1]):a)}}}(0,_util.isString)(this.data.fieldValue)?this.data.fieldValue=[this.data.fieldValue]:this.data.fieldValue||(this.data.fieldValue=[]),this.data.combo=this.hasFieldFlag(_util.AnnotationFieldFlag.COMBO),this.data.multiSelect=this.hasFieldFlag(_util.AnnotationFieldFlag.MULTISELECT),this._hasText=!0}getFieldObject(){const t=this.data.combo?"combobox":"listbox",e=this.data.fieldValue.length>0?this.data.fieldValue[0]:null;return{id:this.data.id,value:e,defaultValue:this.data.defaultFieldValue,editable:!this.data.readOnly,name:this.data.fieldName,rect:this.data.rect,numItems:this.data.fieldValue.length,multipleSelection:this.data.multiSelect,hidden:this.data.hidden,actions:this.data.actions,items:this.data.options,page:this.data.pageIndex,strokeColor:this.data.borderColor,fillColor:this.data.backgroundColor,type:t}}}class SignatureWidgetAnnotation extends WidgetAnnotation{constructor(t){super(t),this.data.fieldValue=null}getFieldObject(){return{id:this.data.id,value:null,page:this.data.pageIndex,type:"signature"}}}class TextAnnotation extends MarkupAnnotation{constructor(t){const e=22;super(t);const i=t.dict;this.data.annotationType=_util.AnnotationType.TEXT,this.data.hasAppearance?this.data.name="NoIcon":(this.data.rect[1]=this.data.rect[3]-e,this.data.rect[2]=this.data.rect[0]+e,this.data.name=i.has("Name")?i.get("Name").name:"Note"),i.has("State")?(this.data.state=i.get("State")||null,this.data.stateModel=i.get("StateModel")||null):(this.data.state=null,this.data.stateModel=null)}}class LinkAnnotation extends Annotation{constructor(t){super(t),this.data.annotationType=_util.AnnotationType.LINK;const e=getQuadPoints(t.dict,this.rectangle);e&&(this.data.quadPoints=e),_catalog.Catalog.parseDestDictionary({destDict:t.dict,resultObj:this.data,docBaseUrl:t.pdfManager.docBaseUrl})}}class PopupAnnotation extends Annotation{constructor(t){super(t),this.data.annotationType=_util.AnnotationType.POPUP;let e=t.dict.get("Parent");if(!e)return void(0,_util.warn)("Popup annotation has a missing or invalid parent annotation.");const i=e.get("Subtype");this.data.parentType=(0,_primitives.isName)(i)?i.name:null;const a=t.dict.getRaw("Parent");this.data.parentId=(0,_primitives.isRef)(a)?a.toString():null;const n=e.getArray("Rect");Array.isArray(n)&&4===n.length?this.data.parentRect=_util.Util.normalizeRect(n):this.data.parentRect=[0,0,0,0];const s=e.get("RT");if((0,_primitives.isName)(s,_util.AnnotationReplyType.GROUP)&&(e=e.get("IRT")),e.has("M")?(this.setModificationDate(e.get("M")),this.data.modificationDate=this.modificationDate):this.data.modificationDate=null,e.has("C")?(this.setColor(e.getArray("C")),this.data.color=this.color):this.data.color=null,!this.viewable){const t=e.get("F");this._isViewable(t)&&this.setFlags(t)}this.setTitle(e.get("T")),this.data.titleObj=this._title,this.setContents(e.get("Contents")),this.data.contentsObj=this._contents}}class FreeTextAnnotation extends MarkupAnnotation{constructor(t){super(t),this.data.annotationType=_util.AnnotationType.FREETEXT}}class LineAnnotation extends MarkupAnnotation{constructor(t){super(t),this.data.annotationType=_util.AnnotationType.LINE;const e=t.dict.getArray("L");if(this.data.lineCoordinates=_util.Util.normalizeRect(e),!this.appearance){const i=this.color?Array.from(this.color).map((t=>t/255)):[0,0,0],a=t.dict.get("CA");let n=null,s=t.dict.getArray("IC");s&&(s=getRgbColor(s,null),n=s?Array.from(s).map((t=>t/255)):null);const r=n?a:null,o=this.borderStyle.width||1,l=2*o,c=[this.data.lineCoordinates[0]-l,this.data.lineCoordinates[1]-l,this.data.lineCoordinates[2]+l,this.data.lineCoordinates[3]+l];_util.Util.intersect(this.rectangle,c)||(this.rectangle=c),this._setDefaultAppearance({xref:t.xref,extra:`${o} w`,strokeColor:i,fillColor:n,strokeAlpha:a,fillAlpha:r,pointsCallback:(t,i)=>(t.push(`${e[0]} ${e[1]} m`,`${e[2]} ${e[3]} l`,"S"),[i[0].x-o,i[1].x+o,i[3].y-o,i[1].y+o])})}}}class SquareAnnotation extends MarkupAnnotation{constructor(t){if(super(t),this.data.annotationType=_util.AnnotationType.SQUARE,!this.appearance){const e=this.color?Array.from(this.color).map((t=>t/255)):[0,0,0],i=t.dict.get("CA");let a=null,n=t.dict.getArray("IC");n&&(n=getRgbColor(n,null),a=n?Array.from(n).map((t=>t/255)):null);const s=a?i:null;this._setDefaultAppearance({xref:t.xref,extra:`${this.borderStyle.width} w`,strokeColor:e,fillColor:a,strokeAlpha:i,fillAlpha:s,pointsCallback:(t,e)=>{const i=e[2].x+this.borderStyle.width/2,n=e[2].y+this.borderStyle.width/2,s=e[3].x-e[2].x-this.borderStyle.width,r=e[1].y-e[3].y-this.borderStyle.width;return t.push(`${i} ${n} ${s} ${r} re`),a?t.push("B"):t.push("S"),[e[0].x,e[1].x,e[3].y,e[1].y]}})}}}class CircleAnnotation extends MarkupAnnotation{constructor(t){if(super(t),this.data.annotationType=_util.AnnotationType.CIRCLE,!this.appearance){const e=this.color?Array.from(this.color).map((t=>t/255)):[0,0,0],i=t.dict.get("CA");let a=null,n=t.dict.getArray("IC");n&&(n=getRgbColor(n,null),a=n?Array.from(n).map((t=>t/255)):null);const s=a?i:null,r=4/3*Math.tan(Math.PI/8);this._setDefaultAppearance({xref:t.xref,extra:`${this.borderStyle.width} w`,strokeColor:e,fillColor:a,strokeAlpha:i,fillAlpha:s,pointsCallback:(t,e)=>{const i=e[0].x+this.borderStyle.width/2,n=e[0].y-this.borderStyle.width/2,s=e[3].x-this.borderStyle.width/2,o=e[3].y+this.borderStyle.width/2,l=i+(s-i)/2,c=n+(o-n)/2,h=(s-i)/2*r,d=(o-n)/2*r;return t.push(`${l} ${o} m`,`${l+h} ${o} ${s} ${c+d} ${s} ${c} c`,`${s} ${c-d} ${l+h} ${n} ${l} ${n} c`,`${l-h} ${n} ${i} ${c-d} ${i} ${c} c`,`${i} ${c+d} ${l-h} ${o} ${l} ${o} c`,"h"),a?t.push("B"):t.push("S"),[e[0].x,e[1].x,e[3].y,e[1].y]}})}}}class PolylineAnnotation extends MarkupAnnotation{constructor(t){super(t),this.data.annotationType=_util.AnnotationType.POLYLINE,this.data.vertices=[];const e=t.dict.getArray("Vertices");if(Array.isArray(e)){for(let t=0,i=e.length;t<i;t+=2)this.data.vertices.push({x:e[t],y:e[t+1]});if(!this.appearance){const e=this.color?Array.from(this.color).map((t=>t/255)):[0,0,0],i=t.dict.get("CA"),a=this.borderStyle.width||1,n=2*a,s=[1/0,1/0,-1/0,-1/0];for(const t of this.data.vertices)s[0]=Math.min(s[0],t.x-n),s[1]=Math.min(s[1],t.y-n),s[2]=Math.max(s[2],t.x+n),s[3]=Math.max(s[3],t.y+n);_util.Util.intersect(this.rectangle,s)||(this.rectangle=s),this._setDefaultAppearance({xref:t.xref,extra:`${a} w`,strokeColor:e,strokeAlpha:i,pointsCallback:(t,e)=>{const i=this.data.vertices;for(let a=0,n=i.length;a<n;a++)t.push(`${i[a].x} ${i[a].y} ${0===a?"m":"l"}`);return t.push("S"),[e[0].x,e[1].x,e[3].y,e[1].y]}})}}}}class PolygonAnnotation extends PolylineAnnotation{constructor(t){super(t),this.data.annotationType=_util.AnnotationType.POLYGON}}class CaretAnnotation extends MarkupAnnotation{constructor(t){super(t),this.data.annotationType=_util.AnnotationType.CARET}}class InkAnnotation extends MarkupAnnotation{constructor(t){super(t),this.data.annotationType=_util.AnnotationType.INK,this.data.inkLists=[];const e=t.dict.getArray("InkList");if(!Array.isArray(e))return;const i=t.xref;for(let a=0,n=e.length;a<n;++a){this.data.inkLists.push([]);for(let t=0,n=e[a].length;t<n;t+=2)this.data.inkLists[a].push({x:i.fetchIfRef(e[a][t]),y:i.fetchIfRef(e[a][t+1])})}if(!this.appearance){const e=this.color?Array.from(this.color).map((t=>t/255)):[0,0,0],i=t.dict.get("CA"),a=this.borderStyle.width||1,n=2*a,s=[1/0,1/0,-1/0,-1/0];for(const t of this.data.inkLists)for(const e of t)s[0]=Math.min(s[0],e.x-n),s[1]=Math.min(s[1],e.y-n),s[2]=Math.max(s[2],e.x+n),s[3]=Math.max(s[3],e.y+n);_util.Util.intersect(this.rectangle,s)||(this.rectangle=s),this._setDefaultAppearance({xref:t.xref,extra:`${a} w`,strokeColor:e,strokeAlpha:i,pointsCallback:(t,e)=>{for(const i of this.data.inkLists){for(let e=0,a=i.length;e<a;e++)t.push(`${i[e].x} ${i[e].y} ${0===e?"m":"l"}`);t.push("S")}return[e[0].x,e[1].x,e[3].y,e[1].y]}})}}}class HighlightAnnotation extends MarkupAnnotation{constructor(t){super(t),this.data.annotationType=_util.AnnotationType.HIGHLIGHT;const e=this.data.quadPoints=getQuadPoints(t.dict,null);if(e){const e=this.appearance&&this.appearance.dict.get("Resources");if(!this.appearance||!e||!e.has("ExtGState")){this.appearance&&(0,_util.warn)("HighlightAnnotation - ignoring built-in appearance stream.");const e=this.color?Array.from(this.color).map((t=>t/255)):[1,1,0],i=t.dict.get("CA");this._setDefaultAppearance({xref:t.xref,fillColor:e,blendMode:"Multiply",fillAlpha:i,pointsCallback:(t,e)=>(t.push(`${e[0].x} ${e[0].y} m`,`${e[1].x} ${e[1].y} l`,`${e[3].x} ${e[3].y} l`,`${e[2].x} ${e[2].y} l`,"f"),[e[0].x,e[1].x,e[3].y,e[1].y])})}}else this.data.hasPopup=!1}}class UnderlineAnnotation extends MarkupAnnotation{constructor(t){super(t),this.data.annotationType=_util.AnnotationType.UNDERLINE;const e=this.data.quadPoints=getQuadPoints(t.dict,null);if(e){if(!this.appearance){const e=this.color?Array.from(this.color).map((t=>t/255)):[0,0,0],i=t.dict.get("CA");this._setDefaultAppearance({xref:t.xref,extra:"[] 0 d 1 w",strokeColor:e,strokeAlpha:i,pointsCallback:(t,e)=>(t.push(`${e[2].x} ${e[2].y} m`,`${e[3].x} ${e[3].y} l`,"S"),[e[0].x,e[1].x,e[3].y,e[1].y])})}}else this.data.hasPopup=!1}}class SquigglyAnnotation extends MarkupAnnotation{constructor(t){super(t),this.data.annotationType=_util.AnnotationType.SQUIGGLY;const e=this.data.quadPoints=getQuadPoints(t.dict,null);if(e){if(!this.appearance){const e=this.color?Array.from(this.color).map((t=>t/255)):[0,0,0],i=t.dict.get("CA");this._setDefaultAppearance({xref:t.xref,extra:"[] 0 d 1 w",strokeColor:e,strokeAlpha:i,pointsCallback:(t,e)=>{const i=(e[0].y-e[2].y)/6;let a=i,n=e[2].x;const s=e[2].y,r=e[3].x;t.push(`${n} ${s+a} m`);do{n+=2,a=0===a?i:0,t.push(`${n} ${s+a} l`)}while(n<r);return t.push("S"),[e[2].x,r,s-2*i,s+2*i]}})}}else this.data.hasPopup=!1}}class StrikeOutAnnotation extends MarkupAnnotation{constructor(t){super(t),this.data.annotationType=_util.AnnotationType.STRIKEOUT;const e=this.data.quadPoints=getQuadPoints(t.dict,null);if(e){if(!this.appearance){const e=this.color?Array.from(this.color).map((t=>t/255)):[0,0,0],i=t.dict.get("CA");this._setDefaultAppearance({xref:t.xref,extra:"[] 0 d 1 w",strokeColor:e,strokeAlpha:i,pointsCallback:(t,e)=>(t.push((e[0].x+e[2].x)/2+" "+(e[0].y+e[2].y)/2+" m",(e[1].x+e[3].x)/2+" "+(e[1].y+e[3].y)/2+" l","S"),[e[0].x,e[1].x,e[3].y,e[1].y])})}}else this.data.hasPopup=!1}}class StampAnnotation extends MarkupAnnotation{constructor(t){super(t),this.data.annotationType=_util.AnnotationType.STAMP}}class FileAttachmentAnnotation extends MarkupAnnotation{constructor(t){super(t);const e=new _file_spec.FileSpec(t.dict.get("FS"),t.xref);this.data.annotationType=_util.AnnotationType.FILEATTACHMENT,this.data.file=e.serializable}}