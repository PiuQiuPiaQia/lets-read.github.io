"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.collectActions=collectActions,exports.encodeToXmlString=encodeToXmlString,exports.escapePDFName=escapePDFName,exports.getArrayLookupTableFactory=getArrayLookupTableFactory,exports.getInheritableProperty=getInheritableProperty,exports.getLookupTableFactory=getLookupTableFactory,exports.isWhiteSpace=isWhiteSpace,exports.log2=log2,exports.parseXFAPath=parseXFAPath,exports.readInt8=readInt8,exports.readUint16=readUint16,exports.readUint32=readUint32,exports.recoverJsURL=recoverJsURL,exports.toRomanNumerals=toRomanNumerals,exports.validateCSSFont=validateCSSFont,exports.XRefParseException=exports.XRefEntryException=exports.ParserEOFException=exports.MissingDataException=void 0;var _util=require("../shared/util.js"),_primitives=require("./primitives.js");function getLookupTableFactory(t){let e;return function(){return t&&(e=Object.create(null),t(e),t=null),e}}function getArrayLookupTableFactory(t){let e;return function(){if(t){let n=t();t=null,e=Object.create(null);for(let t=0,o=n.length;t<o;t+=2)e[n[t]]=n[t+1];n=null}return e}}class MissingDataException extends _util.BaseException{constructor(t,e){super(`Missing data [${t}, ${e})`,"MissingDataException"),this.begin=t,this.end=e}}exports.MissingDataException=MissingDataException;class ParserEOFException extends _util.BaseException{constructor(t){super(t,"ParserEOFException")}}exports.ParserEOFException=ParserEOFException;class XRefEntryException extends _util.BaseException{constructor(t){super(t,"XRefEntryException")}}exports.XRefEntryException=XRefEntryException;class XRefParseException extends _util.BaseException{constructor(t){super(t,"XRefParseException")}}function getInheritableProperty({dict:t,key:e,getArray:n=!1,stopWhenFound:o=!0}){let r;const i=new _primitives.RefSet;while(t instanceof _primitives.Dict&&(!t.objId||!i.has(t.objId))){t.objId&&i.put(t.objId);const s=n?t.getArray(e):t.get(e);if(void 0!==s){if(o)return s;r||(r=[]),r.push(s)}t=t.get("Parent")}return r}exports.XRefParseException=XRefParseException;const ROMAN_NUMBER_MAP=["","C","CC","CCC","CD","D","DC","DCC","DCCC","CM","","X","XX","XXX","XL","L","LX","LXX","LXXX","XC","","I","II","III","IV","V","VI","VII","VIII","IX"];function toRomanNumerals(t,e=!1){(0,_util.assert)(Number.isInteger(t)&&t>0,"The number should be a positive integer.");const n=[];let o;while(t>=1e3)t-=1e3,n.push("M");o=t/100|0,t%=100,n.push(ROMAN_NUMBER_MAP[o]),o=t/10|0,t%=10,n.push(ROMAN_NUMBER_MAP[10+o]),n.push(ROMAN_NUMBER_MAP[20+t]);const r=n.join("");return e?r.toLowerCase():r}function log2(t){return t<=0?0:Math.ceil(Math.log2(t))}function readInt8(t,e){return t[e]<<24>>24}function readUint16(t,e){return t[e]<<8|t[e+1]}function readUint32(t,e){return(t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3])>>>0}function isWhiteSpace(t){return 32===t||9===t||13===t||10===t}function parseXFAPath(t){const e=/(.+)\[(\d+)\]$/;return t.split(".").map((t=>{const n=t.match(e);return n?{name:n[1],pos:parseInt(n[2],10)}:{name:t,pos:0}}))}function escapePDFName(t){const e=[];let n=0;for(let o=0,r=t.length;o<r;o++){const r=t.charCodeAt(o);(r<33||r>126||35===r||40===r||41===r||60===r||62===r||91===r||93===r||123===r||125===r||47===r||37===r)&&(n<o&&e.push(t.substring(n,o)),e.push(`#${r.toString(16)}`),n=o+1)}return 0===e.length?t:(n<t.length&&e.push(t.substring(n,t.length)),e.join(""))}function _collectJS(t,e,n,o){if(!t)return;let r=null;if((0,_primitives.isRef)(t)){if(o.has(t))return;r=t,o.put(r),t=e.fetch(t)}if(Array.isArray(t))for(const i of t)_collectJS(i,e,n,o);else if(t instanceof _primitives.Dict){if((0,_primitives.isName)(t.get("S"),"JavaScript")&&t.has("JS")){const e=t.get("JS");let o;o=(0,_primitives.isStream)(e)?e.getString():e,o=(0,_util.stringToPDFString)(o),o&&n.push(o)}_collectJS(t.getRaw("Next"),e,n,o)}r&&o.remove(r)}function collectActions(t,e,n){const o=Object.create(null),r=getInheritableProperty({dict:e,key:"AA",stopWhenFound:!1});if(r)for(let i=r.length-1;i>=0;i--){const e=r[i];if(e instanceof _primitives.Dict)for(const r of e.getKeys()){const i=n[r];if(!i)continue;const s=e.getRaw(r),c=new _primitives.RefSet,a=[];_collectJS(s,t,a,c),a.length>0&&(o[i]=a)}}if(e.has("A")){const n=e.get("A"),r=new _primitives.RefSet,i=[];_collectJS(n,t,i,r),i.length>0&&(o.Action=i)}return(0,_util.objectSize)(o)>0?o:null}const XMLEntities={60:"&lt;",62:"&gt;",38:"&amp;",34:"&quot;",39:"&apos;"};function encodeToXmlString(t){const e=[];let n=0;for(let o=0,r=t.length;o<r;o++){const r=t.codePointAt(o);if(32<=r&&r<=126){const i=XMLEntities[r];i&&(n<o&&e.push(t.substring(n,o)),e.push(i),n=o+1)}else n<o&&e.push(t.substring(n,o)),e.push(`&#x${r.toString(16).toUpperCase()};`),r>55295&&(r<57344||r>65533)&&o++,n=o+1}return 0===e.length?t:(n<t.length&&e.push(t.substring(n,t.length)),e.join(""))}function validateCSSFont(t){const e="14",n="400",o=new Set(["100","200","300","400","500","600","700","800","900","1000","normal","bold","bolder","lighter"]),{fontFamily:r,fontWeight:i,italicAngle:s}=t;if(/^".*"$/.test(r)){if(/[^\\]"/.test(r.slice(1,r.length-1)))return(0,_util.warn)(`XFA - FontFamily contains some unescaped ": ${r}.`),!1}else if(/^'.*'$/.test(r)){if(/[^\\]'/.test(r.slice(1,r.length-1)))return(0,_util.warn)(`XFA - FontFamily contains some unescaped ': ${r}.`),!1}else for(const l of r.split(/[ \t]+/))if(/^(\d|(-(\d|-)))/.test(l)||!/^[\w-\\]+$/.test(l))return(0,_util.warn)(`XFA - FontFamily contains some invalid <custom-ident>: ${r}.`),!1;const c=i?i.toString():"";t.fontWeight=o.has(c)?c:n;const a=parseFloat(s);return t.italicAngle=isNaN(a)||a<-90||a>90?e:s.toString(),!0}function recoverJsURL(t){const e=["app.launchURL","window.open","xfa.host.gotoURL"],n=new RegExp("^\\s*("+e.join("|").split(".").join("\\.")+")\\((?:'|\")([^'\"]*)(?:'|\")(?:,\\s*(\\w+)\\)|\\))","i"),o=n.exec(t);if(o&&o[2]){const t=o[2];let e=!1;return"true"===o[3]&&"app.launchURL"===o[1]&&(e=!0),{url:t,newWindow:e}}return null}