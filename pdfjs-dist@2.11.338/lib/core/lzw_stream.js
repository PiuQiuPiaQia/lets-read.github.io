"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.LZWStream=void 0;var _decode_stream=require("./decode_stream.js");class LZWStream extends _decode_stream.DecodeStream{constructor(e,t,r){super(t),this.str=e,this.dict=e.dict,this.cachedData=0,this.bitsCached=0;const n=4096,s={earlyChange:r,codeLength:9,nextCode:258,dictionaryValues:new Uint8Array(n),dictionaryLengths:new Uint16Array(n),dictionaryPrevCodes:new Uint16Array(n),currentSequence:new Uint8Array(n),currentSequenceLength:0};for(let i=0;i<256;++i)s.dictionaryValues[i]=i,s.dictionaryLengths[i]=1;this.lzwState=s}readBits(e){let t=this.bitsCached,r=this.cachedData;while(t<e){const e=this.str.getByte();if(-1===e)return this.eof=!0,null;r=r<<8|e,t+=8}return this.bitsCached=t-=e,this.cachedData=r,this.lastCode=null,r>>>t&(1<<e)-1}readBlock(){const e=512,t=e;let r,n,s,i=2*e;const a=this.lzwState;if(!a)return;const c=a.earlyChange;let o=a.nextCode;const h=a.dictionaryValues,d=a.dictionaryLengths,u=a.dictionaryPrevCodes;let l=a.codeLength,f=a.prevCode;const g=a.currentSequence;let L=a.currentSequenceLength,y=0,C=this.bufferLength,S=this.ensureBuffer(this.bufferLength+i);for(r=0;r<e;r++){const e=this.readBits(l),r=L>0;if(e<256)g[0]=e,L=1;else{if(!(e>=258)){if(256===e){l=9,o=258,L=0;continue}this.eof=!0,delete this.lzwState;break}if(e<o)for(L=d[e],n=L-1,s=e;n>=0;n--)g[n]=h[s],s=u[s];else g[L++]=g[0]}if(r&&(u[o]=f,d[o]=d[f]+1,h[o]=g[0],o++,l=o+c&o+c-1?l:0|Math.min(Math.log(o+c)/.6931471805599453+1,12)),f=e,y+=L,i<y){do{i+=t}while(i<y);S=this.ensureBuffer(this.bufferLength+i)}for(n=0;n<L;n++)S[C++]=g[n]}a.nextCode=o,a.codeLength=l,a.prevCode=f,a.currentSequenceLength=L,this.bufferLength=C}}exports.LZWStream=LZWStream;