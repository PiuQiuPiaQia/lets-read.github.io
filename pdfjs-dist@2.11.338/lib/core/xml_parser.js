"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.XMLParserErrorCode=exports.XMLParserBase=exports.SimpleXMLParser=exports.SimpleDOMNode=void 0;var _core_utils=require("./core_utils.js");const XMLParserErrorCode={NoError:0,EndOfDocument:-1,UnterminatedCdat:-2,UnterminatedXmlDeclaration:-3,UnterminatedDoctypeDeclaration:-4,UnterminatedComment:-5,MalformedElement:-6,OutOfMemory:-7,UnterminatedAttributeValue:-8,UnterminatedElement:-9,ElementNeverBegun:-10};function isWhitespace(e,r){const t=e[r];return" "===t||"\n"===t||"\r"===t||"\t"===t}function isWhitespaceString(e){for(let r=0,t=e.length;r<t;r++)if(!isWhitespace(e,r))return!1;return!0}exports.XMLParserErrorCode=XMLParserErrorCode;class XMLParserBase{_resolveEntities(e){return e.replace(/&([^;]+);/g,((e,r)=>{if("#x"===r.substring(0,2))return String.fromCodePoint(parseInt(r.substring(2),16));if("#"===r.substring(0,1))return String.fromCodePoint(parseInt(r.substring(1),10));switch(r){case"lt":return"<";case"gt":return">";case"amp":return"&";case"quot":return'"';case"apos":return"'"}return this.onResolveEntity(r)}))}_parseContent(e,r){const t=[];let s=r;function n(){while(s<e.length&&isWhitespace(e,s))++s}while(s<e.length&&!isWhitespace(e,s)&&">"!==e[s]&&"/"!==e[s])++s;const i=e.substring(r,s);n();while(s<e.length&&">"!==e[s]&&"/"!==e[s]&&"?"!==e[s]){n();let r="",i="";while(s<e.length&&!isWhitespace(e,s)&&"="!==e[s])r+=e[s],++s;if(n(),"="!==e[s])return null;++s,n();const o=e[s];if('"'!==o&&"'"!==o)return null;const a=e.indexOf(o,++s);if(a<0)return null;i=e.substring(s,a),t.push({name:r,value:this._resolveEntities(i)}),s=a+1,n()}return{name:i,attributes:t,parsed:s-r}}_parseProcessingInstruction(e,r){let t=r;function s(){while(t<e.length&&isWhitespace(e,t))++t}while(t<e.length&&!isWhitespace(e,t)&&">"!==e[t]&&"?"!==e[t]&&"/"!==e[t])++t;const n=e.substring(r,t);s();const i=t;while(t<e.length&&("?"!==e[t]||">"!==e[t+1]))++t;const o=e.substring(i,t);return{name:n,value:o,parsed:t-r}}parseXml(e){let r=0;while(r<e.length){const t=e[r];let s=r;if("<"===t){++s;const r=e[s];let t;switch(r){case"/":if(++s,t=e.indexOf(">",s),t<0)return void this.onError(XMLParserErrorCode.UnterminatedElement);this.onEndElement(e.substring(s,t)),s=t+1;break;case"?":++s;const r=this._parseProcessingInstruction(e,s);if("?>"!==e.substring(s+r.parsed,s+r.parsed+2))return void this.onError(XMLParserErrorCode.UnterminatedXmlDeclaration);this.onPi(r.name,r.value),s+=r.parsed+2;break;case"!":if("--"===e.substring(s+1,s+3)){if(t=e.indexOf("--\x3e",s+3),t<0)return void this.onError(XMLParserErrorCode.UnterminatedComment);this.onComment(e.substring(s+3,t)),s=t+3}else if("[CDATA["===e.substring(s+1,s+8)){if(t=e.indexOf("]]>",s+8),t<0)return void this.onError(XMLParserErrorCode.UnterminatedCdat);this.onCdata(e.substring(s+8,t)),s=t+3}else{if("DOCTYPE"!==e.substring(s+1,s+8))return void this.onError(XMLParserErrorCode.MalformedElement);{const r=e.indexOf("[",s+8);let n=!1;if(t=e.indexOf(">",s+8),t<0)return void this.onError(XMLParserErrorCode.UnterminatedDoctypeDeclaration);if(r>0&&t>r){if(t=e.indexOf("]>",s+8),t<0)return void this.onError(XMLParserErrorCode.UnterminatedDoctypeDeclaration);n=!0}const i=e.substring(s+8,t+(n?1:0));this.onDoctype(i),s=t+(n?2:1)}}break;default:const n=this._parseContent(e,s);if(null===n)return void this.onError(XMLParserErrorCode.MalformedElement);let i=!1;if("/>"===e.substring(s+n.parsed,s+n.parsed+2))i=!0;else if(">"!==e.substring(s+n.parsed,s+n.parsed+1))return void this.onError(XMLParserErrorCode.UnterminatedElement);this.onBeginElement(n.name,n.attributes,i),s+=n.parsed+(i?2:1);break}}else{while(s<e.length&&"<"!==e[s])s++;const t=e.substring(r,s);this.onText(this._resolveEntities(t))}r=s}}onResolveEntity(e){return`&${e};`}onPi(e,r){}onComment(e){}onCdata(e){}onDoctype(e){}onText(e){}onBeginElement(e,r,t){}onEndElement(e){}onError(e){}}exports.XMLParserBase=XMLParserBase;class SimpleDOMNode{constructor(e,r){this.nodeName=e,this.nodeValue=r,Object.defineProperty(this,"parentNode",{value:null,writable:!0})}get firstChild(){return this.childNodes&&this.childNodes[0]}get nextSibling(){const e=this.parentNode.childNodes;if(!e)return;const r=e.indexOf(this);return-1!==r?e[r+1]:void 0}get textContent(){return this.childNodes?this.childNodes.map((function(e){return e.textContent})).join(""):this.nodeValue||""}hasChildNodes(){return this.childNodes&&this.childNodes.length>0}searchNode(e,r){if(r>=e.length)return this;const t=e[r],s=[];let n=this;while(1){if(t.name===n.nodeName){if(0!==t.pos){if(0===s.length)return null;{const[i]=s.pop();let o=0;for(const s of i.childNodes)if(t.name===s.nodeName){if(o===t.pos)return s.searchNode(e,r+1);o++}return n.searchNode(e,r+1)}}{const t=n.searchNode(e,r+1);if(null!==t)return t}}if(n.childNodes&&0!==n.childNodes.length)s.push([n,0]),n=n.childNodes[0];else{if(0===s.length)return null;while(0!==s.length){const[e,r]=s.pop(),t=r+1;if(t<e.childNodes.length){s.push([e,t]),n=e.childNodes[t];break}}if(0===s.length)return null}}}dump(e){if("#text"!==this.nodeName){if(e.push(`<${this.nodeName}`),this.attributes)for(const r of this.attributes)e.push(` ${r.name}="${(0,_core_utils.encodeToXmlString)(r.value)}"`);if(this.hasChildNodes()){e.push(">");for(const r of this.childNodes)r.dump(e);e.push(`</${this.nodeName}>`)}else this.nodeValue?e.push(`>${(0,_core_utils.encodeToXmlString)(this.nodeValue)}</${this.nodeName}>`):e.push("/>")}else e.push((0,_core_utils.encodeToXmlString)(this.nodeValue))}}exports.SimpleDOMNode=SimpleDOMNode;class SimpleXMLParser extends XMLParserBase{constructor({hasAttributes:e=!1,lowerCaseName:r=!1}){super(),this._currentFragment=null,this._stack=null,this._errorCode=XMLParserErrorCode.NoError,this._hasAttributes=e,this._lowerCaseName=r}parseFromString(e){if(this._currentFragment=[],this._stack=[],this._errorCode=XMLParserErrorCode.NoError,this.parseXml(e),this._errorCode!==XMLParserErrorCode.NoError)return;const[r]=this._currentFragment;return r?{documentElement:r}:void 0}onText(e){if(isWhitespaceString(e))return;const r=new SimpleDOMNode("#text",e);this._currentFragment.push(r)}onCdata(e){const r=new SimpleDOMNode("#text",e);this._currentFragment.push(r)}onBeginElement(e,r,t){this._lowerCaseName&&(e=e.toLowerCase());const s=new SimpleDOMNode(e);s.childNodes=[],this._hasAttributes&&(s.attributes=r),this._currentFragment.push(s),t||(this._stack.push(this._currentFragment),this._currentFragment=s.childNodes)}onEndElement(e){this._currentFragment=this._stack.pop()||[];const r=this._currentFragment[this._currentFragment.length-1];if(r)for(let t=0,s=r.childNodes.length;t<s;t++)r.childNodes[t].parentNode=r}onError(e){this._errorCode=e}}exports.SimpleXMLParser=SimpleXMLParser;