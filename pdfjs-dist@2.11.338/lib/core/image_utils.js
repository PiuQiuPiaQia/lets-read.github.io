"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.LocalTilingPatternCache=exports.LocalImageCache=exports.LocalGStateCache=exports.LocalFunctionCache=exports.LocalColorSpaceCache=exports.GlobalImageCache=void 0;var _util=require("../shared/util.js"),_primitives=require("./primitives.js");class BaseLocalCache{constructor(e){this.constructor===BaseLocalCache&&(0,_util.unreachable)("Cannot initialize BaseLocalCache."),this._onlyRefs=!0===(e&&e.onlyRefs),this._onlyRefs||(this._nameRefMap=new Map,this._imageMap=new Map),this._imageCache=new _primitives.RefSetCache}getByName(e){this._onlyRefs&&(0,_util.unreachable)("Should not call `getByName` method.");const a=this._nameRefMap.get(e);return a?this.getByRef(a):this._imageMap.get(e)||null}getByRef(e){return this._imageCache.get(e)||null}set(e,a,t){(0,_util.unreachable)("Abstract method `set` called.")}}class LocalImageCache extends BaseLocalCache{set(e,a=null,t){if("string"!==typeof e)throw new Error('LocalImageCache.set - expected "name" argument.');if(a){if(this._imageCache.has(a))return;return this._nameRefMap.set(e,a),void this._imageCache.put(a,t)}this._imageMap.has(e)||this._imageMap.set(e,t)}}exports.LocalImageCache=LocalImageCache;class LocalColorSpaceCache extends BaseLocalCache{set(e=null,a=null,t){if("string"!==typeof e&&!a)throw new Error('LocalColorSpaceCache.set - expected "name" and/or "ref" argument.');if(a){if(this._imageCache.has(a))return;return null!==e&&this._nameRefMap.set(e,a),void this._imageCache.put(a,t)}this._imageMap.has(e)||this._imageMap.set(e,t)}}exports.LocalColorSpaceCache=LocalColorSpaceCache;class LocalFunctionCache extends BaseLocalCache{constructor(e){super({onlyRefs:!0})}set(e=null,a,t){if(!a)throw new Error('LocalFunctionCache.set - expected "ref" argument.');this._imageCache.has(a)||this._imageCache.put(a,t)}}exports.LocalFunctionCache=LocalFunctionCache;class LocalGStateCache extends BaseLocalCache{set(e,a=null,t){if("string"!==typeof e)throw new Error('LocalGStateCache.set - expected "name" argument.');if(a){if(this._imageCache.has(a))return;return this._nameRefMap.set(e,a),void this._imageCache.put(a,t)}this._imageMap.has(e)||this._imageMap.set(e,t)}}exports.LocalGStateCache=LocalGStateCache;class LocalTilingPatternCache extends BaseLocalCache{constructor(e){super({onlyRefs:!0})}set(e=null,a,t){if(!a)throw new Error('LocalTilingPatternCache.set - expected "ref" argument.');this._imageCache.has(a)||this._imageCache.put(a,t)}}exports.LocalTilingPatternCache=LocalTilingPatternCache;class GlobalImageCache{static get NUM_PAGES_THRESHOLD(){return(0,_util.shadow)(this,"NUM_PAGES_THRESHOLD",2)}static get MIN_IMAGES_TO_CACHE(){return(0,_util.shadow)(this,"MIN_IMAGES_TO_CACHE",10)}static get MAX_BYTE_SIZE(){return(0,_util.shadow)(this,"MAX_BYTE_SIZE",4e7)}constructor(){this._refCache=new _primitives.RefSetCache,this._imageCache=new _primitives.RefSetCache}get _byteSize(){let e=0;return this._imageCache.forEach((a=>{e+=a.byteSize})),e}get _cacheLimitReached(){return!(this._imageCache.size<GlobalImageCache.MIN_IMAGES_TO_CACHE)&&!(this._byteSize<GlobalImageCache.MAX_BYTE_SIZE)}shouldCache(e,a){const t=this._refCache.get(e),c=t?t.size+(t.has(a)?0:1):1;return!(c<GlobalImageCache.NUM_PAGES_THRESHOLD)&&!(!this._imageCache.has(e)&&this._cacheLimitReached)}addPageIndex(e,a){let t=this._refCache.get(e);t||(t=new Set,this._refCache.put(e,t)),t.add(a)}addByteSize(e,a){const t=this._imageCache.get(e);t&&(t.byteSize||(t.byteSize=a))}getData(e,a){const t=this._refCache.get(e);if(!t)return null;if(t.size<GlobalImageCache.NUM_PAGES_THRESHOLD)return null;const c=this._imageCache.get(e);return c?(t.add(a),c):null}setData(e,a){if(!this._refCache.has(e))throw new Error('GlobalImageCache.setData - expected "addPageIndex" to have been called.');this._imageCache.has(e)||(this._cacheLimitReached?(0,_util.warn)("GlobalImageCache.setData - cache limit reached."):this._imageCache.put(e,a))}clear(e=!1){e||this._refCache.clear(),this._imageCache.clear()}}exports.GlobalImageCache=GlobalImageCache;