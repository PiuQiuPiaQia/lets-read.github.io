"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Builder=void 0;var _namespaces=require("./namespaces.js"),_xfa_object=require("./xfa_object.js"),_setup=require("./setup.js"),_template=require("./template.js"),_unknown=require("./unknown.js"),_util=require("../../shared/util.js");class Root extends _xfa_object.XFAObject{constructor(e){super(-1,"root",Object.create(null)),this.element=null,this[_xfa_object.$ids]=e}[_xfa_object.$onChild](e){return this.element=e,!0}[_xfa_object.$finalize](){super[_xfa_object.$finalize](),this.element.template instanceof _template.Template&&(this[_xfa_object.$ids].set(_xfa_object.$root,this.element),this.element.template[_xfa_object.$resolvePrototypes](this[_xfa_object.$ids]),this.element.template[_xfa_object.$ids]=this[_xfa_object.$ids])}}class Empty extends _xfa_object.XFAObject{constructor(){super(-1,"",Object.create(null))}[_xfa_object.$onChild](e){return!1}}class Builder{constructor(){this._namespaceStack=[],this._nsAgnosticLevel=0,this._namespacePrefixes=new Map,this._namespaces=new Map,this._nextNsId=Math.max(...Object.values(_namespaces.NamespaceIds).map((({id:e})=>e))),this._currentNamespace=new _unknown.UnknownNamespace(++this._nextNsId)}buildRoot(e){return new Root(e)}build({nsPrefix:e,name:s,attributes:t,namespace:a,prefixes:n}){const c=null!==a;if(c&&(this._namespaceStack.push(this._currentNamespace),this._currentNamespace=this._searchNamespace(a)),n&&this._addNamespacePrefix(n),t.hasOwnProperty(_xfa_object.$nsAttributes)){const e=_setup.NamespaceSetUp.datasets,s=t[_xfa_object.$nsAttributes];let a=null;for(const[t,n]of Object.entries(s)){const s=this._getNamespaceToUse(t);if(s===e){a={xfa:n};break}}a?t[_xfa_object.$nsAttributes]=a:delete t[_xfa_object.$nsAttributes]}const i=this._getNamespaceToUse(e),r=i&&i[_namespaces.$buildXFAObject](s,t)||new Empty;return r[_xfa_object.$isNsAgnostic]()&&this._nsAgnosticLevel++,(c||n||r[_xfa_object.$isNsAgnostic]())&&(r[_xfa_object.$cleanup]={hasNamespace:c,prefixes:n,nsAgnostic:r[_xfa_object.$isNsAgnostic]()}),r}isNsAgnostic(){return this._nsAgnosticLevel>0}_searchNamespace(e){let s=this._namespaces.get(e);if(s)return s;for(const[t,{check:a}]of Object.entries(_namespaces.NamespaceIds))if(a(e)){if(s=_setup.NamespaceSetUp[t],s)return this._namespaces.set(e,s),s;break}return s=new _unknown.UnknownNamespace(++this._nextNsId),this._namespaces.set(e,s),s}_addNamespacePrefix(e){for(const{prefix:s,value:t}of e){const e=this._searchNamespace(t);let a=this._namespacePrefixes.get(s);a||(a=[],this._namespacePrefixes.set(s,a)),a.push(e)}}_getNamespaceToUse(e){if(!e)return this._currentNamespace;const s=this._namespacePrefixes.get(e);return s&&s.length>0?s[s.length-1]:((0,_util.warn)(`Unknown namespace prefix: ${e}.`),null)}clean(e){const{hasNamespace:s,prefixes:t,nsAgnostic:a}=e;s&&(this._currentNamespace=this._namespaceStack.pop()),t&&t.forEach((({prefix:e})=>{this._namespacePrefixes.get(e).pop()})),a&&this._nsAgnosticLevel--}}exports.Builder=Builder;