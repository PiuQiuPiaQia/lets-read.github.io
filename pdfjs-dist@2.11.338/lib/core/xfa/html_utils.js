"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.computeBbox=computeBbox,exports.createWrapper=createWrapper,exports.fixDimensions=fixDimensions,exports.fixTextIndent=fixTextIndent,exports.fixURL=fixURL,exports.isPrintOnly=isPrintOnly,exports.layoutClass=layoutClass,exports.layoutNode=layoutNode,exports.measureToString=measureToString,exports.setAccess=setAccess,exports.setFontFamily=setFontFamily,exports.setMinMaxDimensions=setMinMaxDimensions,exports.setPara=setPara,exports.toStyle=toStyle;var _xfa_object=require("./xfa_object.js"),_util=require("../../shared/util.js"),_utils=require("./utils.js"),_fonts=require("./fonts.js"),_text=require("./text.js");function measureToString(t){return"string"===typeof t?"0px":Number.isInteger(t)?`${t}px`:`${t.toFixed(2)}px`}const converters={anchorType(t,e){const n=t[_xfa_object.$getSubformParent]();if(n&&(!n.layout||"position"===n.layout))switch("transform"in e||(e.transform=""),t.anchorType){case"bottomCenter":e.transform+="translate(-50%, -100%)";break;case"bottomLeft":e.transform+="translate(0,-100%)";break;case"bottomRight":e.transform+="translate(-100%,-100%)";break;case"middleCenter":e.transform+="translate(-50%,-50%)";break;case"middleLeft":e.transform+="translate(0,-50%)";break;case"middleRight":e.transform+="translate(-100%,-50%)";break;case"topCenter":e.transform+="translate(-50%,0)";break;case"topRight":e.transform+="translate(-100%,0)";break}},dimensions(t,e){const n=t[_xfa_object.$getSubformParent]();let a=t.w;const r=t.h;if(n.layout&&n.layout.includes("row")){const e=n[_xfa_object.$extra],r=t.colSpan;let o;-1===r?(o=e.columnWidths.slice(e.currentColumn).reduce(((t,e)=>t+e),0),e.currentColumn=0):(o=e.columnWidths.slice(e.currentColumn,e.currentColumn+r).reduce(((t,e)=>t+e),0),e.currentColumn=(e.currentColumn+t.colSpan)%e.columnWidths.length),isNaN(o)||(a=t.w=o)}e.width=""!==a?measureToString(a):"auto",e.height=""!==r?measureToString(r):"auto"},position(t,e){const n=t[_xfa_object.$getSubformParent]();n&&n.layout&&"position"!==n.layout||(e.position="absolute",e.left=measureToString(t.x),e.top=measureToString(t.y))},rotate(t,e){t.rotate&&("transform"in e||(e.transform=""),e.transform+=`rotate(-${t.rotate}deg)`,e.transformOrigin="top left")},presence(t,e){switch(t.presence){case"invisible":e.visibility="hidden";break;case"hidden":case"inactive":e.display="none";break}},hAlign(t,e){if("para"===t[_xfa_object.$nodeName])switch(t.hAlign){case"justifyAll":e.textAlign="justify-all";break;case"radix":e.textAlign="left";break;default:e.textAlign=t.hAlign}else switch(t.hAlign){case"left":e.alignSelf="start";break;case"center":e.alignSelf="center";break;case"right":e.alignSelf="end";break}},margin(t,e){t.margin&&(e.margin=t.margin[_xfa_object.$toStyle]().margin)}};function setMinMaxDimensions(t,e){const n=t[_xfa_object.$getSubformParent]();"position"===n.layout&&(t.minW>0&&(e.minWidth=measureToString(t.minW)),t.maxW>0&&(e.maxWidth=measureToString(t.maxW)),t.minH>0&&(e.minHeight=measureToString(t.minH)),t.maxH>0&&(e.maxHeight=measureToString(t.maxH)))}function layoutText(t,e,n,a,r,o){const i=new _text.TextMeasure(e,n,a,r);return"string"===typeof t?i.addString(t):t[_xfa_object.$pushGlyphs](i),i.compute(o)}function layoutNode(t,e){let n=null,a=null,r=!1;if((!t.w||!t.h)&&t.value){let o=0,i=0;t.margin&&(o=t.margin.leftInset+t.margin.rightInset,i=t.margin.topInset+t.margin.bottomInset);let s=null,l=null;t.para&&(l=Object.create(null),s=""===t.para.lineHeight?null:t.para.lineHeight,l.top=""===t.para.spaceAbove?0:t.para.spaceAbove,l.bottom=""===t.para.spaceBelow?0:t.para.spaceBelow,l.left=""===t.para.marginLeft?0:t.para.marginLeft,l.right=""===t.para.marginRight?0:t.para.marginRight);let c=t.font;if(!c){const e=t[_xfa_object.$getTemplateRoot]();let n=t[_xfa_object.$getParent]();while(n!==e){if(n.font){c=n.font;break}n=n[_xfa_object.$getParent]()}}const u=(t.w?t.w:e.width)-o,f=t[_xfa_object.$globalData].fontFinder;if(t.value.exData&&t.value.exData[_xfa_object.$content]&&"text/html"===t.value.exData.contentType){const e=layoutText(t.value.exData[_xfa_object.$content],c,l,s,f,u);a=e.width,n=e.height,r=e.isBroken}else{const e=t.value[_xfa_object.$text]();if(e){const t=layoutText(e,c,l,s,f,u);a=t.width,n=t.height,r=t.isBroken}}null===a||t.w||(a+=o),null===n||t.h||(n+=i)}return{w:a,h:n,isBroken:r}}function computeBbox(t,e,n){let a;if(""!==t.w&&""!==t.h)a=[t.x,t.y,t.w,t.h];else{if(!n)return null;let r=t.w;if(""===r){if(0===t.maxW){const e=t[_xfa_object.$getSubformParent]();r="position"===e.layout&&""!==e.w?0:t.minW}else r=Math.min(t.maxW,n.width);e.attributes.style.width=measureToString(r)}let o=t.h;if(""===o){if(0===t.maxH){const e=t[_xfa_object.$getSubformParent]();o="position"===e.layout&&""!==e.h?0:t.minH}else o=Math.min(t.maxH,n.height);e.attributes.style.height=measureToString(o)}a=[t.x,t.y,r,o]}return a}function fixDimensions(t){const e=t[_xfa_object.$getSubformParent]();if(e.layout&&e.layout.includes("row")){const n=e[_xfa_object.$extra],a=t.colSpan;let r;r=-1===a?n.columnWidths.slice(n.currentColumn).reduce(((t,e)=>t+e),0):n.columnWidths.slice(n.currentColumn,n.currentColumn+a).reduce(((t,e)=>t+e),0),isNaN(r)||(t.w=r)}e.layout&&"position"!==e.layout&&(t.x=t.y=0),"table"===t.layout&&""===t.w&&Array.isArray(t.columnWidths)&&(t.w=t.columnWidths.reduce(((t,e)=>t+e),0))}function layoutClass(t){switch(t.layout){case"position":return"xfaPosition";case"lr-tb":return"xfaLrTb";case"rl-row":return"xfaRlRow";case"rl-tb":return"xfaRlTb";case"row":return"xfaRow";case"table":return"xfaTable";case"tb":return"xfaTb";default:return"xfaPosition"}}function toStyle(t,...e){const n=Object.create(null);for(const a of e){const e=t[a];if(null!==e)if(converters.hasOwnProperty(a))converters[a](t,n);else if(e instanceof _xfa_object.XFAObject){const t=e[_xfa_object.$toStyle]();t?Object.assign(n,t):(0,_util.warn)(`(DEBUG) - XFA - style for ${a} not implemented yet`)}}return n}function createWrapper(t,e){const{attributes:n}=e,{style:a}=n,r={name:"div",attributes:{class:["xfaWrapper"],style:Object.create(null)},children:[]};if(n.class.push("xfaWrapped"),t.border){const{widths:n,insets:o}=t.border[_xfa_object.$extra];let i,s,l=o[0],c=o[3];const u=o[0]+o[2],f=o[1]+o[3];switch(t.border.hand){case"even":l-=n[0]/2,c-=n[3]/2,i=`calc(100% + ${(n[1]+n[3])/2-f}px)`,s=`calc(100% + ${(n[0]+n[2])/2-u}px)`;break;case"left":l-=n[0],c-=n[3],i=`calc(100% + ${n[1]+n[3]-f}px)`,s=`calc(100% + ${n[0]+n[2]-u}px)`;break;case"right":i=f?`calc(100% - ${f}px)`:"100%",s=u?`calc(100% - ${u}px)`:"100%";break}const x=["xfaBorder"];isPrintOnly(t.border)&&x.push("xfaPrintOnly");const m={name:"div",attributes:{class:x,style:{top:`${l}px`,left:`${c}px`,width:i,height:s}},children:[]};for(const t of["border","borderWidth","borderColor","borderRadius","borderStyle"])void 0!==a[t]&&(m.attributes.style[t]=a[t],delete a[t]);r.children.push(m,e)}else r.children.push(e);for(const o of["background","backgroundClip","top","left","width","height","minWidth","minHeight","maxWidth","maxHeight","transform","transformOrigin","visibility"])void 0!==a[o]&&(r.attributes.style[o]=a[o],delete a[o]);return"absolute"===a.position?r.attributes.style.position="absolute":r.attributes.style.position="relative",delete a.position,a.alignSelf&&(r.attributes.style.alignSelf=a.alignSelf,delete a.alignSelf),r}function fixTextIndent(t){const e=(0,_utils.getMeasurement)(t.textIndent,"0px");if(e>=0)return;const n="right"===t.textAlign?"right":"left",a="padding"+("left"===n?"Left":"Right"),r=(0,_utils.getMeasurement)(t[a],"0px");t[a]=r-e+"px"}function setAccess(t,e){switch(t.access){case"nonInteractive":e.push("xfaNonInteractive");break;case"readOnly":e.push("xfaReadOnly");break;case"protected":e.push("xfaDisabled");break}}function isPrintOnly(t){return t.relevant.length>0&&!t.relevant[0].excluded&&"print"===t.relevant[0].viewname}function getCurrentPara(t){const e=t[_xfa_object.$getTemplateRoot]()[_xfa_object.$extra].paraStack;return e.length?e[e.length-1]:null}function setPara(t,e,n){if(n.attributes.class&&n.attributes.class.includes("xfaRich")){e&&(""===t.h&&(e.height="auto"),""===t.w&&(e.width="auto"));const a=getCurrentPara(t);if(a){const t=n.attributes.style;switch(t.display="flex",t.flexDirection="column",a.vAlign){case"top":t.justifyContent="start";break;case"bottom":t.justifyContent="end";break;case"middle":t.justifyContent="center";break}const e=a[_xfa_object.$toStyle]();for(const[n,a]of Object.entries(e))n in t||(t[n]=a)}}}function setFontFamily(t,e,n,a){const r=(0,_utils.stripQuotes)(t.typeface),o=n.find(r);if(a.fontFamily=`"${r}"`,o){const{fontFamily:n}=o.regular.cssFontInfo;n!==r&&(a.fontFamily=`"${n}"`);const i=getCurrentPara(e);if(i&&""!==i.lineHeight)return;if(a.lineHeight)return;const s=(0,_fonts.selectFont)(t,o);s&&(a.lineHeight=Math.max(1.2,s.lineHeight))}}function fixURL(t){const e=(0,_util.createValidAbsoluteUrl)(t,null,{addDefaultProtocol:!0,tryConvertEncoding:!0});return e?e.href:null}