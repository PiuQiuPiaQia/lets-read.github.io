"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.XhtmlNamespace=void 0;var _xfa_object=require("./xfa_object.js"),_namespaces=require("./namespaces.js"),_html_utils=require("./html_utils.js"),_utils=require("./utils.js");const XHTML_NS_ID=_namespaces.NamespaceIds.xhtml.id,VALID_STYLES=new Set(["color","font","font-family","font-size","font-stretch","font-style","font-weight","margin","margin-bottom","margin-left","margin-right","margin-top","letter-spacing","line-height","orphans","page-break-after","page-break-before","page-break-inside","tab-interval","tab-stop","text-align","text-decoration","text-indent","vertical-align","widows","kerning-mode","xfa-font-horizontal-scale","xfa-font-vertical-scale","xfa-spacerun","xfa-tab-stops"]),StyleMapping=new Map([["page-break-after","breakAfter"],["page-break-before","breakBefore"],["page-break-inside","breakInside"],["kerning-mode",t=>"none"===t?"none":"normal"],["xfa-font-horizontal-scale",t=>`scaleX(${Math.max(0,Math.min(parseInt(t)/100)).toFixed(2)})`],["xfa-font-vertical-scale",t=>`scaleY(${Math.max(0,Math.min(parseInt(t)/100)).toFixed(2)})`],["xfa-spacerun",""],["xfa-tab-stops",""],["font-size",(t,e)=>(t=e.fontSize=(0,_utils.getMeasurement)(t),(0,_html_utils.measureToString)(.99*t))],["letter-spacing",t=>(0,_html_utils.measureToString)((0,_utils.getMeasurement)(t))],["line-height",t=>(0,_html_utils.measureToString)((0,_utils.getMeasurement)(t))],["margin",t=>(0,_html_utils.measureToString)((0,_utils.getMeasurement)(t))],["margin-bottom",t=>(0,_html_utils.measureToString)((0,_utils.getMeasurement)(t))],["margin-left",t=>(0,_html_utils.measureToString)((0,_utils.getMeasurement)(t))],["margin-right",t=>(0,_html_utils.measureToString)((0,_utils.getMeasurement)(t))],["margin-top",t=>(0,_html_utils.measureToString)((0,_utils.getMeasurement)(t))],["text-indent",t=>(0,_html_utils.measureToString)((0,_utils.getMeasurement)(t))],["font-family",t=>t]]),spacesRegExp=/\s+/g,crlfRegExp=/[\r\n]+/g;function mapStyle(t,e){const s=Object.create(null);if(!t)return s;const a=Object.create(null);for(const[r,n]of t.split(";").map((t=>t.split(":",2)))){const t=StyleMapping.get(r);if(""===t)continue;let e=n;t&&(e="string"===typeof t?t:t(n,a)),r.endsWith("scale")?s.transform?s.transform=`${s[r]} ${e}`:s.transform=e:s[r.replaceAll(/-([a-zA-Z])/g,((t,e)=>e.toUpperCase()))]=e}return s.fontFamily&&(0,_html_utils.setFontFamily)({typeface:s.fontFamily,weight:s.fontWeight||"normal",posture:s.fontStyle||"normal",size:a.fontSize||0},e,e[_xfa_object.$globalData].fontFinder,s),(0,_html_utils.fixTextIndent)(s),s}function checkStyle(t){return t.style?t.style.trim().split(/\s*;\s*/).filter((t=>!!t)).map((t=>t.split(/\s*:\s*/,2))).filter((([e,s])=>("font-family"===e&&t[_xfa_object.$globalData].usedTypefaces.add(s),VALID_STYLES.has(e)))).map((t=>t.join(":"))).join(";"):""}const NoWhites=new Set(["body","html"]);class XhtmlObject extends _xfa_object.XmlObject{constructor(t,e){super(XHTML_NS_ID,e),this.style=t.style||""}[_xfa_object.$clean](t){super[_xfa_object.$clean](t),this.style=checkStyle(this)}[_xfa_object.$acceptWhitespace](){return!NoWhites.has(this[_xfa_object.$nodeName])}[_xfa_object.$onText](t){t=t.replace(crlfRegExp,""),this.style.includes("xfa-spacerun:yes")||(t=t.replace(spacesRegExp," ")),t&&(this[_xfa_object.$content]+=t)}[_xfa_object.$pushGlyphs](t,e=!0){const s=Object.create(null),a={top:NaN,bottom:NaN,left:NaN,right:NaN};let r=null;for(const[n,l]of this.style.split(";").map((t=>t.split(":",2))))switch(n){case"font-family":s.typeface=(0,_utils.stripQuotes)(l);break;case"font-size":s.size=(0,_utils.getMeasurement)(l);break;case"font-weight":s.weight=l;break;case"font-style":s.posture=l;break;case"letter-spacing":s.letterSpacing=(0,_utils.getMeasurement)(l);break;case"margin":const t=l.split(/ \t/).map((t=>(0,_utils.getMeasurement)(t)));switch(t.length){case 1:a.top=a.bottom=a.left=a.right=t[0];break;case 2:a.top=a.bottom=t[0],a.left=a.right=t[1];break;case 3:a.top=t[0],a.bottom=t[2],a.left=a.right=t[1];break;case 4:a.top=t[0],a.left=t[1],a.bottom=t[2],a.right=t[3];break}break;case"margin-top":a.top=(0,_utils.getMeasurement)(l);break;case"margin-bottom":a.bottom=(0,_utils.getMeasurement)(l);break;case"margin-left":a.left=(0,_utils.getMeasurement)(l);break;case"margin-right":a.right=(0,_utils.getMeasurement)(l);break;case"line-height":r=(0,_utils.getMeasurement)(l);break}if(t.pushData(s,a,r),this[_xfa_object.$content])t.addString(this[_xfa_object.$content]);else for(const n of this[_xfa_object.$getChildren]())"#text"!==n[_xfa_object.$nodeName]?n[_xfa_object.$pushGlyphs](t):t.addString(n[_xfa_object.$content]);e&&t.popFont()}[_xfa_object.$toHTML](t){const e=[];return this[_xfa_object.$extra]={children:e},this[_xfa_object.$childrenToHTML]({}),0!==e.length||this[_xfa_object.$content]?_utils.HTMLResult.success({name:this[_xfa_object.$nodeName],attributes:{href:this.href,style:mapStyle(this.style,this)},children:e,value:this[_xfa_object.$content]||""}):_utils.HTMLResult.EMPTY}}class A extends XhtmlObject{constructor(t){super(t,"a"),this.href=(0,_html_utils.fixURL)(t.href)||""}}class B extends XhtmlObject{constructor(t){super(t,"b")}[_xfa_object.$pushGlyphs](t){t.pushFont({weight:"bold"}),super[_xfa_object.$pushGlyphs](t),t.popFont()}}class Body extends XhtmlObject{constructor(t){super(t,"body")}[_xfa_object.$toHTML](t){const e=super[_xfa_object.$toHTML](t),{html:s}=e;return s?(s.name="div",s.attributes.class=["xfaRich"],e):_utils.HTMLResult.EMPTY}}class Br extends XhtmlObject{constructor(t){super(t,"br")}[_xfa_object.$text](){return"\n"}[_xfa_object.$pushGlyphs](t){t.addString("\n")}[_xfa_object.$toHTML](t){return _utils.HTMLResult.success({name:"br"})}}class Html extends XhtmlObject{constructor(t){super(t,"html")}[_xfa_object.$toHTML](t){const e=[];if(this[_xfa_object.$extra]={children:e},this[_xfa_object.$childrenToHTML]({}),0===e.length)return _utils.HTMLResult.success({name:"div",attributes:{class:["xfaRich"],style:{}},value:this[_xfa_object.$content]||""});if(1===e.length){const t=e[0];if(t.attributes&&t.attributes.class.includes("xfaRich"))return _utils.HTMLResult.success(t)}return _utils.HTMLResult.success({name:"div",attributes:{class:["xfaRich"],style:{}},children:e})}}class I extends XhtmlObject{constructor(t){super(t,"i")}[_xfa_object.$pushGlyphs](t){t.pushFont({posture:"italic"}),super[_xfa_object.$pushGlyphs](t),t.popFont()}}class Li extends XhtmlObject{constructor(t){super(t,"li")}}class Ol extends XhtmlObject{constructor(t){super(t,"ol")}}class P extends XhtmlObject{constructor(t){super(t,"p")}[_xfa_object.$pushGlyphs](t){super[_xfa_object.$pushGlyphs](t,!1),t.addString("\n"),t.addPara(),t.popFont()}[_xfa_object.$text](){return super[_xfa_object.$text]()+"\n"}}class Span extends XhtmlObject{constructor(t){super(t,"span")}}class Sub extends XhtmlObject{constructor(t){super(t,"sub")}}class Sup extends XhtmlObject{constructor(t){super(t,"sup")}}class Ul extends XhtmlObject{constructor(t){super(t,"ul")}}class XhtmlNamespace{static[_namespaces.$buildXFAObject](t,e){if(XhtmlNamespace.hasOwnProperty(t))return XhtmlNamespace[t](e)}static a(t){return new A(t)}static b(t){return new B(t)}static body(t){return new Body(t)}static br(t){return new Br(t)}static html(t){return new Html(t)}static i(t){return new I(t)}static li(t){return new Li(t)}static ol(t){return new Ol(t)}static p(t){return new P(t)}static span(t){return new Span(t)}static sub(t){return new Sub(t)}static sup(t){return new Sup(t)}static ul(t){return new Ul(t)}}exports.XhtmlNamespace=XhtmlNamespace;