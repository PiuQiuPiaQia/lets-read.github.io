"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.XFAParser=void 0;var _xfa_object=require("./xfa_object.js"),_xml_parser=require("../xml_parser.js"),_builder=require("./builder.js"),_util=require("../../shared/util.js");class XFAParser extends _xml_parser.XMLParserBase{constructor(){super(),this._builder=new _builder.Builder,this._stack=[],this._globalData={usedTypefaces:new Set},this._ids=new Map,this._current=this._builder.buildRoot(this._ids),this._errorCode=_xml_parser.XMLParserErrorCode.NoError,this._whiteRegex=/^\s+$/,this._nbsps=/\xa0+/g}parse(e){if(this.parseXml(e),this._errorCode===_xml_parser.XMLParserErrorCode.NoError)return this._current[_xfa_object.$finalize](),this._current.element}onText(e){e=e.replace(this._nbsps,(e=>e.slice(1)+" ")),this._current[_xfa_object.$acceptWhitespace]()?this._current[_xfa_object.$onText](e):this._whiteRegex.test(e)||this._current[_xfa_object.$onText](e.trim())}onCdata(e){this._current[_xfa_object.$onText](e)}_mkAttributes(e,t){let r=null,s=null;const i=Object.create({});for(const{name:_,value:n}of e)if("xmlns"===_)r?(0,_util.warn)(`XFA - multiple namespace definition in <${t}>`):r=n;else if(_.startsWith("xmlns:")){const e=_.substring("xmlns:".length);s||(s=[]),s.push({prefix:e,value:n})}else{const e=_.indexOf(":");if(-1===e)i[_]=n;else{let t=i[_xfa_object.$nsAttributes];t||(t=i[_xfa_object.$nsAttributes]=Object.create(null));const[r,s]=[_.slice(0,e),_.slice(e+1)];let a=t[r];a||(a=t[r]=Object.create(null)),a[s]=n}}return[r,s,i]}_getNameAndPrefix(e,t){const r=e.indexOf(":");return-1===r?[e,null]:[e.substring(r+1),t?"":e.substring(0,r)]}onBeginElement(e,t,r){const[s,i,_]=this._mkAttributes(t,e),[n,a]=this._getNameAndPrefix(e,this._builder.isNsAgnostic()),o=this._builder.build({nsPrefix:a,name:n,attributes:_,namespace:s,prefixes:i});if(o[_xfa_object.$globalData]=this._globalData,r)return o[_xfa_object.$finalize](),this._current[_xfa_object.$onChild](o)&&o[_xfa_object.$setId](this._ids),void o[_xfa_object.$clean](this._builder);this._stack.push(this._current),this._current=o}onEndElement(e){const t=this._current;if(t[_xfa_object.$isCDATAXml]()&&"string"===typeof t[_xfa_object.$content]){const e=new XFAParser;e._globalData=this._globalData;const r=e.parse(t[_xfa_object.$content]);t[_xfa_object.$content]=null,t[_xfa_object.$onChild](r)}t[_xfa_object.$finalize](),this._current=this._stack.pop(),this._current[_xfa_object.$onChild](t)&&t[_xfa_object.$setId](this._ids),t[_xfa_object.$clean](this._builder)}onError(e){this._errorCode=e}}exports.XFAParser=XFAParser;