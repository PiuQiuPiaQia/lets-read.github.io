"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.createDataNode=createDataNode,exports.searchNode=searchNode;var _xfa_object=require("./xfa_object.js"),_namespaces=require("./namespaces.js"),_util=require("../../shared/util.js");const namePattern=/^[^.[]+/,indexPattern=/^[^\]]+/,operators={dot:0,dotDot:1,dotHash:2,dotBracket:3,dotParen:4},shortcuts=new Map([["$data",(e,t)=>e.datasets?e.datasets.data:e],["$record",(e,t)=>(e.datasets?e.datasets.data:e)[_xfa_object.$getChildren]()[0]],["$template",(e,t)=>e.template],["$connectionSet",(e,t)=>e.connectionSet],["$form",(e,t)=>e.form],["$layout",(e,t)=>e.layout],["$host",(e,t)=>e.host],["$dataWindow",(e,t)=>e.dataWindow],["$event",(e,t)=>e.event],["!",(e,t)=>e.datasets],["$xfa",(e,t)=>e],["xfa",(e,t)=>e],["$",(e,t)=>t]]),somCache=new WeakMap,NS_DATASETS=_namespaces.NamespaceIds.datasets.id;function parseIndex(e){return e=e.trim(),"*"===e?1/0:parseInt(e,10)||0}function parseExpression(e,t,a=!0){let r=e.match(namePattern);if(!r)return null;let[n]=r;const o=[{name:n,cacheName:"."+n,index:0,js:null,formCalc:null,operator:operators.dot}];let s=n.length;while(s<e.length){const c=s,i=e.charAt(s++);if("["===i){if(r=e.slice(s).match(indexPattern),!r)return(0,_util.warn)("XFA - Invalid index in SOM expression"),null;o[o.length-1].index=parseIndex(r[0]),s+=r[0].length+1;continue}let l;switch(e.charAt(s)){case".":if(!t)return null;s++,l=operators.dotDot;break;case"#":s++,l=operators.dotHash;break;case"[":if(a)return(0,_util.warn)("XFA - SOM expression contains a FormCalc subexpression which is not supported for now."),null;l=operators.dotBracket;break;case"(":if(a)return(0,_util.warn)("XFA - SOM expression contains a JavaScript subexpression which is not supported for now."),null;l=operators.dotParen;break;default:l=operators.dot;break}if(r=e.slice(s).match(namePattern),!r)break;[n]=r,s+=n.length,o.push({name:n,cacheName:e.slice(c,s),operator:l,index:0,js:null,formCalc:null})}return o}function searchNode(e,t,a,r=!0,n=!0){const o=parseExpression(a,r);if(!o)return null;const s=shortcuts.get(o[0].name);let c,i=0;s?(c=!0,e=[s(e,t)],i=1):(c=null===t,e=[t||e]);for(let l=o.length;i<l;i++){const{name:a,cacheName:r,operator:s,index:l}=o[i],d=[];for(const t of e){if(!(t instanceof _xfa_object.XFAObject))continue;let e,o;if(n&&(o=somCache.get(t),o||(o=new Map,somCache.set(t,o)),e=o.get(r)),!e){switch(s){case operators.dot:e=t[_xfa_object.$getChildrenByName](a,!1);break;case operators.dotDot:e=t[_xfa_object.$getChildrenByName](a,!0);break;case operators.dotHash:e=t[_xfa_object.$getChildrenByClass](a),e=e instanceof _xfa_object.XFAObjectArray?e.children:[e];break;default:break}n&&o.set(r,e)}e.length>0&&d.push(e)}if(0!==d.length||c||0!==i)e=isFinite(l)?d.filter((e=>l<e.length)).map((e=>e[l])):d.reduce(((e,t)=>e.concat(t)),[]);else{const a=t[_xfa_object.$getParent]();if(t=a,!t)return null;i=-1,e=[t]}}return 0===e.length?null:e}function createNodes(e,t){let a=null;for(const{name:r,index:n}of t){for(let t=0,o=isFinite(n)?n:0;t<=o;t++){const t=e[_xfa_object.$namespaceId]===NS_DATASETS?-1:e[_xfa_object.$namespaceId];a=new _xfa_object.XmlObject(t,r),e[_xfa_object.$appendChild](a)}e=a}return a}function createDataNode(e,t,a){const r=parseExpression(a);if(!r)return null;if(r.some((e=>e.operator===operators.dotDot)))return null;const n=shortcuts.get(r[0].name);let o=0;n?(e=n(e,t),o=1):e=t||e;for(let s=r.length;o<s;o++){const{name:t,operator:a,index:n}=r[o];if(!isFinite(n))return r[o].index=0,createNodes(e,r.slice(o));let s;switch(a){case operators.dot:s=e[_xfa_object.$getChildrenByName](t,!1);break;case operators.dotDot:s=e[_xfa_object.$getChildrenByName](t,!0);break;case operators.dotHash:s=e[_xfa_object.$getChildrenByClass](t),s=s instanceof _xfa_object.XFAObjectArray?s.children:[s];break;default:break}if(0===s.length)return createNodes(e,r.slice(o));if(!(n<s.length))return r[o].index=n-s.length,createNodes(e,r.slice(o));{const t=s[n];if(!(t instanceof _xfa_object.XFAObject))return(0,_util.warn)("XFA - Cannot create a node."),null;e=t}}return null}