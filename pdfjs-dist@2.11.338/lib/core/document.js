"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PDFDocument=exports.Page=void 0;var _util=require("../shared/util.js"),_primitives=require("./primitives.js"),_core_utils=require("./core_utils.js"),_xfa_fonts=require("./xfa_fonts.js"),_stream=require("./stream.js"),_annotation=require("./annotation.js"),_base_stream=require("./base_stream.js"),_crypto=require("./crypto.js"),_catalog=require("./catalog.js"),_parser=require("./parser.js"),_object_loader=require("./object_loader.js"),_operator_list=require("./operator_list.js"),_evaluator=require("./evaluator.js"),_decode_stream=require("./decode_stream.js"),_struct_tree=require("./struct_tree.js"),_factory=require("./xfa/factory.js"),_xref=require("./xref.js");const DEFAULT_USER_UNIT=1,LETTER_SIZE_MEDIABOX=[0,0,612,792];class Page{constructor({pdfManager:t,xref:e,pageIndex:a,pageDict:r,ref:i,globalIdFactory:n,fontCache:s,builtInCMapCache:o,standardFontDataCache:l,globalImageCache:c,nonBlendModesSet:h,xfaFactory:u}){this.pdfManager=t,this.pageIndex=a,this.pageDict=r,this.xref=e,this.ref=i,this.fontCache=s,this.builtInCMapCache=o,this.standardFontDataCache=l,this.globalImageCache=c,this.nonBlendModesSet=h,this.evaluatorOptions=t.evaluatorOptions,this.resourcesPromise=null,this.xfaFactory=u;const g={obj:0};this._localIdFactory=class extends n{static createObjId(){return`p${a}_${++g.obj}`}static getPageObjId(){return`page${i.toString()}`}}}_getInheritableProperty(t,e=!1){const a=(0,_core_utils.getInheritableProperty)({dict:this.pageDict,key:t,getArray:e,stopWhenFound:!1});return Array.isArray(a)?1!==a.length&&(0,_primitives.isDict)(a[0])?_primitives.Dict.merge({xref:this.xref,dictArray:a}):a[0]:a}get content(){return this.pageDict.getArray("Contents")}get resources(){return(0,_util.shadow)(this,"resources",this._getInheritableProperty("Resources")||_primitives.Dict.empty)}_getBoundingBox(t){if(this.xfaData)return this.xfaData.bbox;const e=this._getInheritableProperty(t,!0);if(Array.isArray(e)&&4===e.length){if(e[2]-e[0]!==0&&e[3]-e[1]!==0)return e;(0,_util.warn)(`Empty /${t} entry.`)}return null}get mediaBox(){return(0,_util.shadow)(this,"mediaBox",this._getBoundingBox("MediaBox")||LETTER_SIZE_MEDIABOX)}get cropBox(){return(0,_util.shadow)(this,"cropBox",this._getBoundingBox("CropBox")||this.mediaBox)}get userUnit(){let t=this.pageDict.get("UserUnit");return(!(0,_util.isNum)(t)||t<=0)&&(t=DEFAULT_USER_UNIT),(0,_util.shadow)(this,"userUnit",t)}get view(){const{cropBox:t,mediaBox:e}=this;let a;if(t===e||(0,_util.isArrayEqual)(t,e))a=e;else{const r=_util.Util.intersect(t,e);r&&r[2]-r[0]!==0&&r[3]-r[1]!==0?a=r:(0,_util.warn)("Empty /CropBox and /MediaBox intersection.")}return(0,_util.shadow)(this,"view",a||e)}get rotate(){let t=this._getInheritableProperty("Rotate")||0;return t%90!==0?t=0:t>=360?t%=360:t<0&&(t=(t%360+360)%360),(0,_util.shadow)(this,"rotate",t)}_onSubStreamError(t,e,a){if(this.evaluatorOptions.ignoreErrors)return t.send("UnsupportedFeature",{featureId:_util.UNSUPPORTED_FEATURES.errorContentSubStream}),void(0,_util.warn)(`getContentStream - ignoring sub-stream (${a}): "${e}".`);throw e}getContentStream(t){return this.pdfManager.ensure(this,"content").then((e=>e instanceof _base_stream.BaseStream?e:Array.isArray(e)?new _decode_stream.StreamsSequenceStream(e,this._onSubStreamError.bind(this,t)):new _stream.NullStream))}get xfaData(){return this.xfaFactory?(0,_util.shadow)(this,"xfaData",{bbox:this.xfaFactory.getBoundingBox(this.pageIndex)}):(0,_util.shadow)(this,"xfaData",null)}save(t,e,a){const r=new _evaluator.PartialEvaluator({xref:this.xref,handler:t,pageIndex:this.pageIndex,idFactory:this._localIdFactory,fontCache:this.fontCache,builtInCMapCache:this.builtInCMapCache,standardFontDataCache:this.standardFontDataCache,globalImageCache:this.globalImageCache,options:this.evaluatorOptions});return this._parsedAnnotations.then((function(t){const i=[];for(const n of t)n.mustBePrinted(a)&&i.push(n.save(r,e,a).catch((function(t){return(0,_util.warn)(`save - ignoring annotation data during "${e.name}" task: "${t}".`),null})));return Promise.all(i)}))}loadResources(t){return this.resourcesPromise||(this.resourcesPromise=this.pdfManager.ensure(this,"resources")),this.resourcesPromise.then((()=>{const e=new _object_loader.ObjectLoader(this.resources,t,this.xref);return e.load()}))}getOperatorList({handler:t,sink:e,task:a,intent:r,cacheKey:i,annotationStorage:n=null}){const s=this.getContentStream(t),o=this.loadResources(["ColorSpace","ExtGState","Font","Pattern","Properties","Shading","XObject"]),l=new _evaluator.PartialEvaluator({xref:this.xref,handler:t,pageIndex:this.pageIndex,idFactory:this._localIdFactory,fontCache:this.fontCache,builtInCMapCache:this.builtInCMapCache,standardFontDataCache:this.standardFontDataCache,globalImageCache:this.globalImageCache,options:this.evaluatorOptions}),c=Promise.all([s,o]),h=c.then((([n])=>{const s=new _operator_list.OperatorList(r,e);return t.send("StartRenderPage",{transparency:l.hasBlendModes(this.resources,this.nonBlendModesSet),pageIndex:this.pageIndex,cacheKey:i}),l.getOperatorList({stream:n,task:a,resources:this.resources,operatorList:s}).then((function(){return s}))}));return Promise.all([h,this._parsedAnnotations]).then((function([t,e]){if(0===e.length||r&_util.RenderingIntentFlag.ANNOTATIONS_DISABLE)return t.flush(!0),{length:t.totalLength};const i=!!(r&_util.RenderingIntentFlag.ANNOTATIONS_FORMS),s=!!(r&_util.RenderingIntentFlag.ANY),o=!!(r&_util.RenderingIntentFlag.DISPLAY),c=!!(r&_util.RenderingIntentFlag.PRINT),h=[];for(const r of e)(s||o&&r.mustBeViewed(n)||c&&r.mustBePrinted(n))&&h.push(r.getOperatorList(l,a,i,n).catch((function(t){return(0,_util.warn)(`getOperatorList - ignoring annotation data during "${a.name}" task: "${t}".`),null})));return Promise.all(h).then((function(e){t.addOp(_util.OPS.beginAnnotations,[]);for(const a of e)t.addOpList(a);return t.addOp(_util.OPS.endAnnotations,[]),t.flush(!0),{length:t.totalLength}}))}))}extractTextContent({handler:t,task:e,normalizeWhitespace:a,includeMarkedContent:r,sink:i,combineTextItems:n}){const s=this.getContentStream(t),o=this.loadResources(["ExtGState","Font","Properties","XObject"]),l=Promise.all([s,o]);return l.then((([s])=>{const o=new _evaluator.PartialEvaluator({xref:this.xref,handler:t,pageIndex:this.pageIndex,idFactory:this._localIdFactory,fontCache:this.fontCache,builtInCMapCache:this.builtInCMapCache,standardFontDataCache:this.standardFontDataCache,globalImageCache:this.globalImageCache,options:this.evaluatorOptions});return o.getTextContent({stream:s,task:e,resources:this.resources,normalizeWhitespace:a,includeMarkedContent:r,combineTextItems:n,sink:i})}))}async getStructTree(){const t=await this.pdfManager.ensureCatalog("structTreeRoot");if(!t)return null;const e=await this.pdfManager.ensure(this,"_parseStructTree",[t]);return e.serializable}_parseStructTree(t){const e=new _struct_tree.StructTreePage(t,this.pageDict);return e.parse(),e}getAnnotationsData(t){return this._parsedAnnotations.then((function(e){const a=[];if(0===e.length)return a;const r=!!(t&_util.RenderingIntentFlag.ANY),i=!!(t&_util.RenderingIntentFlag.DISPLAY),n=!!(t&_util.RenderingIntentFlag.PRINT);for(const t of e)(r||i&&t.viewable||n&&t.printable)&&a.push(t.data);return a}))}get annotations(){const t=this._getInheritableProperty("Annots");return(0,_util.shadow)(this,"annotations",Array.isArray(t)?t:[])}get _parsedAnnotations(){const t=this.pdfManager.ensure(this,"annotations").then((()=>{const t=[];for(const e of this.annotations)t.push(_annotation.AnnotationFactory.create(this.xref,e,this.pdfManager,this._localIdFactory,!1).catch((function(t){return(0,_util.warn)(`_parsedAnnotations: "${t}".`),null})));return Promise.all(t).then((function(t){return t.filter((t=>!!t))}))}));return(0,_util.shadow)(this,"_parsedAnnotations",t)}get jsActions(){const t=(0,_core_utils.collectActions)(this.xref,this.pageDict,_util.PageActionEventType);return(0,_util.shadow)(this,"jsActions",t)}}exports.Page=Page;const PDF_HEADER_SIGNATURE=new Uint8Array([37,80,68,70,45]),STARTXREF_SIGNATURE=new Uint8Array([115,116,97,114,116,120,114,101,102]),ENDOBJ_SIGNATURE=new Uint8Array([101,110,100,111,98,106]),FINGERPRINT_FIRST_BYTES=1024,EMPTY_FINGERPRINT="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0",PDF_HEADER_VERSION_REGEXP=/^[1-9]\.\d$/;function find(t,e,a=1024,r=!1){const i=e.length,n=t.peekBytes(a),s=n.length-i;if(s<=0)return!1;if(r){const a=i-1;let r=n.length-1;while(r>=a){let s=0;while(s<i&&n[r-s]===e[a-s])s++;if(s>=i)return t.pos+=r-a,!0;r--}}else{let a=0;while(a<=s){let r=0;while(r<i&&n[a+r]===e[r])r++;if(r>=i)return t.pos+=a,!0;a++}}return!1}class PDFDocument{constructor(t,e){let a;if((0,_primitives.isStream)(e))a=e;else{if(!(0,_util.isArrayBuffer)(e))throw new Error("PDFDocument: Unknown argument type");a=new _stream.Stream(e)}if(a.length<=0)throw new _util.InvalidPDFException("The PDF file is empty, i.e. its size is zero bytes.");this.pdfManager=t,this.stream=a,this.xref=new _xref.XRef(a,t),this._pagePromises=[],this._version=null;const r={font:0};this._globalIdFactory=class{static getDocId(){return`g_${t.docId}`}static createFontId(){return"f"+ ++r.font}static createObjId(){(0,_util.unreachable)("Abstract method `createObjId` called.")}static getPageObjId(){(0,_util.unreachable)("Abstract method `getPageObjId` called.")}}}parse(t){this.xref.parse(t),this.catalog=new _catalog.Catalog(this.pdfManager,this.xref),this.catalog.version&&(this._version=this.catalog.version)}get linearization(){let t=null;try{t=_parser.Linearization.create(this.stream)}catch(e){if(e instanceof _core_utils.MissingDataException)throw e;(0,_util.info)(e)}return(0,_util.shadow)(this,"linearization",t)}get startXRef(){const t=this.stream;let e=0;if(this.linearization)t.reset(),find(t,ENDOBJ_SIGNATURE)&&(e=t.pos+6-t.start);else{const a=1024,r=STARTXREF_SIGNATURE.length;let i=!1,n=t.end;while(!i&&n>0)n-=a-r,n<0&&(n=0),t.pos=n,i=find(t,STARTXREF_SIGNATURE,a,!0);if(i){let a;t.skip(9);do{a=t.getByte()}while((0,_core_utils.isWhiteSpace)(a));let r="";while(a>=32&&a<=57)r+=String.fromCharCode(a),a=t.getByte();e=parseInt(r,10),isNaN(e)&&(e=0)}}return(0,_util.shadow)(this,"startXRef",e)}checkHeader(){const t=this.stream;if(t.reset(),!find(t,PDF_HEADER_SIGNATURE))return;t.moveStart();const e=12;let a,r="";while((a=t.getByte())>32){if(r.length>=e)break;r+=String.fromCharCode(a)}this._version||(this._version=r.substring(5))}parseStartXRef(){this.xref.setStartXRef(this.startXRef)}get numPages(){if(this.xfaFactory)return(0,_util.shadow)(this,"numPages",this.xfaFactory.numberPages);const t=this.linearization,e=t?t.numPages:this.catalog.numPages;return(0,_util.shadow)(this,"numPages",e)}_hasOnlyDocumentSignatures(t,e=0){const a=10;return!!Array.isArray(t)&&t.every((t=>{if(t=this.xref.fetchIfRef(t),!(t instanceof _primitives.Dict))return!1;if(t.has("Kids"))return++e>a?((0,_util.warn)("_hasOnlyDocumentSignatures: maximum recursion depth reached"),!1):this._hasOnlyDocumentSignatures(t.get("Kids"),e);const r=(0,_primitives.isName)(t.get("FT"),"Sig"),i=t.get("Rect"),n=Array.isArray(i)&&i.every((t=>0===t));return r&&n}))}get xfaData(){const t=this.catalog.acroForm;if(!t)return null;const e=t.get("XFA"),a={"xdp:xdp":"",template:"",datasets:"",config:"",connectionSet:"",localeSet:"",stylesheet:"","/xdp:xdp":""};if((0,_primitives.isStream)(e)&&!e.isEmpty)try{return a["xdp:xdp"]=(0,_util.stringToUTF8String)(e.getString()),a}catch(r){return(0,_util.warn)("XFA - Invalid utf-8 string."),null}if(!Array.isArray(e)||0===e.length)return null;for(let i=0,n=e.length;i<n;i+=2){let t;if(t=0===i?"xdp:xdp":i===n-2?"/xdp:xdp":e[i],!a.hasOwnProperty(t))continue;const s=this.xref.fetchIfRef(e[i+1]);if((0,_primitives.isStream)(s)&&!s.isEmpty)try{a[t]=(0,_util.stringToUTF8String)(s.getString())}catch(r){return(0,_util.warn)("XFA - Invalid utf-8 string."),null}}return a}get xfaFactory(){if(this.pdfManager.enableXfa&&this.catalog.needsRendering&&this.formInfo.hasXfa&&!this.formInfo.hasAcroForm){const t=this.xfaData;return(0,_util.shadow)(this,"xfaFactory",t?new _factory.XFAFactory(t):null)}return(0,_util.shadow)(this,"xfaFaxtory",null)}get isPureXfa(){return this.xfaFactory&&this.xfaFactory.isValid()}get htmlForXfa(){return this.xfaFactory?this.xfaFactory.getPages():null}async loadXfaImages(){const t=await this.pdfManager.ensureCatalog("xfaImages");if(!t)return;const e=t.getKeys(),a=new _object_loader.ObjectLoader(t,e,this.xref);await a.load();const r=new Map;for(const i of e){const e=t.get(i);(0,_primitives.isStream)(e)&&r.set(i,e.getBytes())}this.xfaFactory.setImages(r)}async loadXfaFonts(t,e){const a=await this.pdfManager.ensureCatalog("acroForm");if(!a)return;const r=await a.getAsync("DR");if(!(r instanceof _primitives.Dict))return;const i=new _object_loader.ObjectLoader(r,["Font"],this.xref);await i.load();const n=r.get("Font");if(!(n instanceof _primitives.Dict))return;const s=Object.assign(Object.create(null),this.pdfManager.evaluatorOptions);s.useSystemFonts=!1;const o=new _evaluator.PartialEvaluator({xref:this.xref,handler:t,pageIndex:-1,idFactory:this._globalIdFactory,fontCache:this.catalog.fontCache,builtInCMapCache:this.catalog.builtInCMapCache,standardFontDataCache:this.catalog.standardFontDataCache,options:s}),l=new _operator_list.OperatorList,c=[],h={get font(){return c[c.length-1]},set font(t){c.push(t)},clone(){return this}},u=new Map;n.forEach(((t,e)=>{u.set(t,e)}));const g=[];for(const[_,p]of u){const t=p.get("FontDescriptor");if(!(t instanceof _primitives.Dict))continue;let a=t.get("FontFamily");a=a.replace(/[ ]+(\d)/g,"$1");const i=t.get("FontWeight"),n=-t.get("ItalicAngle"),s={fontFamily:a,fontWeight:i,italicAngle:n};(0,_core_utils.validateCSSFont)(s)&&g.push(o.handleSetFont(r,[_primitives.Name.get(_),1],null,l,e,h,null,s).catch((function(t){return(0,_util.warn)(`loadXfaFonts: "${t}".`),null})))}await Promise.all(g);const f=this.xfaFactory.setFonts(c);if(!f)return;s.ignoreErrors=!0,g.length=0,c.length=0;const d=new Set;for(const _ of f)(0,_xfa_fonts.getXfaFontName)(`${_}-Regular`)||d.add(_);d.size&&f.push("PdfJS-Fallback");for(const _ of f)if(!d.has(_))for(const t of[{name:"Regular",fontWeight:400,italicAngle:0},{name:"Bold",fontWeight:700,italicAngle:0},{name:"Italic",fontWeight:400,italicAngle:12},{name:"BoldItalic",fontWeight:700,italicAngle:12}]){const a=`${_}-${t.name}`,i=(0,_xfa_fonts.getXfaFontDict)(a);g.push(o.handleSetFont(r,[_primitives.Name.get(a),1],null,l,e,h,i,{fontFamily:_,fontWeight:t.fontWeight,italicAngle:t.italicAngle}).catch((function(t){return(0,_util.warn)(`loadXfaFonts: "${t}".`),null})))}await Promise.all(g),this.xfaFactory.appendFonts(c,d)}async serializeXfaData(t){return this.xfaFactory?this.xfaFactory.serializeData(t):null}get formInfo(){const t={hasFields:!1,hasAcroForm:!1,hasXfa:!1,hasSignatures:!1},e=this.catalog.acroForm;if(!e)return(0,_util.shadow)(this,"formInfo",t);try{const a=e.get("Fields"),r=Array.isArray(a)&&a.length>0;t.hasFields=r;const i=e.get("XFA");t.hasXfa=Array.isArray(i)&&i.length>0||(0,_primitives.isStream)(i)&&!i.isEmpty;const n=e.get("SigFlags"),s=!!(1&n),o=s&&this._hasOnlyDocumentSignatures(a);t.hasAcroForm=r&&!o,t.hasSignatures=s}catch(a){if(a instanceof _core_utils.MissingDataException)throw a;(0,_util.warn)(`Cannot fetch form information: "${a}".`)}return(0,_util.shadow)(this,"formInfo",t)}get documentInfo(){const t={Title:_util.isString,Author:_util.isString,Subject:_util.isString,Keywords:_util.isString,Creator:_util.isString,Producer:_util.isString,CreationDate:_util.isString,ModDate:_util.isString,Trapped:_primitives.isName};let e=this._version;"string"===typeof e&&PDF_HEADER_VERSION_REGEXP.test(e)||((0,_util.warn)(`Invalid PDF header version number: ${e}`),e=null);const a={PDFFormatVersion:e,IsLinearized:!!this.linearization,IsAcroFormPresent:this.formInfo.hasAcroForm,IsXFAPresent:this.formInfo.hasXfa,IsCollectionPresent:!!this.catalog.collection,IsSignaturesPresent:this.formInfo.hasSignatures};let r;try{r=this.xref.trailer.get("Info")}catch(i){if(i instanceof _core_utils.MissingDataException)throw i;(0,_util.info)("The document information dictionary is invalid.")}if((0,_primitives.isDict)(r))for(const n of r.getKeys()){const e=r.get(n);if(t[n])t[n](e)?a[n]="string"!==typeof e?e:(0,_util.stringToPDFString)(e):(0,_util.info)(`Bad value in document info for "${n}".`);else if("string"===typeof n){let t;if((0,_util.isString)(e))t=(0,_util.stringToPDFString)(e);else{if(!((0,_primitives.isName)(e)||(0,_util.isNum)(e)||(0,_util.isBool)(e))){(0,_util.info)(`Unsupported value in document info for (custom) "${n}".`);continue}t=e}a.Custom||(a.Custom=Object.create(null)),a.Custom[n]=t}}return(0,_util.shadow)(this,"documentInfo",a)}get fingerprints(){function t(t){return"string"===typeof t&&t.length>0&&t!==EMPTY_FINGERPRINT}function e(t){const e=[];for(let a=0,r=t.length;a<r;a++){const r=t[a].toString(16);e.push(r.padStart(2,"0"))}return e.join("")}const a=this.xref.trailer.get("ID");let r,i;return Array.isArray(a)&&t(a[0])?(r=(0,_util.stringToBytes)(a[0]),a[1]!==a[0]&&t(a[1])&&(i=(0,_util.stringToBytes)(a[1]))):r=(0,_crypto.calculateMD5)(this.stream.getByteRange(0,FINGERPRINT_FIRST_BYTES),0,FINGERPRINT_FIRST_BYTES),(0,_util.shadow)(this,"fingerprints",[e(r),i?e(i):null])}_getLinearizationPage(t){const{catalog:e,linearization:a}=this,r=_primitives.Ref.get(a.objectNumberFirst,0);return this.xref.fetchAsync(r).then((t=>{if((0,_primitives.isDict)(t,"Page")||(0,_primitives.isDict)(t)&&!t.has("Type")&&t.has("Contents"))return r&&!e.pageKidsCountCache.has(r)&&e.pageKidsCountCache.put(r,1),[t,r];throw new _util.FormatError("The Linearization dictionary doesn't point to a valid Page dictionary.")})).catch((a=>((0,_util.info)(a),e.getPageDict(t))))}getPage(t){if(void 0!==this._pagePromises[t])return this._pagePromises[t];const{catalog:e,linearization:a}=this;if(this.xfaFactory)return Promise.resolve(new Page({pdfManager:this.pdfManager,xref:this.xref,pageIndex:t,pageDict:_primitives.Dict.empty,ref:null,globalIdFactory:this._globalIdFactory,fontCache:e.fontCache,builtInCMapCache:e.builtInCMapCache,standardFontDataCache:e.standardFontDataCache,globalImageCache:e.globalImageCache,nonBlendModesSet:e.nonBlendModesSet,xfaFactory:this.xfaFactory}));const r=a&&a.pageFirst===t?this._getLinearizationPage(t):e.getPageDict(t);return this._pagePromises[t]=r.then((([a,r])=>new Page({pdfManager:this.pdfManager,xref:this.xref,pageIndex:t,pageDict:a,ref:r,globalIdFactory:this._globalIdFactory,fontCache:e.fontCache,builtInCMapCache:e.builtInCMapCache,standardFontDataCache:e.standardFontDataCache,globalImageCache:e.globalImageCache,nonBlendModesSet:e.nonBlendModesSet,xfaFactory:null})))}checkFirstPage(){return this.getPage(0).catch((async t=>{if(t instanceof _core_utils.XRefEntryException)throw this._pagePromises.length=0,await this.cleanup(),new _core_utils.XRefParseException}))}fontFallback(t,e){return this.catalog.fontFallback(t,e)}async cleanup(t=!1){return this.catalog?this.catalog.cleanup(t):(0,_primitives.clearPrimitiveCaches)()}_collectFieldObjects(t,e,a){const r=this.xref.fetchIfRef(e);if(r.has("T")){const e=(0,_util.stringToPDFString)(r.get("T"));t=""===t?e:`${t}.${e}`}if(a.has(t)||a.set(t,[]),a.get(t).push(_annotation.AnnotationFactory.create(this.xref,e,this.pdfManager,this._localIdFactory,!0).then((t=>t&&t.getFieldObject())).catch((function(t){return(0,_util.warn)(`_collectFieldObjects: "${t}".`),null}))),r.has("Kids")){const e=r.get("Kids");for(const r of e)this._collectFieldObjects(t,r,a)}}get fieldObjects(){if(!this.formInfo.hasFields)return(0,_util.shadow)(this,"fieldObjects",Promise.resolve(null));const t=Object.create(null),e=new Map;for(const r of this.catalog.acroForm.get("Fields"))this._collectFieldObjects("",r,e);const a=[];for(const[r,i]of e)a.push(Promise.all(i).then((e=>{e=e.filter((t=>!!t)),e.length>0&&(t[r]=e)})));return(0,_util.shadow)(this,"fieldObjects",Promise.all(a).then((()=>t)))}get hasJSActions(){const t=this.pdfManager.ensureDoc("_parseHasJSActions");return(0,_util.shadow)(this,"hasJSActions",t)}async _parseHasJSActions(){const[t,e]=await Promise.all([this.pdfManager.ensureCatalog("jsActions"),this.pdfManager.ensureDoc("fieldObjects")]);return!!t||!!e&&Object.values(e).some((t=>t.some((t=>null!==t.actions))))}get calculationOrderIds(){const t=this.catalog.acroForm;if(!t||!t.has("CO"))return(0,_util.shadow)(this,"calculationOrderIds",null);const e=t.get("CO");if(!Array.isArray(e)||0===e.length)return(0,_util.shadow)(this,"calculationOrderIds",null);const a=e.filter(_primitives.isRef).map((t=>t.toString()));return 0===a.length?(0,_util.shadow)(this,"calculationOrderIds",null):(0,_util.shadow)(this,"calculationOrderIds",a)}}exports.PDFDocument=PDFDocument;