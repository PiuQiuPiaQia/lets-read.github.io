"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PDFAttachmentViewer=void 0;var _pdf=require("../pdf"),_base_tree_viewer=require("./base_tree_viewer.js");class PDFAttachmentViewer extends _base_tree_viewer.BaseTreeViewer{constructor(e){super(e),this.downloadManager=e.downloadManager,this.eventBus._on("fileattachmentannotation",this._appendAttachment.bind(this))}reset(e=!1){super.reset(),this._attachments=null,e||(this._renderedCapability=(0,_pdf.createPromiseCapability)()),this._pendingDispatchEvent&&clearTimeout(this._pendingDispatchEvent),this._pendingDispatchEvent=null}_dispatchEvent(e){this._renderedCapability.resolve(),this._pendingDispatchEvent&&(clearTimeout(this._pendingDispatchEvent),this._pendingDispatchEvent=null),0!==e?this.eventBus.dispatch("attachmentsloaded",{source:this,attachmentsCount:e}):this._pendingDispatchEvent=setTimeout((()=>{this.eventBus.dispatch("attachmentsloaded",{source:this,attachmentsCount:0}),this._pendingDispatchEvent=null}))}_bindLink(e,{content:t,filename:n}){e.onclick=()=>(this.downloadManager.openOrDownloadData(e,t,n),!1)}render({attachments:e,keepRenderedCapability:t=!1}){if(this._attachments&&this.reset(t),this._attachments=e||null,!e)return void this._dispatchEvent(0);const n=Object.keys(e).sort((function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())})),i=document.createDocumentFragment();let a=0;for(const s of n){const t=e[s],n=t.content,r=(0,_pdf.getFilenameFromUrl)(t.filename),c=document.createElement("div");c.className="treeItem";const o=document.createElement("a");this._bindLink(o,{content:n,filename:r}),o.textContent=this._normalizeTextContent(r),c.appendChild(o),i.appendChild(c),a++}this._finishRendering(i,a)}_appendAttachment({id:e,filename:t,content:n}){const i=this._renderedCapability.promise;i.then((()=>{if(i!==this._renderedCapability.promise)return;let a=this._attachments;if(a){for(const t in a)if(e===t)return}else a=Object.create(null);a[e]={filename:t,content:n},this.render({attachments:a,keepRenderedCapability:!0})}))}}exports.PDFAttachmentViewer=PDFAttachmentViewer;