"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PDFOutlineViewer=void 0;var _base_tree_viewer=require("./base_tree_viewer.js"),_pdf=require("../pdf"),_ui_utils=require("./ui_utils.js");class PDFOutlineViewer extends _base_tree_viewer.BaseTreeViewer{constructor(e){super(e),this.linkService=e.linkService,this.eventBus._on("toggleoutlinetree",this._toggleAllTreeItems.bind(this)),this.eventBus._on("currentoutlineitem",this._currentOutlineItem.bind(this)),this.eventBus._on("pagechanging",(e=>{this._currentPageNumber=e.pageNumber})),this.eventBus._on("pagesloaded",(e=>{this._isPagesLoaded=!!e.pagesCount,this._currentOutlineItemCapability&&!this._currentOutlineItemCapability.settled&&this._currentOutlineItemCapability.resolve(this._isPagesLoaded)})),this.eventBus._on("sidebarviewchanged",(e=>{this._sidebarView=e.view}))}reset(){super.reset(),this._outline=null,this._pageNumberToDestHashCapability=null,this._currentPageNumber=1,this._isPagesLoaded=!1,this._currentOutlineItemCapability&&!this._currentOutlineItemCapability.settled&&this._currentOutlineItemCapability.resolve(!1),this._currentOutlineItemCapability=null}_dispatchEvent(e){this._currentOutlineItemCapability=(0,_pdf.createPromiseCapability)(),0===e||this._pdfDocument?.loadingParams.disableAutoFetch?this._currentOutlineItemCapability.resolve(!1):this._isPagesLoaded&&this._currentOutlineItemCapability.resolve(!0),this.eventBus.dispatch("outlineloaded",{source:this,outlineCount:e,currentOutlineItemPromise:this._currentOutlineItemCapability.promise})}_bindLink(e,{url:t,newWindow:i,dest:s}){const{linkService:n}=this;t?n.addLinkAttributes(e,t,i):(e.href=n.getDestinationHash(s),e.onclick=e=>(this._updateCurrentTreeItem(e.target.parentNode),s&&n.goToDestination(s),!1))}_setStyles(e,{bold:t,italic:i}){t&&(e.style.fontWeight="bold"),i&&(e.style.fontStyle="italic")}_addToggleButton(e,{count:t,items:i}){let s=!1;if(t<0){let e=i.length;if(e>0){const t=[...i];while(t.length>0){const{count:i,items:s}=t.shift();i>0&&s.length>0&&(e+=s.length,t.push(...s))}}Math.abs(t)===e&&(s=!0)}super._addToggleButton(e,s)}_toggleAllTreeItems(){this._outline&&super._toggleAllTreeItems()}render({outline:e,pdfDocument:t}){if(this._outline&&this.reset(),this._outline=e||null,this._pdfDocument=t||null,!e)return void this._dispatchEvent(0);const i=document.createDocumentFragment(),s=[{parent:i,items:e}];let n=0,r=!1;while(s.length>0){const e=s.shift();for(const t of e.items){const i=document.createElement("div");i.className="treeItem";const a=document.createElement("a");if(this._bindLink(a,t),this._setStyles(a,t),a.textContent=this._normalizeTextContent(t.title),i.appendChild(a),t.items.length>0){r=!0,this._addToggleButton(i,t);const e=document.createElement("div");e.className="treeItems",i.appendChild(e),s.push({parent:e,items:t.items})}e.parent.appendChild(i),n++}}this._finishRendering(i,n,r)}async _currentOutlineItem(){if(!this._isPagesLoaded)throw new Error("_currentOutlineItem: All pages have not been loaded.");if(!this._outline||!this._pdfDocument)return;const e=await this._getPageNumberToDestHash(this._pdfDocument);if(e&&(this._updateCurrentTreeItem(null),this._sidebarView===_ui_utils.SidebarView.OUTLINE))for(let t=this._currentPageNumber;t>0;t--){const i=e.get(t);if(!i)continue;const s=this.container.querySelector(`a[href="${i}"]`);if(s){this._scrollToCurrentTreeItem(s.parentNode);break}}}async _getPageNumberToDestHash(e){if(this._pageNumberToDestHashCapability)return this._pageNumberToDestHashCapability.promise;this._pageNumberToDestHashCapability=(0,_pdf.createPromiseCapability)();const t=new Map,i=new Map,s=[{nesting:0,items:this._outline}];while(s.length>0){const r=s.shift(),a=r.nesting;for(const{dest:l,items:u}of r.items){let r,o;if("string"===typeof l){if(r=await e.getDestination(l),e!==this._pdfDocument)return null}else r=l;if(Array.isArray(r)){const[s]=r;if("object"===typeof s&&null!==s){if(o=this.linkService._cachedPageNumber(s),!o)try{if(o=await e.getPageIndex(s)+1,e!==this._pdfDocument)return null;this.linkService.cachePageRef(o,s)}catch(n){}}else Number.isInteger(s)&&(o=s+1);if(Number.isInteger(o)&&(!t.has(o)||a>i.get(o))){const e=this.linkService.getDestinationHash(l);t.set(o,e),i.set(o,a)}}u.length>0&&s.push({nesting:a+1,items:u})}}return this._pageNumberToDestHashCapability.resolve(t.size>0?t:null),this._pageNumberToDestHashCapability.promise}}exports.PDFOutlineViewer=PDFOutlineViewer;