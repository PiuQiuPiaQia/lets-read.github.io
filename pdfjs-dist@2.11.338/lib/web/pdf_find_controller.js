"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PDFFindController=exports.FindState=void 0;var _pdf=require("../pdf"),_pdf_find_utils=require("./pdf_find_utils.js"),_ui_utils=require("./ui_utils.js");const FindState={FOUND:0,NOT_FOUND:1,WRAPPED:2,PENDING:3};exports.FindState=FindState;const FIND_TIMEOUT=250,MATCH_SCROLL_OFFSET_TOP=-50,MATCH_SCROLL_OFFSET_LEFT=-400,CHARACTERS_TO_NORMALIZE={"\u2010":"-","\u2018":"'","\u2019":"'","\u201a":"'","\u201b":"'","\u201c":'"',"\u201d":'"',"\u201e":'"',"\u201f":'"',"\xbc":"1/4","\xbd":"1/2","\xbe":"3/4"};let normalizationRegex=null;function normalize(t){if(!normalizationRegex){const t=Object.keys(CHARACTERS_TO_NORMALIZE).join("");normalizationRegex=new RegExp(`[${t}]`,"g")}let e=null;const s=t.replace(normalizationRegex,(function(t,s){const i=CHARACTERS_TO_NORMALIZE[t],h=i.length-t.length;return 0!==h&&(e||=[]).push([s,h]),i}));return[s,e]}function getOriginalIndex(t,e=null){if(!e)return t;let s=0;for(const[i,h]of e){const e=i+s;if(e>=t)break;if(e+h>t){s+=t-e;break}s+=h}return t-s}class PDFFindController{constructor({linkService:t,eventBus:e}){this._linkService=t,this._eventBus=e,this._reset(),e._on("findbarclose",this._onFindBarClose.bind(this))}get highlightMatches(){return this._highlightMatches}get pageMatches(){return this._pageMatches}get pageMatchesLength(){return this._pageMatchesLength}get selected(){return this._selected}get state(){return this._state}setDocument(t){this._pdfDocument&&this._reset(),t&&(this._pdfDocument=t,this._firstPageCapability.resolve())}executeCommand(t,e){if(!e)return;const s=this._pdfDocument;(null===this._state||this._shouldDirtyMatch(t,e))&&(this._dirtyMatch=!0),this._state=e,"findhighlightallchange"!==t&&this._updateUIState(FindState.PENDING),this._firstPageCapability.promise.then((()=>{if(!this._pdfDocument||s&&this._pdfDocument!==s)return;this._extractText();const e=!this._highlightMatches,i=!!this._findTimeout;this._findTimeout&&(clearTimeout(this._findTimeout),this._findTimeout=null),"find"===t?this._findTimeout=setTimeout((()=>{this._nextMatch(),this._findTimeout=null}),FIND_TIMEOUT):this._dirtyMatch?this._nextMatch():"findagain"===t?(this._nextMatch(),e&&this._state.highlightAll&&this._updateAllPages()):"findhighlightallchange"===t?(i?this._nextMatch():this._highlightMatches=!0,this._updateAllPages()):this._nextMatch()}))}scrollMatchIntoView({element:t=null,selectedLeft:e=0,pageIndex:s=-1,matchIndex:i=-1}){if(!this._scrollMatches||!t)return;if(-1===i||i!==this._selected.matchIdx)return;if(-1===s||s!==this._selected.pageIdx)return;this._scrollMatches=!1;const h={top:MATCH_SCROLL_OFFSET_TOP,left:e+MATCH_SCROLL_OFFSET_LEFT};(0,_ui_utils.scrollIntoView)(t,h,!0)}_reset(){this._highlightMatches=!1,this._scrollMatches=!1,this._pdfDocument=null,this._pageMatches=[],this._pageMatchesLength=[],this._state=null,this._selected={pageIdx:-1,matchIdx:-1},this._offset={pageIdx:null,matchIdx:null,wrapped:!1},this._extractTextPromises=[],this._pageContents=[],this._pageDiffs=[],this._matchesCountTotal=0,this._pagesToSearch=null,this._pendingFindMatches=new Set,this._resumePageIdx=null,this._dirtyMatch=!1,clearTimeout(this._findTimeout),this._findTimeout=null,this._firstPageCapability=(0,_pdf.createPromiseCapability)()}get _query(){return this._state.query!==this._rawQuery&&(this._rawQuery=this._state.query,[this._normalizedQuery]=normalize(this._state.query)),this._normalizedQuery}_shouldDirtyMatch(t,e){if(e.query!==this._state.query)return!0;switch(t){case"findagain":const t=this._selected.pageIdx+1,e=this._linkService;return t>=1&&t<=e.pagesCount&&t!==e.page&&!e.isPageVisible(t);case"findhighlightallchange":return!1}return!0}_prepareMatches(t,e,s){function i(e){const s=t[e],i=t[e+1];if(e<t.length-1&&s.match===i.match)return s.skipped=!0,!0;for(let h=e-1;h>=0;h--){const e=t[h];if(!e.skipped){if(e.match+e.matchLength<s.match)break;if(e.match+e.matchLength>=s.match+s.matchLength)return s.skipped=!0,!0}}return!1}t.sort((function(t,e){return t.match===e.match?t.matchLength-e.matchLength:t.match-e.match}));for(let h=0,a=t.length;h<a;h++)i(h)||(e.push(t[h].match),s.push(t[h].matchLength))}_isEntireWord(t,e,s){if(e>0){const s=t.charCodeAt(e),i=t.charCodeAt(e-1);if((0,_pdf_find_utils.getCharacterType)(s)===(0,_pdf_find_utils.getCharacterType)(i))return!1}const i=e+s-1;if(i<t.length-1){const e=t.charCodeAt(i),s=t.charCodeAt(i+1);if((0,_pdf_find_utils.getCharacterType)(e)===(0,_pdf_find_utils.getCharacterType)(s))return!1}return!0}_calculatePhraseMatch(t,e,s,i,h){const a=[],n=[],c=t.length;let r=-c;while(1){if(r=s.indexOf(t,r+c),-1===r)break;if(h&&!this._isEntireWord(s,r,c))continue;const e=getOriginalIndex(r,i),_=r+c-1,l=getOriginalIndex(_,i)-e+1;a.push(e),n.push(l)}this._pageMatches[e]=a,this._pageMatchesLength[e]=n}_calculateWordMatch(t,e,s,i,h){const a=[],n=t.match(/\S+/g);for(let c=0,r=n.length;c<r;c++){const t=n[c],e=t.length;let r=-e;while(1){if(r=s.indexOf(t,r+e),-1===r)break;if(h&&!this._isEntireWord(s,r,e))continue;const n=getOriginalIndex(r,i),c=r+e-1,_=getOriginalIndex(c,i)-n+1;a.push({match:n,matchLength:_,skipped:!1})}}this._pageMatchesLength[e]=[],this._pageMatches[e]=[],this._prepareMatches(a,this._pageMatches[e],this._pageMatchesLength[e])}_calculateMatch(t){let e=this._pageContents[t];const s=this._pageDiffs[t];let i=this._query;const{caseSensitive:h,entireWord:a,phraseSearch:n}=this._state;if(0===i.length)return;h||(e=e.toLowerCase(),i=i.toLowerCase()),n?this._calculatePhraseMatch(i,t,e,s,a):this._calculateWordMatch(i,t,e,s,a),this._state.highlightAll&&this._updatePage(t),this._resumePageIdx===t&&(this._resumePageIdx=null,this._nextPageMatch());const c=this._pageMatches[t].length;c>0&&(this._matchesCountTotal+=c,this._updateUIResultsCount())}_extractText(){if(this._extractTextPromises.length>0)return;let t=Promise.resolve();for(let e=0,s=this._linkService.pagesCount;e<s;e++){const s=(0,_pdf.createPromiseCapability)();this._extractTextPromises[e]=s.promise,t=t.then((()=>this._pdfDocument.getPage(e+1).then((t=>t.getTextContent({normalizeWhitespace:!0}))).then((t=>{const i=t.items,h=[];for(let e=0,s=i.length;e<s;e++)h.push(i[e].str);[this._pageContents[e],this._pageDiffs[e]]=normalize(h.join("")),s.resolve(e)}),(t=>{console.error(`Unable to get text content for page ${e+1}`,t),this._pageContents[e]="",this._pageDiffs[e]=null,s.resolve(e)}))))}}_updatePage(t){this._scrollMatches&&this._selected.pageIdx===t&&(this._linkService.page=t+1),this._eventBus.dispatch("updatetextlayermatches",{source:this,pageIndex:t})}_updateAllPages(){this._eventBus.dispatch("updatetextlayermatches",{source:this,pageIndex:-1})}_nextMatch(){const t=this._state.findPrevious,e=this._linkService.page-1,s=this._linkService.pagesCount;if(this._highlightMatches=!0,this._dirtyMatch){this._dirtyMatch=!1,this._selected.pageIdx=this._selected.matchIdx=-1,this._offset.pageIdx=e,this._offset.matchIdx=null,this._offset.wrapped=!1,this._resumePageIdx=null,this._pageMatches.length=0,this._pageMatchesLength.length=0,this._matchesCountTotal=0,this._updateAllPages();for(let t=0;t<s;t++)this._pendingFindMatches.has(t)||(this._pendingFindMatches.add(t),this._extractTextPromises[t].then((t=>{this._pendingFindMatches.delete(t),this._calculateMatch(t)})))}if(""===this._query)return void this._updateUIState(FindState.FOUND);if(this._resumePageIdx)return;const i=this._offset;if(this._pagesToSearch=s,null!==i.matchIdx){const e=this._pageMatches[i.pageIdx].length;if(!t&&i.matchIdx+1<e||t&&i.matchIdx>0)return i.matchIdx=t?i.matchIdx-1:i.matchIdx+1,void this._updateMatch(!0);this._advanceOffsetPage(t)}this._nextPageMatch()}_matchesReady(t){const e=this._offset,s=t.length,i=this._state.findPrevious;return s?(e.matchIdx=i?s-1:0,this._updateMatch(!0),!0):(this._advanceOffsetPage(i),!!(e.wrapped&&(e.matchIdx=null,this._pagesToSearch<0))&&(this._updateMatch(!1),!0))}_nextPageMatch(){null!==this._resumePageIdx&&console.error("There can only be one pending page.");let t=null;do{const e=this._offset.pageIdx;if(t=this._pageMatches[e],!t){this._resumePageIdx=e;break}}while(!this._matchesReady(t))}_advanceOffsetPage(t){const e=this._offset,s=this._linkService.pagesCount;e.pageIdx=t?e.pageIdx-1:e.pageIdx+1,e.matchIdx=null,this._pagesToSearch--,(e.pageIdx>=s||e.pageIdx<0)&&(e.pageIdx=t?s-1:0,e.wrapped=!0)}_updateMatch(t=!1){let e=FindState.NOT_FOUND;const s=this._offset.wrapped;if(this._offset.wrapped=!1,t){const t=this._selected.pageIdx;this._selected.pageIdx=this._offset.pageIdx,this._selected.matchIdx=this._offset.matchIdx,e=s?FindState.WRAPPED:FindState.FOUND,-1!==t&&t!==this._selected.pageIdx&&this._updatePage(t)}this._updateUIState(e,this._state.findPrevious),-1!==this._selected.pageIdx&&(this._scrollMatches=!0,this._updatePage(this._selected.pageIdx))}_onFindBarClose(t){const e=this._pdfDocument;this._firstPageCapability.promise.then((()=>{!this._pdfDocument||e&&this._pdfDocument!==e||(this._findTimeout&&(clearTimeout(this._findTimeout),this._findTimeout=null),this._resumePageIdx&&(this._resumePageIdx=null,this._dirtyMatch=!0),this._updateUIState(FindState.FOUND),this._highlightMatches=!1,this._updateAllPages())}))}_requestMatchesCount(){const{pageIdx:t,matchIdx:e}=this._selected;let s=0,i=this._matchesCountTotal;if(-1!==e){for(let e=0;e<t;e++)s+=this._pageMatches[e]?.length||0;s+=e+1}return(s<1||s>i)&&(s=i=0),{current:s,total:i}}_updateUIResultsCount(){this._eventBus.dispatch("updatefindmatchescount",{source:this,matchesCount:this._requestMatchesCount()})}_updateUIState(t,e){this._eventBus.dispatch("updatefindcontrolstate",{source:this,state:t,previous:e,matchesCount:this._requestMatchesCount(),rawQuery:this._state?.query??null})}}exports.PDFFindController=PDFFindController;