"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PDFSidebar=void 0;var _ui_utils=require("./ui_utils.js"),_pdf_rendering_queue=require("./pdf_rendering_queue.js");const UI_NOTIFICATION_CLASS="pdfSidebarNotification";class PDFSidebar{constructor({elements:i,pdfViewer:t,pdfThumbnailViewer:e,eventBus:s,l10n:n}){this.isOpen=!1,this.active=_ui_utils.SidebarView.THUMBS,this.isInitialViewSet=!1,this.onToggled=null,this.pdfViewer=t,this.pdfThumbnailViewer=e,this.outerContainer=i.outerContainer,this.viewerContainer=i.viewerContainer,this.toggleButton=i.toggleButton,this.thumbnailButton=i.thumbnailButton,this.outlineButton=i.outlineButton,this.attachmentsButton=i.attachmentsButton,this.layersButton=i.layersButton,this.thumbnailView=i.thumbnailView,this.outlineView=i.outlineView,this.attachmentsView=i.attachmentsView,this.layersView=i.layersView,this._outlineOptionsContainer=i.outlineOptionsContainer,this._currentOutlineItemButton=i.currentOutlineItemButton,this.eventBus=s,this.l10n=n,this._addEventListeners()}reset(){this.isInitialViewSet=!1,this._hideUINotification(!0),this.switchView(_ui_utils.SidebarView.THUMBS),this.outlineButton.disabled=!1,this.attachmentsButton.disabled=!1,this.layersButton.disabled=!1,this._currentOutlineItemButton.disabled=!0}get visibleView(){return this.isOpen?this.active:_ui_utils.SidebarView.NONE}get isThumbnailViewVisible(){return this.isOpen&&this.active===_ui_utils.SidebarView.THUMBS}get isOutlineViewVisible(){return this.isOpen&&this.active===_ui_utils.SidebarView.OUTLINE}get isAttachmentsViewVisible(){return this.isOpen&&this.active===_ui_utils.SidebarView.ATTACHMENTS}get isLayersViewVisible(){return this.isOpen&&this.active===_ui_utils.SidebarView.LAYERS}setInitialView(i=_ui_utils.SidebarView.NONE){this.isInitialViewSet||(this.isInitialViewSet=!0,i!==_ui_utils.SidebarView.NONE&&i!==_ui_utils.SidebarView.UNKNOWN&&this._switchView(i,!0)||this._dispatchEvent())}switchView(i,t=!1){this._switchView(i,t)}_switchView(i,t=!1){const e=i!==this.active;let s=!1;switch(i){case _ui_utils.SidebarView.NONE:return!!this.isOpen&&(this.close(),!0);case _ui_utils.SidebarView.THUMBS:this.isOpen&&e&&(s=!0);break;case _ui_utils.SidebarView.OUTLINE:if(this.outlineButton.disabled)return!1;break;case _ui_utils.SidebarView.ATTACHMENTS:if(this.attachmentsButton.disabled)return!1;break;case _ui_utils.SidebarView.LAYERS:if(this.layersButton.disabled)return!1;break;default:return console.error(`PDFSidebar._switchView: "${i}" is not a valid view.`),!1}return this.active=i,this.thumbnailButton.classList.toggle("toggled",i===_ui_utils.SidebarView.THUMBS),this.outlineButton.classList.toggle("toggled",i===_ui_utils.SidebarView.OUTLINE),this.attachmentsButton.classList.toggle("toggled",i===_ui_utils.SidebarView.ATTACHMENTS),this.layersButton.classList.toggle("toggled",i===_ui_utils.SidebarView.LAYERS),this.thumbnailView.classList.toggle("hidden",i!==_ui_utils.SidebarView.THUMBS),this.outlineView.classList.toggle("hidden",i!==_ui_utils.SidebarView.OUTLINE),this.attachmentsView.classList.toggle("hidden",i!==_ui_utils.SidebarView.ATTACHMENTS),this.layersView.classList.toggle("hidden",i!==_ui_utils.SidebarView.LAYERS),this._outlineOptionsContainer.classList.toggle("hidden",i!==_ui_utils.SidebarView.OUTLINE),t&&!this.isOpen?(this.open(),!0):(s&&(this._updateThumbnailViewer(),this._forceRendering()),e&&this._dispatchEvent(),e)}open(){this.isOpen||(this.isOpen=!0,this.toggleButton.classList.add("toggled"),this.toggleButton.setAttribute("aria-expanded","true"),this.outerContainer.classList.add("sidebarMoving","sidebarOpen"),this.active===_ui_utils.SidebarView.THUMBS&&this._updateThumbnailViewer(),this._forceRendering(),this._dispatchEvent(),this._hideUINotification())}close(){this.isOpen&&(this.isOpen=!1,this.toggleButton.classList.remove("toggled"),this.toggleButton.setAttribute("aria-expanded","false"),this.outerContainer.classList.add("sidebarMoving"),this.outerContainer.classList.remove("sidebarOpen"),this._forceRendering(),this._dispatchEvent())}toggle(){this.isOpen?this.close():this.open()}_dispatchEvent(){this.eventBus.dispatch("sidebarviewchanged",{source:this,view:this.visibleView})}_forceRendering(){this.onToggled?this.onToggled():(this.pdfViewer.forceRendering(),this.pdfThumbnailViewer.forceRendering())}_updateThumbnailViewer(){const{pdfViewer:i,pdfThumbnailViewer:t}=this,e=i.pagesCount;for(let s=0;s<e;s++){const e=i.getPageView(s);if(e?.renderingState===_pdf_rendering_queue.RenderingStates.FINISHED){const i=t.getThumbnail(s);i.setImage(e)}}t.scrollThumbnailIntoView(i.currentPageNumber)}_showUINotification(){this.l10n.get("toggle_sidebar_notification2.title").then((i=>{this.toggleButton.title=i})),this.isOpen||this.toggleButton.classList.add(UI_NOTIFICATION_CLASS)}_hideUINotification(i=!1){(this.isOpen||i)&&this.toggleButton.classList.remove(UI_NOTIFICATION_CLASS),i&&this.l10n.get("toggle_sidebar.title").then((i=>{this.toggleButton.title=i}))}_addEventListeners(){this.viewerContainer.addEventListener("transitionend",(i=>{i.target===this.viewerContainer&&this.outerContainer.classList.remove("sidebarMoving")})),this.toggleButton.addEventListener("click",(()=>{this.toggle()})),this.thumbnailButton.addEventListener("click",(()=>{this.switchView(_ui_utils.SidebarView.THUMBS)})),this.outlineButton.addEventListener("click",(()=>{this.switchView(_ui_utils.SidebarView.OUTLINE)})),this.outlineButton.addEventListener("dblclick",(()=>{this.eventBus.dispatch("toggleoutlinetree",{source:this})})),this.attachmentsButton.addEventListener("click",(()=>{this.switchView(_ui_utils.SidebarView.ATTACHMENTS)})),this.layersButton.addEventListener("click",(()=>{this.switchView(_ui_utils.SidebarView.LAYERS)})),this.layersButton.addEventListener("dblclick",(()=>{this.eventBus.dispatch("resetlayers",{source:this})})),this._currentOutlineItemButton.addEventListener("click",(()=>{this.eventBus.dispatch("currentoutlineitem",{source:this})}));const i=(i,t,e)=>{t.disabled=!i,i?this._showUINotification():this.active===e&&this.switchView(_ui_utils.SidebarView.THUMBS)};this.eventBus._on("outlineloaded",(t=>{i(t.outlineCount,this.outlineButton,_ui_utils.SidebarView.OUTLINE),t.currentOutlineItemPromise.then((i=>{this.isInitialViewSet&&(this._currentOutlineItemButton.disabled=!i)}))})),this.eventBus._on("attachmentsloaded",(t=>{i(t.attachmentsCount,this.attachmentsButton,_ui_utils.SidebarView.ATTACHMENTS)})),this.eventBus._on("layersloaded",(t=>{i(t.layersCount,this.layersButton,_ui_utils.SidebarView.LAYERS)})),this.eventBus._on("presentationmodechanged",(i=>{i.state===_ui_utils.PresentationModeState.NORMAL&&this.isThumbnailViewVisible&&this._updateThumbnailViewer()}))}}exports.PDFSidebar=PDFSidebar;