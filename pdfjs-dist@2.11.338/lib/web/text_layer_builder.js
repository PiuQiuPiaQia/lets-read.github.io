"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TextLayerBuilder=exports.DefaultTextLayerFactory=void 0;var _pdf=require("../pdf");const EXPAND_DIVS_TIMEOUT=300;class TextLayerBuilder{constructor({textLayerDiv:e,eventBus:t,pageIndex:n,viewport:i,highlighter:s=null,enhanceTextSelection:r=!1}){this.textLayerDiv=e,this.eventBus=t,this.textContent=null,this.textContentItemsStr=[],this.textContentStream=null,this.renderingDone=!1,this.pageNumber=n+1,this.viewport=i,this.textDivs=[],this.textLayerRenderTask=null,this.highlighter=s,this.enhanceTextSelection=r,this._bindMouse()}_finishRendering(){if(this.renderingDone=!0,!this.enhanceTextSelection){const e=document.createElement("div");e.className="endOfContent",this.textLayerDiv.appendChild(e)}this.eventBus.dispatch("textlayerrendered",{source:this,pageNumber:this.pageNumber,numTextDivs:this.textDivs.length})}render(e=0){if(!this.textContent&&!this.textContentStream||this.renderingDone)return;this.cancel(),this.textDivs.length=0,this.highlighter?.setTextMapping(this.textDivs,this.textContentItemsStr);const t=document.createDocumentFragment();this.textLayerRenderTask=(0,_pdf.renderTextLayer)({textContent:this.textContent,textContentStream:this.textContentStream,container:t,viewport:this.viewport,textDivs:this.textDivs,textContentItemsStr:this.textContentItemsStr,timeout:e,enhanceTextSelection:this.enhanceTextSelection}),this.textLayerRenderTask.promise.then((()=>{this.textLayerDiv.appendChild(t),this._finishRendering(),this.highlighter?.enable()}),(function(e){}))}cancel(){this.textLayerRenderTask&&(this.textLayerRenderTask.cancel(),this.textLayerRenderTask=null),this.highlighter?.disable()}setTextContentStream(e){this.cancel(),this.textContentStream=e}setTextContent(e){this.cancel(),this.textContent=e}_bindMouse(){const e=this.textLayerDiv;let t=null;e.addEventListener("mousedown",(n=>{if(this.enhanceTextSelection&&this.textLayerRenderTask)return this.textLayerRenderTask.expandTextDivs(!0),void(t&&(clearTimeout(t),t=null));const i=e.querySelector(".endOfContent");if(!i)return;let s=n.target!==e;if(s=s&&"none"!==window.getComputedStyle(i).getPropertyValue("-moz-user-select"),s){const t=e.getBoundingClientRect(),s=Math.max(0,(n.pageY-t.top)/t.height);i.style.top=(100*s).toFixed(2)+"%"}i.classList.add("active")})),e.addEventListener("mouseup",(()=>{if(this.enhanceTextSelection&&this.textLayerRenderTask)return void(t=setTimeout((()=>{this.textLayerRenderTask&&this.textLayerRenderTask.expandTextDivs(!1),t=null}),EXPAND_DIVS_TIMEOUT));const n=e.querySelector(".endOfContent");n&&(n.style.top="",n.classList.remove("active"))}))}}exports.TextLayerBuilder=TextLayerBuilder;class DefaultTextLayerFactory{createTextLayerBuilder(e,t,n,i=!1,s,r){return new TextLayerBuilder({textLayerDiv:e,pageIndex:t,viewport:n,enhanceTextSelection:i,eventBus:s,highlighter:r})}}exports.DefaultTextLayerFactory=DefaultTextLayerFactory;