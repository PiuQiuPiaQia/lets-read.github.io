"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TextHighlighter=void 0;class TextHighlighter{constructor({findController:e,eventBus:t,pageIndex:s}){this.findController=e,this.matches=[],this.eventBus=t,this.pageIdx=s,this._onUpdateTextLayerMatches=null,this.textDivs=null,this.textContentItemsStr=null,this.enabled=!1}setTextMapping(e,t){this.textDivs=e,this.textContentItemsStr=t}enable(){if(!this.textDivs||!this.textContentItemsStr)throw new Error("Text divs and strings have not been set.");if(this.enabled)throw new Error("TextHighlighter is already enabled.");this.enabled=!0,this._onUpdateTextLayerMatches||(this._onUpdateTextLayerMatches=e=>{e.pageIndex!==this.pageIdx&&-1!==e.pageIndex||this._updateMatches()},this.eventBus._on("updatetextlayermatches",this._onUpdateTextLayerMatches)),this._updateMatches()}disable(){this.enabled&&(this.enabled=!1,this._onUpdateTextLayerMatches&&(this.eventBus._off("updatetextlayermatches",this._onUpdateTextLayerMatches),this._onUpdateTextLayerMatches=null))}_convertMatches(e,t){if(!e)return[];const{textContentItemsStr:s}=this;let n=0,i=0;const d=s.length-1,h=[];for(let l=0,a=e.length;l<a;l++){let a=e[l];while(n!==d&&a>=i+s[n].length)i+=s[n].length,n++;n===s.length&&console.error("Could not find a matching mapping");const o={begin:{divIdx:n,offset:a-i}};a+=t[l];while(n!==d&&a>i+s[n].length)i+=s[n].length,n++;o.end={divIdx:n,offset:a-i},h.push(o)}return h}_renderMatches(e){if(0===e.length)return;const{findController:t,pageIdx:s}=this,{textContentItemsStr:n,textDivs:i}=this,d=s===t.selected.pageIdx,h=t.selected.matchIdx,l=t.state.highlightAll;let a=null;const o={divIdx:-1,offset:void 0};function r(e,t){const s=e.divIdx;return i[s].textContent="",c(s,0,e.offset,t)}function c(e,t,s,d){let h=i[e];if(h.nodeType===Node.TEXT_NODE){const t=document.createElement("span");h.parentNode.insertBefore(t,h),t.appendChild(h),i[e]=t,h=t}const l=n[e].substring(t,s),a=document.createTextNode(l);if(d){const e=document.createElement("span");return e.className=`${d} appended`,e.appendChild(a),h.appendChild(e),d.includes("selected")?e.offsetLeft:0}return h.appendChild(a),0}let x=h,f=x+1;if(l)x=0,f=e.length;else if(!d)return;for(let g=x;g<f;g++){const n=e[g],l=n.begin,x=n.end,f=d&&g===h,p=f?" selected":"";let u=0;if(a&&l.divIdx===a.divIdx?c(a.divIdx,a.offset,l.offset):(null!==a&&c(a.divIdx,a.offset,o.offset),r(l)),l.divIdx===x.divIdx)u=c(l.divIdx,l.offset,x.offset,"highlight"+p);else{u=c(l.divIdx,l.offset,o.offset,"highlight begin"+p);for(let e=l.divIdx+1,t=x.divIdx;e<t;e++)i[e].className="highlight middle"+p;r(x,"highlight end"+p)}a=x,f&&t.scrollMatchIntoView({element:i[l.divIdx],selectedLeft:u,pageIndex:s,matchIndex:h})}a&&c(a.divIdx,a.offset,o.offset)}_updateMatches(){if(!this.enabled)return;const{findController:e,matches:t,pageIdx:s}=this,{textContentItemsStr:n,textDivs:i}=this;let d=-1;for(let a=0,o=t.length;a<o;a++){const e=t[a],s=Math.max(d,e.begin.divIdx);for(let t=s,d=e.end.divIdx;t<=d;t++){const e=i[t];e.textContent=n[t],e.className=""}d=e.end.divIdx+1}if(!e?.highlightMatches)return;const h=e.pageMatches[s]||null,l=e.pageMatchesLength[s]||null;this.matches=this._convertMatches(h,l),this._renderMatches(this.matches)}}exports.TextHighlighter=TextHighlighter;