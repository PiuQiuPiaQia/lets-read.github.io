"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BaseViewer=void 0;var _pdf=require("../pdf"),_ui_utils=require("./ui_utils.js"),_pdf_rendering_queue=require("./pdf_rendering_queue.js"),_annotation_layer_builder=require("./annotation_layer_builder.js"),_l10n_utils=require("./l10n_utils.js"),_pdf_page_view=require("./pdf_page_view.js"),_pdf_link_service=require("./pdf_link_service.js"),_struct_tree_layer_builder=require("./struct_tree_layer_builder.js"),_text_highlighter=require("./text_highlighter.js"),_text_layer_builder=require("./text_layer_builder.js"),_xfa_layer_builder=require("./xfa_layer_builder.js");const DEFAULT_CACHE_SIZE=10;function PDFPageViewBuffer(e){const t=[];this.push=function(i){const s=t.indexOf(i);s>=0&&t.splice(s,1),t.push(i),t.length>e&&t.shift().destroy()},this.resize=function(i,s){if(e=i,s){const e=new Set;for(let t=0,i=s.length;t<i;++t)e.add(s[t].id);(0,_ui_utils.moveToEndOfArray)(t,(function(t){return e.has(t.id)}))}while(t.length>e)t.shift().destroy()},this.has=function(e){return t.includes(e)}}function isSameScale(e,t){return t===e||Math.abs(t-e)<1e-15}class BaseViewer{constructor(e){if(this.constructor===BaseViewer)throw new Error("Cannot initialize BaseViewer.");const t="2.11.338";if(_pdf.version!==t)throw new Error(`The API version "${_pdf.version}" does not match the Viewer version "${t}".`);if(this.container=e.container,this.viewer=e.viewer||e.container.firstElementChild,"DIV"!==this.container?.tagName.toUpperCase()||"DIV"!==this.viewer?.tagName.toUpperCase())throw new Error("Invalid `container` and/or `viewer` option.");if(this.container.offsetParent&&"absolute"!==getComputedStyle(this.container).position)throw new Error("The `container` must be absolutely positioned.");this.eventBus=e.eventBus,this.linkService=e.linkService||new _pdf_link_service.SimpleLinkService,this.downloadManager=e.downloadManager||null,this.findController=e.findController||null,this._scriptingManager=e.scriptingManager||null,this.removePageBorders=e.removePageBorders||!1,this.textLayerMode=e.textLayerMode??_ui_utils.TextLayerMode.ENABLE,this._annotationMode=e.annotationMode??_pdf.AnnotationMode.ENABLE_FORMS,this.imageResourcesPath=e.imageResourcesPath||"",this.enablePrintAutoRotate=e.enablePrintAutoRotate||!1,this.renderer=e.renderer||_ui_utils.RendererType.CANVAS,this.useOnlyCssZoom=e.useOnlyCssZoom||!1,this.maxCanvasPixels=e.maxCanvasPixels,this.l10n=e.l10n||_l10n_utils.NullL10n,this.defaultRenderingQueue=!e.renderingQueue,this.defaultRenderingQueue?(this.renderingQueue=new _pdf_rendering_queue.PDFRenderingQueue,this.renderingQueue.setViewer(this)):this.renderingQueue=e.renderingQueue,this._doc=document.documentElement,this.scroll=(0,_ui_utils.watchScroll)(this.container,this._scrollUpdate.bind(this)),this.presentationModeState=_ui_utils.PresentationModeState.UNKNOWN,this._onBeforeDraw=this._onAfterDraw=null,this._resetView(),this.removePageBorders&&this.viewer.classList.add("removePageBorders"),Promise.resolve().then((()=>{this.eventBus.dispatch("baseviewerinit",{source:this})}))}get pagesCount(){return this._pages.length}getPageView(e){return this._pages[e]}get pageViewsReady(){return!!this._pagesCapability.settled&&this._pages.every((function(e){return e?.pdfPage}))}get renderForms(){return this._annotationMode===_pdf.AnnotationMode.ENABLE_FORMS}get enableScripting(){return!!this._scriptingManager}get currentPageNumber(){return this._currentPageNumber}set currentPageNumber(e){if(!Number.isInteger(e))throw new Error("Invalid page number.");this.pdfDocument&&(this._setCurrentPageNumber(e,!0)||console.error(`currentPageNumber: "${e}" is not a valid page.`))}_setCurrentPageNumber(e,t=!1){if(this._currentPageNumber===e)return t&&this._resetCurrentPageView(),!0;if(!(0<e&&e<=this.pagesCount))return!1;const i=this._currentPageNumber;return this._currentPageNumber=e,this.eventBus.dispatch("pagechanging",{source:this,pageNumber:e,pageLabel:this._pageLabels?.[e-1]??null,previous:i}),t&&this._resetCurrentPageView(),!0}get currentPageLabel(){return this._pageLabels?.[this._currentPageNumber-1]??null}set currentPageLabel(e){if(!this.pdfDocument)return;let t=0|e;if(this._pageLabels){const i=this._pageLabels.indexOf(e);i>=0&&(t=i+1)}this._setCurrentPageNumber(t,!0)||console.error(`currentPageLabel: "${e}" is not a valid page.`)}get currentScale(){return this._currentScale!==_ui_utils.UNKNOWN_SCALE?this._currentScale:_ui_utils.DEFAULT_SCALE}set currentScale(e){if(isNaN(e))throw new Error("Invalid numeric scale.");this.pdfDocument&&this._setScale(e,!1)}get currentScaleValue(){return this._currentScaleValue}set currentScaleValue(e){this.pdfDocument&&this._setScale(e,!1)}get pagesRotation(){return this._pagesRotation}set pagesRotation(e){if(!(0,_ui_utils.isValidRotation)(e))throw new Error("Invalid pages rotation angle.");if(!this.pdfDocument)return;if(e%=360,e<0&&(e+=360),this._pagesRotation===e)return;this._pagesRotation=e;const t=this._currentPageNumber,i={rotation:e};for(const s of this._pages)s.update(i);this._currentScaleValue&&this._setScale(this._currentScaleValue,!0),this.eventBus.dispatch("rotationchanging",{source:this,pagesRotation:e,pageNumber:t}),this.defaultRenderingQueue&&this.update()}get firstPagePromise(){return this.pdfDocument?this._firstPageCapability.promise:null}get onePageRendered(){return this.pdfDocument?this._onePageRenderedCapability.promise:null}get pagesPromise(){return this.pdfDocument?this._pagesCapability.promise:null}get _viewerElement(){throw new Error("Not implemented: _viewerElement")}_onePageRenderedOrForceFetch(){return this.container.offsetParent&&0!==this._getVisiblePages().views.length?this._onePageRenderedCapability.promise:Promise.resolve()}setDocument(e){if(this.pdfDocument&&(this.eventBus.dispatch("pagesdestroy",{source:this}),this._cancelRendering(),this._resetView(),this.findController&&this.findController.setDocument(null),this._scriptingManager&&this._scriptingManager.setDocument(null)),this.pdfDocument=e,!e)return;const t=e.isPureXfa,i=e.numPages,s=e.getPage(1),r=e.getOptionalContentConfig();this._pagesCapability.promise.then((()=>{this.eventBus.dispatch("pagesloaded",{source:this,pagesCount:i})})),this._onBeforeDraw=e=>{const t=this._pages[e.pageNumber-1];t&&this._buffer.push(t)},this.eventBus._on("pagerender",this._onBeforeDraw),this._onAfterDraw=e=>{e.cssTransform||this._onePageRenderedCapability.settled||(this._onePageRenderedCapability.resolve(),this.eventBus._off("pagerendered",this._onAfterDraw),this._onAfterDraw=null)},this.eventBus._on("pagerendered",this._onAfterDraw),s.then((s=>{this._firstPageCapability.resolve(s),this._optionalContentConfigPromise=r;const n=this.currentScale,a=s.getViewport({scale:n*_pdf.PixelsPerInch.PDF_TO_CSS_UNITS}),o=this.textLayerMode===_ui_utils.TextLayerMode.DISABLE||t?null:this,l=this._annotationMode!==_pdf.AnnotationMode.DISABLE?this:null,u=t?this:null;for(let e=1;e<=i;++e){const t=new _pdf_page_view.PDFPageView({container:this._viewerElement,eventBus:this.eventBus,id:e,scale:n,defaultViewport:a.clone(),optionalContentConfigPromise:r,renderingQueue:this.renderingQueue,textLayerFactory:o,textLayerMode:this.textLayerMode,annotationLayerFactory:l,annotationMode:this._annotationMode,xfaLayerFactory:u,textHighlighterFactory:this,structTreeLayerFactory:this,imageResourcesPath:this.imageResourcesPath,renderer:this.renderer,useOnlyCssZoom:this.useOnlyCssZoom,maxCanvasPixels:this.maxCanvasPixels,l10n:this.l10n});this._pages.push(t)}const h=this._pages[0];h&&(h.setPdfPage(s),this.linkService.cachePageRef(1,s.ref)),this._spreadMode!==_ui_utils.SpreadMode.NONE&&this._updateSpreadMode(),this._onePageRenderedOrForceFetch().then((()=>{if(this.findController&&this.findController.setDocument(e),this._scriptingManager&&this._scriptingManager.setDocument(e),e.loadingParams.disableAutoFetch||i>7500)return void this._pagesCapability.resolve();let t=i-1;if(t<=0)this._pagesCapability.resolve();else for(let s=2;s<=i;++s)e.getPage(s).then((e=>{const i=this._pages[s-1];i.pdfPage||i.setPdfPage(e),this.linkService.cachePageRef(s,e.ref),0===--t&&this._pagesCapability.resolve()}),(e=>{console.error(`Unable to get page ${s} to initialize viewer`,e),0===--t&&this._pagesCapability.resolve()}))})),this.eventBus.dispatch("pagesinit",{source:this}),this.defaultRenderingQueue&&this.update()})).catch((e=>{console.error("Unable to initialize viewer",e)}))}setPageLabels(e){if(this.pdfDocument){e?Array.isArray(e)&&this.pdfDocument.numPages===e.length?this._pageLabels=e:(this._pageLabels=null,console.error("setPageLabels: Invalid page labels.")):this._pageLabels=null;for(let e=0,t=this._pages.length;e<t;e++)this._pages[e].setPageLabel(this._pageLabels?.[e]??null)}}_resetView(){this._pages=[],this._currentPageNumber=1,this._currentScale=_ui_utils.UNKNOWN_SCALE,this._currentScaleValue=null,this._pageLabels=null,this._buffer=new PDFPageViewBuffer(DEFAULT_CACHE_SIZE),this._location=null,this._pagesRotation=0,this._optionalContentConfigPromise=null,this._pagesRequests=new WeakMap,this._firstPageCapability=(0,_pdf.createPromiseCapability)(),this._onePageRenderedCapability=(0,_pdf.createPromiseCapability)(),this._pagesCapability=(0,_pdf.createPromiseCapability)(),this._scrollMode=_ui_utils.ScrollMode.VERTICAL,this._spreadMode=_ui_utils.SpreadMode.NONE,this._onBeforeDraw&&(this.eventBus._off("pagerender",this._onBeforeDraw),this._onBeforeDraw=null),this._onAfterDraw&&(this.eventBus._off("pagerendered",this._onAfterDraw),this._onAfterDraw=null),this.viewer.textContent="",this._updateScrollMode()}_scrollUpdate(){0!==this.pagesCount&&this.update()}_scrollIntoView({pageDiv:e,pageSpot:t=null,pageNumber:i=null}){(0,_ui_utils.scrollIntoView)(e,t)}_setScaleUpdatePages(e,t,i=!1,s=!1){if(this._currentScaleValue=t.toString(),isSameScale(this._currentScale,e))return void(s&&this.eventBus.dispatch("scalechanging",{source:this,scale:e,presetValue:t}));this._doc.style.setProperty("--zoom-factor",e);const r={scale:e};for(const n of this._pages)n.update(r);if(this._currentScale=e,!i){let e,t=this._currentPageNumber;!this._location||this.isInPresentationMode||this.isChangingPresentationMode||(t=this._location.pageNumber,e=[null,{name:"XYZ"},this._location.left,this._location.top,null]),this.scrollPageIntoView({pageNumber:t,destArray:e,allowNegativeOffset:!0})}this.eventBus.dispatch("scalechanging",{source:this,scale:e,presetValue:s?t:void 0}),this.defaultRenderingQueue&&this.update()}get _pageWidthScaleFactor(){return this._spreadMode===_ui_utils.SpreadMode.NONE||this._scrollMode===_ui_utils.ScrollMode.HORIZONTAL||this.isInPresentationMode?1:2}_setScale(e,t=!1){let i=parseFloat(e);if(i>0)this._setScaleUpdatePages(i,e,t,!1);else{const s=this._pages[this._currentPageNumber-1];if(!s)return;const r=this.isInPresentationMode||this.removePageBorders;let n=r?0:_ui_utils.SCROLLBAR_PADDING,a=r?0:_ui_utils.VERTICAL_PADDING;!r&&this._isScrollModeHorizontal&&([n,a]=[a,n]);const o=(this.container.clientWidth-n)/s.width*s.scale/this._pageWidthScaleFactor,l=(this.container.clientHeight-a)/s.height*s.scale;switch(e){case"page-actual":i=1;break;case"page-width":i=o;break;case"page-height":i=l;break;case"page-fit":i=Math.min(o,l);break;case"auto":const t=(0,_ui_utils.isPortraitOrientation)(s)?o:Math.min(l,o);i=Math.min(_ui_utils.MAX_AUTO_SCALE,t);break;default:return void console.error(`_setScale: "${e}" is an unknown zoom value.`)}this._setScaleUpdatePages(i,e,t,!0)}}_resetCurrentPageView(){this.isInPresentationMode&&this._setScale(this._currentScaleValue,!0);const e=this._pages[this._currentPageNumber-1];this._scrollIntoView({pageDiv:e.div})}pageLabelToPageNumber(e){if(!this._pageLabels)return null;const t=this._pageLabels.indexOf(e);return t<0?null:t+1}scrollPageIntoView({pageNumber:e,destArray:t=null,allowNegativeOffset:i=!1,ignoreDestinationZoom:s=!1}){if(!this.pdfDocument)return;const r=Number.isInteger(e)&&this._pages[e-1];if(!r)return void console.error(`scrollPageIntoView: "${e}" is not a valid pageNumber parameter.`);if(this.isInPresentationMode||!t)return void this._setCurrentPageNumber(e,!0);let n,a,o=0,l=0,u=0,h=0;const c=r.rotation%180!==0,_=(c?r.height:r.width)/r.scale/_pdf.PixelsPerInch.PDF_TO_CSS_UNITS,d=(c?r.width:r.height)/r.scale/_pdf.PixelsPerInch.PDF_TO_CSS_UNITS;let g=0;switch(t[1].name){case"XYZ":o=t[2],l=t[3],g=t[4],o=null!==o?o:0,l=null!==l?l:d;break;case"Fit":case"FitB":g="page-fit";break;case"FitH":case"FitBH":l=t[2],g="page-width",null===l&&this._location?(o=this._location.left,l=this._location.top):"number"!==typeof l&&(l=d);break;case"FitV":case"FitBV":o=t[2],u=_,h=d,g="page-height";break;case"FitR":o=t[2],l=t[3],u=t[4]-o,h=t[5]-l;const e=this.removePageBorders?0:_ui_utils.SCROLLBAR_PADDING,i=this.removePageBorders?0:_ui_utils.VERTICAL_PADDING;n=(this.container.clientWidth-e)/u/_pdf.PixelsPerInch.PDF_TO_CSS_UNITS,a=(this.container.clientHeight-i)/h/_pdf.PixelsPerInch.PDF_TO_CSS_UNITS,g=Math.min(Math.abs(n),Math.abs(a));break;default:return void console.error(`scrollPageIntoView: "${t[1].name}" is not a valid destination type.`)}if(s||(g&&g!==this._currentScale?this.currentScaleValue=g:this._currentScale===_ui_utils.UNKNOWN_SCALE&&(this.currentScaleValue=_ui_utils.DEFAULT_SCALE_VALUE)),"page-fit"===g&&!t[4])return void this._scrollIntoView({pageDiv:r.div,pageNumber:e});const p=[r.viewport.convertToViewportPoint(o,l),r.viewport.convertToViewportPoint(o+u,l+h)];let f=Math.min(p[0][0],p[1][0]),P=Math.min(p[0][1],p[1][1]);i||(f=Math.max(f,0),P=Math.max(P,0)),this._scrollIntoView({pageDiv:r.div,pageSpot:{left:f,top:P},pageNumber:e})}_updateLocation(e){const t=this._currentScale,i=this._currentScaleValue,s=parseFloat(i)===t?Math.round(1e4*t)/100:i,r=e.id;let n="#page="+r;n+="&zoom="+s;const a=this._pages[r-1],o=this.container,l=a.getPagePoint(o.scrollLeft-e.x,o.scrollTop-e.y),u=Math.round(l[0]),h=Math.round(l[1]);n+=","+u+","+h,this._location={pageNumber:r,scale:s,top:h,left:u,rotation:this._pagesRotation,pdfOpenParams:n}}_updateHelper(e){throw new Error("Not implemented: _updateHelper")}update(){const e=this._getVisiblePages(),t=e.views,i=t.length;if(0===i)return;const s=Math.max(DEFAULT_CACHE_SIZE,2*i+1);this._buffer.resize(s,t),this.renderingQueue.renderHighestPriority(e),this._updateHelper(t),this._updateLocation(e.first),this.eventBus.dispatch("updateviewarea",{source:this,location:this._location})}containsElement(e){return this.container.contains(e)}focus(){this.container.focus()}get _isScrollModeHorizontal(){return!this.isInPresentationMode&&this._scrollMode===_ui_utils.ScrollMode.HORIZONTAL}get _isContainerRtl(){return"rtl"===getComputedStyle(this.container).direction}get isInPresentationMode(){return this.presentationModeState===_ui_utils.PresentationModeState.FULLSCREEN}get isChangingPresentationMode(){return this.presentationModeState===_ui_utils.PresentationModeState.CHANGING}get isHorizontalScrollbarEnabled(){return!this.isInPresentationMode&&this.container.scrollWidth>this.container.clientWidth}get isVerticalScrollbarEnabled(){return!this.isInPresentationMode&&this.container.scrollHeight>this.container.clientHeight}_getCurrentVisiblePage(){if(!this.pagesCount)return{views:[]};const e=this._pages[this._currentPageNumber-1],t=e.div,i={id:e.id,x:t.offsetLeft+t.clientLeft,y:t.offsetTop+t.clientTop,view:e};return{first:i,last:i,views:[i]}}_getVisiblePages(){return(0,_ui_utils.getVisibleElements)({scrollEl:this.container,views:this._pages,sortByVisibility:!0,horizontal:this._isScrollModeHorizontal,rtl:this._isScrollModeHorizontal&&this._isContainerRtl})}isPageVisible(e){return!!this.pdfDocument&&(Number.isInteger(e)&&e>0&&e<=this.pagesCount?this._getVisiblePages().views.some((function(t){return t.id===e})):(console.error(`isPageVisible: "${e}" is not a valid page.`),!1))}isPageCached(e){if(!this.pdfDocument||!this._buffer)return!1;if(!(Number.isInteger(e)&&e>0&&e<=this.pagesCount))return console.error(`isPageCached: "${e}" is not a valid page.`),!1;const t=this._pages[e-1];return!!t&&this._buffer.has(t)}cleanup(){for(let e=0,t=this._pages.length;e<t;e++)this._pages[e]&&this._pages[e].renderingState!==_pdf_rendering_queue.RenderingStates.FINISHED&&this._pages[e].reset()}_cancelRendering(){for(let e=0,t=this._pages.length;e<t;e++)this._pages[e]&&this._pages[e].cancelRendering()}_ensurePdfPageLoaded(e){if(e.pdfPage)return Promise.resolve(e.pdfPage);if(this._pagesRequests.has(e))return this._pagesRequests.get(e);const t=this.pdfDocument.getPage(e.id).then((t=>(e.pdfPage||e.setPdfPage(t),this._pagesRequests.delete(e),t))).catch((t=>{console.error("Unable to get page for page view",t),this._pagesRequests.delete(e)}));return this._pagesRequests.set(e,t),t}forceRendering(e){const t=e||this._getVisiblePages(),i=this._isScrollModeHorizontal?this.scroll.right:this.scroll.down,s=this._scrollMode===_ui_utils.ScrollMode.VERTICAL&&this._spreadMode!==_ui_utils.SpreadMode.NONE&&!this.isInPresentationMode,r=this.renderingQueue.getHighestPriority(t,this._pages,i,s);return!!r&&(this._ensurePdfPageLoaded(r).then((()=>{this.renderingQueue.renderView(r)})),!0)}createTextLayerBuilder(e,t,i,s=!1,r,n){return new _text_layer_builder.TextLayerBuilder({textLayerDiv:e,eventBus:r,pageIndex:t,viewport:i,enhanceTextSelection:!this.isInPresentationMode&&s,highlighter:n})}createTextHighlighter(e,t){return new _text_highlighter.TextHighlighter({eventBus:t,pageIndex:e,findController:this.isInPresentationMode?null:this.findController})}createAnnotationLayerBuilder(e,t,i=null,s="",r=!0,n=_l10n_utils.NullL10n,a=null,o=null,l=null,u=null){return new _annotation_layer_builder.AnnotationLayerBuilder({pageDiv:e,pdfPage:t,annotationStorage:i||this.pdfDocument?.annotationStorage,imageResourcesPath:s,renderForms:r,linkService:this.linkService,downloadManager:this.downloadManager,l10n:n,enableScripting:a??this.enableScripting,hasJSActionsPromise:o||this.pdfDocument?.hasJSActions(),fieldObjectsPromise:u||this.pdfDocument?.getFieldObjects(),mouseState:l||this._scriptingManager?.mouseState})}createXfaLayerBuilder(e,t,i=null){return new _xfa_layer_builder.XfaLayerBuilder({pageDiv:e,pdfPage:t,annotationStorage:i||this.pdfDocument?.annotationStorage,linkService:this.linkService})}createStructTreeLayerBuilder(e){return new _struct_tree_layer_builder.StructTreeLayerBuilder({pdfPage:e})}get hasEqualPageSizes(){const e=this._pages[0];for(let t=1,i=this._pages.length;t<i;++t){const i=this._pages[t];if(i.width!==e.width||i.height!==e.height)return!1}return!0}getPagesOverview(){return this._pages.map((e=>{const t=e.pdfPage.getViewport({scale:1});return!this.enablePrintAutoRotate||(0,_ui_utils.isPortraitOrientation)(t)?{width:t.width,height:t.height,rotation:t.rotation}:{width:t.height,height:t.width,rotation:(t.rotation-90)%360}}))}get optionalContentConfigPromise(){return this.pdfDocument?this._optionalContentConfigPromise?this._optionalContentConfigPromise:this.pdfDocument.getOptionalContentConfig():Promise.resolve(null)}set optionalContentConfigPromise(e){if(!(e instanceof Promise))throw new Error(`Invalid optionalContentConfigPromise: ${e}`);if(!this.pdfDocument)return;if(!this._optionalContentConfigPromise)return;this._optionalContentConfigPromise=e;const t={optionalContentConfigPromise:e};for(const i of this._pages)i.update(t);this.update(),this.eventBus.dispatch("optionalcontentconfigchanged",{source:this,promise:e})}get scrollMode(){return this._scrollMode}set scrollMode(e){if(this._scrollMode!==e){if(!(0,_ui_utils.isValidScrollMode)(e))throw new Error(`Invalid scroll mode: ${e}`);this._scrollMode=e,this.eventBus.dispatch("scrollmodechanged",{source:this,mode:e}),this._updateScrollMode(this._currentPageNumber)}}_updateScrollMode(e=null){const t=this._scrollMode,i=this.viewer;i.classList.toggle("scrollHorizontal",t===_ui_utils.ScrollMode.HORIZONTAL),i.classList.toggle("scrollWrapped",t===_ui_utils.ScrollMode.WRAPPED),this.pdfDocument&&e&&(this._currentScaleValue&&isNaN(this._currentScaleValue)&&this._setScale(this._currentScaleValue,!0),this._setCurrentPageNumber(e,!0),this.update())}get spreadMode(){return this._spreadMode}set spreadMode(e){if(this._spreadMode!==e){if(!(0,_ui_utils.isValidSpreadMode)(e))throw new Error(`Invalid spread mode: ${e}`);this._spreadMode=e,this.eventBus.dispatch("spreadmodechanged",{source:this,mode:e}),this._updateSpreadMode(this._currentPageNumber)}}_updateSpreadMode(e=null){if(!this.pdfDocument)return;const t=this.viewer,i=this._pages;if(t.textContent="",this._spreadMode===_ui_utils.SpreadMode.NONE)for(let s=0,r=i.length;s<r;++s)t.appendChild(i[s].div);else{const e=this._spreadMode-1;let s=null;for(let r=0,n=i.length;r<n;++r)null===s?(s=document.createElement("div"),s.className="spread",t.appendChild(s)):r%2===e&&(s=s.cloneNode(!1),t.appendChild(s)),s.appendChild(i[r].div)}e&&(this._currentScaleValue&&isNaN(this._currentScaleValue)&&this._setScale(this._currentScaleValue,!0),this._setCurrentPageNumber(e,!0),this.update())}_getPageAdvance(e,t=!1){if(this.isInPresentationMode)return 1;switch(this._scrollMode){case _ui_utils.ScrollMode.WRAPPED:{const{views:i}=this._getVisiblePages(),s=new Map;for(const{id:e,y:t,percent:r,widthPercent:n}of i){if(0===r||n<100)continue;let i=s.get(t);i||s.set(t,i||=[]),i.push(e)}for(const r of s.values()){const i=r.indexOf(e);if(-1===i)continue;const s=r.length;if(1===s)break;if(t)for(let t=i-1,n=0;t>=n;t--){const i=r[t],s=r[t+1]-1;if(i<s)return e-s}else for(let t=i+1,n=s;t<n;t++){const i=r[t],s=r[t-1]+1;if(i>s)return s-e}if(t){const t=r[0];if(t<e)return e-t+1}else{const t=r[s-1];if(t>e)return t-e+1}break}break}case _ui_utils.ScrollMode.HORIZONTAL:break;case _ui_utils.ScrollMode.VERTICAL:{if(this._spreadMode===_ui_utils.SpreadMode.NONE)break;const i=this._spreadMode-1;if(t&&e%2!==i)break;if(!t&&e%2===i)break;const{views:s}=this._getVisiblePages(),r=t?e-1:e+1;for(const{id:e,percent:t,widthPercent:n}of s)if(e===r){if(t>0&&100===n)return 2;break}break}}return 1}nextPage(){const e=this._currentPageNumber,t=this.pagesCount;if(e>=t)return!1;const i=this._getPageAdvance(e,!1)||1;return this.currentPageNumber=Math.min(e+i,t),!0}previousPage(){const e=this._currentPageNumber;if(e<=1)return!1;const t=this._getPageAdvance(e,!0)||1;return this.currentPageNumber=Math.max(e-t,1),!0}increaseScale(e=1){let t=this._currentScale;do{t=(t*_ui_utils.DEFAULT_SCALE_DELTA).toFixed(2),t=Math.ceil(10*t)/10,t=Math.min(_ui_utils.MAX_SCALE,t)}while(--e>0&&t<_ui_utils.MAX_SCALE);this.currentScaleValue=t}decreaseScale(e=1){let t=this._currentScale;do{t=(t/_ui_utils.DEFAULT_SCALE_DELTA).toFixed(2),t=Math.floor(10*t)/10,t=Math.max(_ui_utils.MIN_SCALE,t)}while(--e>0&&t>_ui_utils.MIN_SCALE);this.currentScaleValue=t}}exports.BaseViewer=BaseViewer;