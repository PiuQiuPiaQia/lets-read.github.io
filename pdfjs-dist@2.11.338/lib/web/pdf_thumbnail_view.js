"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TempImageFactory=exports.PDFThumbnailView=void 0;var _ui_utils=require("./ui_utils.js"),_pdf=require("../pdf"),_pdf_rendering_queue=require("./pdf_rendering_queue.js");const DRAW_UPSCALE_FACTOR=2,MAX_NUM_SCALING_STEPS=3,THUMBNAIL_CANVAS_BORDER_WIDTH=1,THUMBNAIL_WIDTH=98,TempImageFactory=function(){let e=null;return{getCanvas(t,i){let n=e;n||(n=document.createElement("canvas"),e=n),n.width=t,n.height=i,n.mozOpaque=!0;const a=n.getContext("2d",{alpha:!1});return a.save(),a.fillStyle="rgb(255, 255, 255)",a.fillRect(0,0,t,i),a.restore(),[n,n.getContext("2d")]},destroyCanvas(){const t=e;t&&(t.width=0,t.height=0),e=null}}}();exports.TempImageFactory=TempImageFactory;class PDFThumbnailView{constructor({container:e,id:t,defaultViewport:i,optionalContentConfigPromise:n,linkService:a,renderingQueue:s,checkSetImageDisabled:r,l10n:h}){this.id=t,this.renderingId="thumbnail"+t,this.pageLabel=null,this.pdfPage=null,this.rotation=0,this.viewport=i,this.pdfPageRotate=i.rotation,this._optionalContentConfigPromise=n||null,this.linkService=a,this.renderingQueue=s,this.renderTask=null,this.renderingState=_pdf_rendering_queue.RenderingStates.INITIAL,this.resume=null,this._checkSetImageDisabled=r||function(){return!1};const d=this.viewport.width,o=this.viewport.height,g=d/o;this.canvasWidth=THUMBNAIL_WIDTH,this.canvasHeight=this.canvasWidth/g|0,this.scale=this.canvasWidth/d,this.l10n=h;const c=document.createElement("a");c.href=a.getAnchorUrl("#page="+t),this._thumbPageTitle.then((e=>{c.title=e})),c.onclick=function(){return a.goToPage(t),!1},this.anchor=c;const l=document.createElement("div");l.className="thumbnail",l.setAttribute("data-page-number",this.id),this.div=l;const u=document.createElement("div");u.className="thumbnailSelectionRing";const _=2*THUMBNAIL_CANVAS_BORDER_WIDTH;u.style.width=this.canvasWidth+_+"px",u.style.height=this.canvasHeight+_+"px",this.ring=u,l.appendChild(u),c.appendChild(l),e.appendChild(c)}setPdfPage(e){this.pdfPage=e,this.pdfPageRotate=e.rotate;const t=(this.rotation+this.pdfPageRotate)%360;this.viewport=e.getViewport({scale:1,rotation:t}),this.reset()}reset(){this.cancelRendering(),this.renderingState=_pdf_rendering_queue.RenderingStates.INITIAL;const e=this.viewport.width,t=this.viewport.height,i=e/t;this.canvasHeight=this.canvasWidth/i|0,this.scale=this.canvasWidth/e,this.div.removeAttribute("data-loaded");const n=this.ring;n.textContent="";const a=2*THUMBNAIL_CANVAS_BORDER_WIDTH;n.style.width=this.canvasWidth+a+"px",n.style.height=this.canvasHeight+a+"px",this.canvas&&(this.canvas.width=0,this.canvas.height=0,delete this.canvas),this.image&&(this.image.removeAttribute("src"),delete this.image)}update({rotation:e=null}){"number"===typeof e&&(this.rotation=e);const t=(this.rotation+this.pdfPageRotate)%360;this.viewport=this.viewport.clone({scale:1,rotation:t}),this.reset()}cancelRendering(){this.renderTask&&(this.renderTask.cancel(),this.renderTask=null),this.resume=null}_getPageDrawContext(e=1){const t=document.createElement("canvas");t.mozOpaque=!0;const i=t.getContext("2d",{alpha:!1}),n=(0,_ui_utils.getOutputScale)(i);t.width=e*this.canvasWidth*n.sx|0,t.height=e*this.canvasHeight*n.sy|0;const a=n.scaled?[n.sx,0,0,n.sy,0,0]:null;return{ctx:i,canvas:t,transform:a}}_convertCanvasToImage(e){if(this.renderingState!==_pdf_rendering_queue.RenderingStates.FINISHED)throw new Error("_convertCanvasToImage: Rendering has not finished.");const t=this._reduceImage(e),i=document.createElement("img");i.className="thumbnailImage",this._thumbPageCanvas.then((e=>{i.setAttribute("aria-label",e)})),i.style.width=this.canvasWidth+"px",i.style.height=this.canvasHeight+"px",i.src=t.toDataURL(),this.image=i,this.div.setAttribute("data-loaded",!0),this.ring.appendChild(i),t.width=0,t.height=0}draw(){if(this.renderingState!==_pdf_rendering_queue.RenderingStates.INITIAL)return console.error("Must be in new state before drawing"),Promise.resolve(void 0);const{pdfPage:e}=this;if(!e)return this.renderingState=_pdf_rendering_queue.RenderingStates.FINISHED,Promise.reject(new Error("pdfPage is not loaded"));this.renderingState=_pdf_rendering_queue.RenderingStates.RUNNING;const t=async(e=null)=>{if(d===this.renderTask&&(this.renderTask=null),!(e instanceof _pdf.RenderingCancelledException)&&(this.renderingState=_pdf_rendering_queue.RenderingStates.FINISHED,this._convertCanvasToImage(n),e))throw e},{ctx:i,canvas:n,transform:a}=this._getPageDrawContext(DRAW_UPSCALE_FACTOR),s=this.viewport.clone({scale:DRAW_UPSCALE_FACTOR*this.scale}),r=e=>{if(!this.renderingQueue.isHighestPriority(this))return this.renderingState=_pdf_rendering_queue.RenderingStates.PAUSED,void(this.resume=()=>{this.renderingState=_pdf_rendering_queue.RenderingStates.RUNNING,e()});e()},h={canvasContext:i,transform:a,viewport:s,optionalContentConfigPromise:this._optionalContentConfigPromise},d=this.renderTask=e.render(h);d.onContinue=r;const o=d.promise.then((function(){return t(null)}),(function(e){return t(e)}));return o.finally((()=>{n.width=0,n.height=0;const e=this.linkService.isPageCached(this.id);e||this.pdfPage?.cleanup()})),o}setImage(e){if(this._checkSetImageDisabled())return;if(this.renderingState!==_pdf_rendering_queue.RenderingStates.INITIAL)return;const{canvas:t,pdfPage:i}=e;t&&(this.pdfPage||this.setPdfPage(i),this.renderingState=_pdf_rendering_queue.RenderingStates.FINISHED,this._convertCanvasToImage(t))}_reduceImage(e){const{ctx:t,canvas:i}=this._getPageDrawContext();if(e.width<=2*i.width)return t.drawImage(e,0,0,e.width,e.height,0,0,i.width,i.height),i;let n=i.width<<MAX_NUM_SCALING_STEPS,a=i.height<<MAX_NUM_SCALING_STEPS;const[s,r]=TempImageFactory.getCanvas(n,a);while(n>e.width||a>e.height)n>>=1,a>>=1;r.drawImage(e,0,0,e.width,e.height,0,0,n,a);while(n>2*i.width)r.drawImage(s,0,0,n,a,0,0,n>>1,a>>1),n>>=1,a>>=1;return t.drawImage(s,0,0,n,a,0,0,i.width,i.height),i}get _thumbPageTitle(){return this.l10n.get("thumb_page_title",{page:this.pageLabel??this.id})}get _thumbPageCanvas(){return this.l10n.get("thumb_page_canvas",{page:this.pageLabel??this.id})}setPageLabel(e){this.pageLabel="string"===typeof e?e:null,this._thumbPageTitle.then((e=>{this.anchor.title=e})),this.renderingState===_pdf_rendering_queue.RenderingStates.FINISHED&&this._thumbPageCanvas.then((e=>{this.image?.setAttribute("aria-label",e)}))}}exports.PDFThumbnailView=PDFThumbnailView;