"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PDFDocumentProperties=void 0;var _pdf=require("../pdf"),_ui_utils=require("./ui_utils.js");const DEFAULT_FIELD_CONTENT="-",NON_METRIC_LOCALES=["en-us","en-lr","my"],US_PAGE_NAMES={"8.5x11":"Letter","8.5x14":"Legal"},METRIC_PAGE_NAMES={"297x420":"A3","210x297":"A4"};function getPageName(e,t,i){const a=t?e.width:e.height,s=t?e.height:e.width;return i[`${a}x${s}`]}class PDFDocumentProperties{constructor({overlayName:e,fields:t,container:i,closeButton:a},s,r,n){this.overlayName=e,this.fields=t,this.container=i,this.overlayManager=s,this.l10n=n,this._reset(),a.addEventListener("click",this.close.bind(this)),this.overlayManager.register(this.overlayName,this.container,this.close.bind(this)),r._on("pagechanging",(e=>{this._currentPageNumber=e.pageNumber})),r._on("rotationchanging",(e=>{this._pagesRotation=e.pagesRotation})),this._isNonMetricLocale=!0,n.getLanguage().then((e=>{this._isNonMetricLocale=NON_METRIC_LOCALES.includes(e)}))}async open(){const e=e=>{Object.defineProperty(this,"fieldData",{value:Object.freeze(e),writable:!1,enumerable:!0,configurable:!0})};await Promise.all([this.overlayManager.open(this.overlayName),this._dataAvailableCapability.promise]);const t=this._currentPageNumber,i=this._pagesRotation;if(this.fieldData&&t===this.fieldData._currentPageNumber&&i===this.fieldData._pagesRotation)return void this._updateUI();const{info:a,contentDispositionFilename:s,contentLength:r}=await this.pdfDocument.getMetadata(),[n,o,h,l,_,c]=await Promise.all([s||(0,_pdf.getPdfFilenameFromUrl)(this.url),this._parseFileSize(r),this._parseDate(a.CreationDate),this._parseDate(a.ModDate),this.pdfDocument.getPage(t).then((e=>this._parsePageSize((0,_ui_utils.getPageSizeInches)(e),i))),this._parseLinearization(a.IsLinearized)]);e({fileName:n,fileSize:o,title:a.Title,author:a.Author,subject:a.Subject,keywords:a.Keywords,creationDate:h,modificationDate:l,creator:a.Creator,producer:a.Producer,version:a.PDFFormatVersion,pageCount:this.pdfDocument.numPages,pageSize:_,linearized:c,_currentPageNumber:t,_pagesRotation:i}),this._updateUI();const{length:d}=await this.pdfDocument.getDownloadInfo();if(r===d)return;const g=Object.assign(Object.create(null),this.fieldData);g.fileSize=await this._parseFileSize(d),e(g),this._updateUI()}close(){this.overlayManager.close(this.overlayName)}setDocument(e,t=null){this.pdfDocument&&(this._reset(),this._updateUI(!0)),e&&(this.pdfDocument=e,this.url=t,this._dataAvailableCapability.resolve())}_reset(){this.pdfDocument=null,this.url=null,delete this.fieldData,this._dataAvailableCapability=(0,_pdf.createPromiseCapability)(),this._currentPageNumber=1,this._pagesRotation=0}_updateUI(e=!1){if(!e&&this.fieldData){if(this.overlayManager.active===this.overlayName)for(const t in this.fields){const e=this.fieldData[t];this.fields[t].textContent=e||0===e?e:DEFAULT_FIELD_CONTENT}}else for(const t in this.fields)this.fields[t].textContent=DEFAULT_FIELD_CONTENT}async _parseFileSize(e=0){const t=e/1024,i=t/1024;if(t)return this.l10n.get("document_properties_"+(i>=1?"mb":"kb"),{size_mb:i>=1&&(+i.toPrecision(3)).toLocaleString(),size_kb:i<1&&(+t.toPrecision(3)).toLocaleString(),size_b:e.toLocaleString()})}async _parsePageSize(e,t){if(!e)return;t%180!==0&&(e={width:e.height,height:e.width});const i=(0,_ui_utils.isPortraitOrientation)(e);let a={width:Math.round(100*e.width)/100,height:Math.round(100*e.height)/100},s={width:Math.round(25.4*e.width*10)/10,height:Math.round(25.4*e.height*10)/10},r=getPageName(a,i,US_PAGE_NAMES)||getPageName(s,i,METRIC_PAGE_NAMES);if(!r&&(!Number.isInteger(s.width)||!Number.isInteger(s.height))){const t={width:25.4*e.width,height:25.4*e.height},n={width:Math.round(s.width),height:Math.round(s.height)};Math.abs(t.width-n.width)<.1&&Math.abs(t.height-n.height)<.1&&(r=getPageName(n,i,METRIC_PAGE_NAMES),r&&(a={width:Math.round(n.width/25.4*100)/100,height:Math.round(n.height/25.4*100)/100},s=n))}const[{width:n,height:o},h,l,_]=await Promise.all([this._isNonMetricLocale?a:s,this.l10n.get("document_properties_page_size_unit_"+(this._isNonMetricLocale?"inches":"millimeters")),r&&this.l10n.get(`document_properties_page_size_name_${r.toLowerCase()}`),this.l10n.get("document_properties_page_size_orientation_"+(i?"portrait":"landscape"))]);return this.l10n.get(`document_properties_page_size_dimension_${l?"name_":""}string`,{width:n.toLocaleString(),height:o.toLocaleString(),unit:h,name:l,orientation:_})}async _parseDate(e){const t=_pdf.PDFDateString.toDateObject(e);if(t)return this.l10n.get("document_properties_date_string",{date:t.toLocaleDateString(),time:t.toLocaleTimeString()})}_parseLinearization(e){return this.l10n.get("document_properties_linearized_"+(e?"yes":"no"))}}exports.PDFDocumentProperties=PDFDocumentProperties;