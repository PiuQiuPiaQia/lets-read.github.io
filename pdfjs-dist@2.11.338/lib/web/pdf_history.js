"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.isDestArraysEqual=isDestArraysEqual,exports.isDestHashesEqual=isDestHashesEqual,exports.PDFHistory=void 0;var _ui_utils=require("./ui_utils.js");const HASH_CHANGE_TIMEOUT=1e3,POSITION_UPDATED_THRESHOLD=50,UPDATE_VIEWAREA_TIMEOUT=1e3;function getCurrentHash(){return document.location.hash}class PDFHistory{constructor({linkService:t,eventBus:i}){this.linkService=t,this.eventBus=i,this._initialized=!1,this._fingerprint="",this.reset(),this._boundEvents=null,this._isViewerInPresentationMode=!1,this.eventBus._on("presentationmodechanged",(t=>{this._isViewerInPresentationMode=t.state!==_ui_utils.PresentationModeState.NORMAL})),this.eventBus._on("pagesinit",(()=>{this._isPagesLoaded=!1,this.eventBus._on("pagesloaded",(t=>{this._isPagesLoaded=!!t.pagesCount}),{once:!0})}))}initialize({fingerprint:t,resetHistory:i=!1,updateUrl:e=!1}){if(!t||"string"!==typeof t)return void console.error('PDFHistory.initialize: The "fingerprint" must be a non-empty string.');this._initialized&&this.reset();const s=""!==this._fingerprint&&this._fingerprint!==t;this._fingerprint=t,this._updateUrl=!0===e,this._initialized=!0,this._bindEvents();const n=window.history.state;if(this._popStateInProgress=!1,this._blockHashChange=0,this._currentHash=getCurrentHash(),this._numPositionUpdates=0,this._uid=this._maxUid=0,this._destination=null,this._position=null,!this._isValidState(n,!0)||i){const{hash:t,page:e,rotation:n}=this._parseCurrentHash(!0);return!t||s||i?void this._pushOrReplaceState(null,!0):void this._pushOrReplaceState({hash:t,page:e,rotation:n},!0)}const a=n.destination;this._updateInternalState(a,n.uid,!0),void 0!==a.rotation&&(this._initialRotation=a.rotation),a.dest?(this._initialBookmark=JSON.stringify(a.dest),this._destination.page=null):a.hash?this._initialBookmark=a.hash:a.page&&(this._initialBookmark=`page=${a.page}`)}reset(){this._initialized&&(this._pageHide(),this._initialized=!1,this._unbindEvents()),this._updateViewareaTimeout&&(clearTimeout(this._updateViewareaTimeout),this._updateViewareaTimeout=null),this._initialBookmark=null,this._initialRotation=null}push({namedDest:t=null,explicitDest:i,pageNumber:e}){if(!this._initialized)return;if(t&&"string"!==typeof t)return void console.error(`PDFHistory.push: "${t}" is not a valid namedDest parameter.`);if(!Array.isArray(i))return void console.error(`PDFHistory.push: "${i}" is not a valid explicitDest parameter.`);if(!this._isValidPage(e)&&(null!==e||this._destination))return void console.error(`PDFHistory.push: "${e}" is not a valid pageNumber parameter.`);const s=t||JSON.stringify(i);if(!s)return;let n=!1;if(this._destination&&(isDestHashesEqual(this._destination.hash,s)||isDestArraysEqual(this._destination.dest,i))){if(this._destination.page)return;n=!0}this._popStateInProgress&&!n||(this._pushOrReplaceState({dest:i,hash:s,page:e,rotation:this.linkService.rotation},n),this._popStateInProgress||(this._popStateInProgress=!0,Promise.resolve().then((()=>{this._popStateInProgress=!1}))))}pushPage(t){this._initialized&&(this._isValidPage(t)?this._destination?.page!==t&&(this._popStateInProgress||(this._pushOrReplaceState({dest:null,hash:`page=${t}`,page:t,rotation:this.linkService.rotation}),this._popStateInProgress||(this._popStateInProgress=!0,Promise.resolve().then((()=>{this._popStateInProgress=!1}))))):console.error(`PDFHistory.pushPage: "${t}" is not a valid page number.`))}pushCurrentPosition(){this._initialized&&!this._popStateInProgress&&this._tryPushCurrentPosition()}back(){if(!this._initialized||this._popStateInProgress)return;const t=window.history.state;this._isValidState(t)&&t.uid>0&&window.history.back()}forward(){if(!this._initialized||this._popStateInProgress)return;const t=window.history.state;this._isValidState(t)&&t.uid<this._maxUid&&window.history.forward()}get popStateInProgress(){return this._initialized&&(this._popStateInProgress||this._blockHashChange>0)}get initialBookmark(){return this._initialized?this._initialBookmark:null}get initialRotation(){return this._initialized?this._initialRotation:null}_pushOrReplaceState(t,i=!1){const e=i||!this._destination,s={fingerprint:this._fingerprint,uid:e?this._uid:this._uid+1,destination:t};let n;if(this._updateInternalState(t,s.uid),this._updateUrl&&t?.hash){const i=document.location.href.split("#")[0];i.startsWith("file://")||(n=`${i}#${t.hash}`)}e?window.history.replaceState(s,"",n):window.history.pushState(s,"",n)}_tryPushCurrentPosition(t=!1){if(!this._position)return;let i=this._position;if(t&&(i=Object.assign(Object.create(null),this._position),i.temporary=!0),!this._destination)return void this._pushOrReplaceState(i);if(this._destination.temporary)return void this._pushOrReplaceState(i,!0);if(this._destination.hash===i.hash)return;if(!this._destination.page&&(POSITION_UPDATED_THRESHOLD<=0||this._numPositionUpdates<=POSITION_UPDATED_THRESHOLD))return;let e=!1;if(this._destination.page>=i.first&&this._destination.page<=i.page){if(void 0!==this._destination.dest||!this._destination.first)return;e=!0}this._pushOrReplaceState(i,e)}_isValidPage(t){return Number.isInteger(t)&&t>0&&t<=this.linkService.pagesCount}_isValidState(t,i=!1){if(!t)return!1;if(t.fingerprint!==this._fingerprint){if(!i)return!1;{if("string"!==typeof t.fingerprint||t.fingerprint.length!==this._fingerprint.length)return!1;const[i]=performance.getEntriesByType("navigation");if("reload"!==i?.type)return!1}}return!(!Number.isInteger(t.uid)||t.uid<0)&&(null!==t.destination&&"object"===typeof t.destination)}_updateInternalState(t,i,e=!1){this._updateViewareaTimeout&&(clearTimeout(this._updateViewareaTimeout),this._updateViewareaTimeout=null),e&&t?.temporary&&delete t.temporary,this._destination=t,this._uid=i,this._maxUid=Math.max(this._maxUid,i),this._numPositionUpdates=0}_parseCurrentHash(t=!1){const i=unescape(getCurrentHash()).substring(1),e=(0,_ui_utils.parseQueryString)(i),s=e.get("nameddest")||"";let n=0|e.get("page");return(!this._isValidPage(n)||t&&s.length>0)&&(n=null),{hash:i,page:n,rotation:this.linkService.rotation}}_updateViewarea({location:t}){this._updateViewareaTimeout&&(clearTimeout(this._updateViewareaTimeout),this._updateViewareaTimeout=null),this._position={hash:this._isViewerInPresentationMode?`page=${t.pageNumber}`:t.pdfOpenParams.substring(1),page:this.linkService.page,first:t.pageNumber,rotation:t.rotation},this._popStateInProgress||(POSITION_UPDATED_THRESHOLD>0&&this._isPagesLoaded&&this._destination&&!this._destination.page&&this._numPositionUpdates++,UPDATE_VIEWAREA_TIMEOUT>0&&(this._updateViewareaTimeout=setTimeout((()=>{this._popStateInProgress||this._tryPushCurrentPosition(!0),this._updateViewareaTimeout=null}),UPDATE_VIEWAREA_TIMEOUT)))}_popState({state:t}){const i=getCurrentHash(),e=this._currentHash!==i;if(this._currentHash=i,!t){this._uid++;const{hash:t,page:i,rotation:e}=this._parseCurrentHash();return void this._pushOrReplaceState({hash:t,page:i,rotation:e},!0)}if(!this._isValidState(t))return;this._popStateInProgress=!0,e&&(this._blockHashChange++,(0,_ui_utils.waitOnEventOrTimeout)({target:window,name:"hashchange",delay:HASH_CHANGE_TIMEOUT}).then((()=>{this._blockHashChange--})));const s=t.destination;this._updateInternalState(s,t.uid,!0),(0,_ui_utils.isValidRotation)(s.rotation)&&(this.linkService.rotation=s.rotation),s.dest?this.linkService.goToDestination(s.dest):s.hash?this.linkService.setHash(s.hash):s.page&&(this.linkService.page=s.page),Promise.resolve().then((()=>{this._popStateInProgress=!1}))}_pageHide(){this._destination&&!this._destination.temporary||this._tryPushCurrentPosition()}_bindEvents(){this._boundEvents||(this._boundEvents={updateViewarea:this._updateViewarea.bind(this),popState:this._popState.bind(this),pageHide:this._pageHide.bind(this)},this.eventBus._on("updateviewarea",this._boundEvents.updateViewarea),window.addEventListener("popstate",this._boundEvents.popState),window.addEventListener("pagehide",this._boundEvents.pageHide))}_unbindEvents(){this._boundEvents&&(this.eventBus._off("updateviewarea",this._boundEvents.updateViewarea),window.removeEventListener("popstate",this._boundEvents.popState),window.removeEventListener("pagehide",this._boundEvents.pageHide),this._boundEvents=null)}}function isDestHashesEqual(t,i){if("string"!==typeof t||"string"!==typeof i)return!1;if(t===i)return!0;const e=(0,_ui_utils.parseQueryString)(t).get("nameddest");return e===i}function isDestArraysEqual(t,i){function e(t,i){if(typeof t!==typeof i)return!1;if(Array.isArray(t)||Array.isArray(i))return!1;if(null!==t&&"object"===typeof t&&null!==i){if(Object.keys(t).length!==Object.keys(i).length)return!1;for(const s in t)if(!e(t[s],i[s]))return!1;return!0}return t===i||Number.isNaN(t)&&Number.isNaN(i)}if(!Array.isArray(t)||!Array.isArray(i))return!1;if(t.length!==i.length)return!1;for(let s=0,n=t.length;s<n;s++)if(!e(t[s],i[s]))return!1;return!0}exports.PDFHistory=PDFHistory;