"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PDFPresentationMode=void 0;var _ui_utils=require("./ui_utils.js");const DELAY_BEFORE_RESETTING_SWITCH_IN_PROGRESS=1500,DELAY_BEFORE_HIDING_CONTROLS=3e3,ACTIVE_SELECTOR="pdfPresentationMode",CONTROLS_SELECTOR="pdfPresentationModeControls",MOUSE_SCROLL_COOLDOWN_TIME=50,PAGE_SWITCH_THRESHOLD=.1,SWIPE_MIN_DISTANCE_THRESHOLD=50,SWIPE_ANGLE_THRESHOLD=Math.PI/6;class PDFPresentationMode{constructor({container:e,pdfViewer:t,eventBus:s}){this.container=e,this.pdfViewer=t,this.eventBus=s,this.active=!1,this.args=null,this.contextMenuOpen=!1,this.mouseScrollTimeStamp=0,this.mouseScrollDelta=0,this.touchSwipeState=null}request(){if(this.switchInProgress||this.active||!this.pdfViewer.pagesCount)return!1;if(this._addFullscreenChangeListeners(),this._setSwitchInProgress(),this._notifyStateChange(),this.container.requestFullscreen)this.container.requestFullscreen();else if(this.container.mozRequestFullScreen)this.container.mozRequestFullScreen();else{if(!this.container.webkitRequestFullscreen)return!1;this.container.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}return this.args={page:this.pdfViewer.currentPageNumber,previousScale:this.pdfViewer.currentScaleValue},!0}_mouseWheel(e){if(!this.active)return;e.preventDefault();const t=(0,_ui_utils.normalizeWheelEventDelta)(e),s=Date.now(),i=this.mouseScrollTimeStamp;if(!(s>i&&s-i<MOUSE_SCROLL_COOLDOWN_TIME)&&((this.mouseScrollDelta>0&&t<0||this.mouseScrollDelta<0&&t>0)&&this._resetMouseScrollState(),this.mouseScrollDelta+=t,Math.abs(this.mouseScrollDelta)>=PAGE_SWITCH_THRESHOLD)){const e=this.mouseScrollDelta;this._resetMouseScrollState();const t=e>0?this.pdfViewer.previousPage():this.pdfViewer.nextPage();t&&(this.mouseScrollTimeStamp=s)}}get isFullscreen(){return!!(document.fullscreenElement||document.mozFullScreen||document.webkitIsFullScreen)}_notifyStateChange(){let e=_ui_utils.PresentationModeState.NORMAL;this.switchInProgress?e=_ui_utils.PresentationModeState.CHANGING:this.active&&(e=_ui_utils.PresentationModeState.FULLSCREEN),this.eventBus.dispatch("presentationmodechanged",{source:this,state:e})}_setSwitchInProgress(){this.switchInProgress&&clearTimeout(this.switchInProgress),this.switchInProgress=setTimeout((()=>{this._removeFullscreenChangeListeners(),delete this.switchInProgress,this._notifyStateChange()}),DELAY_BEFORE_RESETTING_SWITCH_IN_PROGRESS)}_resetSwitchInProgress(){this.switchInProgress&&(clearTimeout(this.switchInProgress),delete this.switchInProgress)}_enter(){this.active=!0,this._resetSwitchInProgress(),this._notifyStateChange(),this.container.classList.add(ACTIVE_SELECTOR),setTimeout((()=>{this.pdfViewer.currentPageNumber=this.args.page,this.pdfViewer.currentScaleValue="page-fit"}),0),this._addWindowListeners(),this._showControls(),this.contextMenuOpen=!1,window.getSelection().removeAllRanges()}_exit(){const e=this.pdfViewer.currentPageNumber;this.container.classList.remove(ACTIVE_SELECTOR),setTimeout((()=>{this.active=!1,this._removeFullscreenChangeListeners(),this._notifyStateChange(),this.pdfViewer.currentScaleValue=this.args.previousScale,this.pdfViewer.currentPageNumber=e,this.args=null}),0),this._removeWindowListeners(),this._hideControls(),this._resetMouseScrollState(),this.contextMenuOpen=!1}_mouseDown(e){if(this.contextMenuOpen)return this.contextMenuOpen=!1,void e.preventDefault();if(0===e.button){const t=e.target.href&&e.target.classList.contains("internalLink");t||(e.preventDefault(),e.shiftKey?this.pdfViewer.previousPage():this.pdfViewer.nextPage())}}_contextMenu(){this.contextMenuOpen=!0}_showControls(){this.controlsTimeout?clearTimeout(this.controlsTimeout):this.container.classList.add(CONTROLS_SELECTOR),this.controlsTimeout=setTimeout((()=>{this.container.classList.remove(CONTROLS_SELECTOR),delete this.controlsTimeout}),DELAY_BEFORE_HIDING_CONTROLS)}_hideControls(){this.controlsTimeout&&(clearTimeout(this.controlsTimeout),this.container.classList.remove(CONTROLS_SELECTOR),delete this.controlsTimeout)}_resetMouseScrollState(){this.mouseScrollTimeStamp=0,this.mouseScrollDelta=0}_touchSwipe(e){if(this.active)if(e.touches.length>1)this.touchSwipeState=null;else switch(e.type){case"touchstart":this.touchSwipeState={startX:e.touches[0].pageX,startY:e.touches[0].pageY,endX:e.touches[0].pageX,endY:e.touches[0].pageY};break;case"touchmove":if(null===this.touchSwipeState)return;this.touchSwipeState.endX=e.touches[0].pageX,this.touchSwipeState.endY=e.touches[0].pageY,e.preventDefault();break;case"touchend":if(null===this.touchSwipeState)return;let t=0;const s=this.touchSwipeState.endX-this.touchSwipeState.startX,i=this.touchSwipeState.endY-this.touchSwipeState.startY,n=Math.abs(Math.atan2(i,s));Math.abs(s)>SWIPE_MIN_DISTANCE_THRESHOLD&&(n<=SWIPE_ANGLE_THRESHOLD||n>=Math.PI-SWIPE_ANGLE_THRESHOLD)?t=s:Math.abs(i)>SWIPE_MIN_DISTANCE_THRESHOLD&&Math.abs(n-Math.PI/2)<=SWIPE_ANGLE_THRESHOLD&&(t=i),t>0?this.pdfViewer.previousPage():t<0&&this.pdfViewer.nextPage();break}}_addWindowListeners(){this.showControlsBind=this._showControls.bind(this),this.mouseDownBind=this._mouseDown.bind(this),this.mouseWheelBind=this._mouseWheel.bind(this),this.resetMouseScrollStateBind=this._resetMouseScrollState.bind(this),this.contextMenuBind=this._contextMenu.bind(this),this.touchSwipeBind=this._touchSwipe.bind(this),window.addEventListener("mousemove",this.showControlsBind),window.addEventListener("mousedown",this.mouseDownBind),window.addEventListener("wheel",this.mouseWheelBind,{passive:!1}),window.addEventListener("keydown",this.resetMouseScrollStateBind),window.addEventListener("contextmenu",this.contextMenuBind),window.addEventListener("touchstart",this.touchSwipeBind),window.addEventListener("touchmove",this.touchSwipeBind),window.addEventListener("touchend",this.touchSwipeBind)}_removeWindowListeners(){window.removeEventListener("mousemove",this.showControlsBind),window.removeEventListener("mousedown",this.mouseDownBind),window.removeEventListener("wheel",this.mouseWheelBind,{passive:!1}),window.removeEventListener("keydown",this.resetMouseScrollStateBind),window.removeEventListener("contextmenu",this.contextMenuBind),window.removeEventListener("touchstart",this.touchSwipeBind),window.removeEventListener("touchmove",this.touchSwipeBind),window.removeEventListener("touchend",this.touchSwipeBind),delete this.showControlsBind,delete this.mouseDownBind,delete this.mouseWheelBind,delete this.resetMouseScrollStateBind,delete this.contextMenuBind,delete this.touchSwipeBind}_fullscreenChange(){this.isFullscreen?this._enter():this._exit()}_addFullscreenChangeListeners(){this.fullscreenChangeBind=this._fullscreenChange.bind(this),window.addEventListener("fullscreenchange",this.fullscreenChangeBind),window.addEventListener("mozfullscreenchange",this.fullscreenChangeBind),window.addEventListener("webkitfullscreenchange",this.fullscreenChangeBind)}_removeFullscreenChangeListeners(){window.removeEventListener("fullscreenchange",this.fullscreenChangeBind),window.removeEventListener("mozfullscreenchange",this.fullscreenChangeBind),window.removeEventListener("webkitfullscreenchange",this.fullscreenChangeBind),delete this.fullscreenChangeBind}}exports.PDFPresentationMode=PDFPresentationMode;