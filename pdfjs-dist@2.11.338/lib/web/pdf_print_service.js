"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PDFPrintService=PDFPrintService;var _pdf=require("../pdf"),_app=require("./app.js"),_app_options=require("./app_options.js"),_print_utils=require("./print_utils.js");let activeService=null,overlayManager=null;function renderPage(e,t,r,i,n,o){const a=activeService.scratchCanvas,s=n/_pdf.PixelsPerInch.PDF;a.width=Math.floor(i.width*s),a.height=Math.floor(i.height*s);const c=a.getContext("2d");return c.save(),c.fillStyle="rgb(255, 255, 255)",c.fillRect(0,0,a.width,a.height),c.restore(),t.getPage(r).then((function(e){const t={canvasContext:c,transform:[s,0,0,s,0,0],viewport:e.getViewport({scale:1,rotation:i.rotation}),intent:"print",annotationMode:_pdf.AnnotationMode.ENABLE_STORAGE,optionalContentConfigPromise:o};return e.render(t).promise}))}function PDFPrintService(e,t,r,i,n=null,o){this.pdfDocument=e,this.pagesOverview=t,this.printContainer=r,this._printResolution=i||150,this._optionalContentConfigPromise=n||e.getOptionalContentConfig(),this.l10n=o,this.currentPage=-1,this.scratchCanvas=document.createElement("canvas")}PDFPrintService.prototype={layout(){this.throwIfInactive();const e=document.querySelector("body");e.setAttribute("data-pdfjsprinting",!0);const t=this.pagesOverview.every((function(e){return e.width===this.pagesOverview[0].width&&e.height===this.pagesOverview[0].height}),this);t||console.warn("Not all pages have the same size. The printed result may be incorrect!"),this.pageStyleSheet=document.createElement("style");const r=this.pagesOverview[0];this.pageStyleSheet.textContent="@page { size: "+r.width+"pt "+r.height+"pt;}",e.appendChild(this.pageStyleSheet)},destroy(){if(activeService!==this)return;this.printContainer.textContent="";const e=document.querySelector("body");e.removeAttribute("data-pdfjsprinting"),this.pageStyleSheet&&(this.pageStyleSheet.remove(),this.pageStyleSheet=null),this.scratchCanvas.width=this.scratchCanvas.height=0,this.scratchCanvas=null,activeService=null,ensureOverlay().then((function(){"printServiceOverlay"===overlayManager.active&&overlayManager.close("printServiceOverlay")}))},renderPages(){if(this.pdfDocument.isPureXfa)return(0,_print_utils.getXfaHtmlForPrinting)(this.printContainer,this.pdfDocument),Promise.resolve();const e=this.pagesOverview.length,t=(r,i)=>{if(this.throwIfInactive(),++this.currentPage>=e)return renderProgress(e,e,this.l10n),void r();const n=this.currentPage;renderProgress(n,e,this.l10n),renderPage(this,this.pdfDocument,n+1,this.pagesOverview[n],this._printResolution,this._optionalContentConfigPromise).then(this.useRenderedPage.bind(this)).then((function(){t(r,i)}),i)};return new Promise(t)},useRenderedPage(){this.throwIfInactive();const e=document.createElement("img"),t=this.scratchCanvas;"toBlob"in t&&!_app_options.compatibilityParams.disableCreateObjectURL?t.toBlob((function(t){e.src=URL.createObjectURL(t)})):e.src=t.toDataURL();const r=document.createElement("div");return r.className="printedPage",r.appendChild(e),this.printContainer.appendChild(r),new Promise((function(t,r){e.onload=t,e.onerror=r}))},performPrint(){return this.throwIfInactive(),new Promise((e=>{setTimeout((()=>{this.active?(print.call(window),setTimeout(e,20)):e()}),0)}))},get active(){return this===activeService},throwIfInactive(){if(!this.active)throw new Error("This print request was cancelled or completed.")}};const print=window.print;function dispatchEvent(e){const t=document.createEvent("CustomEvent");t.initCustomEvent(e,!1,!1,"custom"),window.dispatchEvent(t)}function abort(){activeService&&(activeService.destroy(),dispatchEvent("afterprint"))}function renderProgress(e,t,r){const i=document.getElementById("printServiceOverlay"),n=Math.round(100*e/t),o=i.querySelector("progress"),a=i.querySelector(".relative-progress");o.value=n,r.get("print_progress_percent",{progress:n}).then((e=>{a.textContent=e}))}if(window.print=function(){if(activeService)console.warn("Ignored window.print() because of a pending print job.");else{ensureOverlay().then((function(){activeService&&overlayManager.open("printServiceOverlay")}));try{dispatchEvent("beforeprint")}finally{if(!activeService)return console.error("Expected print service to be initialized."),void ensureOverlay().then((function(){"printServiceOverlay"===overlayManager.active&&overlayManager.close("printServiceOverlay")}));const e=activeService;activeService.renderPages().then((function(){return e.performPrint()})).catch((function(){})).then((function(){e.active&&abort()}))}}},window.addEventListener("keydown",(function(e){80!==e.keyCode||!e.ctrlKey&&!e.metaKey||e.altKey||e.shiftKey&&!window.chrome&&!window.opera||(window.print(),e.preventDefault(),e.stopImmediatePropagation?e.stopImmediatePropagation():e.stopPropagation())}),!0),"onbeforeprint"in window){const e=function(e){"custom"!==e.detail&&e.stopImmediatePropagation&&e.stopImmediatePropagation()};window.addEventListener("beforeprint",e),window.addEventListener("afterprint",e)}let overlayPromise;function ensureOverlay(){if(!overlayPromise){if(overlayManager=_app.PDFViewerApplication.overlayManager,!overlayManager)throw new Error("The overlay manager has not yet been initialized.");overlayPromise=overlayManager.register("printServiceOverlay",document.getElementById("printServiceOverlay"),abort,!0),document.getElementById("printCancel").onclick=abort}return overlayPromise}_app.PDFPrintServiceFactory.instance={supportsPrinting:!0,createPrintService(e,t,r,i,n,o){if(activeService)throw new Error("The print service is created and active.");return activeService=new PDFPrintService(e,t,r,i,n,o),activeService}};