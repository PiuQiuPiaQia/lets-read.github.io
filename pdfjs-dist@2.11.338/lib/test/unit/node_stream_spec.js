"use strict";var _util=require("../../shared/util.js"),_is_node=require("../../shared/is_node.js"),_node_stream=require("../../display/node_stream.js");if(!_is_node.isNodeJS)throw new Error('The "node_stream" unit-tests can only be run in Node.js environments.');const path=require("path"),url=require("url"),http=require("http"),fs=require("fs");describe("node_stream",(function(){let e=null,t=null;const n=url.parse(encodeURI("file://"+path.join(process.cwd(),"./test/pdfs/tracemonkey.pdf"))).href,a=1016315;beforeAll((function(){e=http.createServer(((e,t)=>{const n=process.cwd()+"/test/pdfs"+e.url;fs.lstat(n,((a,r)=>{if(a)return t.writeHead(404),void t.end(`File ${e.url} not found!`);if(e.headers.range){const[a,r]=e.headers.range.split("=")[1].split("-").map((e=>Number(e))),o=fs.createReadStream(n,{start:a,end:r});t.writeHead(206,{"Content-Type":"application/pdf"}),o.pipe(t)}else{const e=r.size,a=fs.createReadStream(n);t.writeHead(200,{"Content-Type":"application/pdf","Content-Length":e,"Accept-Ranges":"bytes"}),a.pipe(t)}}))})).listen(0),t=e.address().port})),afterAll((function(){e.close()})),it("read both http(s) and filesystem pdf files",(async function(){const e=new _node_stream.PDFNodeStream({url:`http://127.0.0.1:${t}/tracemonkey.pdf`,rangeChunkSize:65536,disableStream:!0,disableRange:!0}),r=new _node_stream.PDFNodeStream({url:n,rangeChunkSize:65536,disableStream:!0,disableRange:!0}),o=e.getFullReader(),l=r.getFullReader();let s,u;const i=o.headersReady.then((()=>{s=o.isStreamingSupported,u=o.isRangeSupported}));let d,p;const c=l.headersReady.then((()=>{d=l.isStreamingSupported,p=l.isRangeSupported}));let f=0,h=0;const g=function(){return o.read().then((function(e){if(!e.done)return f+=e.value.byteLength,g()}))},m=function(){return l.read().then((function(e){if(!e.done)return h+=e.value.byteLength,m()}))};await Promise.all([g(),m(),i,c]),expect(s).toEqual(!1),expect(u).toEqual(!1),expect(d).toEqual(!1),expect(p).toEqual(!1),expect(f).toEqual(a),expect(f).toEqual(h)})),it("read custom ranges for both http(s) and filesystem urls",(async function(){const e=32768,r=new _node_stream.PDFNodeStream({url:`http://127.0.0.1:${t}/tracemonkey.pdf`,length:a,rangeChunkSize:e,disableStream:!0,disableRange:!1}),o=new _node_stream.PDFNodeStream({url:n,length:a,rangeChunkSize:e,disableStream:!0,disableRange:!1}),l=r.getFullReader(),s=o.getFullReader();let u,i,d,p,c,f;const h=l.headersReady.then((function(){u=l.isStreamingSupported,i=l.isRangeSupported,l.cancel(new _util.AbortException("Don't need fullReader1.")),d=!0})),g=s.headersReady.then((function(){p=s.isStreamingSupported,c=s.isRangeSupported,s.cancel(new _util.AbortException("Don't need fullReader2.")),f=!0})),m=a%e||e,R=r.getRangeReader(a-m-e,a-m),S=r.getRangeReader(a-m,a),q=o.getRangeReader(a-m-e,a-m),_=o.getRangeReader(a-m,a),b={value:0},y={value:0},E={value:0},x={value:0},v=function(e,t){return e.read().then((function(n){if(!n.done)return t.value+=n.value.byteLength,v(e,t)}))};await Promise.all([v(R,b),v(S,y),v(q,E),v(_,x),h,g]),expect(b.value).toEqual(e),expect(y.value).toEqual(m),expect(E.value).toEqual(e),expect(x.value).toEqual(m),expect(u).toEqual(!1),expect(i).toEqual(!0),expect(d).toEqual(!0),expect(p).toEqual(!1),expect(c).toEqual(!0),expect(f).toEqual(!0)}))}));