"use strict";var _test_utils=require("./test_utils.js"),_ui_utils=require("../../web/ui_utils.js"),_api=require("../../display/api.js"),_pdf_find_controller=require("../../web/pdf_find_controller.js"),_pdf_link_service=require("../../web/pdf_link_service.js");const tracemonkeyFileName="tracemonkey.pdf";class MockLinkService extends _pdf_link_service.SimpleLinkService{constructor(){super(),this._page=1,this._pdfDocument=null}setDocument(e){this._pdfDocument=e}get pagesCount(){return this._pdfDocument.numPages}get page(){return this._page}set page(e){this._page=e}}async function initPdfFindController(e){const t=(0,_api.getDocument)((0,_test_utils.buildGetDocumentParams)(e||tracemonkeyFileName)),n=await t.promise,r=new _ui_utils.EventBus,a=new MockLinkService;a.setDocument(n);const i=new _pdf_find_controller.PDFFindController({linkService:a,eventBus:r});return i.setDocument(n),{eventBus:r,pdfFindController:i}}function testSearch({eventBus:e,pdfFindController:t,parameters:n,matchesPerPage:r,selectedMatch:a,pageMatches:i=null,pageMatchesLength:s=null}){return new Promise((function(c){t.executeCommand("find",n);let o=r.length;for(let e=o-1;e>=0;e--)if(r[e]>0){o=e+1;break}const d=r.reduce(((e,t)=>e+t));e.on("updatefindmatchescount",(function n(l){if(t.pageMatches.length===o){e.off("updatefindmatchescount",n),expect(l.matchesCount.total).toBe(d);for(let e=0;e<o;e++)expect(t.pageMatches[e].length).toEqual(r[e]);expect(t.selected.pageIdx).toEqual(a.pageIndex),expect(t.selected.matchIdx).toEqual(a.matchIndex),i&&(expect(t.pageMatches).toEqual(i),expect(t.pageMatchesLength).toEqual(s)),c()}}))}))}describe("pdf_find_controller",(function(){it("performs a normal search",(async function(){const{eventBus:e,pdfFindController:t}=await initPdfFindController();await testSearch({eventBus:e,pdfFindController:t,parameters:{query:"Dynamic",caseSensitive:!1,entireWord:!1,phraseSearch:!0,findPrevious:!1},matchesPerPage:[11,5,0,3,0,0,0,1,1,1,0,3,4,4],selectedMatch:{pageIndex:0,matchIndex:0}})})),it("performs a normal search and finds the previous result",(async function(){const{eventBus:e,pdfFindController:t}=await initPdfFindController();await testSearch({eventBus:e,pdfFindController:t,parameters:{query:"conference",caseSensitive:!1,entireWord:!1,phraseSearch:!0,findPrevious:!0},matchesPerPage:[0,0,0,0,0,0,0,0,0,0,0,0,0,5],selectedMatch:{pageIndex:13,matchIndex:4}})})),it("performs a case sensitive search",(async function(){const{eventBus:e,pdfFindController:t}=await initPdfFindController();await testSearch({eventBus:e,pdfFindController:t,parameters:{query:"Dynamic",caseSensitive:!0,entireWord:!1,phraseSearch:!0,findPrevious:!1},matchesPerPage:[3,0,0,0,0,0,0,0,0,0,0,0,1,3],selectedMatch:{pageIndex:0,matchIndex:0}})})),it("performs an entire word search",(async function(){const{eventBus:e,pdfFindController:t}=await initPdfFindController();await testSearch({eventBus:e,pdfFindController:t,parameters:{query:"Government",caseSensitive:!1,entireWord:!0,phraseSearch:!0,findPrevious:!1},matchesPerPage:[0,0,0,0,0,0,0,0,0,0,0,0,1,0],selectedMatch:{pageIndex:12,matchIndex:0}})})),it("performs a multiple term (no phrase) search",(async function(){const{eventBus:e,pdfFindController:t}=await initPdfFindController();await testSearch({eventBus:e,pdfFindController:t,parameters:{query:"alternate solution",caseSensitive:!1,entireWord:!1,phraseSearch:!1,findPrevious:!1},matchesPerPage:[0,0,0,0,0,1,0,0,4,0,0,0,0,0],selectedMatch:{pageIndex:5,matchIndex:0}})})),it("performs a normal search, where the text is normalized",(async function(){const{eventBus:e,pdfFindController:t}=await initPdfFindController("fraction-highlight.pdf");await testSearch({eventBus:e,pdfFindController:t,parameters:{query:"fraction",caseSensitive:!1,entireWord:!1,phraseSearch:!0,findPrevious:!1},matchesPerPage:[3],selectedMatch:{pageIndex:0,matchIndex:0},pageMatches:[[19,48,66]],pageMatchesLength:[[8,8,8]]})}))}));