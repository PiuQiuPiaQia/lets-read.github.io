"use strict";var _ui_utils=require("../../web/ui_utils.js"),_is_node=require("../../shared/is_node.js");describe("ui_utils",(function(){describe("binary search",(function(){function t(t){return t}function e(t){return t>3}it("empty array",(function(){expect((0,_ui_utils.binarySearchFirstItem)([],t)).toEqual(0)})),it("single boolean entry",(function(){expect((0,_ui_utils.binarySearchFirstItem)([!1],t)).toEqual(1),expect((0,_ui_utils.binarySearchFirstItem)([!0],t)).toEqual(0)})),it("three boolean entries",(function(){expect((0,_ui_utils.binarySearchFirstItem)([!0,!0,!0],t)).toEqual(0),expect((0,_ui_utils.binarySearchFirstItem)([!1,!0,!0],t)).toEqual(1),expect((0,_ui_utils.binarySearchFirstItem)([!1,!1,!0],t)).toEqual(2),expect((0,_ui_utils.binarySearchFirstItem)([!1,!1,!1],t)).toEqual(3)})),it("three numeric entries",(function(){expect((0,_ui_utils.binarySearchFirstItem)([0,1,2],e)).toEqual(3),expect((0,_ui_utils.binarySearchFirstItem)([2,3,4],e)).toEqual(2),expect((0,_ui_utils.binarySearchFirstItem)([4,5,6],e)).toEqual(0)}))})),describe("EventBus",(function(){it("dispatch event",(function(){const t=new _ui_utils.EventBus;let e=0;t.on("test",(function(t){expect(t).toEqual(void 0),e++})),t.dispatch("test"),expect(e).toEqual(1)})),it("dispatch event with arguments",(function(){const t=new _ui_utils.EventBus;let e=0;t.on("test",(function(t){expect(t).toEqual({abc:123}),e++})),t.dispatch("test",{abc:123}),expect(e).toEqual(1)})),it("dispatch different event",(function(){const t=new _ui_utils.EventBus;let e=0;t.on("test",(function(){e++})),t.dispatch("nottest"),expect(e).toEqual(0)})),it("dispatch event multiple times",(function(){const t=new _ui_utils.EventBus;let e=0;t.dispatch("test"),t.on("test",(function(){e++})),t.dispatch("test"),t.dispatch("test"),expect(e).toEqual(2)})),it("dispatch event to multiple handlers",(function(){const t=new _ui_utils.EventBus;let e=0;t.on("test",(function(){e++})),t.on("test",(function(){e++})),t.dispatch("test"),expect(e).toEqual(2)})),it("dispatch to detached",(function(){const t=new _ui_utils.EventBus;let e=0;const i=function(){e++};t.on("test",i),t.dispatch("test"),t.off("test",i),t.dispatch("test"),expect(e).toEqual(1)})),it("dispatch to wrong detached",(function(){const t=new _ui_utils.EventBus;let e=0;t.on("test",(function(){e++})),t.dispatch("test"),t.off("test",(function(){e++})),t.dispatch("test"),expect(e).toEqual(2)})),it("dispatch to detached during handling",(function(){const t=new _ui_utils.EventBus;let e=0;const i=function(){t.off("test",n),e++},n=function(){t.off("test",i),e++};t.on("test",i),t.on("test",n),t.dispatch("test"),t.dispatch("test"),expect(e).toEqual(2)})),it("dispatch event to handlers with/without 'once' option",(function(){const t=new _ui_utils.EventBus;let e=0,i=0;t.on("test",(function(){e++})),t.on("test",(function(){i++}),{once:!0}),t.dispatch("test"),t.dispatch("test"),t.dispatch("test"),expect(e).toEqual(3),expect(i).toEqual(1)})),it("should not re-dispatch to DOM",(async function(){_is_node.isNodeJS&&pending("Document is not supported in Node.js.");const t=new _ui_utils.EventBus;let e=0;function i(){expect(!1).toEqual(!0)}t.on("test",(function(t){expect(t).toEqual(void 0),e++})),document.addEventListener("test",i),t.dispatch("test"),await Promise.resolve(),expect(e).toEqual(1),document.removeEventListener("test",i)}))})),describe("isValidRotation",(function(){it("should reject non-integer angles",(function(){expect((0,_ui_utils.isValidRotation)()).toEqual(!1),expect((0,_ui_utils.isValidRotation)(null)).toEqual(!1),expect((0,_ui_utils.isValidRotation)(NaN)).toEqual(!1),expect((0,_ui_utils.isValidRotation)([90])).toEqual(!1),expect((0,_ui_utils.isValidRotation)("90")).toEqual(!1),expect((0,_ui_utils.isValidRotation)(90.5)).toEqual(!1)})),it("should reject non-multiple of 90 degree angles",(function(){expect((0,_ui_utils.isValidRotation)(45)).toEqual(!1),expect((0,_ui_utils.isValidRotation)(-123)).toEqual(!1)})),it("should accept valid angles",(function(){expect((0,_ui_utils.isValidRotation)(0)).toEqual(!0),expect((0,_ui_utils.isValidRotation)(90)).toEqual(!0),expect((0,_ui_utils.isValidRotation)(-270)).toEqual(!0),expect((0,_ui_utils.isValidRotation)(540)).toEqual(!0)}))})),describe("isPortraitOrientation",(function(){it("should be portrait orientation",(function(){expect((0,_ui_utils.isPortraitOrientation)({width:200,height:400})).toEqual(!0),expect((0,_ui_utils.isPortraitOrientation)({width:500,height:500})).toEqual(!0)})),it("should be landscape orientation",(function(){expect((0,_ui_utils.isPortraitOrientation)({width:600,height:300})).toEqual(!1)}))})),describe("parseQueryString",(function(){it("should parse one key/value pair",(function(){const t=(0,_ui_utils.parseQueryString)("key1=value1");expect(t.size).toEqual(1),expect(t.get("key1")).toEqual("value1")})),it("should parse multiple key/value pairs",(function(){const t=(0,_ui_utils.parseQueryString)("key1=value1&key2=value2&key3=value3");expect(t.size).toEqual(3),expect(t.get("key1")).toEqual("value1"),expect(t.get("key2")).toEqual("value2"),expect(t.get("key3")).toEqual("value3")})),it("should parse keys without values",(function(){const t=(0,_ui_utils.parseQueryString)("key1");expect(t.size).toEqual(1),expect(t.get("key1")).toEqual("")})),it("should decode encoded key/value pairs",(function(){const t=(0,_ui_utils.parseQueryString)("k%C3%ABy1=valu%C3%AB1");expect(t.size).toEqual(1),expect(t.get("k\xeby1")).toEqual("valu\xeb1")})),it("should convert keys to lowercase",(function(){const t=(0,_ui_utils.parseQueryString)("Key1=Value1&KEY2=Value2");expect(t.size).toEqual(2),expect(t.get("key1")).toEqual("Value1"),expect(t.get("key2")).toEqual("Value2")}))})),describe("waitOnEventOrTimeout",(function(){let t;beforeAll((function(){t=new _ui_utils.EventBus})),afterAll((function(){t=null})),it("should reject invalid parameters",(async function(){const e=(0,_ui_utils.waitOnEventOrTimeout)({target:"window",name:"DOMContentLoaded"}).then((function(){expect(!1).toEqual(!0)}),(function(t){expect(t instanceof Error).toEqual(!0)})),i=(0,_ui_utils.waitOnEventOrTimeout)({target:t,name:""}).then((function(){expect(!1).toEqual(!0)}),(function(t){expect(t instanceof Error).toEqual(!0)})),n=(0,_ui_utils.waitOnEventOrTimeout)({target:t,name:"pagerendered",delay:-1e3}).then((function(){expect(!1).toEqual(!0)}),(function(t){expect(t instanceof Error).toEqual(!0)}));await Promise.all([e,i,n])})),it("should resolve on event, using the DOM",(async function(){_is_node.isNodeJS&&pending("Document is not supported in Node.js.");const t=document.createElement("button"),e=(0,_ui_utils.waitOnEventOrTimeout)({target:t,name:"click",delay:1e4});t.click();const i=await e;expect(i).toEqual(_ui_utils.WaitOnType.EVENT)})),it("should resolve on timeout, using the DOM",(async function(){_is_node.isNodeJS&&pending("Document is not supported in Node.js.");const t=document.createElement("button"),e=(0,_ui_utils.waitOnEventOrTimeout)({target:t,name:"click",delay:10}),i=await e;expect(i).toEqual(_ui_utils.WaitOnType.TIMEOUT)})),it("should resolve on event, using the EventBus",(async function(){const e=(0,_ui_utils.waitOnEventOrTimeout)({target:t,name:"pagerendered",delay:1e4});t.dispatch("pagerendered");const i=await e;expect(i).toEqual(_ui_utils.WaitOnType.EVENT)})),it("should resolve on timeout, using the EventBus",(async function(){const e=(0,_ui_utils.waitOnEventOrTimeout)({target:t,name:"pagerendered",delay:10}),i=await e;expect(i).toEqual(_ui_utils.WaitOnType.TIMEOUT)}))})),describe("getPageSizeInches",(function(){it("gets page size (in inches)",(function(){const t={view:[0,0,595.28,841.89],userUnit:1,rotate:0},{width:e,height:i}=(0,_ui_utils.getPageSizeInches)(t);expect(+e.toPrecision(3)).toEqual(8.27),expect(+i.toPrecision(4)).toEqual(11.69)})),it("gets page size (in inches), for non-default /Rotate entry",(function(){const t={view:[0,0,612,792],userUnit:1,rotate:0},{width:e,height:i}=(0,_ui_utils.getPageSizeInches)(t);expect(e).toEqual(8.5),expect(i).toEqual(11);const n={view:[0,0,612,792],userUnit:1,rotate:90},{width:o,height:s}=(0,_ui_utils.getPageSizeInches)(n);expect(o).toEqual(11),expect(s).toEqual(8.5)}))})),describe("getVisibleElements",(function(){const t=9,e=2*t-7;function i(i){const n=[];let o=0,s=0;for(const u of i){const i=u.reduce((function(t,e){return Math.max(t,e[1])}),0);let c=-t;for(const[l,a]of u){const u=o+(i-a)/2-t,r={offsetLeft:c,offsetTop:u,clientWidth:l,clientHeight:a,clientLeft:t,clientTop:t};n.push({id:s,div:r}),++s,c+=l+e}o+=i+e}return n}function n(t,e){const i=[],{scrollLeft:n,scrollTop:o}=t,s=n+t.clientWidth,u=o+t.clientHeight;for(const c of e){const{div:t}=c,e=t.offsetLeft+t.clientLeft,l=e+t.clientWidth,a=t.offsetTop+t.clientTop,r=a+t.clientHeight;if(e<s&&l>n&&a<u&&r>o){const d=Math.max(0,o-a)+Math.max(0,r-u),p=Math.max(0,n-e)+Math.max(0,l-s),f=(t.clientHeight-d)/t.clientHeight,h=(t.clientWidth-p)/t.clientWidth,_=f*h*100|0;i.push({id:c.id,x:e,y:a,view:c,percent:_,widthPercent:100*h|0})}}return{first:i[0],last:i[i.length-1],views:i}}function o(t,e=!1,i=!1){const o=t.reduce((function(t,{div:i}){return Math.max(t,e?Math.abs(i.offsetLeft+i.clientLeft+i.clientWidth):i.offsetTop+i.clientTop+i.clientHeight)}),0);for(let s=-o;s<o;s+=7)for(let u=s+5;u<o;u+=u-s){const o=e?{scrollTop:0,scrollLeft:s,clientHeight:1e4,clientWidth:u-s}:{scrollTop:s,scrollLeft:0,clientHeight:u-s,clientWidth:1e4};expect((0,_ui_utils.getVisibleElements)({scrollEl:o,views:t,sortByVisibility:!1,horizontal:e,rtl:i})).toEqual(n(o,t))}}it("with pages of varying height",(function(){const t=i([[[50,20],[20,50]],[[30,12],[12,30]],[[20,50],[50,20]],[[50,20],[20,50]]]);o(t)})),it("widescreen challenge",(function(){const t=i([[[10,50],[10,60],[10,70],[10,80],[10,90]],[[10,90],[10,80],[10,70],[10,60],[10,50]],[[10,50],[10,60],[10,70],[10,80],[10,90]]]);o(t)})),it("works with horizontal scrolling",(function(){const t=i([[[10,50],[20,20],[30,10]]]);o(t,!0)})),it("works with horizontal scrolling with RTL-documents",(function(){const t=i([[[-10,50],[-20,20],[-30,10]]]);o(t,!0,!0)})),it("handles `sortByVisibility` correctly",(function(){const t={scrollTop:75,scrollLeft:0,clientHeight:750,clientWidth:1500},e=i([[[100,150]],[[100,150]],[[100,150]]]),n=(0,_ui_utils.getVisibleElements)({scrollEl:t,views:e}),o=(0,_ui_utils.getVisibleElements)({scrollEl:t,views:e,sortByVisibility:!0}),s=[],u=[];for(const i of n.views)s.push(i.id);for(const i of o.views)u.push(i.id);expect(s).toEqual([0,1,2]),expect(u).toEqual([1,2,0])})),it("handles views being empty",(function(){const t={scrollTop:10,scrollLeft:0,clientHeight:750,clientWidth:1500},e=[];expect((0,_ui_utils.getVisibleElements)({scrollEl:t,views:e})).toEqual({first:void 0,last:void 0,views:[]})})),it("handles all views being hidden (without errors)",(function(){const t={scrollTop:1e5,scrollLeft:0,clientHeight:750,clientWidth:1500},e=i([[[100,150]],[[100,150]],[[100,150]]]);expect((0,_ui_utils.getVisibleElements)({scrollEl:t,views:e})).toEqual({first:void 0,last:void 0,views:[]})})),describe("backtrackBeforeAllVisibleElements",(function(){const t=[10,50],n=[10,10],o=20+e+40,s=20+e+10;it("handles case 1",(function(){const e=i([[[10,20],[10,20],[10,20],[10,20]],[t,n,t,n],[[10,50],[10,50],[10,50],[10,50]],[[10,20],[10,20],[10,20],[10,20]],[[10,20]]]),s=4;expect((0,_ui_utils.backtrackBeforeAllVisibleElements)(s,e,o)).toEqual(4)})),it("handles case 2",(function(){const e=i([[[10,20],[10,20],[10,20],[10,20]],[t,n,t,t],[[10,50],[10,50],[10,50],[10,50]],[[10,20],[10,20],[10,20],[10,20]]]),s=6;expect((0,_ui_utils.backtrackBeforeAllVisibleElements)(s,e,o)).toEqual(4)})),it("handles case 3",(function(){const e=i([[[10,20],[10,20],[10,20],[10,20]],[t,n,t,n],[[10,50],[10,50],[10,50],[10,50]],[[10,20],[10,20],[10,20],[10,20]]]),s=8;expect((0,_ui_utils.backtrackBeforeAllVisibleElements)(s,e,o)).toEqual(4)})),it("handles case 4",(function(){const e=i([[[10,20],[10,20],[10,20],[10,20]],[t,n,t,n],[[10,50],[10,50],[10,50],[10,50]],[[10,20],[10,20],[10,20],[10,20]]]),o=4;expect((0,_ui_utils.backtrackBeforeAllVisibleElements)(o,e,s)).toEqual(4)}))}))})),describe("moveToEndOfArray",(function(){it("works on empty arrays",(function(){const t=[];(0,_ui_utils.moveToEndOfArray)(t,(function(){})),expect(t).toEqual([])})),it("works when moving everything",(function(){const t=[1,2,3,4,5];(0,_ui_utils.moveToEndOfArray)(t,(function(){return!0})),expect(t).toEqual([1,2,3,4,5])})),it("works when moving some things",(function(){const t=[1,2,3,4,5];(0,_ui_utils.moveToEndOfArray)(t,(function(t){return t%2===0})),expect(t).toEqual([1,3,5,2,4])})),it("works when moving one thing",(function(){const t=[1,2,3,4,5];(0,_ui_utils.moveToEndOfArray)(t,(function(t){return 1===t})),expect(t).toEqual([2,3,4,5,1])})),it("works when moving nothing",(function(){const t=[1,2,3,4,5];(0,_ui_utils.moveToEndOfArray)(t,(function(t){return 0===t})),expect(t).toEqual([1,2,3,4,5])}))}))}));