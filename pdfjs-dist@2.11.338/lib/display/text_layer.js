"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.renderTextLayer=renderTextLayer;var _util=require("../shared/util.js");const MAX_TEXT_DIVS_TO_RENDER=1e5,DEFAULT_FONT_SIZE=30,DEFAULT_FONT_ASCENT=.8,ascentCache=new Map,AllWhitespaceRegexp=/^\s+$/g;function getAscent(t,e){const n=ascentCache.get(t);if(n)return n;e.save(),e.font=`${DEFAULT_FONT_SIZE}px ${t}`;const i=e.measureText("");let o=i.fontBoundingBoxAscent,s=Math.abs(i.fontBoundingBoxDescent);if(o){e.restore();const n=o/(o+s);return ascentCache.set(t,n),n}e.strokeStyle="red",e.clearRect(0,0,DEFAULT_FONT_SIZE,DEFAULT_FONT_SIZE),e.strokeText("g",0,0);let a=e.getImageData(0,0,DEFAULT_FONT_SIZE,DEFAULT_FONT_SIZE).data;s=0;for(let r=a.length-1-3;r>=0;r-=4)if(a[r]>0){s=Math.ceil(r/4/DEFAULT_FONT_SIZE);break}e.clearRect(0,0,DEFAULT_FONT_SIZE,DEFAULT_FONT_SIZE),e.strokeText("A",0,DEFAULT_FONT_SIZE),a=e.getImageData(0,0,DEFAULT_FONT_SIZE,DEFAULT_FONT_SIZE).data,o=0;for(let r=0,l=a.length;r<l;r+=4)if(a[r]>0){o=DEFAULT_FONT_SIZE-Math.floor(r/4/DEFAULT_FONT_SIZE);break}if(e.restore(),o){const e=o/(o+s);return ascentCache.set(t,e),e}return ascentCache.set(t,DEFAULT_FONT_ASCENT),DEFAULT_FONT_ASCENT}function appendText(t,e,n,i){const o=document.createElement("span"),s=t._enhanceTextSelection?{angle:0,canvasWidth:0,hasText:""!==e.str,hasEOL:e.hasEOL,originalTransform:null,paddingBottom:0,paddingLeft:0,paddingRight:0,paddingTop:0,scale:1}:{angle:0,canvasWidth:0,hasText:""!==e.str,hasEOL:e.hasEOL};t._textDivs.push(o);const a=_util.Util.transform(t._viewport.transform,e.transform);let r=Math.atan2(a[1],a[0]);const l=n[e.fontName];l.vertical&&(r+=Math.PI/2);const h=Math.hypot(a[2],a[3]),d=h*getAscent(l.fontFamily,i);let c,x;0===r?(c=a[4],x=a[5]-d):(c=a[4]+d*Math.sin(r),x=a[5]-d*Math.cos(r)),o.style.left=`${c}px`,o.style.top=`${x}px`,o.style.fontSize=`${h}px`,o.style.fontFamily=l.fontFamily,o.setAttribute("role","presentation"),o.textContent=e.str,o.dir=e.dir,t._fontInspectorEnabled&&(o.dataset.fontName=e.fontName),0!==r&&(s.angle=r*(180/Math.PI));let _=!1;if(e.str.length>1||t._enhanceTextSelection&&AllWhitespaceRegexp.test(e.str))_=!0;else if(e.transform[0]!==e.transform[3]){const t=Math.abs(e.transform[0]),n=Math.abs(e.transform[3]);t!==n&&Math.max(t,n)/Math.min(t,n)>1.5&&(_=!0)}if(_&&(l.vertical?s.canvasWidth=e.height*t._viewport.scale:s.canvasWidth=e.width*t._viewport.scale),t._textDivProperties.set(o,s),t._textContentStream&&t._layoutText(o),t._enhanceTextSelection&&s.hasText){let n=1,i=0;0!==r&&(n=Math.cos(r),i=Math.sin(r));const s=(l.vertical?e.height:e.width)*t._viewport.scale,a=h;let d,_;0!==r?(d=[n,i,-i,n,c,x],_=_util.Util.getAxialAlignedBoundingBox([0,0,s,a],d)):_=[c,x,c+s,x+a],t._bounds.push({left:_[0],top:_[1],right:_[2],bottom:_[3],div:o,size:[s,a],m:d})}}function render(t){if(t._canceled)return;const e=t._textDivs,n=t._capability,i=e.length;if(i>MAX_TEXT_DIVS_TO_RENDER)return t._renderingDone=!0,void n.resolve();if(!t._textContentStream)for(let o=0;o<i;o++)t._layoutText(e[o]);t._renderingDone=!0,n.resolve()}function findPositiveMin(t,e,n){let i=0;for(let o=0;o<n;o++){const n=t[e++];n>0&&(i=i?Math.min(n,i):n)}return i}function expand(t){const e=t._bounds,n=t._viewport,i=expandBounds(n.width,n.height,e);for(let o=0;o<i.length;o++){const n=e[o].div,s=t._textDivProperties.get(n);if(0===s.angle){s.paddingLeft=e[o].left-i[o].left,s.paddingTop=e[o].top-i[o].top,s.paddingRight=i[o].right-e[o].right,s.paddingBottom=i[o].bottom-e[o].bottom,t._textDivProperties.set(n,s);continue}const a=i[o],r=e[o],l=r.m,h=l[0],d=l[1],c=[[0,0],[0,r.size[1]],[r.size[0],0],r.size],x=new Float64Array(64);for(let t=0,e=c.length;t<e;t++){const e=_util.Util.applyTransform(c[t],l);x[t+0]=h&&(a.left-e[0])/h,x[t+4]=d&&(a.top-e[1])/d,x[t+8]=h&&(a.right-e[0])/h,x[t+12]=d&&(a.bottom-e[1])/d,x[t+16]=d&&(a.left-e[0])/-d,x[t+20]=h&&(a.top-e[1])/h,x[t+24]=d&&(a.right-e[0])/-d,x[t+28]=h&&(a.bottom-e[1])/h,x[t+32]=h&&(a.left-e[0])/-h,x[t+36]=d&&(a.top-e[1])/-d,x[t+40]=h&&(a.right-e[0])/-h,x[t+44]=d&&(a.bottom-e[1])/-d,x[t+48]=d&&(a.left-e[0])/d,x[t+52]=h&&(a.top-e[1])/-h,x[t+56]=d&&(a.right-e[0])/d,x[t+60]=h&&(a.bottom-e[1])/-h}const _=1+Math.min(Math.abs(h),Math.abs(d));s.paddingLeft=findPositiveMin(x,32,16)/_,s.paddingTop=findPositiveMin(x,48,16)/_,s.paddingRight=findPositiveMin(x,0,16)/_,s.paddingBottom=findPositiveMin(x,16,16)/_,t._textDivProperties.set(n,s)}}function expandBounds(t,e,n){const i=n.map((function(t,e){return{x1:t.left,y1:t.top,x2:t.right,y2:t.bottom,index:e,x1New:void 0,x2New:void 0}}));expandBoundsLTR(t,i);const o=new Array(n.length);for(const s of i){const t=s.index;o[t]={left:s.x1New,top:0,right:s.x2New,bottom:0}}n.map((function(e,n){const s=o[n],a=i[n];a.x1=e.top,a.y1=t-s.right,a.x2=e.bottom,a.y2=t-s.left,a.index=n,a.x1New=void 0,a.x2New=void 0})),expandBoundsLTR(e,i);for(const s of i){const t=s.index;o[t].top=s.x1New,o[t].bottom=s.x2New}return o}function expandBoundsLTR(t,e){e.sort((function(t,e){return t.x1-e.x1||t.index-e.index}));const n={x1:-1/0,y1:-1/0,x2:0,y2:1/0,index:-1,x1New:0,x2New:0},i=[{start:-1/0,end:1/0,boundary:n}];for(const o of e){let t=0;while(t<i.length&&i[t].end<=o.y1)t++;let e,n,s=i.length-1;while(s>=0&&i[s].start>=o.y2)s--;let a,r,l=-1/0;for(a=t;a<=s;a++){let t;e=i[a],n=e.boundary,t=n.x2>o.x1?n.index>o.index?n.x1New:o.x1:void 0===n.x2New?(n.x2+o.x1)/2:n.x2New,t>l&&(l=t)}for(o.x1New=l,a=t;a<=s;a++)e=i[a],n=e.boundary,void 0===n.x2New?n.x2>o.x1?n.index>o.index&&(n.x2New=n.x2):n.x2New=l:n.x2New>l&&(n.x2New=Math.max(l,n.x2));const h=[];let d=null;for(a=t;a<=s;a++){e=i[a],n=e.boundary;const t=n.x2>o.x2?n:o;d===t?h[h.length-1].end=e.end:(h.push({start:e.start,end:e.end,boundary:t}),d=t)}for(i[t].start<o.y1&&(h[0].start=o.y1,h.unshift({start:i[t].start,end:o.y1,boundary:i[t].boundary})),o.y2<i[s].end&&(h[h.length-1].end=o.y2,h.push({start:o.y2,end:i[s].end,boundary:i[s].boundary})),a=t;a<=s;a++){if(e=i[a],n=e.boundary,void 0!==n.x2New)continue;let o=!1;for(r=t-1;!o&&r>=0&&i[r].start>=n.y1;r--)o=i[r].boundary===n;for(r=s+1;!o&&r<i.length&&i[r].end<=n.y2;r++)o=i[r].boundary===n;for(r=0;!o&&r<h.length;r++)o=h[r].boundary===n;o||(n.x2New=l)}Array.prototype.splice.apply(i,[t,s-t+1].concat(h))}for(const o of i){const e=o.boundary;void 0===e.x2New&&(e.x2New=Math.max(t,e.x2))}}class TextLayerRenderTask{constructor({textContent:t,textContentStream:e,container:n,viewport:i,textDivs:o,textContentItemsStr:s,enhanceTextSelection:a}){this._textContent=t,this._textContentStream=e,this._container=n,this._document=n.ownerDocument,this._viewport=i,this._textDivs=o||[],this._textContentItemsStr=s||[],this._enhanceTextSelection=!!a,this._fontInspectorEnabled=!!globalThis.FontInspector?.enabled,this._reader=null,this._layoutTextLastFontSize=null,this._layoutTextLastFontFamily=null,this._layoutTextCtx=null,this._textDivProperties=new WeakMap,this._renderingDone=!1,this._canceled=!1,this._capability=(0,_util.createPromiseCapability)(),this._renderTimer=null,this._bounds=[],this._capability.promise.finally((()=>{this._enhanceTextSelection||(this._textDivProperties=null),this._layoutTextCtx&&(this._layoutTextCtx.canvas.width=0,this._layoutTextCtx.canvas.height=0,this._layoutTextCtx=null)})).catch((()=>{}))}get promise(){return this._capability.promise}cancel(){this._canceled=!0,this._reader&&(this._reader.cancel(new _util.AbortException("TextLayer task cancelled.")).catch((()=>{})),this._reader=null),null!==this._renderTimer&&(clearTimeout(this._renderTimer),this._renderTimer=null),this._capability.reject(new Error("TextLayer task cancelled."))}_processItems(t,e){for(let n=0,i=t.length;n<i;n++)if(void 0!==t[n].str)this._textContentItemsStr.push(t[n].str),appendText(this,t[n],e,this._layoutTextCtx);else if("beginMarkedContentProps"===t[n].type||"beginMarkedContent"===t[n].type){const e=this._container;this._container=document.createElement("span"),this._container.classList.add("markedContent"),null!==t[n].id&&this._container.setAttribute("id",`${t[n].id}`),e.appendChild(this._container)}else"endMarkedContent"===t[n].type&&(this._container=this._container.parentNode)}_layoutText(t){const e=this._textDivProperties.get(t);let n="";if(0!==e.canvasWidth&&e.hasText){const{fontSize:i,fontFamily:o}=t.style;i===this._layoutTextLastFontSize&&o===this._layoutTextLastFontFamily||(this._layoutTextCtx.font=`${i} ${o}`,this._layoutTextLastFontSize=i,this._layoutTextLastFontFamily=o);const{width:s}=this._layoutTextCtx.measureText(t.textContent);if(s>0){const t=e.canvasWidth/s;this._enhanceTextSelection&&(e.scale=t),n=`scaleX(${t})`}}if(0!==e.angle&&(n=`rotate(${e.angle}deg) ${n}`),n.length>0&&(this._enhanceTextSelection&&(e.originalTransform=n),t.style.transform=n),e.hasText&&this._container.appendChild(t),e.hasEOL){const t=document.createElement("br");t.setAttribute("role","presentation"),this._container.appendChild(t)}}_render(t=0){const e=(0,_util.createPromiseCapability)();let n=Object.create(null);const i=this._document.createElement("canvas");if(i.height=i.width=DEFAULT_FONT_SIZE,i.mozOpaque=!0,this._layoutTextCtx=i.getContext("2d",{alpha:!1}),this._textContent){const t=this._textContent.items,n=this._textContent.styles;this._processItems(t,n),e.resolve()}else{if(!this._textContentStream)throw new Error('Neither "textContent" nor "textContentStream" parameters specified.');{const t=()=>{this._reader.read().then((({value:i,done:o})=>{o?e.resolve():(Object.assign(n,i.styles),this._processItems(i.items,n),t())}),e.reject)};this._reader=this._textContentStream.getReader(),t()}}e.promise.then((()=>{n=null,t?this._renderTimer=setTimeout((()=>{render(this),this._renderTimer=null}),t):render(this)}),this._capability.reject)}expandTextDivs(t=!1){if(!this._enhanceTextSelection||!this._renderingDone)return;null!==this._bounds&&(expand(this),this._bounds=null);const e=[],n=[];for(let i=0,o=this._textDivs.length;i<o;i++){const o=this._textDivs[i],s=this._textDivProperties.get(o);s.hasText&&(t?(e.length=0,n.length=0,s.originalTransform&&e.push(s.originalTransform),s.paddingTop>0?(n.push(`${s.paddingTop}px`),e.push(`translateY(${-s.paddingTop}px)`)):n.push(0),s.paddingRight>0?n.push(s.paddingRight/s.scale+"px"):n.push(0),s.paddingBottom>0?n.push(`${s.paddingBottom}px`):n.push(0),s.paddingLeft>0?(n.push(s.paddingLeft/s.scale+"px"),e.push(`translateX(${-s.paddingLeft/s.scale}px)`)):n.push(0),o.style.padding=n.join(" "),e.length&&(o.style.transform=e.join(" "))):(o.style.padding=null,o.style.transform=s.originalTransform))}}}function renderTextLayer(t){const e=new TextLayerRenderTask({textContent:t.textContent,textContentStream:t.textContentStream,container:t.container,viewport:t.viewport,textDivs:t.textDivs,textContentItemsStr:t.textContentItemsStr,enhanceTextSelection:t.enhanceTextSelection});return e._render(t.timeout),e}