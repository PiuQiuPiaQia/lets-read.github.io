"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.addLinkAttributes=addLinkAttributes,exports.deprecated=deprecated,exports.getFilenameFromUrl=getFilenameFromUrl,exports.getPdfFilenameFromUrl=getPdfFilenameFromUrl,exports.getXfaPageViewport=getXfaPageViewport,exports.isDataScheme=isDataScheme,exports.isPdfFile=isPdfFile,exports.isValidFetchUrl=isValidFetchUrl,exports.loadScript=loadScript,exports.StatTimer=exports.RenderingCancelledException=exports.PixelsPerInch=exports.PDFDateString=exports.PageViewport=exports.LinkTarget=exports.DOMSVGFactory=exports.DOMStandardFontDataFactory=exports.DOMCMapReaderFactory=exports.DOMCanvasFactory=void 0;var _util=require("../shared/util.js"),_base_factory=require("./base_factory.js");const DEFAULT_LINK_REL="noopener noreferrer nofollow",SVG_NS="http://www.w3.org/2000/svg",PixelsPerInch={CSS:96,PDF:72,get PDF_TO_CSS_UNITS(){return(0,_util.shadow)(this,"PDF_TO_CSS_UNITS",this.CSS/this.PDF)}};exports.PixelsPerInch=PixelsPerInch;class DOMCanvasFactory extends _base_factory.BaseCanvasFactory{constructor({ownerDocument:t=globalThis.document}={}){super(),this._document=t}_createCanvas(t,e){const r=this._document.createElement("canvas");return r.width=t,r.height=e,r}}async function fetchData(t,e=!1){if(isValidFetchUrl(t,document.baseURI)){const r=await fetch(t);if(!r.ok)throw new Error(r.statusText);return e?new Uint8Array(await r.arrayBuffer()):(0,_util.stringToBytes)(await r.text())}return new Promise(((r,a)=>{const s=new XMLHttpRequest;s.open("GET",t,!0),e&&(s.responseType="arraybuffer"),s.onreadystatechange=()=>{if(s.readyState===XMLHttpRequest.DONE){if(200===s.status||0===s.status){let t;if(e&&s.response?t=new Uint8Array(s.response):!e&&s.responseText&&(t=(0,_util.stringToBytes)(s.responseText)),t)return void r(t)}a(new Error(s.statusText))}},s.send(null)}))}exports.DOMCanvasFactory=DOMCanvasFactory;class DOMCMapReaderFactory extends _base_factory.BaseCMapReaderFactory{_fetchData(t,e){return fetchData(t,this.isCompressed).then((t=>({cMapData:t,compressionType:e})))}}exports.DOMCMapReaderFactory=DOMCMapReaderFactory;class DOMStandardFontDataFactory extends _base_factory.BaseStandardFontDataFactory{_fetchData(t){return fetchData(t,!0)}}exports.DOMStandardFontDataFactory=DOMStandardFontDataFactory;class DOMSVGFactory extends _base_factory.BaseSVGFactory{_createSVG(t){return document.createElementNS(SVG_NS,t)}}exports.DOMSVGFactory=DOMSVGFactory;class PageViewport{constructor({viewBox:t,scale:e,rotation:r,offsetX:a=0,offsetY:s=0,dontFlip:n=!1}){this.viewBox=t,this.scale=e,this.rotation=r,this.offsetX=a,this.offsetY=s;const o=(t[2]+t[0])/2,i=(t[3]+t[1])/2;let c,l,d,p,f,u,h,g;switch(r%=360,r<0&&(r+=360),r){case 180:c=-1,l=0,d=0,p=1;break;case 90:c=0,l=1,d=1,p=0;break;case 270:c=0,l=-1,d=-1,p=0;break;case 0:c=1,l=0,d=0,p=-1;break;default:throw new Error("PageViewport: Invalid rotation, must be a multiple of 90 degrees.")}n&&(d=-d,p=-p),0===c?(f=Math.abs(i-t[1])*e+a,u=Math.abs(o-t[0])*e+s,h=Math.abs(t[3]-t[1])*e,g=Math.abs(t[2]-t[0])*e):(f=Math.abs(o-t[0])*e+a,u=Math.abs(i-t[1])*e+s,h=Math.abs(t[2]-t[0])*e,g=Math.abs(t[3]-t[1])*e),this.transform=[c*e,l*e,d*e,p*e,f-c*e*o-d*e*i,u-l*e*o-p*e*i],this.width=h,this.height=g}clone({scale:t=this.scale,rotation:e=this.rotation,offsetX:r=this.offsetX,offsetY:a=this.offsetY,dontFlip:s=!1}={}){return new PageViewport({viewBox:this.viewBox.slice(),scale:t,rotation:e,offsetX:r,offsetY:a,dontFlip:s})}convertToViewportPoint(t,e){return _util.Util.applyTransform([t,e],this.transform)}convertToViewportRectangle(t){const e=_util.Util.applyTransform([t[0],t[1]],this.transform),r=_util.Util.applyTransform([t[2],t[3]],this.transform);return[e[0],e[1],r[0],r[1]]}convertToPdfPoint(t,e){return _util.Util.applyInverseTransform([t,e],this.transform)}}exports.PageViewport=PageViewport;class RenderingCancelledException extends _util.BaseException{constructor(t,e){super(t,"RenderingCancelledException"),this.type=e}}exports.RenderingCancelledException=RenderingCancelledException;const LinkTarget={NONE:0,SELF:1,BLANK:2,PARENT:3,TOP:4};function addLinkAttributes(t,{url:e,target:r,rel:a,enabled:s=!0}={}){(0,_util.assert)(e&&"string"===typeof e,'addLinkAttributes: A valid "url" parameter must provided.');const n=(0,_util.removeNullCharacters)(e);s?t.href=t.title=n:(t.href="",t.title=`Disabled: ${n}`,t.onclick=()=>!1);let o="";switch(r){case LinkTarget.NONE:break;case LinkTarget.SELF:o="_self";break;case LinkTarget.BLANK:o="_blank";break;case LinkTarget.PARENT:o="_parent";break;case LinkTarget.TOP:o="_top";break}t.target=o,t.rel="string"===typeof a?a:DEFAULT_LINK_REL}function isDataScheme(t){const e=t.length;let r=0;while(r<e&&""===t[r].trim())r++;return"data:"===t.substring(r,r+5).toLowerCase()}function isPdfFile(t){return"string"===typeof t&&/\.pdf$/i.test(t)}function getFilenameFromUrl(t){const e=t.indexOf("#"),r=t.indexOf("?"),a=Math.min(e>0?e:t.length,r>0?r:t.length);return t.substring(t.lastIndexOf("/",a)+1,a)}function getPdfFilenameFromUrl(t,e="document.pdf"){if("string"!==typeof t)return e;if(isDataScheme(t))return(0,_util.warn)('getPdfFilenameFromUrl: ignore "data:"-URL for performance reasons.'),e;const r=/^(?:(?:[^:]+:)?\/\/[^/]+)?([^?#]*)(\?[^#]*)?(#.*)?$/,a=/[^/?#=]+\.pdf\b(?!.*\.pdf\b)/i,s=r.exec(t);let n=a.exec(s[1])||a.exec(s[2])||a.exec(s[3]);if(n&&(n=n[0],n.includes("%")))try{n=a.exec(decodeURIComponent(n))[0]}catch(o){}return n||e}exports.LinkTarget=LinkTarget;class StatTimer{constructor(){this.started=Object.create(null),this.times=[]}time(t){t in this.started&&(0,_util.warn)(`Timer is already running for ${t}`),this.started[t]=Date.now()}timeEnd(t){t in this.started||(0,_util.warn)(`Timer has not been started for ${t}`),this.times.push({name:t,start:this.started[t],end:Date.now()}),delete this.started[t]}toString(){const t=[];let e=0;for(const r of this.times){const t=r.name;t.length>e&&(e=t.length)}for(const r of this.times){const a=r.end-r.start;t.push(`${r.name.padEnd(e)} ${a}ms\n`)}return t.join("")}}function isValidFetchUrl(t,e){try{const{protocol:r}=e?new URL(t,e):new URL(t);return"http:"===r||"https:"===r}catch(r){return!1}}function loadScript(t,e=!1){return new Promise(((r,a)=>{const s=document.createElement("script");s.src=t,s.onload=function(t){e&&s.remove(),r(t)},s.onerror=function(){a(new Error(`Cannot load script at: ${s.src}`))},(document.head||document.documentElement).appendChild(s)}))}function deprecated(t){console.log("Deprecated API usage: "+t)}let pdfDateStringRegex;exports.StatTimer=StatTimer;class PDFDateString{static toDateObject(t){if(!t||!(0,_util.isString)(t))return null;pdfDateStringRegex||(pdfDateStringRegex=new RegExp("^D:(\\d{4})(\\d{2})?(\\d{2})?(\\d{2})?(\\d{2})?(\\d{2})?([Z|+|-])?(\\d{2})?'?(\\d{2})?'?"));const e=pdfDateStringRegex.exec(t);if(!e)return null;const r=parseInt(e[1],10);let a=parseInt(e[2],10);a=a>=1&&a<=12?a-1:0;let s=parseInt(e[3],10);s=s>=1&&s<=31?s:1;let n=parseInt(e[4],10);n=n>=0&&n<=23?n:0;let o=parseInt(e[5],10);o=o>=0&&o<=59?o:0;let i=parseInt(e[6],10);i=i>=0&&i<=59?i:0;const c=e[7]||"Z";let l=parseInt(e[8],10);l=l>=0&&l<=23?l:0;let d=parseInt(e[9],10)||0;return d=d>=0&&d<=59?d:0,"-"===c?(n+=l,o+=d):"+"===c&&(n-=l,o-=d),new Date(Date.UTC(r,a,s,n,o,i))}}function getXfaPageViewport(t,{scale:e=1,rotation:r=0}){const{width:a,height:s}=t.attributes.style,n=[0,0,parseInt(a),parseInt(s)];return new PageViewport({viewBox:n,scale:e,rotation:r})}exports.PDFDateString=PDFDateString;