"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PDFNodeStream=void 0;var _util=require("../shared/util.js"),_network_utils=require("./network_utils.js");const fs=require("fs"),http=require("http"),https=require("https"),url=require("url"),fileUriRegex=/^file:\/\/\/[a-zA-Z]:\//;function parseUrl(e){const t=url.parse(e);return"file:"===t.protocol||t.host?t:/^[a-z]:[/\\]/i.test(e)?url.parse(`file:///${e}`):(t.host||(t.protocol="file:"),t)}class PDFNodeStream{constructor(e){this.source=e,this.url=parseUrl(e.url),this.isHttp="http:"===this.url.protocol||"https:"===this.url.protocol,this.isFsUrl="file:"===this.url.protocol,this.httpHeaders=this.isHttp&&e.httpHeaders||{},this._fullRequestReader=null,this._rangeRequestReaders=[]}get _progressiveDataLength(){return this._fullRequestReader?._loaded??0}getFullReader(){return(0,_util.assert)(!this._fullRequestReader,"PDFNodeStream.getFullReader can only be called once."),this._fullRequestReader=this.isFsUrl?new PDFNodeStreamFsFullReader(this):new PDFNodeStreamFullReader(this),this._fullRequestReader}getRangeReader(e,t){if(t<=this._progressiveDataLength)return null;const r=this.isFsUrl?new PDFNodeStreamFsRangeReader(this,e,t):new PDFNodeStreamRangeReader(this,e,t);return this._rangeRequestReaders.push(r),r}cancelAllRequests(e){this._fullRequestReader&&this._fullRequestReader.cancel(e);for(const t of this._rangeRequestReaders.slice(0))t.cancel(e)}}exports.PDFNodeStream=PDFNodeStream;class BaseFullReader{constructor(e){this._url=e.url,this._done=!1,this._storedError=null,this.onProgress=null;const t=e.source;this._contentLength=t.length,this._loaded=0,this._filename=null,this._disableRange=t.disableRange||!1,this._rangeChunkSize=t.rangeChunkSize,this._rangeChunkSize||this._disableRange||(this._disableRange=!0),this._isStreamingSupported=!t.disableStream,this._isRangeSupported=!t.disableRange,this._readableStream=null,this._readCapability=(0,_util.createPromiseCapability)(),this._headersCapability=(0,_util.createPromiseCapability)()}get headersReady(){return this._headersCapability.promise}get filename(){return this._filename}get contentLength(){return this._contentLength}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}async read(){if(await this._readCapability.promise,this._done)return{value:void 0,done:!0};if(this._storedError)throw this._storedError;const e=this._readableStream.read();if(null===e)return this._readCapability=(0,_util.createPromiseCapability)(),this.read();this._loaded+=e.length,this.onProgress&&this.onProgress({loaded:this._loaded,total:this._contentLength});const t=new Uint8Array(e).buffer;return{value:t,done:!1}}cancel(e){this._readableStream?this._readableStream.destroy(e):this._error(e)}_error(e){this._storedError=e,this._readCapability.resolve()}_setReadableStream(e){this._readableStream=e,e.on("readable",(()=>{this._readCapability.resolve()})),e.on("end",(()=>{e.destroy(),this._done=!0,this._readCapability.resolve()})),e.on("error",(e=>{this._error(e)})),!this._isStreamingSupported&&this._isRangeSupported&&this._error(new _util.AbortException("streaming is disabled")),this._storedError&&this._readableStream.destroy(this._storedError)}}class BaseRangeReader{constructor(e){this._url=e.url,this._done=!1,this._storedError=null,this.onProgress=null,this._loaded=0,this._readableStream=null,this._readCapability=(0,_util.createPromiseCapability)();const t=e.source;this._isStreamingSupported=!t.disableStream}get isStreamingSupported(){return this._isStreamingSupported}async read(){if(await this._readCapability.promise,this._done)return{value:void 0,done:!0};if(this._storedError)throw this._storedError;const e=this._readableStream.read();if(null===e)return this._readCapability=(0,_util.createPromiseCapability)(),this.read();this._loaded+=e.length,this.onProgress&&this.onProgress({loaded:this._loaded});const t=new Uint8Array(e).buffer;return{value:t,done:!1}}cancel(e){this._readableStream?this._readableStream.destroy(e):this._error(e)}_error(e){this._storedError=e,this._readCapability.resolve()}_setReadableStream(e){this._readableStream=e,e.on("readable",(()=>{this._readCapability.resolve()})),e.on("end",(()=>{e.destroy(),this._done=!0,this._readCapability.resolve()})),e.on("error",(e=>{this._error(e)})),this._storedError&&this._readableStream.destroy(this._storedError)}}function createRequestOptions(e,t){return{protocol:e.protocol,auth:e.auth,host:e.hostname,port:e.port,path:e.path,method:"GET",headers:t}}class PDFNodeStreamFullReader extends BaseFullReader{constructor(e){super(e);const t=t=>{if(404===t.statusCode){const e=new _util.MissingPDFException(`Missing PDF "${this._url}".`);return this._storedError=e,void this._headersCapability.reject(e)}this._headersCapability.resolve(),this._setReadableStream(t);const r=e=>this._readableStream.headers[e.toLowerCase()],{allowRangeRequests:s,suggestedLength:i}=(0,_network_utils.validateRangeRequestCapabilities)({getResponseHeader:r,isHttp:e.isHttp,rangeChunkSize:this._rangeChunkSize,disableRange:this._disableRange});this._isRangeSupported=s,this._contentLength=i||this._contentLength,this._filename=(0,_network_utils.extractFilenameFromHeader)(r)};this._request=null,"http:"===this._url.protocol?this._request=http.request(createRequestOptions(this._url,e.httpHeaders),t):this._request=https.request(createRequestOptions(this._url,e.httpHeaders),t),this._request.on("error",(e=>{this._storedError=e,this._headersCapability.reject(e)})),this._request.end()}}class PDFNodeStreamRangeReader extends BaseRangeReader{constructor(e,t,r){super(e),this._httpHeaders={};for(const i in e.httpHeaders){const t=e.httpHeaders[i];"undefined"!==typeof t&&(this._httpHeaders[i]=t)}this._httpHeaders.Range=`bytes=${t}-${r-1}`;const s=e=>{if(404!==e.statusCode)this._setReadableStream(e);else{const e=new _util.MissingPDFException(`Missing PDF "${this._url}".`);this._storedError=e}};this._request=null,"http:"===this._url.protocol?this._request=http.request(createRequestOptions(this._url,this._httpHeaders),s):this._request=https.request(createRequestOptions(this._url,this._httpHeaders),s),this._request.on("error",(e=>{this._storedError=e})),this._request.end()}}class PDFNodeStreamFsFullReader extends BaseFullReader{constructor(e){super(e);let t=decodeURIComponent(this._url.path);fileUriRegex.test(this._url.href)&&(t=t.replace(/^\//,"")),fs.lstat(t,((e,r)=>{if(e)return"ENOENT"===e.code&&(e=new _util.MissingPDFException(`Missing PDF "${t}".`)),this._storedError=e,void this._headersCapability.reject(e);this._contentLength=r.size,this._setReadableStream(fs.createReadStream(t)),this._headersCapability.resolve()}))}}class PDFNodeStreamFsRangeReader extends BaseRangeReader{constructor(e,t,r){super(e);let s=decodeURIComponent(this._url.path);fileUriRegex.test(this._url.href)&&(s=s.replace(/^\//,"")),this._setReadableStream(fs.createReadStream(s,{start:t,end:r-1}))}}