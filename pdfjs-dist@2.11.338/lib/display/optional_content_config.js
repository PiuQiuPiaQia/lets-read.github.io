"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.OptionalContentConfig=void 0;var _util=require("../shared/util.js");class OptionalContentGroup{constructor(t,i){this.visible=!0,this.name=t,this.intent=i}}class OptionalContentConfig{constructor(t){if(this.name=null,this.creator=null,this._order=null,this._groups=new Map,null!==t){this.name=t.name,this.creator=t.creator,this._order=t.order;for(const i of t.groups)this._groups.set(i.id,new OptionalContentGroup(i.name,i.intent));if("OFF"===t.baseState)for(const t of this._groups)t.visible=!1;for(const i of t.on)this._groups.get(i).visible=!0;for(const i of t.off)this._groups.get(i).visible=!1}}_evaluateVisibilityExpression(t){const i=t.length;if(i<2)return!0;const r=t[0];for(let o=1;o<i;o++){const i=t[o];let n;if(Array.isArray(i))n=this._evaluateVisibilityExpression(i);else{if(!this._groups.has(i))return(0,_util.warn)(`Optional content group not found: ${i}`),!0;n=this._groups.get(i).visible}switch(r){case"And":if(!n)return!1;break;case"Or":if(n)return!0;break;case"Not":return!n;default:return!0}}return"And"===r}isVisible(t){if(0===this._groups.size)return!0;if(!t)return(0,_util.warn)("Optional content group not defined."),!0;if("OCG"===t.type)return this._groups.has(t.id)?this._groups.get(t.id).visible:((0,_util.warn)(`Optional content group not found: ${t.id}`),!0);if("OCMD"===t.type){if(t.expression)return this._evaluateVisibilityExpression(t.expression);if(!t.policy||"AnyOn"===t.policy){for(const i of t.ids){if(!this._groups.has(i))return(0,_util.warn)(`Optional content group not found: ${i}`),!0;if(this._groups.get(i).visible)return!0}return!1}if("AllOn"===t.policy){for(const i of t.ids){if(!this._groups.has(i))return(0,_util.warn)(`Optional content group not found: ${i}`),!0;if(!this._groups.get(i).visible)return!1}return!0}if("AnyOff"===t.policy){for(const i of t.ids){if(!this._groups.has(i))return(0,_util.warn)(`Optional content group not found: ${i}`),!0;if(!this._groups.get(i).visible)return!0}return!1}if("AllOff"===t.policy){for(const i of t.ids){if(!this._groups.has(i))return(0,_util.warn)(`Optional content group not found: ${i}`),!0;if(this._groups.get(i).visible)return!1}return!0}return(0,_util.warn)(`Unknown optional content policy ${t.policy}.`),!0}return(0,_util.warn)(`Unknown group type ${t.type}.`),!0}setVisibility(t,i=!0){this._groups.has(t)?this._groups.get(t).visible=!!i:(0,_util.warn)(`Optional content group not found: ${t}`)}getOrder(){return this._groups.size?this._order?this._order.slice():Array.from(this._groups.keys()):null}getGroups(){return this._groups.size>0?(0,_util.objectFromMap)(this._groups):null}getGroup(t){return this._groups.get(t)||null}}exports.OptionalContentConfig=OptionalContentConfig;