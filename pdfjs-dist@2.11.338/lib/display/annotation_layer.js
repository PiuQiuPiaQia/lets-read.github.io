"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AnnotationLayer=void 0;var _util=require("../shared/util.js"),_display_utils=require("./display_utils.js"),_annotation_storage=require("./annotation_storage.js"),_scripting_utils=require("../shared/scripting_utils.js");const DEFAULT_TAB_INDEX=1e3,GetElementsByNameSet=new WeakSet;class AnnotationElementFactory{static create(t){const e=t.data.annotationType;switch(e){case _util.AnnotationType.LINK:return new LinkAnnotationElement(t);case _util.AnnotationType.TEXT:return new TextAnnotationElement(t);case _util.AnnotationType.WIDGET:const e=t.data.fieldType;switch(e){case"Tx":return new TextWidgetAnnotationElement(t);case"Btn":return t.data.radioButton?new RadioButtonWidgetAnnotationElement(t):t.data.checkBox?new CheckboxWidgetAnnotationElement(t):new PushButtonWidgetAnnotationElement(t);case"Ch":return new ChoiceWidgetAnnotationElement(t)}return new WidgetAnnotationElement(t);case _util.AnnotationType.POPUP:return new PopupAnnotationElement(t);case _util.AnnotationType.FREETEXT:return new FreeTextAnnotationElement(t);case _util.AnnotationType.LINE:return new LineAnnotationElement(t);case _util.AnnotationType.SQUARE:return new SquareAnnotationElement(t);case _util.AnnotationType.CIRCLE:return new CircleAnnotationElement(t);case _util.AnnotationType.POLYLINE:return new PolylineAnnotationElement(t);case _util.AnnotationType.CARET:return new CaretAnnotationElement(t);case _util.AnnotationType.INK:return new InkAnnotationElement(t);case _util.AnnotationType.POLYGON:return new PolygonAnnotationElement(t);case _util.AnnotationType.HIGHLIGHT:return new HighlightAnnotationElement(t);case _util.AnnotationType.UNDERLINE:return new UnderlineAnnotationElement(t);case _util.AnnotationType.SQUIGGLY:return new SquigglyAnnotationElement(t);case _util.AnnotationType.STRIKEOUT:return new StrikeOutAnnotationElement(t);case _util.AnnotationType.STAMP:return new StampAnnotationElement(t);case _util.AnnotationType.FILEATTACHMENT:return new FileAttachmentAnnotationElement(t);default:return new AnnotationElement(t)}}}class AnnotationElement{constructor(t,{isRenderable:e=!1,ignoreBorder:n=!1,createQuadrilaterals:a=!1}={}){this.isRenderable=e,this.data=t.data,this.layer=t.layer,this.page=t.page,this.viewport=t.viewport,this.linkService=t.linkService,this.downloadManager=t.downloadManager,this.imageResourcesPath=t.imageResourcesPath,this.renderForms=t.renderForms,this.svgFactory=t.svgFactory,this.annotationStorage=t.annotationStorage,this.enableScripting=t.enableScripting,this.hasJSActions=t.hasJSActions,this._fieldObjects=t.fieldObjects,this._mouseState=t.mouseState,e&&(this.container=this._createContainer(n)),a&&(this.quadrilaterals=this._createQuadrilaterals(n))}_createContainer(t=!1){const e=this.data,n=this.page,a=this.viewport,i=document.createElement("section");let s=e.rect[2]-e.rect[0],o=e.rect[3]-e.rect[1];i.setAttribute("data-annotation-id",e.id);const r=_util.Util.normalizeRect([e.rect[0],n.view[3]-e.rect[1]+n.view[1],e.rect[2],n.view[3]-e.rect[3]+n.view[1]]);if(i.style.transform=`matrix(${a.transform.join(",")})`,i.style.transformOrigin=`${-r[0]}px ${-r[1]}px`,!t&&e.borderStyle.width>0){i.style.borderWidth=`${e.borderStyle.width}px`,e.borderStyle.style!==_util.AnnotationBorderStyleType.UNDERLINE&&(s-=2*e.borderStyle.width,o-=2*e.borderStyle.width);const t=e.borderStyle.horizontalCornerRadius,n=e.borderStyle.verticalCornerRadius;if(t>0||n>0){const e=`${t}px / ${n}px`;i.style.borderRadius=e}switch(e.borderStyle.style){case _util.AnnotationBorderStyleType.SOLID:i.style.borderStyle="solid";break;case _util.AnnotationBorderStyleType.DASHED:i.style.borderStyle="dashed";break;case _util.AnnotationBorderStyleType.BEVELED:(0,_util.warn)("Unimplemented border style: beveled");break;case _util.AnnotationBorderStyleType.INSET:(0,_util.warn)("Unimplemented border style: inset");break;case _util.AnnotationBorderStyleType.UNDERLINE:i.style.borderBottomStyle="solid";break;default:break}const a=e.borderColor||e.color||null;a?i.style.borderColor=_util.Util.makeHexColor(0|e.color[0],0|e.color[1],0|e.color[2]):i.style.borderWidth=0}return i.style.left=`${r[0]}px`,i.style.top=`${r[1]}px`,i.style.width=`${s}px`,i.style.height=`${o}px`,i}_createQuadrilaterals(t=!1){if(!this.data.quadPoints)return null;const e=[],n=this.data.rect;for(const a of this.data.quadPoints)this.data.rect=[a[2].x,a[2].y,a[1].x,a[1].y],e.push(this._createContainer(t));return this.data.rect=n,e}_createPopup(t,e){let n=this.container;this.quadrilaterals&&(t=t||this.quadrilaterals,n=this.quadrilaterals[0]),t||(t=document.createElement("div"),t.style.height=n.style.height,t.style.width=n.style.width,n.appendChild(t));const a=new PopupElement({container:n,trigger:t,color:e.color,titleObj:e.titleObj,modificationDate:e.modificationDate,contentsObj:e.contentsObj,hideWrapper:!0}),i=a.render();i.style.left=n.style.width,n.appendChild(i)}_renderQuadrilaterals(t){for(const e of this.quadrilaterals)e.className=t;return this.quadrilaterals}render(){(0,_util.unreachable)("Abstract method `AnnotationElement.render` called")}_getElementsByName(t,e=null){const n=[];if(this._fieldObjects){const a=this._fieldObjects[t];if(a)for(const{page:t,id:i,exportValues:s}of a){if(-1===t)continue;if(i===e)continue;const a="string"===typeof s?s:null,o=document.getElementById(i);!o||GetElementsByNameSet.has(o)?n.push({id:i,exportValue:a,domElement:o}):(0,_util.warn)(`_getElementsByName - element not allowed: ${i}`)}return n}for(const a of document.getElementsByName(t)){const{id:t,exportValue:i}=a;t!==e&&(GetElementsByNameSet.has(a)&&n.push({id:t,exportValue:i,domElement:a}))}return n}static get platform(){const t="undefined"!==typeof navigator?navigator.platform:"";return(0,_util.shadow)(this,"platform",{isWin:t.includes("Win"),isMac:t.includes("Mac")})}}class LinkAnnotationElement extends AnnotationElement{constructor(t){const e=!!(t.data.url||t.data.dest||t.data.action||t.data.isTooltipOnly||t.data.resetForm||t.data.actions&&(t.data.actions.Action||t.data.actions["Mouse Up"]||t.data.actions["Mouse Down"]));super(t,{isRenderable:e,createQuadrilaterals:!0})}render(){const{data:t,linkService:e}=this,n=document.createElement("a");if(t.url)e.addLinkAttributes||(0,_util.warn)("LinkAnnotationElement.render - missing `addLinkAttributes`-method on the `linkService`-instance."),e.addLinkAttributes?.(n,t.url,t.newWindow);else if(t.action)this._bindNamedAction(n,t.action);else if(t.dest)this._bindLink(n,t.dest);else{let e=!1;t.actions&&(t.actions.Action||t.actions["Mouse Up"]||t.actions["Mouse Down"])&&this.enableScripting&&this.hasJSActions&&(e=!0,this._bindJSAction(n,t)),t.resetForm?this._bindResetFormAction(n,t.resetForm):e||this._bindLink(n,"")}return this.quadrilaterals?this._renderQuadrilaterals("linkAnnotation").map(((t,e)=>{const a=0===e?n:n.cloneNode();return t.appendChild(a),t})):(this.container.className="linkAnnotation",this.container.appendChild(n),this.container)}_bindLink(t,e){t.href=this.linkService.getDestinationHash(e),t.onclick=()=>(e&&this.linkService.goToDestination(e),!1),(e||""===e)&&(t.className="internalLink")}_bindNamedAction(t,e){t.href=this.linkService.getAnchorUrl(""),t.onclick=()=>(this.linkService.executeNamedAction(e),!1),t.className="internalLink"}_bindJSAction(t,e){t.href=this.linkService.getAnchorUrl("");const n=new Map([["Action","onclick"],["Mouse Up","onmouseup"],["Mouse Down","onmousedown"]]);for(const a of Object.keys(e.actions)){const i=n.get(a);i&&(t[i]=()=>(this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e.id,name:a}}),!1))}t.onclick||(t.onclick=()=>!1),t.className="internalLink"}_bindResetFormAction(t,e){const n=t.onclick;if(n||(t.href=this.linkService.getAnchorUrl("")),t.className="internalLink",!this._fieldObjects)return(0,_util.warn)('_bindResetFormAction - "resetForm" action not supported, ensure that the `fieldObjects` parameter is provided.'),void(n||(t.onclick=()=>!1));t.onclick=()=>{n&&n();const{fields:t,refs:a,include:i}=e,s=[];if(0!==t.length||0!==a.length){const e=new Set(a);for(const n of t){const t=this._fieldObjects[n]||[];for(const{id:n}of t)e.add(n)}for(const t of Object.values(this._fieldObjects))for(const n of t)e.has(n.id)===i&&s.push(n)}else for(const e of Object.values(this._fieldObjects))s.push(...e);const o=this.annotationStorage,r=[];for(const e of s){const{id:t}=e;switch(r.push(t),e.type){case"text":{const n=e.defaultValue||"";o.setValue(t,{value:n,valueAsString:n});break}case"checkbox":case"radiobutton":{const n=e.defaultValue===e.exportValues;o.setValue(t,{value:n});break}case"combobox":case"listbox":{const n=e.defaultValue||"";o.setValue(t,{value:n});break}default:continue}const n=document.getElementById(t);n&&GetElementsByNameSet.has(n)&&n.dispatchEvent(new Event("resetform"))}return this.enableScripting&&this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:"app",ids:r,name:"ResetForm"}}),!1}}}class TextAnnotationElement extends AnnotationElement{constructor(t){const e=!!(t.data.hasPopup||t.data.titleObj?.str||t.data.contentsObj?.str);super(t,{isRenderable:e})}render(){this.container.className="textAnnotation";const t=document.createElement("img");return t.style.height=this.container.style.height,t.style.width=this.container.style.width,t.src=this.imageResourcesPath+"annotation-"+this.data.name.toLowerCase()+".svg",t.alt="[{{type}} Annotation]",t.dataset.l10nId="text_annotation_type",t.dataset.l10nArgs=JSON.stringify({type:this.data.name}),this.data.hasPopup||this._createPopup(t,this.data),this.container.appendChild(t),this.container}}class WidgetAnnotationElement extends AnnotationElement{render(){return this.data.alternativeText&&(this.container.title=this.data.alternativeText),this.container}_getKeyModifier(t){const{isWin:e,isMac:n}=AnnotationElement.platform;return e&&t.ctrlKey||n&&t.metaKey}_setEventListener(t,e,n,a){e.includes("mouse")?t.addEventListener(e,(t=>{this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:this.data.id,name:n,value:a(t),shift:t.shiftKey,modifier:this._getKeyModifier(t)}})})):t.addEventListener(e,(t=>{this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:this.data.id,name:n,value:t.target.checked}})}))}_setEventListeners(t,e,n){for(const[a,i]of e)("Action"===i||this.data.actions?.[i])&&this._setEventListener(t,a,i,n)}_setBackgroundColor(t){const e=this.data.backgroundColor||null;t.style.backgroundColor=null===e?"transparent":_util.Util.makeHexColor(e[0],e[1],e[2])}_dispatchEventFromSandbox(t,e){const n=(t,e,n)=>{const a=n.detail[t];n.target.style[e]=_scripting_utils.ColorConverters[`${a[0]}_HTML`](a.slice(1))},a={display:t=>{const e=t.detail.display%2===1;t.target.style.visibility=e?"hidden":"visible",this.annotationStorage.setValue(this.data.id,{hidden:e,print:0===t.detail.display||3===t.detail.display})},print:t=>{this.annotationStorage.setValue(this.data.id,{print:t.detail.print})},hidden:t=>{t.target.style.visibility=t.detail.hidden?"hidden":"visible",this.annotationStorage.setValue(this.data.id,{hidden:t.detail.hidden})},focus:t=>{setTimeout((()=>t.target.focus({preventScroll:!1})),0)},userName:t=>{t.target.title=t.detail.userName},readonly:t=>{t.detail.readonly?t.target.setAttribute("readonly",""):t.target.removeAttribute("readonly")},required:t=>{t.detail.required?t.target.setAttribute("required",""):t.target.removeAttribute("required")},bgColor:t=>{n("bgColor","backgroundColor",t)},fillColor:t=>{n("fillColor","backgroundColor",t)},fgColor:t=>{n("fgColor","color",t)},textColor:t=>{n("textColor","color",t)},borderColor:t=>{n("borderColor","borderColor",t)},strokeColor:t=>{n("strokeColor","borderColor",t)}};for(const i of Object.keys(e.detail)){const n=t[i]||a[i];n&&n(e)}}}class TextWidgetAnnotationElement extends WidgetAnnotationElement{constructor(t){const e=t.renderForms||!t.data.hasAppearance&&!!t.data.fieldValue;super(t,{isRenderable:e})}setPropertyOnSiblings(t,e,n,a){const i=this.annotationStorage;for(const s of this._getElementsByName(t.name,t.id))s.domElement&&(s.domElement[e]=n),i.setValue(s.id,{[a]:n})}render(){const t=this.annotationStorage,e=this.data.id;this.container.className="textWidgetAnnotation";let n=null;if(this.renderForms){const a=t.getValue(e,{value:this.data.fieldValue,valueAsString:this.data.fieldValue}),i=a.valueAsString||a.value||"",s={userValue:null,formattedValue:null,beforeInputSelectionRange:null,beforeInputValue:null};this.data.multiLine?(n=document.createElement("textarea"),n.textContent=i):(n=document.createElement("input"),n.type="text",n.setAttribute("value",i)),GetElementsByNameSet.add(n),n.disabled=this.data.readOnly,n.name=this.data.fieldName,n.tabIndex=DEFAULT_TAB_INDEX,s.userValue=i,n.setAttribute("id",e),n.addEventListener("input",(a=>{t.setValue(e,{value:a.target.value}),this.setPropertyOnSiblings(n,"value",a.target.value,"value")})),n.addEventListener("resetform",(t=>{const e=this.data.defaultFieldValue||"";n.value=s.userValue=e,delete s.formattedValue}));let o=t=>{s.formattedValue&&(t.target.value=s.formattedValue),t.target.scrollLeft=0,s.beforeInputSelectionRange=null};if(this.enableScripting&&this.hasJSActions){n.addEventListener("focus",(t=>{s.userValue&&(t.target.value=s.userValue)})),n.addEventListener("updatefromsandbox",(n=>{const a={value(n){s.userValue=n.detail.value||"",t.setValue(e,{value:s.userValue.toString()}),s.formattedValue||(n.target.value=s.userValue)},valueAsString(n){s.formattedValue=n.detail.valueAsString||"",n.target!==document.activeElement&&(n.target.value=s.formattedValue),t.setValue(e,{formattedValue:s.formattedValue})},selRange(t){const[e,n]=t.detail.selRange;e>=0&&n<t.target.value.length&&t.target.setSelectionRange(e,n)}};this._dispatchEventFromSandbox(a,n)})),n.addEventListener("keydown",(t=>{s.beforeInputValue=t.target.value;let n=-1;"Escape"===t.key?n=0:"Enter"===t.key?n=2:"Tab"===t.key&&(n=3),-1!==n&&(s.userValue=t.target.value,this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e,name:"Keystroke",value:t.target.value,willCommit:!0,commitKey:n,selStart:t.target.selectionStart,selEnd:t.target.selectionEnd}}))}));const a=o;o=null,n.addEventListener("blur",(t=>{this._mouseState.isDown&&(s.userValue=t.target.value,this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e,name:"Keystroke",value:t.target.value,willCommit:!0,commitKey:1,selStart:t.target.selectionStart,selEnd:t.target.selectionEnd}})),a(t)})),n.addEventListener("mousedown",(t=>{s.beforeInputValue=t.target.value,s.beforeInputSelectionRange=null})),n.addEventListener("keyup",(t=>{t.target.selectionStart===t.target.selectionEnd&&(s.beforeInputSelectionRange=null)})),n.addEventListener("select",(t=>{s.beforeInputSelectionRange=[t.target.selectionStart,t.target.selectionEnd]})),this.data.actions?.Keystroke&&n.addEventListener("input",(t=>{let n=-1,a=-1;s.beforeInputSelectionRange&&([n,a]=s.beforeInputSelectionRange),this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e,name:"Keystroke",value:s.beforeInputValue,change:t.data,willCommit:!1,selStart:n,selEnd:a}})})),this._setEventListeners(n,[["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],(t=>t.target.value))}if(o&&n.addEventListener("blur",o),null!==this.data.maxLen&&(n.maxLength=this.data.maxLen),this.data.comb){const t=this.data.rect[2]-this.data.rect[0],e=t/this.data.maxLen;n.classList.add("comb"),n.style.letterSpacing=`calc(${e}px - 1ch)`}}else n=document.createElement("div"),n.textContent=this.data.fieldValue,n.style.verticalAlign="middle",n.style.display="table-cell";return this._setTextStyle(n),this._setBackgroundColor(n),this.container.appendChild(n),this.container}_setTextStyle(t){const e=["left","center","right"],{fontSize:n,fontColor:a}=this.data.defaultAppearanceData,i=t.style;n&&(i.fontSize=`${n}px`),i.color=_util.Util.makeHexColor(a[0],a[1],a[2]),null!==this.data.textAlignment&&(i.textAlign=e[this.data.textAlignment])}}class CheckboxWidgetAnnotationElement extends WidgetAnnotationElement{constructor(t){super(t,{isRenderable:t.renderForms})}render(){const t=this.annotationStorage,e=this.data,n=e.id;let a=t.getValue(n,{value:e.exportValue===e.fieldValue}).value;"string"===typeof a&&(a="Off"!==a,t.setValue(n,{value:a})),this.container.className="buttonWidgetAnnotation checkBox";const i=document.createElement("input");return GetElementsByNameSet.add(i),i.disabled=e.readOnly,i.type="checkbox",i.name=e.fieldName,a&&i.setAttribute("checked",!0),i.setAttribute("id",n),i.setAttribute("exportValue",e.exportValue),i.tabIndex=DEFAULT_TAB_INDEX,i.addEventListener("change",(a=>{const{name:i,checked:s}=a.target;for(const o of this._getElementsByName(i,n)){const n=s&&o.exportValue===e.exportValue;o.domElement&&(o.domElement.checked=n),t.setValue(o.id,{value:n})}t.setValue(n,{value:s})})),i.addEventListener("resetform",(t=>{const n=e.defaultFieldValue||"Off";t.target.checked=n===e.exportValue})),this.enableScripting&&this.hasJSActions&&(i.addEventListener("updatefromsandbox",(e=>{const a={value(e){e.target.checked="Off"!==e.detail.value,t.setValue(n,{value:e.target.checked})}};this._dispatchEventFromSandbox(a,e)})),this._setEventListeners(i,[["change","Validate"],["change","Action"],["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],(t=>t.target.checked))),this._setBackgroundColor(i),this.container.appendChild(i),this.container}}class RadioButtonWidgetAnnotationElement extends WidgetAnnotationElement{constructor(t){super(t,{isRenderable:t.renderForms})}render(){this.container.className="buttonWidgetAnnotation radioButton";const t=this.annotationStorage,e=this.data,n=e.id;let a=t.getValue(n,{value:e.fieldValue===e.buttonValue}).value;"string"===typeof a&&(a=a!==e.buttonValue,t.setValue(n,{value:a}));const i=document.createElement("input");if(GetElementsByNameSet.add(i),i.disabled=e.readOnly,i.type="radio",i.name=e.fieldName,a&&i.setAttribute("checked",!0),i.setAttribute("id",n),i.tabIndex=DEFAULT_TAB_INDEX,i.addEventListener("change",(e=>{const{name:a,checked:i}=e.target;for(const s of this._getElementsByName(a,n))t.setValue(s.id,{value:!1});t.setValue(n,{value:i})})),i.addEventListener("resetform",(t=>{const n=e.defaultFieldValue;t.target.checked=null!==n&&void 0!==n&&n===e.buttonValue})),this.enableScripting&&this.hasJSActions){const a=e.buttonValue;i.addEventListener("updatefromsandbox",(e=>{const i={value:e=>{const i=a===e.detail.value;for(const a of this._getElementsByName(e.target.name)){const e=i&&a.id===n;a.domElement&&(a.domElement.checked=e),t.setValue(a.id,{value:e})}}};this._dispatchEventFromSandbox(i,e)})),this._setEventListeners(i,[["change","Validate"],["change","Action"],["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],(t=>t.target.checked))}return this._setBackgroundColor(i),this.container.appendChild(i),this.container}}class PushButtonWidgetAnnotationElement extends LinkAnnotationElement{render(){const t=super.render();return t.className="buttonWidgetAnnotation pushButton",this.data.alternativeText&&(t.title=this.data.alternativeText),t}}class ChoiceWidgetAnnotationElement extends WidgetAnnotationElement{constructor(t){super(t,{isRenderable:t.renderForms})}render(){this.container.className="choiceWidgetAnnotation";const t=this.annotationStorage,e=this.data.id;t.getValue(e,{value:this.data.fieldValue.length>0?this.data.fieldValue[0]:void 0});let{fontSize:n}=this.data.defaultAppearanceData;n||(n=9);const a=`calc(${n}px * var(--zoom-factor))`,i=document.createElement("select");GetElementsByNameSet.add(i),i.disabled=this.data.readOnly,i.name=this.data.fieldName,i.setAttribute("id",e),i.tabIndex=DEFAULT_TAB_INDEX,i.style.fontSize=`${n}px`,this.data.combo||(i.size=this.data.options.length,this.data.multiSelect&&(i.multiple=!0)),i.addEventListener("resetform",(t=>{const e=this.data.defaultFieldValue;for(const n of i.options)n.selected=n.value===e}));for(const r of this.data.options){const t=document.createElement("option");t.textContent=r.displayValue,t.value=r.exportValue,this.data.combo&&(t.style.fontSize=a),this.data.fieldValue.includes(r.exportValue)&&t.setAttribute("selected",!0),i.appendChild(t)}const s=(t,e)=>{const n=e?"value":"textContent",a=t.target.options;return t.target.multiple?Array.prototype.filter.call(a,(t=>t.selected)).map((t=>t[n])):-1===a.selectedIndex?null:a[a.selectedIndex][n]},o=t=>{const e=t.target.options;return Array.prototype.map.call(e,(t=>({displayValue:t.textContent,exportValue:t.value})))};return this.enableScripting&&this.hasJSActions?(i.addEventListener("updatefromsandbox",(n=>{const a={value(n){const a=n.detail.value,o=new Set(Array.isArray(a)?a:[a]);for(const t of i.options)t.selected=o.has(t.value);t.setValue(e,{value:s(n,!0)})},multipleSelection(t){i.multiple=!0},remove(n){const a=i.options,r=n.detail.remove;if(a[r].selected=!1,i.remove(r),a.length>0){const t=Array.prototype.findIndex.call(a,(t=>t.selected));-1===t&&(a[0].selected=!0)}t.setValue(e,{value:s(n,!0),items:o(n)})},clear(n){while(0!==i.length)i.remove(0);t.setValue(e,{value:null,items:[]})},insert(n){const{index:a,displayValue:r,exportValue:l}=n.detail.insert,d=document.createElement("option");d.textContent=r,d.value=l,i.insertBefore(d,i.children[a]),t.setValue(e,{value:s(n,!0),items:o(n)})},items(n){const{items:a}=n.detail;while(0!==i.length)i.remove(0);for(const t of a){const{displayValue:e,exportValue:n}=t,a=document.createElement("option");a.textContent=e,a.value=n,i.appendChild(a)}i.options.length>0&&(i.options[0].selected=!0),t.setValue(e,{value:s(n,!0),items:o(n)})},indices(n){const a=new Set(n.detail.indices);for(const t of n.target.options)t.selected=a.has(t.index);t.setValue(e,{value:s(n,!0)})},editable(t){t.target.disabled=!t.detail.editable}};this._dispatchEventFromSandbox(a,n)})),i.addEventListener("input",(n=>{const a=s(n,!0),i=s(n,!1);t.setValue(e,{value:a}),this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e,name:"Keystroke",value:i,changeEx:a,willCommit:!0,commitKey:1,keyDown:!1}})})),this._setEventListeners(i,[["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"],["input","Action"]],(t=>t.target.checked))):i.addEventListener("input",(function(n){t.setValue(e,{value:s(n)})})),this._setBackgroundColor(i),this.container.appendChild(i),this.container}}class PopupAnnotationElement extends AnnotationElement{constructor(t){const e=!(!t.data.titleObj?.str&&!t.data.contentsObj?.str);super(t,{isRenderable:e})}render(){const t=["Line","Square","Circle","PolyLine","Polygon","Ink"];if(this.container.className="popupAnnotation",t.includes(this.data.parentType))return this.container;const e=`[data-annotation-id="${this.data.parentId}"]`,n=this.layer.querySelectorAll(e);if(0===n.length)return this.container;const a=new PopupElement({container:this.container,trigger:Array.from(n),color:this.data.color,titleObj:this.data.titleObj,modificationDate:this.data.modificationDate,contentsObj:this.data.contentsObj}),i=this.page,s=_util.Util.normalizeRect([this.data.parentRect[0],i.view[3]-this.data.parentRect[1]+i.view[1],this.data.parentRect[2],i.view[3]-this.data.parentRect[3]+i.view[1]]),o=s[0]+this.data.parentRect[2]-this.data.parentRect[0],r=s[1];return this.container.style.transformOrigin=`${-o}px ${-r}px`,this.container.style.left=`${o}px`,this.container.style.top=`${r}px`,this.container.appendChild(a.render()),this.container}}class PopupElement{constructor(t){this.container=t.container,this.trigger=t.trigger,this.color=t.color,this.titleObj=t.titleObj,this.modificationDate=t.modificationDate,this.contentsObj=t.contentsObj,this.hideWrapper=t.hideWrapper||!1,this.pinned=!1}render(){const t=.7,e=document.createElement("div");e.className="popupWrapper",this.hideElement=this.hideWrapper?e:this.container,this.hideElement.hidden=!0;const n=document.createElement("div");n.className="popup";const a=this.color;if(a){const e=t*(255-a[0])+a[0],i=t*(255-a[1])+a[1],s=t*(255-a[2])+a[2];n.style.backgroundColor=_util.Util.makeHexColor(0|e,0|i,0|s)}const i=document.createElement("h1");i.dir=this.titleObj.dir,i.textContent=this.titleObj.str,n.appendChild(i);const s=_display_utils.PDFDateString.toDateObject(this.modificationDate);if(s){const t=document.createElement("span");t.textContent="{{date}}, {{time}}",t.dataset.l10nId="annotation_date_string",t.dataset.l10nArgs=JSON.stringify({date:s.toLocaleDateString(),time:s.toLocaleTimeString()}),n.appendChild(t)}const o=this._formatContents(this.contentsObj);n.appendChild(o),Array.isArray(this.trigger)||(this.trigger=[this.trigger]);for(const r of this.trigger)r.addEventListener("click",this._toggle.bind(this)),r.addEventListener("mouseover",this._show.bind(this,!1)),r.addEventListener("mouseout",this._hide.bind(this,!1));return n.addEventListener("click",this._hide.bind(this,!0)),e.appendChild(n),e}_formatContents({str:t,dir:e}){const n=document.createElement("p");n.dir=e;const a=t.split(/(?:\r\n?|\n)/);for(let i=0,s=a.length;i<s;++i){const t=a[i];n.appendChild(document.createTextNode(t)),i<s-1&&n.appendChild(document.createElement("br"))}return n}_toggle(){this.pinned?this._hide(!0):this._show(!0)}_show(t=!1){t&&(this.pinned=!0),this.hideElement.hidden&&(this.hideElement.hidden=!1,this.container.style.zIndex+=1)}_hide(t=!0){t&&(this.pinned=!1),this.hideElement.hidden||this.pinned||(this.hideElement.hidden=!0,this.container.style.zIndex-=1)}}class FreeTextAnnotationElement extends AnnotationElement{constructor(t){const e=!!(t.data.hasPopup||t.data.titleObj?.str||t.data.contentsObj?.str);super(t,{isRenderable:e,ignoreBorder:!0})}render(){return this.container.className="freeTextAnnotation",this.data.hasPopup||this._createPopup(null,this.data),this.container}}class LineAnnotationElement extends AnnotationElement{constructor(t){const e=!!(t.data.hasPopup||t.data.titleObj?.str||t.data.contentsObj?.str);super(t,{isRenderable:e,ignoreBorder:!0})}render(){this.container.className="lineAnnotation";const t=this.data,e=t.rect[2]-t.rect[0],n=t.rect[3]-t.rect[1],a=this.svgFactory.create(e,n),i=this.svgFactory.createElement("svg:line");return i.setAttribute("x1",t.rect[2]-t.lineCoordinates[0]),i.setAttribute("y1",t.rect[3]-t.lineCoordinates[1]),i.setAttribute("x2",t.rect[2]-t.lineCoordinates[2]),i.setAttribute("y2",t.rect[3]-t.lineCoordinates[3]),i.setAttribute("stroke-width",t.borderStyle.width||1),i.setAttribute("stroke","transparent"),a.appendChild(i),this.container.append(a),this._createPopup(i,t),this.container}}class SquareAnnotationElement extends AnnotationElement{constructor(t){const e=!!(t.data.hasPopup||t.data.titleObj?.str||t.data.contentsObj?.str);super(t,{isRenderable:e,ignoreBorder:!0})}render(){this.container.className="squareAnnotation";const t=this.data,e=t.rect[2]-t.rect[0],n=t.rect[3]-t.rect[1],a=this.svgFactory.create(e,n),i=t.borderStyle.width,s=this.svgFactory.createElement("svg:rect");return s.setAttribute("x",i/2),s.setAttribute("y",i/2),s.setAttribute("width",e-i),s.setAttribute("height",n-i),s.setAttribute("stroke-width",i||1),s.setAttribute("stroke","transparent"),s.setAttribute("fill","none"),a.appendChild(s),this.container.append(a),this._createPopup(s,t),this.container}}class CircleAnnotationElement extends AnnotationElement{constructor(t){const e=!!(t.data.hasPopup||t.data.titleObj?.str||t.data.contentsObj?.str);super(t,{isRenderable:e,ignoreBorder:!0})}render(){this.container.className="circleAnnotation";const t=this.data,e=t.rect[2]-t.rect[0],n=t.rect[3]-t.rect[1],a=this.svgFactory.create(e,n),i=t.borderStyle.width,s=this.svgFactory.createElement("svg:ellipse");return s.setAttribute("cx",e/2),s.setAttribute("cy",n/2),s.setAttribute("rx",e/2-i/2),s.setAttribute("ry",n/2-i/2),s.setAttribute("stroke-width",i||1),s.setAttribute("stroke","transparent"),s.setAttribute("fill","none"),a.appendChild(s),this.container.append(a),this._createPopup(s,t),this.container}}class PolylineAnnotationElement extends AnnotationElement{constructor(t){const e=!!(t.data.hasPopup||t.data.titleObj?.str||t.data.contentsObj?.str);super(t,{isRenderable:e,ignoreBorder:!0}),this.containerClassName="polylineAnnotation",this.svgElementName="svg:polyline"}render(){this.container.className=this.containerClassName;const t=this.data,e=t.rect[2]-t.rect[0],n=t.rect[3]-t.rect[1],a=this.svgFactory.create(e,n);let i=[];for(const o of t.vertices){const e=o.x-t.rect[0],n=t.rect[3]-o.y;i.push(e+","+n)}i=i.join(" ");const s=this.svgFactory.createElement(this.svgElementName);return s.setAttribute("points",i),s.setAttribute("stroke-width",t.borderStyle.width||1),s.setAttribute("stroke","transparent"),s.setAttribute("fill","none"),a.appendChild(s),this.container.append(a),this._createPopup(s,t),this.container}}class PolygonAnnotationElement extends PolylineAnnotationElement{constructor(t){super(t),this.containerClassName="polygonAnnotation",this.svgElementName="svg:polygon"}}class CaretAnnotationElement extends AnnotationElement{constructor(t){const e=!!(t.data.hasPopup||t.data.titleObj?.str||t.data.contentsObj?.str);super(t,{isRenderable:e,ignoreBorder:!0})}render(){return this.container.className="caretAnnotation",this.data.hasPopup||this._createPopup(null,this.data),this.container}}class InkAnnotationElement extends AnnotationElement{constructor(t){const e=!!(t.data.hasPopup||t.data.titleObj?.str||t.data.contentsObj?.str);super(t,{isRenderable:e,ignoreBorder:!0}),this.containerClassName="inkAnnotation",this.svgElementName="svg:polyline"}render(){this.container.className=this.containerClassName;const t=this.data,e=t.rect[2]-t.rect[0],n=t.rect[3]-t.rect[1],a=this.svgFactory.create(e,n);for(const i of t.inkLists){let e=[];for(const a of i){const n=a.x-t.rect[0],i=t.rect[3]-a.y;e.push(`${n},${i}`)}e=e.join(" ");const n=this.svgFactory.createElement(this.svgElementName);n.setAttribute("points",e),n.setAttribute("stroke-width",t.borderStyle.width||1),n.setAttribute("stroke","transparent"),n.setAttribute("fill","none"),this._createPopup(n,t),a.appendChild(n)}return this.container.append(a),this.container}}class HighlightAnnotationElement extends AnnotationElement{constructor(t){const e=!!(t.data.hasPopup||t.data.titleObj?.str||t.data.contentsObj?.str);super(t,{isRenderable:e,ignoreBorder:!0,createQuadrilaterals:!0})}render(){return this.data.hasPopup||this._createPopup(null,this.data),this.quadrilaterals?this._renderQuadrilaterals("highlightAnnotation"):(this.container.className="highlightAnnotation",this.container)}}class UnderlineAnnotationElement extends AnnotationElement{constructor(t){const e=!!(t.data.hasPopup||t.data.titleObj?.str||t.data.contentsObj?.str);super(t,{isRenderable:e,ignoreBorder:!0,createQuadrilaterals:!0})}render(){return this.data.hasPopup||this._createPopup(null,this.data),this.quadrilaterals?this._renderQuadrilaterals("underlineAnnotation"):(this.container.className="underlineAnnotation",this.container)}}class SquigglyAnnotationElement extends AnnotationElement{constructor(t){const e=!!(t.data.hasPopup||t.data.titleObj?.str||t.data.contentsObj?.str);super(t,{isRenderable:e,ignoreBorder:!0,createQuadrilaterals:!0})}render(){return this.data.hasPopup||this._createPopup(null,this.data),this.quadrilaterals?this._renderQuadrilaterals("squigglyAnnotation"):(this.container.className="squigglyAnnotation",this.container)}}class StrikeOutAnnotationElement extends AnnotationElement{constructor(t){const e=!!(t.data.hasPopup||t.data.titleObj?.str||t.data.contentsObj?.str);super(t,{isRenderable:e,ignoreBorder:!0,createQuadrilaterals:!0})}render(){return this.data.hasPopup||this._createPopup(null,this.data),this.quadrilaterals?this._renderQuadrilaterals("strikeoutAnnotation"):(this.container.className="strikeoutAnnotation",this.container)}}class StampAnnotationElement extends AnnotationElement{constructor(t){const e=!!(t.data.hasPopup||t.data.titleObj?.str||t.data.contentsObj?.str);super(t,{isRenderable:e,ignoreBorder:!0})}render(){return this.container.className="stampAnnotation",this.data.hasPopup||this._createPopup(null,this.data),this.container}}class FileAttachmentAnnotationElement extends AnnotationElement{constructor(t){super(t,{isRenderable:!0});const{filename:e,content:n}=this.data.file;this.filename=(0,_display_utils.getFilenameFromUrl)(e),this.content=n,this.linkService.eventBus?.dispatch("fileattachmentannotation",{source:this,id:(0,_util.stringToPDFString)(e),filename:e,content:n})}render(){this.container.className="fileAttachmentAnnotation";const t=document.createElement("div");return t.style.height=this.container.style.height,t.style.width=this.container.style.width,t.addEventListener("dblclick",this._download.bind(this)),this.data.hasPopup||!this.data.titleObj?.str&&!this.data.contentsObj?.str||this._createPopup(t,this.data),this.container.appendChild(t),this.container}_download(){this.downloadManager?.openOrDownloadData(this.container,this.content,this.filename)}}class AnnotationLayer{static render(t){const e=[],n=[];for(const a of t.annotations)a&&(a.annotationType!==_util.AnnotationType.POPUP?e.push(a):n.push(a));n.length&&e.push(...n);for(const a of e){const e=AnnotationElementFactory.create({data:a,layer:t.div,page:t.page,viewport:t.viewport,linkService:t.linkService,downloadManager:t.downloadManager,imageResourcesPath:t.imageResourcesPath||"",renderForms:!1!==t.renderForms,svgFactory:new _display_utils.DOMSVGFactory,annotationStorage:t.annotationStorage||new _annotation_storage.AnnotationStorage,enableScripting:t.enableScripting,hasJSActions:t.hasJSActions,fieldObjects:t.fieldObjects,mouseState:t.mouseState||{isDown:!1}});if(e.isRenderable){const n=e.render();if(a.hidden&&(n.style.visibility="hidden"),Array.isArray(n))for(const e of n)t.div.appendChild(e);else e instanceof PopupAnnotationElement?t.div.prepend(n):t.div.appendChild(n)}}}static update(t){const e=`matrix(${t.viewport.transform.join(",")})`;for(const n of t.annotations){const a=t.div.querySelectorAll(`[data-annotation-id="${n.id}"]`);if(a)for(const t of a)t.style.transform=e}t.div.hidden=!1}}exports.AnnotationLayer=AnnotationLayer;