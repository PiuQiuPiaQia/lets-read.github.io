"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.FontLoader=exports.FontFaceObject=void 0;var _util=require("../shared/util.js");class BaseFontLoader{constructor({docId:A,onUnsupportedFeature:t,ownerDocument:e=globalThis.document,styleElement:o=null}){this.constructor===BaseFontLoader&&(0,_util.unreachable)("Cannot initialize BaseFontLoader."),this.docId=A,this._onUnsupportedFeature=t,this._document=e,this.nativeFontFaces=[],this.styleElement=null}addNativeFontFace(A){this.nativeFontFaces.push(A),this._document.fonts.add(A)}insertRule(A){let t=this.styleElement;t||(t=this.styleElement=this._document.createElement("style"),t.id=`PDFJS_FONT_STYLE_TAG_${this.docId}`,this._document.documentElement.getElementsByTagName("head")[0].appendChild(t));const e=t.sheet;e.insertRule(A,e.cssRules.length)}clear(){for(const A of this.nativeFontFaces)this._document.fonts.delete(A);this.nativeFontFaces.length=0,this.styleElement&&(this.styleElement.remove(),this.styleElement=null)}async bind(A){if(A.attached||A.missingFile)return;if(A.attached=!0,this.isFontLoadingAPISupported){const t=A.createNativeFontFace();if(t){this.addNativeFontFace(t);try{await t.loaded}catch(e){throw this._onUnsupportedFeature({featureId:_util.UNSUPPORTED_FEATURES.errorFontLoadNative}),(0,_util.warn)(`Failed to load font '${t.family}': '${e}'.`),A.disableFontFace=!0,e}}return}const t=A.createFontFaceRule();if(t){if(this.insertRule(t),this.isSyncFontLoadingSupported)return;await new Promise((e=>{const o=this._queueLoadingCallback(e);this._prepareFontLoadEvent([t],[A],o)}))}}_queueLoadingCallback(A){(0,_util.unreachable)("Abstract method `_queueLoadingCallback`.")}get isFontLoadingAPISupported(){const A=!!this._document?.fonts;return(0,_util.shadow)(this,"isFontLoadingAPISupported",A)}get isSyncFontLoadingSupported(){(0,_util.unreachable)("Abstract method `isSyncFontLoadingSupported`.")}get _loadTestFont(){(0,_util.unreachable)("Abstract method `_loadTestFont`.")}_prepareFontLoadEvent(A,t,e){(0,_util.unreachable)("Abstract method `_prepareFontLoadEvent`.")}}let FontLoader;exports.FontLoader=FontLoader,exports.FontLoader=FontLoader=class extends BaseFontLoader{constructor(A){super(A),this.loadingContext={requests:[],nextRequestId:0},this.loadTestFontId=0}get isSyncFontLoadingSupported(){let A=!1;if("undefined"===typeof navigator)A=!0;else{const t=/Mozilla\/5.0.*?rv:(\d+).*? Gecko/.exec(navigator.userAgent);t?.[1]>=14&&(A=!0)}return(0,_util.shadow)(this,"isSyncFontLoadingSupported",A)}_queueLoadingCallback(A){function t(){(0,_util.assert)(!o.done,"completeRequest() cannot be called twice."),o.done=!0;while(e.requests.length>0&&e.requests[0].done){const A=e.requests.shift();setTimeout(A.callback,0)}}const e=this.loadingContext,o={id:"pdfjs-font-loading-"+e.nextRequestId++,done:!1,complete:t,callback:A};return e.requests.push(o),o}get _loadTestFont(){const A=function(){return atob("T1RUTwALAIAAAwAwQ0ZGIDHtZg4AAAOYAAAAgUZGVE1lkzZwAAAEHAAAABxHREVGABQAFQAABDgAAAAeT1MvMlYNYwkAAAEgAAAAYGNtYXABDQLUAAACNAAAAUJoZWFk/xVFDQAAALwAAAA2aGhlYQdkA+oAAAD0AAAAJGhtdHgD6AAAAAAEWAAAAAZtYXhwAAJQAAAAARgAAAAGbmFtZVjmdH4AAAGAAAAAsXBvc3T/hgAzAAADeAAAACAAAQAAAAEAALZRFsRfDzz1AAsD6AAAAADOBOTLAAAAAM4KHDwAAAAAA+gDIQAAAAgAAgAAAAAAAAABAAADIQAAAFoD6AAAAAAD6AABAAAAAAAAAAAAAAAAAAAAAQAAUAAAAgAAAAQD6AH0AAUAAAKKArwAAACMAooCvAAAAeAAMQECAAACAAYJAAAAAAAAAAAAAQAAAAAAAAAAAAAAAFBmRWQAwAAuAC4DIP84AFoDIQAAAAAAAQAAAAAAAAAAACAAIAABAAAADgCuAAEAAAAAAAAAAQAAAAEAAAAAAAEAAQAAAAEAAAAAAAIAAQAAAAEAAAAAAAMAAQAAAAEAAAAAAAQAAQAAAAEAAAAAAAUAAQAAAAEAAAAAAAYAAQAAAAMAAQQJAAAAAgABAAMAAQQJAAEAAgABAAMAAQQJAAIAAgABAAMAAQQJAAMAAgABAAMAAQQJAAQAAgABAAMAAQQJAAUAAgABAAMAAQQJAAYAAgABWABYAAAAAAAAAwAAAAMAAAAcAAEAAAAAADwAAwABAAAAHAAEACAAAAAEAAQAAQAAAC7//wAAAC7////TAAEAAAAAAAABBgAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAAAAAAD/gwAyAAAAAQAAAAAAAAAAAAAAAAAAAAABAAQEAAEBAQJYAAEBASH4DwD4GwHEAvgcA/gXBIwMAYuL+nz5tQXkD5j3CBLnEQACAQEBIVhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYAAABAQAADwACAQEEE/t3Dov6fAH6fAT+fPp8+nwHDosMCvm1Cvm1DAz6fBQAAAAAAAABAAAAAMmJbzEAAAAAzgTjFQAAAADOBOQpAAEAAAAAAAAADAAUAAQAAAABAAAAAgABAAAAAAAAAAAD6AAAAAAAAA==")};return(0,_util.shadow)(this,"_loadTestFont",A())}_prepareFontLoadEvent(A,t,e){function o(A,t){return A.charCodeAt(t)<<24|A.charCodeAt(t+1)<<16|A.charCodeAt(t+2)<<8|255&A.charCodeAt(t+3)}function n(A,t,e,o){const n=A.substring(0,t),s=A.substring(t+e);return n+o+s}let s,i;const a=this._document.createElement("canvas");a.width=1,a.height=1;const r=a.getContext("2d");let l=0;function c(A,t){if(l++,l>30)return(0,_util.warn)("Load test font never loaded."),void t();r.font="30px "+A,r.fillText(".",0,20);const e=r.getImageData(0,0,1,1);e.data[3]>0?t():setTimeout(c.bind(null,A,t))}const d=`lt${Date.now()}${this.loadTestFontId++}`;let h=this._loadTestFont;const u=976;h=n(h,u,d.length,d);const F=16,g=1482184792;let p=o(h,F);for(s=0,i=d.length-3;s<i;s+=4)p=p-g+o(d,s)|0;s<d.length&&(p=p-g+o(d+"XXX",s)|0),h=n(h,F,4,(0,_util.string32)(p));const f=`url(data:font/opentype;base64,${btoa(h)});`,m=`@font-face {font-family:"${d}";src:${f}}`;this.insertRule(m);const E=[];for(const y of t)E.push(y.loadedName);E.push(d);const _=this._document.createElement("div");_.style.visibility="hidden",_.style.width=_.style.height="10px",_.style.position="absolute",_.style.top=_.style.left="0px";for(const y of E){const A=this._document.createElement("span");A.textContent="Hi",A.style.fontFamily=y,_.appendChild(A)}this._document.body.appendChild(_),c(d,(()=>{this._document.body.removeChild(_),e.complete()}))}};class FontFaceObject{constructor(A,{isEvalSupported:t=!0,disableFontFace:e=!1,ignoreErrors:o=!1,onUnsupportedFeature:n,fontRegistry:s=null}){this.compiledGlyphs=Object.create(null);for(const i in A)this[i]=A[i];this.isEvalSupported=!1!==t,this.disableFontFace=!0===e,this.ignoreErrors=!0===o,this._onUnsupportedFeature=n,this.fontRegistry=s}createNativeFontFace(){if(!this.data||this.disableFontFace)return null;let A;if(this.cssFontInfo){const t={weight:this.cssFontInfo.fontWeight};this.cssFontInfo.italicAngle&&(t.style=`oblique ${this.cssFontInfo.italicAngle}deg`),A=new FontFace(this.cssFontInfo.fontFamily,this.data,t)}else A=new FontFace(this.loadedName,this.data,{});return this.fontRegistry&&this.fontRegistry.registerFont(this),A}createFontFaceRule(){if(!this.data||this.disableFontFace)return null;const A=(0,_util.bytesToString)(this.data),t=`url(data:${this.mimetype};base64,${btoa(A)});`;let e;if(this.cssFontInfo){let A=`font-weight: ${this.cssFontInfo.fontWeight};`;this.cssFontInfo.italicAngle&&(A+=`font-style: oblique ${this.cssFontInfo.italicAngle}deg;`),e=`@font-face {font-family:"${this.cssFontInfo.fontFamily}";${A}src:${t}}`}else e=`@font-face {font-family:"${this.loadedName}";src:${t}}`;return this.fontRegistry&&this.fontRegistry.registerFont(this,t),e}getPathGenerator(A,t){if(void 0!==this.compiledGlyphs[t])return this.compiledGlyphs[t];let e;try{e=A.get(this.loadedName+"_path_"+t)}catch(o){if(!this.ignoreErrors)throw o;return this._onUnsupportedFeature({featureId:_util.UNSUPPORTED_FEATURES.errorFontGetPath}),(0,_util.warn)(`getPathGenerator - ignoring character: "${o}".`),this.compiledGlyphs[t]=function(A,t){}}if(this.isEvalSupported&&_util.IsEvalSupportedCached.value){const A=[];for(const t of e){const e=void 0!==t.args?t.args.join(","):"";A.push("c.",t.cmd,"(",e,");\n")}return this.compiledGlyphs[t]=new Function("c","size",A.join(""))}return this.compiledGlyphs[t]=function(A,t){for(const o of e)"scale"===o.cmd&&(o.args=[t,-t]),A[o.cmd].apply(A,o.args)}}}exports.FontFaceObject=FontFaceObject;